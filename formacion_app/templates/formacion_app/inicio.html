{% extends 'formacion_app/base_formacion.html' %}

{% block title %}Dashboard · Formación{% endblock %}

{% block formacion_content %}
<!-- ══════════════════════════════════════════════════════════════════════════
     BARRA DE CONTROL SUPERIOR (Estilo Odoo)
     ══════════════════════════════════════════════════════════════════════════ -->
<div class="odoo-control-bar">
    <div class="odoo-control-left">
        <a href="/admin/formacion_app/programaeducativo/add/" class="odoo-btn odoo-btn-primary">
            <span class="material-icons">add</span>
            Nuevo programa
        </a>

        <a href="/admin/formacion_app/cicloprograma/add/" class="odoo-btn odoo-btn-secondary">
            <span class="material-icons">event</span>
            Nuevo ciclo
        </a>

        <a href="/admin/formacion_app/grupoformativo/add/" class="odoo-btn odoo-btn-secondary">
            <span class="material-icons">groups</span>
            Nuevo grupo
        </a>
    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════════════════
     CONTENIDO DEL DASHBOARD
     ══════════════════════════════════════════════════════════════════════════ -->
<div class="odoo-dashboard">

    <!-- KPIs -->
    <div class="odoo-kpi-row">

        <div class="odoo-kpi-card">
            <div class="odoo-kpi-icon" style="background:#e0f2fe;color:#0284c7;">
                <span class="material-icons">school</span>
            </div>
            <div class="odoo-kpi-content">
                <div class="odoo-kpi-value">{{ total_programas|default:"0" }}</div>
                <div class="odoo-kpi-label">Programas educativos</div>
                <div class="odoo-kpi-sub">Plantillas: Escuela Dominical, Discipulado, etc.</div>
            </div>
        </div>

        <div class="odoo-kpi-card">
            <div class="odoo-kpi-icon" style="background:#ecfeff;color:#0891b2;">
                <span class="material-icons">calendar_month</span>
            </div>
            <div class="odoo-kpi-content">
                <div class="odoo-kpi-value">{{ ciclos_activos|default:"0" }}</div>
                <div class="odoo-kpi-label">Ciclos activos</div>
                <div class="odoo-kpi-sub">{{ total_ciclos|default:"0" }} totales</div>
            </div>
        </div>

        <div class="odoo-kpi-card">
            <div class="odoo-kpi-icon" style="background:#ede9fe;color:#6d28d9;">
                <span class="material-icons">groups</span>
            </div>
            <div class="odoo-kpi-content">
                <div class="odoo-kpi-value">{{ total_grupos|default:"0" }}</div>
                <div class="odoo-kpi-label">Grupos / clases</div>
                <div class="odoo-kpi-sub">Varones, Hembras y Mixtos por edades</div>
            </div>
        </div>

        <div class="odoo-kpi-card">
            <div class="odoo-kpi-icon" style="background:#d1fae5;color:#065f46;">
                <span class="material-icons">how_to_reg</span>
            </div>
            <div class="odoo-kpi-content">
                <div class="odoo-kpi-value">{{ total_inscritos|default:"0" }}</div>
                <div class="odoo-kpi-label">Inscritos</div>
                <div class="odoo-kpi-sub">{{ inscritos_activos|default:"0" }} activos</div>
            </div>
        </div>

    </div>

    <!-- GRID -->
    <div class="odoo-dashboard-grid">

        <!-- Columna izquierda -->
        <div class="odoo-dashboard-column">

            <!-- Estado general -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Estado general</h2>
                    <span class="odoo-panel-badge">{{ ciclos_activos|default:"0" }} ciclos activos</span>
                </div>

                <div class="odoo-alerts-grid">
                    <div class="odoo-alert-item" style="background:#ecfdf5;">
                        <span class="material-icons" style="color:#059669;">check_circle</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value" style="color:#065f46;">{{ programas_activos|default:"0" }}</div>
                            <div class="odoo-alert-label" style="color:#065f46;">Programas activos</div>
                        </div>
                    </div>

                    <div class="odoo-alert-item" style="background:#f3f4f6;">
                        <span class="material-icons" style="color:#6b7280;">pause_circle</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value" style="color:#374151;">{{ programas_inactivos|default:"0" }}</div>
                            <div class="odoo-alert-label" style="color:#374151;">Programas inactivos</div>
                        </div>
                    </div>

                    <div class="odoo-alert-item">
                        <span class="material-icons">warning_amber</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value">{{ grupos_sin_maestro|default:"0" }}</div>
                            <div class="odoo-alert-label">Grupos sin maestro</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribución por sexo permitido -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Distribución de grupos</h2>
                    <span class="odoo-panel-badge">{{ total_grupos|default:"0" }} total</span>
                </div>

                {% if distribucion_sexo %}
                <div class="chart-distribution">
                    <div class="donut-chart-container">
                        <svg class="donut-chart" viewBox="0 0 160 160">
                            {% for row in distribucion_sexo %}
                                <circle class="donut-segment"
                                        data-value="{{ row.total }}"
                                        data-name="{{ row.label }}"
                                        data-index="{{ forloop.counter0 }}"></circle>
                            {% endfor %}
                            <circle cx="80" cy="80" r="45" fill="#fff"/>
                            <text x="80" y="75" class="donut-total">{{ total_grupos|default:"0" }}</text>
                            <text x="80" y="92" class="donut-label">grupos</text>
                        </svg>
                    </div>

                    <div class="chart-legend">
                        {% for row in distribucion_sexo %}
                            {% if total_grupos %}
                                {% widthratio row.total total_grupos 100 as pct %}
                            {% endif %}
                            <div class="legend-item">
                                <span class="legend-color" data-index="{{ forloop.counter0 }}"></span>
                                <span class="legend-name">{{ row.label }}</span>
                                <span class="legend-value">{{ row.total }}</span>
                                <span class="legend-pct">{% if total_grupos %}{{ pct }}{% else %}0{% endif %}%</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <p class="odoo-empty">Aún no hay grupos creados.</p>
                {% endif %}
            </div>

        </div>

        <!-- Columna derecha -->
        <div class="odoo-dashboard-column">

            <!-- Programas con más inscritos -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Programas con más inscritos</h2>
                    <span class="odoo-panel-sub">Top 5</span>
                </div>

                {% if top_programas %}
                <ul class="odoo-recent-list">
                    {% for p in top_programas %}
                    <li class="odoo-recent-item">
                        <div class="odoo-recent-avatar" style="background:#017e84;">
                            {{ p.nombre|slice:":1"|upper }}
                        </div>
                        <div class="odoo-recent-info">
                            <div class="odoo-recent-name">{{ p.nombre }}</div>
                            <div class="odoo-recent-sub">{{ p.total_inscritos }} inscritos</div>
                        </div>
                        <span class="odoo-recent-badge odoo-badge-new">{{ p.total_inscritos }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="odoo-empty">Aún no hay inscripciones registradas.</p>
                {% endif %}
            </div>

            <!-- Grupos sin maestro -->
            {% if grupos_sin_maestro_lista %}
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Requieren atención</h2>
                    <span class="odoo-panel-badge" style="background:#fef2f2;color:#991b1b;">
                        {{ grupos_sin_maestro|default:"0" }} sin maestro
                    </span>
                </div>

                <ul class="odoo-recent-list">
                    {% for g in grupos_sin_maestro_lista|slice:":5" %}
                    <li class="odoo-recent-item" style="background:#fef2f2;">
                        <div class="odoo-recent-avatar" style="background:#dc2626;">
                            <span class="material-icons" style="font-size:16px;">warning</span>
                        </div>
                        <div class="odoo-recent-info">
                            <a href="/admin/formacion_app/grupoformativo/{{ g.id }}/change/" class="odoo-recent-name">
                                {{ g.nombre }}
                            </a>
                            <div class="odoo-recent-sub">{{ g.ciclo.programa.nombre }} · {{ g.ciclo.nombre }}</div>
                        </div>
                        <a href="/admin/formacion_app/grupoformativo/{{ g.id }}/change/" class="odoo-btn-mini">
                            <span class="material-icons">edit</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
/* Misma base visual que tu dashboard de Estructura (look & feel idéntico) */
.odoo-control-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:#f8f9fa;border-bottom:1px solid #dee2e6}
.odoo-control-left,.odoo-control-right{display:flex;align-items:center;gap:12px}
.odoo-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;font-size:13px;font-weight:500;border:none;border-radius:4px;cursor:pointer;text-decoration:none;transition:all .15s ease}
.odoo-btn .material-icons{font-size:18px}
.odoo-btn-primary{background:#017e84;color:#fff}
.odoo-btn-primary:hover{background:#016166}
.odoo-btn-secondary{background:#fff;color:#495057;border:1px solid #dee2e6}
.odoo-btn-secondary:hover{background:#e9ecef}

.odoo-dashboard{padding:16px;background:#f8f9fa;min-height:calc(100vh - 120px);display:flex;flex-direction:column;gap:16px}

.odoo-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.odoo-kpi-card{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px;display:flex;align-items:center;gap:16px}
.odoo-kpi-icon{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.odoo-kpi-icon .material-icons{font-size:24px}
.odoo-kpi-content{flex:1;min-width:0}
.odoo-kpi-value{font-size:28px;font-weight:700;color:#212529;line-height:1}
.odoo-kpi-label{font-size:13px;font-weight:500;color:#495057;margin-top:4px}
.odoo-kpi-sub{font-size:11px;color:#6c757d;margin-top:2px}

.odoo-dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.odoo-dashboard-column{display:flex;flex-direction:column;gap:16px}

.odoo-panel{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px}
.odoo-panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e9ecef}
.odoo-panel-header h2{font-size:14px;font-weight:600;color:#212529;margin:0}
.odoo-panel-badge{font-size:11px;background:#e9ecef;color:#495057;padding:2px 8px;border-radius:10px}
.odoo-panel-sub{font-size:11px;color:#6c757d}
.odoo-empty{font-size:13px;color:#6c757d;text-align:center;padding:20px}

.chart-distribution{display:flex;align-items:center;gap:24px}
.donut-chart-container{flex-shrink:0;width:160px;height:160px}
.donut-chart{width:100%;height:100%;transform:rotate(-90deg)}
.donut-segment{fill:none;stroke-width:28;cx:80;cy:80;r:60;transition:stroke-dashoffset .3s ease, opacity .2s}
.donut-segment:hover{opacity:.85;cursor:pointer}
.donut-total{font-size:28px;font-weight:700;fill:#212529;text-anchor:middle;transform:rotate(90deg);transform-origin:80px 80px}
.donut-label{font-size:11px;fill:#6c757d;text-anchor:middle;transform:rotate(90deg);transform-origin:80px 80px}

.chart-legend{flex:1;display:flex;flex-direction:column;gap:8px}
.legend-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f8f9fa;border-radius:6px;transition:background .15s}
.legend-item:hover{background:#e9ecef}
.legend-color{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.legend-name{flex:1;font-size:12px;color:#495057;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.legend-value{font-size:13px;font-weight:600;color:#212529;min-width:24px;text-align:right}
.legend-pct{font-size:11px;color:#6c757d;min-width:32px;text-align:right}

/* Colores segmentos */
.donut-segment[data-index="0"], .legend-color[data-index="0"]{stroke:#017e84;background:#017e84}
.donut-segment[data-index="1"], .legend-color[data-index="1"]{stroke:#0ea5e9;background:#0ea5e9}
.donut-segment[data-index="2"], .legend-color[data-index="2"]{stroke:#8b5cf6;background:#8b5cf6}
.donut-segment[data-index="3"], .legend-color[data-index="3"]{stroke:#f59e0b;background:#f59e0b}
.donut-segment[data-index="4"], .legend-color[data-index="4"]{stroke:#ef4444;background:#ef4444}

.odoo-alerts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.odoo-alert-item{display:flex;align-items:center;gap:10px;padding:12px;background:#fef2f2;border-radius:6px}
.odoo-alert-item .material-icons{font-size:20px;color:#dc2626}
.odoo-alert-value{font-size:18px;font-weight:700;color:#991b1b}
.odoo-alert-label{font-size:11px;color:#991b1b}

.odoo-recent-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
.odoo-recent-item{display:flex;align-items:center;gap:12px;padding:8px;background:#f8f9fa;border-radius:6px}
.odoo-recent-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:600;flex-shrink:0;overflow:hidden}
.odoo-recent-info{flex:1;min-width:0}
.odoo-recent-name{font-size:13px;font-weight:500;color:#212529;text-decoration:none;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.odoo-recent-sub{font-size:11px;color:#6c757d}
.odoo-recent-badge{font-size:10px;font-weight:500;padding:2px 8px;border-radius:10px;flex-shrink:0}
.odoo-badge-new{background:#d1fae5;color:#065f46}

.odoo-btn-mini{display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:#fff;border:1px solid #dee2e6;border-radius:6px;color:#017e84;text-decoration:none;transition:all .15s}
.odoo-btn-mini:hover{background:#017e84;color:#fff;border-color:#017e84}
.odoo-btn-mini .material-icons{font-size:18px}

@media (max-width:1200px){.odoo-kpi-row{grid-template-columns:repeat(2,1fr)}}
@media (max-width:992px){.odoo-dashboard-grid{grid-template-columns:1fr}.odoo-alerts-grid{grid-template-columns:1fr}}
@media (max-width:640px){
  .odoo-dashboard{padding:12px;gap:12px}
  .odoo-control-bar{padding:8px 12px}
  .odoo-btn{padding:6px 10px;font-size:12px}
  .odoo-btn .material-icons{font-size:16px}
  .odoo-kpi-row{grid-template-columns:repeat(2,1fr);gap:8px}
  .odoo-kpi-card{padding:10px;gap:10px}
  .odoo-kpi-icon{width:36px;height:36px;border-radius:6px}
  .odoo-kpi-icon .material-icons{font-size:18px}
  .odoo-kpi-value{font-size:20px}
  .odoo-kpi-label{font-size:11px;margin-top:2px}
  .odoo-kpi-sub{display:none}
  .odoo-panel{padding:12px;border-radius:6px}
  .odoo-panel-header{margin-bottom:10px;padding-bottom:8px}
  .odoo-panel-header h2{font-size:13px}
  .chart-distribution{flex-direction:column;gap:16px}
  .donut-chart-container{width:140px;height:140px;margin:0 auto}
  .donut-total{font-size:24px}
  .legend-item{padding:5px 8px}
  .legend-name{font-size:11px}
  .legend-value{font-size:12px}
  .legend-pct{font-size:10px}
  .odoo-recent-item{padding:6px 8px;gap:10px}
  .odoo-recent-avatar{width:32px;height:32px;font-size:12px}
  .odoo-recent-name{font-size:12px}
  .odoo-recent-sub{font-size:10px}
  .odoo-recent-badge{font-size:9px;padding:2px 6px}
  .odoo-empty{padding:16px;font-size:12px}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const segments = document.querySelectorAll('.donut-segment');
    if (!segments.length) return;

    let total = 0;
    segments.forEach(seg => total += parseInt(seg.dataset.value || "0", 10));

    if (!total) return;

    const circumference = 2 * Math.PI * 60;
    let currentOffset = 0;

    segments.forEach((segment) => {
        const value = parseInt(segment.dataset.value || "0", 10);
        const pct = value / total;
        const len = circumference * pct;

        segment.style.strokeDasharray = `${len} ${circumference}`;
        segment.style.strokeDashoffset = -currentOffset;

        currentOffset += len;
    });
});
</script>

{% endblock %}
