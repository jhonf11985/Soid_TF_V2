{% extends 'formacion_app/base_formacion.html' %}
{% load static %}

{% block formacion_content %}
<style>
  :root{
    --k-bg: #f6f7fb;
    --k-card: #ffffff;
    --k-border: #e9ecef;
    --k-muted: #6c757d;
    --k-text: #212529;
    --k-primary: #5c9ead;   /* Tu color */
    --k-primary-2: #4a7d8d;
    --k-primary-light: rgba(92,158,173,.08);
    --k-shadow: 0 18px 55px rgba(16,24,40,.12);
    --k-radius: 18px;
  }

  /* ============ MODO KIOSKO: ocultar "todo lo dem√°s" del layout ============ */
  html, body { height: 100%; }
  body { overflow: hidden; background: var(--k-bg) !important; }

  /* Oculta elementos t√≠picos del layout (sidebar/topbar/footer/breadcrumbs) */
  header, .topbar, .navbar, .app-header, .header,
  aside, .sidebar, .app-sidebar, nav.sidebar, .layout-sidebar,
  .breadcrumb, .breadcrumbs, .footer, footer,
  .sidebar-nav, .sidebar-container, .sidebar-wrapper,
  .main-header, .page-header, .page-titlebar {
    display: none !important;
  }

  /* Resetea contenedores t√≠picos para que no empujen hacia abajo */
  main, .main, .content, .page-content, .container, .container-fluid,
  .layout, .layout-content, .app-content, .content-wrapper, .page-wrapper,
  .odoo-content, .odoo-page, .odoo-main {
    padding: 0 !important;
    margin: 0 !important;
    max-width: none !important;
    width: 100% !important;
  }

  /* ============ KIOSKO: CENTRADO PERFECTO ============ */
  .kiosko-wrap{
    height: 100vh;
    width: 100vw;
    display: flex;
    align-items: center;      /* ‚úÖ centra vertical */
    justify-content: center;  /* ‚úÖ centra horizontal */
    padding: 18px;
    box-sizing: border-box;
    background: linear-gradient(135deg, #f0f4f8 0%, #e3eef7 100%);
  }

  .kiosko-card{
    width: min(800px, 100%);
    background: var(--k-card);
    border: 1px solid var(--k-border);
    border-radius: var(--k-radius);
    box-shadow: 0 20px 60px rgba(92,158,173,.15);
    overflow: hidden;
  }

  .kiosko-header{
    padding: 18px 20px;
    background: linear-gradient(135deg, var(--k-primary-light) 0%, rgba(92,158,173,.12) 100%);
    border-bottom: 2px solid var(--k-primary);
    display:flex;
    align-items:flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .kiosko-title{
    margin: 0;
    font-size: 22px;
    font-weight: 900;
    color: var(--k-primary);
    letter-spacing: .3px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .kiosko-sub{
    margin-top: 6px;
    color: var(--k-muted);
    font-size: 14px;
    font-weight: 700;
    line-height: 1.3;
  }

  .kiosko-exit{
    display:inline-flex;
    align-items:center;
    gap:8px;
    text-decoration:none;
    background:#fff;
    color: var(--k-primary);
    border: 2px solid rgba(92,158,173,.3);
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 900;
    white-space: nowrap;
    transition: all .2s ease;
  }
  .kiosko-exit:active{ transform: scale(.98); }
  .kiosko-exit:hover{ 
    background: var(--k-primary-light);
    border-color: var(--k-primary);
  }

  .kiosko-body{
    padding: 20px 22px 24px 22px;
  }

  /* Display tipo "pantalla" */
  .kiosko-label{
    display:block;
    font-size: 13px;
    color: var(--k-muted);
    margin-bottom: 8px;
    letter-spacing: .3px;
    text-transform: uppercase;
    font-weight: 800;
  }

  .kiosko-display{
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 3px solid var(--k-primary);
    border-radius: 16px;
    padding: 16px 14px;
    box-shadow: inset 0 2px 8px rgba(92,158,173,.08);
  }

  .kiosko-input{
    width:100%;
    border:none;
    outline:none;
    background: transparent;
    font-size: clamp(24px, 3.5vw, 36px);
    font-weight: 900;
    letter-spacing: .28em;
    text-align: center;
    color: var(--k-primary);
  }

  .kiosko-hint{
    margin-top: 10px;
    color: var(--k-muted);
    font-size: 14px;
    text-align: center;
    font-weight: 600;
  }

  /* Teclado */
  .pad{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 16px;
  }

  .pad-btn{
    height: 68px;
    border-radius: 14px;
    border: 2px solid var(--k-border);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    font-size: 24px;
    font-weight: 900;
    color: var(--k-text);
    cursor: pointer;
    user-select: none;
    touch-action: manipulation;
    transition: all .15s ease;
    box-shadow: 0 4px 12px rgba(16,24,40,.06);
  }
  .pad-btn:hover{ 
    background: linear-gradient(135deg, var(--k-primary-light) 0%, rgba(92,158,173,.12) 100%);
    border-color: var(--k-primary);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(92,158,173,.15);
  }
  .pad-btn:active{
    transform: scale(.97);
    box-shadow: 0 2px 8px rgba(16,24,40,.10);
  }
  .pad-btn.pad-action{ font-size: 16px; letter-spacing: .3px; }
  .pad-btn.pad-back{ font-size: 20px; }

  /* Acciones */
  .kiosko-actions{
    display:flex;
    gap: 12px;
    margin-top: 18px;
    flex-wrap: wrap;
  }

  .btn-primary{
    flex: 1;
    min-width: 220px;
    border: none;
    border-radius: 14px;
    padding: 16px 18px;
    background: var(--k-primary);
    color:#fff;
    font-weight: 900;
    font-size: 16px;
    letter-spacing: .5px;
    cursor: pointer;
    transition: all .2s ease;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    touch-action: manipulation;
    box-shadow: 0 4px 12px rgba(92,158,173,.25);
  }
  .btn-primary:hover{ 
    background: var(--k-primary-2);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(92,158,173,.35);
  }
  .btn-primary:active{ transform: scale(.99); }

  .btn-ghost{
    border: 2px solid var(--k-border);
    background: #ffffff;
    color: var(--k-text);
    border-radius: 14px;
    padding: 16px 18px;
    font-weight: 900;
    font-size: 15px;
    cursor: pointer;
    transition: all .2s ease;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    touch-action: manipulation;
  }
  .btn-ghost:hover{ 
    background: var(--k-primary-light);
    border-color: var(--k-primary);
  }
  .btn-ghost:active{ transform: scale(.99); }

  /* Resultado (debajo de botones) */
  .kiosko-result{
    margin-top: 16px;
    border-radius: 14px;
    padding: 14px 16px;
    display:none;
    align-items:flex-start;
    gap: 12px;
    border: 2px solid transparent;
  }
  .kiosko-result .icon{ font-size: 22px; line-height: 1; margin-top: 2px; }
  .kiosko-result .text{ font-size: 15px; font-weight: 800; line-height: 1.3; }
  .kiosko-result .sub{ margin-top: 4px; font-size: 13px; font-weight: 700; opacity: .9; }

  .is-ok{
    background: linear-gradient(135deg, rgba(25,135,84,.08) 0%, rgba(25,135,84,.12) 100%);
    border-color: rgba(25,135,84,.25);
    color: #0f5132;
  }
  .is-bad{
    background: linear-gradient(135deg, rgba(220,53,69,.08) 0%, rgba(220,53,69,.12) 100%);
    border-color: rgba(220,53,69,.25);
    color: #842029;
  }

  /* Bot√≥n pantalla completa */
  .fs-btn{
    position: fixed;
    right: 16px;
    top: 16px;
    z-index: 99998;
    background: var(--k-primary);
    color: #fff;
    border: none;
    border-radius: 14px;
    padding: 12px 16px;
    font-weight: 900;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 24px rgba(92,158,173,.3);
    transition: all .2s ease;
  }
  .fs-btn:hover{
    background: var(--k-primary-2);
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(92,158,173,.4);
  }
  .fs-btn:active{ transform: scale(.98); }

  /* Overlay bienvenida */
  .welcome-overlay{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(15, 18, 22, .65);
    z-index: 99999;
    backdrop-filter: blur(6px);
  }
  .welcome-box{
    width: min(800px, 92vw);
    background: #fff;
    border-radius: 20px;
    border: 2px solid var(--k-primary);
    padding: 32px 28px;
    box-shadow: 0 24px 72px rgba(92,158,173,.35);
    text-align: center;
  }
  .welcome-ok{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background: linear-gradient(135deg, rgba(25,135,84,.1) 0%, rgba(25,135,84,.15) 100%);
    color:#0f5132;
    border: 2px solid rgba(25,135,84,.25);
    padding: 12px 16px;
    border-radius: 14px;
    font-weight: 900;
    font-size: 15px;
  }
  .welcome-title{
    margin: 16px 0 0 0;
    font-size: clamp(22px, 3.8vw, 38px);
    font-weight: 950;
    color: var(--k-primary);
  }
  .welcome-sub{
    margin-top: 10px;
    font-size: clamp(15px, 2.4vw, 19px);
    color: var(--k-muted);
    font-weight: 800;
  }

  @media (min-width: 820px){
    .pad-btn{ height: 74px; font-size: 26px; }
  }
</style>

<button type="button" id="btnFullscreen" class="fs-btn">
  <span class="material-icons" style="font-size:20px;">fullscreen</span>
  Pantalla completa
</button>

<div id="welcomeOverlay" class="welcome-overlay" aria-live="polite">
  <div class="welcome-box">
    <div class="welcome-ok">‚úÖ Asistencia registrada</div>
    <h3 class="welcome-title" id="welcomeTitle">Bienvenido</h3>
    <div class="welcome-sub" id="welcomeSub">al grupo</div>
  </div>
</div>

<div class="kiosko-wrap">
  <div class="kiosko-card">

    <div class="kiosko-header">
      <div>
        <h2 class="kiosko-title">
          <span class="material-icons" style="font-size:26px;">qr_code_scanner</span>
          Modo Kiosko
        </h2>
        <div class="kiosko-sub">
          üìö {{ grupo.nombre }} ¬∑ üìÖ {{ sesion.fecha|date:"d/m/Y" }}
        </div>
      </div>

      <a class="kiosko-exit" href="{% url 'formacion:sesion_detalle' sesion.id %}">
        <span class="material-icons" style="font-size:20px;">arrow_back</span>
        Salir
      </a>
    </div>

    <div class="kiosko-body">
      <form id="kioskoForm" method="post" autocomplete="off">
        {% csrf_token %}

        <label class="kiosko-label">
          <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">badge</span>
          C√≥digo del miembro
        </label>

        <div class="kiosko-display">
          <input
            id="codigoInput"
            name="codigo"
            type="text"
            inputmode="numeric"
            autocomplete="off"
            class="kiosko-input"
            placeholder="_ _ _ _"
            aria-label="C√≥digo del miembro"
          >
        </div>

        <div class="kiosko-hint">
          üí° Introduce tu c√≥digo con el teclado num√©rico
        </div>

        <div class="pad" aria-label="Teclado num√©rico">
          <button type="button" class="pad-btn" data-key="1">1</button>
          <button type="button" class="pad-btn" data-key="2">2</button>
          <button type="button" class="pad-btn" data-key="3">3</button>

          <button type="button" class="pad-btn" data-key="4">4</button>
          <button type="button" class="pad-btn" data-key="5">5</button>
          <button type="button" class="pad-btn" data-key="6">6</button>

          <button type="button" class="pad-btn" data-key="7">7</button>
          <button type="button" class="pad-btn" data-key="8">8</button>
          <button type="button" class="pad-btn" data-key="9">9</button>

          <button type="button" class="pad-btn pad-action" data-action="clear">Borrar</button>
          <button type="button" class="pad-btn" data-key="0">0</button>
          <button type="button" class="pad-btn pad-back" data-action="back">‚å´</button>
        </div>

        <div class="kiosko-actions">
          <button type="submit" id="btnMarcar" class="btn-primary">
            <span class="material-icons" style="font-size:22px;">check_circle</span>
            MARCAR ASISTENCIA
          </button>

          <button type="button" id="btnLimpiar" class="btn-ghost">
            <span class="material-icons" style="font-size:20px;">restart_alt</span>
            Limpiar
          </button>
        </div>

        <div id="resultado" class="kiosko-result" role="status" aria-live="polite">
          <div class="icon" id="resultadoIcon">‚úîÔ∏è</div>
          <div>
            <div class="text" id="resultadoText">Mensaje</div>
            <div class="sub" id="resultadoSub" style="display:none;"></div>
          </div>
        </div>

      </form>
    </div>

  </div>
</div>

<script>
(function () {
  const form = document.getElementById('kioskoForm');
  const input = document.getElementById('codigoInput');

  const box = document.getElementById('resultado');
  const icon = document.getElementById('resultadoIcon');
  const text = document.getElementById('resultadoText');
  const sub  = document.getElementById('resultadoSub');

  const btnLimpiar = document.getElementById('btnLimpiar');

  // Fullscreen
  const btnFS = document.getElementById('btnFullscreen');
  function isFS(){ return !!document.fullscreenElement; }
  async function enterFullscreen(){
    try{
      await document.documentElement.requestFullscreen();
      btnFS.style.display = 'none';
    }catch(e){
      console.warn('Fullscreen bloqueado por el navegador:', e);
    }
  }
  btnFS?.addEventListener('click', enterFullscreen);
  document.addEventListener('fullscreenchange', () => {
    btnFS.style.display = isFS() ? 'none' : 'inline-flex';
  });

  // Welcome overlay
  const overlay = document.getElementById('welcomeOverlay');
  const wTitle = document.getElementById('welcomeTitle');
  const wSub = document.getElementById('welcomeSub');
  let welcomeTimer = null;

  function showWelcome(nombre, grupo){
    if (welcomeTimer) clearTimeout(welcomeTimer);
    wTitle.textContent = `Bienvenido, ${nombre || 'miembro'} üëã`;
    wSub.textContent = grupo ? `al grupo ${grupo}` : `al grupo`;
    overlay.style.display = 'flex';
    welcomeTimer = setTimeout(() => overlay.style.display = 'none', 2000);
  }
  overlay?.addEventListener('click', () => overlay.style.display = 'none');

  // UX
  const MAX_LEN = 8;
  let hideTimer = null;

  function focusInput() {
    input.focus({ preventScroll: true });
  }
  function setValue(v){ input.value = v; }
  function appendDigit(d){
    const cur = (input.value || '').replace(/\s+/g,'');
    if (cur.length >= MAX_LEN) return;
    setValue(cur + d);
  }
  function backspace(){
    const cur = (input.value || '');
    if (!cur) return;
    setValue(cur.slice(0, -1));
  }
  function clearAll(){ setValue(''); }

  function show(msg, ok, extra){
    if (hideTimer) clearTimeout(hideTimer);

    box.style.display = 'flex';
    box.classList.remove('is-ok','is-bad');
    box.classList.add(ok ? 'is-ok' : 'is-bad');

    icon.textContent = ok ? '‚úîÔ∏è' : '‚ö†Ô∏è';
    text.textContent = msg;

    if (extra){
      sub.style.display = 'block';
      sub.textContent = extra;
    } else {
      sub.style.display = 'none';
      sub.textContent = '';
    }

    hideTimer = setTimeout(() => { box.style.display = 'none'; }, ok ? 2000 : 2500);
  }

  // Pad events
  document.querySelectorAll('.pad-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      const action = btn.dataset.action;

      if (key) appendDigit(key);
      if (action === 'back') backspace();
      if (action === 'clear') clearAll();

      focusInput();
    });
  });

  btnLimpiar.addEventListener('click', () => {
    clearAll();
    focusInput();
  });

  async function marcar(e){
    e.preventDefault();

    const codigo = (input.value || '').trim();
    if (!codigo){
      show("Introduce el c√≥digo.", false);
      focusInput();
      return;
    }

    const formData = new FormData(form);

    const res = await fetch("{% url 'formacion:sesion_kiosko_marcar' sesion.id %}", {
      method: "POST",
      credentials: "same-origin",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      body: formData
    });

    let data = null;
    try { data = await res.json(); } catch (e) {}

    if (data && data.ok){
      const nombre = data.nombre || "";
      const grupo  = data.grupo || "{{ grupo.nombre|escapejs }}";

      show(data.msg || "Asistencia registrada ‚úÖ", true, data.marcado_en ? ("Marcado: " + data.marcado_en) : "");

      // Bienvenida grande
      showWelcome(nombre, grupo);

    } else {
      show((data && data.msg) ? data.msg : "Error marcando asistencia.", false);
    }

    clearAll();
    focusInput();
  }

  form.addEventListener("submit", marcar);

  // Mantener el foco
  setTimeout(() => focusInput(), 150);

  // Bloqueo de letras
  input.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','Tab','Enter'];
    if (allowed.includes(e.key)) return;
    if (/^\d$/.test(e.key)) return;
    e.preventDefault();
  });

})();
</script>
{% endblock %}