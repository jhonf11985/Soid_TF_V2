{% extends 'formacion_app/base_formacion.html' %}
{% load static %}

{% block formacion_content %}
<style>
/* =========================================================================
   REPORTE DE ANÁLISIS DE GRUPOS
   ========================================================================= */

.reporte-container {
    padding: 0;
    background: #f8f9fa;
    min-height: calc(100vh - 120px);
}

/* CONTROL BAR */
.reporte-control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: #fff;
    border-bottom: 1px solid #dee2e6;
    flex-wrap: wrap;
    gap: 12px;
}

.reporte-title-section h1 {
    font-size: 20px;
    font-weight: 600;
    color: #212529;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.reporte-title-section h1 .material-icons {
    color: #714B67;
}

.reporte-title-section .subtitle {
    font-size: 13px;
    color: #6c757d;
    margin-top: 2px;
}

.reporte-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-reporte {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
    background: #fff;
    color: #495057;
}

.btn-reporte:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
    color: #495057;
}

.btn-reporte.primary {
    background: #714B67;
    color: white;
    border-color: #714B67;
}

.btn-reporte.primary:hover {
    background: #5a3d53;
    color: white;
}

.btn-reporte .material-icons {
    font-size: 18px;
}

/* RESUMEN CARDS */
.resumen-section {
    padding: 20px 24px;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
}

.resumen-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
}

.resumen-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.resumen-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.resumen-card.active {
    border-color: #714B67;
    box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.15);
}

.resumen-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.resumen-card-icon .material-icons {
    font-size: 24px;
    color: white;
}

.resumen-card-icon.total { background: linear-gradient(135deg, #714B67, #8e6384); }
.resumen-card-icon.faltan { background: linear-gradient(135deg, #0ea5e9, #38bdf8); }
.resumen-card-icon.sobran { background: linear-gradient(135deg, #f97316, #fb923c); }
.resumen-card-icon.excedidos { background: linear-gradient(135deg, #ef4444, #f87171); }
.resumen-card-icon.sin-maestro { background: linear-gradient(135deg, #eab308, #facc15); }
.resumen-card-icon.vacios { background: linear-gradient(135deg, #6b7280, #9ca3af); }

.resumen-card-content {
    flex: 1;
}

.resumen-card-number {
    font-size: 28px;
    font-weight: 700;
    color: #212529;
    line-height: 1;
}

.resumen-card-label {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
}

/* FILTROS */
.filtros-section {
    padding: 16px 24px;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.filtro-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filtro-group label {
    font-size: 13px;
    font-weight: 500;
    color: #495057;
    white-space: nowrap;
}

.filtro-select {
    padding: 6px 28px 6px 10px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
    color: #495057;
    background: #fff;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
}

.filtro-select:focus {
    outline: none;
    border-color: #714B67;
}

.filtro-search {
    position: relative;
    flex: 1;
    max-width: 300px;
}

.filtro-search input {
    width: 100%;
    padding: 6px 10px 6px 32px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
}

.filtro-search input:focus {
    outline: none;
    border-color: #714B67;
}

.filtro-search .material-icons {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: #adb5bd;
}

.btn-limpiar {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
    background: #fff;
    color: #6c757d;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.btn-limpiar:hover {
    background: #f8f9fa;
}

.btn-limpiar .material-icons {
    font-size: 16px;
}

/* TABLA DE RESULTADOS */
.resultados-section {
    padding: 20px 24px;
}

.resultados-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.resultados-count {
    font-size: 14px;
    color: #6c757d;
}

.resultados-count strong {
    color: #212529;
}

.resultados-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    overflow: hidden;
}

/* GRUPO EXPANDIBLE */
.grupo-item {
    border-bottom: 1px solid #e9ecef;
}

.grupo-item:last-child {
    border-bottom: none;
}

.grupo-header {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    cursor: pointer;
    transition: background 0.15s;
    gap: 16px;
}

.grupo-header:hover {
    background: #f8f9fa;
}

.grupo-expand-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s;
    flex-shrink: 0;
}

.grupo-item.expanded .grupo-expand-icon {
    background: #714B67;
    color: white;
    transform: rotate(90deg);
}

.grupo-expand-icon .material-icons {
    font-size: 18px;
}

.grupo-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
}

.grupo-avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: linear-gradient(135deg, #714B67 0%, #8e6384 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.grupo-avatar .material-icons {
    font-size: 20px;
}

.grupo-details {
    flex: 1;
    min-width: 0;
}

.grupo-nombre {
    font-weight: 600;
    color: #212529;
    margin-bottom: 2px;
}

.grupo-meta {
    font-size: 12px;
    color: #6c757d;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.grupo-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.grupo-meta-item .material-icons {
    font-size: 14px;
}

/* BADGES DE ESTADO */
.grupo-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.badge-stat {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
}

.badge-stat .material-icons {
    font-size: 14px;
}

.badge-stat.inscritos {
    background: #d1fae5;
    color: #065f46;
}

.badge-stat.faltan {
    background: #dbeafe;
    color: #1e40af;
}

.badge-stat.sobran {
    background: #ffedd5;
    color: #c2410c;
}

.badge-stat.excedido {
    background: #fee2e2;
    color: #991b1b;
}

.badge-stat.sin-maestro {
    background: #fef3c7;
    color: #92400e;
}

/* CONTENIDO EXPANDIBLE */
.grupo-content {
    display: none;
    padding: 0 20px 20px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.grupo-item.expanded .grupo-content {
    display: block;
}

/* TABS DENTRO DEL GRUPO */
.grupo-content-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    border-bottom: 2px solid #dee2e6;
    padding-top: 16px;
}

.content-tab {
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    background: none;
    border: none;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.content-tab:hover {
    color: #495057;
}

.content-tab.active {
    color: #714B67;
    border-bottom-color: #714B67;
}

.content-tab .count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    margin-left: 6px;
    border-radius: 10px;
    font-size: 11px;
    background: #e9ecef;
    color: #495057;
}

.content-tab.active .count {
    background: #714B67;
    color: white;
}

.content-panel {
    display: none;
}

.content-panel.active {
    display: block;
}

/* HEADER DE PANEL CON BOTÓN IMPRIMIR */
.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.panel-title {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 8px;
}

.panel-title .material-icons {
    font-size: 18px;
    color: #714B67;
}

.btn-print-list {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    background: #fff;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-print-list:hover {
    background: #714B67;
    color: white;
    border-color: #714B67;
}

.btn-print-list .material-icons {
    font-size: 16px;
}

/* LISTA DE MIEMBROS */
.miembros-list {
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    max-height: 400px;
    overflow-y: auto;
}

.miembro-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
    font-size: 13px;
}

.miembro-item:last-child {
    border-bottom: none;
}

.miembro-item:nth-child(even) {
    background: #fafafa;
}

.miembro-numero {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
}

.miembro-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6b7280, #9ca3af);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
}

.miembro-info {
    flex: 1;
    min-width: 0;
}

.miembro-nombre {
    font-weight: 500;
    color: #212529;
}

.miembro-codigo {
    font-size: 11px;
    color: #6c757d;
}

.miembro-extra {
    font-size: 11px;
    color: #6c757d;
    text-align: right;
}

.miembro-razon {
    font-size: 11px;
    color: #f97316;
    display: flex;
    align-items: center;
    gap: 4px;
}

.miembro-razon .material-icons {
    font-size: 14px;
}

.empty-list {
    padding: 32px;
    text-align: center;
    color: #6c757d;
    font-size: 13px;
}

.empty-list .material-icons {
    font-size: 40px;
    color: #adb5bd;
    display: block;
    margin-bottom: 12px;
}

/* =========================================================================
   MODAL DE IMPRESIÓN
   ========================================================================= */
.print-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.print-modal-overlay.active {
    display: flex;
}

.print-modal {
    background: #fff;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.print-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

.print-modal-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: #212529;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.print-modal-header h2 .material-icons {
    color: #714B67;
}

.print-modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    color: #6c757d;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.print-modal-close:hover {
    background: #e9ecef;
    color: #212529;
}

.print-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}

.print-modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

/* CONTENIDO IMPRIMIBLE */
.print-content {
    font-family: Arial, sans-serif;
}

.print-header {
    text-align: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #714B67;
}

.print-header h1 {
    font-size: 20px;
    color: #212529;
    margin: 0 0 4px 0;
}

.print-header .print-subtitle {
    font-size: 14px;
    color: #6c757d;
}

.print-header .print-date {
    font-size: 12px;
    color: #adb5bd;
    margin-top: 8px;
}

.print-info {
    display: flex;
    gap: 24px;
    margin-bottom: 20px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.print-info-item {
    font-size: 13px;
}

.print-info-item strong {
    color: #495057;
}

.print-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.print-table th {
    background: #714B67;
    color: white;
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
}

.print-table th:first-child {
    width: 50px;
    text-align: center;
}

.print-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e9ecef;
}

.print-table td:first-child {
    text-align: center;
    color: #6c757d;
}

.print-table tr:nth-child(even) {
    background: #f8f9fa;
}

.print-total {
    margin-top: 16px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    font-size: 14px;
    text-align: right;
}

.print-total strong {
    color: #714B67;
}

/* PRINT STYLES */
@media print {
    body * {
        visibility: hidden;
    }
    
    .print-modal, .print-modal * {
        visibility: visible;
    }
    
    .print-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: none;
        max-height: none;
        box-shadow: none;
        border-radius: 0;
    }
    
    .print-modal-header,
    .print-modal-footer,
    .print-modal-close {
        display: none !important;
    }
    
    .print-modal-body {
        padding: 20px;
        overflow: visible;
    }
    
    .print-table {
        page-break-inside: auto;
    }
    
    .print-table tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
}

/* RESPONSIVE */
@media (max-width: 992px) {
    .resumen-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .filtros-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filtro-group {
        width: 100%;
    }
    
    .filtro-select {
        flex: 1;
    }
    
    .filtro-search {
        max-width: none;
    }
}

@media (max-width: 768px) {
    .resumen-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .grupo-badges {
        display: none;
    }
    
    .grupo-content {
        padding-left: 16px;
        padding-right: 16px;
    }
    
    .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .resumen-grid {
        grid-template-columns: 1fr;
    }
    
    .resumen-card {
        padding: 12px 16px;
    }
    
    .resumen-card-number {
        font-size: 24px;
    }
    
    .grupo-content-tabs {
        overflow-x: auto;
    }
    
    .content-tab {
        white-space: nowrap;
    }
}
</style>

<div class="reporte-container">
    <!-- BARRA DE CONTROL -->
    <div class="reporte-control-bar">
        <div class="reporte-title-section">
            <h1>
                <span class="material-icons">assessment</span>
                Análisis de Grupos
            </h1>
            <div class="subtitle">Reporte detallado de inscripciones y cumplimiento de reglas</div>
        </div>
        
        <div class="reporte-actions">
            <a href="{% url 'formacion:grupos' %}" class="btn-reporte">
                <span class="material-icons">arrow_back</span>
                Volver
            </a>
        </div>
    </div>
    
    <!-- RESUMEN CARDS -->
    <div class="resumen-section">
        <div class="resumen-grid">
            <div class="resumen-card" data-filtro="todos">
                <div class="resumen-card-icon total">
                    <span class="material-icons">groups</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.total_grupos }}</div>
                    <div class="resumen-card-label">Grupos totales</div>
                </div>
            </div>
            
            <div class="resumen-card" data-filtro="con-faltantes">
                <div class="resumen-card-icon faltan">
                    <span class="material-icons">person_add</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.grupos_con_faltantes }}</div>
                    <div class="resumen-card-label">Con faltantes</div>
                </div>
            </div>
            
            <div class="resumen-card" data-filtro="con-sobrantes">
                <div class="resumen-card-icon sobran">
                    <span class="material-icons">person_remove</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.grupos_con_sobrantes }}</div>
                    <div class="resumen-card-label">No cumplen reglas</div>
                </div>
            </div>
            
            <div class="resumen-card" data-filtro="excedidos">
                <div class="resumen-card-icon excedidos">
                    <span class="material-icons">error</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.grupos_excedidos }}</div>
                    <div class="resumen-card-label">Cupo excedido</div>
                </div>
            </div>
            
            <div class="resumen-card" data-filtro="sin-maestro">
                <div class="resumen-card-icon sin-maestro">
                    <span class="material-icons">school</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.grupos_sin_maestro }}</div>
                    <div class="resumen-card-label">Sin maestro</div>
                </div>
            </div>
            
            <div class="resumen-card" data-filtro="vacios">
                <div class="resumen-card-icon vacios">
                    <span class="material-icons">group_off</span>
                </div>
                <div class="resumen-card-content">
                    <div class="resumen-card-number">{{ stats.grupos_vacios }}</div>
                    <div class="resumen-card-label">Sin alumnos</div>
                </div>
            </div>

            <div class="resumen-card" data-filtro="sin-grupo">
  <div class="resumen-card-icon vacios">
    <span class="material-icons">person_off</span>
  </div>
  <div class="resumen-card-content">
    <div class="resumen-card-number">{{ stats.miembros_sin_grupo }}</div>
    <div class="resumen-card-label">Sin grupo ({{ stats.porc_sin_grupo }}%)</div>
  </div>
</div>

        </div>
    </div>
    
    <!-- FILTROS -->
    <div class="filtros-section">
        <div class="filtro-group">
            <label>Programa:</label>
            <select class="filtro-select" id="filtroPrograma">
                <option value="">Todos</option>
                {% for p in programas %}
                <option value="{{ p.id }}">{{ p.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filtro-group">
            <label>Sexo:</label>
            <select class="filtro-select" id="filtroSexo">
                <option value="">Todos</option>
                <option value="VARONES">Varones</option>
                <option value="HEMBRAS">Hembras</option>
                <option value="MIXTO">Mixto</option>
            </select>
        </div>
        
        <div class="filtro-group">
            <label>Estado civil:</label>
            <select class="filtro-select" id="filtroEstadoCivil">
                <option value="">Todos</option>
                <option value="TODOS">Sin filtro (Todos)</option>
                <option value="SOLTERO">Solteros</option>
                <option value="CASADO">Casados</option>
                <option value="VIUDO">Viudos</option>
                <option value="DIVORCIADO">Divorciados</option>
            </select>
        </div>
        
        <div class="filtro-group">
            <label>Estado:</label>
            <select class="filtro-select" id="filtroEstado">
                <option value="">Todos</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
        
        <div class="filtro-search">
            <span class="material-icons">search</span>
            <input type="text" id="filtroBusqueda" placeholder="Buscar grupo...">
        </div>
        
        <button type="button" class="btn-limpiar" id="btnLimpiar">
            <span class="material-icons">clear_all</span>
            Limpiar
        </button>
    </div>
    
    <!-- RESULTADOS -->
    <div class="resultados-section">
        <div class="resultados-header">
            <div class="resultados-count">
                Mostrando <strong id="countVisible">{{ grupos|length }}</strong> de <strong>{{ grupos|length }}</strong> grupos
            </div>
        </div>
        
        <div class="resultados-card">
            {% for item in grupos %}
            <div class="grupo-item" 
                 data-grupo-id="{{ item.grupo.id }}"
                 data-grupo-nombre="{{ item.grupo.nombre }}"
                 data-programa="{{ item.grupo.programa_id|default:'' }}"
                 data-sexo="{{ item.grupo.sexo_permitido }}"
                 data-estado-civil="{{ item.grupo.estado_civil_permitido }}"
                 data-estado="{% if item.grupo.activo %}activo{% else %}inactivo{% endif %}"
                 data-nombre="{{ item.grupo.nombre|lower }}"
                 data-tiene-faltantes="{% if item.total_faltan > 0 %}si{% else %}no{% endif %}"
                 data-tiene-sobrantes="{% if item.total_sobran > 0 %}si{% else %}no{% endif %}"
                 data-excedido="{% if item.excedido %}si{% else %}no{% endif %}"
                 data-sin-maestro="{% if item.sin_maestro %}si{% else %}no{% endif %}"
                 data-vacio="{% if item.total_inscritos == 0 %}si{% else %}no{% endif %}">
                
                <!-- HEADER DEL GRUPO -->
                <div class="grupo-header" onclick="toggleGrupo(this)">
                    <div class="grupo-expand-icon">
                        <span class="material-icons">chevron_right</span>
                    </div>
                    
                    <div class="grupo-info">
                        <div class="grupo-avatar">
                            <span class="material-icons">groups</span>
                        </div>
                        <div class="grupo-details">
                            <div class="grupo-nombre">{{ item.grupo.nombre }}</div>
                            <div class="grupo-meta">
                                {% if item.grupo.programa %}
                                <span class="grupo-meta-item">
                                    <span class="material-icons">menu_book</span>
                                    {{ item.grupo.programa.nombre }}
                                </span>
                                {% endif %}
                                <span class="grupo-meta-item">
                                    <span class="material-icons">{% if item.grupo.sexo_permitido == 'VARONES' %}male{% elif item.grupo.sexo_permitido == 'HEMBRAS' %}female{% else %}group{% endif %}</span>
                                    {{ item.grupo.get_sexo_permitido_display }}
                                </span>
                                {% if item.grupo.estado_civil_permitido and item.grupo.estado_civil_permitido != 'TODOS' %}
                                <span class="grupo-meta-item">
                                    <span class="material-icons">favorite</span>
                                    {{ item.grupo.get_estado_civil_permitido_display }}
                                </span>
                                {% endif %}
                                {% if item.grupo.edad_min or item.grupo.edad_max %}
                                <span class="grupo-meta-item">
                                    <span class="material-icons">cake</span>
                                    {% if item.grupo.edad_min and item.grupo.edad_max %}
                                        {{ item.grupo.edad_min }}-{{ item.grupo.edad_max }} años
                                    {% elif item.grupo.edad_min %}
                                        +{{ item.grupo.edad_min }} años
                                    {% else %}
                                        Hasta {{ item.grupo.edad_max }} años
                                    {% endif %}
                                </span>
                                {% endif %}
                                {% if item.grupo.cupo %}
                                <span class="grupo-meta-item">
                                    <span class="material-icons">reduce_capacity</span>
                                    Cupo: {{ item.grupo.cupo }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- BADGES -->
                    <div class="grupo-badges">
                        <span class="badge-stat inscritos">
                            <span class="material-icons">people</span>
                            {{ item.total_inscritos }}
                        </span>
                        
                        {% if item.total_faltan > 0 %}
                        <span class="badge-stat faltan">
                            <span class="material-icons">person_add</span>
                            +{{ item.total_faltan }}
                        </span>
                        {% endif %}
                        
                        {% if item.total_sobran > 0 %}
                        <span class="badge-stat sobran">
                            <span class="material-icons">warning</span>
                            {{ item.total_sobran }}
                        </span>
                        {% endif %}
                        
                        {% if item.excedido %}
                        <span class="badge-stat excedido">
                            <span class="material-icons">error</span>
                            Excedido
                        </span>
                        {% endif %}
                        
                        {% if item.sin_maestro %}
                        <span class="badge-stat sin-maestro">
                            <span class="material-icons">school</span>
                            Sin maestro
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- CONTENIDO EXPANDIBLE -->
                <div class="grupo-content">
                    <div class="grupo-content-tabs">
                        <button type="button" class="content-tab active" data-panel="inscritos-{{ item.grupo.id }}">
                            Inscritos <span class="count">{{ item.total_inscritos }}</span>
                        </button>
                        <button type="button" class="content-tab" data-panel="faltan-{{ item.grupo.id }}">
                            Deberían estar <span class="count">{{ item.total_faltan }}</span>
                        </button>
                        <button type="button" class="content-tab" data-panel="sobran-{{ item.grupo.id }}">
                            No cumplen <span class="count">{{ item.total_sobran }}</span>
                        </button>
                    </div>
                    
                    <!-- PANEL: INSCRITOS -->
                    <div class="content-panel active" id="inscritos-{{ item.grupo.id }}">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons">people</span>
                                Miembros inscritos actualmente
                            </div>
                            {% if item.inscritos %}
                            <button type="button" class="btn-print-list" 
                                    onclick="abrirModalImpresion('{{ item.grupo.nombre|escapejs }}', 'Miembros Inscritos', 'inscritos-{{ item.grupo.id }}')">
                                <span class="material-icons">print</span>
                                Imprimir lista
                            </button>
                            {% endif %}
                        </div>
                        <div class="miembros-list">
                            {% for m in item.inscritos %}
                            <div class="miembro-item">
                                <div class="miembro-numero">{{ forloop.counter }}</div>
                                <div class="miembro-avatar">{{ m.nombre|slice:":1"|upper }}</div>
                                <div class="miembro-info">
                                    <div class="miembro-nombre">{{ m.nombre }}</div>
                                    <div class="miembro-codigo">{{ m.codigo|default:"Sin código" }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-list">
                                <span class="material-icons">group_off</span>
                                No hay miembros inscritos
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- PANEL: FALTAN -->
                    <div class="content-panel" id="faltan-{{ item.grupo.id }}">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons">person_add</span>
                                Deberían estar según las reglas
                            </div>
                            {% if item.faltan %}
                            <button type="button" class="btn-print-list" 
                                    onclick="abrirModalImpresion('{{ item.grupo.nombre|escapejs }}', 'Miembros que Deberían Estar', 'faltan-{{ item.grupo.id }}')">
                                <span class="material-icons">print</span>
                                Imprimir lista
                            </button>
                            {% endif %}
                        </div>
                        <div class="miembros-list">
                            {% for m in item.faltan %}
                            <div class="miembro-item">
                                <div class="miembro-numero">{{ forloop.counter }}</div>
                                <div class="miembro-avatar" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8);">{{ m.nombre|slice:":1"|upper }}</div>
                                <div class="miembro-info">
                                    <div class="miembro-nombre">{{ m.nombre }}</div>
                                    <div class="miembro-codigo">{{ m.codigo|default:"Sin código" }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-list">
                                <span class="material-icons">check_circle</span>
                                Todos los elegibles ya están inscritos
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- PANEL: SOBRAN -->
                    <div class="content-panel" id="sobran-{{ item.grupo.id }}">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons">warning</span>
                                No cumplen las reglas del grupo
                            </div>
                            {% if item.sobran %}
                            <button type="button" class="btn-print-list" 
                                    onclick="abrirModalImpresion('{{ item.grupo.nombre|escapejs }}', 'Miembros que No Cumplen Reglas', 'sobran-{{ item.grupo.id }}')">
                                <span class="material-icons">print</span>
                                Imprimir lista
                            </button>
                            {% endif %}
                        </div>
                        <div class="miembros-list">
                            {% for m in item.sobran %}
                            <div class="miembro-item">
                                <div class="miembro-numero">{{ forloop.counter }}</div>
                                <div class="miembro-avatar" style="background: linear-gradient(135deg, #f97316, #fb923c);">{{ m.nombre|slice:":1"|upper }}</div>
                                <div class="miembro-info">
                                    <div class="miembro-nombre">{{ m.nombre }}</div>
                                    <div class="miembro-codigo">{{ m.codigo|default:"Sin código" }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-list">
                                <span class="material-icons">verified</span>
                                Todos los inscritos cumplen las reglas
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-list" style="padding: 60px;">
                <span class="material-icons" style="font-size: 48px;">folder_off</span>
                <p style="margin-top: 16px;">No hay grupos para mostrar</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- MODAL DE IMPRESIÓN -->
<div class="print-modal-overlay" id="printModal">
    <div class="print-modal">
        <div class="print-modal-header">
            <h2>
                <span class="material-icons">print</span>
                <span id="printModalTitle">Vista previa de impresión</span>
            </h2>
            <button type="button" class="print-modal-close" onclick="cerrarModalImpresion()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="print-modal-body">
            <div class="print-content" id="printContent">
                <!-- Contenido dinámico -->
            </div>
        </div>
        <div class="print-modal-footer">
            <button type="button" class="btn-reporte" onclick="cerrarModalImpresion()">
                Cancelar
            </button>
            <button type="button" class="btn-reporte primary" onclick="imprimirContenido()">
                <span class="material-icons">print</span>
                Imprimir
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle grupo expandible
    window.toggleGrupo = function(header) {
        const item = header.closest('.grupo-item');
        item.classList.toggle('expanded');
    };
    
    // Tabs dentro de cada grupo
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.stopPropagation();
            const container = this.closest('.grupo-content');
            const panelId = this.dataset.panel;
            
            container.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            container.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
        });
    });
    
    // Filtros
    let filtroActivo = 'todos';
    
    document.querySelectorAll('.resumen-card').forEach(card => {
        card.addEventListener('click', function() {
            const filtro = this.dataset.filtro;
            
            document.querySelectorAll('.resumen-card').forEach(c => c.classList.remove('active'));
            
            if (filtroActivo === filtro) {
                filtroActivo = 'todos';
            } else {
                filtroActivo = filtro;
                this.classList.add('active');
            }
            
            aplicarFiltros();
        });
    });
    
    const filtroPrograma = document.getElementById('filtroPrograma');
    const filtroSexo = document.getElementById('filtroSexo');
    const filtroEstadoCivil = document.getElementById('filtroEstadoCivil');
    const filtroEstado = document.getElementById('filtroEstado');
    const filtroBusqueda = document.getElementById('filtroBusqueda');
    
    [filtroPrograma, filtroSexo, filtroEstadoCivil, filtroEstado].forEach(el => {
        el.addEventListener('change', aplicarFiltros);
    });
    
    filtroBusqueda.addEventListener('input', aplicarFiltros);
    
    document.getElementById('btnLimpiar').addEventListener('click', function() {
        filtroPrograma.value = '';
        filtroSexo.value = '';
        filtroEstadoCivil.value = '';
        filtroEstado.value = '';
        filtroBusqueda.value = '';
        filtroActivo = 'todos';
        document.querySelectorAll('.resumen-card').forEach(c => c.classList.remove('active'));
        aplicarFiltros();
    });
    
    function aplicarFiltros() {
        const programa = filtroPrograma.value;
        const sexo = filtroSexo.value;
        const estadoCivil = filtroEstadoCivil.value;
        const estado = filtroEstado.value;
        const busqueda = filtroBusqueda.value.toLowerCase().trim();
        
        let visibles = 0;
        
        document.querySelectorAll('.grupo-item').forEach(item => {
            let mostrar = true;
            
            // Filtro por card
            if (filtroActivo === 'con-faltantes' && item.dataset.tieneFaltantes !== 'si') mostrar = false;
            if (filtroActivo === 'con-sobrantes' && item.dataset.tieneSobrantes !== 'si') mostrar = false;
            if (filtroActivo === 'excedidos' && item.dataset.excedido !== 'si') mostrar = false;
            if (filtroActivo === 'sin-maestro' && item.dataset.sinMaestro !== 'si') mostrar = false;
            if (filtroActivo === 'vacios' && item.dataset.vacio !== 'si') mostrar = false;
            
            // Filtros de selects
            if (programa && item.dataset.programa !== programa) mostrar = false;
            if (sexo && item.dataset.sexo !== sexo) mostrar = false;
            if (estadoCivil && item.dataset.estadoCivil !== estadoCivil) mostrar = false;
            if (estado && item.dataset.estado !== estado) mostrar = false;
            
            // Búsqueda
            if (busqueda && !item.dataset.nombre.includes(busqueda)) mostrar = false;
            
            item.style.display = mostrar ? '' : 'none';
            if (mostrar) visibles++;
        });
        
        document.getElementById('countVisible').textContent = visibles;
    }
});

// =========================================================================
// FUNCIONES DE IMPRESIÓN
// =========================================================================

function abrirModalImpresion(grupoNombre, tipoLista, panelId) {
    const panel = document.getElementById(panelId);
    const miembros = panel.querySelectorAll('.miembro-item');
    
    if (miembros.length === 0) return;
    
    // Generar tabla
    let tableRows = '';
    miembros.forEach((m, index) => {
        const nombre = m.querySelector('.miembro-nombre').textContent;
        const codigo = m.querySelector('.miembro-codigo').textContent;
        tableRows += `
            <tr>
                <td>${index + 1}</td>
                <td>${nombre}</td>
                <td>${codigo}</td>
            </tr>
        `;
    });
    
    const fecha = new Date().toLocaleDateString('es-DO', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    const html = `
        <div class="print-header">
            <h1>${grupoNombre}</h1>
            <div class="print-subtitle">${tipoLista}</div>
            <div class="print-date">${fecha}</div>
        </div>
        
        <table class="print-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Código</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        
        <div class="print-total">
            Total: <strong>${miembros.length}</strong> miembros
        </div>
    `;
    
    document.getElementById('printModalTitle').textContent = `${tipoLista} - ${grupoNombre}`;
    document.getElementById('printContent').innerHTML = html;
    document.getElementById('printModal').classList.add('active');
}

function cerrarModalImpresion() {
    document.getElementById('printModal').classList.remove('active');
}

function imprimirContenido() {
    window.print();
}

// Cerrar modal con Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarModalImpresion();
    }
});

// Cerrar modal al hacer clic fuera
document.getElementById('printModal').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalImpresion();
    }
});
</script>

{% endblock %}