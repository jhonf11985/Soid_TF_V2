{% extends "formacion_app/base_formacion.html" %}

{% block title %}Añadir rol · Formación{% endblock %}

{% block formacion_content %}

<style>
  .card { background:#fff; border:1px solid #e9ecef; border-radius:10px; overflow:hidden; }
  .top { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; background:#f8f9fa; border-bottom:1px solid #dee2e6; flex-wrap:wrap; }
  .title { display:flex; gap:8px; align-items:center; font-weight:800; color:#212529; }
  .title .material-icons { color:#714B67; }
  .body { padding:16px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .field label { font-size:12px; font-weight:700; color:#6c757d; display:block; margin-bottom:6px; }
  .input, .select { width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:8px; font-size:14px; outline:none; }
  .input:focus, .select:focus { border-color:#714B67; box-shadow: 0 0 0 3px rgba(113,75,103,.12); }
  .actions { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
  .btn { display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .btn-primary { background:#714B67; color:#fff; }
  .btn-secondary { background:#e9ecef; color:#495057; text-decoration:none; }
  .alert { background:#fef2f2; border:1px solid #fecaca; color:#b91c1c; padding:10px 12px; border-radius:8px; margin-bottom:12px; font-size:13px; white-space:pre-wrap; }
  .help { font-size:12px; color:#6c757d; margin-top:8px; }
  @media (max-width: 860px) { .row { grid-template-columns: 1fr; } }
</style>

<div class="card">
  <div class="top">
    <div class="title">
      <span class="material-icons">person_add</span>
      Añadir Maestro / Ayudante
    </div>
    <a class="btn btn-secondary" href="{% url 'formacion:roles_formativos' %}">
      <span class="material-icons">arrow_back</span> Volver
    </a>
  </div>

  <div class="body">
    {% if errores %}
      <div class="alert">{{ errores }}</div>
    {% endif %}

    <form method="post">
      {% csrf_token %}

      <div class="row">
        <div class="field">
          <label>Buscar miembro</label>
          <input class="input" type="text" id="miembro_buscar" placeholder="Escribe nombre o código..." autocomplete="off">
          <input type="hidden" name="miembro_id" id="miembro_id">
          <div class="help">Selecciona un miembro de la lista sugerida.</div>
          <div id="miembro_sugerencias" class="help"></div>
        </div>

        <div class="field">
          <label>Tipo de rol</label>
          <select class="select" name="tipo" required>
            <option value="">Seleccione...</option>
            <option value="MAESTRO">Maestro</option>
            <option value="AYUDANTE">Ayudante</option>
          </select>
          <div class="help">Esto define quién sale en el listado de Maestros/Ayudantes y luego se carga en grupos.</div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">save</span> Guardar
        </button>
        <a class="btn btn-secondary" href="{% url 'formacion:roles_formativos' %}">
          Cancelar
        </a>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_URL = "/api/buscar-miembros/?filtro=activos&limit=10&q=";
  const input = document.getElementById("miembro_buscar");
  const hidden = document.getElementById("miembro_id");
  const sugerencias = document.getElementById("miembro_sugerencias");

  let t = null;

  function render(items){
    if (!items || items.length === 0) {
      sugerencias.innerHTML = "<div class='help'>No se encontraron resultados.</div>";
      return;
    }

    sugerencias.innerHTML = items.map(i => {
      const codigo = i.codigo || "Sin código";
      return `
        <div style="padding:8px 10px;border:1px solid #eee;border-radius:8px;margin-top:6px;cursor:pointer;"
             data-id="${i.id}" data-text="${i.nombre} (${codigo})">
          <strong>${i.nombre}</strong><br><small>${codigo}</small>
        </div>
      `;
    }).join("");

    sugerencias.querySelectorAll("div[data-id]").forEach(div => {
      div.addEventListener("click", () => {
        hidden.value = div.dataset.id;
        input.value = div.dataset.text;
        sugerencias.innerHTML = "<div class='help'>Seleccionado ✅</div>";
      });
    });
  }

  async function search(q){
    try {
      const res = await fetch(API_URL + encodeURIComponent(q), {
        credentials: "same-origin",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await res.json();
      if (data.success) render(data.resultados || []);
      else render([]);
    } catch(e){
      render([]);
    }
  }

  input.addEventListener("input", () => {
    hidden.value = "";
    const q = input.value.trim();
    clearTimeout(t);
    if (q.length < 2) { sugerencias.innerHTML = ""; return; }
    t = setTimeout(() => search(q), 250);
  });
});
</script>

{% endblock %}
