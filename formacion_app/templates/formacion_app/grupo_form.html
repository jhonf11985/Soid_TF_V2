{% extends "formacion_app/base_formacion.html" %}
{% load static %}

{% block title %}
    {% if grupo %}
        {{ grupo.nombre }} 路 Formaci贸n
    {% else %}
        Nuevo grupo 路 Formaci贸n
    {% endif %}
{% endblock %}

{% block formacion_content %}

<style>
/* ALERTS */
.odoo-alert { padding: 12px 16px; border-radius: 4px; font-size: 13px; }
.odoo-alert-danger { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }

/* CONTROL BAR */
.odoo-control-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-wrap: wrap; gap: 8px; }
.odoo-control-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.odoo-control-right { display: flex; align-items: center; gap: 12px; }
.odoo-breadcrumb-link { display: flex; align-items: center; gap: 4px; color: #495057; text-decoration: none; font-size: 14px; font-weight: 500; }
.odoo-breadcrumb-link:hover { color: #714B67; }
.odoo-breadcrumb-link .material-icons { font-size: 18px; }
.odoo-breadcrumb-sep { color: #adb5bd; font-size: 14px; }
.odoo-breadcrumb-current { color: #212529; font-size: 14px; font-weight: 600; }
.odoo-new-badge { background: #714B67; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
.odoo-member-code { display: flex; align-items: center; gap: 4px; font-size: 13px; color: #6c757d; background: #e9ecef; padding: 4px 10px; border-radius: 4px; }
.odoo-member-code .material-icons { font-size: 16px; }

/* FORM CONTAINER */
.odoo-form-container { display: flex; gap: 0; background: #fff; min-height: calc(100vh - 180px); }
.odoo-form-main { flex: 1; padding: 20px 24px; overflow-y: auto; }
.odoo-form-aside { width: 280px; background: #f8f9fa; border-left: 1px solid #dee2e6; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

/* FORM HEADER */
.odoo-form-header { display: flex; gap: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef; margin-bottom: 20px; }
.odoo-avatar-section { flex-shrink: 0; }
.odoo-avatar { width: 110px; height: 110px; border-radius: 8px; background: linear-gradient(135deg, #714B67 0%, #8e6384 100%); display: flex; align-items: center; justify-content: center; color: white; }
.odoo-avatar .material-icons { font-size: 48px; }
.odoo-header-info { flex: 1; display: flex; flex-direction: column; gap: 12px; }

/* NAME FIELD */
.odoo-name-field { margin-top: 4px; }
.odoo-name-input { width: 100%; border: none; border-bottom: 2px solid transparent; font-size: 28px; font-weight: 600; color: #212529; padding: 4px 0; background: transparent; transition: border-color 0.2s; }
.odoo-name-input:focus { outline: none; border-bottom-color: #714B67; }
.odoo-name-input::placeholder { color: #adb5bd; font-weight: 400; }

/* QUICK FIELDS */
.odoo-quick-fields { display: flex; gap: 20px; flex-wrap: wrap; }
.odoo-quick-field { display: flex; align-items: center; gap: 8px; color: #6c757d; }
.odoo-quick-field .material-icons { font-size: 18px; color: #714B67; }
.odoo-quick-field input, .odoo-quick-field select { border: none; border-bottom: 1px solid #dee2e6; padding: 4px 0; font-size: 14px; color: #495057; background: transparent; min-width: 180px; }
.odoo-quick-field input:focus, .odoo-quick-field select:focus { outline: none; border-bottom-color: #714B67; }
.odoo-quick-select { cursor: pointer; }

/* CAMPOS EN LNEA */
.odoo-form-body { display: grid; grid-template-columns: 1fr 1fr; gap: 0 40px; margin-bottom: 24px; }
.odoo-form-column { display: flex; flex-direction: column; gap: 0; }
.odoo-field-line { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4; }
.odoo-field-line:last-child { border-bottom: none; }
.odoo-field-line .odoo-label { flex: 0 0 140px; font-size: 13px; font-weight: 500; color: #495057; }
.odoo-field-line .odoo-field-value { flex: 1; }
.odoo-input-line, .odoo-select-line { width: 100%; padding: 6px 0; border: none; border-bottom: 1px solid #dee2e6; font-size: 14px; color: #212529; background: transparent; transition: border-color 0.2s; }
.odoo-input-line:focus, .odoo-select-line:focus { outline: none; border-bottom-color: #714B67; border-bottom-width: 2px; }
.odoo-input-line::placeholder { color: #adb5bd; }
.odoo-select-line { cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0 center; padding-right: 20px; }
.odoo-checkbox-line { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #495057; }
.odoo-checkbox-line input[type="checkbox"] { width: 18px; height: 18px; accent-color: #714B67; cursor: pointer; }

/* =========================================================================
   TABS MEJORADOS
   ========================================================================= */
.odoo-tabs-section { border-top: 1px solid #e9ecef; padding-top: 0; margin-top: 10px; }
.odoo-tabs-bar { display: flex; gap: 0; border-bottom: 2px solid #dee2e6; background: #f8f9fa; margin: 0 -24px; padding: 0 24px; }
.odoo-tab { 
    display: flex; 
    align-items: center; 
    gap: 8px;
    padding: 14px 20px; 
    border: none; 
    background: transparent; 
    font-size: 14px; 
    font-weight: 500; 
    color: #6c757d; 
    cursor: pointer; 
    border-bottom: 3px solid transparent; 
    margin-bottom: -2px; 
    transition: all 0.2s; 
}
.odoo-tab:hover { color: #495057; background: rgba(113, 75, 103, 0.05); }
.odoo-tab.active { color: #714B67; border-bottom-color: #714B67; background: #fff; }
.odoo-tab .material-icons { font-size: 20px; }

/* BADGE EN PESTAAS */
.odoo-tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 22px;
    padding: 0 6px;
    border-radius: 11px;
    font-size: 12px;
    font-weight: 600;
    background: #e9ecef;
    color: #495057;
}
.odoo-tab.active .odoo-tab-badge {
    background: #714B67;
    color: white;
}

/* Badge con alerta (para sugerencias) */
.odoo-tab-badge.has-alert {
    background: #fef3c7;
    color: #92400e;
}
.odoo-tab.active .odoo-tab-badge.has-alert {
    background: #f59e0b;
    color: white;
}

.odoo-tabs-content { padding: 20px 0; }
.odoo-tab-panel { display: none; }
.odoo-tab-panel.active { display: block; }

/* EMPTY STATE */
.odoo-empty-state { display: flex; align-items: center; gap: 8px; padding: 20px; background: #f8f9fa; border-radius: 4px; color: #6c757d; font-size: 14px; }
.odoo-empty-state .material-icons { font-size: 20px; color: #714B67; }

/* ASIDE */
.odoo-aside-actions { display: flex; flex-direction: column; gap: 8px; }
.odoo-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border-radius: 4px; font-size: 14px; font-weight: 500; text-decoration: none; cursor: pointer; border: none; transition: background 0.2s, transform 0.1s; }
.odoo-btn:active { transform: scale(0.98); }
.odoo-btn .material-icons { font-size: 18px; }
.odoo-btn-primary { background: #714B67; color: white; }
.odoo-btn-primary:hover { background: #5a3d53; }
.odoo-btn-secondary { background: #e9ecef; color: #495057; }
.odoo-btn-secondary:hover { background: #dee2e6; }
.odoo-btn-sm { padding: 6px 12px; font-size: 13px; }
.odoo-btn-success { background: #10b981; color: white; }
.odoo-btn-success:hover { background: #059669; }
.odoo-btn-success.added { background: #d1fae5; color: #065f46; pointer-events: none; }

.odoo-aside-info { background: #fff; border-radius: 6px; padding: 12px; border: 1px solid #e9ecef; }
.odoo-info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4; }
.odoo-info-item:last-child { border-bottom: none; }
.odoo-info-label { font-size: 12px; color: #6c757d; font-weight: 500; }
.odoo-info-value { font-size: 13px; color: #212529; }
.odoo-info-badge { background: #d1fae5; color: #065f46; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
.odoo-badge-inactive { background: #fee2e2; color: #991b1b; }
.odoo-badge-warning { background: #fef3c7; color: #92400e; }
.odoo-aside-tips { background: #fff; border-radius: 6px; padding: 12px; border: 1px solid #e9ecef; }
.odoo-aside-title { font-size: 13px; font-weight: 600; color: #495057; margin: 0 0 10px 0; }
.odoo-tips-list { margin: 0; padding: 0 0 0 18px; font-size: 12px; color: #6c757d; line-height: 1.6; }
.odoo-tips-list li { margin-bottom: 6px; }

/* AUTOCOMPLETE */
.autocomplete-section { margin-bottom: 24px; }
.autocomplete-section-title { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef; }
.autocomplete-section-title .material-icons { font-size: 20px; color: #714B67; }
.autocomplete-wrapper { position: relative; margin-bottom: 12px; }
.autocomplete-input-container { position: relative; }
.autocomplete-search { width: 100%; padding: 10px 12px 10px 40px; border: none; border-bottom: 1px solid #dee2e6; font-size: 14px; color: #212529; background: transparent; transition: border-color 0.2s; }
.autocomplete-search:focus { outline: none; border-bottom-color: #714B67; border-bottom-width: 2px; }
.autocomplete-search::placeholder { color: #adb5bd; }
.autocomplete-search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #adb5bd; font-size: 20px; pointer-events: none; }
.autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #dee2e6; border-radius: 0 0 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 280px; overflow-y: auto; display: none; }
.autocomplete-dropdown.open { display: block; }
.autocomplete-list { list-style: none; margin: 0; padding: 4px 0; }
.autocomplete-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; cursor: pointer; transition: background 0.15s; }
.autocomplete-item:hover { background: #f8f9fa; }
.autocomplete-item-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #714B67, #8e6384); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; }
.autocomplete-item-info { flex: 1; min-width: 0; }
.autocomplete-item-name { font-size: 14px; font-weight: 500; color: #212529; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.autocomplete-item-code { font-size: 12px; color: #6c757d; }
.autocomplete-empty, .autocomplete-loading { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 24px; color: #6c757d; font-size: 13px; gap: 8px; }
.autocomplete-empty .material-icons, .autocomplete-loading .material-icons { font-size: 32px; color: #adb5bd; }
.autocomplete-loading .spinner { animation: spin 1s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* LISTA DE SELECCIONADOS */
.selected-list { display: flex; flex-direction: column; gap: 0; }
.selected-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: #fff; border-bottom: 1px solid #f1f3f4; transition: background 0.15s; }
.selected-item:hover { background: #f8f9fa; }
.selected-item:last-child { border-bottom: none; }
.selected-item-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #714B67, #8e6384); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
.selected-item-info { flex: 1; min-width: 0; }
.selected-item-name { font-size: 14px; font-weight: 500; color: #212529; }
.selected-item-code { font-size: 12px; color: #6c757d; }
.selected-item-remove { width: 28px; height: 28px; border: none; background: transparent; color: #6c757d; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; }
.selected-item-remove:hover { background: #fee2e2; color: #dc2626; }
.selected-item-remove .material-icons { font-size: 18px; }
.selected-empty { display: flex; align-items: center; gap: 8px; padding: 16px; background: #f8f9fa; color: #6c757d; font-size: 13px; border-radius: 4px; }
.selected-empty .material-icons { font-size: 20px; color: #adb5bd; }
.selected-count { font-size: 12px; color: #6c757d; margin-bottom: 8px; }
.selected-count strong { color: #714B67; }

/* =========================================================================
   PANEL DE SUGERENCIAS MEJORADO
   ========================================================================= */
.sugerencias-summary {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 20px;
}
.sugerencias-stat {
    flex: 1;
    text-align: center;
    padding: 8px;
}
.sugerencias-stat-number {
    font-size: 24px;
    font-weight: 700;
    color: #714B67;
}
.sugerencias-stat-label {
    font-size: 11px;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.sugerencias-stat.warning .sugerencias-stat-number { color: #f59e0b; }
.sugerencias-stat.success .sugerencias-stat-number { color: #10b981; }

.sugerencia-section {
    margin-bottom: 24px;
}
.sugerencia-section-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 6px 6px 0 0;
    border: 1px solid #e9ecef;
    border-bottom: none;
}
.sugerencia-section-header .material-icons {
    font-size: 20px;
}
.sugerencia-section-header.faltan { color: #0369a1; }
.sugerencia-section-header.faltan .material-icons { color: #0ea5e9; }
.sugerencia-section-header.sobran { color: #c2410c; }
.sugerencia-section-header.sobran .material-icons { color: #f97316; }

.sugerencia-section-title {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
}
.sugerencia-section-count {
    font-size: 12px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 10px;
    background: rgba(0,0,0,0.1);
}

.sugerencia-list {
    border: 1px solid #e9ecef;
    border-radius: 0 0 6px 6px;
    max-height: 300px;
    overflow-y: auto;
}
.sugerencia-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.15s;
}
.sugerencia-item:last-child { border-bottom: none; }
.sugerencia-item:hover { background: #f8f9fa; }

/* RESPONSIVE */
@media (max-width: 992px) { .odoo-form-container { flex-direction: column; } .odoo-form-aside { width: 100%; border-left: none; border-top: 1px solid #dee2e6; } .odoo-aside-actions { flex-direction: row; flex-wrap: wrap; } .odoo-btn { flex: 1; min-width: 120px; } }
@media (max-width: 768px) { .odoo-form-header { flex-direction: column; align-items: center; text-align: center; } .odoo-header-info { align-items: center; } .odoo-quick-fields { justify-content: center; } .odoo-form-body { grid-template-columns: 1fr; } .odoo-name-input { font-size: 22px; text-align: center; } .odoo-control-bar { padding: 8px 12px; } .odoo-form-main { padding: 16px; } .odoo-tabs-bar { margin: 0 -16px; padding: 0 16px; overflow-x: auto; } .odoo-tab { padding: 10px 14px; font-size: 13px; white-space: nowrap; } .odoo-field-line { flex-direction: column; align-items: flex-start; gap: 4px; } .odoo-field-line .odoo-label { flex: none; } .sugerencias-summary { flex-wrap: wrap; } .sugerencias-stat { min-width: 45%; } }
@media (max-width: 480px) { .odoo-avatar { width: 80px; height: 80px; } .odoo-avatar .material-icons { font-size: 36px; } .odoo-name-input { font-size: 18px; } .odoo-aside-actions { flex-direction: column; } .odoo-btn { width: 100%; } .odoo-tab-badge { display: none; } }
</style>

<form method="post" class="odoo-form">
    {% csrf_token %}

    {% if errors %}
    <div class="odoo-alert odoo-alert-danger" style="margin:12px 0;">
        <strong>No se pudo guardar.</strong>
        <div style="margin-top:6px;"><pre style="white-space:pre-wrap; margin:0;">{{ errors }}</pre></div>
    </div>
    {% endif %}

    <!-- BARRA SUPERIOR -->
    <div class="odoo-control-bar">
        <div class="odoo-control-left">
            <a href="{% url 'formacion:grupos' %}" class="odoo-breadcrumb-link">
                <span class="material-icons">arrow_back</span> Grupos
            </a>
            <span class="odoo-breadcrumb-sep">/</span>
            <span class="odoo-breadcrumb-current">{% if grupo %}Editar{% else %}Nuevo{% endif %}</span>
            {% if not grupo %}<span class="odoo-new-badge">Nuevo</span>{% endif %}
        </div>
        <div class="odoo-control-right">
            <div class="odoo-member-code">
                <span class="material-icons">groups</span>
                {% if grupo %}ID {{ grupo.id }}{% else %}Nuevo{% endif %}
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="odoo-form-container">
        <div class="odoo-form-main">

            <!-- HEADER -->
            <div class="odoo-form-header">
                <div class="odoo-avatar-section">
                    <div class="odoo-avatar"><span class="material-icons">groups</span></div>
                </div>
                <div class="odoo-header-info">
                    <div class="odoo-quick-fields">
                        <div class="odoo-quick-field">
                            <span class="material-icons">menu_book</span>
                            <select name="programa" id="id_programa" class="odoo-quick-select">
                                <option value="">Sin programa</option>
                                {% for p in programas %}
                                <option value="{{ p.id }}" {% if grupo and grupo.programa_id == p.id %}selected{% endif %}>{{ p.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="odoo-name-field">
                        <input type="text" name="nombre" value="{% if grupo %}{{ grupo.nombre }}{% endif %}" placeholder="Nombre del grupo" class="odoo-name-input" required>
                    </div>
                    <div class="odoo-quick-fields">
                        <div class="odoo-quick-field">
                            <span class="material-icons">schedule</span>
                            <input type="text" name="horario" value="{% if grupo %}{{ grupo.horario }}{% endif %}" placeholder="Horario (ej. Martes 7:00 PM)">
                        </div>
                        <div class="odoo-quick-field">
                            <span class="material-icons">place</span>
                            <input type="text" name="lugar" value="{% if grupo %}{{ grupo.lugar }}{% endif %}" placeholder="Lugar (opcional)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- BODY - CAMPOS EN LNEA (REGLAS DE FILTRADO) -->
            <div class="odoo-form-body">
                <div class="odoo-form-column">
                    <div class="odoo-field-line">
                        <label class="odoo-label">Sexo permitido</label>
                        <div class="odoo-field-value">
                            <select name="sexo_permitido" class="odoo-select-line">
                                <option value="MIXTO" {% if grupo and grupo.sexo_permitido == "MIXTO" %}selected{% endif %}>Mixto</option>
                                <option value="VARONES" {% if grupo and grupo.sexo_permitido == "VARONES" %}selected{% endif %}>Varones</option>
                                <option value="HEMBRAS" {% if grupo and grupo.sexo_permitido == "HEMBRAS" %}selected{% endif %}>Hembras</option>
                            </select>
                        </div>
                    </div>
                    <div class="odoo-field-line">
                        <label class="odoo-label">Estado civil</label>
                        <div class="odoo-field-value">
                            <select name="estado_civil_permitido" class="odoo-select-line">
                                <option value="TODOS" {% if grupo and grupo.estado_civil_permitido == "TODOS" %}selected{% endif %}>Todos</option>
                                <option value="SOLTERO" {% if grupo and grupo.estado_civil_permitido == "SOLTERO" %}selected{% endif %}>Solteros</option>
                                <option value="CASADO" {% if grupo and grupo.estado_civil_permitido == "CASADO" %}selected{% endif %}>Casados</option>
                                <option value="VIUDO" {% if grupo and grupo.estado_civil_permitido == "VIUDO" %}selected{% endif %}>Viudos</option>
                                <option value="DIVORCIADO" {% if grupo and grupo.estado_civil_permitido == "DIVORCIADO" %}selected{% endif %}>Divorciados</option>
                            </select>
                        </div>
                    </div>
                    <div class="odoo-field-line">
                        <label class="odoo-label">Edad m铆nima</label>
                        <div class="odoo-field-value">
                            <input type="number" name="edad_min" class="odoo-input-line" min="0" value="{% if grupo and grupo.edad_min != None %}{{ grupo.edad_min }}{% endif %}" placeholder="Opcional">
                        </div>
                    </div>
                </div>
                <div class="odoo-form-column">
                    <div class="odoo-field-line">
                        <label class="odoo-label">Edad m谩xima</label>
                        <div class="odoo-field-value">
                            <input type="number" name="edad_max" class="odoo-input-line" min="0" value="{% if grupo and grupo.edad_max != None %}{{ grupo.edad_max }}{% endif %}" placeholder="Opcional">
                        </div>
                    </div>
                    <div class="odoo-field-line">
                        <label class="odoo-label">Cupo m谩ximo</label>
                        <div class="odoo-field-value">
                            <input type="number" name="cupo" class="odoo-input-line" min="0" value="{% if grupo and grupo.cupo != None %}{{ grupo.cupo }}{% endif %}" placeholder="Sin l铆mite">
                        </div>
                    </div>
                    <div class="odoo-field-line">
                        <label class="odoo-label">Estado</label>
                        <div class="odoo-field-value">
                            <label class="odoo-checkbox-line">
                                <input type="checkbox" name="activo" {% if not grupo or grupo.activo %}checked{% endif %}>
                                <span>Grupo activo</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =========================================================================
                 PESTAAS MEJORADAS
                 ========================================================================= -->
            <div class="odoo-tabs-section">
                <div class="odoo-tabs-bar">
                    <button type="button" class="odoo-tab active" data-tab="equipo">
                        <span class="material-icons">school</span>
                        <span>Equipo</span>
                        <span class="odoo-tab-badge" id="badge-equipo">{{ total_equipo|default:0 }}</span>
                    </button>
                    <button type="button" class="odoo-tab" data-tab="alumnos">
                        <span class="material-icons">people</span>
                        <span>Alumnos</span>
                        <span class="odoo-tab-badge" id="badge-alumnos">{{ total_alumnos|default:0 }}</span>
                    </button>
                    <button type="button" class="odoo-tab" data-tab="sugerencias">
                        <span class="material-icons">lightbulb</span>
                        <span>Sugerencias</span>
                        {% if sugeridos_stats.total_faltan > 0 %}
                        <span class="odoo-tab-badge has-alert">{{ sugeridos_stats.total_faltan }}</span>
                        {% endif %}
                    </button>
                </div>
                <div class="odoo-tabs-content">

                    <!-- =========================================================
                         TAB 1: EQUIPO (Maestros + Ayudantes)
                         ========================================================= -->
                    <div class="odoo-tab-panel active" id="tab-equipo">
                        <input type="hidden" name="maestros_ids" id="maestros_ids" value="">
                        <input type="hidden" name="ayudantes_ids" id="ayudantes_ids" value="">

                        <!-- MAESTROS -->
                        <div class="autocomplete-section">
                            <div class="autocomplete-section-title"><span class="material-icons">school</span> Maestros</div>
                            <div class="autocomplete-wrapper" id="autocomplete-maestros">
                                <div class="autocomplete-input-container">
                                    <span class="material-icons autocomplete-search-icon">search</span>
                                    <input type="text" class="autocomplete-search" id="search-maestros" placeholder="Buscar miembro para asignar como maestro..." autocomplete="off">
                                </div>
                                <div class="autocomplete-dropdown" id="dropdown-maestros">
                                    <ul class="autocomplete-list" id="list-maestros"></ul>
                                    <div class="autocomplete-empty" id="empty-maestros"><span class="material-icons">person_search</span><p>No se encontraron miembros</p></div>
                                    <div class="autocomplete-loading" id="loading-maestros"><span class="material-icons spinner">sync</span><p>Buscando...</p></div>
                                </div>
                            </div>
                            <div class="selected-count" id="count-maestros"><strong>0</strong> maestros asignados</div>
                            <div class="selected-list" id="selected-maestros">
                                <div class="selected-empty" id="empty-selected-maestros"><span class="material-icons">school</span><span>No hay maestros asignados.</span></div>
                            </div>
                        </div>

                        <!-- AYUDANTES -->
                        <div class="autocomplete-section">
                            <div class="autocomplete-section-title"><span class="material-icons">support_agent</span> Ayudantes</div>
                            <div class="autocomplete-wrapper" id="autocomplete-ayudantes">
                                <div class="autocomplete-input-container">
                                    <span class="material-icons autocomplete-search-icon">search</span>
                                    <input type="text" class="autocomplete-search" id="search-ayudantes" placeholder="Buscar miembro para asignar como ayudante..." autocomplete="off">
                                </div>
                                <div class="autocomplete-dropdown" id="dropdown-ayudantes">
                                    <ul class="autocomplete-list" id="list-ayudantes"></ul>
                                    <div class="autocomplete-empty" id="empty-ayudantes"><span class="material-icons">person_search</span><p>No se encontraron miembros</p></div>
                                    <div class="autocomplete-loading" id="loading-ayudantes"><span class="material-icons spinner">sync</span><p>Buscando...</p></div>
                                </div>
                            </div>
                            <div class="selected-count" id="count-ayudantes"><strong>0</strong> ayudantes asignados</div>
                            <div class="selected-list" id="selected-ayudantes">
                                <div class="selected-empty" id="empty-selected-ayudantes"><span class="material-icons">support_agent</span><span>No hay ayudantes asignados.</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- =========================================================
                         TAB 2: ALUMNOS
                         ========================================================= -->
                    <div class="odoo-tab-panel" id="tab-alumnos">
                        <input type="hidden" name="estudiantes_ids" id="estudiantes_ids" value="">
                        <div class="autocomplete-section">
                            <div class="autocomplete-section-title">
                                <span class="material-icons">person_add</span> Inscribir alumnos
                            </div>
                            <div class="autocomplete-wrapper" id="autocomplete-estudiantes">
                                <div class="autocomplete-input-container">
                                    <span class="material-icons autocomplete-search-icon">search</span>
                                    <input type="text" class="autocomplete-search" id="search-estudiantes" placeholder="Buscar miembro por nombre o c贸digo..." autocomplete="off">
                                </div>
                                <div class="autocomplete-dropdown" id="dropdown-estudiantes">
                                    <ul class="autocomplete-list" id="list-estudiantes"></ul>
                                    <div class="autocomplete-empty" id="empty-estudiantes"><span class="material-icons">person_search</span><p>No se encontraron miembros</p></div>
                                    <div class="autocomplete-loading" id="loading-estudiantes"><span class="material-icons spinner">sync</span><p>Buscando...</p></div>
                                </div>
                            </div>
                            <div class="selected-count" id="count-estudiantes"><strong>0</strong> alumnos inscritos</div>
                            <div class="selected-list" id="selected-estudiantes">
                                <div class="selected-empty" id="empty-selected-estudiantes"><span class="material-icons">groups</span><span>No hay alumnos inscritos.</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- =========================================================
                         TAB 3: SUGERENCIAS (por reglas)
                         ========================================================= -->
                    <div class="odoo-tab-panel" id="tab-sugerencias">
                        
                        {% if grupo %}
                        <!-- RESUMEN ESTADSTICO -->
                        <div class="sugerencias-summary">
                            <div class="sugerencias-stat">
                                <div class="sugerencias-stat-number">{{ sugeridos_stats.total_elegibles }}</div>
                                <div class="sugerencias-stat-label">Elegibles</div>
                            </div>
                            <div class="sugerencias-stat success">
                                <div class="sugerencias-stat-number">{{ sugeridos_stats.total_inscritos }}</div>
                                <div class="sugerencias-stat-label">Inscritos</div>
                            </div>
                            <div class="sugerencias-stat {% if sugeridos_stats.total_faltan > 0 %}warning{% endif %}">
                                <div class="sugerencias-stat-number">{{ sugeridos_stats.total_faltan }}</div>
                                <div class="sugerencias-stat-label">Faltan</div>
                            </div>
                            <div class="sugerencias-stat {% if sugeridos_stats.total_sobran > 0 %}warning{% endif %}">
                                <div class="sugerencias-stat-number">{{ sugeridos_stats.total_sobran }}</div>
                                <div class="sugerencias-stat-label">No cumplen</div>
                            </div>
                        </div>

                        <!-- FALTAN: Deber铆an estar -->
                        <div class="sugerencia-section">
                            <div class="sugerencia-section-header faltan">
                                <span class="material-icons">person_add_alt</span>
                                <span class="sugerencia-section-title">Deber铆an estar en este grupo</span>
                                <span class="sugerencia-section-count">{{ sugeridos_stats.total_faltan }}</span>
                            </div>
                            <div class="sugerencia-list">
                                {% if sugeridos_faltan %}
                                    {% for m in sugeridos_faltan %}
                                    <div class="sugerencia-item" id="sugerido-{{ m.id }}">
                                        <div class="selected-item-avatar">{{ m.nombre|slice:":1"|upper }}</div>
                                        <div class="selected-item-info">
                                            <div class="selected-item-name">{{ m.nombre }}</div>
                                            <div class="selected-item-code">{{ m.codigo|default:"Sin c贸digo" }}</div>
                                        </div>
                                        <button type="button" 
                                                class="odoo-btn odoo-btn-success odoo-btn-sm btn-agregar-sugerido"
                                                data-id="{{ m.id }}" 
                                                data-nombre="{{ m.nombre }}" 
                                                data-codigo="{{ m.codigo }}">
                                            <span class="material-icons" style="font-size:16px;">add</span>
                                            A帽adir
                                        </button>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="selected-empty">
                                        <span class="material-icons">check_circle</span>
                                        <span>Todos los elegibles ya est谩n inscritos.</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- SOBRAN: No cumplen reglas -->
                        <div class="sugerencia-section">
                            <div class="sugerencia-section-header sobran">
                                <span class="material-icons">warning_amber</span>
                                <span class="sugerencia-section-title">No cumplen las reglas actuales</span>
                                <span class="sugerencia-section-count">{{ sugeridos_stats.total_sobran }}</span>
                            </div>
                            <div class="sugerencia-list">
                                {% if sugeridos_sobran %}
                                    {% for m in sugeridos_sobran %}
                                    <div class="sugerencia-item">
                                        <div class="selected-item-avatar">{{ m.nombre|slice:":1"|upper }}</div>
                                        <div class="selected-item-info">
                                            <div class="selected-item-name">{{ m.nombre }}</div>
                                            <div class="selected-item-code">{{ m.codigo|default:"Sin c贸digo" }}</div>
                                        </div>
                                        <span class="odoo-info-badge odoo-badge-warning">Revisar</span>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="selected-empty">
                                        <span class="material-icons">verified</span>
                                        <span>Todos los inscritos cumplen las reglas.</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {% else %}
                        <!-- MENSAJE PARA GRUPO NUEVO -->
                        <div class="odoo-empty-state">
                            <span class="material-icons">info</span>
                            <div>
                                <strong>Guarda el grupo primero</strong><br>
                                <small>Las sugerencias basadas en reglas estar谩n disponibles despu茅s de guardar.</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>

        </div>

        <!-- ASIDE -->
        <div class="odoo-form-aside">
            <div class="odoo-aside-actions">
                {% if grupo %}
                <button type="submit" class="odoo-btn odoo-btn-primary"><span class="material-icons">save</span> Guardar cambios</button>
                {% else %}
                <button type="submit" class="odoo-btn odoo-btn-primary"><span class="material-icons">check</span> Crear grupo</button>
                {% endif %}
                <a href="{% url 'formacion:grupos' %}" class="odoo-btn odoo-btn-secondary">Cancelar</a>
            </div>
            <div class="odoo-aside-info">
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Estado</span>
                    {% if grupo and not grupo.activo %}<span class="odoo-info-badge odoo-badge-inactive">Inactivo</span>{% else %}<span class="odoo-info-badge">Activo</span>{% endif %}
                </div>
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Programa</span>
                    <span class="odoo-info-value">{% if grupo and grupo.programa %}{{ grupo.programa.nombre }}{% else %}{% endif %}</span>
                </div>
                {% if grupo %}
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Creado</span>
                    <span class="odoo-info-value">{{ grupo.creado_en|date:"d/m/Y" }}</span>
                </div>
                {% endif %}
            </div>
            <div class="odoo-aside-tips">
                <h4 class="odoo-aside-title"> Reglas de filtrado</h4>
                <ul class="odoo-tips-list">
                    <li><strong>Sexo, edad y estado civil</strong> se usan para sugerir alumnos.</li>
                    <li>Las sugerencias <strong>no bloquean</strong> inscripciones manuales.</li>
                    <li>Puedes inscribir cualquier miembro aunque no cumpla las reglas.</li>
                </ul>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_URL = "/api/buscar-miembros/";
    const MIN_CHARS = 2;
    const DEBOUNCE_MS = 300;

    class AutocompleteMultiple {
        constructor(config) {
            this.key = config.key;
            this.searchInput = document.getElementById('search-' + config.key);
            this.dropdown = document.getElementById('dropdown-' + config.key);
            this.listEl = document.getElementById('list-' + config.key);
            this.emptyEl = document.getElementById('empty-' + config.key);
            this.loadingEl = document.getElementById('loading-' + config.key);
            this.selectedContainer = document.getElementById('selected-' + config.key);
            this.emptySelectedEl = document.getElementById('empty-selected-' + config.key);
            this.countEl = document.getElementById('count-' + config.key);
            this.hiddenInput = document.getElementById(config.key + '_ids');
            this.selected = new Map();
            this.debounceTimer = null;
            this.excludeFrom = config.excludeFrom || [];
            this.init();
        }

        init() {
            if (!this.searchInput) return;
            this.searchInput.addEventListener('input', (e) => {
                clearTimeout(this.debounceTimer);
                const query = e.target.value.trim();
                if (query.length < MIN_CHARS) { this.closeDropdown(); return; }
                this.debounceTimer = setTimeout(() => this.search(query), DEBOUNCE_MS);
            });
            this.searchInput.addEventListener('focus', () => {
                if (this.searchInput.value.length >= MIN_CHARS) this.dropdown.classList.add('open');
            });
            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { this.closeDropdown(); this.searchInput.blur(); }
            });
            document.addEventListener('click', (e) => {
                const wrapper = document.getElementById('autocomplete-' + this.key);
                if (wrapper && !wrapper.contains(e.target)) this.closeDropdown();
            });
        }

        async search(query) {
            this.showLoading();
            this.dropdown.classList.add('open');
            try {
                const response = await fetch(API_URL + '?q=' + encodeURIComponent(query) + '&filtro=activos&limit=15', {
                    credentials: 'same-origin',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (data.success && data.resultados) {
                    this.renderResults(data.resultados);
                } else {
                    this.showEmpty();
                }
            } catch (error) {
                console.error('Error buscando:', error);
                this.showEmpty();
            }
        }

        renderResults(results) {
            this.hideLoading();
            this.listEl.innerHTML = '';
            const excludeIds = new Set();
            this.selected.forEach((_, id) => excludeIds.add(String(id)));
            this.excludeFrom.forEach(other => {
                other.selected.forEach((_, id) => excludeIds.add(String(id)));
            });
            const filtered = results.filter(item => !excludeIds.has(String(item.id)));
            if (filtered.length === 0) { this.showEmpty(); return; }
            this.emptyEl.style.display = 'none';
            filtered.forEach(item => {
                const li = document.createElement('li');
                li.className = 'autocomplete-item';
                const inicial = item.nombre ? item.nombre.charAt(0).toUpperCase() : '?';
                li.innerHTML = '<div class="autocomplete-item-avatar">' + inicial + '</div><div class="autocomplete-item-info"><div class="autocomplete-item-name">' + this.escapeHtml(item.nombre) + '</div><div class="autocomplete-item-code">' + this.escapeHtml(item.codigo || 'Sin c贸digo') + '</div></div>';
                li.addEventListener('click', () => this.addItem(item.id, item.nombre, item.codigo));
                this.listEl.appendChild(li);
            });
        }

        addItem(id, nombre, codigo) {
            const strId = String(id);
            if (this.selected.has(strId)) return;
            this.selected.set(strId, { id: strId, nombre, codigo });
            this.renderSelected();
            this.updateHiddenInput();
            this.updateCount();
            this.updateBadge();
            this.searchInput.value = '';
            this.closeDropdown();
        }

        removeItem(id) {
            this.selected.delete(String(id));
            this.renderSelected();
            this.updateHiddenInput();
            this.updateCount();
            this.updateBadge();
        }

        renderSelected() {
            Array.from(this.selectedContainer.children).forEach(child => {
                if (child !== this.emptySelectedEl) child.remove();
            });
            if (this.selected.size === 0) { this.emptySelectedEl.style.display = 'flex'; return; }
            this.emptySelectedEl.style.display = 'none';
            this.selected.forEach((item, id) => {
                const div = document.createElement('div');
                div.className = 'selected-item';
                const inicial = item.nombre ? item.nombre.charAt(0).toUpperCase() : '?';
                div.innerHTML = '<div class="selected-item-avatar">' + inicial + '</div><div class="selected-item-info"><div class="selected-item-name">' + this.escapeHtml(item.nombre) + '</div><div class="selected-item-code">' + this.escapeHtml(item.codigo || 'Sin c贸digo') + '</div></div><button type="button" class="selected-item-remove" title="Quitar"><span class="material-icons">close</span></button>';
                div.querySelector('.selected-item-remove').addEventListener('click', () => this.removeItem(id));
                this.selectedContainer.appendChild(div);
            });
        }

        updateHiddenInput() {
            this.hiddenInput.value = Array.from(this.selected.keys()).join(',');
        }

        updateCount() {
            const count = this.selected.size;
            const labels = {
                'estudiantes': 'alumnos inscritos',
                'maestros': 'maestros asignados',
                'ayudantes': 'ayudantes asignados'
            };
            this.countEl.innerHTML = '<strong>' + count + '</strong> ' + (labels[this.key] || 'seleccionados');
        }

        updateBadge() {
            // Actualizar badge en pesta帽a
            if (this.key === 'estudiantes') {
                const badge = document.getElementById('badge-alumnos');
                if (badge) badge.textContent = this.selected.size;
            } else if (this.key === 'maestros' || this.key === 'ayudantes') {
                const acMaestros = window.__autocompletes && window.__autocompletes.maestros;
                const acAyudantes = window.__autocompletes && window.__autocompletes.ayudantes;
                const total = (acMaestros ? acMaestros.selected.size : 0) + (acAyudantes ? acAyudantes.selected.size : 0);
                const badge = document.getElementById('badge-equipo');
                if (badge) badge.textContent = total;
            }
        }

        showLoading() { this.listEl.innerHTML = ''; this.emptyEl.style.display = 'none'; this.loadingEl.style.display = 'flex'; }
        hideLoading() { this.loadingEl.style.display = 'none'; }
        showEmpty() { this.hideLoading(); this.listEl.innerHTML = ''; this.emptyEl.style.display = 'flex'; }
        closeDropdown() { this.dropdown.classList.remove('open'); }
        escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        loadExisting(items) {
            items.forEach(item => {
                this.selected.set(String(item.id), { id: String(item.id), nombre: item.nombre, codigo: item.codigo });
            });
            this.renderSelected();
            this.updateHiddenInput();
            this.updateCount();
            this.updateBadge();
        }
    }

    const acEstudiantes = new AutocompleteMultiple({ key: 'estudiantes' });
    const acMaestros = new AutocompleteMultiple({ key: 'maestros' });
    const acAyudantes = new AutocompleteMultiple({ key: 'ayudantes' });
    acMaestros.excludeFrom = [acAyudantes];
    acAyudantes.excludeFrom = [acMaestros];

    // Exponer instancias globalmente
    window.__autocompletes = {
        estudiantes: acEstudiantes,
        maestros: acMaestros,
        ayudantes: acAyudantes
    };

    // Cargar datos existentes (edici贸n)
    {% if maestros_actuales %}
    acMaestros.loadExisting({{ maestros_actuales|safe }});
    {% endif %}
    
    {% if ayudantes_actuales %}
    acAyudantes.loadExisting({{ ayudantes_actuales|safe }});
    {% endif %}
    
    {% if estudiantes_actuales %}
    acEstudiantes.loadExisting({{ estudiantes_actuales|safe }});
    {% endif %}

    // =========================================================================
    // BOTONES "AADIR" EN SUGERENCIAS
    // =========================================================================
    document.querySelectorAll('.btn-agregar-sugerido').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            const codigo = this.dataset.codigo;
            
            // A帽adir al autocomplete de estudiantes
            acEstudiantes.addItem(id, nombre, codigo);
            
            // Cambiar estado del bot贸n
            this.classList.add('added');
            this.innerHTML = '<span class="material-icons" style="font-size:16px;">check</span> A帽adido';
            this.disabled = true;
        });
    });

    // =========================================================================
    // TABS
    // =========================================================================
    const tabs = document.querySelectorAll('.odoo-tab');
    const panels = document.querySelectorAll('.odoo-tab-panel');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            const panel = document.getElementById('tab-' + tab.dataset.tab);
            if (panel) panel.classList.add('active');
        });
    });
});
</script>

{% endblock %}