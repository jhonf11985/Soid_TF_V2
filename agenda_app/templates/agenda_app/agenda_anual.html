{% extends "agenda_app/base_agenda.html" %}
{% load static %}

{% block agenda_content %}

<div class="odoo-page">

  <div class="agenda-header">
    <div class="agenda-header-left">
      <div class="agenda-title-group">
        <h1 class="agenda-title">Agenda anual</h1>
        <span class="agenda-year-badge">{{ year }}</span>
      </div>
      <p class="agenda-subtitle">Selecciona un mes para ver sus actividades</p>
    </div>

    <div class="agenda-header-right">
      <form method="get" class="year-selector">
        <span class="material-icons">calendar_month</span>
        <input
          name="year"
          type="number"
          value="{{ year }}"
          min="2000"
          max="2100"
          class="year-input"
        />
        <button class="btn-ver" type="submit">Ver</button>
      </form>

      <a href="{% url 'agenda_app:actividad_create' %}" class="btn-agendar">
        <span class="material-icons">add</span>
        Agendar
      </a>
    </div>
  </div>

  <div class="mini-calendar-grid">
    {% for m in meses_data %}
      <div class="mini-mes {% if m.total > 0 %}mini-mes-activo{% endif %}"
           data-mes="{{ m.mes_num }}"
           onclick="seleccionarMes({{ m.mes_num }})">
        <div class="mini-mes-nombre">{{ m.mes_nombre|slice:":3" }}</div>
        <div class="mini-mes-count">
          {% if m.total > 0 %}
            <span class="count-badge">{{ m.total }}</span>
          {% else %}
            <span class="count-empty">—</span>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="mes-detalle-container">

    {% for m in meses_data %}
      <div class="mes-detalle" id="mes-{{ m.mes_num }}" style="display: none;">

        <div class="mes-detalle-header">
          <div class="mes-detalle-info">
            <h2 class="mes-detalle-titulo">{{ m.mes_nombre }} {{ year }}</h2>
            <span class="mes-detalle-count">
              {% if m.total == 0 %}
                Sin actividades
              {% elif m.total == 1 %}
                1 actividad programada
              {% else %}
                {{ m.total }} actividades programadas
              {% endif %}
            </span>
          </div>

          <a href="{% url 'agenda_app:actividad_create' %}?mes={{ m.mes_num }}&year={{ year }}" class="btn-add-actividad">
            <span class="material-icons">add</span>
            Nueva actividad
          </a>
        </div>

        <div class="mes-detalle-body">

          {% if m.total == 0 %}
            <div class="mes-vacio">
              <div class="mes-vacio-icon">
                <span class="material-icons">event_busy</span>
              </div>
              <p class="mes-vacio-text">No hay actividades en {{ m.mes_nombre|lower }}</p>

              <a href="{% url 'agenda_app:actividad_create' %}?mes={{ m.mes_num }}&year={{ year }}" class="btn-crear-primera">
                <span class="material-icons">add_circle</span>
                Crear primera actividad
              </a>
            </div>

          {% elif m.actividades %}
            <div class="actividades-grid">
              {% for a in m.actividades %}
                <div class="actividad-card">
                  <div class="actividad-card-header">
                    <div class="actividad-fecha">
                      <span class="fecha-num">{{ a.fecha|date:"d" }}</span>
                      <span class="fecha-dia">{{ a.fecha|date:"D" }}</span>
                    </div>
                    {% if a.estado == "PROGRAMADA" %}
                      <span class="estado-dot estado-programada"></span>
                    {% elif a.estado == "REALIZADA" %}
                      <span class="estado-dot estado-realizada"></span>
                    {% else %}
                      <span class="estado-dot estado-cancelada"></span>
                    {% endif %}
                  </div>

                  <div class="actividad-card-body">
                    <a href="{% url 'agenda_app:actividad_detail' a.pk %}" class="actividad-nombre">{{ a.titulo }}</a>

                    <div class="actividad-detalles">
                      {% if a.hora_inicio %}
                        <span class="detalle-item">
                          <span class="material-icons">schedule</span>
                          {{ a.hora_inicio|time:"H:i" }}
                          {% if a.hora_fin %} - {{ a.hora_fin|time:"H:i" }}{% endif %}
                        </span>
                      {% endif %}

                      {% if a.lugar %}
                        <span class="detalle-item">
                          <span class="material-icons">place</span>
                          {{ a.lugar }}
                        </span>
                      {% endif %}

                      {% if a.responsable_texto %}
                        <span class="detalle-item">
                          <span class="material-icons">person</span>
                          {{ a.responsable_texto }}
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="actividad-card-footer">
                    <span class="tipo-badge">{{ a.get_tipo_display }}</span>
                  </div>
                </div>
              {% endfor %}
            </div>

          {% else %}
            <div class="mes-vacio">
              <div class="mes-vacio-icon">
                <span class="material-icons">event_busy</span>
              </div>
              <p class="mes-vacio-text">No hay actividades en {{ m.mes_nombre|lower }}</p>
            </div>
          {% endif %}

        </div>

      </div>
    {% endfor %}

    <div class="mes-placeholder" id="mes-placeholder">
      <div class="placeholder-icon">
        <span class="material-icons">touch_app</span>
      </div>
      <p class="placeholder-text">Selecciona un mes del calendario para ver sus actividades</p>
    </div>

  </div>

</div>

<style>

/* ================================
   VARIABLES
   ================================ */
:root {
  --primary: #714B67;
  --primary-light: #8F6B83;
  --primary-dark: #5C3D54;
  --secondary: #00A09D;
  --secondary-light: #E8F8F8;
  --bg-light: #F8F9FA;
  --bg-card: #FFFFFF;
  --border: #E9ECEF;
  --text-dark: #212529;
  --text-muted: #6C757D;
  --success: #28A745;
  --success-bg: #D4EDDA;
  --danger: #DC3545;
  --danger-bg: #F8D7DA;
  --info: #17A2B8;
  --info-bg: #D1ECF1;
}

/* ================================
   HEADER
   ================================ */
.agenda-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 24px;
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 16px;
  color: white;
}

.agenda-title-group {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.agenda-title {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
}

.agenda-year-badge {
  background: rgba(255,255,255,0.2);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 600;
}

.agenda-subtitle {
  margin: 8px 0 0;
  opacity: 0.85;
  font-size: 14px;
}

.agenda-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.year-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.15);
  padding: 6px 12px;
  border-radius: 8px;
}

.year-selector .material-icons {
  font-size: 20px;
  opacity: 0.8;
}

.year-input {
  width: 80px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  background: rgba(255,255,255,0.9);
  color: var(--text-dark);
}

.btn-ver {
  padding: 6px 14px;
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-ver:hover {
  background: rgba(255,255,255,0.3);
}

.btn-agendar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  background: white;
  color: var(--primary);
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-agendar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-agendar .material-icons {
  font-size: 20px;
}

/* ================================
   MINI CALENDAR GRID - MÁS COMPACTO
   ================================ */
.mini-calendar-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 6px;
  margin-bottom: 24px;
}

.mini-mes {
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px 4px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.mini-mes:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.mini-mes.mini-mes-activo {
  border-color: var(--secondary);
  background: var(--secondary-light);
}

.mini-mes.mini-mes-selected {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}

.mini-mes.mini-mes-selected .mini-mes-nombre {
  color: white;
}

.mini-mes.mini-mes-selected .count-badge {
  background: white;
  color: var(--primary);
}

.mini-mes.mini-mes-selected .count-empty {
  color: rgba(255,255,255,0.6);
}

.mini-mes-nombre {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-dark);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.mini-mes-count {
  min-height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.count-badge {
  background: var(--secondary);
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
}

.count-empty {
  color: var(--text-muted);
  opacity: 0.4;
  font-size: 12px;
}

/* ================================
   MES DETALLE CONTAINER
   ================================ */
.mes-detalle-container {
  background: var(--bg-card);
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  min-height: 300px;
  overflow: hidden;
}

.mes-detalle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-light);
}

.mes-detalle-titulo {
  margin: 0;
  font-size: 22px;
  font-weight: 700;
  color: var(--text-dark);
}

.mes-detalle-count {
  display: block;
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 4px;
}

.btn-add-actividad {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 18px;
  background: var(--secondary);
  color: white;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-add-actividad:hover {
  background: #008B88;
  transform: translateY(-1px);
}

.btn-add-actividad .material-icons {
  font-size: 18px;
}

.mes-detalle-body {
  padding: 20px 24px;
}

/* Mes vacío */
.mes-vacio {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
}

.mes-vacio-icon {
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-light);
  border-radius: 50%;
  margin-bottom: 16px;
}

.mes-vacio-icon .material-icons {
  font-size: 36px;
  color: var(--text-muted);
  opacity: 0.5;
}

.mes-vacio-text {
  font-size: 16px;
  color: var(--text-muted);
  margin: 0 0 20px;
}

.btn-crear-primera {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: var(--secondary);
  color: white;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-crear-primera:hover {
  background: #008B88;
  transform: translateY(-2px);
}

/* Placeholder */
.mes-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
}

.placeholder-icon {
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 50%;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.placeholder-icon .material-icons {
  font-size: 48px;
  color: white;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
}

.placeholder-text {
  font-size: 16px;
  color: var(--text-muted);
  margin: 0;
}

/* ================================
   ACTIVIDADES GRID - 3 COLUMNAS
   ================================ */
.actividades-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.actividad-card {
  background: var(--bg-light);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.2s;
}

.actividad-card:hover {
  border-color: var(--primary-light);
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.actividad-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
}

.actividad-card-header .actividad-fecha {
  display: flex;
  align-items: center;
  gap: 8px;
  color: white;
}

.actividad-card-header .fecha-num {
  font-size: 22px;
  font-weight: 700;
  line-height: 1;
}

.actividad-card-header .fecha-dia {
  font-size: 11px;
  text-transform: uppercase;
  opacity: 0.85;
}

.actividad-card-body {
  padding: 14px;
}

.actividad-nombre {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-dark);
  text-decoration: none;
  margin-bottom: 10px;
  line-height: 1.3;
}

.actividad-nombre:hover {
  color: var(--primary);
}

.actividad-detalles {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.detalle-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--text-muted);
}

.detalle-item .material-icons {
  font-size: 14px;
  color: var(--secondary);
}

.actividad-card-footer {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  background: white;
}

.tipo-badge {
  display: inline-block;
  background: var(--secondary-light);
  color: var(--secondary);
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

/* Estado dots */
.estado-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.estado-programada {
  background: #17A2B8;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.estado-realizada {
  background: #28A745;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.estado-cancelada {
  background: #DC3545;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

/* ================================
   RESPONSIVE
   ================================ */
@media (max-width: 1200px) {
  .actividades-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 992px) {
  .mini-calendar-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
  }
  
  .mini-mes {
    padding: 10px 6px;
  }
}

@media (max-width: 768px) {
  .agenda-header {
    flex-direction: column;
    padding: 20px;
  }

  .agenda-title {
    font-size: 24px;
  }

  .agenda-header-right {
    width: 100%;
    flex-direction: column;
  }

  .year-selector {
    width: 100%;
    justify-content: center;
  }

  .btn-agendar {
    width: 100%;
    justify-content: center;
  }

  .mini-calendar-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 6px;
  }

  .mini-mes {
    padding: 8px 4px;
  }

  .mini-mes-nombre {
    font-size: 10px;
  }

  .count-badge {
    font-size: 9px;
    padding: 2px 5px;
    min-width: 16px;
  }

  /* Detalle */
  .mes-detalle-header {
    flex-direction: column;
    align-items: flex-start;
    padding: 16px;
  }

  .btn-add-actividad {
    width: 100%;
    justify-content: center;
  }

  .actividades-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .actividad-card-body {
    padding: 12px;
  }

  .actividad-nombre {
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .mini-calendar-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .agenda-title {
    font-size: 20px;
  }

  .mes-detalle-titulo {
    font-size: 18px;
  }

  .actividades-grid {
    grid-template-columns: 1fr;
  }

  .mes-detalle-body {
    padding: 16px;
  }
}
</style>

<script>
function seleccionarMes(mesNumero) {
  document.querySelectorAll('.mini-mes').forEach(el => {
    el.classList.remove('mini-mes-selected');
  });

  const mesBtn = document.querySelector('.mini-mes[data-mes="' + mesNumero + '"]');
  if (mesBtn) mesBtn.classList.add('mini-mes-selected');

  const placeholder = document.getElementById('mes-placeholder');
  if (placeholder) placeholder.style.display = 'none';

  document.querySelectorAll('.mes-detalle').forEach(el => {
    el.style.display = 'none';
  });

  const detalle = document.getElementById('mes-' + mesNumero);
  if (detalle) detalle.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
  // 1) Si hay algún mes con actividades, abre el primero con actividades
  const primerMesConActividades = document.querySelector('.mini-mes.mini-mes-activo');
  if (primerMesConActividades) {
    const mes = parseInt(primerMesConActividades.getAttribute('data-mes'));
    seleccionarMes(mes);
    return;
  }

  // 2) Si no hay actividades en ningún mes, abre el mes actual igual (para ver "Sin actividades")
  const mesActual = new Date().getMonth() + 1;
  seleccionarMes(mesActual);
});
</script>


{% endblock %}