{% extends "agenda_app/base_agenda.html" %}
{% load static %}

{% block agenda_content %}

<div class="odoo-page">

  <div class="agenda-header">
    <div class="agenda-header-left">
      <div class="agenda-title-group">
        <h1 class="agenda-title">Agenda anual</h1>
        <span class="agenda-year-badge">{{ year }}</span>
      </div>
      <p class="agenda-subtitle">Selecciona un mes para ver sus actividades</p>
    </div>

    <div class="agenda-header-right">
      <form method="get" class="year-selector">
        <span class="material-icons">calendar_month</span>
        <input
          name="year"
          type="number"
          value="{{ year }}"
          min="2000"
          max="2100"
          class="year-input"
        />
        <button class="btn-ver" type="submit">Ver</button>
      </form>

      <a href="{% url 'agenda_app:actividad_create' %}" class="btn-agendar">
        <span class="material-icons">add</span>
        Agendar
      </a>
    </div>
  </div>

  <!-- Botón acordeón para móvil -->
  <div class="calendario-acordeon">
    <button type="button" class="acordeon-toggle" onclick="toggleCalendario()">
      <div class="acordeon-info">
        <span class="material-icons">calendar_month</span>
        <span class="acordeon-mes-actual">Selecciona un mes</span>
      </div>
      <span class="material-icons acordeon-arrow">expand_more</span>
    </button>
    
    <div class="acordeon-content" id="acordeon-content">
      <div class="mini-calendar-grid">
        {% for m in meses_data %}
          <div class="mini-mes {% if m.total > 0 %}mini-mes-activo{% endif %}"
               data-mes="{{ m.mes_num }}"
               data-nombre="{{ m.mes_nombre }}"
               onclick="seleccionarMes({{ m.mes_num }}, '{{ m.mes_nombre }}')">
            <div class="mini-mes-nombre">{{ m.mes_nombre|slice:":3" }}</div>
            <div class="mini-mes-count">
              {% if m.total > 0 %}
                <span class="count-badge">{{ m.total }}</span>
              {% else %}
                <span class="count-empty">—</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="mes-detalle-container">

    {% for m in meses_data %}
      <div class="mes-detalle" id="mes-{{ m.mes_num }}" style="display: none;">

        <div class="mes-detalle-header">
          <div class="mes-detalle-info">
            <h2 class="mes-detalle-titulo">{{ m.mes_nombre }} {{ year }}</h2>
            <span class="mes-detalle-count">
              {% if m.total == 0 %}
                Sin actividades
              {% elif m.total == 1 %}
                1 actividad programada
              {% else %}
                {{ m.total }} actividades programadas
              {% endif %}
            </span>
          </div>

          <a href="{% url 'agenda_app:actividad_create' %}?mes={{ m.mes_num }}&year={{ year }}" class="btn-add-actividad">
            <span class="material-icons">add</span>
            Nueva actividad
          </a>
        </div>

        <div class="mes-detalle-body">

          {% if m.total == 0 %}
            <div class="mes-vacio">
              <div class="mes-vacio-icon">
                <span class="material-icons">event_busy</span>
              </div>
              <p class="mes-vacio-text">No hay actividades en {{ m.mes_nombre|lower }}</p>

              <a href="{% url 'agenda_app:actividad_create' %}?mes={{ m.mes_num }}&year={{ year }}" class="btn-crear-primera">
                <span class="material-icons">add_circle</span>
                Crear primera actividad
              </a>
            </div>

          {% elif m.actividades %}
            <div class="actividades-lista">
              {% for a in m.actividades %}
                <a href="{% url 'agenda_app:actividad_detail' a.pk %}" class="actividad-row">
                  <div class="actividad-fecha-col">
                    <span class="fecha-num">{{ a.fecha|date:"d" }}</span>
                    <span class="fecha-dia">{{ a.fecha|date:"D" }}</span>
                  </div>
                  
                  <div class="actividad-estado-col">
                    {% if a.estado == "PROGRAMADA" %}
                      <span class="estado-dot estado-programada" title="Programada"></span>
                    {% elif a.estado == "REALIZADA" %}
                      <span class="estado-dot estado-realizada" title="Realizada"></span>
                    {% else %}
                      <span class="estado-dot estado-cancelada" title="Cancelada"></span>
                    {% endif %}
                  </div>
                  
                  <div class="actividad-info-col">
                    <span class="actividad-titulo">{{ a.titulo }}</span>
                    <div class="actividad-meta">
                      {% if a.hora_inicio %}
                        <span class="meta-item">
                          <span class="material-icons">schedule</span>
                          {{ a.hora_inicio|time:"H:i" }}{% if a.hora_fin %}-{{ a.hora_fin|time:"H:i" }}{% endif %}
                        </span>
                      {% endif %}
                      {% if a.lugar %}
                        <span class="meta-item">
                          <span class="material-icons">place</span>
                          {{ a.lugar|truncatechars:20 }}
                        </span>
                      {% endif %}
                      {% if a.unidad %}
                        <span class="meta-item">
                          <span class="material-icons">groups</span>
                          {{ a.unidad.nombre|truncatechars:15 }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="actividad-tipo-col">
                    <span class="tipo-badge tipo-{{ a.tipo|lower }}">{{ a.get_tipo_display }}</span>
                  </div>
                  
                  <div class="actividad-arrow-col">
                    <span class="material-icons">chevron_right</span>
                  </div>
                </a>
              {% endfor %}
            </div>

          {% else %}
            <div class="mes-vacio">
              <div class="mes-vacio-icon">
                <span class="material-icons">event_busy</span>
              </div>
              <p class="mes-vacio-text">No hay actividades en {{ m.mes_nombre|lower }}</p>
            </div>
          {% endif %}

        </div>

      </div>
    {% endfor %}

    <div class="mes-placeholder" id="mes-placeholder">
      <div class="placeholder-icon">
        <span class="material-icons">touch_app</span>
      </div>
      <p class="placeholder-text">Selecciona un mes del calendario para ver sus actividades</p>
    </div>

  </div>

</div>

<style>

/* ================================
   VARIABLES
   ================================ */
:root {
  --primary: #714B67;
  --primary-light: #8F6B83;
  --primary-dark: #5C3D54;
  --secondary: #00A09D;
  --secondary-light: #E8F8F8;
  --bg-light: #F8F9FA;
  --bg-card: #FFFFFF;
  --border: #E9ECEF;
  --text-dark: #212529;
  --text-muted: #6C757D;
  --success: #28A745;
  --success-bg: #D4EDDA;
  --danger: #DC3545;
  --danger-bg: #F8D7DA;
  --info: #17A2B8;
  --info-bg: #D1ECF1;
}

/* ================================
   HEADER
   ================================ */
.agenda-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 24px;
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 16px;
  color: white;
}

.agenda-title-group {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.agenda-title {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
}

.agenda-year-badge {
  background: rgba(255,255,255,0.2);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 600;
}

.agenda-subtitle {
  margin: 8px 0 0;
  opacity: 0.85;
  font-size: 14px;
}

.agenda-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.year-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.15);
  padding: 6px 12px;
  border-radius: 8px;
}

.year-selector .material-icons {
  font-size: 20px;
  opacity: 0.8;
}

.year-input {
  width: 80px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  background: rgba(255,255,255,0.9);
  color: var(--text-dark);
}

.btn-ver {
  padding: 6px 14px;
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-ver:hover {
  background: rgba(255,255,255,0.3);
}

.btn-agendar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  background: white;
  color: var(--primary);
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-agendar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-agendar .material-icons {
  font-size: 20px;
}

/* ================================
   ACORDEÓN CALENDARIO (MÓVIL)
   ================================ */
.calendario-acordeon {
  margin-bottom: 24px;
}

.acordeon-toggle {
  display: none; /* Oculto en desktop */
  width: 100%;
  padding: 14px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  align-items: center;
  justify-content: space-between;
  transition: all 0.2s;
}

.acordeon-toggle:hover {
  border-color: var(--primary-light);
}

.acordeon-toggle.active {
  border-color: var(--primary);
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
  border-bottom: none;
}

.acordeon-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.acordeon-info .material-icons {
  color: var(--primary);
  font-size: 22px;
}

.acordeon-mes-actual {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-dark);
}

.acordeon-arrow {
  color: var(--text-muted);
  font-size: 24px;
  transition: transform 0.3s;
}

.acordeon-toggle.active .acordeon-arrow {
  transform: rotate(180deg);
}

.acordeon-content {
  /* Visible por defecto en desktop */
}

.acordeon-content.collapsed {
  display: none;
}

/* ================================
   MINI CALENDAR GRID
   ================================ */
.mini-calendar-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 6px;
  margin-bottom: 24px;
}

.mini-mes {
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px 4px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.mini-mes:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.mini-mes.mini-mes-activo {
  border-color: var(--secondary);
  background: var(--secondary-light);
}

.mini-mes.mini-mes-selected {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}

.mini-mes.mini-mes-selected .mini-mes-nombre {
  color: white;
}

.mini-mes.mini-mes-selected .count-badge {
  background: rgba(255,255,255,0.25);
  color: white;
}

.mini-mes-nombre {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-dark);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.count-badge {
  display: inline-block;
  background: var(--secondary);
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
}

.count-empty {
  color: var(--text-muted);
  font-size: 12px;
}

/* ================================
   MES DETALLE
   ================================ */
.mes-detalle-container {
  background: var(--bg-card);
  border-radius: 12px;
  border: 1px solid var(--border);
  overflow: hidden;
  min-height: 300px;
}

.mes-detalle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-light);
}

.mes-detalle-titulo {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-dark);
}

.mes-detalle-count {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 4px;
  display: block;
}

.btn-add-actividad {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--secondary);
  color: white;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-add-actividad:hover {
  background: #008B88;
}

.btn-add-actividad .material-icons {
  font-size: 18px;
}

.mes-detalle-body {
  padding: 0;
}

/* Mes vacío */
.mes-vacio {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
}

.mes-vacio-icon {
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-light);
  border-radius: 50%;
  margin-bottom: 16px;
}

.mes-vacio-icon .material-icons {
  font-size: 36px;
  color: var(--text-muted);
  opacity: 0.5;
}

.mes-vacio-text {
  font-size: 16px;
  color: var(--text-muted);
  margin: 0 0 20px;
}

.btn-crear-primera {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: var(--secondary);
  color: white;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-crear-primera:hover {
  background: #008B88;
  transform: translateY(-2px);
}

/* Placeholder */
.mes-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
}

.placeholder-icon {
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 50%;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.placeholder-icon .material-icons {
  font-size: 48px;
  color: white;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
}

.placeholder-text {
  font-size: 16px;
  color: var(--text-muted);
  margin: 0;
}

/* ================================
   ACTIVIDADES LISTA (COMPACTA - 2 COLUMNAS)
   ================================ */
.actividades-lista {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0;
}

.actividades-lista .actividad-row:nth-child(odd) {
  border-right: 1px solid var(--border);
}

.actividades-lista .actividad-row:nth-last-child(1),
.actividades-lista .actividad-row:nth-last-child(2) {
  border-bottom: none;
}

.actividad-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  text-decoration: none;
  color: inherit;
  transition: background 0.15s;
}

.actividad-row:last-child {
  border-bottom: none;
}

.actividad-row:hover {
  background: var(--bg-light);
}

/* Columna fecha */
.actividad-fecha-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 44px;
  padding: 6px 8px;
  background: var(--primary);
  border-radius: 8px;
  color: white;
}

.actividad-fecha-col .fecha-num {
  font-size: 18px;
  font-weight: 700;
  line-height: 1;
}

.actividad-fecha-col .fecha-dia {
  font-size: 9px;
  text-transform: uppercase;
  opacity: 0.85;
  margin-top: 2px;
}

/* Columna estado */
.actividad-estado-col {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
}

.estado-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.estado-programada {
  background: #17A2B8;
}

.estado-realizada {
  background: #28A745;
}

.estado-cancelada {
  background: #DC3545;
}

/* Columna info principal */
.actividad-info-col {
  flex: 1;
  min-width: 0;
}

.actividad-titulo {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.actividad-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.meta-item {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: 11px;
  color: var(--text-muted);
}

.meta-item .material-icons {
  font-size: 13px;
  color: var(--secondary);
}

/* Columna tipo */
.actividad-tipo-col {
  flex-shrink: 0;
}

.tipo-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  background: var(--secondary-light);
  color: var(--secondary);
}

/* Columna arrow */
.actividad-arrow-col {
  flex-shrink: 0;
  color: var(--text-muted);
}

.actividad-arrow-col .material-icons {
  font-size: 20px;
  opacity: 0.4;
  transition: opacity 0.15s;
}

.actividad-row:hover .actividad-arrow-col .material-icons {
  opacity: 1;
  color: var(--primary);
}

/* ================================
   RESPONSIVE
   ================================ */
@media (max-width: 992px) {
  .mini-calendar-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
  }
  
  .mini-mes {
    padding: 10px 6px;
  }
}

@media (max-width: 768px) {
  .agenda-header {
    flex-direction: column;
    padding: 20px;
  }

  .agenda-title {
    font-size: 24px;
  }

  .agenda-header-right {
    width: 100%;
    flex-direction: column;
  }

  .year-selector {
    width: 100%;
    justify-content: center;
  }

  .btn-agendar {
    width: 100%;
    justify-content: center;
  }

  /* Acordeón visible en móvil */
  .acordeon-toggle {
    display: flex;
  }

  .acordeon-content {
    display: none;
    border: 2px solid var(--primary);
    border-top: none;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    padding: 12px;
    background: var(--bg-card);
  }

  .acordeon-content.expanded {
    display: block;
  }

  .mini-calendar-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 0;
  }

  .mini-mes {
    padding: 8px 4px;
  }

  .mini-mes-nombre {
    font-size: 10px;
  }

  .count-badge {
    font-size: 9px;
    padding: 2px 5px;
    min-width: 16px;
  }

  /* Detalle */
  .mes-detalle-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
  }

  .btn-add-actividad {
    width: 100%;
    justify-content: center;
  }

  /* Lista compacta en móvil - 1 columna */
  .actividades-lista {
    grid-template-columns: 1fr;
  }

  .actividades-lista .actividad-row:nth-child(odd) {
    border-right: none;
  }

  .actividad-row {
    padding: 10px 12px;
    gap: 10px;
  }

  .actividad-fecha-col {
    min-width: 38px;
    padding: 5px 6px;
  }

  .actividad-fecha-col .fecha-num {
    font-size: 16px;
  }

  .actividad-tipo-col {
    display: none;
  }

  .actividad-arrow-col {
    display: none;
  }

  .actividad-titulo {
    font-size: 13px;
  }

  .meta-item {
    font-size: 10px;
  }
}

@media (max-width: 480px) {
  .mini-calendar-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .agenda-title {
    font-size: 20px;
  }

  .mes-detalle-titulo {
    font-size: 18px;
  }

  .actividad-estado-col {
    display: none;
  }

  .actividad-meta {
    gap: 8px;
  }
}
</style>

<script>
let calendarioExpandido = false;

function toggleCalendario() {
  const toggle = document.querySelector('.acordeon-toggle');
  const content = document.getElementById('acordeon-content');
  
  calendarioExpandido = !calendarioExpandido;
  
  if (calendarioExpandido) {
    toggle.classList.add('active');
    content.classList.add('expanded');
    content.classList.remove('collapsed');
  } else {
    toggle.classList.remove('active');
    content.classList.remove('expanded');
    content.classList.add('collapsed');
  }
}

function seleccionarMes(mesNumero, mesNombre) {
  document.querySelectorAll('.mini-mes').forEach(el => {
    el.classList.remove('mini-mes-selected');
  });

  const mesBtn = document.querySelector('.mini-mes[data-mes="' + mesNumero + '"]');
  if (mesBtn) mesBtn.classList.add('mini-mes-selected');

  // Actualizar texto del acordeón
  const acordeonTexto = document.querySelector('.acordeon-mes-actual');
  if (acordeonTexto && mesNombre) {
    acordeonTexto.textContent = mesNombre + ' {{ year }}';
  }

  // Cerrar acordeón en móvil después de seleccionar
  if (window.innerWidth <= 768 && calendarioExpandido) {
    toggleCalendario();
  }

  const placeholder = document.getElementById('mes-placeholder');
  if (placeholder) placeholder.style.display = 'none';

  document.querySelectorAll('.mes-detalle').forEach(el => {
    el.style.display = 'none';
  });

  const detalle = document.getElementById('mes-' + mesNumero);
  if (detalle) detalle.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
  // Obtener el nombre del mes desde el elemento
  function getMesNombre(mesNum) {
    const mesEl = document.querySelector('.mini-mes[data-mes="' + mesNum + '"]');
    return mesEl ? mesEl.getAttribute('data-nombre') : '';
  }

  // 1) Si hay algún mes con actividades, abre el primero con actividades
  const primerMesConActividades = document.querySelector('.mini-mes.mini-mes-activo');
  if (primerMesConActividades) {
    const mes = parseInt(primerMesConActividades.getAttribute('data-mes'));
    const nombre = primerMesConActividades.getAttribute('data-nombre');
    seleccionarMes(mes, nombre);
    return;
  }

  // 2) Si no hay actividades en ningún mes, abre el mes actual igual
  const mesActual = new Date().getMonth() + 1;
  const nombreActual = getMesNombre(mesActual);
  seleccionarMes(mesActual, nombreActual);
});
</script>


{% endblock %}