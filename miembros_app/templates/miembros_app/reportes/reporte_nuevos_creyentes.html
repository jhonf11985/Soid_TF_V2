{% extends 'core/base_modulo.html' %}

{% block title %}Reporte de nuevos creyentes{% endblock %}

{% block breadcrumb %}
Miembros / Reportes / Nuevos creyentes
{% endblock %}

{% block content %}

<section class="page-header no-print">
    <div>
        <h1 class="page-title">Reporte de nuevos creyentes</h1>
        <p class="page-subtitle">
            Personas que han recibido a Cristo recientemente. Este reporte est√° pensado
            para organizar visitas, llamadas y el primer seguimiento.
        </p>
    </div>
    <div class="page-header-actions">
        <button type="button" class="btn-secondary" onclick="window.print()">
            <span class="material-icons" style="font-size:16px;">print</span>
            Imprimir
        </button>
    </div>
</section>

<section class="page-section">

    {# üîπ CABEZAL INSTITUCIONAL: SOLO SE VE AL IMPRIMIR #}
    <div class="only-print" style="text-align:center; margin-bottom:12px;">

        {% if CFG.logo %}
            <img src="{{ CFG.logo.url }}"
                 alt="{{ CFG.nombre_iglesia|default:'Logo iglesia' }}"
                 style="max-height:70px; margin-bottom:6px;">
        {% endif %}

        <h2 style="margin:0; font-size:18px; font-weight:700; letter-spacing:0.04em;">
            {% if CFG.nombre_iglesia %}
                {{ CFG.nombre_iglesia|upper }}
            {% else %}
                IGLESIA TORRE FUERTE
            {% endif %}
        </h2>

        {% if CFG.denominacion %}
            <div style="font-size:12px; color:#4b5563; margin-top:2px;">
                {{ CFG.denominacion }}
            </div>
        {% endif %}

        {% if CFG.lema %}
            <div style="font-size:12px; color:#6b7280; margin-top:4px; font-style:italic;">
                ‚Äú{{ CFG.lema }}‚Äù
            </div>
        {% endif %}

        {% if CFG.direccion %}
            <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                {{ CFG.direccion }}
            </div>
        {% endif %}

        <div style="font-size:11px; color:#6b7280; margin-top:6px;">
            Reporte: Nuevos creyentes ¬∑ Fecha: {{ hoy|date:"d/m/Y" }}
        </div>

        <hr style="margin-top:10px; border:none; border-top:1px solid #e5e7eb;">
    </div>

    <!-- Filtros (solo en pantalla) -->
    <form method="get" class="form-grid no-print" style="margin-bottom: 12px; align-items: flex-end;">

        <!-- Buscar -->
        <div class="form-field form-field-full">
            <label for="id_q">Buscar</label>
            <input
                id="id_q"
                type="text"
                name="q"
                placeholder="Nombre, tel√©fono o correo‚Ä¶"
                value="{{ query }}"
            >
        </div>

        <!-- Rango fechas + solo contacto -->
        <div class="form-field form-field-full">
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">

                <div>
                    <label for="id_fecha_desde">Conversi√≥n desde</label>
                    <input
                        id="id_fecha_desde"
                        type="date"
                        name="fecha_desde"
                        value="{{ fecha_desde }}"
                    >
                </div>

                <div>
                    <label for="id_fecha_hasta">Conversi√≥n hasta</label>
                    <input
                        id="id_fecha_hasta"
                        type="date"
                        name="fecha_hasta"
                        value="{{ fecha_hasta }}"
                    >
                </div>

                <div style="font-size:12px; margin-top:4px;">
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input
                            type="checkbox"
                            name="solo_contacto"
                            value="1"
                            {% if solo_contacto %}checked{% endif %}
                        >
                        Mostrar solo quienes tienen alg√∫n dato de contacto
                    </label>
                </div>

            </div>

            <p style="font-size:11px; color:#6b7280; margin-top:4px;">
                Si no seleccionas fechas, se mostrar√°n todos los nuevos creyentes registrados.
            </p>
        </div>

        <!-- Botones -->
        <div class="form-actions" style="justify-content:flex-start; border-top:none; padding-top:0;">
            <button type="submit" class="btn-secondary">
                <span class="material-icons" style="font-size:16px;">search</span>
                Aplicar filtros
            </button>
            <button type="button" class="btn-secondary" onclick="window.print()">
                <span class="material-icons" style="font-size:16px;">print</span>
                Imprimir
            </button>
        </div>

        <!-- Resumen -->
        <div class="form-field form-field-full" style="margin-top:-4px; font-size:12px; color:#6b7280;">
            {% if miembros %}
                {{ miembros|length }} nuevo{{ miembros|length|pluralize:" creyente,nuevos creyentes" }} encontrado{{ miembros|length|pluralize:"s" }}.
            {% else %}
                No se encontraron nuevos creyentes con los filtros seleccionados.
            {% endif %}
        </div>
    </form>

    <!-- Tabla -->
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Fecha conversi√≥n</th>
                    <th>Edad</th>
                    <th class="no-print col-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
            {% if miembros %}
                {% for m in miembros %}
                    <tr>
                        <td>{{ forloop.counter }}</td>

                        <!-- Nombre + g√©nero -->
                        <td>
                            <div style="font-weight:600; font-size:13px;">
                                {{ m.nombres }} {{ m.apellidos }}
                            </div>
                            <div style="font-size:11px; color:#6b7280;">
                                {% if m.genero %}
                                    {{ m.get_genero_display }}
                                {% else %}
                                    ‚Äî 
                                {% endif %}
                            </div>
                        </td>

                        <!-- Contacto -->
                        <td>
                            {% if m.telefono or m.telefono_secundario or m.email %}
                                {% if m.telefono or m.telefono_secundario %}
                                    <div style="font-size:12px;">
                                        {% if m.telefono %}
                                            {{ m.telefono }}
                                        {% endif %}
                                        {% if m.telefono_secundario %}
                                            {% if m.telefono %}<span> ¬∑ </span>{% endif %}
                                            {{ m.telefono_secundario }}
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if m.email %}
                                    <div style="font-size:11px; color:#6b7280;">
                                        {{ m.email }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <span style="font-size:11px; color:#9ca3af;">Sin datos</span>
                            {% endif %}
                        </td>

                        <!-- Fecha conversi√≥n -->
                        <td>
                            {% if m.fecha_conversion %}
                                {{ m.fecha_conversion|date:"d/m/Y" }}
                            {% else %}
                                <span style="font-size:11px; color:#9ca3af;">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Edad -->
                        <td>
                            {% if m.calcular_edad %}
                                {{ m.calcular_edad }} a√±os
                            {% else %}
                                <span style="font-size:11px; color:#9ca3af;">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Acciones (solo pantalla) -->
                        <td class="col-center no-print">
                            <a href="{% url 'miembros_app:nuevo_creyente_editar' m.pk %}"
                               class="btn-secondary"
                               style="padding:4px; min-width:auto;"
                               title="Editar nuevo creyente">
                                <span class="material-icons" style="font-size:18px;">edit</span>
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" class="table-empty">
                        No hay registros para mostrar.
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

</section>

<style>
.only-print {
    display: none;
}

/* Mobile-first: ya viene con table-wrapper y layout fluido.
   Solo ajustamos impresi√≥n. */
@media print {
    .topbar,
    .main-nav,
    .footer,
    .form-actions,
    .page-header,
    .page-header-actions,
    .no-print {
        display: none !important;
    }

    .layout {
        margin: 0;
        max-width: 100%;
        padding: 0;
    }

    .page-section {
        box-shadow: none;
        border: none;
        padding: 0;
    }

    .table th,
    .table td {
        font-size: 11px;
        padding: 4px 4px;
    }

    .only-print {
        display: inline !important;
    }
}
</style>

{% endblock %}
