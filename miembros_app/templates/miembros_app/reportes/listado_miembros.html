{% extends 'core/base_modulo.html' %}

{% block title %}Listado general de miembros{% endblock %}

{% block breadcrumb %}
Miembros / Reportes / Listado general
{% endblock %}

{% block content %}
<section class="page-header no-print">
    <div>
        <h1 class="page-title">Listado general de miembros</h1>
        <p class="page-subtitle"></p>
    </div>
<td>
    <span style="font-weight:600; color:#1e3a8a;">
        {{ m.codigo_miembro }}
    </span>
</td>

    <div class="page-header-actions">

        <!-- Imprimir (compacto) -->
        <button type="button"
                class="btn-secondary small-btn"
                onclick="window.print()">
            <span class="material-icons" style="font-size:16px;">print</span>
            Imprimir
        </button>

        <!-- Enviar por correo (compacto) -->
        <a href="{% url 'miembros_app:listado_miembros_enviar_email' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
           class="btn-primary small-btn"
           style="display:inline-flex; align-items:center; gap:4px;">
            <span class="material-icons" style="font-size:16px;">mail</span>
            Enviar
        </a>

        <!-- Exportar a Excel (compacto) -->
        <a href="{% url 'miembros_app:exportar_miembros_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
           class="btn-secondary small-btn"
           style="display:inline-flex; align-items:center; gap:4px;">
            <span class="material-icons" style="font-size:16px;">download</span>
            Excel
        </a>

        <!-- Importar Excel (compacto, con input oculto) -->
        <form id="importar-excel-form"
              action="{% url 'miembros_app:importar_miembros_excel' %}"
              method="post"
              enctype="multipart/form-data"
              style="display:inline;">
            {% csrf_token %}
            <input type="file"
                   id="archivo-excel-input"
                   name="archivo_excel"
                   accept=".xlsx,.xls"
                   style="display:none;"
                   onchange="document.getElementById('importar-excel-form').submit();">

            <button type="button"
                    class="btn-secondary small-btn"
                    style="display:inline-flex; align-items:center; gap:4px;"
                    onclick="document.getElementById('archivo-excel-input').click();">
                <span class="material-icons" style="font-size:16px;">upload</span>
                Importar
            </button>
        </form>

    </div>
</section>





<section class="page-section">

    {# Encabezado institucional: solo se ver√° AL IMPRIMIR #}
    <div class="only-print" style="text-align:center; margin-bottom:12px;">
        {% if CFG.logo %}
            <img src="{{ CFG.logo.url }}"
                 alt="{{ CFG.nombre_iglesia|default:'Logo iglesia' }}"
                 style="max-height:70px; margin-bottom:6px;">
        {% endif %}

        <h2 style="margin:0; font-size:18px; font-weight:700; letter-spacing:0.04em;">
            {% if CFG.nombre_iglesia %}
                {{ CFG.nombre_iglesia|upper }}
            {% else %}
                IGLESIA TORRE FUERTE
            {% endif %}
        </h2>

        {% if CFG.denominacion %}
            <div style="font-size:12px; color:#4b5563; margin-top:2px;">
                {{ CFG.denominacion }}
            </div>
        {% endif %}

        {% if CFG.lema %}
            <div style="font-size:12px; color:#6b7280; margin-top:4px; font-style:italic;">
                ‚Äú{{ CFG.lema }}‚Äù
            </div>
        {% endif %}

        {% if CFG.direccion %}
            <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                {{ CFG.direccion }}
            </div>
        {% endif %}

        <div style="font-size:11px; color:#6b7280; margin-top:6px;">
            Reporte: Listado general de miembros ¬∑ Fecha: {{ hoy|date:"d/m/Y" }}
        </div>

        <hr style="margin-top:10px; border:none; border-top:1px solid #e5e7eb;">
    </div>

    {# Meta info solo en pantalla #}
    <div class="report-meta no-print" style="font-size:12px; color:#6b7280; margin-bottom:8px;">
        <span>Registros encontrados:
            {% if miembros %}
                {{ miembros|length }}
            {% else %}
                0
            {% endif %}
        </span>
        <span style="margin-left:12px;">Fecha de generaci√≥n: {{ hoy|date:"d/m/Y" }}</span>
    </div>

    <!-- Filtros (versi√≥n profesional) -->
    <form method="get" class="filters-card no-print">

        <!-- üß© Fila principal: b√∫squeda + filtros clave -->
        <div class="filters-main-row">
            <!-- Buscar -->
            <div class="form-field form-field-grow">
                <label for="id_q">Buscar</label>
                <input
                    id="id_q"
                    type="text"
                    name="q"
                    placeholder="Nombre, apellido, tel√©fono, c√©dula o correo‚Ä¶"
                    value="{{ query }}"
                >
            </div>

            <!-- Estado -->
            <div class="form-field">
                <label for="id_estado">Estado</label>
                <select id="id_estado" name="estado">
                    <option value="">Todos</option>
                    {% for value, label in estados_choices %}
                        <option value="{{ value }}" {% if value == estado %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Categor√≠a -->
            <div class="form-field">
                <label for="id_categoria_edad">Categor√≠a</label>
                <select id="id_categoria_edad" name="categoria_edad">
                    <option value="">Todas</option>
                    {% for value, label in categorias_choices %}
                        <option value="{{ value }}" {% if value == categoria_edad_filtro %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- G√©nero -->
            <div class="form-field">
                <label for="id_genero">G√©nero</label>
                <select id="id_genero" name="genero">
                    <option value="">Todos</option>
                    {% for value, label in generos_choices %}
                        <option value="{{ value }}" {% if value == genero_filtro %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Bautismo -->
            <div class="form-field">
                <label for="id_bautizado">Bautismo</label>
                <select id="id_bautizado" name="bautizado">
                    <option value="">Todos</option>
                    <option value="1" {% if bautizado == "1" %}selected{% endif %}>Solo bautizados</option>
                    <option value="0" {% if bautizado == "0" %}selected{% endif %}>No bautizados</option>
                </select>
            </div>

            <!-- Bot√≥n aplicar -->
            <div class="filters-actions">
                <button type="submit" class="btn-secondary">
                    <span class="material-icons" style="font-size:16px;">search</span>
                    Aplicar
                </button>
            </div>
        </div>

        <!-- ‚öôÔ∏è Filtros avanzados (plegable) -->
        <details class="filters-advanced" {% if edad_min or edad_max or usar_rango_edad or tiene_contacto or mostrar_todos or incluir_ninos %}open{% endif %}>
            <summary>
                <span class="summary-icon">‚öôÔ∏è</span>
                <span>Filtros avanzados</span>
                <span class="summary-hint">Edad, contacto, ni√±os‚Ä¶</span>
            </summary>

            <div class="filters-advanced-body">

                <!-- Rango de edad -->
                <div class="advanced-row">
                    <div class="advanced-block">
                        <label>Edad (a√±os)</label>
                        <div class="edad-range-row">
                            <input
                                type="number"
                                name="edad_min"
                                min="0"
                                value="{{ edad_min }}"
                                placeholder="Desde"
                            >
                            <span class="edad-sep">a</span>
                            <input
                                type="number"
                                name="edad_max"
                                min="0"
                                value="{{ edad_max }}"
                                placeholder="Hasta"
                            >
                        </div>
                        <p class="hint-text">
                            Si no marcas la casilla, el reporte ignora este rango.
                        </p>
                    </div>

                    <label class="checkbox-inline">
                        <input
                            type="checkbox"
                            name="usar_rango_edad"
                            value="1"
                            {% if usar_rango_edad %}checked{% endif %}
                        >
                        Aplicar este rango de edad
                    </label>
                </div>

                <!-- Checkboxes especiales -->
                <div class="advanced-row">
                    <div class="checkbox-group">
                        <label class="checkbox-inline">
                            <input
                                type="checkbox"
                                name="tiene_contacto"
                                value="1"
                                {% if tiene_contacto %}checked{% endif %}
                            >
                            Solo con contacto
                        </label>

                        <label class="checkbox-inline">
                            <input
                                type="checkbox"
                                name="mostrar_todos"
                                value="1"
                                {% if mostrar_todos %}checked{% endif %}
                            >
                            Mostrar todos (incluye inactivos)
                        </label>

                        <label class="checkbox-inline">
                            <input
                                type="checkbox"
                                name="incluir_ninos"
                                value="1"
                                {% if incluir_ninos %}checked{% endif %}
                            >
                            Incluir ni√±os (menores de 12 a√±os)
                        </label>
                    </div>
                </div>

            </div>
        </details>
    </form>

    <!-- üîµ Chips de filtros activos -->
    {% if query or estado or genero_filtro or categoria_edad_filtro or bautizado or edad_min or edad_max or tiene_contacto or mostrar_todos or incluir_ninos %}
        <div class="filters-tags no-print">
            <span class="filters-tags-label">Filtros activos:</span>

            {% if query %}
                <span class="filter-chip">B√∫squeda: ‚Äú{{ query }}‚Äù</span>
            {% endif %}

            {% if estado %}
                <span class="filter-chip">Estado: {{ estado }}</span>
            {% endif %}

            {% if genero_filtro %}
                <span class="filter-chip">G√©nero: {{ genero_filtro }}</span>
            {% endif %}

            {% if categoria_edad_filtro %}
                <span class="filter-chip">Categor√≠a: {{ categoria_edad_filtro }}</span>
            {% endif %}

            {% if bautizado == "1" %}
                <span class="filter-chip">Solo bautizados</span>
            {% elif bautizado == "0" %}
                <span class="filter-chip">No bautizados</span>
            {% endif %}

            {# Edad: separamos la l√≥gica para evitar par√©ntesis en el if #}
            {% if usar_rango_edad %}
                {% if edad_min or edad_max %}
                    <span class="filter-chip">
                        Edad:
                        {% if edad_min %}desde {{ edad_min }}{% endif %}
                        {% if edad_min and edad_max %} ¬∑ {% endif %}
                        {% if edad_max %}hasta {{ edad_max }}{% endif %}
                    </span>
                {% endif %}
            {% endif %}

            {% if tiene_contacto %}
                <span class="filter-chip">Solo con contacto</span>
            {% endif %}

            {% if mostrar_todos %}
                <span class="filter-chip">Incluye inactivos</span>
            {% endif %}

            {% if incluir_ninos %}
                <span class="filter-chip">Incluye ni√±os</span>
            {% endif %}
        </div>
    {% endif %}


        <!-- Acciones -->
        <div class="form-actions" style="justify-content:flex-start; border-top:none; padding-top:0;">
            <button type="submit" class="btn-secondary">
                <span class="material-icons" style="font-size:16px;">search</span>
                Aplicar filtros
            </button>
        </div>
    </form>

    <!-- Tabla -->
    <div class="table-wrapper">
        <table class="table">
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Miembro</th>
                <th>Edad</th>
                <th>Categor√≠a</th>
                <th>C√©dula</th>
                <th>Contacto</th>
                <th>Estado</th>
                <th>Bautismo</th>
                <th class="col-center no-print">Acciones</th>
            </tr>
        </thead>

        <tbody>
        {% if miembros %}
            {% for m in miembros %}
            <tr>

                <!-- üîµ C√≥digo del miembro -->
                <td>
                    <span style="font-weight:600; color:#1e3a8a;">
                        {{ m.codigo_miembro }}
                    </span>
                </td>

                    <!-- Miembro -->
                    <td>
                        <div style="font-weight:600; font-size:13px;">
                            <a href="{% url 'miembros_app:detalle' m.pk %}" class="no-print">
                                {{ m.nombres }} {{ m.apellidos }}
                            </a>
                            <span class="only-print">
                                {{ m.nombres }} {{ m.apellidos }}
                            </span>
                        </div>
                        <div style="font-size:11px; color:#6b7280;">
                            {{ m.profesion|default:"Sin profesi√≥n registrada" }}
                        </div>
                    </td>

                    <!-- Edad -->
                    <td>
                        {% if m.calcular_edad %}
                            {{ m.calcular_edad }} a√±os
                        {% else %}
                            <span style="font-size:11px; color:#9ca3af;">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- Categor√≠a -->
                    <td>
                        {% if m.categoria_edad %}
                            <span style="
                                font-size:11px;
                                padding:2px 6px;
                                border-radius:999px;
                                background:#eef2ff;
                                color:#3730a3;
                                font-weight:600;">
                                {{ m.get_categoria_edad_display }}
                            </span>
                        {% else %}
                            <span style="font-size:11px; color:#9ca3af;">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- C√©dula -->
                    <td>
                        {% if m.cedula %}
                            {{ m.cedula }}
                        {% else %}
                            <span style="font-size:11px; color:#9ca3af;">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- Contacto -->
                    <td>
                        {% if m.telefono or m.whatsapp or m.email %}
                            {% if m.telefono or m.whatsapp %}
                                <div style="font-size:12px;">
                                    {% if m.telefono %}
                                        {% with numero=m.telefono %}
                                            {{ numero }}
                                            <a href="https://wa.me/{{ numero|cut:' '|cut:'-' }}"
                                               target="_blank"
                                               title="Enviar WhatsApp"
                                               class="no-print-inline">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="13"
                                                     height="13"
                                                     viewBox="0 0 24 24"
                                                     style="margin-left:6px; fill:#6b7280;">
                                                    <path d="M12 2C6.486 2 2 6.486 2 12c0 1.86.507 3.599 1.387 5.106L2 22l5.043-1.356A9.93 9.93 0 0 0 12 22c5.514 0 10-4.486 10-10S17.514 2 12 2zm0 18a7.93 7.93 0 0 1-4.062-1.129l-.289-.172-2.999.807.802-2.92-.188-.3A7.924 7.924 0 0 1 4 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8zm4.427-5.444c-.239-.119-1.415-.699-1.635-.777-.22-.08-.38-.119-.54.119-.159.239-.62.777-.76.936-.14.159-.28.18-.519.06-.239-.119-1.01-.372-1.926-1.185-.711-.633-1.192-1.414-1.332-1.653-.14-.239-.015-.368.105-.487.108-.108.239-.28.359-.419.119-.14.159-.239.239-.398.08-.159.04-.298-.02-.418-.06-.119-.539-1.298-.739-1.777-.195-.468-.394-.405-.539-.414l-.459-.008c-.159 0-.418.06-.638.298-.22.239-.839.82-.839 1.997 0 1.177.859 2.315.979 2.475.119.159 1.689 2.577 4.139 3.614.579.25 1.03.399 1.382.511.581.185 1.109.159 1.528.096.467-.069 1.415-.579 1.614-1.137.199-.557.199-1.037.139-1.137-.06-.099-.219-.159-.458-.278z"/>
                                                </svg>
                                            </a>
                                        {% endwith %}
                                    {% else %}
                                        {% with numero=m.whatsapp %}
                                            {{ numero }}
                                            <a href="https://wa.me/{{ numero|cut:' '|cut:'-' }}"
                                               target="_blank"
                                               title="Enviar WhatsApp"
                                               class="no-print-inline">
                                                <i class="bi bi-whatsapp"
                                                   style="font-size:1.25rem; margin-left:6px;">
                                                </i>
                                            </a>
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            {% endif %}

                            {% if m.email %}
                                <div style="font-size:12px;">{{ m.email }}</div>
                            {% endif %}
                        {% else %}
                            <span style="font-size:11px; color:#6b7280;">Sin datos</span>
                        {% endif %}
                    </td>

                    <!-- Estado -->
                    <td>
                        {% if not m.activo %}
                            <div style="
                                display:inline-block;
                                padding:2px 6px;
                                border-radius:999px;
                                background:#fee2e2;
                                color:#b91c1c;
                                font-size:11px;
                                font-weight:600;">
                                Inactivo
                            </div>

                            {% if m.razon_salida %}
                                <div style="font-size:11px; color:#6b7280;">
                                    {{ m.razon_salida }}
                                </div>
                            {% endif %}

                            {% if m.fecha_salida %}
                                <div style="font-size:11px; color:#6b7280;">
                                    Salida: {{ m.fecha_salida|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            {% if m.estado_miembro %}
                                <div style="font-size:12px; font-weight:600; color:#111827;">
                                    {{ m.get_estado_miembro_display }}
                                </div>
                            {% else %}
                                <div style="font-size:11px; color:#6b7280;">Sin estado</div>
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Bautismo -->
                    <td>
                        {% if m.bautizado_confirmado %}
                            <span class="pill pill-success">S√≠</span>
                            {% if m.fecha_bautismo %}
                                <div style="font-size:11px; color:#6b7280;">
                                    {{ m.fecha_bautismo|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            <span class="pill pill-muted">No</span>
                        {% endif %}
                    </td>

                    <!-- Acciones (solo pantalla) -->
                    <td class="col-center no-print">
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <!-- Ver detalle -->
                            <a href="{% url 'miembros_app:detalle' m.pk %}"
                               class="btn-secondary"
                               style="padding:4px; min-width:auto;">
                                <span class="material-icons" style="font-size:18px;">visibility</span>
                            </a>
                            <!-- Editar -->
                            <a href="{% url 'miembros_app:editar' m.pk %}"
                               class="btn-secondary"
                               style="padding:4px; min-width:auto;">
                                <span class="material-icons" style="font-size:18px;">edit</span>
                            </a>
                        </div>
                    </td>
                </tr>

                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="9" class="table-empty">
                        No se encontraron resultados.
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

</section>

<style>
.only-print {
    display: none;
}

@media print {
    /* Ocultar elementos de navegaci√≥n y controles del sistema */
    .topbar,
    .main-nav,
    .footer,
    .page-header,
    .form-grid,
    .page-header-actions,
    .no-print {
        display: none !important;
    }

    .layout {
        margin: 0;
        max-width: 100%;
        padding: 0;
    }

    .page-section {
        box-shadow: none;
        border: none;
        padding: 0;
    }

    .table th,
    .table td {
        font-size: 11px;
        padding: 4px 4px;
    }

    /* Mostrar encabezado institucional solo en impresi√≥n */
    .only-print {
        display: block !important;
    }
}

    /* Botones m√°s compactos */
    .small-btn {
        padding: 4px 10px;
        font-size: 13px;
    }

    .page-header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
    }

    /* Opcional: en pantallas muy peque√±as, que se vea m√°s ligero */
    @media (max-width: 480px) {
        .page-header-actions .small-btn {
            padding: 3px 8px;
            font-size: 12px;
        }
    }
@media (max-width: 640px) {

    .table th,
    .table td {
        font-size: 11px;
        padding: 4px 6px;
        white-space: nowrap;
    }

    /* Que la columna de C√≥digo se vea clara en m√≥vil */
    .table th:first-child,
    .table td:first-child {
        position: sticky;
        left: 0;
        background: #f9fafb;
        z-index: 1;
    }
}
    /* ====== Filtros profesionales ====== */

    .filters-card {
        background: #f9fafb;
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 10px;
        border: 1px solid #e5e7eb;
    }

    .filters-main-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-end;
    }

    .form-field-grow {
        flex: 2 1 220px;
    }

    .filters-main-row .form-field {
        flex: 1 1 150px;
        min-width: 140px;
    }

    .filters-main-row label {
        font-size: 12px;
        color: #4b5563;
        margin-bottom: 2px;
        display: block;
    }

    .filters-main-row input[type="text"],
    .filters-main-row select {
        width: 100%;
        font-size: 13px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
    }

    .filters-actions {
        display: flex;
        align-items: flex-end;
        margin-left: auto;
    }

    .filters-actions .btn-secondary {
        white-space: nowrap;
    }

    /* Filtros avanzados (details/summary) */
    .filters-advanced {
        margin-top: 8px;
        border-top: 1px dashed #e5e7eb;
        padding-top: 8px;
        font-size: 13px;
    }

    .filters-advanced summary {
        list-style: none;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: #4b5563;
        font-weight: 500;
    }

    .filters-advanced summary::-webkit-details-marker {
        display: none;
    }

    .summary-icon {
        font-size: 14px;
    }

    .summary-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-left: 4px;
    }

    .filters-advanced-body {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .advanced-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .advanced-block {
        min-width: 220px;
    }

    .edad-range-row {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .edad-range-row input[type="number"] {
        width: 80px;
        padding: 4px 6px;
        font-size: 13px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
    }

    .edad-sep {
        font-size: 12px;
        color: #6b7280;
    }

    .hint-text {
        font-size: 11px;
        color: #6b7280;
        margin-top: 3px;
    }

    .checkbox-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #4b5563;
        cursor: pointer;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    /* Chips filtros activos */
    .filters-tags {
        margin-bottom: 10px;
        font-size: 11px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
    }

    .filters-tags-label {
        font-weight: 600;
        color: #4b5563;
        margin-right: 4px;
    }

    .filter-chip {
        background: #eef2ff;
        color: #3730a3;
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: 1px solid #e0e7ff;
    }

    @media (max-width: 640px) {
        .filters-main-row {
            flex-direction: column;
        }

        .filters-actions {
            margin-left: 0;
            justify-content: flex-start;
        }
    }


</style>

{% endblock %}
