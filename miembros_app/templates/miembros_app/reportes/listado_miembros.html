{% extends 'core/base_modulo.html' %}

{% block title %}Listado general de miembros{% endblock %}

{% block breadcrumb %}
Miembros / Reportes / Listado general
{% endblock %}

{% block content %}

<section class="page-header">
    <div>
        <h1 class="page-title">Listado general de miembros</h1>
        <p class="page-subtitle">
            Versión imprimible del listado de miembros. Por defecto se muestran solo los activos y pasivos
            (mayores de {{ EDAD_MINIMA_MIEMBRO_OFICIAL }} años).
        </p>

    </div>
</section>

<section class="page-section">

    <!-- Filtros avanzados -->
    <form method="get" class="form-grid" style="margin-bottom: 12px; align-items: flex-end;">

        {# Fila 1: Buscador (fila completa) #}
        <div class="form-field form-field-full">
            <label for="id_q">Buscar</label>
            <input
                id="id_q"
                type="text"
                name="q"
                placeholder="Nombre, apellido, teléfono o correo…"
                value="{{ query }}"
            >
        </div>

        {# Fila 2: Estado / Género / Categoría / Bautismo #}
        <div class="form-field form-field-full">
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">

                <!-- Estado -->
                <div style="flex:1; min-width:160px;">
                    <label for="id_estado">Estado</label>
                    <select id="id_estado" name="estado">
                        <option value="">Todos</option>
                        {% for value, label in estados_choices %}
                            <option value="{{ value }}" {% if value == estado %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Género -->
                <div style="flex:1; min-width:160px;">
                    <label for="id_genero">Género</label>
                    <select id="id_genero" name="genero">
                        <option value="">Todos</option>
                        {% for value, label in generos_choices %}
                            <option value="{{ value }}" {% if value == genero_filtro %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Categoría de edad -->
                <div style="flex:1; min-width:160px;">
                    <label for="id_categoria_edad">Categoría</label>
                    <select id="id_categoria_edad" name="categoria_edad">
                        <option value="">Todas</option>
                        {% for value, label in categorias_choices %}
                            <option value="{{ value }}" {% if value == categoria_edad_filtro %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Bautismo -->
                <div style="flex:1; min-width:160px;">
                    <label for="id_bautizado">Bautismo</label>
                    <select id="id_bautizado" name="bautizado">
                        <option value="">Todos</option>
                        <option value="1" {% if bautizado == "1" %}selected{% endif %}>Solo bautizados</option>
                        <option value="0" {% if bautizado == "0" %}selected{% endif %}>No bautizados</option>
                    </select>
                </div>

            </div>
        </div>

        {# Fila 3: Rango de edad + check para activarlo #}
        <div class="form-field form-field-full">
            <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;">

                <div style="display:flex; flex-direction:column; gap:4px;">
                    <label>Edad (años)</label>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <input
                            type="number"
                            name="edad_min"
                            min="0"
                            value="{{ edad_min }}"
                            placeholder="Desde"
                            style="width:80px;"
                        >
                        <span style="font-size:12px; color:#6b7280;">a</span>
                        <input
                            type="number"
                            name="edad_max"
                            min="0"
                            value="{{ edad_max }}"
                            placeholder="Hasta"
                            style="width:80px;"
                        >
                    </div>
                </div>

                <label style="display:flex; align-items:center; gap:6px; font-size:12px; cursor:pointer; margin-bottom:4px;">
                    <input
                        type="checkbox"
                        name="usar_rango_edad"
                        value="1"
                        {% if usar_rango_edad %}checked{% endif %}
                    >
                    Aplicar este rango de edad a los resultados
                </label>
            </div>

            <p style="font-size:11px; color:#6b7280; margin-top:2px;">
                Si el check no está marcado, el reporte ignora estos valores.
            </p>
        </div>

        {# Fila 4: Checkboxes especiales #}
        <div class="form-field form-field-full" style="font-size:12px;">
            <div style="display:flex; flex-wrap:wrap; gap:12px;">

                <!-- Solo con contacto -->
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input
                        type="checkbox"
                        name="tiene_contacto"
                        value="1"
                        {% if tiene_contacto %}checked{% endif %}
                    >
                    Solo con contacto
                </label>

                <!-- Mostrar todos (incluye inactivos) -->
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input
                        type="checkbox"
                        name="mostrar_todos"
                        value="1"
                        {% if mostrar_todos %}checked{% endif %}
                    >
                    Mostrar todos (incluye inactivos)
                </label>

                <!-- Incluir niños -->
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input
                        type="checkbox"
                        name="incluir_ninos"
                        value="1"
                        {% if incluir_ninos %}checked{% endif %}
                    >
                    Incluir niños (menores de {{ EDAD_MINIMA_MIEMBRO_OFICIAL }} años)
                </label>

            </div>
        </div>

        <!-- Acciones -->
        <div class="form-actions" style="justify-content:flex-start; border-top:none; padding-top:0;">
            <button type="submit" class="btn-secondary">
                <span class="material-icons" style="font-size:16px;">search</span>
                Aplicar filtros
            </button>
            <button type="button" class="btn-secondary" onclick="window.print()">
                <span class="material-icons" style="font-size:16px;">print</span>
                Imprimir
            </button>
        </div>

        <!-- Resumen -->
        <div class="form-field form-field-full" style="margin-top:-4px; font-size:12px; color:#6b7280;">
            {% if miembros %}
                {{ miembros|length }} registro{{ miembros|length|pluralize:"s" }} encontrados
            {% else %}
                No se encontraron resultados con el criterio indicado.
            {% endif %}
        </div>
    </form>

    <!-- Tabla -->
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Miembro</th>
                    <th>Edad</th>
                    <th>Categoría</th>
                    <th>Contacto</th>
                    <th>Estado</th>
                    <th>Bautismo</th>
                    <th>Ingreso</th>
                    <th class="col-center no-print">Acciones</th>
                </tr>
            </thead>

            <tbody>
            {% if miembros %}
                {% for m in miembros %}
                <tr>
                    <td>{{ forloop.counter }}</td>

                    <!-- Miembro -->
                    <td>
                        <div style="font-weight:600; font-size:13px;">
                            <a href="{% url 'miembros_app:detalle' m.pk %}">
                                {{ m.nombres }} {{ m.apellidos }}
                            </a>
                        </div>
                        <div style="font-size:11px; color:#6b7280;">
                            {{ m.profesion|default:"Sin profesión registrada" }}
                        </div>
                    </td>

                    <!-- Edad -->
                    <td>
                        {% if m.calcular_edad %}
                            {{ m.calcular_edad }} años
                        {% else %}
                            <span style="font-size:11px; color:#9ca3af;">—</span>
                        {% endif %}
                    </td>

                    <!-- Categoría -->
                    <td>
                        {% if m.categoria_edad %}
                            <span style="
                                font-size:11px;
                                padding:2px 6px;
                                border-radius:999px;
                                background:#eef2ff;
                                color:#3730a3;
                                font-weight:600;">
                                {{ m.get_categoria_edad_display }}
                            </span>
                        {% else %}
                            <span style="font-size:11px; color:#9ca3af;">—</span>
                        {% endif %}
                    </td>

                    <!-- Contacto -->
                    <td>
                        {% if m.telefono %}
                            <div style="font-size:12px;">{{ m.telefono }}</div>
                        {% endif %}
                        {% if m.email %}
                            <div style="font-size:12px;">{{ m.email }}</div>
                        {% endif %}
                        {% if not m.telefono and not m.email %}
                            <span style="font-size:11px; color:#6b7280;">Sin datos</span>
                        {% endif %}
                    </td>

                    <!-- Estado -->
                    <td>
                        {% if not m.activo %}
                            <div style="
                                display:inline-block;
                                padding:2px 6px;
                                border-radius:999px;
                                background:#fee2e2;
                                color:#b91c1c;
                                font-size:11px;
                                font-weight:600;">
                                Inactivo
                            </div>

                            {% if m.razon_salida %}
                                <div style="font-size:11px; color:#6b7280;">
                                    {{ m.razon_salida }}
                                </div>
                            {% endif %}

                            {% if m.fecha_salida %}
                                <div style="font-size:11px; color:#6b7280;">
                                    Salida: {{ m.fecha_salida|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            {% if m.estado_miembro %}
                                <div style="font-size:12px; font-weight:600; color:#111827;">
                                    {{ m.get_estado_miembro_display }}
                                </div>
                            {% else %}
                                <div style="font-size:11px; color:#6b7280;">Sin estado</div>
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Bautismo -->
                    <td>
                        {% if m.bautizado_confirmado %}
                            <span class="pill pill-success">Sí</span>
                            {% if m.fecha_bautismo %}
                                <div style="font-size:11px; color:#6b7280;">
                                    {{ m.fecha_bautismo|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            <span class="pill pill-muted">No</span>
                        {% endif %}
                    </td>

                    <!-- Ingreso -->
                    <td>
                        {% if m.fecha_ingreso_iglesia %}
                            {{ m.fecha_ingreso_iglesia|date:"d/m/Y" }}
                        {% else %}
                            <span style="font-size:11px; color:#6b7280;">—</span>
                        {% endif %}
                    </td>

                    <!-- Acciones -->
                    <td class="col-center no-print">
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <!-- Ver detalle -->
                            <a href="{% url 'miembros_app:detalle' m.pk %}"
                               class="btn-secondary"
                               style="padding:4px; min-width:auto;">
                                <span class="material-icons" style="font-size:18px;">visibility</span>
                            </a>
                            <!-- Editar -->
                            <a href="{% url 'miembros_app:editar' m.pk %}"
                               class="btn-secondary"
                               style="padding:4px; min-width:auto;">
                                <span class="material-icons" style="font-size:18px;">edit</span>
                            </a>
                        </div>
                    </td>
                </tr>

                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="9" class="table-empty">
                        No se encontraron resultados.
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

</section>

<style>
@media print {
    .topbar,
    .main-nav,
    .footer,
    .form-actions,
    .form-grid,
    .page-header-actions,
    .no-print {
        display: none !important;
    }

    .layout {
        margin: 0;
        max-width: 100%;
        padding: 0;
    }

    .page-section {
        box-shadow: none;
        border: none;
        padding: 0;
    }

    .page-title {
        font-size: 18px;
        margin-bottom: 4px;
    }

    .page-subtitle {
        font-size: 11px;
    }

    .table th,
    .table td {
        font-size: 11px;
        padding: 4px 4px;
    }
}
</style>

{% endblock %}
