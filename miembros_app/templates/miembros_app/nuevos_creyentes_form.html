{% extends 'miembros_app/base_miembros.html' %}
{% load static %}

{% block title %}
    {% if modo == "editar" %}Editar nuevo creyente{% else %}Registrar nuevo creyente{% endif %}
{% endblock %}

{% block miembros_content %}

<form method="post" class="odoo-form">
    {% csrf_token %}

    <!-- ══════════════════════════════════════════════════════════════════════════
         BARRA SUPERIOR (Control Bar)
         ══════════════════════════════════════════════════════════════════════════ -->
    <div class="odoo-control-bar">
        <div class="odoo-control-left">
            <a href="{% url 'miembros_app:nuevo_creyente_lista' %}" class="odoo-breadcrumb-link">
                <span class="material-icons">arrow_back</span>
                Nuevos creyentes
            </a>
            <span class="odoo-breadcrumb-sep">/</span>
            <span class="odoo-breadcrumb-current">
                {% if modo == "editar" %}Editar{% else %}Nuevo{% endif %}
            </span>
            
            {% if not modo == "editar" %}
            <span class="odoo-new-badge">Nuevo</span>
            {% endif %}
        </div>
        
        <div class="odoo-control-right">
            <div class="odoo-status-badge">
                <span class="material-icons">favorite</span>
                Nuevo creyente
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════════════
         CONTENIDO PRINCIPAL
         ══════════════════════════════════════════════════════════════════════════ -->
    <div class="odoo-form-container">
        
        <!-- ÁREA PRINCIPAL DEL FORMULARIO -->
        <div class="odoo-form-main">
            
            <!-- ─────────────────────────────────────────────────────────────────────
                 HEADER: Avatar + Nombre + Campos principales
                 ───────────────────────────────────────────────────────────────────── -->
            <div class="odoo-form-header">
                
                <!-- Avatar del nuevo creyente -->
                <div class="odoo-avatar-section">
                    <div class="odoo-avatar odoo-avatar-new">
                        <span class="material-icons">person_add</span>
                    </div>
                </div>

                <!-- Info principal -->
                <div class="odoo-header-info">
                  
                <!-- Radio: Género -->
                <div class="odoo-radio-group">
                    <label class="odoo-radio">
                        <input type="radio" name="genero" value="masculino"
                            {% if form.genero.value == 'masculino' %}checked{% endif %}>
                        <span>Masculino</span>
                    </label>

                    <label class="odoo-radio">
                        <input type="radio" name="genero" value="femenino"
                            {% if form.genero.value == 'femenino' %}checked{% endif %}>
                        <span>Femenino</span>
                    </label>
                </div>

                {% if form.genero.errors %}
                    <div class="odoo-field-error" style="padding-left:0;">{{ form.genero.errors.0 }}</div>
                {% endif %}


                    <!-- Nombre grande -->
                    <div class="odoo-name-field">
                        <input type="text" 
                               name="nombres" 
                               id="{{ form.nombres.id_for_label }}"
                               value="{{ form.nombres.value|default:'' }}"
                               placeholder="Nombres"
                               class="odoo-name-input {% if form.nombres.errors %}odoo-input-error{% endif %}"
                               required>
                        <input type="text" 
                               name="apellidos" 
                               id="{{ form.apellidos.id_for_label }}"
                               value="{{ form.apellidos.value|default:'' }}"
                               placeholder="Apellidos"
                               class="odoo-name-input">
                    </div>
                    {% if form.nombres.errors %}
                    <span class="odoo-error-inline">{{ form.nombres.errors.0 }}</span>
                    {% endif %}

                    <!-- Campos de contacto rápido -->
                    <div class="odoo-quick-fields">
                        <div class="odoo-quick-field">
                            <span class="material-icons">email</span>
                            <input type="email" 
                                   name="email" 
                                   id="{{ form.email.id_for_label }}"
                                   value="{{ form.email.value|default:'' }}"
                                   placeholder="Correo electrónico">
                        </div>
                        <div class="odoo-quick-field">
                            <span class="material-icons">phone</span>
                            <input type="tel" 
                                   name="telefono" 
                                   id="{{ form.telefono.id_for_label }}"
                                   value="{{ form.telefono.value|default:'' }}"
                                   placeholder="Teléfono">
                        </div>
                        <div id="telefono-dup-msg" class="odoo-field-hint" style="display:none; margin-top:6px;">
  <span class="material-icons" style="font-size:16px; vertical-align:-3px;">warning</span>
  <span id="telefono-dup-text"></span>
</div>

                        <div class="odoo-quick-field">
                            <span class="material-icons">chat</span>
                            <input type="tel" 
                                   name="whatsapp" 
                                   id="{{ form.whatsapp.id_for_label }}"
                                   value="{{ form.whatsapp.value|default:'' }}"
                                   placeholder="WhatsApp">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ─────────────────────────────────────────────────────────────────────
                 BODY: Campos en dos columnas estilo Odoo
                 ───────────────────────────────────────────────────────────────────── -->
            <div class="odoo-form-body">
                
                <!-- Columna Izquierda -->
                <div class="odoo-form-column">
                    
                    <div class="odoo-field">
                        <label class="odoo-label">Fecha de nacimiento</label>
                        <div class="odoo-field-input">
                        <input type="date" 
                            name="fecha_nacimiento" 
                            id="{{ form.fecha_nacimiento.id_for_label }}"
                            value="{% if form.fecha_nacimiento.value %}{{ form.fecha_nacimiento.value|date:'Y-m-d' }}{% endif %}"
                            class="odoo-input">

                        </div>
                    </div>
                    {% if form.fecha_nacimiento.errors %}
                    <div class="odoo-field-error">{{ form.fecha_nacimiento.errors.0 }}</div>
                    {% endif %}

                    <div class="odoo-field">
                        <label class="odoo-label">Fecha de conversión</label>
                        <div class="odoo-field-input">
                        <input type="date" 
                            name="fecha_conversion" 
                            id="{{ form.fecha_conversion.id_for_label }}"
                            value="{% if form.fecha_conversion.value %}{{ form.fecha_conversion.value|date:'Y-m-d' }}{% endif %}"
                            class="odoo-input">

                        </div>
                    </div>
                    {% if form.fecha_conversion.errors %}
                    <div class="odoo-field-error">{{ form.fecha_conversion.errors.0 }}</div>
                    {% endif %}

                </div>

                <!-- Columna Derecha -->
                <div class="odoo-form-column">

                    <div class="odoo-field-group">
                        <label class="odoo-label">Dirección</label>
                        <div class="odoo-field-input">
                            <input type="text" 
                                   name="direccion" 
                                   id="{{ form.direccion.id_for_label }}"
                                   value="{{ form.direccion.value|default:'' }}"
                                   placeholder="Dirección completa"
                                   class="odoo-input">
                        </div>
                    </div>
                    {% if form.direccion.errors %}
                    <div class="odoo-field-error">{{ form.direccion.errors.0 }}</div>
                    {% endif %}

                </div>

            </div>

            <!-- ─────────────────────────────────────────────────────────────────────
                 SECCIÓN: Notas de seguimiento
                 ───────────────────────────────────────────────────────────────────── -->
            <div class="odoo-section">
                <div class="odoo-section-title">
                    <span class="material-icons">note</span>
                    Notas de seguimiento
                </div>
                
                <div class="odoo-field-full">
                    <textarea name="notas" 
                              id="{{ form.notas.id_for_label }}"
                              class="odoo-textarea"
                              rows="4"
                              placeholder="Detalles para seguimiento: visita, discipulado, observaciones, etc.">{{ form.notas.value|default:'' }}</textarea>
                </div>
                {% if form.notas.errors %}
                <div class="odoo-field-error" style="padding-left: 0;">{{ form.notas.errors.0 }}</div>
                {% endif %}
            </div>

        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             PANEL LATERAL
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="odoo-form-aside">
            <div class="odoo-wa-toggle">
        <label class="odoo-switch">
            <input type="checkbox" id="id_enviar_whatsapp" name="enviar_whatsapp" value="1" checked>
            <span class="odoo-switch-slider"></span>
        </label>
        <div class="odoo-wa-toggle-text">
            <div class="odoo-wa-toggle-title">Enviar bienvenida por WhatsApp</div>
            <div class="odoo-wa-toggle-sub">Al guardar, abrir WhatsApp con el mensaje listo.</div>
        </div>
        </div>

            <!-- Botones de acción -->
            <div class="odoo-aside-actions">
                <button type="submit" class="odoo-btn-save">
                    <span class="material-icons">check</span>
                    Guardar
                </button>
                <a href="{% url 'miembros_app:nuevo_creyente_lista' %}" class="odoo-btn-cancel">
                    Descartar
                </a>
            </div>

            <!-- Info del registro -->
            <div class="odoo-aside-info">
                <div class="odoo-info-title">
                    <span class="material-icons">info</span>
                    Información
                </div>
                <div class="odoo-info-content">
                    {% if modo == "editar" %}
                        <p>Editando registro existente.</p>
                        {% if objeto.fecha_creacion %}
                        <p class="odoo-info-date">
                            Registrado: {{ objeto.fecha_creacion|date:"d/m/Y H:i" }}
                        </p>
                        {% endif %}
                    {% else %}
                        <p>Complete los datos del nuevo creyente.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tips -->
            <div class="odoo-aside-tips">
                <div class="odoo-info-title">
                    <span class="material-icons">lightbulb</span>
                    Consejos
                </div>
                <ul class="odoo-tips-list">
                    <li>Registre al menos un teléfono para seguimiento.</li>
                    <li>Las notas son útiles para el equipo pastoral.</li>
                    <li>La fecha de conversión ayuda al seguimiento.</li>
                </ul>
            </div>

        </div>

    </div>

</form>

<!-- ══════════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════════ -->
<style>
 /* WhatsApp toggle (aside) */
.odoo-wa-toggle{
  display:flex;
  gap:10px;
  align-items:flex-start;
  background:#ffffff;
  border:1px solid #e9ecef;
  border-radius:8px;
  padding:10px 12px;
}

.odoo-wa-toggle-text{flex:1}
.odoo-wa-toggle-title{
  font-size:13px;
  font-weight:600;
  color:#212529;
  line-height:1.2;
}
.odoo-wa-toggle-sub{
  margin-top:2px;
  font-size:12px;
  color:#6c757d;
  line-height:1.2;
}

/* Switch */
.odoo-switch{ position:relative; display:inline-block; width:42px; height:24px; margin-top:2px; flex:0 0 auto; }
.odoo-switch input{ display:none; }
.odoo-switch-slider{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background:#dee2e6; transition:.2s; border-radius:999px;
}
.odoo-switch-slider:before{
  content:""; position:absolute; height:18px; width:18px; left:3px; top:3px;
  background:white; transition:.2s; border-radius:50%;
  box-shadow:0 1px 2px rgba(0,0,0,.12);
}
.odoo-switch input:checked + .odoo-switch-slider{ background:#10b981; }
.odoo-switch input:checked + .odoo-switch-slider:before{ transform:translateX(18px); }
   
/* ═══════════════════════════════════════════════════════════════════════════
   RESET Y BASE
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form {
    background: #f8f9fa;
    min-height: 100vh;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BARRA DE CONTROL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-control-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    background: white;
    border-bottom: 1px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 100;
}

.odoo-control-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.odoo-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #017e84;
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
}

.odoo-breadcrumb-link:hover {
    text-decoration: underline;
}

.odoo-breadcrumb-link .material-icons {
    font-size: 18px;
}

.odoo-breadcrumb-sep {
    color: #6c757d;
}

.odoo-breadcrumb-current {
    font-size: 13px;
    color: #495057;
    font-weight: 500;
}

.odoo-new-badge {
    background: #d1fae5;
    color: #065f46;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 500;
}

.odoo-control-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.odoo-status-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #059669;
    font-weight: 500;
}

.odoo-status-badge .material-icons {
    font-size: 18px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTENEDOR PRINCIPAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-container {
    display: grid;
    grid-template-columns: 1fr 280px;
    min-height: calc(100vh - 50px);
}

.odoo-form-main {
    background: white;
    padding: 0;
    border-right: 1px solid #dee2e6;
}

/* ═══════════════════════════════════════════════════════════════════════════
   HEADER DEL FORMULARIO
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-header {
    display: flex;
    gap: 24px;
    padding: 24px;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(180deg, #f8f9fa 0%, white 100%);
}

.odoo-avatar-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.odoo-avatar {
    width: 110px;
    height: 110px;
    border-radius: 8px;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.odoo-avatar-new {
    background: linear-gradient(135deg, #10b981, #059669);
}

.odoo-avatar .material-icons {
    font-size: 48px;
    color: white;
}

.odoo-header-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Radio group */
.odoo-radio-group {
    display: flex;
    gap: 16px;
}

.odoo-radio {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 13px;
    color: #495057;
}

.odoo-radio input {
    accent-color: #017e84;
}

/* Name field */
.odoo-name-field {
    display: flex;
    gap: 12px;
}

.odoo-name-input {
    flex: 1;
    border: none;
    border-bottom: 2px solid #e9ecef;
    padding: 8px 0;
    font-size: 24px;
    font-weight: 500;
    color: #212529;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-name-input:hover {
    border-color: #adb5bd;
}

.odoo-name-input:focus {
    outline: none;
    border-color: #017e84;
}

.odoo-name-input::placeholder {
    color: #adb5bd;
    font-weight: 400;
}

.odoo-name-input.odoo-input-error {
    border-color: #dc3545;
}

.odoo-error-inline {
    color: #dc3545;
    font-size: 12px;
    margin-top: -8px;
}

/* Quick fields */
.odoo-quick-fields {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
}

.odoo-quick-field {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 200px;
}

.odoo-quick-field .material-icons {
    font-size: 18px;
    color: #6c757d;
}

.odoo-quick-field input {
    flex: 1;
    border: none;
    border-bottom: 1px solid transparent;
    padding: 4px 0;
    font-size: 14px;
    color: #212529;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-quick-field input:hover {
    border-color: #dee2e6;
}

.odoo-quick-field input:focus {
    outline: none;
    border-color: #017e84;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BODY DEL FORMULARIO
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    padding: 24px;
}

.odoo-form-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Field */
.odoo-field,
.odoo-field-group {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.odoo-label {
    width: 120px;
    flex-shrink: 0;
    font-size: 13px;
    font-weight: 500;
    color: #495057;
    padding-top: 8px;
    text-align: right;
}

.odoo-field-input {
    flex: 1;
}

.odoo-input {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
    padding: 6px 0;
    font-size: 14px;
    font-family: inherit;
    color: #212529;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-input:hover {
    border-bottom-color: #adb5bd;
}

.odoo-input:focus {
    outline: none;
    border-bottom-color: #017e84;
    border-bottom-width: 2px;
    padding-bottom: 5px;
}

.odoo-field-error {
    color: #dc3545;
    font-size: 12px;
    padding-left: 132px;
    margin-top: -8px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   SECCIÓN
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-section {
    padding: 20px 24px;
    border-top: 1px solid #e9ecef;
}

.odoo-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #212529;
    margin-bottom: 16px;
}

.odoo-section-title .material-icons {
    font-size: 18px;
    color: #017e84;
}

.odoo-field-full {
    width: 100%;
}

.odoo-textarea {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
    padding: 8px 0;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-textarea:hover {
    border-bottom-color: #adb5bd;
}

.odoo-textarea:focus {
    outline: none;
    border-bottom-color: #017e84;
    border-bottom-width: 2px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PANEL LATERAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-aside {
    background: #f8f9fa;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Botones de acción */
.odoo-aside-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.odoo-btn-save {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    padding: 10px 16px;
    background: #017e84;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
    font-family: inherit;
}

.odoo-btn-save:hover {
    background: #016166;
}

.odoo-btn-save .material-icons {
    font-size: 18px;
}

.odoo-btn-cancel {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 10px 16px;
    background: white;
    color: #495057;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s ease;
}

.odoo-btn-cancel:hover {
    background: #e9ecef;
}

/* Info card */
.odoo-aside-info,
.odoo-aside-tips {
    background: white;
    border-radius: 4px;
    padding: 12px;
}

.odoo-info-title {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    margin-bottom: 8px;
}

.odoo-info-title .material-icons {
    font-size: 16px;
    color: #017e84;
}

.odoo-info-content {
    font-size: 13px;
    color: #6c757d;
}

.odoo-info-content p {
    margin: 0 0 4px;
}

.odoo-info-date {
    font-size: 11px;
    color: #9ca3af;
}

/* Tips */
.odoo-tips-list {
    margin: 0;
    padding-left: 16px;
    font-size: 12px;
    color: #6c757d;
    line-height: 1.6;
}

.odoo-tips-list li {
    margin-bottom: 4px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════ */
@media (max-width: 1200px) {
    .odoo-form-container {
        grid-template-columns: 1fr;
    }
    
    .odoo-form-main {
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
    
    .odoo-form-aside {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .odoo-aside-actions {
        flex-direction: row;
        width: 100%;
    }
    
    .odoo-btn-save,
    .odoo-btn-cancel {
        flex: 1;
    }
    
    .odoo-aside-info,
    .odoo-aside-tips {
        flex: 1;
        min-width: 200px;
    }
}

@media (max-width: 768px) {
    .odoo-form-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .odoo-name-field {
        flex-direction: column;
    }
    
    .odoo-quick-fields {
        flex-direction: column;
        width: 100%;
    }
    
    .odoo-quick-field {
        width: 100%;
    }
    
    .odoo-form-body {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .odoo-field,
    .odoo-field-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .odoo-label {
        width: auto;
        text-align: left;
        padding-top: 0;
        margin-bottom: 4px;
    }
    
    .odoo-field-error {
        padding-left: 0;
    }
    #telefono-dup-msg{
  background:#fff3cd;
  border:1px solid #ffe69c;
  color:#664d03;
  border-radius:8px;
  padding:8px 10px;
  font-size:12px;
}
#telefono-dup-msg .material-icons{
  margin-right:6px;
}
button[disabled].odoo-btn-save{
  opacity:.6;
  cursor:not-allowed;
}

}
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tel = document.getElementById("{{ form.telefono.id_for_label }}");
  if (!tel) return;

  const msgBox  = document.getElementById("telefono-dup-msg");
  const msgText = document.getElementById("telefono-dup-text");

  // Botón Guardar (en tu template está el submit aquí) :contentReference[oaicite:5]{index=5}
  const formEl = tel.closest("form");
  const btnSave = formEl ? formEl.querySelector('button[type="submit"]') : null;

  // PK si estás editando (para excluirse a sí mismo)
  const pk = "{% if modo == 'editar' and objeto %}{{ objeto.pk }}{% endif %}";

  function digitsOnly(v){ return (v || "").replace(/\D/g, ""); }

  function showDup(msg){
    if (msgBox && msgText){
      msgText.textContent = msg;
      msgBox.style.display = "block";
    }
    tel.classList.add("odoo-input-error");
    if (btnSave) btnSave.disabled = true;
  }

  function clearDup(){
    if (msgBox){
      msgBox.style.display = "none";
    }
    tel.classList.remove("odoo-input-error");
    if (btnSave) btnSave.disabled = false;
  }

  let tmr = null;

  async function checkTelefono(){
    const raw = tel.value;
    const d = digitsOnly(raw);

    // No molestamos si no hay nada, o si está demasiado corto (evita spam al servidor)
    if (!d || d.length < 7){
      clearDup();
      return;
    }

    const params = new URLSearchParams();
    params.append("telefono", raw);
    if (pk) params.append("pk", pk);

    try {
      const url = "{% url 'miembros_app:validar_telefono' %}?" + params.toString();
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      const data = await res.json();

      if (data && data.existe){
        showDup("Este número ya está registrado en el sistema.");
      } else {
        clearDup();
      }
    } catch (e) {
      // Si falla el fetch, no bloqueamos (pero podrías avisar si quieres)
      clearDup();
    }
  }

  function debounceCheck(){
    clearTimeout(tmr);
    tmr = setTimeout(checkTelefono, 300);
  }

  tel.addEventListener("input", debounceCheck);
  tel.addEventListener("blur", checkTelefono);

  // chequeo inicial si ya viene lleno (modo editar)
  setTimeout(checkTelefono, 50);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const tel = document.getElementById("{{ form.telefono.id_for_label }}");
  const wa  = document.getElementById("{{ form.whatsapp.id_for_label }}");

  // (opcional) si en algún momento agregas teléfono secundario
  const tel2 = document.getElementById("id_telefono_secundario");

  if (!tel || !wa) return;

  function digitsOnly(v) { return (v || "").replace(/\D/g, ""); }

  function formatRD(d) {
    if (d.length === 11 && d.startsWith("1")) d = d.slice(1);
    d = d.slice(0, 10);

    const a = d.slice(0, 3);
    const b = d.slice(3, 6);
    const c = d.slice(6, 10);

    if (d.length <= 3) return a;
    if (d.length <= 6) return a + "-" + b;
    return a + "-" + b + "-" + c;
  }

  function toWhatsAppE164FromDigits(d) {
    if (d.length === 11 && d.startsWith("1")) d = d.slice(1);
    d = d.slice(0, 10);
    if (d.length === 10 && /^(809|829|849)/.test(d)) return "+1" + d;
    return "";
  }

  function normalizeWhatsAppInput(v) {
    const digits = digitsOnly(v);

    if (digits.length === 11 && digits.startsWith("1")) {
      const rd10 = digits.slice(1);
      return toWhatsAppE164FromDigits(rd10) || ("+" + digits);
    }
    if (digits.length === 10) {
      return toWhatsAppE164FromDigits(digits) || digits;
    }
    return digits ? ("+" + digits) : "";
  }

  let waEditado = false;

function syncFromTelefono() {
  const raw = digitsOnly(tel.value);

  // Formateo visual del teléfono (RD)
  tel.value = formatRD(raw);

  // Si WhatsApp fue editado por el usuario y no está vacío, lo respetamos
  if (waEditado && wa.value.trim()) return;

  // Tomamos dígitos del teléfono ya formateado
  const d = digitsOnly(tel.value);

  // ✅ Sincronización en tiempo real (parcial)
  // Si está escribiendo y ya tenemos algo, vamos formando +1 + dígitos (RD)
  if (d.length > 0) {
    // si tiene 11 y empieza con 1, lo tratamos como +1 + 10
    let dd = d;
    if (dd.length === 11 && dd.startsWith("1")) dd = dd.slice(1);
    dd = dd.slice(0, 10);

    // Si el número parece RD (o aún va parcial), mostramos +1 + lo que haya
    // Esto da "tiempo real" desde que empieza a escribir.
    wa.value = "+1" + dd;
  } else {
    wa.value = "";
  }

  // ✅ Cuando ya está completo y es RD válido, lo dejamos fino (tu lógica final)
  const e164 = toWhatsAppE164FromDigits(d);
  if (e164) wa.value = e164;
}


  function syncTelefonoSecundario() {
    if (!tel2) return;
    const d = digitsOnly(tel2.value);
    tel2.value = formatRD(d);
  }

  tel.addEventListener("input", syncFromTelefono);
  tel.addEventListener("blur", syncFromTelefono);

  if (tel2) {
    tel2.addEventListener("input", syncTelefonoSecundario);
    tel2.addEventListener("blur", syncTelefonoSecundario);
    syncTelefonoSecundario();
  }

    wa.addEventListener("input", function (e) {
    // Solo marcamos "editado" si el input fue del usuario real.
    // (Autofill / cambios programáticos no deben bloquear la sincronización)
    if (e.isTrusted) waEditado = true;

    wa.value = normalizeWhatsAppInput(wa.value);
    });


  wa.addEventListener("blur", function () {
    wa.value = normalizeWhatsAppInput(wa.value);
  });

  // Inicial
  syncFromTelefono();
  if (wa.value && wa.value.trim()) wa.value = normalizeWhatsAppInput(wa.value);
});
</script>
{% endblock %}