{% extends 'core/base_modulo.html' %}

{% block title %}Lista de Miembros{% endblock %}

{% block breadcrumb %}
Miembros / Lista
{% endblock %}

{% block content %}

<section class="page-header no-print">
    <div>
        <h1 class="page-title">Listado general de miembros</h1>
        <p class="page-subtitle">
        
        </p>
    </div>
    <div class="page-header-actions">
        <button type="button" class="btn-secondary" onclick="window.print()">
            <span class="material-icons" style="font-size:16px;">print</span>
            Imprimir
        </button>

        <a href="{% url 'miembros_app:listado_miembros_enviar_email' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
           class="btn-primary"
           style="display:inline-flex; align-items:center; gap:4px;">
            <span class="material-icons" style="font-size:16px;">mail</span>
            Enviar por correo
        </a>

        <a href="{% url 'miembros_app:exportar_miembros_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
           class="btn-secondary"
           style="display:inline-flex; align-items:center; gap:4px;">
            <span class="material-icons" style="font-size:16px;">download</span>
            Exportar a Excel
        </a>

        <!-- Importar desde Excel -->
        <form action="{% url 'miembros_app:importar_miembros_excel' %}"
              method="post"
              enctype="multipart/form-data"
              style="display:inline-flex; align-items:center; gap:6px; margin-left:8px;">
            {% csrf_token %}
            <input type="file"
                   name="archivo_excel"
                   accept=".xlsx,.xls"
                   required
                   style="font-size:11px; max-width:180px;">
            <button type="submit"
                    class="btn-secondary"
                    style="display:inline-flex; align-items:center; gap:4px;">
                <span class="material-icons" style="font-size:16px;">upload</span>
                Importar Excel
            </button>
        </form>
    </div>
</section>


<section class="page-section">

    <!-- Barra de búsqueda, filtros y resumen -->
    <div class="form-grid" style="margin-bottom: 16px; align-items: center;">
        <div class="form-field form-field-full">
            <form method="get" style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">

                <!-- Buscador -->
                <input
                    type="text"
                    name="q"
                    placeholder="Buscar por nombre, apellido, teléfono o correo…"
                    value="{{ query }}"
                    style="flex:1; min-width:230px;"
                >

                <button type="submit" class="btn-secondary">
                    <span class="material-icons" style="font-size:16px;">search</span>
                    Buscar
                </button>

                <!-- Filtros compactos -->
                <div style="display:flex; flex-wrap:wrap; gap:8px; width:100%; margin-top:6px;">

                    <!-- Estado -->
                    <div style="flex:1; min-width:140px;">
                        <label for="id_estado" style="font-size:11px; color:#6b7280;">Estado</label>
                        <select id="id_estado" name="estado" style="width:100%; font-size:12px;">
                            <option value="">Todos</option>
                            {% for value, label in estados_choices %}
                                <option value="{{ value }}" {% if value == estado %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Género -->
                    <div style="flex:1; min-width:120px;">
                        <label for="id_genero" style="font-size:11px; color:#6b7280;">Género</label>
                        <select id="id_genero" name="genero" style="width:100%; font-size:12px;">
                            <option value="">Todos</option>
                            {% for value, label in generos_choices %}
                                <option value="{{ value }}" {% if value == genero_filtro %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Categoría de edad -->
                    <div style="flex:1; min-width:150px;">
                        <label for="id_categoria_edad" style="font-size:11px; color:#6b7280;">Categoría</label>
                        <select id="id_categoria_edad" name="categoria_edad" style="width:100%; font-size:12px;">
                            <option value="">Todas</option>
                            {% for value, label in categorias_choices %}
                                <option value="{{ value }}" {% if value == categoria_edad_filtro %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Bautismo -->
                    <div style="flex:1; min-width:150px;">
                        <label for="id_bautizado" style="font-size:11px; color:#6b7280;">Bautismo</label>
                        <select id="id_bautizado" name="bautizado" style="width:100%; font-size:12px;">
                            <option value="">Todos</option>
                            <option value="1" {% if bautizado == "1" %}selected{% endif %}>Solo bautizados</option>
                            <option value="0" {% if bautizado == "0" %}selected{% endif %}>No bautizados</option>
                        </select>
                    </div>
                </div>

                <!-- Checkbox Mostrar todos -->
                <label
                    style="
                        width:100%;
                        margin-top:6px;
                        font-size:12px;
                        color:#4b5563;
                        display:flex;
                        align-items:center;
                        gap:6px;
                    "
                >
                    <input
                        type="checkbox"
                        name="mostrar_todos"
                        value="1"
                        {% if mostrar_todos %}checked{% endif %}
                    >
                    Mostrar todos (incluye inactivos y niños)
                </label>
            </form>
        </div>

        <div class="form-field form-field-full" style="margin-top: -4px; font-size:12px; color:#6b7280;">
            {% if miembros %}
                {{ miembros|length }} miembro{{ miembros|length|pluralize:"s" }} encontrados
            {% else %}
                No se encontraron miembros con el criterio indicado.
            {% endif %}
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Miembro</th>
                    <th>Contacto</th>
                    <th>Estado</th>
                    <th>Bautismo</th>
                    <th>Ingreso</th>
                    <th class="col-center">Acciones</th>
                </tr>
            </thead>

            <tbody>
            {% if miembros %}
                {% for m in miembros %}
                <tr>
                    <!-- Columna Miembro -->
                    <td>
                        <div class="member-main">
                            <div class="member-avatar">
                                {% if m.foto %}
                                    <img src="{{ m.foto.url }}" alt="{{ m.nombres }} {{ m.apellidos }}">
                                {% else %}
                                    <span>
                                        {{ m.nombres|default:""|first }}{{ m.apellidos|default:""|first }}
                                    </span>
                                {% endif %}
                            </div>
                            <div>
                                <div class="member-name">
                                    <a href="{% url 'miembros_app:detalle' m.pk %}">
                                        {{ m.nombres }} {{ m.apellidos }}
                                    </a>
                                </div>

                                <div class="member-subtext">
                                    {{ m.profesion|default:"Sin profesión registrada" }}
                                </div>

                                <!-- Edad + Categoría -->
                                <div class="member-subtext">
                                    {% if m.calcular_edad %}
                                        {{ m.calcular_edad }} años
                                        {% if m.categoria_edad %}
                                            · {{ m.get_categoria_edad_display }}
                                        {% endif %}
                                    {% else %}
                                        {% if m.categoria_edad %}
                                            {{ m.get_categoria_edad_display }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Columna Contacto -->
                    <td>
                        {% if m.telefono %}
                            <div class="member-contact-line">
                                {{ m.telefono }}
                            </div>
                        {% endif %}
                        {% if m.email %}
                            <div class="member-contact-line">
                                {{ m.email }}
                            </div>
                        {% endif %}
                        {% if not m.telefono and not m.email %}
                            <span class="member-subtext">Sin datos de contacto</span>
                        {% endif %}
                    </td>

                    <!-- Columna Estado / salida -->
                    <td>
                        {% if not m.activo %}
                            <!-- Miembro inactivo (salida registrada) -->
                            <span class="pill pill-muted" style="background:#fee2e2; color:#b91c1c; margin-bottom:2px; display:inline-block;">
                                Inactivo
                            </span>

                            {% if m.razon_salida %}
                                <div class="member-subtext">
                                    {{ m.razon_salida }}
                                </div>
                            {% endif %}

                            {% if m.fecha_salida %}
                                <div class="member-subtext">
                                    Salida: {{ m.fecha_salida|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- Miembro activo en la iglesia -->
                            {% if m.estado_miembro %}
                                <div class="member-subtext" style="font-weight:600; color:#111827;">
                                    {{ m.get_estado_miembro_display }}
                                </div>
                            {% else %}
                                <div class="member-subtext">Sin estado</div>
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Columna Bautismo -->
                    <td class="col-center">
                        {% if m.bautizado_confirmado %}
                            <span class="pill pill-success">Sí</span>
                            {% if m.fecha_bautismo %}
                                <div class="member-subtext">
                                    {{ m.fecha_bautismo|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        {% else %}
                            <span class="pill pill-muted">No</span>
                        {% endif %}
                    </td>

                    <!-- Columna Ingreso -->
                    <td>
                        {% if m.fecha_ingreso_iglesia %}
                            {{ m.fecha_ingreso_iglesia|date:"d/m/Y" }}
                        {% else %}
                            <span class="member-subtext">Sin fecha</span>
                        {% endif %}
                    </td>

                    <!-- Columna Acciones -->
                    <td class="col-center">
                        <a href="{% url 'miembros_app:editar' m.pk %}"
                           class="btn-secondary"
                           style="padding:4px 10px; font-size:12px;">
                            <span class="material-icons" style="font-size:16px;">edit</span>
                            Editar
                        </a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" class="table-empty">
                        No se encontraron miembros.
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

</section>

<style>
    .member-main {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        color: #374151;
        overflow: hidden;
        flex-shrink: 0;
    }

    .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .member-name {
        font-weight: 600;
        font-size: 13px;
    }

    .member-subtext {
        font-size: 11px;
        color: #6b7280;
    }

    .member-contact-line {
        font-size: 12px;
        margin-bottom: 2px;
    }
</style>

{% endblock %}
