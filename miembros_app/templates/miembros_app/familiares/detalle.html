{% extends 'miembros_app/base_miembros.html' %}
{% load static %}

{% block title %}{{ hogar.nombre }}{% endblock %}

{% block miembros_content %}

<div class="odoo-form">

  <!-- Barra superior -->
  <div class="odoo-control-bar">
    <div class="odoo-control-left">
      <a href="{% url 'miembros_app:familias_home' %}" class="odoo-breadcrumb-link">
        <span class="material-icons">arrow_back</span>
        Familias
      </a>
      <span class="odoo-breadcrumb-sep">/</span>
      <span class="odoo-breadcrumb-current">{{ hogar.nombre }}</span>
    </div>

    <div class="odoo-control-right">
      <div class="odoo-search">
        <span class="material-icons">search</span>
        <input id="miembrosSearch" type="text" placeholder="Buscar miembro…">
      </div>
    </div>
  </div>

  <!-- Encabezado tipo “hero” -->
  <div class="familia-hero">
    <div class="familia-hero-left">
      <div class="familia-hero-icon">
        <span class="material-icons">family_restroom</span>
      </div>

      <div class="familia-hero-info">
        <div class="familia-hero-title">{{ hogar.nombre }}</div>
        <div class="familia-hero-subtitle">
          Hogar • <strong>{{ hogar_miembros|length }}</strong> miembros
        </div>

        <div class="familia-hero-chips">
          <span class="chip">
            <span class="material-icons">group</span>
            Miembros: {{ hogar_miembros|length }}
          </span>

          {% if hogar.miembro_referencia %}
          <span class="chip">
            <span class="material-icons">verified</span>
            Referencia: {{ hogar.miembro_referencia.nombres }} {{ hogar.miembro_referencia.apellidos }}
          </span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="familia-hero-actions">
<a href="{% url 'miembros_app:familia_editar' hogar.id %}" class="odoo-btn odoo-btn-primary">
    <span class="material-icons">edit</span>
    Editar familia
</a>


      {% if hogar.miembro_referencia %}
      <a class="btn-primary" href="{% url 'miembros_app:familiares_lista' hogar.miembro_referencia.pk %}">
        <span class="material-icons">family_restroom</span>
        Ver relaciones
      </a>
      {% endif %}
    </div>
  </div>

  <div class="odoo-form-container">
    <div class="odoo-form-main">

      <!-- Sección miembros -->
      <div class="familiar-seccion">
        <h3 class="familiar-seccion-titulo">
          <span class="material-icons">group</span>
          Miembros del hogar
          <span class="odoo-badge">{{ hogar_miembros|length }}</span>
        </h3>

        <div class="miembros-grid" id="miembrosGrid">

          {% for hm in hogar_miembros %}
          {% with m=hm.miembro %}

          <a class="miembro-card"
             href="{% url 'miembros_app:detalle' m.pk %}"
             data-name="{{ m.nombres|lower }} {{ m.apellidos|lower }}">

            <div class="miembro-card-left">
              <div class="miembro-avatar">
                {% if m.foto %}
                  <img src="{{ m.foto.url }}" alt="{{ m.nombres }}">
                {% else %}
                  <span class="material-icons">person</span>
                {% endif %}
              </div>

              <div class="miembro-info">
                <div class="miembro-nombre">{{ m.nombres }} {{ m.apellidos }}</div>

                <!-- ROLES + REFERENCIA -->
                <div class="miembro-rol-line">
                  <span class="rol-badge rol-{{ hm.rol }}">
                    {{ hm.get_rol_display }}
                  </span>

                  {% if hm.es_principal %}
                  <span class="principal-badge">
                    <span class="material-icons">star</span>
                    Referencia familiar
                  </span>
                  {% endif %}
                </div>

                <div class="miembro-meta">
                  {% if m.codigo_miembro %}Código: {{ m.codigo_miembro }}{% endif %}
                  {% if not m.codigo_miembro and m.codigo_seguimiento %}Código: {{ m.codigo_seguimiento }}{% endif %}
                </div>
              </div>
            </div>

            <div class="miembro-card-right">
              <span class="material-icons">chevron_right</span>
            </div>
          </a>

          {% endwith %}
          {% empty %}
          <div class="familiar-vacio">
            <span class="material-icons">group</span>
            <p>No hay miembros en este hogar</p>
          </div>
          {% endfor %}

        </div>
      </div>

      <!-- Nota inferior -->
      <div class="familia-footer-note">
        <span class="material-icons">info</span>
        <div>
          Este listado se actualiza automáticamente cuando agregas o editas relaciones familiares.
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  /* ========= Controles superiores ========= */
  .odoo-search{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:10px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    min-width:320px;
  }
  .odoo-search input{
    border:none;
    outline:none;
    width:100%;
    font-size:14px;
    background:transparent;
  }
  .odoo-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    margin-left:10px;
    padding:2px 10px;
    border-radius:999px;
    font-size:12px;
    background:rgba(0,0,0,.06);
  }

  /* ========= HERO ========= */
  .familia-hero{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:16px;
    margin:12px 0 16px 0;
    padding:16px;
    border-radius:16px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
  }
  .familia-hero-left{
    display:flex;
    align-items:flex-start;
    gap:14px;
    min-width:0;
  }
  .familia-hero-icon{
    width:52px;
    height:52px;
    border-radius:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.06);
    flex:0 0 auto;
  }
  .familia-hero-title{
    font-size:20px;
    font-weight:800;
    line-height:1.2;
    color:#111;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:640px;
  }
  .familia-hero-subtitle{
    margin-top:4px;
    color:rgba(0,0,0,.55);
    font-size:13px;
  }
  .familia-hero-chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(0,0,0,.05);
    font-size:12px;
    color:#111;
  }
  .chip .material-icons{ font-size:16px; color:rgba(0,0,0,.6); }

  .familia-hero-actions{
    display:flex;
    gap:10px;
    flex:0 0 auto;
    align-items:center;
  }
  .btn-soft, .btn-primary{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:12px;
    text-decoration:none;
    border:1px solid rgba(0,0,0,.10);
    background:#fff;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
  }
  .btn-soft[disabled]{
    opacity:.55;
    cursor:not-allowed;
  }
  .btn-primary{
    background:#111;
    color:#fff;
    border-color:#111;
  }
  .btn-primary .material-icons{ color:#fff; font-size:18px; }
  .btn-soft .material-icons{ color:rgba(0,0,0,.65); font-size:18px; }

  /* ========= GRID miembros ========= */
  .miembros-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap:12px;
    margin-top:10px;
  }
  .miembro-card{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px;
    border-radius:14px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    text-decoration:none;
    transition:transform .08s ease, box-shadow .08s ease;
  }
  .miembro-card:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 22px rgba(0,0,0,.08);
  }
  .miembro-card-left{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .miembro-avatar{
    width:44px;
    height:44px;
    border-radius:14px;
    background:rgba(0,0,0,.06);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex:0 0 auto;
  }
  .miembro-avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .miembro-info{ min-width:0; }
  .miembro-nombre{
    font-weight:800;
    color:#111;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:520px;
  }

  /* ===== ROLES ===== */
  .miembro-rol-line{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:6px;
    flex-wrap:wrap;
  }

  .rol-badge{
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
  }

  /* Padre */
  .rol-padre{
    background:#e3f2fd;
    color:#1565c0;
  }

  /* Madre */
  .rol-madre{
    background:#fce4ec;
    color:#ad1457;
  }

  /* Hijo-Hija */
  .rol-hijo{
    background:#e8f5e9;
    color:#2e7d32;
  }

  /* Otro */
  .rol-otro{
    background:#f5f5f5;
    color:#444;
  }

  /* Principal (Referencia familiar) */
  .principal-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    background:#fff3cd;
    color:#856404;
    border:1px solid #ffeeba;
  }
  .principal-badge .material-icons{
    font-size:16px;
  }

  .miembro-meta{
    margin-top:6px;
    font-size:12px;
    color:rgba(0,0,0,.55);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:520px;
  }
  .miembro-card-right{
    color:rgba(0,0,0,.45);
    display:flex;
    align-items:center;
  }

  /* ========= Footer info ========= */
  .familia-footer-note{
    margin-top:14px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(0,0,0,.04);
    display:flex;
    gap:10px;
    align-items:flex-start;
    color:rgba(0,0,0,.7);
    font-size:13px;
  }
  .familia-footer-note .material-icons{ color:rgba(0,0,0,.55); }

  @media (max-width: 520px){
    .odoo-search{ min-width:0; width:100%; }
    .familia-hero{ flex-direction:column; }
    .familia-hero-actions{ width:100%; justify-content:flex-start; flex-wrap:wrap; }
    .familia-hero-title{ max-width: 320px; }
    .miembro-nombre, .miembro-meta{ max-width: 240px; }
  }
</style>

<script>
  (function(){
    const input = document.getElementById("miembrosSearch");
    const grid = document.getElementById("miembrosGrid");
    if(!input || !grid) return;

    input.addEventListener("input", function(){
      const q = (this.value || "").toLowerCase().trim();
      const cards = grid.querySelectorAll(".miembro-card");
      cards.forEach(card => {
        const name = card.getAttribute("data-name") || "";
        card.style.display = name.includes(q) ? "" : "none";
      });
    });
  })();
</script>

{% endblock %}
