{% extends 'miembros_app/base_miembros.html' %}
{% load static %}

{% block title %}
    {% if modo == "editar" and miembro %}
        {{ miembro.nombres }} {{ miembro.apellidos }} · Miembros
    {% else %}
        Nuevo miembro · Miembros
    {% endif %}
{% endblock %}

{% block miembros_content %}

<form method="post" enctype="multipart/form-data" class="odoo-form">
    {% csrf_token %}

    <!-- ══════════════════════════════════════════════════════════════════
         BARRA SUPERIOR (Control Bar)
         ══════════════════════════════════════════════════════════════════ -->
    <div class="odoo-control-bar">
        <div class="odoo-control-left">
            <a href="{% url 'miembros_app:lista' %}" class="odoo-breadcrumb-link">
                <span class="material-icons">arrow_back</span>
                Miembros
            </a>
            <span class="odoo-breadcrumb-sep">/</span>
            <span class="odoo-breadcrumb-current">
                {% if modo == "editar" %}Editar{% else %}Nuevo{% endif %}
            </span>
            
            {% if not modo == "editar" %}
            <span class="odoo-new-badge">Nuevo</span>
            {% endif %}
        </div>
        
        <div class="odoo-control-right">
            <div class="odoo-member-code">
                <span class="material-icons">qr_code_2</span>
                {% if form.codigo_miembro_display.value %}
                    {{ form.codigo_miembro_display.value }}
                {% else %}
                    {{ form.codigo_miembro_display.initial }}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════
         CONTENIDO PRINCIPAL
         ══════════════════════════════════════════════════════════════════ -->
    <div class="odoo-form-container">
        
        <!-- ÁREA PRINCIPAL DEL FORMULARIO -->
        <div class="odoo-form-main">
            
            <!-- ─────────────────────────────────────────────────────────
                 HEADER: Foto + Nombre + Campos principales
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-form-header">
                
                <!-- Foto del miembro -->
                <div class="odoo-avatar-section">
                    <div class="odoo-avatar">
                        {% if miembro and miembro.foto %}
                            <img src="{{ miembro.foto.url }}" alt="Foto">
                        {% else %}
                            <span class="material-icons">person</span>
                        {% endif %}
                    </div>
                    <div class="odoo-avatar-upload">
                        <input
                            type="file"
                            name="foto"
                            id="id_foto"
                            accept="image/*"
                        >
                    </div>

                </div>

                <!-- Info principal -->
                <div class="odoo-header-info">
                    
                    <!-- Radio: Género -->
                    <div class="odoo-radio-group">
                        <label class="odoo-radio">
                            <input type="radio" name="genero" value="masculino"
                                {% if form.genero.value == 'masculino' %}checked{% endif %}>
                            <span>Masculino</span>
                        </label>
                        <label class="odoo-radio">
                            <input type="radio" name="genero" value="femenino"
                                {% if form.genero.value == 'femenino' %}checked{% endif %}>
                            <span>Femenino</span>
                        </label>
                    </div>


                    <!-- Nombre grande -->
                    <div class="odoo-name-field">
                        <input type="text" 
                               name="nombres" 
                               id="{{ form.nombres.id_for_label }}"
                               value="{{ form.nombres.value|default:'' }}"
                               placeholder="Nombres"
                               class="odoo-name-input"
                               required>
                        <input type="text" 
                               name="apellidos" 
                               id="{{ form.apellidos.id_for_label }}"
                               value="{{ form.apellidos.value|default:'' }}"
                               placeholder="Apellidos"
                               class="odoo-name-input"
                               required>
                    </div>

                    <!-- Campos de contacto rápido -->
                    <div class="odoo-quick-fields">
                        <div class="odoo-quick-field">
                            <span class="material-icons">email</span>
                            <input type="email" 
                                   name="email" 
                                   id="{{ form.email.id_for_label }}"
                                   value="{{ form.email.value|default:'' }}"
                                   placeholder="Correo electrónico">
                        </div>
                        <div class="odoo-quick-field">
                            <span class="material-icons">phone</span>
                            <input type="tel" 
                                   name="telefono" 
                                   id="{{ form.telefono.id_for_label }}"
                                   value="{{ form.telefono.value|default:'' }}"
                                   placeholder="Teléfono">
                        </div>
                        <div class="odoo-quick-field">
                            <span class="material-icons">chat</span>
                            <input type="tel" 
                                   name="whatsapp" 
                                   id="{{ form.whatsapp.id_for_label }}"
                                   value="{{ form.whatsapp.value|default:'' }}"
                                   placeholder="WhatsApp">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ─────────────────────────────────────────────────────────
                 BODY: Campos en dos columnas estilo Odoo
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-form-body">
                
                <!-- Columna Izquierda -->
                <div class="odoo-form-column">
                    
                    <div class="odoo-field-group">
                        <label class="odoo-label">Dirección</label>
                        <div class="odoo-field-stack">
                            <input type="text" name="direccion" 
                                   id="{{ form.direccion.id_for_label }}"
                                   value="{{ form.direccion.value|default:'' }}"
                                   placeholder="Calle..." class="odoo-input">
                            <input type="text" name="sector" 
                                   id="{{ form.sector.id_for_label }}"
                                   value="{{ form.sector.value|default:'' }}"
                                   placeholder="Sector / Barrio" class="odoo-input">
                            <div class="odoo-field-row">
                                <input type="text" name="ciudad" 
                                       id="{{ form.ciudad.id_for_label }}"
                                       value="{{ form.ciudad.value|default:'' }}"
                                       placeholder="Ciudad" class="odoo-input">
                                <input type="text" name="provincia" 
                                       id="{{ form.provincia.id_for_label }}"
                                       value="{{ form.provincia.value|default:'' }}"
                                       placeholder="Provincia" class="odoo-input">
                                <input type="text" name="codigo_postal" 
                                       id="{{ form.codigo_postal.id_for_label }}"
                                       value="{{ form.codigo_postal.value|default:'' }}"
                                       placeholder="C.P." class="odoo-input odoo-input-small">
                            </div>
                            <select name="nacionalidad" id="{{ form.nacionalidad.id_for_label }}" class="odoo-input">
                                <option value="">País</option>
                                {% for value, label in form.nacionalidad.field.choices %}
                                    <option value="{{ value }}" {% if form.nacionalidad.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="odoo-form-column">
                    
                    <div class="odoo-field">
                        <label class="odoo-label">Cédula</label>
                        <input type="text" name="cedula" id="id_cedula"
                               value="{{ form.cedula.value|default:'' }}"
                               placeholder="000-0000000-0" class="odoo-input">
                    </div>

<div class="odoo-field">
    <label class="odoo-label">Fecha nacimiento</label>
    <input type="date"
           name="fecha_nacimiento"
           id="{{ form.fecha_nacimiento.id_for_label }}"
           class="odoo-input"
           value="{{ form.fecha_nacimiento.value|date:'Y-m-d' }}">
</div>

                    <!-- Aviso de edad mínima -->
                    <div id="edad_aviso" class="odoo-alert odoo-alert-warning" style="display:none;">
                        ⚠️ Estás registrando a un miembro menor de {{ EDAD_MINIMA_MIEMBRO_OFICIAL }} años.
                        <strong>No será considerado en la lista oficial.</strong>
                    </div>

                    {% if form.fecha_nacimiento.errors %}
                    <div class="odoo-field-error">
                        {% for error in form.fecha_nacimiento.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="odoo-field">
                        <label class="odoo-label">Estado civil</label>
                        <select name="estado_civil" id="{{ form.estado_civil.id_for_label }}" class="odoo-input">
                            {% for value, label in form.estado_civil.field.choices %}
                                <option value="{{ value }}" {% if form.estado_civil.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="odoo-field">
                        <label class="odoo-label">Estado miembro</label>
                        <select name="estado_miembro" id="id_estado_miembro" class="odoo-input">
                            {% for value, label in form.estado_miembro.field.choices %}
                                <option value="{{ value }}" {% if form.estado_miembro.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="odoo-field odoo-field-checkbox">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="bautizado_confirmado" id="id_bautizado_confirmado"
                                   {% if form.bautizado_confirmado.value %}checked{% endif %}>
                            <span>Bautizado confirmado</span>
                        </label>
                    </div>

                    <div class="odoo-field odoo-field-checkbox">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="activo" id="id_activo"
                                   {% if form.activo.value %}checked{% endif %}>
                            <span>Miembro activo</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ─────────────────────────────────────────────────────────
                 TABS: Pestañas inferiores estilo Odoo
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-tabs-section">
                
                <!-- Tab buttons -->
                <div class="odoo-tabs-bar">
                    <button type="button" class="odoo-tab active" data-tab="personal">
                        Información personal
                    </button>
                    <button type="button" class="odoo-tab" data-tab="membresia">
                        Membresía
                    </button>
                    <button type="button" class="odoo-tab" data-tab="emergencia">
                        Emergencia
                    </button>
                    <button type="button" class="odoo-tab" data-tab="trabajo">
                        Trabajo
                    </button>
                    <button type="button" class="odoo-tab" data-tab="familiares">
                        Familiares
                    </button>
                    <button type="button" class="odoo-tab" data-tab="intereses">
                        Intereses
                    </button>
                    <button type="button" class="odoo-tab" data-tab="notas">
                        Notas
                    </button>
                </div>

                <!-- Tab contents -->
                <div class="odoo-tabs-content">
                    
                    <!-- TAB: Información Personal -->
                    <div class="odoo-tab-panel active" id="tab-personal">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Lugar nacimiento</label>
                                <input type="text" name="lugar_nacimiento" 
                                       id="{{ form.lugar_nacimiento.id_for_label }}"
                                       value="{{ form.lugar_nacimiento.value|default:'' }}"
                                       placeholder="Ciudad o país de nacimiento" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Pasaporte</label>
                                <input type="text" name="pasaporte" 
                                       id="{{ form.pasaporte.id_for_label }}"
                                       value="{{ form.pasaporte.value|default:'' }}"
                                       placeholder="Número de pasaporte" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Nivel educativo</label>
                                <select name="nivel_educativo" id="{{ form.nivel_educativo.id_for_label }}" class="odoo-input">
                                    {% for value, label in form.nivel_educativo.field.choices %}
                                        <option value="{{ value }}" {% if form.nivel_educativo.value == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Profesión</label>
                                <input type="text" name="profesion" 
                                       id="{{ form.profesion.id_for_label }}"
                                       value="{{ form.profesion.value|default:'' }}"
                                       placeholder="Profesión u ocupación" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tel. secundario</label>
                                <input type="tel" name="telefono_secundario" 
                                       id="{{ form.telefono_secundario.id_for_label }}"
                                       value="{{ form.telefono_secundario.value|default:'' }}"
                                       placeholder="Teléfono alternativo" class="odoo-input">
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Membresía -->
                    <div class="odoo-tab-panel" id="tab-membresia">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Fecha ingreso</label>
                                <input type="date" name="fecha_ingreso_iglesia" 
                                       id="{{ form.fecha_ingreso_iglesia.id_for_label }}"
                                       value="{{ form.fecha_ingreso_iglesia.value|default:'' }}"
                                       class="odoo-input">
                            </div>
                            {% if form.fecha_ingreso_iglesia.errors %}
                            <div class="odoo-field-error odoo-field-full">
                                {% for error in form.fecha_ingreso_iglesia.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="odoo-field">
                                <label class="odoo-label">Fecha conversión</label>
                                <input type="date" name="fecha_conversion" 
                                       id="{{ form.fecha_conversion.id_for_label }}"
                                       value="{{ form.fecha_conversion.value|default:'' }}"
                                       class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Fecha bautismo</label>
                                <input type="date" name="fecha_bautismo" 
                                       id="{{ form.fecha_bautismo.id_for_label }}"
                                       value="{{ form.fecha_bautismo.value|default:'' }}"
                                       class="odoo-input">
                            </div>
                            <div class="odoo-field odoo-field-checkbox">
                                <label class="odoo-checkbox-label">
                                    <input type="checkbox" name="es_trasladado" id="id_es_trasladado"
                                           {% if form.es_trasladado.value %}checked{% endif %}>
                                    <span>Viene de otra iglesia</span>
                                </label>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Iglesia anterior</label>
                                <input type="text" name="iglesia_anterior" id="id_iglesia_anterior"
                                       value="{{ form.iglesia_anterior.value|default:'' }}"
                                       placeholder="Nombre de la iglesia anterior" class="odoo-input">
                            </div>
                        </div>

                        <!-- Sección de salida (solo visible si no está activo) -->
                        <div class="odoo-subsection" id="bloque-salida-miembro" style="display: none;">
                            <h4 class="odoo-subsection-title">Información de salida</h4>
                            <div class="odoo-tab-grid">
                                <div class="odoo-field">
                                    <label class="odoo-label">Razón salida</label>
                                    <select name="razon_salida" id="{{ form.razon_salida.id_for_label }}" class="odoo-input">
                                        {% for value, label in form.razon_salida.field.choices %}
                                            <option value="{{ value }}" {% if form.razon_salida.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% if form.razon_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.razon_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}

                                <div class="odoo-field">
                                    <label class="odoo-label">Fecha salida</label>
                                    <input type="date" name="fecha_salida" 
                                           id="{{ form.fecha_salida.id_for_label }}"
                                           value="{{ form.fecha_salida.value|default:'' }}"
                                           class="odoo-input">
                                </div>
                                {% if form.fecha_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.fecha_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}

                                <div class="odoo-field odoo-field-full">
                                    <label class="odoo-label">Comentario</label>
                                    <textarea name="comentario_salida" id="{{ form.comentario_salida.id_for_label }}"
                                              rows="2" class="odoo-textarea"
                                              placeholder="Detalles adicionales sobre la salida...">{{ form.comentario_salida.value|default:'' }}</textarea>
                                </div>
                                {% if form.comentario_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.comentario_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Emergencia -->
                    <div class="odoo-tab-panel" id="tab-emergencia">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Contacto emergencia</label>
                                <input type="text" name="contacto_emergencia_nombre" 
                                       id="{{ form.contacto_emergencia_nombre.id_for_label }}"
                                       value="{{ form.contacto_emergencia_nombre.value|default:'' }}"
                                       placeholder="Nombre completo" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tel. emergencia</label>
                                <input type="tel" name="contacto_emergencia_telefono" 
                                       id="{{ form.contacto_emergencia_telefono.id_for_label }}"
                                       value="{{ form.contacto_emergencia_telefono.value|default:'' }}"
                                       placeholder="Teléfono" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Relación</label>
                                <input type="text" name="contacto_emergencia_relacion" 
                                       id="{{ form.contacto_emergencia_relacion.id_for_label }}"
                                       value="{{ form.contacto_emergencia_relacion.value|default:'' }}"
                                       placeholder="Ej: Esposa, Padre, Hermano" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tipo de sangre</label>
                                <select name="tipo_sangre" id="{{ form.tipo_sangre.id_for_label }}" class="odoo-input">
                                    {% for value, label in form.tipo_sangre.field.choices %}
                                        <option value="{{ value }}" {% if form.tipo_sangre.value == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Alergias</label>
                                <textarea name="alergias" id="{{ form.alergias.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Lista de alergias conocidas...">{{ form.alergias.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Condiciones médicas</label>
                                <textarea name="condiciones_medicas" id="{{ form.condiciones_medicas.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Condiciones médicas relevantes...">{{ form.condiciones_medicas.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Medicamentos</label>
                                <textarea name="medicamentos" id="{{ form.medicamentos.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Medicamentos que toma regularmente...">{{ form.medicamentos.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Trabajo -->
                    <div class="odoo-tab-panel" id="tab-trabajo">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Empleador</label>
                                <input type="text" name="empleador" 
                                       id="{{ form.empleador.id_for_label }}"
                                       value="{{ form.empleador.value|default:'' }}"
                                       placeholder="Nombre de la empresa" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Puesto</label>
                                <input type="text" name="puesto" 
                                       id="{{ form.puesto.id_for_label }}"
                                       value="{{ form.puesto.value|default:'' }}"
                                       placeholder="Cargo o posición" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tel. trabajo</label>
                                <input type="tel" name="telefono_trabajo" 
                                       id="{{ form.telefono_trabajo.id_for_label }}"
                                       value="{{ form.telefono_trabajo.value|default:'' }}"
                                       placeholder="Teléfono laboral" class="odoo-input">
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Dirección trabajo</label>
                                <textarea name="direccion_trabajo" id="{{ form.direccion_trabajo.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Dirección completa del lugar de trabajo...">{{ form.direccion_trabajo.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Familiares -->
<div class="odoo-tab-panel" id="tab-familiares">
    
    <div class="odoo-field-full">
        <label class="odoo-separator">Familiares registrados</label>
        
        <table class="odoo-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Relación</th>
                    <th>Vive junto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for fam in familiares_existentes %} 
                <tr>
                    <td>{{ fam.nombre_completo }}</td>
                    <td>{{ fam.get_tipo_relacion_display }}</td>
                    <td>{% if fam.vive_junto %}Sí{% else %}No{% endif %}</td>
                    <td>
                        <a href="#" class="odoo-link-danger">
                            <span class="material-icons">delete</span>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="odoo-empty-text">No hay familiares registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="odoo-add-line" id="btn-add-familiar">
        <a href="javascript:void(0)" class="odoo-add-link" onclick="toggleFamiliarForm(true)">
            <span class="material-icons">add</span>
            Agregar familiar
        </a>
    </div>

    <div class="odoo-inline-edit-box" id="familiar-form" style="display:none;">
        <h5 class="odoo-inline-title">Nuevo familiar</h5>
        
        <div class="odoo-tab-grid">
            
<div class="odoo-field-row">
  <label>Buscar miembro</label>

  <div class="odoo-field-value autocomplete-wrapper" data-autocomplete-id="id_familiar_miembro">
    <!-- Campo hidden -->
    <input type="hidden" id="id_familiar_miembro" name="familiar_miembro" value="">

    <!-- Contenedor input + chip (MISMO estilo que ingreso) -->
    <div class="autocomplete-field">
      <div class="autocomplete-chip" style="display:none;">
        <span class="chip-avatar">M</span>
        <span class="chip-text">
          <span class="chip-name"></span>
          <span class="chip-code"></span>
        </span>
        <button type="button" class="chip-remove" title="Quitar">
          <span class="material-icons">close</span>
        </button>
      </div>

      <input
        type="text"
        class="autocomplete-search odoo-input"
        placeholder="Escriba para buscar..."
        autocomplete="off"
        data-endpoint="{% url 'core:api_buscar_miembros' %}"
      />

      <button type="button" class="autocomplete-clear-btn" style="display:none;"></button>
    </div>

    <!-- Dropdown -->
    <div class="autocomplete-dropdown">
      <ul class="autocomplete-list"></ul>

      <div class="autocomplete-loading" style="display:none;">
        <span class="material-icons spinner">sync</span>
        Buscando...
      </div>

      <div class="autocomplete-empty" style="display:none;">
        <span class="material-icons">person_search</span>
        No se encontraron miembros
      </div>
    </div>

    <!-- Mantengo este bloque para el JS, pero lo ocultamos porque usaremos CHIP -->
    <div class="autocomplete-selected" style="display:none;">
      <strong class="selected-name"></strong>
      <span class="selected-codigo"></span>
      <button type="button" class="selected-remove">×</button>
    </div>
  </div>
</div>



            <div class="odoo-field">
                <label class="odoo-label">Relación</label>
                <div class="odoo-field-stack">
                    <select name="tipo_relacion" id="id_tipo_relacion" class="odoo-input">
                        <option value="">Seleccione tipo...</option>
                        <option value="padre">Padre</option>
                        <option value="madre">Madre</option>
                        <option value="hijo">Hijo / Hija</option>
                        <option value="hermano">Hermano / Hermana</option>
                        <option value="conyuge">Cónyuge</option>
                        <option value="otro">Otro</option>
                    </select>

                    <div class="odoo-field-row" style="margin-top: 8px;">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="vive_junto">
                            <span>Vive junto</span>
                        </label>
                        <label class="odoo-checkbox-label" style="margin-left: 15px;">
                            <input type="checkbox" name="es_responsable">
                            <span>Es responsable</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="odoo-field odoo-field-full">
                <label class="odoo-label">Notas</label>
                <input type="text" name="notas_familiar" 
                       placeholder="Observaciones sobre la relación..." 
                       class="odoo-input">
            </div>

            <div class="odoo-field odoo-field-full">
                <div class="odoo-inline-actions">
                    <button type="submit" name="agregar_familiar" value="1" class="odoo-btn-primary odoo-btn-sm">
                        Guardar y cerrar
                    </button>
                    <button type="button" class="odoo-btn-secondary odoo-btn-sm" onclick="toggleFamiliarForm(false)">
                        Descartar
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>


                    <!-- TAB: Intereses y Habilidades -->
                    <div class="odoo-tab-panel" id="tab-intereses">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Intereses</label>
                                {{ form.intereses }}
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Otros intereses</label>
                                <textarea name="otros_intereses" id="{{ form.otros_intereses.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Otros intereses no listados...">{{ form.otros_intereses.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Habilidades</label>
                                {{ form.habilidades }}
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Otras habilidades</label>
                                <textarea name="otras_habilidades" id="{{ form.otras_habilidades.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Otras habilidades no listadas...">{{ form.otras_habilidades.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Notas -->
                    <div class="odoo-tab-panel" id="tab-notas">
                        <div class="odoo-field odoo-field-full">
                            <label class="odoo-label">Notas pastorales</label>
                            <textarea name="notas" id="{{ form.notas.id_for_label }}"
                                      rows="6" class="odoo-textarea"
                                      placeholder="Observaciones internas sobre el miembro (visible solo para el equipo autorizado)...">{{ form.notas.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════════════════════════════════
             PANEL LATERAL (Chatter / Acciones)
             ══════════════════════════════════════════════════════════════════ -->
        <div class="odoo-form-aside">
            
            <!-- Botones de acción -->
            <div class="odoo-aside-actions">
                {% if modo == "editar" %}
                    <button type="submit" class="odoo-btn odoo-btn-primary">
                        <span class="material-icons">save</span>
                        Guardar cambios
                    </button>
                {% else %}
                    <button type="submit" name="guardar" value="1" class="odoo-btn odoo-btn-primary">
                        <span class="material-icons">check</span>
                        Guardar
                    </button>
                    <button type="submit" name="guardar_y_nuevo" value="1" class="odoo-btn odoo-btn-secondary">
                        <span class="material-icons">add</span>
                        Guardar y nuevo
                    </button>
                {% endif %}
            </div>

            <!-- Info rápida -->
            <div class="odoo-aside-info">
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Edad</span>
                    <span class="odoo-info-value" id="id_edad_display">—</span>
                </div>
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Categoría</span>
                    <span class="odoo-info-badge" id="id_categoria_edad_display">—</span>
                </div>
            </div>

            <!-- Consejos rápidos -->
            <div class="odoo-aside-tips">
                <h4 class="odoo-aside-title">Consejos</h4>
                <ul class="odoo-tips-list">
                    <li>Revisa la pestaña <strong>Membresía</strong> para fechas importantes.</li>
                    <li>En <strong>Emergencia</strong>, añade contacto y condiciones médicas.</li>
                    <li>Usa <strong>Notas</strong> para observaciones pastorales.</li>
                </ul>
            </div>

            <!-- Actividad reciente -->
            <div class="odoo-aside-activity">
                <h4 class="odoo-aside-title">Actividad</h4>
                {% if modo == "editar" and miembro %}
                <div class="odoo-activity-item">
                    <div class="odoo-activity-avatar">
                        <span class="material-icons">person</span>
                    </div>
                    <div class="odoo-activity-content">
                        <span class="odoo-activity-text">Registro creado</span>
                        <span class="odoo-activity-date">{{ miembro.fecha_creacion|date:"d M Y" }}</span>
                    </div>
                </div>
                {% else %}
                <div class="odoo-activity-item">
                    <div class="odoo-activity-avatar">
                        <span class="material-icons">add_circle</span>
                    </div>
                    <div class="odoo-activity-content">
                        <span class="odoo-activity-text">Creando nuevo registro...</span>
                        <span class="odoo-activity-date">Ahora</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<!-- ══════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════ -->
<style>

/* ═══════════════════════════════════════════════════════════════════════════
   RESET Y BASE - Estilo Odoo
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form {
    background: #fff;
    min-height: calc(100vh - 60px);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BARRA DE CONTROL SUPERIOR
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 100;
}

.odoo-control-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.odoo-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #017e84;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
}

.odoo-breadcrumb-link:hover {
    text-decoration: underline;
}

.odoo-breadcrumb-link .material-icons {
    font-size: 18px;
}

.odoo-breadcrumb-sep {
    color: #6c757d;
}

.odoo-breadcrumb-current {
    color: #495057;
    font-size: 14px;
}

.odoo-new-badge {
    background: #017e84;
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 3px;
    margin-left: 8px;
}

.odoo-member-code {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
    color: #6c757d;
    background: #e9ecef;
    padding: 4px 10px;
    border-radius: 4px;
}

.odoo-member-code .material-icons {
    font-size: 16px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTENEDOR PRINCIPAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-container {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 0;
    min-height: calc(100vh - 110px);
}

.odoo-form-main {
    padding: 24px 32px;
    border-right: 1px solid #dee2e6;
}

/* ═══════════════════════════════════════════════════════════════════════════
   HEADER DEL FORMULARIO (Avatar + Nombre)
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-header {
    display: flex;
    gap: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 24px;
}

.odoo-avatar-section {
    flex-shrink: 0;
}

.odoo-avatar {
    width: 110px;
    height: 110px;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.odoo-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.odoo-avatar .material-icons {
    font-size: 56px;
    color: #017e84;
    opacity: 0.6;
}

.odoo-avatar-upload {
    margin-top: 8px;
}

.odoo-avatar-upload input[type="file"] {
    font-size: 11px;
    width: 110px;
}

.odoo-header-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Radio group (Masculino/Femenino) */
.odoo-radio-group {
    display: flex;
    gap: 16px;
}

.odoo-radio {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 13px;
    color: #495057;
}

.odoo-radio input[type="radio"] {
    accent-color: #017e84;
}

/* Campo de nombre grande */
.odoo-name-field {
    display: flex;
    gap: 12px;
}

.odoo-name-input {
    flex: 1;
    font-size: 28px;
    font-weight: 400;
    color: #212529;
    border: none;
    border-bottom: 1px solid transparent;
    background: #fff0f3;
    padding: 8px 12px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.odoo-name-input:hover {
    background: #ffe4e9;
}

.odoo-name-input:focus {
    outline: none;
    background: #fff;
    border-bottom-color: #017e84;
}

.odoo-name-input::placeholder {
    color: #adb5bd;
    font-weight: 300;
}

/* Campos de contacto rápido */
.odoo-quick-fields {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
}

.odoo-quick-field {
    display: flex;
    align-items: center;
    gap: 8px;
}

.odoo-quick-field .material-icons {
    font-size: 18px;
    color: #6c757d;
    width: 20px;
}

.odoo-quick-field input {
    flex: 1;
    max-width: 280px;
    border: none;
    border-bottom: 1px dashed #dee2e6;
    padding: 4px 0;
    font-size: 14px;
    color: #495057;
    background: transparent;
}

.odoo-quick-field input:hover {
    border-bottom-color: #adb5bd;
}

.odoo-quick-field input:focus {
    outline: none;
    border-bottom: 1px solid #017e84;
}

.odoo-quick-field input::placeholder {
    color: #adb5bd;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BODY DEL FORMULARIO (Dos columnas)
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px 48px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 24px;
}

.odoo-form-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Campos estilo Odoo */
.odoo-field {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.odoo-field-group {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.odoo-label {
    width: 120px;
    flex-shrink: 0;
    font-size: 13px;
    color: #495057;
    padding-top: 6px;
    text-align: right;
}

.odoo-input {
    flex: 1;
    border: none;
    border-bottom: 1px solid #dee2e6;
    padding: 6px 0;
    font-size: 14px;
    color: #212529;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-input:hover {
    border-bottom-color: #adb5bd;
}

.odoo-input:focus {
    outline: none;
    border-bottom-color: #017e84;
}

.odoo-input::placeholder {
    color: #adb5bd;
}

.odoo-input-small {
    max-width: 80px;
}

select.odoo-input {
    cursor: pointer;
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3e%3cpath fill='%236c757d' d='M6 8L1 3h10z'/%3e%3c/svg%3e") no-repeat right center;
    padding-right: 20px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

/* Stack de campos (para dirección) */
.odoo-field-stack {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.odoo-field-row {
    display: flex;
    gap: 12px;
}

/* Checkbox */
.odoo-field-checkbox {
    padding-left: 132px;
}

.odoo-field-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-left: 132px;
}

.odoo-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 13px;
    color: #495057;
}

.odoo-checkbox-label input[type="checkbox"] {
    accent-color: #017e84;
    width: 16px;
    height: 16px;
}

/* Alertas */
.odoo-alert {
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 13px;
    margin: 8px 0;
}

.odoo-alert-warning {
    background: #fff7ed;
    color: #c2410c;
    border-left: 3px solid #f97316;
}

/* Field errors */
.odoo-field-error {
    color: #dc3545;
    font-size: 12px;
    padding-left: 132px;
    margin-top: -8px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   TABS
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-tabs-section {
    margin-top: 8px;
}

.odoo-tabs-bar {
    display: flex;
    gap: 0;
    border-bottom: 1px solid #dee2e6;
    flex-wrap: wrap;
}

.odoo-tab {
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
}

.odoo-tab:hover {
    color: #495057;
    background: #f8f9fa;
}

.odoo-tab.active {
    color: #017e84;
    border-bottom-color: #017e84;
}

.odoo-tabs-content {
    padding: 20px 0;
}

.odoo-tab-panel {
    display: none;
}

.odoo-tab-panel.active {
    display: block;
}

.odoo-tab-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 32px;
}

.odoo-field-full {
    grid-column: 1 / -1;
}

.odoo-textarea {
    width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s ease;
}

.odoo-textarea:focus {
    outline: none;
    border-color: #017e84;
}

/* Subsection */
.odoo-subsection {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px dashed #dee2e6;
}

.odoo-subsection-title {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 12px;
}

/* Tabla estilo Odoo */
.odoo-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 16px;
}

.odoo-table th {
    text-align: left;
    padding: 8px 12px;
    background: #f8f9fa;
    color: #495057;
    font-weight: 500;
    border-bottom: 1px solid #dee2e6;
}

.odoo-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e9ecef;
    color: #212529;
}

.odoo-table tr:hover td {
    background: #f8f9fa;
}

.odoo-link-danger {
    color: #dc3545;
    display: flex;
}

.odoo-link-danger .material-icons {
    font-size: 18px;
}

/* Add line */
.odoo-add-line {
    padding: 8px 0;
}

.odoo-add-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #017e84;
    font-size: 13px;
    text-decoration: none;
}

.odoo-add-link:hover {
    text-decoration: underline;
}

.odoo-add-link .material-icons {
    font-size: 18px;
}

.odoo-inline-form {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 4px;
    margin-top: 12px;
}

.odoo-btn-link {
    background: none;
    border: none;
    color: #017e84;
    font-size: 13px;
    cursor: pointer;
    padding: 0;
}

.odoo-btn-link:hover {
    text-decoration: underline;
}

.odoo-empty-text {
    color: #6c757d;
    font-size: 13px;
    font-style: italic;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PANEL LATERAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-aside {
    background: #f8f9fa;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.odoo-aside-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.odoo-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.odoo-btn .material-icons {
    font-size: 18px;
}

.odoo-btn-primary {
    background: #017e84;
    color: white;
}

.odoo-btn-primary:hover {
    background: #016166;
}

.odoo-btn-secondary {
    background: white;
    color: #495057;
    border: 1px solid #dee2e6;
}

.odoo-btn-secondary:hover {
    background: #e9ecef;
}

/* Info lateral */
.odoo-aside-info {
    background: white;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.odoo-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.odoo-info-label {
    font-size: 12px;
    color: #6c757d;
}

.odoo-info-value {
    font-size: 14px;
    font-weight: 600;
    color: #212529;
}

.odoo-info-badge {
    font-size: 11px;
    font-weight: 500;
    background: #d4edda;
    color: #155724;
    padding: 2px 8px;
    border-radius: 10px;
}

/* Tips */
.odoo-aside-tips {
    background: white;
    border-radius: 4px;
    padding: 12px;
}

.odoo-aside-title {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.odoo-tips-list {
    margin: 0;
    padding-left: 16px;
    font-size: 12px;
    color: #6c757d;
    line-height: 1.6;
}

.odoo-tips-list li {
    margin-bottom: 4px;
}

/* Actividad */
.odoo-aside-activity {
    background: white;
    border-radius: 4px;
    padding: 12px;
}

.odoo-activity-item {
    display: flex;
    gap: 10px;
}

.odoo-activity-avatar {
    width: 32px;
    height: 32px;
    background: #017e84;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.odoo-activity-avatar .material-icons {
    font-size: 18px;
    color: white;
}

.odoo-activity-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.odoo-activity-text {
    font-size: 13px;
    color: #212529;
}

.odoo-activity-date {
    font-size: 11px;
    color: #6c757d;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════ */
@media (max-width: 1200px) {
    .odoo-form-container {
        grid-template-columns: 1fr;
    }
    
    .odoo-form-main {
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
    
    .odoo-form-aside {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .odoo-aside-actions {
        flex-direction: row;
    }
    
    .odoo-aside-info,
    .odoo-aside-tips,
    .odoo-aside-activity {
        flex: 1;
        min-width: 200px;
    }
}

@media (max-width: 768px) {
    .odoo-form-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .odoo-name-field {
        flex-direction: column;
    }
    
    .odoo-form-body {
        grid-template-columns: 1fr;
    }
    
    .odoo-field,
    .odoo-field-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .odoo-label {
        width: auto;
        text-align: left;
        padding-top: 0;
        margin-bottom: 4px;
    }
    
    .odoo-field-checkbox,
    .odoo-field-checkboxes {
        padding-left: 0;
    }
    
    .odoo-field-error {
        padding-left: 0;
    }
    
    .odoo-tab-grid {
        grid-template-columns: 1fr;
    }
    /* Separador de sección limpio (texto azulado/gris) */
.odoo-separator {
    display: block;
    color: #017e84;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 4px;
    width: 100%;
}

/* Enlace "Agregar línea" */
.odoo-add-line {
    padding: 10px 0;
}

.odoo-add-link {
    color: #017e84;
    text-decoration: none;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: color 0.2s;
}

.odoo-add-link:hover {
    color: #015c61;
    text-decoration: underline;
}

/* Caja de edición inline (Fondo gris suave, sin bordes pesados) */
.odoo-inline-edit-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 16px;
    margin-top: 10px;
    margin-bottom: 20px;
    /* Sin border-radius exagerado, Odoo es bastante cuadrado */
    border-radius: 2px; 
}

.odoo-inline-title {
    margin: 0 0 16px 0;
    font-size: 14px;
    color: #495057;
    font-weight: 600;
}

/* Botones pequeños para acciones inline */
.odoo-btn-sm {
    padding: 4px 12px;
    font-size: 12px;
    height: 30px;
}

/* Ajuste para el select múltiple visual */
#id_familiar option {
    padding: 4px;
    cursor: pointer;
}
#id_familiar option:hover {
    background-color: #e9ecef;
}
}/* ================================
   AUTOCOMPLETE – ESTILO INGRESO
   ================================ */

.autocomplete-wrapper {
    position: relative;
    width: 100%;
}

.autocomplete-field {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
}

.autocomplete-search {
    width: 100%;
}

.autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
    z-index: 1000;
}

.autocomplete-list {
    list-style: none;
    margin: 0;
    padding: 6px;
    max-height: 260px;
    overflow-y: auto;
}

.autocomplete-item {
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
}

.autocomplete-item:hover {
    background: #f3f4f6;
}

.autocomplete-item-main {
    display: flex;
    justify-content: space-between;
    font-weight: 500;
}

.autocomplete-item-codigo {
    font-size: 11px;
    color: #6b7280;
}

.autocomplete-item-meta {
    margin-top: 2px;
    font-size: 11px;
    color: #9ca3af;
}

.autocomplete-loading,
.autocomplete-empty {
    padding: 14px;
    font-size: 13px;
    color: #6b7280;
    text-align: center;
}

/* Selección (tarjeta) */
.autocomplete-selected {
    margin-top: 6px;
    padding: 8px 10px;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px dashed #d1d5db;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
}

.autocomplete-selected .selected-name {
    font-weight: 600;
}

.autocomplete-selected .selected-codigo {
    font-size: 11px;
    color: #6b7280;
}

.autocomplete-selected .selected-remove {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    color: #9ca3af;
}

.autocomplete-selected .selected-remove:hover {
    color: #ef4444;
}

</style>

<!-- ══════════════════════════════════════════════════════════════════════════
     SCRIPTS
     ══════════════════════════════════════════════════════════════════════════ -->

<!-- Variable de edad mínima desde Django -->
<script>
    const EDAD_MINIMA_MIEMBRO_OFICIAL = {{ EDAD_MINIMA_MIEMBRO_OFICIAL }};
</script>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// FUNCIONALIDAD DE TABS
// ═══════════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.odoo-tab');
    const panels = document.querySelectorAll('.odoo-tab-panel');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = 'tab-' + this.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        });
    });
    
    // Check URL params for tab
    const params = new URLSearchParams(window.location.search);
    const tabParam = params.get('tab');
    if (tabParam) {
        const targetTab = document.querySelector(`[data-tab="${tabParam}"]`);
        if (targetTab) targetTab.click();
    }
});

// Toggle familiar form
function toggleFamiliarForm() {
    const form = document.getElementById('familiar-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// ═══════════════════════════════════════════════════════════════════════════
// CÁLCULO DE EDAD Y CATEGORÍA
// ═══════════════════════════════════════════════════════════════════════════
function calcularEdadDesdeFecha(fechaStr) {
    if (!fechaStr) return null;

    const partes = fechaStr.split("-");
    if (partes.length !== 3) return null;

    const anio = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10);
    const dia = parseInt(partes[2], 10);

    if (isNaN(anio) || isNaN(mes) || isNaN(dia)) return null;

    const nacimiento = new Date(anio, mes - 1, dia);
    const hoy = new Date();

    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mesDiff = hoy.getMonth() - nacimiento.getMonth();

    if (mesDiff < 0 || (mesDiff === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }

    return edad >= 0 ? edad : null;
}

function obtenerCategoriaEdad(edad) {
    if (edad === null) return "—";

    if (edad <= 5)  return "Infante";
    if (edad <= 11) return "Niño";
    if (edad <= 17) return "Adolescente";
    if (edad <= 30) return "Joven";
    if (edad <= 59) return "Adulto";
    return "Adulto mayor";
}

function actualizarEdadYCategoria() {
    const inputFecha       = document.getElementById('id_fecha_nacimiento');
    const edadDisplay      = document.getElementById('id_edad_display');
    const categoriaDisplay = document.getElementById('id_categoria_edad_display');
    const avisoEdad        = document.getElementById('edad_aviso');

    if (!inputFecha || !edadDisplay || !categoriaDisplay) return;

    const valor = inputFecha.value;

    if (!valor) {
        edadDisplay.textContent = "—";
        categoriaDisplay.textContent = "—";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    const edad = calcularEdadDesdeFecha(valor);

    if (edad === null) {
        edadDisplay.textContent = "—";
        categoriaDisplay.textContent = "—";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    // Actualizar displays
    edadDisplay.textContent = edad + " años";
    categoriaDisplay.textContent = obtenerCategoriaEdad(edad);

    // Mostrar/ocultar aviso según edad mínima
    if (avisoEdad) {
        avisoEdad.style.display = edad < EDAD_MINIMA_MIEMBRO_OFICIAL ? "block" : "none";
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE BAUTISMO SEGÚN EDAD Y ESTADO
// ═══════════════════════════════════════════════════════════════════════════
function actualizarBautismoPorEstadoYEdad() {
    const inputFecha = document.getElementById('id_fecha_nacimiento');
    const estadoSelect = document.getElementById('id_estado_miembro');
    const bautizadoCheckbox = document.getElementById('id_bautizado_confirmado');

    if (!bautizadoCheckbox) return;

    const edad = inputFecha ? calcularEdadDesdeFecha(inputFecha.value) : null;
    const estado = estadoSelect ? estadoSelect.value : "";
    const EDAD_MIN_BAUTISMO = EDAD_MINIMA_MIEMBRO_OFICIAL;

    // Por defecto dejamos que el usuario pueda marcar/desmarcar
    bautizadoCheckbox.disabled = false;

    // Si es menor que la edad mínima -> nunca bautizado confirmado
    if (edad !== null && edad < EDAD_MIN_BAUTISMO) {
        bautizadoCheckbox.checked = false;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Catecúmeno nunca se marca como bautizado
    if (estado === "catecumeno") {
        bautizadoCheckbox.checked = false;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Estados pastorales oficiales -> siempre bautizados
    const estadosBautizados = ["activo", "pasivo", "observacion", "disciplina", "descarriado"];
    if (estadosBautizados.includes(estado)) {
        bautizadoCheckbox.checked = true;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Otros estados futuros -> libre
    bautizadoCheckbox.disabled = false;
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE TRASLADO / IGLESIA ANTERIOR
// ═══════════════════════════════════════════════════════════════════════════
function actualizarIglesiaAnterior() {
    const trasladoCheckbox = document.getElementById('id_es_trasladado');
    const iglesiaAnteriorInput = document.getElementById('id_iglesia_anterior');

    if (!iglesiaAnteriorInput || !trasladoCheckbox) return;

    if (trasladoCheckbox.checked) {
        iglesiaAnteriorInput.removeAttribute('disabled');
        iglesiaAnteriorInput.removeAttribute('readonly');
    } else {
        iglesiaAnteriorInput.value = '';
        iglesiaAnteriorInput.setAttribute('disabled', 'disabled');
        iglesiaAnteriorInput.setAttribute('readonly', 'readonly');
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE MIEMBRO ACTIVO / BLOQUE DE SALIDA
// ═══════════════════════════════════════════════════════════════════════════
function actualizarBloqueSalida() {
    const chkActivo = document.getElementById('id_activo');
    const bloqueSalida = document.getElementById('bloque-salida-miembro');

    if (!chkActivo || !bloqueSalida) return;

    bloqueSalida.style.display = chkActivo.checked ? 'none' : 'block';
}

// ═══════════════════════════════════════════════════════════════════════════
// FORMATO DE CÉDULA DOMINICANA
// ═══════════════════════════════════════════════════════════════════════════
function formatearCedula(valor) {
    let soloDigitos = valor.replace(/\D/g, '').slice(0, 11);

    if (soloDigitos.length <= 3) return soloDigitos;
    if (soloDigitos.length <= 10) {
        return soloDigitos.slice(0, 3) + '-' + soloDigitos.slice(3);
    }
    return soloDigitos.slice(0, 3) + '-' + soloDigitos.slice(3, 10) + '-' + soloDigitos.slice(10);
}

// ═══════════════════════════════════════════════════════════════════════════
// FILTRO DE BÚSQUEDA DE FAMILIARES
// ═══════════════════════════════════════════════════════════════════════════
function setupFamiliarSearch() {
    const searchInput = document.getElementById('familiar_search');
    const selectList = document.getElementById('id_familiar');

    if (searchInput && selectList) {
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();

            for (let i = 0; i < selectList.options.length; i++) {
                const option = selectList.options[i];
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(filter) ? "" : "none";
            }
        });
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// INICIALIZACIÓN AL CARGAR LA PÁGINA
// ═══════════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar edad y categoría
    actualizarEdadYCategoria();
    
    // Eventos de fecha de nacimiento
    const inputFecha = document.getElementById('id_fecha_nacimiento');
    if (inputFecha) {
        inputFecha.addEventListener('change', function() {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
        inputFecha.addEventListener('input', function() {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
    }

    // Eventos de estado del miembro
    const estadoSelect = document.getElementById('id_estado_miembro');
    if (estadoSelect) {
        estadoSelect.addEventListener('change', actualizarBautismoPorEstadoYEdad);
    }

    // Inicializar bautismo
    actualizarBautismoPorEstadoYEdad();

    // Eventos de traslado
    const trasladoCheckbox = document.getElementById('id_es_trasladado');
    if (trasladoCheckbox) {
        trasladoCheckbox.addEventListener('change', actualizarIglesiaAnterior);
        actualizarIglesiaAnterior();
    }

    // Eventos de miembro activo
    const chkActivo = document.getElementById('id_activo');
    if (chkActivo) {
        chkActivo.addEventListener('change', actualizarBloqueSalida);
        actualizarBloqueSalida();
    }

    // Formato de cédula
    const cedulaInput = document.getElementById('id_cedula');
    if (cedulaInput) {
        if (cedulaInput.value) {
            cedulaInput.value = formatearCedula(cedulaInput.value);
        }
        cedulaInput.addEventListener('input', function() {
            this.value = formatearCedula(this.value);
        });
    }

    // Búsqueda de familiares
    setupFamiliarSearch();
});
</script>
{% load static %}
<script src="{% static 'core/js/autocomplete-miembro.js' %}"></script>


{% endblock %}