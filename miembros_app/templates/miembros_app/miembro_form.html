{% extends 'core/base_modulo.html' %}

{% block title %}
    {% if modo == "editar" and miembro %}
        Editar miembro ¬∑ Soid_Tf_2
    {% else %}
        Agregar miembro ¬∑ Soid_Tf_2
    {% endif %}
{% endblock %}

{% block breadcrumb %}
Miembros /
{% if modo == "editar" %}
    Editar
{% else %}
    Crear
{% endif %}
{% endblock %}

{% block content %}

<section class="page-header">
    <div>
        {% if modo == "editar" %}
            <h1 class="page-title">Editar miembro</h1>
            <p class="page-subtitle">
                Actualiza la informaci√≥n del miembro. Revisa con calma cada pesta√±a.
            </p>
        {% else %}
            <h1 class="page-title">Nuevo miembro</h1>
            <p class="page-subtitle">
                Registra los datos completos del miembro para mantener la informaci√≥n organizada.
            </p>
        {% endif %}
    </div>

    <div class="page-header-actions">
        <a href="{% url 'miembros_app:lista' %}" class="btn-secondary">
            <span class="material-icons">arrow_back</span>
            Volver a la lista
        </a>
    </div>
</section>

<section class="member-create-wrapper">
    <div class="member-card">

        <!-- ENCABEZADO DEL FORMULARIO -->
        <div class="member-card-header">
            <div>
                <h2>Ficha de registro</h2>
                <p class="member-card-subtitle">
                    Revisa con calma cada pesta√±a. Los campos marcados con <span class="required">*</span> son obligatorios.
                </p>
            </div>
            <div class="member-status-pill">
                <span class="status-dot"></span>
                {% if modo == "editar" and miembro %}
                    Editando: {{ miembro.nombres }} {{ miembro.apellidos }}
                {% else %}
                    Nuevo registro
                {% endif %}
            </div>
        </div>

        <!-- FORMULARIO -->
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {# BLOQUE RESUMEN DE ERRORES (A√ëADIDO) #}
            {% if form.errors %}
                <div class="form-error-summary">
                    <h4>Hay errores en el formulario</h4>
                    <p>Revisa los campos marcados en rojo. Ning√∫n cambio se ha guardado.</p>
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- BANNER C√ìDIGO DE MIEMBRO (SIEMPRE VISIBLE) -->
            <div class="member-code-banner">
                <div class="member-code-main">
                    <span class="material-icons member-code-icon">qr_code_2</span>
                    <span class="member-code-text">
                        {% if form.codigo_miembro_display.value %}
                            {{ form.codigo_miembro_display.value }}
                        {% else %}
                            {{ form.codigo_miembro_display.initial }}
                        {% endif %}
                    </span>
                </div>
                <div class="member-code-sub">
                    {% if modo == "editar" and miembro %}
                        C√≥digo interno del miembro (no editable).
                    {% else %}
                        C√≥digo que se asignar√° a este nuevo miembro al guardar.
                    {% endif %}
                </div>
            </div>

            <!-- BARRA DE TABS -->
            <div class="tabs-bar">
                <button type="button" class="tab-btn active" onclick="openTab('personal', this)">
                    Informaci√≥n personal
                </button>
                <button type="button" class="tab-btn" onclick="openTab('contacto', this)">
                    Contacto
                </button>
                <button type="button" class="tab-btn" onclick="openTab('membresia', this)">
                    Membres√≠a
                </button>
                <button type="button" class="tab-btn" onclick="openTab('emergencia', this)">
                    Emergencia y salud
                </button>
                <button type="button" class="tab-btn" onclick="openTab('trabajo', this)">
                    Trabajo
                </button>
                

                <!-- NUEVA PESTA√ëA: FAMILIARES -->
                <button type="button" class="tab-btn" onclick="openTab('familiares', this)">
                    Familiares
                </button>

                <button type="button" class="tab-btn" onclick="openTab('intereses', this)">
                    Intereses y habilidades
                </button>
                <button type="button" class="tab-btn" onclick="openTab('notas', this)">
                    Notas
                </button>
            </div>


            <div class="member-layout">
                <!-- CONTENIDO DE TABS -->
                <div class="member-main">

                    <!-- ========== PESTA√ëA: INFORMACI√ìN PERSONAL ========== -->
                    <div id="personal" class="tab-content" style="display: block;">
                        <h3 class="tab-title">Informaci√≥n personal</h3>
                        <p class="tab-description">
                            Datos b√°sicos de identidad del miembro.
                        </p>

                        <div class="form-grid">
                            <!-- Foto destacada a la izquierda -->
                            <div class="form-field form-field-full member-photo-field">
                                <label>Foto</label>
                                <div class="member-photo-wrapper">
                                    <div class="member-photo-preview">
                                        {% if miembro and miembro.foto %}
                                            <img src="{{ miembro.foto.url }}" alt="Foto del miembro">
                                        {% else %}
                                            <span class="material-icons member-photo-icon">person</span>
                                        {% endif %}
                                    </div>

                                    <div class="member-photo-input">
                                        {{ form.foto }}

                                        <p class="help-text">
                                            Formatos permitidos: JPG, PNG. Tama√±o recomendado 500x500 px.
                                        </p>
                                    </div>
                                </div>
                            </div>


                            <div class="form-field">
                                <label for="{{ form.nombres.id_for_label }}">Nombres <span class="required">*</span></label>
                                {{ form.nombres }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.apellidos.id_for_label }}">Apellidos <span class="required">*</span></label>
                                {{ form.apellidos }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.genero.id_for_label }}">G√©nero</label>
                                {{ form.genero }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.fecha_nacimiento.id_for_label }}">Fecha de nacimiento</label>
                                {{ form.fecha_nacimiento }}
                                <div id="edad_aviso" 
                                style="display:none; margin-top:6px; padding:10px; border-radius:6px;
                                        background:#fff7ed; color:#c2410c; font-size:13px;">
                                ‚ö†Ô∏è ‚ö†Ô∏è Esta registando a un miembro menor de {{ EDAD_MINIMA_MIEMBRO_OFICIAL }} a√±os.

                                <br>
                                <strong>Por lo tanto no sera consierado en la lista Oficial.</strong>
                            </div>

                                {# ERRORES ESPEC√çFICOS DE FECHA DE NACIMIENTO (A√ëADIDO) #}
                                {% if form.fecha_nacimiento.errors %}
                                    <div class="field-error">
                                        {% for error in form.fecha_nacimiento.errors %}
                                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}

                               
                            </div>

                            <div class="form-field">
                                <label>Edad</label>
                                <div class="info-pill">
                                    <span class="info-pill-value" id="id_edad_display">‚Äî</span>
                                    <span class="info-pill-label">a√±os</span>
                                </div>
                                <small class="field-help">Se calcula seg√∫n la fecha de nacimiento.</small>
                            </div>

                            <div class="form-field">
                                <label>Categor√≠a de edad</label>
                                <span class="badge badge-green" id="id_categoria_edad_display">‚Äî</span>
                                <small class="field-help">Infante, ni√±o, adolescente, joven, etc.</small>
                            </div>

                            <div class="form-field">
                                <label for="{{ form.lugar_nacimiento.id_for_label }}">Lugar de nacimiento</label>
                                {{ form.lugar_nacimiento }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.nacionalidad.id_for_label }}">Nacionalidad</label>
                                {{ form.nacionalidad }}
                            </div>
                       <!-- üëá NUEVOS CAMPOS DE IDENTIDAD -->
                            <div class="form-field">
                                <label for="{{ form.cedula.id_for_label }}">C√©dula</label>
                                {{ form.cedula }}
                                <small class="field-help">
                                    Formato: 000-0000000-0
                                </small>
                            </div>

                            <div class="form-field">
                                <label for="{{ form.pasaporte.id_for_label }}">Pasaporte</label>
                                {{ form.pasaporte }}
                                <small class="field-help">
                                    Solo si aplica.
                                </small>
                            </div>

                            <div class="form-field">
                                <label for="{{ form.estado_civil.id_for_label }}">Estado civil</label>
                                {{ form.estado_civil }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.nivel_educativo.id_for_label }}">Nivel educativo</label>
                                {{ form.nivel_educativo }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.profesion.id_for_label }}">Profesi√≥n</label>
                                {{ form.profesion }}
                            </div>
                        </div>
                    </div>

                    <!-- ========== PESTA√ëA: CONTACTO ========== -->
                    <div id="contacto" class="tab-content">
                        <h3 class="tab-title">Contacto</h3>
                        <p class="tab-description">
                            Informaci√≥n de contacto y direcci√≥n.
                        </p>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="{{ form.telefono.id_for_label }}">Tel√©fono principal</label>
                                {{ form.telefono }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.telefono_secundario.id_for_label }}">Tel√©fono secundario</label>
                                {{ form.telefono_secundario }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.whatsapp.id_for_label }}">WhatsApp</label>
                                {{ form.whatsapp }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.email.id_for_label }}">Correo electr√≥nico</label>
                                {{ form.email }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.direccion.id_for_label }}">Direcci√≥n</label>
                                {{ form.direccion }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.sector.id_for_label }}">Sector / Barrio</label>
                                {{ form.sector }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.ciudad.id_for_label }}">Ciudad</label>
                                {{ form.ciudad }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.provincia.id_for_label }}">Provincia</label>
                                {{ form.provincia }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.codigo_postal.id_for_label }}">C√≥digo postal</label>
                                {{ form.codigo_postal }}
                            </div>
                        </div>
                    </div>
<!-- ========== PESTA√ëA: MEMBRES√çA ========== -->
                                        <!-- ========== PESTA√ëA: MEMBRES√çA ========== -->
                    <div id="membresia" class="tab-content">
                        <h3 class="tab-title">Membres√≠a</h3>
                        <p class="tab-description">
                            Estado espiritual y datos de ingreso del miembro en la iglesia.
                        </p>

                        <div class="form-grid">

                            <!-- Estado + Bautizado en l√≠nea -->
                            <div class="form-field form-field-full">
                                <label for="{{ form.estado_miembro.id_for_label }}">Estado del miembro</label>
                                <div class="field-inline">
                                    <div class="field-inline-main">
                                        {{ form.estado_miembro }}
                                    </div>
                                    <label class="field-inline-side" for="{{ form.bautizado_confirmado.id_for_label }}">
                                        {{ form.bautizado_confirmado }}
                                        Bautizado confirmado
                                    </label>
                                </div>
                            </div>

                            <!-- Fecha ingreso + traslado -->
                            <div class="form-field">
                                <label for="{{ form.fecha_ingreso_iglesia.id_for_label }}">Fecha de ingreso a la iglesia</label>
                                {{ form.fecha_ingreso_iglesia }}

                                {% if form.fecha_ingreso_iglesia.errors %}
                                <div class="field-error">
                                    {% for error in form.fecha_ingreso_iglesia.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-field">
                                <label class="checkbox-label" for="{{ form.es_trasladado.id_for_label }}">
                                    {{ form.es_trasladado }}
                                    Viene de otra iglesia
                                </label>
                                <small class="field-help">
                                    Marca esta opci√≥n si el miembro llega trasladado de otra iglesia.
                                </small>
                            </div>

                            <!-- Iglesia anterior normal (no full width) -->
                            <div class="form-field">
                                <label for="{{ form.iglesia_anterior.id_for_label }}">Iglesia anterior</label>
                                {{ form.iglesia_anterior }}
                            </div>

                            <!-- Fechas espirituales -->
                            <div class="form-field">
                                <label for="{{ form.fecha_conversion.id_for_label }}">Fecha de conversi√≥n</label>
                                {{ form.fecha_conversion }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.fecha_bautismo.id_for_label }}">Fecha de bautismo</label>
                                {{ form.fecha_bautismo }}
                            </div>

                            <!-- Miembro activo (abajo) -->
                            <div class="form-field form-field-full">
                                <label class="checkbox-label" for="{{ form.activo.id_for_label }}">
                                    {{ form.activo }}
                                    Miembro activo
                                </label>
                                <p class="field-help">
                                    Si desmarcas esta casilla, el miembro dejar√° de aparecer en la lista oficial.
                                    Podr√°s indicar el motivo y la fecha de salida.
                                </p>
                            </div>

                            <!-- Bloque de salida: se muestra solo cuando "Miembro activo" est√° desmarcado -->
                            <div id="bloque-salida-miembro" class="form-field form-field-full" style="display: none;">
                                <h4 class="tab-subtitle">Informaci√≥n de salida</h4>
                                <p class="field-help">
                                    Estos datos se usan para llevar estad√≠sticas de cu√°ntos miembros se van y por qu√©.
                                </p>

                                <div class="form-grid">
                                    <!-- Raz√≥n de salida -->
                                    <div class="form-field">
                                        <label for="{{ form.razon_salida.id_for_label }}">Raz√≥n de salida</label>
                                        {{ form.razon_salida }}

                                        {% if form.razon_salida.errors %}
                                        <div class="field-error">
                                            {% for error in form.razon_salida.errors %}
                                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Fecha de salida -->
                                    <div class="form-field">
                                        <label for="{{ form.fecha_salida.id_for_label }}">Fecha de salida</label>
                                        {{ form.fecha_salida }}

                                        {% if form.fecha_salida.errors %}
                                        <div class="field-error">
                                            {% for error in form.fecha_salida.errors %}
                                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <p class="field-help">
                                            Si no indicas una fecha, se usar√° la fecha actual autom√°ticamente.
                                        </p>
                                    </div>

                                    <!-- Comentario de salida -->
                                    <div class="form-field form-field-full">
                                        <label for="{{ form.comentario_salida.id_for_label }}">Comentario</label>
                                        {{ form.comentario_salida }}

                                        {% if form.comentario_salida.errors %}
                                        <div class="field-error">
                                            {% for error in form.comentario_salida.errors %}
                                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <p class="field-help">
                                            Opcional. Puedes a√±adir detalles breves (ej: se mud√≥ de ciudad, cambio de trabajo, etc.).
                                        </p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- ========== PESTA√ëA: EMERGENCIA Y SALUD ========== -->
                    <div id="emergencia" class="tab-content">
                        <h3 class="tab-title">Emergencia y salud</h3>
                        <p class="tab-description">
                            Datos importantes para contacto de emergencia y condiciones m√©dicas relevantes.
                        </p>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="{{ form.contacto_emergencia_nombre.id_for_label }}">Nombre contacto de emergencia</label>
                                {{ form.contacto_emergencia_nombre }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.contacto_emergencia_telefono.id_for_label }}">Tel√©fono de emergencia</label>
                                {{ form.contacto_emergencia_telefono }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.contacto_emergencia_relacion.id_for_label }}">Relaci√≥n</label>
                                {{ form.contacto_emergencia_relacion }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.tipo_sangre.id_for_label }}">Tipo de sangre</label>
                                {{ form.tipo_sangre }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.alergias.id_for_label }}">Alergias</label>
                                {{ form.alergias }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.condiciones_medicas.id_for_label }}">Condiciones m√©dicas</label>
                                {{ form.condiciones_medicas }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.medicamentos.id_for_label }}">Medicamentos</label>
                                {{ form.medicamentos }}
                            </div>
                        </div>
                    </div>

                    <!-- ========== PESTA√ëA: TRABAJO ========== -->
                    <div id="trabajo" class="tab-content">
                        <h3 class="tab-title">Trabajo</h3>
                        <p class="tab-description">
                            Informaci√≥n laboral del miembro.
                        </p>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="{{ form.empleador.id_for_label }}">Empleador</label>
                                {{ form.empleador }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.puesto.id_for_label }}">Puesto</label>
                                {{ form.puesto }}
                            </div>

                            <div class="form-field">
                                <label for="{{ form.telefono_trabajo.id_for_label }}">Tel√©fono del trabajo</label>
                                {{ form.telefono_trabajo }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.direccion_trabajo.id_for_label }}">Direcci√≥n del trabajo</label>
                                {{ form.direccion_trabajo }}
                            </div>
                        </div>
                    </div>
                    
                                          <!-- ========== PESTA√ëA: FAMILIARES ========== -->
                    <div id="familiares" class="tab-content">
                        <h3 class="tab-title">Familiares</h3>
                        <p class="tab-description">
                            Asigna familiares a este miembro usando la lista de miembros registrados.
                        </p>

                        {% if modo == "editar" and miembro %}
                            <!-- Tabla de familiares ya asignados -->
                            {% if familiares %}
                                <div class="form-grid">
                                    <div class="form-field form-field-full">
                                        <table class="table-familiares">
                                            <thead>
                                            <tr>
                                                <th>Familiar</th>
                                                <th>Relaci√≥n</th>
                                                <th>Vive en casa</th>
                                                <th>Responsable</th>
                                                <th>Acciones</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for rel in familiares %}
                                                <tr>
                                                    <td>{{ rel.familiar.nombres }} {{ rel.familiar.apellidos }}</td>
                                                    <td>{{ rel.get_tipo_relacion_display }}</td>
                                                    <td>{% if rel.vive_junto %}S√≠{% else %}No{% endif %}</td>
                                                    <td>{% if rel.es_responsable %}S√≠{% else %}No{% endif %}</td>
                                                    <td>
                                                        <a href="{% url 'miembros_app:eliminar_familiar' rel.pk %}"
                                                        class="btn-secondary"
                                                        style="padding:2px 8px; font-size:11px;"
                                                        onclick="return confirm('¬øSeguro que quieres quitar este familiar?')">
                                                            Quitar
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            {% else %}
                                <p class="tab-helper">Este miembro a√∫n no tiene familiares asignados.</p>
                            {% endif %}
                     

                            <hr class="divider">

                            <!-- Formulario para agregar un nuevo familiar (MISMO FORMULARIO GENERAL) -->
                            <h4 class="tab-subtitle">Agregar familiar desde la lista de miembros</h4>
                            <p class="tab-description">
                                Selecciona un miembro ya registrado y define la relaci√≥n familiar.
                            </p>

                            <div class="familia-form">
                                <div class="form-grid">
                                    <div class="form-field">
                                        <label for="familiar_search">Miembro familiar <span class="required">*</span></label>

                                        <!-- Buscador para filtrar la lista -->
                                        <input type="text"
                                               id="familiar_search"
                                               class="input"
                                               placeholder="Escribe para buscar por nombre o apellido...">

                                        <small class="field-help">
                                            Escribe parte del nombre o apellido para filtrar la lista.
                                        </small>

                                        <select name="familiar" id="id_familiar" class="input" size="6" style="margin-top: 6px;">
                                            <option value="">Seleccione un miembro</option>
                                            {% for m in todos_miembros %}
                                                {% if m.pk != miembro.pk %}
                                                    <option value="{{ m.pk }}">
                                                        {{ m.nombres }} {{ m.apellidos }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label for="id_tipo_relacion">Relaci√≥n <span class="required">*</span></label>
                                        <select name="tipo_relacion" id="id_tipo_relacion" class="input">
                                        <option value="">Seleccione relaci√≥n</option>

                                        <option value="padre">Padre</option>
                                        <option value="madre">Madre</option>

                                        <!-- Valor 'hijo' (el modelo entiende Hijo/a) -->
                                        <option value="hijo">Hijo / Hija</option>

                                        <!-- Valor 'hermano' (el modelo entiende Hermano/a) -->
                                        <option value="hermano">Hermano / Hermana</option>

                                        <option value="conyuge">C√≥nyuge</option>

                                        <!-- Todo lo dem√°s entra como 'otro' -->
                                        <option value="otro">Abuelo / Abuela</option>
                                        <option value="otro">Tutor / Encargado</option>
                                        <option value="otro">Otro familiar</option>
                                    </select>

                                    </div>

                                    <div class="form-field">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="vive_junto" class="checkbox">
                                            Vive en la misma casa
                                        </label>

                                        <label class="checkbox-label">
                                            <input type="checkbox" name="es_responsable" class="checkbox">
                                            Responsable principal
                                        </label>

                                        <small class="field-help">
                                            Marca <strong>Responsable principal</strong> solo cuando este familiar es
                                            el adulto o encargado principal del hogar (por ejemplo: padre, madre o tutor
                                            de los menores que viven en la casa).
                                        </small>
                                    </div>


                                    <div class="form-field form-field-full">
                                        <label for="id_notas_familiar">Notas</label>
                                        <textarea name="notas" id="id_notas_familiar" rows="2" class="textarea"
                                                  placeholder="Notas breves sobre esta relaci√≥n familiar (opcional)"></textarea>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <!-- IMPORTANTE: este name es lo que usaremos en la vista -->
                                    <button type="submit" name="agregar_familiar" value="1" class="btn-secondary" style="margin-top:8px;">
                                        + Agregar familiar
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <p>
                                Guarda primero el miembro para poder gestionar sus familiares.
                            </p>
                        {% endif %}
                    </div>



                    <!-- ========== PESTA√ëA: INTERESES ========== -->
                    <div id="intereses" class="tab-content">
                        <h3 class="tab-title">Intereses y habilidades</h3>
                        <p class="tab-description">
                            √Åreas donde el miembro podr√≠a servir o involucrarse.
                        </p>

                        <div class="form-grid">
                            <div class="form-field form-field-full">
                                <label for="{{ form.intereses.id_for_label }}">Intereses</label>
                                {{ form.intereses }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.otros_intereses.id_for_label }}">Otros intereses</label>
                                {{ form.otros_intereses }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.habilidades.id_for_label }}">Habilidades</label>
                                {{ form.habilidades }}
                            </div>

                            <div class="form-field form-field-full">
                                <label for="{{ form.otras_habilidades.id_for_label }}">Otras habilidades</label>
                                {{ form.otras_habilidades }}
                            </div>
                        </div>
                    </div>

                    <!-- ========== PESTA√ëA: NOTAS ========== -->
                    <div id="notas" class="tab-content">
                        <h3 class="tab-title">Notas pastorales</h3>
                        <p class="tab-description">
                            Observaciones internas sobre el miembro (visible solo para el equipo autorizado).
                        </p>

                        <div class="form-grid">
                            <div class="form-field form-field-full">
                                <label for="{{ form.notas.id_for_label }}">Notas</label>
                                {{ form.notas }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ASIDE / AYUDA -->
                <aside class="member-aside">
                    <div class="aside-card">
                        <h4>Consejos r√°pidos</h4>
                        <ul>
                            <li>Revisa primero la pesta√±a de <strong>Informaci√≥n personal</strong>.</li>
                            <li>En <strong>Emergencia y salud</strong>, a√±ade todo lo que pueda ser √∫til.</li>
                            <li>En <strong>Membres√≠a</strong>, verifica bien fechas y estado.</li>
                        </ul>
                    </div>
                    <div class="aside-card">
                        <h4>Acciones</h4>
                        <p class="member-card-subtitle">
                            Cuando termines de revisar las pesta√±as, guarda los cambios.
                        </p>

                        {% if modo == "editar" %}
                            <!-- MODO EDITAR: un solo bot√≥n -->
                            <button type="submit"
                                    class="btn-primary"
                                    style="width:100%; justify-content:center;">
                                <span class="material-icons">save</span>
                                Guardar cambios
                            </button>
                        {% else %}
                            <!-- MODO CREAR: dos botones -->

                            <!-- Bot√≥n GUARDAR (va a la lista) -->
                            <button type="submit"
                                    name="guardar"
                                    value="1"
                                    class="btn-primary"
                                    style="width:100%; justify-content:center; margin-bottom:8px;">
                                <span class="material-icons">check</span>
                                Guardar
                            </button>

                            <!-- Bot√≥n GUARDAR Y NUEVO (vuelve al formulario limpio) -->
                            <button type="submit"
                                    name="guardar_y_nuevo"
                                    value="1"
                                    class="btn-secondary"
                                    style="width:100%; justify-content:center;">
                                <span class="material-icons">add</span>
                                Guardar y nuevo
                            </button>
                        {% endif %}
                    </div>

                </aside>
            </div>
        </form>
    </div>
</section>
<script>
    const EDAD_MINIMA_MIEMBRO_OFICIAL = {{ EDAD_MINIMA_MIEMBRO_OFICIAL }};
</script>

<script>
function openTab(tabName, btn) {
    // Ocultar todas las tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');

    // Quitar 'active' de todos los botones
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

    // Mostrar la tab seleccionada
    const tab = document.getElementById(tabName);
    if (tab) {
        tab.style.display = 'block';
    }

    // Activar el bot√≥n actual
    if (btn) {
        btn.classList.add('active');
    }
}

// =========================
// C√°lculo de edad y categor√≠a en el navegador
// =========================

function calcularEdadDesdeFecha(fechaStr) {
    if (!fechaStr) return null;

    const partes = fechaStr.split("-");
    if (partes.length !== 3) return null;

    const anio = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10);
    const dia = parseInt(partes[2], 10);

    if (isNaN(anio) || isNaN(mes) || isNaN(dia)) return null;

    const nacimiento = new Date(anio, mes - 1, dia);
    const hoy = new Date();

    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mesDiff = hoy.getMonth() - nacimiento.getMonth();

    if (mesDiff < 0 || (mesDiff === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }

    return edad >= 0 ? edad : null;
}

function obtenerCategoriaEdad(edad) {
    if (edad === null) return "‚Äî";

    if (edad <= 5)  return "Infante";
    if (edad <= 11) return "Ni√±o";
    if (edad <= 17) return "Adolescente";
    if (edad <= 30) return "Joven";
    if (edad <= 59) return "Adulto";
    return "Adulto mayor";
}



function actualizarEdadYCategoria() {
    const inputFecha       = document.getElementById('id_fecha_nacimiento');
    const edadDisplay      = document.getElementById('id_edad_display');
    const categoriaDisplay = document.getElementById('id_categoria_edad_display');
    const avisoEdad        = document.getElementById('edad_aviso');

    if (!inputFecha || !edadDisplay || !categoriaDisplay) return;

    const valor = inputFecha.value;

    if (!valor) {
        edadDisplay.textContent = "‚Äî";
        categoriaDisplay.textContent = "‚Äî";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    const edad = calcularEdadDesdeFecha(valor);

    if (edad === null) {
        edadDisplay.textContent = "‚Äî";
        categoriaDisplay.textContent = "‚Äî";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    // Actualizar badges
    edadDisplay.textContent = edad;  // ‚Üê solo el n√∫mero
    categoriaDisplay.textContent = obtenerCategoriaEdad(edad);

    // Mostrar/ocultar aviso seg√∫n edad m√≠nima configurable
    if (avisoEdad) {
        if (edad < EDAD_MINIMA_MIEMBRO_OFICIAL) {
            avisoEdad.style.display = "block";
        } else {
            avisoEdad.style.display = "none";
        }
    }
}


document.addEventListener('DOMContentLoaded', function() {
    actualizarEdadYCategoria();
    const inputFecha = document.getElementById('id_fecha_nacimiento');
    if (inputFecha) {
        inputFecha.addEventListener('change', function () {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
        inputFecha.addEventListener('input', function () {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
    }

    // L√≥gica adicional: bautismo seg√∫n edad y estado
    const estadoSelect = document.getElementById('id_estado_miembro');
    const bautizadoCheckbox = document.getElementById('id_bautizado_confirmado');

    function actualizarBautismoPorEstadoYEdad() {
        if (!bautizadoCheckbox) return;

        const edad = inputFecha ? calcularEdadDesdeFecha(inputFecha.value) : null;
        const estado = estadoSelect ? estadoSelect.value : "";
        const EDAD_MIN_BAUTISMO = EDAD_MINIMA_MIEMBRO_OFICIAL;


        // Por defecto dejamos que el usuario pueda marcar/desmarcar
        bautizadoCheckbox.disabled = false;

        // Si es menor que la edad m√≠nima -> nunca bautizado confirmado
        if (edad !== null && edad < EDAD_MIN_BAUTISMO) {
            bautizadoCheckbox.checked = false;
            bautizadoCheckbox.disabled = true;
            return;
        }

        // Catec√∫meno nunca se marca como bautizado
        if (estado === "catecumeno") {
            bautizadoCheckbox.checked = false;
            bautizadoCheckbox.disabled = true;
            return;
        }

        // Estados pastorales oficiales -> siempre bautizados
        const estadosBautizados = ["activo", "pasivo", "observacion", "disciplina", "descarriado"];
        if (estadosBautizados.includes(estado)) {
            bautizadoCheckbox.checked = true;
            bautizadoCheckbox.disabled = true;
            return;
        }

        // Otros estados futuros -> libre
        bautizadoCheckbox.disabled = false;
    }

    if (estadoSelect) {
        estadoSelect.addEventListener('change', actualizarBautismoPorEstadoYEdad);
    }

    // Ejecutar una vez al cargar la p√°gina
    actualizarBautismoPorEstadoYEdad();

    // -------- L√≥gica de traslado / iglesia anterior ----------
    const trasladoCheckbox = document.getElementById('id_es_trasladado');
    const iglesiaAnteriorInput = document.getElementById('id_iglesia_anterior');

    function actualizarIglesiaAnterior() {
        if (!iglesiaAnteriorInput || !trasladoCheckbox) return;

        if (trasladoCheckbox.checked) {
            iglesiaAnteriorInput.removeAttribute('disabled');
            iglesiaAnteriorInput.removeAttribute('readonly');
        } else {
            iglesiaAnteriorInput.value = '';
            iglesiaAnteriorInput.setAttribute('disabled', 'disabled');
            iglesiaAnteriorInput.setAttribute('readonly', 'readonly');
        }
    }

    if (trasladoCheckbox) {
        trasladoCheckbox.addEventListener('change', actualizarIglesiaAnterior);
        // Ejecutar una vez al cargar para dejar el estado correcto
        actualizarIglesiaAnterior();
    }
});

</script>

<style>
    .member-create-wrapper {
        margin-top: 10px;
    }

    .member-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 18px 18px 20px;
        box-shadow: 0 10px 25px rgba(15,23,42,0.08);
        border: 1px solid #e5e7eb;
    }

    .member-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .member-card-header h2 {
        margin: 0;
        font-size: 18px;
        color: #111827;
    }

    .member-card-subtitle {
        margin: 4px 0 0;
        font-size: 12px;
        color: #6b7280;
    }

    .member-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
        white-space: nowrap;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
    }

    .required {
        color: #dc2626;
    }

    .tabs-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        background: #f3f4f6;
        padding: 6px;
        border-radius: 999px;
        margin-bottom: 16px;
    }

    .tab-btn {
        border: none;
        background: transparent;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        color: #4b5563;
        display: inline-flex;
        align-items: center;
    }

    .tab-btn.active {
        background: #ffffff;
        color: #111827;
        box-shadow: 0 2px 6px rgba(15,23,42,0.12);
    }

    .member-layout {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(220px, 1.2fr);
        gap: 18px;
        align-items: flex-start;
    }

    .tab-title {
        margin: 0 0 4px;
        font-size: 15px;
        color: #111827;
    }

    .tab-description {
        margin: 0 0 12px;
        font-size: 12px;
        color: #6b7280;
    }

    .member-photo-field label {
        margin-bottom: 6px;
    }

    .member-photo-wrapper {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .member-photo-preview {
        width: 70px;
        height: 70px;
        border-radius: 999px;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
    }

    .member-photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .member-photo-icon {
        font-size: 32px;
        color: #6b7280;
    }

    .member-photo-input input[type="file"] {
        font-size: 12px;
    }

    .help-text {
        margin: 4px 0 0;
        font-size: 11px;
        color: #6b7280;
    }

    .member-aside {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .aside-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 10px;
        font-size: 12px;
        color: #4b5563;
    }

    .aside-card h4 {
        margin: 0 0 6px;
        font-size: 13px;
        color: #111827;
    }

    .aside-card ul {
        padding-left: 18px;
        margin: 0;
    }

    .aside-card ul li {
        margin-bottom: 4px;
    }

    .tab-content {
        display: none;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .member-layout {
            grid-template-columns: 1fr;
        }

        .member-aside {
            flex-direction: column-reverse;
        }

        .tabs-bar {
            border-radius: 12px;
        }

        .member-card-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
    .badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
    }

    .badge-blue {
        background-color: #dbeafe;   /* azul suave */
        color: #1e3a8a;               /* azul oscuro */
    }

    .badge-green {
        background-color: #dcfce7;   /* verde suave */
        color: #166534;               /* verde oscuro */
    }

    .badge-yellow {
        background-color: #fef9c3;   /* amarillo suave */
        color: #854d0e;
    }

    .badge-red {
        background-color: #fee2e2;   /* rojo suave */
        color: #991b1b;
    }

    /* CLASES NUEVAS PARA ERRORES */
    .form-error-summary {
        margin-bottom: 14px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 13px;
    }

    .form-error-summary h4 {
        margin: 0 0 4px;
        font-size: 14px;
        font-weight: 600;
    }

    .form-error-summary p {
        margin: 0 0 4px;
    }

    .form-error-summary ul {
        margin: 4px 0 0;
        padding-left: 18px;
    }

    .form-error-summary li {
        margin-bottom: 2px;
    }

    .field-error {
        margin-top: 4px;
        font-size: 12px;
        color: #b91c1c;
    }
#familiar_search {
    font-size: 12px;
}

#id_familiar {
    font-size: 12px;
    max-height: 180px;
}
    .field-inline {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .field-inline-main {
        flex: 1;
    }

    .field-inline-side {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        white-space: nowrap;
    }


/* ============================
   Icono "Reemplazar foto" (üîÑ)
   y ocultar ruta tipo miembros_fotos/...
   ============================ */

/* Contenedor que genera Django para el campo de archivo */
.member-photo-input .clearable-file-input {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 0; /* Oculta textos como "Actualmente:" y "Cambiar:" */
}

/* Ocultar el enlace con el nombre/ruta del archivo */
.member-photo-input .clearable-file-input a {
    display: none !important;
}

/* Input de archivo (para seleccionar nueva foto) */
.member-photo-input .clearable-file-input input[type="file"] {
    font-size: 11px;
}

/* Ocultamos el checkbox real de borrar */
.member-photo-input .clearable-file-input input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    pointer-events: none;
}

/* Bot√≥n sutil con icono de "reemplazar" üîÑ */
.member-photo-input .clearable-file-input label {
    width: 24px;
    height: 24px;
    border-radius: 999px;
    background: #f3f4f6;           /* gris suave */
    border: 1px solid #d1d5db;     /* borde gris */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    margin-top: 3px;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
}

/* Icono üîÑ dentro del circulito */
.member-photo-input .clearable-file-input label::before {
    content: "‚ü≥";                  /* icono tipo "reemplazar" / refresh */
    font-size: 13px;
    color: #4b5563;                /* gris medio, discreto */
}

/* Hover elegante, sutil */
.member-photo-input .clearable-file-input label:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
    transform: translateY(-1px);
}




</style>
<style>
.member-code-banner {
    margin: 12px 0 16px 0;
    padding: 10px 14px;
    border-radius: 8px;
    background: #f1f5f9;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.member-code-main {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
}

.member-code-icon {
    font-size: 20px;
}

.member-code-text {
    font-family: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    letter-spacing: 0.04em;
}

.member-code-sub {
    font-size: 12px;
    color: #64748b;
    margin-left: 28px;
}
</style>

<script>
// ===============================================
//  FUNCIONES PARA MANEJO DE PESTA√ëAS EN EL FORM
// ===============================================

// Abre una pesta√±a y activa su bot√≥n
function openTab(tabName, btn) {
    // Ocultar todas las tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Quitar "active" de todos los botones
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
    });

    // Mostrar la tab seleccionada
    const tab = document.getElementById(tabName);
    if (tab) {
        tab.style.display = 'block';
    }

    // Si tenemos bot√≥n, activar directamente
    if (btn) {
        btn.classList.add('active');
    } else {
        // Si no hay bot√≥n (por ejemplo, al usar ?tab=familiares)
        // buscamos el bot√≥n que corresponde al nombre del tab
        document.querySelectorAll('.tab-btn').forEach(b => {
            const onclick = b.getAttribute('onclick') || "";
            if (onclick.includes("'" + tabName + "'")) {
                b.classList.add('active');
            }
        });
    }
}

// =======================================================
//  Mantener activa la pesta√±a al regresar de un redirect
// =======================================================
document.addEventListener('DOMContentLoaded', function () {
    const params = new URLSearchParams(window.location.search);
    const tab = params.get('tab');

    // Si tenemos ?tab=familiares, ?tab=intereses, etc.
    if (tab) {
        openTab(tab, null); 
    }
});

// =======================================================
//  FILTRO DEL BUSCADOR PARA LA LISTA DE FAMILIARES
// =======================================================
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('familiar_search');
    const selectList = document.getElementById('id_familiar');

    if (searchInput && selectList) {
        searchInput.addEventListener('input', function () {
            const filter = this.value.toLowerCase();

            // Recorremos todas las opciones del <select>
            for (let i = 0; i < selectList.options.length; i++) {
                const option = selectList.options[i];
                const text = option.textContent.toLowerCase();

                // Filtrar si coincide con el texto
                option.style.display = text.includes(filter) ? "" : "none";
            }
        });
    }
});
// =======================================================
//  MOSTRAR / OCULTAR CAMPOS DE SALIDA SEG√öN "Miembro activo"
// =======================================================
document.addEventListener('DOMContentLoaded', () => {
    const chkActivo = document.getElementById('id_activo');
    const bloqueSalida = document.getElementById('bloque-salida-miembro');

    function actualizarBloqueSalida() {
        if (!chkActivo || !bloqueSalida) return;

        // Si el checkbox est√° desmarcado, mostramos el bloque
        if (chkActivo.checked) {
            bloqueSalida.style.display = 'none';
        } else {
            bloqueSalida.style.display = '';
        }
    }

    if (chkActivo && bloqueSalida) {
        // Estado inicial (por si se est√° editando un miembro ya dado de baja)
        actualizarBloqueSalida();

        // Cuando el usuario cambia el checkbox
        chkActivo.addEventListener('change', actualizarBloqueSalida);
    }
});

</script>

<script>
// ============================
// FORMATEO DE C√âDULA DOMINICANA
// ============================
document.addEventListener('DOMContentLoaded', function () {
    const cedulaInput = document.getElementById('id_cedula');
    if (!cedulaInput) return;

    function formatearCedula(valor) {
        // 1) Quitar todo lo que no sea d√≠gito
        let soloDigitos = valor.replace(/\D/g, '');

        // 2) Limitar a 11 d√≠gitos (formato oficial)
        soloDigitos = soloDigitos.slice(0, 11);

        // 3) Reconstruir con guiones: 000-0000000-0
        if (soloDigitos.length <= 3) {
            return soloDigitos;
        } else if (soloDigitos.length <= 10) {
            return soloDigitos.slice(0, 3) + '-' + soloDigitos.slice(3);
        } else {
            return (
                soloDigitos.slice(0, 3) +
                '-' +
                soloDigitos.slice(3, 10) +
                '-' +
                soloDigitos.slice(10)
            );
        }
    }

    // Formatear el valor inicial (por si viene de la BD)
    if (cedulaInput.value) {
        cedulaInput.value = formatearCedula(cedulaInput.value);
    }

    // Re-formatear cada vez que el usuario escribe
    cedulaInput.addEventListener('input', function () {
        const valorFormateado = formatearCedula(cedulaInput.value);
        cedulaInput.value = valorFormateado;
    });
});
</script>



{% endblock %}
