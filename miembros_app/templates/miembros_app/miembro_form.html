{% extends 'miembros_app/base_miembros.html' %}
{% load static %}

{% block title %}
    {% if modo == "editar" and miembro %}
        {{ miembro.nombres }} {{ miembro.apellidos }} · Miembros
    {% else %}
        Nuevo miembro · Miembros
    {% endif %}
{% endblock %}

{% block miembros_content %}

<form method="post" enctype="multipart/form-data" class="odoo-form">
    {% csrf_token %}

    {% if form.errors %}
  <div class="odoo-alert odoo-alert-danger">
    <strong>⚠️ Por favor corrige los siguientes errores:</strong>
    <ul>
      {% for field in form %}
        {% for error in field.errors %}
          <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if bloquear_identidad %}
  <div class="odoo-alert odoo-alert-warning" style="margin-bottom: 16px;">
    ⚠️ <strong>Algunos campos están bloqueados</strong> porque este miembro
    está asignado a una o más unidades.
    <br>
    Para poder modificarlos, primero debes retirarlo de sus unidades.
  </div>
{% endif %}


    <!-- ══════════════════════════════════════════════════════════════════
         BARRA SUPERIOR (Control Bar)
         ══════════════════════════════════════════════════════════════════ -->
    <div class="odoo-control-bar">
        <div class="odoo-control-left">
            <a href="{% url 'miembros_app:lista' %}" class="odoo-breadcrumb-link">
                <span class="material-icons">arrow_back</span>
                Miembros
            </a>
            <span class="odoo-breadcrumb-sep">/</span>
            <span class="odoo-breadcrumb-current">
                {% if modo == "editar" %}Editar{% else %}Nuevo{% endif %}
            </span>
            
            {% if not modo == "editar" %}
            <span class="odoo-new-badge">Nuevo</span>
            {% endif %}
        </div>
        
        <div class="odoo-control-right">
            <div class="odoo-member-code">
                <span class="material-icons">qr_code_2</span>
                {% if form.codigo_miembro_display.value %}
                    {{ form.codigo_miembro_display.value }}
                {% else %}
                    {{ form.codigo_miembro_display.initial }}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════
         CONTENIDO PRINCIPAL
         ══════════════════════════════════════════════════════════════════ -->
    <div class="odoo-form-container">
        
        <!-- ÁREA PRINCIPAL DEL FORMULARIO -->
        <div class="odoo-form-main">
            
            <!-- ─────────────────────────────────────────────────────────
                 HEADER: Foto + Nombre + Campos principales
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-form-header">
                
                <!-- Foto del miembro -->
                <div class="odoo-avatar-section">
                    <div class="odoo-avatar">
                        {% if miembro and miembro.foto %}
                            <img src="{{ miembro.foto.url }}" alt="Foto">
                        {% else %}
                            <span class="material-icons">person</span>
                        {% endif %}
                    </div>
                    <div class="odoo-avatar-upload">
                        <input
                            type="file"
                            name="foto"
                            id="id_foto"
                            accept="image/*"
                        >
                    </div>

                </div>

                <!-- Info principal -->
                <div class="odoo-header-info">
                    
                    <!-- Radio: Género -->
                <label class="odoo-radio">
                <input type="radio" name="genero" value="masculino"
                        {% if form.genero.value == 'masculino' %}checked{% endif %}
                        {% if bloquear_identidad %}disabled{% endif %}>
                <span>Masculino</span>
                </label>

                <label class="odoo-radio">
                <input type="radio" name="genero" value="femenino"
                        {% if form.genero.value == 'femenino' %}checked{% endif %}
                        {% if bloquear_identidad %}disabled{% endif %}>
                <span>Femenino</span>
                </label>

                {% if bloquear_identidad %}
                <input type="hidden" name="genero" value="{{ miembro.genero }}">
                {% endif %}






                    <!-- Nombre grande -->
                    <div class="odoo-name-field">
                        <input type="text" 
                               name="nombres" 
                               id="{{ form.nombres.id_for_label }}"
                               value="{{ form.nombres.value|default:'' }}"
                               placeholder="Nombres"
                               class="odoo-name-input"
                               required>
                        <input type="text" 
                               name="apellidos" 
                               id="{{ form.apellidos.id_for_label }}"
                               value="{{ form.apellidos.value|default:'' }}"
                               placeholder="Apellidos"
                               class="odoo-name-input"
                               required>
                    </div>

                    <!-- Campos de contacto rápido -->
                    <div class="odoo-quick-fields">
                        <div class="odoo-quick-field">
                            <span class="material-icons">email</span>
                            <input type="email" 
                                   name="email" 
                                   id="{{ form.email.id_for_label }}"
                                   value="{{ form.email.value|default:'' }}"
                                   placeholder="Correo electrónico">
                        </div>
                        <div class="odoo-quick-field">
                            <span class="material-icons">phone</span>
                            <input type="tel" 
                                   name="telefono" 
                                   id="{{ form.telefono.id_for_label }}"
                                   value="{{ form.telefono.value|default:'' }}"
                                   placeholder="Teléfono">
                        </div>
                        <div class="field-error" id="telefono-error" style="display:none;">
    Este número de teléfono ya está registrado.
</div>

                        <div class="odoo-quick-field">
                            <span class="material-icons">chat</span>
                            <input type="tel" 
                                   name="whatsapp" 
                                   id="{{ form.whatsapp.id_for_label }}"
                                   value="{{ form.whatsapp.value|default:'' }}"
                                   placeholder="WhatsApp">
                        </div>
                        <div class="hint">
                        Escribe solo números (sin guiones). Ej: 8091234567 o +18091234567
                        </div>
                    </div>
                </div>
            </div>

            <!-- ─────────────────────────────────────────────────────────
                 BODY: Campos en dos columnas estilo Odoo
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-form-body">
                
                <!-- Columna Izquierda -->
                <div class="odoo-form-column">
                    
                    <div class="odoo-field-group">
                        <label class="odoo-label">Dirección</label>
                        <div class="odoo-field-stack">
                            <input type="text" name="direccion" 
                                   id="{{ form.direccion.id_for_label }}"
                                   value="{{ form.direccion.value|default:'' }}"
                                   placeholder="Calle..." class="odoo-input">
<div class="odoo-field">
    <label class="odoo-label">Sector</label>

    {% with current=form.sector.value|default_if_none:'' %}
    <select id="id_sector" name="sector" class="odoo-input odoo-select">
        <option value="">Selecciona tu sector</option>

        <option value="21 de Enero" {% if current == "21 de Enero" %}selected{% endif %}>21 de Enero</option>
        <option value="30 de Mayo" {% if current == "30 de Mayo" %}selected{% endif %}>30 de Mayo</option>
        <option value="Ana Melia" {% if current == "Ana Melia" %}selected{% endif %}>Ana Melia</option>
        <option value="Anamuya" {% if current == "Anamuya" %}selected{% endif %}>Anamuya</option>
        <option value="Antonio Guzmán" {% if current == "Antonio Guzmán" %}selected{% endif %}>Antonio Guzmán</option>
        <option value="Brisas del Duey" {% if current == "Brisas del Duey" %}selected{% endif %}>Brisas del Duey</option>
        <option value="Cristo Rey" {% if current == "Cristo Rey" %}selected{% endif %}>Cristo Rey</option>
        <option value="Don Celso" {% if current == "Don Celso" %}selected{% endif %}>Don Celso</option>
        <option value="Duarte" {% if current == "Duarte" %}selected{% endif %}>Duarte</option>
        <option value="Juan Pablo Duarte" {% if current == "Juan Pablo Duarte" %}selected{% endif %}>Juan Pablo Duarte</option>
        <option value="El Bonao" {% if current == "El Bonao" %}selected{% endif %}>El Bonao</option>
        <option value="El Centro" {% if current == "El Centro" %}selected{% endif %}>El Centro</option>
        <option value="El Chorro" {% if current == "El Chorro" %}selected{% endif %}>El Chorro</option>
        <option value="El Macao" {% if current == "El Macao" %}selected{% endif %}>El Macao</option>
        <option value="El Obispado" {% if current == "El Obispado" %}selected{% endif %}>El Obispado</option>
        <option value="El Tamarindo" {% if current == "El Tamarindo" %}selected{% endif %}>El Tamarindo</option>
        <option value="La Altagracia" {% if current == "La Altagracia" %}selected{% endif %}>La Altagracia</option>
        <option value="La Aviación" {% if current == "La Aviación" %}selected{% endif %}>La Aviación</option>
        <option value="La Cabrera" {% if current == "La Cabrera" %}selected{% endif %}>La Cabrera</option>
        <option value="La Candelaria" {% if current == "La Candelaria" %}selected{% endif %}>La Candelaria</option>
        <option value="La Ceiba del Salado" {% if current == "La Ceiba del Salado" %}selected{% endif %}>La Ceiba del Salado</option>
        <option value="La Colonia" {% if current == "La Colonia" %}selected{% endif %}>La Colonia</option>
        <option value="La Cruz" {% if current == "La Cruz" %}selected{% endif %}>La Cruz</option>
        <option value="La Fe" {% if current == "La Fe" %}selected{% endif %}>La Fe</option>
        <option value="La Laguna" {% if current == "La Laguna" %}selected{% endif %}>La Laguna</option>
        <option value="La Malena" {% if current == "La Malena" %}selected{% endif %}>La Malena</option>
        <option value="La Mina" {% if current == "La Mina" %}selected{% endif %}>La Mina</option>
        <option value="La Otra Banda" {% if current == "La Otra Banda" %}selected{% endif %}>La Otra Banda</option>
        <option value="Las Caobas" {% if current == "Las Caobas" %}selected{% endif %}>Las Caobas</option>
        <option value="Las Flores" {% if current == "Las Flores" %}selected{% endif %}>Las Flores</option>
        <option value="Las Mercedes" {% if current == "Las Mercedes" %}selected{% endif %}>Las Mercedes</option>
        <option value="Los Platanitos" {% if current == "Los Platanitos" %}selected{% endif %}>Los Platanitos</option>
        <option value="Los Ríos" {% if current == "Los Ríos" %}selected{% endif %}>Los Ríos</option>
        <option value="Los Sotos" {% if current == "Los Sotos" %}selected{% endif %}>Los Sotos</option>
        <option value="Luisa Perla" {% if current == "Luisa Perla" %}selected{% endif %}>Luisa Perla</option>
        <option value="Mamá Tingó" {% if current == "Mamá Tingó" %}selected{% endif %}>Mamá Tingó</option>
        <option value="Nazaret" {% if current == "Nazaret" %}selected{% endif %}>Nazaret</option>
        <option value="San Francisco" {% if current == "San Francisco" %}selected{% endif %}>San Francisco</option>
        <option value="San José" {% if current == "San José" %}selected{% endif %}>San José</option>
        <option value="San Martín" {% if current == "San Martín" %}selected{% endif %}>San Martín</option>
        <option value="San Pedro" {% if current == "San Pedro" %}selected{% endif %}>San Pedro</option>
        <option value="Santa Cruz" {% if current == "Santa Cruz" %}selected{% endif %}>Santa Cruz</option>
        <option value="Santana" {% if current == "Santana" %}selected{% endif %}>Santana</option>
        <option value="Savica" {% if current == "Savica" %}selected{% endif %}>Savica</option>
        <option value="Villa Cerro" {% if current == "Villa Cerro" %}selected{% endif %}>Villa Cerro</option>
        <option value="Villa Hortensia" {% if current == "Villa Hortensia" %}selected{% endif %}>Villa Hortensia</option>
        <option value="Villa María" {% if current == "Villa María" %}selected{% endif %}>Villa María</option>
        <option value="Villa Palmera" {% if current == "Villa Palmera" %}selected{% endif %}>Villa Palmera</option>
        <option value="Villa Progreso" {% if current == "Villa Progreso" %}selected{% endif %}>Villa Progreso</option>
        <option value="Yuma" {% if current == "Yuma" %}selected{% endif %}>Yuma</option>

        <option value="Otro" {% if current == "Otro" %}selected{% endif %}>Otro / No aparece en la lista</option>
    </select>
    {% endwith %}

    {% if form.sector.errors %}
        <div class="odoo-error">{{ form.sector.errors|striptags }}</div>
    {% endif %}
</div>

                            <div class="odoo-field-row">
                                <input type="text" name="ciudad" 
                                       id="{{ form.ciudad.id_for_label }}"
                                       value="{{ form.ciudad.value|default:'' }}"
                                       placeholder="Ciudad" class="odoo-input">
                                <input type="text" name="provincia" 
                                       id="{{ form.provincia.id_for_label }}"
                                       value="{{ form.provincia.value|default:'' }}"
                                       placeholder="Provincia" class="odoo-input">
                                <input type="text" name="codigo_postal" 
                                       id="{{ form.codigo_postal.id_for_label }}"
                                       value="{{ form.codigo_postal.value|default:'' }}"
                                       placeholder="C.P." class="odoo-input odoo-input-small">
                            </div>
                                <div class="odoo-field">
                                    <label class="odoo-label">País</label>

                                    <input
                                        type="text"
                                        name="nacionalidad"
                                        id="{{ form.nacionalidad.id_for_label }}"
                                        class="odoo-input"
                                        placeholder="Escribe y selecciona (ej.: República Dominicana)"
                                        autocomplete="off"
                                        list="lista_paises"
                                        value="{% if form.nacionalidad.value %}{{ form.nacionalidad.value }}{% elif modo != 'editar' %}República Dominicana{% endif %}"
                                    >

                                    <datalist id="lista_paises">
                                        <option value="República Dominicana">
<option value="Estados Unidos">
<option value="España">
<option value="México">
<option value="Colombia">
<option value="Venezuela">
<option value="Puerto Rico">

<option value="Haiti"></option>

                                        {# Si tu form trae choices, los reutilizamos. Si no, al menos queda el input manual funcionando. #}
                                        {% for value, label in form.nacionalidad.field.choices %}
                                            {% if value %}
                                                <option value="{{ value }}">{{ label }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </datalist>

                                    
                                </div>

                        </div>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="odoo-form-column">
                    
                    <div class="odoo-field">
                        <label class="odoo-label">Cédula</label>
                        <input type="text" name="cedula" id="id_cedula"
                               value="{{ form.cedula.value|default:'' }}"
                               placeholder="000-0000000-0" class="odoo-input">
                    </div>
                    <div id="cedula_feedback" class="hint" style="margin-top:6px; display:none;"></div>


                    <div class="odoo-field">
                        <label class="odoo-label">Fecha nacimiento</label>
                        <input type="date"
                               name="fecha_nacimiento"
                               id="{{ form.fecha_nacimiento.id_for_label }}"
                               class="odoo-input"
                               value="{{ form.fecha_nacimiento.value|date:'Y-m-d' }}"
                               {% if bloquear_identidad %}disabled{% endif %}>
                        {% if bloquear_identidad %}
                        <input type="hidden" name="fecha_nacimiento" value="{{ form.fecha_nacimiento.value|date:'Y-m-d' }}">
                        {% endif %}
                    </div>


                    <!-- Aviso de edad mínima -->
                    <div id="edad_aviso" class="odoo-alert odoo-alert-warning" style="display:none;">
                        ⚠️ Estás registrando a un miembro menor de {{ EDAD_MINIMA_MIEMBRO_OFICIAL }} años.
                        <strong>No será considerado en la lista oficial.</strong>
                    </div>

                    {% if form.fecha_nacimiento.errors %}
                    <div class="odoo-field-error">
                        {% for error in form.fecha_nacimiento.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="odoo-field">
                        <label class="odoo-label">Estado civil</label>
                        <select name="estado_civil" id="{{ form.estado_civil.id_for_label }}" class="odoo-input">
                            {% for value, label in form.estado_civil.field.choices %}
                                <option value="{{ value }}" {% if form.estado_civil.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="odoo-field">
                        <label class="odoo-label">Estado miembro</label>
                        <select name="estado_miembro" id="id_estado_miembro" class="odoo-input"
                           {% if bloquear_estado %}disabled{% endif %}>

                            {% for value, label in form.estado_miembro.field.choices %}
                                <option value="{{ value }}" {% if form.estado_miembro.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                        {% if bloquear_estado %}
                {# Si está disabled, NO se envía en POST, así que lo preservamos #}
                <input type="hidden" name="estado_miembro" value="{{ form.estado_miembro.value|default:'' }}">


                {% endif %}


                    <div class="odoo-field odoo-field-checkbox">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="bautizado_confirmado" id="id_bautizado_confirmado"
                                   {% if form.bautizado_confirmado.value %}checked{% endif %}>
                            <span>Bautizado confirmado</span>
                        </label>
                    </div>

                    <div class="odoo-field odoo-field-checkbox">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="activo" id="id_activo"
                                   {% if form.activo.value %}checked{% endif %}>
                            <span>Miembro activo</span>
                        </label>
                    </div>

                    <!-- Fecha de ingreso (campo importante) -->
                    <div class="odoo-field">
                        <label class="odoo-label">Fecha ingreso</label>
                        {% if modo == "editar" %}
                        <input type="date"
                               id="{{ form.fecha_ingreso_iglesia.id_for_label }}"
                               class="odoo-input"
                               value="{{ form.fecha_ingreso_iglesia.value|date:'Y-m-d' }}"
                               readonly
                               style="background: #e9ecef; cursor: not-allowed;">
                        <input type="hidden"
                               name="fecha_ingreso_iglesia"
                               value="{{ form.fecha_ingreso_iglesia.value|date:'Y-m-d' }}">
                        {% else %}
                        <input type="date"
                               name="fecha_ingreso_iglesia"
                               id="{{ form.fecha_ingreso_iglesia.id_for_label }}"
                               class="odoo-input"
                               value="{% if form.fecha_ingreso_iglesia.value %}{{ form.fecha_ingreso_iglesia.value|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}">
                        {% endif %}
                    </div>
                    <div class="odoo-field-note">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                        {% if modo == "editar" %}
                        Esta fecha no se puede editar una vez guardada.
                        {% else %}
                        <strong>Importante:</strong> Esta fecha no se podrá editar después de guardar. Si no recuerda la fecha exacta, ponga una fecha aproximada.
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ─────────────────────────────────────────────────────────
                 TABS: Pestañas inferiores estilo Odoo
                 ───────────────────────────────────────────────────────── -->
            <div class="odoo-tabs-section">
                
                <!-- Tab buttons -->
                <div class="odoo-tabs-bar">
                    <button type="button" class="odoo-tab active" data-tab="personal">
                        Información personal
                    </button>
                    <button type="button" class="odoo-tab" data-tab="membresia">
                        Membresía
                    </button>
                    <button type="button" class="odoo-tab" data-tab="emergencia">
                        Emergencia
                    </button>
                    <button type="button" class="odoo-tab" data-tab="trabajo">
                        Trabajo
                    </button>
                    <button type="button" class="odoo-tab" data-tab="familiares">
                        Familiares
                    </button>
                    <button type="button" class="odoo-tab" data-tab="intereses">
                        Intereses
                    </button>
                    <button type="button" class="odoo-tab" data-tab="socioeconomico">
                        Socioeconómico
                    </button>

                    <button type="button" class="odoo-tab" data-tab="notas">
                        Notas
                    </button>
                    <button type="button" class="odoo-tab" data-tab="socioeconomico">
                        Socioeconómico
                    </button>

                </div>

                <!-- Tab contents -->
                <div class="odoo-tabs-content">
                    
                    <!-- TAB: Información Personal -->
                    <div class="odoo-tab-panel active" id="tab-personal">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Lugar nacimiento</label>
                                <input type="text" name="lugar_nacimiento" 
                                       id="{{ form.lugar_nacimiento.id_for_label }}"
                                       value="{{ form.lugar_nacimiento.value|default:'' }}"
                                       placeholder="Ciudad o país de nacimiento" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Pasaporte</label>
                                <input type="text" name="pasaporte" 
                                       id="{{ form.pasaporte.id_for_label }}"
                                       value="{{ form.pasaporte.value|default:'' }}"
                                       placeholder="Número de pasaporte" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Nivel educativo</label>
                                <select name="nivel_educativo" id="{{ form.nivel_educativo.id_for_label }}" class="odoo-input">
                                    {% for value, label in form.nivel_educativo.field.choices %}
                                        <option value="{{ value }}" {% if form.nivel_educativo.value == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Profesión</label>

                                <input type="text"
                                    name="profesion"
                                    id="{{ form.profesion.id_for_label }}"
                                    value="{{ form.profesion.value|default:'' }}"
                                    placeholder="Profesión u ocupación"
                                    class="odoo-input"
                                    list="profesion_list">

                                <datalist id="profesion_list">
                                    <option value="Empleado(a)"></option>
                                    <option value="Estudiante"></option>
                                    <option value="Independiente"></option>
                                    <option value="Ama de casa"></option>

                                    <option value="Maestro(a)"></option>
                                    <option value="Técnico(a)"></option>
                                    <option value="Ingeniero(a)"></option>
                                    <option value="Arquitecto(a)"></option>
                                    <option value="Doctor(a)"></option>
                                    <option value="Enfermero(a)"></option>
                                    <option value="Abogado(a)"></option>
                                    <option value="Contable"></option>
                                    <option value="Comerciante"></option>
                                    <option value="Pastor(a) / Ministro"></option>
                                    <option value="Militar / Policía"></option>
                                </datalist>
                            </div>

                            <div class="odoo-field">
                                <label class="odoo-label">Tel. secundario</label>
                                <input type="tel" name="telefono_secundario" 
                                       id="{{ form.telefono_secundario.id_for_label }}"
                                       value="{{ form.telefono_secundario.value|default:'' }}"
                                       placeholder="Teléfono alternativo" class="odoo-input">
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Membresía -->
                    <div class="odoo-tab-panel" id="tab-membresia">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Fecha conversión</label>
                                <input type="date" name="fecha_conversion"
                                    id="{{ form.fecha_conversion.id_for_label }}"
                                    value="{{ form.fecha_conversion.value|date:'Y-m-d' }}"
                                    class="odoo-input">
                            </div>

                            <div class="odoo-field">
                                <label class="odoo-label">Fecha bautismo</label>
                                <input type="date" name="fecha_bautismo"
                                    id="{{ form.fecha_bautismo.id_for_label }}"
                                    value="{{ form.fecha_bautismo.value|date:'Y-m-d' }}"
                                    class="odoo-input">
                            </div>
                            <div class="odoo-field odoo-field-checkbox">
                                <label class="odoo-checkbox-label">
                                    <input type="checkbox" name="es_trasladado" id="id_es_trasladado"
                                           {% if form.es_trasladado.value %}checked{% endif %}>
                                    <span>Viene de otra iglesia</span>
                                </label>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Iglesia anterior</label>
                                <input type="text" name="iglesia_anterior" id="id_iglesia_anterior"
                                       value="{{ form.iglesia_anterior.value|default:'' }}"
                                       placeholder="Nombre de la iglesia anterior" class="odoo-input">
                            </div>
                        </div>

                        <!-- Sección de salida (solo visible si no está activo) -->
                        <div class="odoo-subsection" id="bloque-salida-miembro" style="display: none;">
                            <h4 class="odoo-subsection-title">Información de salida</h4>
                            <div class="odoo-tab-grid">
                                <div class="odoo-field">
                                    <label class="odoo-label">Razón salida</label>
                                    <select name="razon_salida" id="{{ form.razon_salida.id_for_label }}" class="odoo-input">
                                        {% for value, label in form.razon_salida.field.choices %}
                                            <option value="{{ value }}" {% if form.razon_salida.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% if form.razon_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.razon_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}

                                <div class="odoo-field">
                                    <label class="odoo-label">Fecha salida</label>
                                    <input type="date" name="fecha_salida" 
                                           id="{{ form.fecha_salida.id_for_label }}"
                                           value="{{ form.fecha_salida.value|default:'' }}"
                                           class="odoo-input">
                                </div>
                                {% if form.fecha_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.fecha_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}

                                <div class="odoo-field odoo-field-full">
                                    <label class="odoo-label">Comentario</label>
                                    <textarea name="comentario_salida" id="{{ form.comentario_salida.id_for_label }}"
                                              rows="2" class="odoo-textarea"
                                              placeholder="Detalles adicionales sobre la salida...">{{ form.comentario_salida.value|default:'' }}</textarea>
                                </div>
                                {% if form.comentario_salida.errors %}
                                <div class="odoo-field-error">
                                    {% for error in form.comentario_salida.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Emergencia -->
                    <div class="odoo-tab-panel" id="tab-emergencia">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Contacto emergencia</label>
                                <input type="text" name="contacto_emergencia_nombre" 
                                       id="{{ form.contacto_emergencia_nombre.id_for_label }}"
                                       value="{{ form.contacto_emergencia_nombre.value|default:'' }}"
                                       placeholder="Nombre completo" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tel. emergencia</label>
                                <input type="tel" name="contacto_emergencia_telefono" 
                                       id="{{ form.contacto_emergencia_telefono.id_for_label }}"
                                       value="{{ form.contacto_emergencia_telefono.value|default:'' }}"
                                       placeholder="Teléfono" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Relación</label>
                                <input type="text" name="contacto_emergencia_relacion" 
                                       id="{{ form.contacto_emergencia_relacion.id_for_label }}"
                                       value="{{ form.contacto_emergencia_relacion.value|default:'' }}"
                                       placeholder="Ej: Esposa, Padre, Hermano" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tipo de sangre</label>
                                <select name="tipo_sangre" id="{{ form.tipo_sangre.id_for_label }}" class="odoo-input">
                                    {% for value, label in form.tipo_sangre.field.choices %}
                                        <option value="{{ value }}" {% if form.tipo_sangre.value == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Alergias</label>
                                <textarea name="alergias" id="{{ form.alergias.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Lista de alergias conocidas...">{{ form.alergias.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Condiciones médicas</label>
                                <textarea name="condiciones_medicas" id="{{ form.condiciones_medicas.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Condiciones médicas relevantes...">{{ form.condiciones_medicas.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Medicamentos</label>
                                <textarea name="medicamentos" id="{{ form.medicamentos.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Medicamentos que toma regularmente...">{{ form.medicamentos.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Trabajo -->
                    <div class="odoo-tab-panel" id="tab-trabajo">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field">
                                <label class="odoo-label">Empleador</label>
                                <input type="text" name="empleador" 
                                       id="{{ form.empleador.id_for_label }}"
                                       value="{{ form.empleador.value|default:'' }}"
                                       placeholder="Nombre de la empresa" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Puesto</label>
                                <input type="text" name="puesto" 
                                       id="{{ form.puesto.id_for_label }}"
                                       value="{{ form.puesto.value|default:'' }}"
                                       placeholder="Cargo o posición" class="odoo-input">
                            </div>
                            <div class="odoo-field">
                                <label class="odoo-label">Tel. trabajo</label>
                                <input type="tel" name="telefono_trabajo" 
                                       id="{{ form.telefono_trabajo.id_for_label }}"
                                       value="{{ form.telefono_trabajo.value|default:'' }}"
                                       placeholder="Teléfono laboral" class="odoo-input">
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Dirección trabajo</label>
                                <textarea name="direccion_trabajo" id="{{ form.direccion_trabajo.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Dirección completa del lugar de trabajo...">{{ form.direccion_trabajo.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Familiares -->
<div class="odoo-tab-panel" id="tab-familiares">
    
<div class="odoo-field-full">
  <label class="odoo-separator">Familiares registrados</label>

  <!-- Flag para que el backend sepa que debe sincronizar -->
  <input type="hidden" name="familiares_sync" value="1">

  <table class="odoo-table" data-current-miembro-id="{{ miembro.id }}">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Relación</th>
        <th>Vive junto</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <!-- ✅ ÚNICO tbody: aquí van tanto los existentes como los nuevos -->
<!-- ✅ ÚNICO tbody: aquí van tanto los existentes como los nuevos -->
<tbody id="familiares-pendientes">
  {% for rel in familiares %}
    <tr
      data-miembro-id="{{ rel.familiar_id }}"
      data-payload='{"id":"{{ rel.familiar_id }}","nombre":"{{ rel.familiar.nombres }} {{ rel.familiar.apellidos|escapejs }}","codigo":"{{ rel.familiar.codigo|default_if_none:""|escapejs }}","tipo_relacion":"{{ rel.tipo_relacion }}","tipo_relacion_label":"{{ rel.get_tipo_relacion_display }}","vive_junto":{{ rel.vive_junto|yesno:"true,false" }},"es_responsable":{{ rel.es_responsable|yesno:"true,false" }},"notas":"{{ rel.notas|default_if_none:""|escapejs }}"}'
    >
      <td>
        {{ rel.familiar.nombres }} {{ rel.familiar.apellidos }}
        {% if rel.familiar.codigo %}
          <div style="font-size:11px;color:#6c757d;">{{ rel.familiar.codigo }}</div>
        {% endif %}
      </td>
      <td>{{ rel.get_tipo_relacion_display }}</td>
      <td>{% if rel.vive_junto %}Sí{% else %}No{% endif %}</td>
      <td>
        <a href="javascript:void(0)" class="odoo-link-danger js-remove-familiar-line" title="Quitar">
          <span class="material-icons">delete</span>
        </a>
      </td>
    </tr>
  {% empty %}
    <tr id="familiares-empty-row">
      <td colspan="4" class="odoo-empty-text">No hay familiares registrados.</td>
    </tr>
  {% endfor %}
</tbody>
  </table>
</div>


    <div class="odoo-add-line" id="btn-add-familiar">
        <a href="javascript:void(0)" class="odoo-add-link" onclick="toggleFamiliarForm(true)">
            <span class="material-icons">add</span>
            Agregar familiar
        </a>
    </div>

    <div class="odoo-inline-edit-box" id="familiar-form" style="display:none;">
        <h5 class="odoo-inline-title">Nuevo familiar</h5>
        
        <div class="odoo-tab-grid">
            
        <div class="odoo-field-row">
            <label>Buscar miembro</label>
        
            <div class="odoo-field-value autocomplete-wrapper" data-autocomplete-id="id_familiar_miembro">
                
                <input type="hidden" id="id_familiar_miembro" name="familiar_miembro" value="">
                <div id="familiares-hidden-inputs"></div>
                                        
                <div class="autocomplete-field">
                    
                    <div class="autocomplete-chip" id="chip-familiar" style="display: none;">
                        <span class="chip-avatar">M</span>
                        <span class="chip-text">
                            <span class="chip-name"></span>
                            <span class="chip-code"></span>
                        </span>
                        <button type="button" class="chip-remove" id="chip-remove-familiar" title="Quitar">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    
                    <input 
                        type="text" 
                        id="search-familiar" 
                        class="autocomplete-search" 
                        placeholder="Escriba para buscar..."
                        autocomplete="off"
                    >
                </div>  

                <div class="autocomplete-dropdown" id="dropdown-familiar">
                    <ul class="autocomplete-list" id="list-familiar"></ul>
                    
                    <div class="autocomplete-empty" id="empty-familiar">
                        <span class="material-icons">person_search</span>
                        <p>No se encontraron miembros</p>
                    </div>
                    <div class="autocomplete-loading" id="loading-familiar">
                        <span class="material-icons spinner">sync</span>
                        <p>Buscando...</p>
                    </div>
                </div>

      <div class="autocomplete-empty" style="display:none;">
        <span class="material-icons">person_search</span>
        No se encontraron miembros
      </div>
  

    <!-- Mantengo este bloque para el JS, pero lo ocultamos porque usaremos CHIP -->
    <div class="autocomplete-selected" style="display:none;">
      <strong class="selected-name"></strong>
      <span class="selected-codigo"></span>
      <button type="button" class="selected-remove">×</button>
    </div>
  </div>
</div>



            <div class="odoo-field">
                <label class="odoo-label">Relación</label>
                <div class="odoo-field-stack">
                <select name="tipo_relacion" class="odoo-input" id="id_tipo_relacion">
                <option value="" selected disabled>Selecciona…</option>
                {% for value, label in TIPOS_RELACION_CHOICES %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
                </select>


                    <div class="odoo-field-row" style="margin-top: 8px;">
                        <label class="odoo-checkbox-label">
                            <input type="checkbox" name="vive_junto">
                            <span>Vive junto</span>
                        </label>
                        <label class="odoo-checkbox-label" style="margin-left: 15px;">
                            <input type="checkbox" name="es_responsable">
                            <span>Es responsable</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="odoo-field odoo-field-full">
                <label class="odoo-label">Notas</label>
                <input type="text" name="notas_familiar" 
                       placeholder="Observaciones sobre la relación..." 
                       class="odoo-input">
            </div>

            <div class="odoo-field odoo-field-full">
                <div class="odoo-inline-actions">
                   <button type="button" class="odoo-btn-primary odoo-btn-sm" id="btn-add-familiar-line">
                    Añadir a la lista
                    </button>

                    <button type="button" class="odoo-btn-secondary odoo-btn-sm" onclick="toggleFamiliarForm(false)">
                        Descartar
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>


                    <!-- TAB: Intereses y Habilidades -->
                    <div class="odoo-tab-panel" id="tab-intereses">
                        <div class="odoo-tab-grid">
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Intereses</label>
                                {{ form.intereses }}
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Otros intereses</label>
                                <textarea name="otros_intereses" id="{{ form.otros_intereses.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Otros intereses no listados...">{{ form.otros_intereses.value|default:'' }}</textarea>
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Habilidades</label>
                                {{ form.habilidades }}
                            </div>
                            <div class="odoo-field odoo-field-full">
                                <label class="odoo-label">Otras habilidades</label>
                                <textarea name="otras_habilidades" id="{{ form.otras_habilidades.id_for_label }}"
                                          rows="2" class="odoo-textarea"
                                          placeholder="Otras habilidades no listadas...">{{ form.otras_habilidades.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
 <!-- TAB: Socioeconómico -->
<div class="odoo-tab-panel" id="tab-socioeconomico">

    <div class="odoo-tab-grid">

        <!-- Vivienda -->
        <div class="odoo-field">
            <label class="odoo-label">Tipo de vivienda</label>
            <select name="tipo_vivienda" id="{{ form.tipo_vivienda.id_for_label }}" class="odoo-input">
                <option value="">— Seleccionar —</option>
                {% for value, label in form.tipo_vivienda.field.choices %}
                    {% if value %}
                        <option value="{{ value }}" {% if form.tipo_vivienda.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="odoo-field">
            <label class="odoo-label">Situación económica</label>
            <select name="situacion_economica" id="{{ form.situacion_economica.id_for_label }}" class="odoo-input">
                <option value="">— Seleccionar —</option>
                {% for value, label in form.situacion_economica.field.choices %}
                    {% if value %}
                        <option value="{{ value }}" {% if form.situacion_economica.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Tiene vehículo -->
        <div class="odoo-field odoo-field-checkbox">
            <label class="odoo-checkbox-label">
                <input type="checkbox" name="tiene_vehiculo" id="id_tiene_vehiculo"
                       {% if form.tiene_vehiculo.value %}checked{% endif %}>
                <span>Tiene vehículo</span>
            </label>
        </div>

    </div>

    <!-- Sub-sección Vehículo -->
    <div class="odoo-subsection" id="bloque-vehiculo">
        <h4 class="odoo-subsection-title">Datos del vehículo</h4>

        <div class="odoo-tab-grid">
            <div class="odoo-field">
                <label class="odoo-label">Tipo</label>
                <select name="vehiculo_tipo" id="{{ form.vehiculo_tipo.id_for_label }}" class="odoo-input">
                    <option value="">— Seleccionar —</option>
                    {% for value, label in form.vehiculo_tipo.field.choices %}
                        {% if value %}
                            <option value="{{ value }}" {% if form.vehiculo_tipo.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="odoo-field">
                <label class="odoo-label">Marca</label>
                <input type="text"
                       name="vehiculo_marca"
                       id="{{ form.vehiculo_marca.id_for_label }}"
                       value="{{ form.vehiculo_marca.value|default:'' }}"
                       placeholder="Ej: Toyota"
                       class="odoo-input">
            </div>

            <div class="odoo-field">
                <label class="odoo-label">Placa</label>
                <input type="text"
                       name="vehiculo_placa"
                       id="{{ form.vehiculo_placa.id_for_label }}"
                       value="{{ form.vehiculo_placa.value|default:'' }}"
                       placeholder="Ej: A123456"
                       class="odoo-input">
            </div>
        </div>
    </div>
</div>


                    <!-- TAB: Notas -->
                    <div class="odoo-tab-panel" id="tab-notas">
                        <div class="odoo-field odoo-field-full">
                            <label class="odoo-label">Notas pastorales</label>
                            <textarea name="notas" id="{{ form.notas.id_for_label }}"
                                      rows="6" class="odoo-textarea"
                                      placeholder="Observaciones internas sobre el miembro (visible solo para el equipo autorizado)...">{{ form.notas.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════════════════════════════════
             PANEL LATERAL (Chatter / Acciones)
             ══════════════════════════════════════════════════════════════════ -->
        <div class="odoo-form-aside">
            
            <!-- Botones de acción -->
            <div class="odoo-aside-actions">
                {% if modo == "editar" %}
                    <button type="submit" class="odoo-btn odoo-btn-primary">
                        <span class="material-icons">save</span>
                        Guardar cambios
                    </button>
                {% else %}
                    <button type="submit" name="guardar" value="1" class="odoo-btn odoo-btn-primary">
                        <span class="material-icons">check</span>
                        Guardar
                    </button>
                    <button type="submit" name="guardar_y_nuevo" value="1" class="odoo-btn odoo-btn-secondary">
                        <span class="material-icons">add</span>
                        Guardar y nuevo
                    </button>
                {% endif %}
            </div>

            <!-- Info rápida -->
            <div class="odoo-aside-info">
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Edad</span>
                    <span class="odoo-info-value" id="id_edad_display">—</span>
                </div>
                <div class="odoo-info-item">
                    <span class="odoo-info-label">Categoría</span>
                    <span class="odoo-info-badge" id="id_categoria_edad_display">—</span>
                </div>
            </div>

            <!-- Consejos rápidos -->
            <div class="odoo-aside-tips">
                <h4 class="odoo-aside-title">Consejos</h4>
                <ul class="odoo-tips-list">
                    <li>Revisa la pestaña <strong>Membresía</strong> para fechas importantes.</li>
                    <li>En <strong>Emergencia</strong>, añade contacto y condiciones médicas.</li>
                    <li>Usa <strong>Notas</strong> para observaciones pastorales.</li>
                </ul>
            </div>


            <!-- Actividad reciente -->
            <div class="odoo-activity">

                {% if miembro %}
                    <div class="odoo-activity-item">
                        <span class="odoo-activity-label">Creado el</span>
                        <span class="odoo-activity-date">
                            {{ miembro.fecha_creacion|date:"d/m/Y H:i" }}
                        </span>
                    </div>

                    <div class="odoo-activity-item">
                        <span class="odoo-activity-label">Última actualización</span>
                        <span class="odoo-activity-date">
                            {{ miembro.fecha_actualizacion|date:"d/m/Y H:i" }}
                        </span>
                    </div>
                {% else %}
                    <div class="odoo-activity-item">
                        <span class="odoo-activity-label">Creando nuevo registro</span>
                        <span class="odoo-activity-date">Ahora</span>
                    </div>
                {% endif %}

            </div>


        </div>
    </div>
</form>

<!-- ══════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════ -->
<style>
.odoo-alert{
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:8px;
  font-size:14px;
  border:1px solid transparent;
}

.odoo-alert-danger{
  background:#fdecec;
  border-color:#f5c2c7;
  color:#842029;
}

.odoo-alert-success{
  background:#eaf7ee;
  border-color:#b7e4c7;
  color:#0f5132;
}

.odoo-alert-info{
  background:#e8f4fd;
  border-color:#b6daff;
  color:#084298;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESET Y BASE - Estilo Odoo
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form {
    background: #fff;
    min-height: calc(100vh - 60px);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BARRA DE CONTROL SUPERIOR
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 100;
}

.odoo-control-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.odoo-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #017e84;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
}

.odoo-breadcrumb-link:hover {
    text-decoration: underline;
}

.odoo-breadcrumb-link .material-icons {
    font-size: 18px;
}

.odoo-breadcrumb-sep {
    color: #6c757d;
}

.odoo-breadcrumb-current {
    color: #495057;
    font-size: 14px;
}

.odoo-new-badge {
    background: #017e84;
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 3px;
    margin-left: 8px;
}

.odoo-member-code {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
    color: #6c757d;
    background: #e9ecef;
    padding: 4px 10px;
    border-radius: 4px;
}

.odoo-member-code .material-icons {
    font-size: 16px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTENEDOR PRINCIPAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-container {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 0;
    min-height: calc(100vh - 110px);
}

.odoo-form-main {
    padding: 24px 32px;
    border-right: 1px solid #dee2e6;
}

/* ═══════════════════════════════════════════════════════════════════════════
   HEADER DEL FORMULARIO (Avatar + Nombre)
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-header {
    display: flex;
    gap: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 24px;
}

.odoo-avatar-section {
    flex-shrink: 0;
}

.odoo-avatar {
    width: 110px;
    height: 110px;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.odoo-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.odoo-avatar .material-icons {
    font-size: 56px;
    color: #017e84;
    opacity: 0.6;
}

.odoo-avatar-upload {
    margin-top: 8px;
}

.odoo-avatar-upload input[type="file"] {
    font-size: 11px;
    width: 110px;
}

.odoo-header-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Radio group (Masculino/Femenino) */
.odoo-radio-group {
    display: flex;
    gap: 16px;
}

.odoo-radio {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 13px;
    color: #495057;
}

.odoo-radio input[type="radio"] {
    accent-color: #017e84;
}

/* Campo de nombre grande */
.odoo-name-field {
    display: flex;
    gap: 12px;
}

.odoo-name-input {
    flex: 1;
    font-size: 28px;
    font-weight: 400;
    color: #212529;
    border: none;
    border-bottom: 1px solid transparent;
    background: #fff0f3;
    padding: 8px 12px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.odoo-name-input:hover {
    background: #ffe4e9;
}

.odoo-name-input:focus {
    outline: none;
    background: #fff;
    border-bottom-color: #017e84;
}

.odoo-name-input::placeholder {
    color: #adb5bd;
    font-weight: 300;
}

/* Campos de contacto rápido */
.odoo-quick-fields {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
}

.odoo-quick-field {
    display: flex;
    align-items: center;
    gap: 8px;
}

.odoo-quick-field .material-icons {
    font-size: 18px;
    color: #6c757d;
    width: 20px;
}

.odoo-quick-field input {
    flex: 1;
    max-width: 280px;
    border: none;
    border-bottom: 1px dashed #dee2e6;
    padding: 4px 0;
    font-size: 14px;
    color: #495057;
    background: transparent;
}

.odoo-quick-field input:hover {
    border-bottom-color: #adb5bd;
}

.odoo-quick-field input:focus {
    outline: none;
    border-bottom: 1px solid #017e84;
}

.odoo-quick-field input::placeholder {
    color: #adb5bd;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BODY DEL FORMULARIO (Dos columnas)
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px 48px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 24px;
}

.odoo-form-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Campos estilo Odoo */
.odoo-field {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.odoo-field-group {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.odoo-label {
    width: 120px;
    flex-shrink: 0;
    font-size: 13px;
    color: #495057;
    padding-top: 6px;
    text-align: right;
}

.odoo-input {
    flex: 1;
    border: none;
    border-bottom: 1px solid #dee2e6;
    padding: 6px 0;
    font-size: 14px;
    color: #212529;
    background: transparent;
    transition: border-color 0.2s ease;
}

.odoo-input:hover {
    border-bottom-color: #adb5bd;
}

.odoo-input:focus {
    outline: none;
    border-bottom-color: #017e84;
}

.odoo-input::placeholder {
    color: #adb5bd;
}

.odoo-input-small {
    max-width: 80px;
}

/* Nota informativa de campo */
.odoo-field-note {
    margin-left: 132px;
    font-size: 12px;
    color: #6c757d;
    background: #fff8e6;
    border: 1px solid #ffe4a0;
    border-radius: 4px;
    padding: 8px 12px;
    margin-top: 8px;
    line-height: 1.4;
}

.odoo-field-note .material-icons {
    color: #856404;
    margin-right: 4px;
}

select.odoo-input {
    cursor: pointer;
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3e%3cpath fill='%236c757d' d='M6 8L1 3h10z'/%3e%3c/svg%3e") no-repeat right center;
    padding-right: 20px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

/* Stack de campos (para dirección) */
.odoo-field-stack {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.odoo-field-row {
    display: flex;
    gap: 12px;
}

/* Checkbox */
.odoo-field-checkbox {
    padding-left: 132px;
}

.odoo-field-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-left: 132px;
}

.odoo-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 13px;
    color: #495057;
}

.odoo-checkbox-label input[type="checkbox"] {
    accent-color: #017e84;
    width: 16px;
    height: 16px;
}

/* Alertas */
.odoo-alert {
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 13px;
    margin: 8px 0;
}

.odoo-alert-warning {
    background: #fff7ed;
    color: #c2410c;
    border-left: 3px solid #f97316;
}

/* Field errors */
.odoo-field-error {
    color: #dc3545;
    font-size: 12px;
    padding-left: 132px;
    margin-top: -8px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   TABS
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-tabs-section {
    margin-top: 8px;
}

.odoo-tabs-bar {
    display: flex;
    gap: 0;
    border-bottom: 1px solid #dee2e6;
    flex-wrap: wrap;
}

.odoo-tab {
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
}

.odoo-tab:hover {
    color: #495057;
    background: #f8f9fa;
}

.odoo-tab.active {
    color: #017e84;
    border-bottom-color: #017e84;
}

.odoo-tabs-content {
    padding: 20px 0;
}

.odoo-tab-panel {
    display: none;
}

.odoo-tab-panel.active {
    display: block;
}

.odoo-tab-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 32px;
}

.odoo-field-full {
    grid-column: 1 / -1;
}

.odoo-textarea {
    width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s ease;
}

.odoo-textarea:focus {
    outline: none;
    border-color: #017e84;
}

/* Subsection */
.odoo-subsection {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px dashed #dee2e6;
}

.odoo-subsection-title {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 12px;
}

/* Tabla estilo Odoo */
.odoo-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 16px;
}

.odoo-table th {
    text-align: left;
    padding: 8px 12px;
    background: #f8f9fa;
    color: #495057;
    font-weight: 500;
    border-bottom: 1px solid #dee2e6;
}

.odoo-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e9ecef;
    color: #212529;
}

.odoo-table tr:hover td {
    background: #f8f9fa;
}

.odoo-link-danger {
    color: #dc3545;
    display: flex;
}

.odoo-link-danger .material-icons {
    font-size: 18px;
}

/* Add line */
.odoo-add-line {
    padding: 8px 0;
}

.odoo-add-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #017e84;
    font-size: 13px;
    text-decoration: none;
}

.odoo-add-link:hover {
    text-decoration: underline;
}

.odoo-add-link .material-icons {
    font-size: 18px;
}

.odoo-inline-form {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 4px;
    margin-top: 12px;
}

.odoo-btn-link {
    background: none;
    border: none;
    color: #017e84;
    font-size: 13px;
    cursor: pointer;
    padding: 0;
}

.odoo-btn-link:hover {
    text-decoration: underline;
}

.odoo-empty-text {
    color: #6c757d;
    font-size: 13px;
    font-style: italic;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PANEL LATERAL
   ═══════════════════════════════════════════════════════════════════════════ */
.odoo-form-aside {
    background: #f8f9fa;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.odoo-aside-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.odoo-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.odoo-btn .material-icons {
    font-size: 18px;
}

.odoo-btn-primary {
    background: #017e84;
    color: white;
}

.odoo-btn-primary:hover {
    background: #016166;
}

.odoo-btn-secondary {
    background: white;
    color: #495057;
    border: 1px solid #dee2e6;
}

.odoo-btn-secondary:hover {
    background: #e9ecef;
}

/* Info lateral */
.odoo-aside-info {
    background: white;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.odoo-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.odoo-info-label {
    font-size: 12px;
    color: #6c757d;
}

.odoo-info-value {
    font-size: 14px;
    font-weight: 600;
    color: #212529;
}

.odoo-info-badge {
    font-size: 11px;
    font-weight: 500;
    background: #d4edda;
    color: #155724;
    padding: 2px 8px;
    border-radius: 10px;
}

/* Tips */
.odoo-aside-tips {
    background: white;
    border-radius: 4px;
    padding: 12px;
}

.odoo-aside-title {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.odoo-tips-list {
    margin: 0;
    padding-left: 16px;
    font-size: 12px;
    color: #6c757d;
    line-height: 1.6;
}

.odoo-tips-list li {
    margin-bottom: 4px;
}

/* Actividad */
.odoo-aside-activity {
    background: white;
    border-radius: 4px;
    padding: 12px;
}

.odoo-activity-item {
    display: flex;
    gap: 10px;
}

.odoo-activity-avatar {
    width: 32px;
    height: 32px;
    background: #017e84;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.odoo-activity-avatar .material-icons {
    font-size: 18px;
    color: white;
}

.odoo-activity-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.odoo-activity-text {
    font-size: 13px;
    color: #212529;
}

.odoo-activity-date {
    font-size: 11px;
    color: #6c757d;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════ */
@media (max-width: 992px) {
    .odoo-form-container {
        grid-template-columns: 1fr;
    }
    
    .odoo-form-main {
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
    
    .odoo-form-aside {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .odoo-aside-actions {
        flex-direction: row;
    }
    
    .odoo-aside-info,
    .odoo-aside-tips,
    .odoo-aside-activity {
        flex: 1;
        min-width: 200px;
    }
}

@media (max-width: 768px) {

    .odoo-form-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .odoo-name-field {
        flex-direction: column;
    }

    .odoo-form-body {
        grid-template-columns: 1fr;
    }

    .odoo-field,
    .odoo-field-group {
        flex-direction: column;
        align-items: stretch;
    }

    .odoo-label {
        width: auto;
        text-align: left;
        padding-top: 0;
        margin-bottom: 4px;
    }

    .odoo-field-checkbox,
    .odoo-field-checkboxes {
        padding-left: 0;
    }

    .odoo-field-note {
        margin-left: 0;
    }

    .odoo-field-error {
        padding-left: 0;
    }

    .odoo-tab-grid {
        grid-template-columns: 1fr;
    }

    /* ======================================================
       ⚠️ CLAVE: NO BLOQUEAR SCROLL HORIZONTAL DE TABLAS
       ====================================================== */

    /* El layout general no debe desbordarse */
    .odoo-form,
    .odoo-form-container {
        max-width: 100%;
        overflow-x: hidden;
    }

    /* ⬅️ AQUÍ ESTÁ LA CORRECCIÓN IMPORTANTE */
    .odoo-form-main {
        max-width: 100%;
        overflow-x: visible; /* permite scroll interno */
    }
}

.odoo-separator {
    display: block;
    color: #017e84;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 4px;
    width: 100%;
}

/* Enlace "Agregar línea" */
.odoo-add-line {
    padding: 10px 0;
}

.odoo-add-link {
    color: #017e84;
    text-decoration: none;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: color 0.2s;
}

.odoo-add-link:hover {
    color: #015c61;
    text-decoration: underline;
}

/* Caja de edición inline (Fondo gris suave, sin bordes pesados) */
.odoo-inline-edit-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 16px;
    margin-top: 10px;
    margin-bottom: 20px;
    /* Sin border-radius exagerado, Odoo es bastante cuadrado */
    border-radius: 2px; 
}

.odoo-inline-title {
    margin: 0 0 16px 0;
    font-size: 14px;
    color: #495057;
    font-weight: 600;
}

/* Botones pequeños para acciones inline */
.odoo-btn-sm {
    padding: 4px 12px;
    font-size: 12px;
    height: 30px;
}

/* Ajuste para el select múltiple visual */
#id_familiar option {
    padding: 4px;
    cursor: pointer;
}
#id_familiar option:hover {
    background-color: #e9ecef;
}
.odoo-form-main{
  padding: 14px 12px !important;
}
.odoo-control-bar{
  padding: 8px 12px !important;
}

/* ✅ FIX OVERFLOW: en móvil el layout debe ser 1 columna */
.odoo-form-container {
    grid-template-columns: 1fr !important;
    min-height: auto !important;
}
.odoo-form-main{
  padding: 14px 12px !important;
}
.odoo-control-bar{
  padding: 8px 12px !important;
}

@media (max-width: 768px){
  .odoo-form,
  .odoo-form-container,
  .odoo-form-main{
    max-width: 100%;
    overflow-x: hidden;
  }
}


 .odoo-form-main{
    max-width: 100%;
    overflow-x: visible;
  }
}

/* el aside pasa abajo y ocupa 100% */
.odoo-form-aside {
    width: 100%;
    order: 2;
}





    /* =====================================
       AUTOCOMPLETE - ESTILO CHIP/TAG
       ===================================== */

    .autocomplete-wrapper {
        position: relative;
    }

    .autocomplete-field {
        display: flex;
        align-items: center;
        min-height: 32px;
        flex-wrap: wrap;
        gap: 6px;
    }

    /* Input de búsqueda */
    .autocomplete-search {
        flex: 1;
        min-width: 120px;
        border: none;
        border-bottom: 1px solid transparent;
        background: transparent;
        padding: 4px 0;
        font-size: 13px;
        color: var(--odoo-text);
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .autocomplete-search:hover {
        border-bottom-color: var(--odoo-border);
    }

    .autocomplete-search:focus {
        outline: none;
        border-bottom-color: var(--odoo-purple);
        border-bottom-width: 2px;
        padding-bottom: 3px;
    }

    .autocomplete-search::placeholder {
        color: #adb5bd;
    }

    /* Ocultar input cuando hay chip */
    .autocomplete-field.has-selection .autocomplete-search {
        display: none;
    }

    /* =====================================
       CHIP / TAG - ESTILO SUTIL Y COMPACTO
       ===================================== */

    .autocomplete-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 6px 2px 2px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        font-size: 13px;
        color: var(--odoo-text);
        animation: chipIn 0.15s ease;
    }

    @keyframes chipIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .chip-avatar {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--odoo-purple);
        color: white;
        font-size: 9px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
    }

    .chip-text {
        display: flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
    }

    .chip-name {
        font-weight: 500;
        color: var(--odoo-text);
        font-size: 13px;
    }

    .chip-code {
        font-size: 11px;
        color: var(--odoo-text-muted);
        font-weight: 400;
    }

    .chip-remove {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: #9ca3af;
        cursor: pointer;
        transition: all 0.15s;
        padding: 0;
        margin-left: 2px;
    }

    .chip-remove:hover {
        background: #e5e7eb;
        color: var(--odoo-text);
    }

    .chip-remove .material-icons {
        font-size: 14px;
    }

    /* =====================================
       DROPDOWN
       ===================================== */

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 4px;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 280px;
        overflow-y: auto;
        display: none;
    }

    .autocomplete-dropdown.open {
        display: block;
    }

    .autocomplete-list {
        list-style: none;
        margin: 0;
        padding: 4px 0;
    }

    .autocomplete-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .autocomplete-item:hover {
        background: #f5f0f4;
    }

    .autocomplete-item-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--odoo-purple) 0%, #8e6b82 100%);
        color: white;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .autocomplete-item-info {
        flex: 1;
        min-width: 0;
    }

    .autocomplete-item-name {
        font-weight: 500;
        color: #111827;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .autocomplete-item-meta {
        font-size: 11px;
        color: #6b7280;
        display: flex;
        gap: 8px;
        margin-top: 2px;
    }

    .autocomplete-item-code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        color: #6b7280;
        font-weight: 500;
    }

    .autocomplete-empty,
    .autocomplete-loading {
        padding: 24px 14px;
        text-align: center;
        color: #9ca3af;
        display: none;
    }

    .autocomplete-empty .material-icons,
    .autocomplete-loading .material-icons {
        font-size: 32px;
        opacity: 0.4;
        display: block;
        margin: 0 auto 8px;
    }

    .autocomplete-empty p,
    .autocomplete-loading p {
        margin: 0;
        font-size: 12px;
    }

    /* Spinner animation */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .spinner {
        animation: spin 1s linear infinite;
    }
    /* ==========================================================
    ACTIVIDAD (estilo sistema / Odoo)
    ========================================================== */

    .odoo-activity {
        margin-top: 24px;
        padding-top: 12px;
        border-top: 1px dashed #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .odoo-activity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .odoo-activity-label {
        font-size: 11px;
        font-weight: 500;
        color: #6c757d; /* gris sistema */
        text-transform: uppercase;
        letter-spacing: 0.4px;
    }

    .odoo-activity-date {
        font-size: 12px;
        font-weight: 500;
        color: #495057;
    }

.hint {
    margin-top: 3px;
    font-size: 10px;   /* antes 11px o 12px */
    color: var(--color-text-muted);
    opacity: 0.75;     /* más sutil */
    line-height: 1.3;
}

</style>

<!-- ══════════════════════════════════════════════════════════════════════════
     SCRIPTS
     ══════════════════════════════════════════════════════════════════════════ -->

<!-- Variable de edad mínima desde Django -->
<script>
    const EDAD_MINIMA_MIEMBRO_OFICIAL = {{ EDAD_MINIMA_MIEMBRO_OFICIAL }};
</script>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// FUNCIONALIDAD DE TABS
// ═══════════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.odoo-tab');
    const panels = document.querySelectorAll('.odoo-tab-panel');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = 'tab-' + this.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        });
    });
    
    // Check URL params for tab
    const params = new URLSearchParams(window.location.search);
    const tabParam = params.get('tab');
    if (tabParam) {
        const targetTab = document.querySelector(`[data-tab="${tabParam}"]`);
        if (targetTab) targetTab.click();
    }
});

// Toggle familiar form
function toggleFamiliarForm() {
    const form = document.getElementById('familiar-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// ═══════════════════════════════════════════════════════════════════════════
// CÁLCULO DE EDAD Y CATEGORÍA
// ═══════════════════════════════════════════════════════════════════════════
function calcularEdadDesdeFecha(fechaStr) {
    if (!fechaStr) return null;

    const partes = fechaStr.split("-");
    if (partes.length !== 3) return null;

    const anio = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10);
    const dia = parseInt(partes[2], 10);

    if (isNaN(anio) || isNaN(mes) || isNaN(dia)) return null;

    const nacimiento = new Date(anio, mes - 1, dia);
    const hoy = new Date();

    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mesDiff = hoy.getMonth() - nacimiento.getMonth();

    if (mesDiff < 0 || (mesDiff === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }

    return edad >= 0 ? edad : null;
}

function obtenerCategoriaEdad(edad) {
    if (edad === null) return "—";

    if (edad <= 5)  return "Infante";
    if (edad <= 11) return "Niño";
    if (edad <= 17) return "Adolescente";
    if (edad <= 30) return "Joven";
    if (edad <= 59) return "Adulto";
    return "Adulto mayor";
}

function actualizarEdadYCategoria() {
    const inputFecha       = document.getElementById('id_fecha_nacimiento');
    const edadDisplay      = document.getElementById('id_edad_display');
    const categoriaDisplay = document.getElementById('id_categoria_edad_display');
    const avisoEdad        = document.getElementById('edad_aviso');

    if (!inputFecha || !edadDisplay || !categoriaDisplay) return;

    const valor = inputFecha.value;

    if (!valor) {
        edadDisplay.textContent = "—";
        categoriaDisplay.textContent = "—";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    const edad = calcularEdadDesdeFecha(valor);

    if (edad === null) {
        edadDisplay.textContent = "—";
        categoriaDisplay.textContent = "—";
        if (avisoEdad) avisoEdad.style.display = "none";
        return;
    }

    // Actualizar displays
    edadDisplay.textContent = edad + " años";
    categoriaDisplay.textContent = obtenerCategoriaEdad(edad);

    // Mostrar/ocultar aviso según edad mínima
    if (avisoEdad) {
        avisoEdad.style.display = edad < EDAD_MINIMA_MIEMBRO_OFICIAL ? "block" : "none";
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE BAUTISMO SEGÚN EDAD Y ESTADO
// ═══════════════════════════════════════════════════════════════════════════
function actualizarBautismoPorEstadoYEdad() {
    const inputFecha = document.getElementById('id_fecha_nacimiento');
    const estadoSelect = document.getElementById('id_estado_miembro');
    const bautizadoCheckbox = document.getElementById('id_bautizado_confirmado');

    if (!bautizadoCheckbox) return;

    const edad = inputFecha ? calcularEdadDesdeFecha(inputFecha.value) : null;
    const estado = estadoSelect ? estadoSelect.value : "";
    const EDAD_MIN_BAUTISMO = EDAD_MINIMA_MIEMBRO_OFICIAL;

    // Por defecto dejamos que el usuario pueda marcar/desmarcar
    bautizadoCheckbox.disabled = false;

    // Si es menor que la edad mínima -> nunca bautizado confirmado
    if (edad !== null && edad < EDAD_MIN_BAUTISMO) {
        bautizadoCheckbox.checked = false;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Catecúmeno nunca se marca como bautizado
    if (estado === "catecumeno") {
        bautizadoCheckbox.checked = false;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Estados pastorales oficiales -> siempre bautizados
    const estadosBautizados = ["activo", "pasivo", "observacion", "disciplina", "descarriado"];
    if (estadosBautizados.includes(estado)) {
        bautizadoCheckbox.checked = true;
        bautizadoCheckbox.disabled = true;
        return;
    }

    // Otros estados futuros -> libre
    bautizadoCheckbox.disabled = false;
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE TRASLADO / IGLESIA ANTERIOR
// ═══════════════════════════════════════════════════════════════════════════
function actualizarIglesiaAnterior() {
    const trasladoCheckbox = document.getElementById('id_es_trasladado');
    const iglesiaAnteriorInput = document.getElementById('id_iglesia_anterior');

    if (!iglesiaAnteriorInput || !trasladoCheckbox) return;

    if (trasladoCheckbox.checked) {
        iglesiaAnteriorInput.removeAttribute('disabled');
        iglesiaAnteriorInput.removeAttribute('readonly');
    } else {
        iglesiaAnteriorInput.value = '';
        iglesiaAnteriorInput.setAttribute('disabled', 'disabled');
        iglesiaAnteriorInput.setAttribute('readonly', 'readonly');
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// LÓGICA DE MIEMBRO ACTIVO / BLOQUE DE SALIDA
// ═══════════════════════════════════════════════════════════════════════════
function actualizarBloqueSalida() {
    const chkActivo = document.getElementById('id_activo');
    const bloqueSalida = document.getElementById('bloque-salida-miembro');

    if (!chkActivo || !bloqueSalida) return;

    bloqueSalida.style.display = chkActivo.checked ? 'none' : 'block';
}

// ═══════════════════════════════════════════════════════════════════════════
// FORMATO DE CÉDULA DOMINICANA
// ═══════════════════════════════════════════════════════════════════════════
function formatearCedula(valor) {
    let soloDigitos = valor.replace(/\D/g, '').slice(0, 11);

    if (soloDigitos.length <= 3) return soloDigitos;
    if (soloDigitos.length <= 10) {
        return soloDigitos.slice(0, 3) + '-' + soloDigitos.slice(3);
    }
    return soloDigitos.slice(0, 3) + '-' + soloDigitos.slice(3, 10) + '-' + soloDigitos.slice(10);
}

// ═══════════════════════════════════════════════════════════════════════════
// FILTRO DE BÚSQUEDA DE FAMILIARES
// ═══════════════════════════════════════════════════════════════════════════
function setupFamiliarSearch() {
    const searchInput = document.getElementById('familiar_search');
    const selectList = document.getElementById('id_familiar');

    if (searchInput && selectList) {
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();

            for (let i = 0; i < selectList.options.length; i++) {
                const option = selectList.options[i];
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(filter) ? "" : "none";
            }
        });
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// INICIALIZACIÓN AL CARGAR LA PÁGINA
// ═══════════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar edad y categoría
    actualizarEdadYCategoria();
    
    // Eventos de fecha de nacimiento
    const inputFecha = document.getElementById('id_fecha_nacimiento');
    if (inputFecha) {
        inputFecha.addEventListener('change', function() {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
        inputFecha.addEventListener('input', function() {
            actualizarEdadYCategoria();
            actualizarBautismoPorEstadoYEdad();
        });
    }

    // Eventos de estado del miembro
    const estadoSelect = document.getElementById('id_estado_miembro');
    if (estadoSelect) {
        estadoSelect.addEventListener('change', actualizarBautismoPorEstadoYEdad);
    }

    // Inicializar bautismo
    actualizarBautismoPorEstadoYEdad();

    // Eventos de traslado
    const trasladoCheckbox = document.getElementById('id_es_trasladado');
    if (trasladoCheckbox) {
        trasladoCheckbox.addEventListener('change', actualizarIglesiaAnterior);
        actualizarIglesiaAnterior();
    }

    // Eventos de miembro activo
    const chkActivo = document.getElementById('id_activo');
    if (chkActivo) {
        chkActivo.addEventListener('change', actualizarBloqueSalida);
        actualizarBloqueSalida();
    }

    // Formato de cédula
    const cedulaInput = document.getElementById('id_cedula');
    if (cedulaInput) {
        if (cedulaInput.value) {
            cedulaInput.value = formatearCedula(cedulaInput.value);
        }
        cedulaInput.addEventListener('input', function() {
            this.value = formatearCedula(this.value);
        });
    }

    // Búsqueda de familiares
    setupFamiliarSearch();
});
</script>
{% load static %}
<script src="{% static 'core/js/autocomplete-miembro.js' %}"></script>

<script>
(function () {
  function q(sel, root=document){ return root.querySelector(sel); }
  function qa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  function escapeHtml(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function getSelectedMiembro(){
    const wrapper = q('[data-autocomplete-id="id_familiar_miembro"]');
    const hidden = wrapper ? q('#id_familiar_miembro', wrapper) : null;
    const id = hidden ? (hidden.value || "").trim() : "";

    const chipName = wrapper ? q('.autocomplete-chip .chip-name', wrapper) : null;
    const chipCode = wrapper ? q('.autocomplete-chip .chip-code', wrapper) : null;

    return {
      id,
      nombre: chipName ? chipName.textContent.trim() : "",
      codigo: chipCode ? chipCode.textContent.trim() : "",
      wrapper
    };
  }


  function buildHiddenFromRows(){
  const container = q('#familiares-hidden-inputs');
  if (!container) return;
  container.innerHTML = "";

  // ✅ Solo filas que tengan data-payload
  const rows = qa('#familiares-pendientes tr[data-payload]');

  rows.forEach(tr => {
    const raw = tr.getAttribute('data-payload');
    if (!raw) return;

    let payload = null;
    try {
      payload = JSON.parse(raw);
    } catch (e) {
      return;
    }

    // ✅ Evitar payload null o sin id
    if (!payload || !payload.id) return;

    container.insertAdjacentHTML('beforeend', `
      <input type="hidden" name="familiares_miembro_id[]" value="${payload.id}">
      <input type="hidden" name="familiares_tipo_relacion[]" value="${payload.tipo_relacion || ''}">
      <input type="hidden" name="familiares_vive_junto[]" value="${payload.vive_junto ? '1':'0'}">
      <input type="hidden" name="familiares_es_responsable[]" value="${payload.es_responsable ? '1':'0'}">
      <input type="hidden" name="familiares_notas[]" value="${escapeHtml(payload.notas || '')}">
    `);
  });
}


function clearInline(){
  const { wrapper } = getSelectedMiembro();
  if (wrapper){
    const hidden = q('#id_familiar_miembro', wrapper);
    if (hidden) hidden.value = "";

    const chip = q('.autocomplete-chip', wrapper);
    if (chip) chip.style.display = "none";

    // 👇 ESTO ES LO QUE TE FALTABA
    const field = q('.autocomplete-field', wrapper);
    if (field) field.classList.remove('has-selection');

    const search = q('.autocomplete-search', wrapper);
    if (search) {
      search.value = "";
      search.style.display = "";     // vuelve a mostrarse
      search.focus();
    }

    // opcional: cerrar dropdown si quedó abierto
    const dd = q('.autocomplete-dropdown', wrapper);
    if (dd) dd.classList.remove('open');
  }

    const rel = q('#id_tipo_relacion');
    if (rel) rel.value = "";

    const vive = q('input[name="vive_junto"]');
    if (vive) vive.checked = false;

    const resp = q('input[name="es_responsable"]');
    if (resp) resp.checked = false;

    const notas = q('input[name="notas_familiar"]');
    if (notas) notas.value = "";
  }

  function addRow(payload){
    const tbody = q('#familiares-pendientes');
    if (!tbody) return;

    if (tbody.querySelector(`tr[data-miembro-id="${payload.id}"]`)){
      alert("Ese familiar ya está añadido en la lista.");
      return;
    }

    const tr = document.createElement('tr');
    tr.setAttribute('data-miembro-id', payload.id);
    tr.setAttribute('data-payload', JSON.stringify(payload));

    tr.innerHTML = `
      <td>
        ${escapeHtml(payload.nombre || '—')}
        ${payload.codigo ? `<div style="font-size:11px;color:#6c757d;">${escapeHtml(payload.codigo)}</div>` : ""}
      </td>
      <td>${escapeHtml(payload.tipo_relacion_label)}</td>
      <td>${payload.vive_junto ? "Sí" : "No"}</td>
      <td>
        <a href="javascript:void(0)" class="odoo-link-danger js-remove-familiar-line" title="Quitar">
          <span class="material-icons">delete</span>
        </a>
      </td>
    `;

    tbody.prepend(tr);
    buildHiddenFromRows();
  }

  document.addEventListener('click', (e) => {
    const rm = e.target.closest('.js-remove-familiar-line');
    if (!rm) return;

    const tr = rm.closest('tr');
    if (tr) tr.remove();
    buildHiddenFromRows();
  });

  document.addEventListener('DOMContentLoaded', () => {
    const btn = q('#btn-add-familiar-line');
    if (!btn) return;

    btn.addEventListener('click', () => {
      const sel = q('#id_tipo_relacion');
      const vive = q('input[name="vive_junto"]');
      const resp = q('input[name="es_responsable"]');
      const notas = q('input[name="notas_familiar"]');

      const { id, nombre, codigo } = getSelectedMiembro();
      if (!id){
        alert("Primero selecciona un miembro en el buscador.");
        return;
      }
      if (!sel || !sel.value){
        alert("Selecciona la relación.");
        return;
      }

      const payload = {
        id,
        nombre,
        codigo,
        tipo_relacion: sel.value,
        tipo_relacion_label: sel.options[sel.selectedIndex]?.textContent?.trim() || sel.value,
        vive_junto: !!(vive && vive.checked),
        es_responsable: !!(resp && resp.checked),
        notas: notas ? notas.value.trim() : ""
      };

      addRow(payload);
      clearInline();
      toggleFamiliarForm(false);
    });
  });

    // ====================================
    // AUTOCOMPLETE DE MIEMBROS - ESTILO CHIP
    // ====================================
    const searchInput = document.getElementById('search-persona');
    const dropdown = document.getElementById('dropdown-persona');
    const listEl = document.getElementById('list-persona');
    const emptyEl = document.getElementById('empty-persona');
    const loadingEl = document.getElementById('loading-persona');
    const hiddenInput = document.getElementById('id_persona_asociada');
    const fieldContainer = searchInput?.closest('.autocomplete-field');
    
    // Elementos del chip
    const chip = document.getElementById('chip-persona');
    const chipAvatar = document.getElementById('chip-avatar');
    const chipName = document.getElementById('chip-name');
    const chipCode = document.getElementById('chip-code');
    const chipRemove = document.getElementById('chip-remove');

    let debounceTimer = null;
    const DEBOUNCE_DELAY = 300;
    const MIN_CHARS = 2;

    // Obtener iniciales del nombre
    function getInitials(nombre) {
        if (!nombre) return '?';
        const parts = nombre.trim().split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[1][0]).toUpperCase();
        }
        return nombre.substring(0, 2).toUpperCase();
    }

    // Función para escapar HTML
    function escapeHtml(text) {
        if (!text) return '';
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Mostrar loading
    function showLoading() {
        listEl.innerHTML = '';
        listEl.style.display = 'none';
        emptyEl.style.display = 'none';
        loadingEl.style.display = 'block';
        dropdown.classList.add('open');
    }

    // Mostrar vacío
    function showEmpty() {
        listEl.innerHTML = '';
        listEl.style.display = 'none';
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
    }

    // Cerrar dropdown
    function closeDropdown() {
        dropdown.classList.remove('open');
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'none';
    }

    // Renderizar resultados
    function renderResults(resultados) {
        listEl.innerHTML = '';

        resultados.forEach(miembro => {
            const li = document.createElement('li');
            li.className = 'autocomplete-item';
            li.dataset.id = miembro.id;
            li.dataset.nombre = miembro.nombre;
            li.dataset.codigo = miembro.codigo || '';

            const initials = getInitials(miembro.nombre);

            li.innerHTML = `
                <div class="autocomplete-item-avatar">${initials}</div>
                <div class="autocomplete-item-info">
                    <div class="autocomplete-item-name">${escapeHtml(miembro.nombre)}</div>
                    <div class="autocomplete-item-meta">
                        ${miembro.codigo ? `<span class="autocomplete-item-code">${escapeHtml(miembro.codigo)}</span>` : ''}
                        ${miembro.telefono && miembro.telefono !== '—' ? `<span>${escapeHtml(miembro.telefono)}</span>` : ''}
                    </div>
                </div>
            `;

            li.addEventListener('click', function() {
                selectMiembro(miembro.id, miembro.nombre, miembro.codigo);
            });

            listEl.appendChild(li);
        });

        loadingEl.style.display = 'none';
        emptyEl.style.display = 'none';
        listEl.style.display = 'block';
    }

    // Seleccionar miembro - mostrar chip
    function selectMiembro(id, nombre, codigo) {
        // Guardar valor
        hiddenInput.value = id;
        
        // Actualizar chip
        chipAvatar.textContent = getInitials(nombre);
        chipName.textContent = nombre;
        chipCode.textContent = codigo || 'Sin código';
        
        // Mostrar chip, ocultar input
        chip.style.display = 'inline-flex';
        searchInput.value = '';
        searchInput.style.display = 'none';
        fieldContainer.classList.add('has-selection');
        
        // Cerrar dropdown
        closeDropdown();
    }

    // Limpiar selección
    function clearSelection() {
        hiddenInput.value = '';
        chip.style.display = 'none';
        searchInput.style.display = '';
        searchInput.value = '';
        fieldContainer.classList.remove('has-selection');
        listEl.innerHTML = '';
        closeDropdown();
        searchInput.focus();
    }

    // Buscar miembros
    async function searchMiembros(query) {
        query = query.trim();

        if (query.length < MIN_CHARS) {
            closeDropdown();
            return;
        }

        showLoading();

        try {
            const response = await fetch(
                `/api/buscar-miembros/?q=${encodeURIComponent(query)}&filtro=activos&limit=15`,
                {
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.resultados && data.resultados.length > 0) {
                renderResults(data.resultados);
            } else {
                showEmpty();
            }
        } catch (error) {
            console.error('Error en búsqueda:', error);
            showEmpty();
        }
    }

    // Event listeners
    if (searchInput) {
        // Búsqueda con debounce
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchMiembros(e.target.value);
            }, DEBOUNCE_DELAY);
        });

        // Focus abre dropdown si hay texto suficiente
        searchInput.addEventListener('focus', function() {
            if (this.value.length >= MIN_CHARS) {
                dropdown.classList.add('open');
            }
        });

        // Teclado
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDropdown();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const firstItem = listEl.querySelector('.autocomplete-item');
                if (firstItem) {
                    selectMiembro(
                        firstItem.dataset.id,
                        firstItem.dataset.nombre,
                        firstItem.dataset.codigo
                    );
                }
            }
        });
    }

    // Botón quitar chip
    if (chipRemove) {
        chipRemove.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearSelection();
        });
    }

    // Click fuera cierra dropdown
    document.addEventListener('click', function(e) {
        const wrapper = document.getElementById('autocomplete-persona');
        if (wrapper && !wrapper.contains(e.target)) {
            closeDropdown();
        }
    });

    // ====================================
    // MANEJO DE ARCHIVOS ADJUNTOS
    // ====================================
    const attachBtn = document.getElementById('attach-btn');
    const attachInput = document.getElementById('attachment-input');
    const attachList = document.getElementById('attach-list');
    
    let attachedFiles = [];

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'picture_as_pdf',
            'doc': 'description',
            'docx': 'description',
            'xls': 'table_chart',
            'xlsx': 'table_chart',
            'jpg': 'image',
            'jpeg': 'image',
            'png': 'image',
            'gif': 'image',
        };
        return icons[ext] || 'insert_drive_file';
    }

    function renderAttachments() {
        attachList.innerHTML = '';
        
        attachedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'odoo-attach-item';
            item.innerHTML = `
                <span class="material-icons">${getFileIcon(file.name)}</span>
                <span class="odoo-attach-item-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                <span class="odoo-attach-item-size">${formatFileSize(file.size)}</span>
                <button type="button" class="odoo-attach-remove" data-index="${index}" title="Quitar">
                    <span class="material-icons">close</span>
                </button>
            `;
            attachList.appendChild(item);
        });

        // Event listeners para botones de quitar
        attachList.querySelectorAll('.odoo-attach-remove').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                attachedFiles.splice(idx, 1);
                renderAttachments();
            });
        });
    }

    if (attachBtn && attachInput) {
        attachBtn.addEventListener('click', () => attachInput.click());
        
        attachInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files);
            attachedFiles = [...attachedFiles, ...newFiles];
            renderAttachments();
            this.value = ''; // Reset para permitir seleccionar el mismo archivo
        });
    }
    function addRow(payload){
    const tbody = q('#familiares-pendientes');
    if (!tbody) return;

    const currentId = parseInt(q('table.odoo-table[data-current-miembro-id]')?.dataset.currentMiembroId || "0", 10);
    const payloadId = parseInt(payload.id, 10);

    if (currentId && payloadId === currentId){
        alert("No puedes agregarte a ti mismo como familiar.");
        return;
    }

    if (tbody.querySelector(`tr[data-miembro-id="${payload.id}"]`)){
        alert("Ese familiar ya está añadido en la lista.");
        return;
    }

    // Si estaba el mensaje de “No hay familiares…”, lo quitamos
    const emptyRow = q('#familiares-empty-row');
    if (emptyRow) emptyRow.remove();

    const tr = document.createElement('tr');
    tr.setAttribute('data-miembro-id', payload.id);
    tr.setAttribute('data-payload', JSON.stringify(payload));

    tr.innerHTML = `
        <td>
        ${escapeHtml(payload.nombre || '—')}
        ${payload.codigo ? `<div style="font-size:11px;color:#6c757d;">${escapeHtml(payload.codigo)}</div>` : ""}
        </td>
        <td>${escapeHtml(payload.tipo_relacion_label)}</td>
        <td>${payload.vive_junto ? "Sí" : "No"}</td>
        <td>
        <a href="javascript:void(0)" class="odoo-link-danger js-remove-familiar-line" title="Quitar">
            <span class="material-icons">delete</span>
        </a>
        </td>
    `;

    tbody.prepend(tr);
    buildHiddenFromRows();
    }
     buildHiddenFromRows();
})();


</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tel = document.getElementById("id_telefono");
  const wa  = document.getElementById("id_whatsapp");

  // ✅ NUEVO
  const tel2 = document.getElementById("id_telefono_secundario");

  if (!tel || !wa) return;

  function digitsOnly(v) {
    return (v || "").replace(/\D/g, "");
  }

  function formatRD(d) {
    // si ponen 1 + 10 dígitos, tomamos solo los 10 de RD
    if (d.length === 11 && d.startsWith("1")) d = d.slice(1);
    d = d.slice(0, 10);

    const a = d.slice(0, 3);
    const b = d.slice(3, 6);
    const c = d.slice(6, 10);

    if (d.length <= 3) return a;
    if (d.length <= 6) return a + "-" + b;
    return a + "-" + b + "-" + c;
  }

  function toWhatsAppE164FromDigits(d) {
    if (d.length === 11 && d.startsWith("1")) d = d.slice(1);
    d = d.slice(0, 10);
    if (d.length === 10 && /^(809|829|849)/.test(d)) return "+1" + d;
    return "";
  }

  function normalizeWhatsAppInput(v) {
    const digits = digitsOnly(v);
    if (digits.length === 11 && digits.startsWith("1")) {
      const rd10 = digits.slice(1);
      return toWhatsAppE164FromDigits(rd10) || ("+" + digits);
    }
    if (digits.length === 10) {
      return toWhatsAppE164FromDigits(digits) || digits;
    }
    return digits ? ("+" + digits) : "";
  }

  let waEditado = false;

  function syncFromTelefono() {
    const d = digitsOnly(tel.value);
    tel.value = formatRD(d);

    if (!waEditado || !wa.value.trim()) {
      const dd = digitsOnly(tel.value);
      const e164 = toWhatsAppE164FromDigits(dd);
      if (e164) wa.value = e164;
    }
  }

  // ✅ NUEVO: mismo formato RD para teléfono secundario
  function syncTelefonoSecundario() {
    if (!tel2) return;
    const d = digitsOnly(tel2.value);
    tel2.value = formatRD(d);
  }

  tel.addEventListener("input", syncFromTelefono);
  tel.addEventListener("blur", syncFromTelefono);

  // ✅ NUEVO
  if (tel2) {
    tel2.addEventListener("input", syncTelefonoSecundario);
    tel2.addEventListener("blur", syncTelefonoSecundario);
    syncTelefonoSecundario(); // inicial
  }

  wa.addEventListener("input", function () {
    waEditado = true;
    wa.value = normalizeWhatsAppInput(wa.value);
  });

  wa.addEventListener("blur", function () {
    wa.value = normalizeWhatsAppInput(wa.value);
  });

  syncFromTelefono();
  if (wa.value && wa.value.trim()) wa.value = normalizeWhatsAppInput(wa.value);
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const inputCedula = document.getElementById("id_cedula");
  const feedback = document.getElementById("cedula_feedback");
  const form = inputCedula ? inputCedula.closest("form") : null;
  const submitBtn = form ? form.querySelector('button[type="submit"], input[type="submit"]') : null;

  // pk (si estás editando) para excluir el propio miembro
  const miembroPk = "{{ miembro.pk|default:'' }}";

  function setFeedback(text, type) {
    // type: "ok" | "warn" | "error"
    feedback.style.display = "block";
    feedback.textContent = text;

    // Reutilizamos tu clase hint, pero cambiamos color de forma simple
    feedback.style.fontSize = "12px";
    feedback.style.lineHeight = "1.2";

    if (type === "error") {
      feedback.style.color = "#dc3545";
    } else if (type === "warn") {
      feedback.style.color = "#e6a117";
    } else {
      feedback.style.color = "#28a745";
    }
  }

  function clearFeedback() {
    feedback.style.display = "none";
    feedback.textContent = "";
  }

  function setSubmitEnabled(enabled) {
    if (!submitBtn) return;
    submitBtn.disabled = !enabled;
  }

  let t = null;
  async function validateCedula() {
    const cedula = (inputCedula.value || "").trim();

    if (!cedula) {
      clearFeedback();
      setSubmitEnabled(true);
      return;
    }

    // Si quieres, aquí también puedes autoformatear, pero por ahora solo validamos.
    const url = "{% url 'miembros_app:ajax_validar_cedula' %}" + 
                "?cedula=" + encodeURIComponent(cedula) +
                "&pk=" + encodeURIComponent(miembroPk || "");

    try {
      const res = await fetch(url, { method: "GET" });
      const data = await res.json();

      if (!data.ok) {
        setFeedback("No se pudo validar ahora mismo.", "warn");
        setSubmitEnabled(true);
        return;
      }

      if (data.empty) {
        clearFeedback();
        setSubmitEnabled(true);
        return;
      }

      if (!data.valid_format) {
        setFeedback(data.message || "Formato inválido. Usa 000-0000000-0", "warn");
        setSubmitEnabled(true); // formato inválido, pero tú decides: si quieres bloquear, pon false
        return;
      }

      if (data.exists) {
        setFeedback(data.message || "Ya existe un miembro con esta cédula.", "error");
        setSubmitEnabled(false);
        return;
      }

      setFeedback(data.message || "Cédula disponible.", "ok");
      setSubmitEnabled(true);

    } catch (e) {
      setFeedback("No se pudo validar ahora mismo.", "warn");
      setSubmitEnabled(true);
    }
  }

  if (!inputCedula) return;

  inputCedula.addEventListener("input", function () {
    clearTimeout(t);
    t = setTimeout(validateCedula, 350); // debounce
  });

  inputCedula.addEventListener("blur", validateCedula);
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const pass = document.getElementById("id_pasaporte");
  if (!pass) return;

  function normalizePassport(v) {
    // mayúsculas, sin espacios, solo A-Z y 0-9, y límite razonable
    return (v || "")
      .toUpperCase()
      .replace(/\s+/g, "")
      .replace(/[^A-Z0-9]/g, "")
      .slice(0, 15);
  }

  pass.addEventListener("input", function () {
    const n = normalizePassport(pass.value);
    if (pass.value !== n) pass.value = n;
  });

  pass.addEventListener("blur", function () {
    pass.value = normalizePassport(pass.value);
  });

  // inicial
  pass.value = normalizePassport(pass.value);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // 🔍 buscamos el input por name (más seguro que por id fijo)
    const telInput = document.querySelector("input[name='telefono']");
    const errorBox = document.getElementById("telefono-error");
    const submitBtn = document.querySelector("button[type='submit']");

    if (!telInput || !errorBox || !submitBtn) return;

    let timer = null;

    function onlyDigits(v){
        return (v || "").replace(/\D/g, "");
    }

    telInput.addEventListener("input", function () {
        clearTimeout(timer);

        const value = onlyDigits(telInput.value);

        // si no llega a 10 dígitos, no validamos todavía
        if (value.length < 10) {
            errorBox.style.display = "none";
            submitBtn.disabled = false;
            return;
        }

        timer = setTimeout(() => {
            fetch(`/miembros/ajax/validar-telefono/?telefono=${value}`)
                .then(r => r.json())
                .then(data => {
                    if (data.existe) {
                        errorBox.style.display = "block";
                        submitBtn.disabled = true;
                    } else {
                        errorBox.style.display = "none";
                        submitBtn.disabled = false;
                    }
                })
                .catch(() => {
                    // si falla la llamada, no bloqueamos el formulario
                    submitBtn.disabled = false;
                });
        }, 450); // debounce
    });
});
</script>


{% endblock %}