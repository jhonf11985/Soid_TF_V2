{% extends 'core/base.html' %}

{% block title %}Mi perfil · Soid_Tf_2{% endblock %}

{% block breadcrumb %}
Mi perfil
{% endblock %}

{% block content %}

<section class="page-header">
    <div>
        <h1 class="page-title">Mi perfil</h1>
        <p class="page-subtitle">
            Información de tu cuenta en el sistema Soid_Tf_2.
        </p>
    </div>
</section>

<section class="page-section">
    <div class="perfil-layout">
        <!-- COLUMNA IZQUIERDA: FICHA -->
        <div class="perfil-card">
            <div class="perfil-header">
                <div class="perfil-avatar">
                    {{ usuario.first_name|default:usuario.username|first|upper }}
                </div>
                <div class="perfil-header-text">
                    <h2 class="perfil-nombre">
                        {{ usuario.get_full_name|default:usuario.username }}
                    </h2>
                    <p class="perfil-username">
                        @{{ usuario.username }}
                    </p>
                    <p class="perfil-rol">
                        {% if usuario.is_superuser %}
                            Administrador del sistema
                        {% elif usuario.is_staff %}
                            Usuario de equipo / staff
                        {% else %}
                            Usuario estándar
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="perfil-section">
                <h3>Datos de contacto</h3>
                <dl class="perfil-lista">
                    <div>
                        <dt>Correo electrónico</dt>
                        <dd>{{ usuario.email|default:"No definido" }}</dd>
                    </div>
                </dl>
            </div>

            <div class="perfil-section">
                <h3>Estado de la cuenta</h3>
                <dl class="perfil-lista">
                    <div>
                        <dt>Activo</dt>
                        <dd>
                            {% if usuario.is_active %}
                                Sí
                            {% else %}
                                No
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt>Puede acceder al sistema</dt>
                        <dd>
                            {% if usuario.is_staff %}
                                Sí (staff)
                            {% else %}
                                Solo áreas públicas
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>

            <div class="perfil-section">
                <h3>Roles / grupos</h3>
                {% with grupos=usuario.groups.all %}
                    {% if grupos %}
                        <ul class="perfil-tags">
                            {% for g in grupos %}
                                <li>{{ g.name }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="perfil-texto-secundario">
                            Este usuario no tiene grupos asignados todavía.
                        </p>
                    {% endif %}
                {% endwith %}
            </div>

            <div class="perfil-section" id="pushBox">
                <h3>Notificaciones (Push)</h3>

                <p class="perfil-texto-secundario" style="margin-top:6px;">
                    Actívalas para recibir avisos importantes del sistema incluso si no estás dentro de SOID.
                    Se activa solo para este dispositivo/navegador.
                </p>

                <dl class="perfil-lista" style="margin-top:10px;">
                    <div>
                        <dt>Estado en este dispositivo</dt>
                        <dd id="pushEstado">Comprobando…</dd>
                    </div>
                </dl>

                <div class="perfil-actions" style="margin-top:10px;">
                    <button type="button" class="btn btn-primary" id="btnPushActivar" disabled>
                        Activar notificaciones
                    </button>

                    <button type="button" class="btn btn-secondary" id="btnPushDesactivar" style="display:none;">
                        Desactivar
                    </button>
                </div>

                <p class="perfil-texto-secundario" id="pushMsg" style="margin-top:8px;"></p>
            </div>

            <div class="perfil-actions">
                <a href="{% url 'core:cambiar_contrasena' %}" class="btn btn-primary">
                    Cambiar contraseña
                </a>
            </div>
        </div>

        <!-- COLUMNA DERECHA: NOTAS / AYUDA -->
        <aside class="perfil-help-card">
            <h2>Sobre tu cuenta</h2>
            <p class="perfil-help-text">
                Tu usuario te permite acceder a los distintos módulos del sistema
                según los permisos y grupos que el administrador te haya asignado.
            </p>

            <ul class="perfil-help-list">
                <li>
                    <strong>Administradores</strong> pueden gestionar usuarios, configuración y módulos.
                </li>
                <li>
                    <strong>Secretaría</strong> suele registrar miembros y nuevos creyentes.
                </li>
                <li>
                    <strong>Consulta</strong> solo ve información, sin modificarla.
                </li>
            </ul>

            <div class="perfil-note">
                <p>
                    Si notas algo incorrecto en tus datos o necesitas más permisos,
                    habla con el administrador del sistema.
                </p>
            </div>
        </aside>
    </div>
</section>

<style>
    .perfil-layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
        gap: 18px;
        align-items: flex-start;
    }

    @media (max-width: 900px) {
        .perfil-layout {
            grid-template-columns: minmax(0, 1fr);
        }
    }

    .perfil-card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid var(--color-border-subtle);
        padding: 14px 16px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }

    .perfil-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
    }

    .perfil-avatar {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: #f3f4f6;
        border: 1px solid var(--color-border-subtle);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
        color: var(--color-primary);
        flex: 0 0 auto;
    }

    .perfil-header-text {
        min-width: 0;
    }

    .perfil-nombre {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-main);
        line-height: 1.25;
    }

    .perfil-username {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--color-text-muted);
    }

    .perfil-rol {
        margin: 2px 0 0;
        font-size: 11px;
        color: var(--color-text-muted);
    }

    .perfil-section {
        margin-top: 14px;
        padding-top: 10px;
        border-top: 1px solid var(--color-border-subtle);
    }

    .perfil-section h3 {
        margin: 0 0 6px;
        font-size: 12px;
        font-weight: 600;
        color: var(--color-text-main);
    }

    .perfil-lista {
        margin: 0;
        padding: 0;
    }

    .perfil-lista > div {
        margin-bottom: 6px;
    }

    .perfil-lista dt {
        font-size: 11px;
        color: var(--color-text-muted);
        margin: 0;
    }

    .perfil-lista dd {
        margin: 0;
        font-size: 13px;
        color: var(--color-text-main);
    }

    .perfil-tags {
        list-style: none;
        padding: 0;
        margin: 4px 0 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .perfil-tags li {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        background: #f3f4f6;
        color: var(--color-text-main);
        border: 1px solid var(--color-border-subtle);
    }

    .perfil-texto-secundario {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--color-text-muted);
    }

    .perfil-actions {
        margin-top: 14px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .perfil-help-card {
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid var(--color-border-subtle);
        padding: 12px 14px;
        font-size: 12px;
        color: var(--color-text-main);
    }

    .perfil-help-card h2 {
        margin: 0 0 6px;
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-main);
    }

    .perfil-help-text {
        margin: 0 0 10px;
        color: var(--color-text-muted);
    }

    .perfil-help-list {
        padding-left: 16px;
        margin: 0 0 12px;
        color: var(--color-text-main);
    }

    .perfil-help-list li {
        margin-bottom: 4px;
    }

    .perfil-note {
        padding: 8px 10px;
        border-radius: 8px;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        font-size: 11px;
        color: #1d4ed8;
    }
</style>

<script>
(function () {
    // =============================================
    // ELEMENTOS DEL DOM
    // =============================================
    const estadoEl = document.getElementById("pushEstado");
    const msgEl = document.getElementById("pushMsg");
    const btnOn = document.getElementById("btnPushActivar");
    const btnOff = document.getElementById("btnPushDesactivar");

    if (!estadoEl || !btnOn || !btnOff) {
        console.warn("[Push] Elementos del DOM no encontrados");
        return;
    }

    // =============================================
    // CONFIGURACIÓN
    // =============================================
    const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default:'' }}";
    const URL_PUSH_STATUS = "{% url 'notificaciones_app:push_status' %}";
    const URL_PUSH_SUBSCRIBE = "{% url 'notificaciones_app:push_subscribe' %}";
    const URL_PUSH_UNSUBSCRIBE = "{% url 'notificaciones_app:push_unsubscribe' %}";

    // =============================================
    // FUNCIONES AUXILIARES
    // =============================================
    function setUI(estado, textoExtra = "") {
        // estado: "activo" | "inactivo" | "no-soportado" | "cargando" | "error"
        btnOn.disabled = false;
        
        switch (estado) {
            case "activo":
                estadoEl.textContent = "Activadas ✅";
                btnOn.style.display = "none";
                btnOff.style.display = "inline-flex";
                break;
            case "inactivo":
                estadoEl.textContent = "Desactivadas";
                btnOn.style.display = "inline-flex";
                btnOff.style.display = "none";
                break;
            case "no-soportado":
                estadoEl.textContent = "No disponible";
                btnOn.style.display = "none";
                btnOff.style.display = "none";
                break;
            case "cargando":
                estadoEl.textContent = "Comprobando…";
                btnOn.disabled = true;
                break;
            case "error":
                estadoEl.textContent = "Error al comprobar";
                btnOn.style.display = "inline-flex";
                btnOff.style.display = "none";
                break;
        }
        
        msgEl.textContent = textoExtra || "";
    }

    function getCSRFToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : "";
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // =============================================
    // VERIFICAR SOPORTE
    // =============================================
    function checkSupport() {
        if (!("serviceWorker" in navigator)) {
            console.warn("[Push] Service Worker no soportado");
            return false;
        }
        if (!("PushManager" in window)) {
            console.warn("[Push] PushManager no soportado");
            return false;
        }
        if (!("Notification" in window)) {
            console.warn("[Push] Notifications no soportadas");
            return false;
        }
        return true;
    }

    // =============================================
    // CONSULTAR ESTADO EN SERVIDOR
    // =============================================
    async function fetchStatus() {
        setUI("cargando");

        // Verificar soporte del navegador
        if (!checkSupport()) {
            setUI("no-soportado", "Tu navegador no soporta notificaciones push.");
            return;
        }

        // Verificar VAPID key
        if (!VAPID_PUBLIC_KEY) {
            setUI("error", "Configuración incompleta en el servidor (VAPID).");
            console.error("[Push] VAPID_PUBLIC_KEY vacía");
            return;
        }

        try {
            // Esperar a que el SW esté listo
            await navigator.serviceWorker.ready;
            
            const res = await fetch(URL_PUSH_STATUS, { 
                credentials: "same-origin",
                headers: {
                    "Accept": "application/json"
                }
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            
            if (data.activo) {
                setUI("activo");
            } else {
                setUI("inactivo");
            }
        } catch (err) {
            console.error("[Push] Error en fetchStatus:", err);
            setUI("error", "No se pudo verificar el estado.");
        }
    }

    // =============================================
    // ACTIVAR NOTIFICACIONES
    // =============================================
    async function activar() {
        msgEl.textContent = "";
        btnOn.disabled = true;
        btnOn.textContent = "Activando...";

        try {
            // 1. Verificar soporte
            if (!checkSupport()) {
                setUI("no-soportado", "Tu navegador no soporta notificaciones push.");
                return;
            }

            // 2. Verificar VAPID
            if (!VAPID_PUBLIC_KEY) {
                setUI("error", "Falta configuración VAPID en el servidor.");
                return;
            }

            // 3. Solicitar permiso
            const permiso = await Notification.requestPermission();
            if (permiso !== "granted") {
                setUI("inactivo", "Permiso denegado. Puedes activarlo desde la configuración del navegador.");
                btnOn.textContent = "Activar notificaciones";
                return;
            }

            // 4. Obtener registro del SW
            const registration = await navigator.serviceWorker.ready;

            // 5. Suscribirse a push
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
            });

            // 6. Enviar suscripción al servidor
            const res = await fetch(URL_PUSH_SUBSCRIBE, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify(subscription.toJSON()),
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();

            if (data.ok) {
                setUI("activo", "¡Listo! Recibirás notificaciones en este dispositivo.");
            } else {
                setUI("inactivo", data.error || "No se pudo guardar la suscripción.");
            }
        } catch (err) {
            console.error("[Push] Error al activar:", err);
            setUI("inactivo", `Error: ${err.message || "No se pudo activar"}`);
        } finally {
            btnOn.textContent = "Activar notificaciones";
            btnOn.disabled = false;
        }
    }

    // =============================================
    // DESACTIVAR NOTIFICACIONES
    // =============================================
// =============================================
    // DESACTIVAR NOTIFICACIONES
    // =============================================
    async function desactivar() {
        msgEl.textContent = "";
        btnOff.disabled = true;
        btnOff.textContent = "Desactivando...";

        try {
            let endpoint = "";
            
            // 1. Obtener endpoint y desuscribir del navegador
            if ("serviceWorker" in navigator) {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    endpoint = subscription.endpoint;
                    await subscription.unsubscribe();
                }
            }

            // 2. Notificar al servidor con el endpoint
            const res = await fetch(URL_PUSH_UNSUBSCRIBE, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                    "Accept": "application/json"
                },
                body: JSON.stringify({ endpoint: endpoint })
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();

            if (data.ok) {
                setUI("inactivo", "Notificaciones desactivadas en este dispositivo.");
            } else {
                setUI("activo", data.error || "No se pudo desactivar en el servidor.");
            }
        } catch (err) {
            console.error("[Push] Error al desactivar:", err);
            setUI("activo", `Error: ${err.message || "No se pudo desactivar"}`);
        } finally {
            btnOff.textContent = "Desactivar";
            btnOff.disabled = false;
        }
    }

    // =============================================
    // EVENT LISTENERS
    // =============================================
    btnOn.addEventListener("click", activar);
    btnOff.addEventListener("click", desactivar);

    // =============================================
    // INICIALIZAR
    // =============================================
    // Esperar a que el DOM esté completamente listo
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", fetchStatus);
    } else {
        // Pequeño delay para asegurar que el SW se registre primero
        setTimeout(fetchStatus, 500);
    }
})();
</script>

{% endblock %}