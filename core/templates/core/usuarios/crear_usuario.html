{% extends 'core/base.html' %}
{% load static %}

{% block title %}Crear usuario ¬∑ Soid_Tf_2{% endblock %}

{% block content %}
<form method="post" class="odoo-form">
  {% csrf_token %}

  {% if messages %}
    <div class="odoo-messages">
      {% for message in messages %}
        <div class="odoo-alert odoo-alert-{{ message.tags|default:'info' }}">
          <span class="material-icons">
            {% if 'success' in message.tags %}check_circle{% elif 'error' in message.tags or 'danger' in message.tags %}error{% else %}info{% endif %}
          </span>
          <div class="odoo-alert-text">{{ message }}</div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.non_field_errors %}
    <div class="odoo-form-errors">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <div class="odoo-control-bar">
    <div class="odoo-control-left">
      <a href="javascript:history.back()" class="odoo-breadcrumb-link">
        <span class="material-icons">arrow_back</span>
        Usuarios
      </a>
      <span class="odoo-breadcrumb-sep">/</span>
<span class="odoo-breadcrumb-current">
  {% if modo_edicion %}Editar{% else %}Nuevo{% endif %}
</span>

{% if not modo_edicion %}
<span class="odoo-new-badge">Nuevo</span>
{% endif %}

    </div>
  </div>

  <div class="odoo-form-container">
    <div class="odoo-form-main">

      <div class="odoo-form-header">
        <div class="odoo-avatar-section">
          <div class="odoo-avatar">
            <span class="material-icons odoo-avatar-icon">person_add</span>
          </div>
        </div>

        <div class="odoo-header-info">
          <div class="odoo-name-field">
            {{ form.first_name }}
            {{ form.last_name }}
          </div>

          {{ form.override_nombre }}

          <!-- Vincular a miembro (Autocomplete) - debajo del nombre -->
          <div class="odoo-member-link">
            <span class="material-icons">person_search</span>
            <div class="autocomplete-wrapper"
                 data-autocomplete-id="id_miembro_id"
                 data-endpoint="/api/buscar-miembros/"
                 data-filtro="sin_usuario"
                 data-limit="15"
                 data-min-chars="2"
                 data-debounce="300">

              {{ form.miembro_id }}
              {% if form.miembro_id.errors %}
                <div class="odoo-field-error" style="margin-top:8px;">{{ form.miembro_id.errors.0 }}</div>
              {% endif %}

              <div class="autocomplete-field">
                <div class="autocomplete-chip" style="display:none;">
                  <span class="chip-avatar">M</span>
                  <span class="chip-text">
                    <span class="chip-name">‚Äî</span>
                    <span class="chip-code">‚Äî</span>
                  </span>
                  <button type="button" class="chip-remove" title="Quitar">
                    <span class="material-icons">close</span>
                  </button>
                </div>

                <input type="text"
                       class="autocomplete-search"
                       placeholder="Vincular a miembro existente..."
                       autocomplete="off">
              </div>

              <div class="autocomplete-dropdown">
                <ul class="autocomplete-list"></ul>
                <div class="autocomplete-empty" style="display:none;">
                  <span class="material-icons">person_search</span>
                  <p>No se encontraron miembros</p>
                </div>
                <div class="autocomplete-loading" style="display:none;">
                  <span class="material-icons spinner">sync</span>
                  <p>Buscando‚Ä¶</p>
                </div>
              </div>
            </div>
          </div>

<div class="odoo-quick-fields">
  <div class="odoo-quick-field">
    <span class="material-icons">email</span>
    {{ form.email }}
  </div>

  {% if form.email.errors %}
    <div class="odoo-field-error">{{ form.email.errors.0 }}</div>
  {% elif form.miembro_id.value %}
    <div class="email-status ok" style="display:block;">
      <span class="material-icons">link</span>
      Email del miembro vinculado (puedes modificarlo).
    </div>
  {% else %}
    <div id="email-status" class="email-status" style="display:none;"></div>
  {% endif %}
</div>

          </div>
        </div>
     
      

      <div class="odoo-form-body">
        <div class="odoo-form-column">
          <h3 class="odoo-section-title">Credenciales</h3>

          <div class="odoo-field">
            <label class="odoo-label">Nombre de usuario</label>
            {{ form.username }}
            <small class="odoo-help">Sin espacios. Recomendado: nombre.apellido</small>
            {% if form.username.errors %}
              <div class="odoo-field-error">{{ form.username.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="odoo-field">
            <label class="odoo-label">Rol / Grupo</label>
            {{ form.grupo }}
            <small class="odoo-help">Define los permisos del usuario dentro del sistema.</small>
            {% if form.grupo.errors %}
              <div class="odoo-field-error">{{ form.grupo.errors.0 }}</div>
            {% endif %}
          </div>
        </div>

        {% if not modo_edicion %}
  <div class="odoo-form-column">
    <h3 class="odoo-section-title">Seguridad</h3>

    <div class="odoo-field">
      <label class="odoo-label">Contrase√±a</label>
      {{ form.password1 }}
      <small class="odoo-help">Usa una contrase√±a segura (m√≠nimo 8 caracteres, n√∫meros y may√∫sculas).</small>
      {% if form.password1.errors %}
        <div class="odoo-field-error">{{ form.password1.errors.0 }}</div>
      {% endif %}
    </div>

    <div class="odoo-field">
      <label class="odoo-label">Repetir contrase√±a</label>
      {{ form.password2 }}
      <small class="odoo-help">Debe coincidir exactamente con la contrase√±a.</small>
      {% if form.password2.errors %}
        <div class="odoo-field-error">{{ form.password2.errors.0 }}</div>
      {% endif %}
    </div>
  </div>
{% else %}
  <div class="odoo-form-column">
    <h3 class="odoo-section-title">Seguridad</h3>
    <div class="odoo-field">
      <div class="odoo-help">
        La contrase√±a no se edita aqu√≠. Para cambiarla, usa la opci√≥n "Cambiar contrase√±a" del usuario (o crea un flujo admin espec√≠fico).
      </div>
    </div>
  </div>
{% endif %}

      </div>

      <!-- =========================================
           üÜï SECCI√ìN USUARIO TEMPORAL
           ========================================= -->
      {% if not modo_edicion %}
      <div class="odoo-form-body" style="margin-top: 0; padding-top: 0;">
        <div class="odoo-form-column" style="grid-column: 1 / -1;">
          <h3 class="odoo-section-title">
            <span class="material-icons" style="font-size: 20px; vertical-align: -4px; margin-right: 6px;">schedule</span>
            Acceso Temporal
          </h3>

          <div class="odoo-field">
            <label class="odoo-checkbox-label">
              {{ form.es_temporal }}
              <span class="checkbox-text">
                <strong>Usuario temporal / de prueba</strong>
                <small class="odoo-help" style="display: block; margin-top: 2px;">
                  El acceso se desactivar√° autom√°ticamente cuando expire.
                </small>
              </span>
            </label>
          </div>

          <!-- Campos que aparecen solo si es temporal -->
          <div id="campos-temporal" class="campos-temporal" style="display: none;">
            <div class="odoo-field-row">
              <div class="odoo-field" style="flex: 1;">
                <label class="odoo-label">Expira en</label>
                {{ form.dias_expiracion }}
              </div>
              <div class="odoo-field" style="flex: 1;">
                <label class="odoo-label">Motivo</label>
                {{ form.motivo_temporal }}
              </div>
            </div>
            
            <div class="temporal-info-box">
              <span class="material-icons">info</span>
              <div>
                <strong>Usuario de prueba</strong>
                <p>Este usuario podr√° acceder al sistema con todas las funciones hasta que expire. Despu√©s se desactivar√° autom√°ticamente.</p>
              </div>
            </div>
          </div>

        </div>
      </div>
      {% endif %}
      <!-- FIN SECCI√ìN TEMPORAL -->

    </div>

    <div class="odoo-form-aside">
      <div class="odoo-aside-actions">
        <button type="submit" class="odoo-btn odoo-btn-primary">
          <span class="material-icons">save</span> Guardar Usuario
        </button>
        <a href="javascript:history.back()" id="btn-descartar" class="odoo-btn odoo-btn-secondary">Descartar</a>
      </div>
    </div>
  </div>

  <!-- Acciones m√≥vil tipo app -->
  <div class="odoo-mobile-actions" aria-label="Acciones">
    <button type="submit" class="odoo-btn odoo-btn-primary odoo-mobile-save">
      <span class="material-icons">save</span> Guardar
    </button>
    <a href="javascript:history.back()" id="btn-descartar-mobile" class="odoo-btn odoo-btn-secondary odoo-mobile-cancel">
      Cancelar
    </a>
  </div>
</form>

<style>

    .email-status{
  margin-top: 6px;
  font-size: 12px;
  line-height: 1.2;
}
.email-status.ok{ color: #14532d; }
.email-status.bad{ color: #991b1b; }
.email-status.wait{ color: #6b7280; }
.email-status .material-icons{
  font-size: 16px;
  vertical-align: -3px;
  margin-right: 6px;
}

  :root{
    --odoo-primary: #714B67;
    --odoo-primary-hover: #5a3c52;

    --odoo-secondary-bg: #ffffff;
    --odoo-secondary-border: #d1d5db;
    --odoo-secondary-text: #111827;
    --odoo-secondary-hover: #f3f4f6;
  }

  /* ===== Mensajes ===== */
  .odoo-messages{
    margin: 12px 20px 0;
    display: grid;
    gap: 10px;
  }

  .odoo-alert{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid var(--color-border-subtle);
    background: #fff;
    font-size: 13px;
  }

  .odoo-alert .material-icons{
    font-size: 20px;
    margin-top: 1px;
  }

  .odoo-alert-success{
    border-color: #86efac;
    background: #f0fdf4;
  }
  .odoo-alert-success .material-icons{ color: #16a34a; }

  .odoo-alert-error, .odoo-alert-danger{
    border-color: #fca5a5;
    background: #fef2f2;
  }
  .odoo-alert-error .material-icons,
  .odoo-alert-danger .material-icons{ color: #dc2626; }

  .odoo-alert-info{
    border-color: #93c5fd;
    background: #eff6ff;
  }
  .odoo-alert-info .material-icons{ color: #2563eb; }

  .odoo-alert-warning{
    border-color: #fcd34d;
    background: #fffbeb;
  }
  .odoo-alert-warning .material-icons{ color: #d97706; }

  /* ===== üÜï ESTILOS SECCI√ìN TEMPORAL ===== */
  .odoo-checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fafafa;
    transition: all 0.2s;
  }

  .odoo-checkbox-label:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .odoo-checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    accent-color: var(--odoo-primary);
    cursor: pointer;
  }

  .odoo-checkbox-label .checkbox-text {
    flex: 1;
  }

  .odoo-checkbox-label .checkbox-text strong {
    color: #111827;
    font-size: 14px;
  }

  .campos-temporal {
    margin-top: 16px;
    padding: 16px;
    background: #fefce8;
    border: 1px solid #fde047;
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .odoo-field-row {
    display: flex;
    gap: 16px;
  }

  @media (max-width: 600px) {
    .odoo-field-row {
      flex-direction: column;
      gap: 12px;
    }
  }

  .temporal-info-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-top: 16px;
    padding: 12px;
    background: #fef9c3;
    border-radius: 6px;
  }

  .temporal-info-box .material-icons {
    color: #ca8a04;
    font-size: 20px;
    margin-top: 2px;
  }

  .temporal-info-box strong {
    color: #854d0e;
    font-size: 13px;
  }

  .temporal-info-box p {
    margin: 4px 0 0;
    font-size: 12px;
    color: #713f12;
    line-height: 1.4;
  }

  /* Cuando est√° marcado el checkbox */
  .odoo-checkbox-label:has(input:checked) {
    background: #fef9c3;
    border-color: #facc15;
  }

  /* ===== Resto de estilos existentes ===== */
  .odoo-control-bar{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .odoo-control-left{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .odoo-breadcrumb-link{
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: var(--odoo-primary);
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
  }
  .odoo-breadcrumb-link:hover{ text-decoration: underline; }

  .odoo-breadcrumb-sep{ color: #9ca3af; }

  .odoo-breadcrumb-current{
    font-weight: 600;
    color: #111827;
  }

  .odoo-new-badge{
    background: #dbeafe;
    color: #1d4ed8;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 999px;
    margin-left: 6px;
  }

  /* Container principal */
  .odoo-form-container{
    display: flex;
    gap: 24px;
    padding: 20px;
    max-width: 1100px;
    margin: 0 auto;
  }

  .odoo-form-main{
    flex: 1;
    background: #fff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  /* Header con avatar */
  .odoo-form-header{
    display: flex;
    gap: 20px;
    padding: 24px;
    border-bottom: 1px solid #f3f4f6;
  }

  .odoo-avatar-section{ flex-shrink: 0; }

  .odoo-avatar{
    width: 80px;
    height: 80px;
    border-radius: 12px;
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .odoo-avatar-icon{
    font-size: 36px;
    color: var(--odoo-primary);
  }

  .odoo-header-info{ flex: 1; }

  .odoo-name-field{
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }

  .odoo-name-field input{
    flex: 1;
    font-size: 18px;
    font-weight: 600;
    padding: 8px 12px;
    border: 1px solid transparent;
    border-radius: 6px;
    background: #f9fafb;
  }
  .odoo-name-field input:focus{
    outline: none;
    border-color: var(--odoo-primary);
    background: #fff;
  }

  /* Link a miembro */
  .odoo-member-link{
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 12px;
  }
  .odoo-member-link > .material-icons{
    color: #9ca3af;
    margin-top: 8px;
  }

  .odoo-quick-fields{
    margin-top: 8px;
  }
  .odoo-quick-field{
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .odoo-quick-field .material-icons{
    color: #9ca3af;
    font-size: 20px;
  }
  .odoo-quick-field input{
    flex: 1;
    padding: 6px 10px;
    border: 1px solid transparent;
    border-radius: 4px;
    font-size: 14px;
  }
  .odoo-quick-field input:focus{
    outline: none;
    border-color: var(--odoo-primary);
    background: #fff;
  }

  /* Body del form */
  .odoo-form-body{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    padding: 24px;
  }

  .odoo-form-column{}

  .odoo-section-title{
    font-size: 14px;
    font-weight: 600;
    color: var(--odoo-primary);
    margin: 0 0 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #f3e8ff;
  }

  .odoo-field{
    margin-bottom: 16px;
  }

  .odoo-label{
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
  }

  .odoo-field input,
  .odoo-field select{
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .odoo-field input:focus,
  .odoo-field select:focus{
    outline: none;
    border-color: var(--odoo-primary);
    box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.1);
  }

  .odoo-help{
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
  }

  .odoo-field-error{
    font-size: 12px;
    color: #dc2626;
    margin-top: 4px;
  }

  /* Aside */
  .odoo-form-aside{
    width: 200px;
    flex-shrink: 0;
  }

  .odoo-aside-actions{
    position: sticky;
    top: 80px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .odoo-btn{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
  }

  .odoo-btn-primary{
    background: var(--odoo-primary);
    color: #fff;
  }
  .odoo-btn-primary:hover{
    background: var(--odoo-primary-hover);
  }

  .odoo-btn-secondary{
    background: var(--odoo-secondary-bg);
    color: var(--odoo-secondary-text);
    border: 1px solid var(--odoo-secondary-border);
  }
  .odoo-btn-secondary:hover{
    background: var(--odoo-secondary-hover);
  }

  /* Mobile actions */
  .odoo-mobile-actions{
    display: none;
  }

  @media (max-width: 768px){
    .odoo-form-aside{ display: none; }

    .odoo-mobile-actions{
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      position: sticky;
      bottom: 0;
      z-index: 50;
    }

    .odoo-mobile-save{ flex: 2; }
    .odoo-mobile-cancel{ flex: 1; }

    .odoo-form-header{
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .odoo-name-field{
      flex-direction: column;
    }

    .odoo-form-container{
      padding: 12px;
    }
  }

  /* Autocomplete styles */
  .autocomplete-wrapper{
    flex: 1;
    position: relative;
  }

  .autocomplete-field{
    position: relative;
  }

  .autocomplete-search{
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }
  .autocomplete-search:focus{
    outline: none;
    border-color: var(--odoo-primary);
  }

  .autocomplete-chip{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: #f3e8ff;
    border-radius: 20px;
    font-size: 13px;
  }

  .chip-avatar{
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--odoo-primary);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
  }

  .chip-text{
    display: flex;
    flex-direction: column;
    line-height: 1.2;
  }

  .chip-name{ font-weight: 500; }
  .chip-code{ font-size: 11px; color: #6b7280; }

  .chip-remove{
    background: none;
    border: none;
    padding: 2px;
    cursor: pointer;
    color: #9ca3af;
    display: flex;
  }
  .chip-remove:hover{ color: #dc2626; }
  .chip-remove .material-icons{ font-size: 16px; }

  .autocomplete-dropdown{
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    max-height: 280px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }

  .autocomplete-list{
    list-style: none;
    margin: 0;
    padding: 4px;
  }

  .autocomplete-list li{
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
  }
  .autocomplete-list li:hover{
    background: #f3f4f6;
  }

  .autocomplete-empty,
  .autocomplete-loading{
    padding: 20px;
    text-align: center;
    color: #6b7280;
  }
  .autocomplete-empty .material-icons,
  .autocomplete-loading .material-icons{
    font-size: 32px;
    margin-bottom: 8px;
    display: block;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { animation: spin 1s linear infinite; }

</style>

<script>
(function(){
  const form = document.querySelector('.odoo-form');
  const emailInput = document.getElementById('id_email');
  const statusEl = document.getElementById('email-status');
  const btnSubmitDesktop = document.querySelector('.odoo-aside-actions .odoo-btn-primary');
  const btnSubmitMobile = document.querySelector('.odoo-mobile-save');
  const btnCancelDesktop = document.getElementById('btn-descartar');
  const btnCancelMobile = document.getElementById('btn-descartar-mobile');

  // =========================================
  // üÜï TOGGLE CAMPOS TEMPORALES
  // =========================================
  const checkboxTemporal = document.getElementById('id_es_temporal');
  const camposTemporal = document.getElementById('campos-temporal');

  function toggleCamposTemporal() {
    if (!checkboxTemporal || !camposTemporal) return;
    
    if (checkboxTemporal.checked) {
      camposTemporal.style.display = 'block';
    } else {
      camposTemporal.style.display = 'none';
    }
  }

  if (checkboxTemporal) {
    checkboxTemporal.addEventListener('change', toggleCamposTemporal);
    // Ejecutar al cargar por si viene con valor previo
    toggleCamposTemporal();
  }
  // =========================================

  // =========================
  // Dirty tracking
  // =========================
  let isDirty = false;
  let suppressDirty = false;
  const miembroHidden = document.getElementById('id_miembro_id');

  form.addEventListener('input', () => {
    if (!suppressDirty) isDirty = true;
  });
  form.addEventListener('change', () => {
    if (!suppressDirty) isDirty = true;
  });

  function runWithoutDirty(fn){
    suppressDirty = true;
    fn();
    setTimeout(() => { suppressDirty = false; }, 0);
  }

  // Para el autocomplete de miembros
  if (miembroHidden){
    let lastMiembroId = miembroHidden.value || "";
    setInterval(() => {
      const v = miembroHidden.value || "";
      if (v === lastMiembroId) return;
      lastMiembroId = v;
      runWithoutDirty(() => {});
    }, 250);
  }

  // Eventos custom si quieres dispararlos desde tu autocomplete (opcional)
  document.addEventListener("soid_autofill_start", () => { suppressDirty = true; });
  document.addEventListener("soid_autofill_end", () => {
    setTimeout(() => { suppressDirty = false; }, 0);
  });

  function confirmExit(e){
    if (!isDirty) return;
    const ok = confirm("Tienes cambios sin guardar. ¬øSeguro que quieres salir?");
    if (!ok) e.preventDefault();
  }

  if (btnCancelDesktop) btnCancelDesktop.addEventListener("click", confirmExit);
  if (btnCancelMobile)  btnCancelMobile.addEventListener("click", confirmExit);

  window.addEventListener("beforeunload", function(e){
    if (!isDirty) return;
    e.preventDefault();
    e.returnValue = "";
  });

  // =========================
  // UX bot√≥n guardar (spinner)
  // =========================
  function lockButton(btn, text){
    if (!btn) return;
    btn.disabled = true;
    btn.setAttribute("aria-disabled", "true");
    btn.style.opacity = "0.78";
    btn.style.cursor = "not-allowed";

    if (!btn.dataset.originalHtml){
      btn.dataset.originalHtml = btn.innerHTML;
    }

    btn.innerHTML = `
      <span class="material-icons spinner" style="font-size:18px;">sync</span>
      ${text || "Guardando."}
    `;
  }

  function lockCancel(btn){
    if (!btn) return;
    btn.style.pointerEvents = "none";
    btn.style.opacity = "0.6";
  }

  // =========================
  // Validaci√≥n de email realtime
  // =========================
  function setStatus(type, text){
    if (!statusEl) return;

    if (!text){
      statusEl.style.display = "none";
      statusEl.className = "email-status";
      statusEl.textContent = "";
      return;
    }

    statusEl.style.display = "block";
    statusEl.className = "email-status " + type;

    let icon = "info";
    if (type === "ok") icon = "check_circle";
    if (type === "bad") icon = "error";
    if (type === "wait") icon = "hourglass_top";

    statusEl.innerHTML = `<span class="material-icons">${icon}</span>${text}`;
  }

  function isValidEmailFormat(value){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }

  let emailTimer = null;
  let lastChecked = "";
  let pending = false;
  let ctrl = null;
  let lastAvailable = true;

  async function checkEmailNow(){
    if (!emailInput) return true;

    const raw = (emailInput.value || "").trim();
    const email = raw.toLowerCase();

    if (!email){
      pending = false;
      lastChecked = "";
      lastAvailable = true;
      setStatus("", "");
      return true;
    }

    if (!isValidEmailFormat(email)){
      pending = false;
      lastChecked = "";
      lastAvailable = false;
      setStatus("bad", "Formato de correo no v√°lido.");
      return false;
    }

    if (email === lastChecked && !pending){
      if (lastAvailable) setStatus("ok", "Correo disponible.");
      else setStatus("bad", "Ya existe un usuario con este correo.");
      return lastAvailable;
    }

    if (ctrl) ctrl.abort();
    ctrl = new AbortController();

    pending = true;
    setStatus("wait", "Comprobando correo‚Ä¶");

    try{
      const excludeId = "{{ usuario_obj.id|default:'' }}";

      const url = excludeId
        ? `/api/email-disponible/?email=${encodeURIComponent(email)}&exclude_id=${excludeId}`
        : `/api/email-disponible/?email=${encodeURIComponent(email)}`;

            const res = await fetch(url, {
        method: "GET",
        credentials: "same-origin",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        signal: ctrl.signal
      });

      if (!res.ok){
        pending = false;
        lastChecked = email;
        lastAvailable = false;
        setStatus("bad", "No se pudo validar el correo (servidor).");
        return false;
      }

      const data = await res.json();
      pending = false;
      lastChecked = email;

      if (data && data.success && data.available){
        lastAvailable = true;
        setStatus("ok", data.message || "Correo disponible.");
        return true;
      } else {
        lastAvailable = false;
        setStatus("bad", (data && data.message) ? data.message : "Este correo ya est√° en uso.");
        return false;
      }

    } catch(e){
      if (e && e.name === "AbortError") return false;
      pending = false;
      lastChecked = email;
      lastAvailable = false;
      setStatus("bad", "No se pudo validar el correo (sin conexi√≥n).");
      return false;
    }
  }

  if (emailInput){
    emailInput.addEventListener("input", function(){
      if (emailTimer) clearTimeout(emailTimer);
      emailTimer = setTimeout(checkEmailNow, 350);
    });

    emailInput.addEventListener("blur", function(){
      if (emailTimer) clearTimeout(emailTimer);
      checkEmailNow();
    });
  }

  // =========================
  // Submit control (lo m√°s importante)
  // =========================
  let allowNextSubmit = false;
  
  // Detectar si estamos en modo edici√≥n
  const modoEdicion = document.querySelector('.odoo-breadcrumb-current')?.textContent?.trim() === 'Editar';

  form.addEventListener("submit", async function(e){
    // Si reenviamos nosotros mismos, dejar pasar
    if (allowNextSubmit){
      allowNextSubmit = false;
      return;
    }

    // Si HTML5 detecta inv√°lidos, no ponemos spinner aqu√≠
    if (typeof form.checkValidity === "function" && !form.checkValidity()){
      return;
    }

    // EN MODO EDICI√ìN: confiar en el backend, no validar email aqu√≠
    if (modoEdicion) {
      isDirty = false;
      lockButton(btnSubmitDesktop, "Guardando...");
      lockButton(btnSubmitMobile, "Guardando...");
      lockCancel(btnCancelDesktop);
      lockCancel(btnCancelMobile);
      return; // Dejar que el form se env√≠e normalmente
    }

    // Validar email antes de enviar
    if (emailInput){
      const raw = (emailInput.value || "").trim();
      const current = raw.toLowerCase();

      if (raw){
        if (pending){
          e.preventDefault();
          setStatus("wait", "Espera a que termine la validaci√≥n del correo‚Ä¶");
          return;
        }

        if (current !== lastChecked){
          e.preventDefault();
          const ok = await checkEmailNow();
          if (!ok){
            emailInput.focus();
            return;
          }

          allowNextSubmit = true;
          if (typeof form.requestSubmit === "function") form.requestSubmit();
          else form.submit();
          return;
        }

        if (!lastAvailable){
          e.preventDefault();
          emailInput.focus();
          return;
        }
      }
    }

    // ‚úÖ Si llegamos aqu√≠, el submit S√ç VA A SALIR
    isDirty = false;

    lockButton(btnSubmitDesktop, "Guardando.");
    lockButton(btnSubmitMobile,  "Guardando.");
    lockCancel(btnCancelDesktop);
    lockCancel(btnCancelMobile);

  }, true); // capture=true => corre antes y evita "cargando infinito"

})();
</script>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { animation: spin 1s linear infinite; }
</style>



{% endblock %}