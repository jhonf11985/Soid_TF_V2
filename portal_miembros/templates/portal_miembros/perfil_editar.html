{% extends "core/base_sidebar.html" %}
{% load static %}

{% block content %}
<style>
  :root {
    --primary: #5c9ead;
    --primary-dark: #4a8a99;
    --primary-light: #e8f4f6;
    --primary-rgb: 92, 158, 173;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BASE & CONTENEDOR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pm-wrap{max-width:800px;margin:0 auto;padding:12px}
  .pm-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.06)}
  
  /* Header */
  .pm-header{padding:16px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff}
  .pm-header h1{font-size:18px;font-weight:800;margin:0}
  .pm-header p{margin:4px 0 0;font-size:13px;opacity:.9}
  .pm-nav{display:flex;gap:8px;margin-top:12px}
  .pm-nav a{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(255,255,255,.2);color:#fff;text-decoration:none;border-radius:8px;font-size:13px;font-weight:600;transition:background .2s}
  .pm-nav a:hover{background:rgba(255,255,255,.35)}

  /* Errores */
  .pm-errors{background:#fef2f2;border-bottom:1px solid #fecaca;color:#991b1b;padding:12px 16px;font-size:13px}
  .pm-errors strong{display:block;margin-bottom:6px}
  .pm-errors ul{margin:0;padding-left:18px}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIONES COLAPSABLES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pm-section{border-bottom:1px solid #e5e7eb}
  .pm-section:last-child{border-bottom:none}

  .pm-section-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 16px;
    background:#f9fafb;
    cursor:pointer;
    user-select:none;
    transition:background .2s
  }
  .pm-section-header:hover{background:#f3f4f6}
  .pm-section-header:active{background:#e5e7eb}

  .pm-section.open .pm-section-header{background:var(--primary-light)}

  .pm-section-title{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:15px;
    font-weight:700;
    color:#111827;
    margin:0
  }
  .pm-section-title .icon{font-size:20px}

  .pm-section-toggle{
    width:28px;
    height:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#e5e7eb;
    border-radius:50%;
    transition:transform .3s,background .2s
  }
  .pm-section.open .pm-section-toggle{background:var(--primary)}
  .pm-section-toggle svg{
    width:16px;
    height:16px;
    color:#6b7280;
    transition:color .2s,transform .3s
  }
  .pm-section.open .pm-section-toggle svg{color:#fff;transform:rotate(180deg)}

  .pm-section-body{
    display:none;
    padding:16px;
    background:#fff
  }
  .pm-section.open .pm-section-body{display:block}

  /* SecciÃ³n siempre abierta (Datos bÃ¡sicos) */
  .pm-section.always-open .pm-section-body{display:block}
  .pm-section.always-open .pm-section-toggle{display:none}
  .pm-section.always-open .pm-section-header{cursor:default;background:var(--primary-light)}
  .pm-section.always-open .pm-section-header:hover{background:var(--primary-light)}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GRID & CAMPOS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pm-grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:540px){.pm-grid{grid-template-columns:repeat(2,1fr)}}
  .pm-grid .full{grid-column:1/-1}

  .pm-field{display:flex;flex-direction:column;gap:4px}
  .pm-field label{font-size:12px;font-weight:600;color:#374151}

  .pm-input{
    width:100%;
    padding:12px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#fff;
    font-size:15px;
    outline:none;
    transition:border-color .2s,box-shadow .2s;
    -webkit-appearance:none
  }
  .pm-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(var(--primary-rgb),.15)}
  .pm-input[readonly]{background:#f3f4f6;color:#6b7280;cursor:not-allowed}

  .pm-select{
    appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235c9ead' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    padding-right:36px
  }

  .pm-textarea{min-height:80px;resize:vertical;line-height:1.4}

  .pm-hint{font-size:11px;color:#9ca3af;margin-top:2px}

  /* Checkbox */
  .pm-checkbox{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px;
    background:#f9fafb;
    border-radius:10px;
    cursor:pointer;
    transition:background .2s
  }
  .pm-checkbox:hover{background:var(--primary-light)}
  .pm-checkbox input{width:20px;height:20px;accent-color:var(--primary)}
  .pm-checkbox span{font-size:14px;font-weight:500;color:#374151}

  /* Sub-secciÃ³n condicional */
  .pm-subsection{
    margin-top:12px;
    padding:14px;
    background:var(--primary-light);
    border:1px solid #c5dfe5;
    border-radius:10px;
    transition:opacity .2s
  }
  .pm-subsection h4{margin:0 0 12px;font-size:13px;font-weight:700;color:var(--primary-dark)}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FOOTER & BOTONES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pm-footer{
    position:sticky;
    bottom:0;
    padding:16px;
    background:#fff;
    border-top:1px solid #e5e7eb;
    display:flex;
    gap:10px;
    flex-wrap:wrap
  }

  .pm-btn{
    flex:1;
    min-width:140px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:14px 16px;
    border-radius:12px;
    border:none;
    font-size:15px;
    font-weight:700;
    cursor:pointer;
    transition:transform .1s,box-shadow .2s;
    text-decoration:none
  }
  .pm-btn:active{transform:scale(.98)}

  .pm-btn-primary{background:var(--primary);color:#fff}
  .pm-btn-primary:hover{background:var(--primary-dark);box-shadow:0 4px 12px rgba(var(--primary-rgb),.4)}

  .pm-btn-secondary{background:#f3f4f6;color:#374151;border:1px solid #d1d5db}
  .pm-btn-secondary:hover{background:#e5e7eb}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FOTO UPLOAD
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pm-foto-wrap{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .pm-foto-preview{
    width:80px;
    height:80px;
    border-radius:50%;
    background:var(--primary-light);
    border:3px solid var(--primary);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex-shrink:0
  }
  .pm-foto-preview img{width:100%;height:100%;object-fit:cover}
  .pm-foto-preview svg{width:40px;height:40px;color:var(--primary)}
  .pm-foto-input{flex:1;min-width:200px}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FAMILIA - ESTILOS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .familia-hogar-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: linear-gradient(135deg, var(--primary-light) 0%, #f0f9fa 100%);
    border: 1px solid #c5dfe5;
    border-radius: 14px;
    margin-bottom: 16px;
  }
  .hogar-icon {
    width: 48px;
    height: 48px;
    background: var(--primary);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    flex-shrink: 0;
  }
  .hogar-info { flex: 1; min-width: 0; }
  .hogar-nombre { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 2px; }
  .hogar-meta { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6b7280; }
  .hogar-clan { background: #fff; padding: 2px 8px; border-radius: 6px; font-weight: 600; color: var(--primary-dark); }
  .hogar-edit-btn {
    width: 36px; height: 36px; border: none; background: #fff; border-radius: 10px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: #6b7280; transition: all 0.2s; flex-shrink: 0;
  }
  .hogar-edit-btn:hover { background: var(--primary); color: #fff; }
  .hogar-edit-form { margin-bottom: 16px; }
  .hogar-edit-inline { display: flex; gap: 8px; align-items: center; }
  .pm-btn-mini { padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; }

  .familia-sin-hogar {
    text-align: center; padding: 32px 16px; background: #f9fafb;
    border: 2px dashed #d1d5db; border-radius: 14px; margin-bottom: 16px;
  }
  .sin-hogar-icon { color: #9ca3af; margin-bottom: 12px; }
  .sin-hogar-text { color: #6b7280; font-size: 14px; margin: 0 0 16px 0; }
  .pm-btn-crear-hogar {
    display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px;
    background: var(--primary); color: #fff; border: none; border-radius: 10px;
    font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s;
  }
  .pm-btn-crear-hogar:hover { background: var(--primary-dark); transform: translateY(-1px); }

  .familia-relaciones-titulo {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
    font-size: 13px; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .relaciones-badge { background: var(--primary); color: #fff; padding: 2px 10px; border-radius: 20px; font-size: 12px; }
  .familia-relaciones-lista { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .relacion-card {
    display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff;
    border: 1px solid #e5e7eb; border-radius: 12px; transition: all 0.2s;
  }
  .relacion-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(92, 158, 173, 0.15); }
  .relacion-avatar {
    width: 44px; height: 44px; border-radius: 12px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
  }
  .relacion-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .avatar-initials { color: #fff; font-size: 14px; font-weight: 700; }
  .relacion-info { flex: 1; min-width: 0; }
  .relacion-nombre { font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 4px; }
  .relacion-tipo { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .tipo-badge { font-size: 11px; font-weight: 700; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; background: var(--primary-light); color: var(--primary-dark); }
  .tipo-badge.tipo-conyuge { background: #fce7f3; color: #be185d; }
  .tipo-badge.tipo-hijo { background: #dbeafe; color: #1d4ed8; }
  .tipo-badge.tipo-padre, .tipo-badge.tipo-madre { background: #fef3c7; color: #b45309; }
  .tipo-badge.tipo-hermano { background: #d1fae5; color: #047857; }
  .vive-junto-badge { font-size: 11px; color: #6b7280; }
  .relacion-delete-btn {
    width: 36px; height: 36px; border: none; background: transparent; border-radius: 8px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: #9ca3af; transition: all 0.2s; flex-shrink: 0;
  }
  .relacion-delete-btn:hover { background: #fef2f2; color: #dc2626; }

  .familia-agregar-section { text-align: center; margin-bottom: 8px; }
  .btn-agregar-relacion {
    display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px;
    background: transparent; border: 2px dashed #d1d5db; border-radius: 10px;
    color: #6b7280; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .btn-agregar-relacion:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
  .agregar-relacion-form { margin-top: 16px; padding: 20px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 14px; }
  .agregar-relacion-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .agregar-relacion-header h4 { margin: 0; font-size: 15px; font-weight: 700; color: #111827; }
  .btn-cerrar-form { width: 32px; height: 32px; border: none; background: #fff; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; }
  .btn-cerrar-form:hover { background: #fee2e2; color: #dc2626; }
  .agregar-relacion-actions { display: flex; gap: 10px; justify-content: flex-end; }

  /* Validaciones en tiempo real */
  .validaciones-container { margin-bottom: 16px; }
  .validacion-errores, .validacion-warnings {
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 12px;
  }
  .validacion-errores {
    background: #fef2f2;
    border: 1px solid #fecaca;
  }
  .validacion-warnings {
    background: #fffbeb;
    border: 1px solid #fde68a;
  }
  .validacion-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 10px;
  }
  .validacion-header.error { color: #dc2626; }
  .validacion-header.warning { color: #d97706; }
  .validacion-lista {
    margin: 0;
    padding-left: 28px;
    font-size: 13px;
    line-height: 1.5;
  }
  .validacion-errores .validacion-lista { color: #991b1b; }
  .validacion-warnings .validacion-lista { color: #92400e; }
  .validacion-confirmar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
    padding: 10px 12px;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #92400e;
  }
  .validacion-confirmar input { width: 18px; height: 18px; accent-color: #d97706; }
  .btn-disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none;
  }

  .autocomplete-familia-wrapper { position: relative; }
  .autocomplete-familia-field { position: relative; }
  .autocomplete-familia-field.has-selection .pm-input { display: none; }
  .familiar-chip {
    display: flex; align-items: center; gap: 10px; padding: 8px 12px;
    background: linear-gradient(135deg, var(--primary-light), #f0f9fa);
    border: 1px solid var(--primary); border-radius: 10px;
  }
  .familiar-chip .chip-avatar {
    width: 32px; height: 32px; background: var(--primary); border-radius: 8px;
    display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700;
  }
  .familiar-chip .chip-nombre { flex: 1; font-weight: 600; color: #111827; }
  .familiar-chip .chip-remove {
    width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px;
    cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280;
  }
  .familiar-chip .chip-remove:hover { background: #fee2e2; color: #dc2626; }
  .autocomplete-familia-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff;
    border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    z-index: 100; max-height: 240px; overflow-y: auto; display: none;
  }
  .autocomplete-familia-dropdown.open { display: block; }
  .dropdown-loading, .dropdown-empty { padding: 20px; text-align: center; color: #6b7280; font-size: 14px; }
  .dropdown-loading .spinner {
    display: inline-block; width: 16px; height: 16px; border: 2px solid #e5e7eb;
    border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
    margin-right: 8px; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .dropdown-results { list-style: none; margin: 0; padding: 6px; }
  .dropdown-results li { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; cursor: pointer; transition: background 0.15s; }
  .dropdown-results li:hover { background: var(--primary-light); }
  .dropdown-results .result-avatar {
    width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0;
  }
  .dropdown-results .result-info { flex: 1; min-width: 0; }
  .dropdown-results .result-nombre { font-size: 14px; font-weight: 600; color: #111827; }
  .dropdown-results .result-codigo { font-size: 12px; color: #6b7280; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE AJUSTES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media (max-width:480px){
    .pm-wrap{padding:8px}
    .pm-header{padding:14px}
    .pm-header h1{font-size:16px}
    .pm-section-header{padding:12px 14px}
    .pm-section-title{font-size:14px}
    .pm-section-body{padding:14px}
    .pm-input{padding:11px;font-size:16px}
    .pm-footer{padding:12px}
    .pm-btn{padding:12px 14px;font-size:14px}
    .familia-hogar-card { flex-wrap: wrap; }
    .hogar-edit-inline { flex-wrap: wrap; }
    .hogar-edit-inline input { width: 100%; flex: none; }
    .agregar-relacion-actions { flex-direction: column; }
    .agregar-relacion-actions .pm-btn { width: 100%; justify-content: center; }
  }
</style>

<div class="pm-wrap">
  <form method="post" enctype="multipart/form-data" class="pm-card">
    {% csrf_token %}

    <div class="pm-header">
      <h1>Editar mis datos</h1>
      <p>Actualiza tu informaciÃ³n personal</p>
      <div class="pm-nav">
        <a href="{% url 'portal_miembros:perfil' %}">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          Volver al perfil
        </a>
      </div>
    </div>

    {% if form.errors %}
    <div class="pm-errors">
      <strong>âš ï¸ Revisa el formulario:</strong>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- DATOS BÃSICOS (siempre abierta) -->
    <div class="pm-section always-open open">
      <div class="pm-section-header">
        <h3 class="pm-section-title"><span class="icon">ğŸ‘¤</span> Datos bÃ¡sicos</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-foto-wrap" style="margin-bottom:16px">
          <div class="pm-foto-preview" id="foto-preview">
            {% if miembro.foto %}<img src="{{ miembro.foto.url }}" alt="Foto">{% else %}<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a8.25 8.25 0 1115 0"/></svg>{% endif %}
          </div>
          <div class="pm-foto-input">
            <input type="file" name="foto" id="id_foto" accept="image/*" class="pm-input">
            <p class="pm-hint">JPG, PNG. MÃ¡ximo 5MB</p>
          </div>
        </div>
        <div class="pm-grid">
          <div class="pm-field"><label>Nombres *</label><input type="text" name="nombres" id="id_nombres" value="{{ form.nombres.value|default:'' }}" placeholder="Tus nombres" class="pm-input" required></div>
          <div class="pm-field"><label>Apellidos *</label><input type="text" name="apellidos" id="id_apellidos" value="{{ form.apellidos.value|default:'' }}" placeholder="Tus apellidos" class="pm-input" required></div>
          <div class="pm-field"><label>GÃ©nero</label><input class="pm-input" value="{{ miembro.get_genero_display|default:miembro.genero }}" readonly></div>
        </div>
      </div>
    </div>

    <!-- CONTACTO -->
    <div class="pm-section" data-section="contacto">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ“</span> Contacto</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field"><label>TelÃ©fono</label><input type="tel" name="telefono" id="id_telefono" value="{{ form.telefono.value|default:'' }}" placeholder="8091234567" class="pm-input" inputmode="numeric"><p class="pm-hint">Solo nÃºmeros, sin guiones</p></div>
          <div class="pm-field"><label>WhatsApp</label><input type="tel" name="whatsapp" id="id_whatsapp" value="{{ form.whatsapp.value|default:'' }}" placeholder="8091234567" class="pm-input" inputmode="numeric"></div>
          <div class="pm-field"><label>TelÃ©fono secundario</label><input type="tel" name="telefono_secundario" id="id_telefono_secundario" value="{{ form.telefono_secundario.value|default:'' }}" placeholder="Opcional" class="pm-input" inputmode="numeric"></div>
          <div class="pm-field"><label>Email</label><input type="email" name="email" id="id_email" value="{{ form.email.value|default:'' }}" placeholder="correo@ejemplo.com" class="pm-input" inputmode="email"></div>
        </div>
      </div>
    </div>

    <!-- DIRECCIÃ“N -->
    <div class="pm-section" data-section="direccion">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ“</span> DirecciÃ³n</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field full"><label>DirecciÃ³n</label><textarea name="direccion" id="id_direccion" rows="2" placeholder="Calle, nÃºmero, edificio..." class="pm-input pm-textarea">{{ form.direccion.value|default:'' }}</textarea></div>
          <div class="pm-field">
            <label>Sector</label>
            {% with current=form.sector.value|default_if_none:'' %}
            <select name="sector" id="id_sector" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="21 de Enero" {% if current == "21 de Enero" %}selected{% endif %}>21 de Enero</option>
              <option value="30 de Mayo" {% if current == "30 de Mayo" %}selected{% endif %}>30 de Mayo</option>
              <option value="Ana Melia" {% if current == "Ana Melia" %}selected{% endif %}>Ana Melia</option>
              <option value="Anamuya" {% if current == "Anamuya" %}selected{% endif %}>Anamuya</option>
              <option value="Antonio GuzmÃ¡n" {% if current == "Antonio GuzmÃ¡n" %}selected{% endif %}>Antonio GuzmÃ¡n</option>
              <option value="Brisas del Duey" {% if current == "Brisas del Duey" %}selected{% endif %}>Brisas del Duey</option>
              <option value="Cristo Rey" {% if current == "Cristo Rey" %}selected{% endif %}>Cristo Rey</option>
              <option value="Don Celso" {% if current == "Don Celso" %}selected{% endif %}>Don Celso</option>
              <option value="Duarte" {% if current == "Duarte" %}selected{% endif %}>Duarte</option>
              <option value="El Bonao" {% if current == "El Bonao" %}selected{% endif %}>El Bonao</option>
              <option value="El Centro" {% if current == "El Centro" %}selected{% endif %}>El Centro</option>
              <option value="El Chorro" {% if current == "El Chorro" %}selected{% endif %}>El Chorro</option>
              <option value="El Macao" {% if current == "El Macao" %}selected{% endif %}>El Macao</option>
              <option value="El Obispado" {% if current == "El Obispado" %}selected{% endif %}>El Obispado</option>
              <option value="El Tamarindo" {% if current == "El Tamarindo" %}selected{% endif %}>El Tamarindo</option>
              <option value="Juan Pablo Duarte" {% if current == "Juan Pablo Duarte" %}selected{% endif %}>Juan Pablo Duarte</option>
              <option value="La Altagracia" {% if current == "La Altagracia" %}selected{% endif %}>La Altagracia</option>
              <option value="La AviaciÃ³n" {% if current == "La AviaciÃ³n" %}selected{% endif %}>La AviaciÃ³n</option>
              <option value="La Cabrera" {% if current == "La Cabrera" %}selected{% endif %}>La Cabrera</option>
              <option value="La Candelaria" {% if current == "La Candelaria" %}selected{% endif %}>La Candelaria</option>
              <option value="La Ceiba del Salado" {% if current == "La Ceiba del Salado" %}selected{% endif %}>La Ceiba del Salado</option>
              <option value="La Colonia" {% if current == "La Colonia" %}selected{% endif %}>La Colonia</option>
              <option value="La Cruz" {% if current == "La Cruz" %}selected{% endif %}>La Cruz</option>
              <option value="La Fe" {% if current == "La Fe" %}selected{% endif %}>La Fe</option>
              <option value="La Laguna" {% if current == "La Laguna" %}selected{% endif %}>La Laguna</option>
              <option value="La Malena" {% if current == "La Malena" %}selected{% endif %}>La Malena</option>
              <option value="La Mina" {% if current == "La Mina" %}selected{% endif %}>La Mina</option>
              <option value="La Otra Banda" {% if current == "La Otra Banda" %}selected{% endif %}>La Otra Banda</option>
              <option value="Las Caobas" {% if current == "Las Caobas" %}selected{% endif %}>Las Caobas</option>
              <option value="Las Flores" {% if current == "Las Flores" %}selected{% endif %}>Las Flores</option>
              <option value="Las Mercedes" {% if current == "Las Mercedes" %}selected{% endif %}>Las Mercedes</option>
              <option value="Los Platanitos" {% if current == "Los Platanitos" %}selected{% endif %}>Los Platanitos</option>
              <option value="Los RÃ­os" {% if current == "Los RÃ­os" %}selected{% endif %}>Los RÃ­os</option>
              <option value="Los Sotos" {% if current == "Los Sotos" %}selected{% endif %}>Los Sotos</option>
              <option value="Luisa Perla" {% if current == "Luisa Perla" %}selected{% endif %}>Luisa Perla</option>
              <option value="MamÃ¡ TingÃ³" {% if current == "MamÃ¡ TingÃ³" %}selected{% endif %}>MamÃ¡ TingÃ³</option>
              <option value="Nazaret" {% if current == "Nazaret" %}selected{% endif %}>Nazaret</option>
              <option value="Nuevo Amanecer" {% if current == "Nuevo Amanecer" %}selected{% endif %}>Nuevo Amanecer</option>
              <option value="Palmeras del Este" {% if current == "Palmeras del Este" %}selected{% endif %}>Palmeras del Este</option>
              <option value="Punta Cana" {% if current == "Punta Cana" %}selected{% endif %}>Punta Cana</option>
              <option value="Quisqueya" {% if current == "Quisqueya" %}selected{% endif %}>Quisqueya</option>
              <option value="Sabana Grande" {% if current == "Sabana Grande" %}selected{% endif %}>Sabana Grande</option>
              <option value="San Juan" {% if current == "San Juan" %}selected{% endif %}>San Juan</option>
              <option value="San MartÃ­n" {% if current == "San MartÃ­n" %}selected{% endif %}>San MartÃ­n</option>
              <option value="San Rafael del Yuma" {% if current == "San Rafael del Yuma" %}selected{% endif %}>San Rafael del Yuma</option>
              <option value="Santana" {% if current == "Santana" %}selected{% endif %}>Santana</option>
              <option value="Santo Domingo" {% if current == "Santo Domingo" %}selected{% endif %}>Santo Domingo</option>
              <option value="Uvero Alto" {% if current == "Uvero Alto" %}selected{% endif %}>Uvero Alto</option>
              <option value="Villa Cerro" {% if current == "Villa Cerro" %}selected{% endif %}>Villa Cerro</option>
              <option value="Otro" {% if current == "Otro" %}selected{% endif %}>Otro</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>Ciudad</label>
            {% with current=form.ciudad.value|default_if_none:'' %}
            <select name="ciudad" id="id_ciudad" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="Higuey" {% if current == "Higuey" %}selected{% endif %}>HigÃ¼ey</option>
              <option value="Punta Cana" {% if current == "Punta Cana" %}selected{% endif %}>Punta Cana</option>
              <option value="San Rafael del Yuma" {% if current == "San Rafael del Yuma" %}selected{% endif %}>San Rafael del Yuma</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>Provincia</label>
            {% with current=form.provincia.value|default_if_none:'' %}
            <select name="provincia" id="id_provincia" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="La Altagracia" {% if current == "La Altagracia" %}selected{% endif %}>La Altagracia</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>PaÃ­s / Nacionalidad</label>
            <input type="text" name="nacionalidad" id="id_nacionalidad" value="{% if form.nacionalidad.value %}{{ form.nacionalidad.value }}{% else %}RepÃºblica Dominicana{% endif %}" placeholder="Tu paÃ­s" class="pm-input" list="lista_paises" autocomplete="off">
            <datalist id="lista_paises"><option value="RepÃºblica Dominicana"><option value="Estados Unidos"><option value="EspaÃ±a"><option value="MÃ©xico"><option value="Colombia"><option value="Venezuela"><option value="Puerto Rico"><option value="Haiti"></datalist>
          </div>
          <div class="pm-field"><label>Lugar de nacimiento</label><input type="text" name="lugar_nacimiento" id="id_lugar_nacimiento" value="{{ form.lugar_nacimiento.value|default:'' }}" placeholder="Ciudad o paÃ­s" class="pm-input"></div>
        </div>
      </div>
    </div>

    <!-- INFORMACIÃ“N PERSONAL -->
    <div class="pm-section" data-section="personal">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ“‹</span> InformaciÃ³n personal</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field">
            <label>Estado civil</label>
            {% with current=form.estado_civil.value|default_if_none:'' %}
            <select name="estado_civil" id="id_estado_civil" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="soltero" {% if current == "soltero" %}selected{% endif %}>Soltero(a)</option>
              <option value="casado" {% if current == "casado" %}selected{% endif %}>Casado(a)</option>
              <option value="divorciado" {% if current == "divorciado" %}selected{% endif %}>Divorciado(a)</option>
              <option value="viudo" {% if current == "viudo" %}selected{% endif %}>Viudo(a)</option>
              <option value="union_libre" {% if current == "union_libre" %}selected{% endif %}>UniÃ³n libre</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>Nivel educativo</label>
            {% with current=form.nivel_educativo.value|default_if_none:'' %}
            <select name="nivel_educativo" id="id_nivel_educativo" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="primaria" {% if current == "primaria" %}selected{% endif %}>Primaria</option>
              <option value="secundaria" {% if current == "secundaria" %}selected{% endif %}>Secundaria</option>
              <option value="bachillerato" {% if current == "bachillerato" %}selected{% endif %}>Bachillerato</option>
              <option value="tecnico" {% if current == "tecnico" %}selected{% endif %}>TÃ©cnico</option>
              <option value="universitario" {% if current == "universitario" %}selected{% endif %}>Universitario</option>
              <option value="postgrado" {% if current == "postgrado" %}selected{% endif %}>Postgrado</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>ProfesiÃ³n</label>
            <input type="text" name="profesion" id="id_profesion" value="{{ form.profesion.value|default:'' }}" placeholder="Tu ocupaciÃ³n" class="pm-input" list="profesion_list">
            <datalist id="profesion_list"><option value="Empleado(a)"><option value="Estudiante"><option value="Independiente"><option value="Ama de casa"><option value="Maestro(a)"><option value="TÃ©cnico(a)"><option value="Ingeniero(a)"><option value="Doctor(a)"><option value="Enfermero(a)"><option value="Abogado(a)"><option value="Contable"><option value="Comerciante"></datalist>
          </div>
          <div class="pm-field"><label>Pasaporte</label><input type="text" name="pasaporte" id="id_pasaporte" value="{{ form.pasaporte.value|default:'' }}" placeholder="NÃºmero" class="pm-input" style="text-transform:uppercase"></div>
        </div>
      </div>
    </div>

    <!-- MEMBRESÃA -->
    <div class="pm-section" data-section="membresia">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">â›ª</span> MembresÃ­a</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <label class="pm-checkbox full">
            <input type="checkbox" name="es_trasladado" id="id_es_trasladado" {% if form.es_trasladado.value %}checked{% endif %}>
            <span>Viene de otra iglesia</span>
          </label>
          <div class="pm-field full">
            <label>Iglesia anterior</label>
            <input type="text" name="iglesia_anterior" id="id_iglesia_anterior" value="{{ form.iglesia_anterior.value|default:'' }}" placeholder="Nombre de la iglesia" class="pm-input">
          </div>
          <div class="pm-field">
            <label>Fecha de conversiÃ³n</label>
            <input type="date" name="fecha_conversion" id="id_fecha_conversion" value="{{ form.fecha_conversion.value|date:'Y-m-d' }}" class="pm-input">
          </div>
          <div class="pm-field">
            <label>Fecha de bautismo</label>
            <input type="date" name="fecha_bautismo" id="id_fecha_bautismo" value="{{ form.fecha_bautismo.value|date:'Y-m-d' }}" class="pm-input" {% if not miembro.bautizado_confirmado %}readonly{% endif %}>
            {% if not miembro.bautizado_confirmado %}
              <p class="pm-hint">Este campo lo completa/valida secretarÃ­a cuando el bautismo estÃ© confirmado.</p>
            {% endif %}
          </div>
          <label class="pm-checkbox">
            <input type="checkbox" {% if miembro.bautizado_confirmado %}checked{% endif %} disabled>
            <span>Bautismo confirmado (solo administraciÃ³n)</span>
          </label>
          <div class="pm-field">
            <label>CategorÃ­a</label>
            <input type="text" name="categoria_miembro" id="id_categoria_miembro" value="{{ form.categoria_miembro.value|default:'' }}" placeholder="Ej: Miembro, LÃ­der" class="pm-input">
          </div>
        </div>
      </div>
    </div>

    <!-- SALUD -->
    <div class="pm-section" data-section="salud">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ¥</span> Salud y emergencia</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field"><label>Contacto emergencia</label><input type="text" name="contacto_emergencia_nombre" id="id_contacto_emergencia_nombre" value="{{ form.contacto_emergencia_nombre.value|default:'' }}" placeholder="Nombre completo" class="pm-input"></div>
          <div class="pm-field"><label>TelÃ©fono emergencia</label><input type="tel" name="contacto_emergencia_telefono" id="id_contacto_emergencia_telefono" value="{{ form.contacto_emergencia_telefono.value|default:'' }}" placeholder="NÃºmero" class="pm-input" inputmode="numeric"></div>
          <div class="pm-field"><label>RelaciÃ³n</label><input type="text" name="contacto_emergencia_relacion" id="id_contacto_emergencia_relacion" value="{{ form.contacto_emergencia_relacion.value|default:'' }}" placeholder="Ej: Esposa, Hijo" class="pm-input" list="relacion_list"><datalist id="relacion_list"><option value="Esposa"><option value="Esposo"><option value="Madre"><option value="Padre"><option value="Hijo/a"><option value="Hermano/a"><option value="Amigo/a"></datalist></div>
          <div class="pm-field">
            <label>Tipo de sangre</label>
            {% with current=form.tipo_sangre.value|default_if_none:'' %}
            <select name="tipo_sangre" id="id_tipo_sangre" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="A+" {% if current == "A+" %}selected{% endif %}>A+</option>
              <option value="A-" {% if current == "A-" %}selected{% endif %}>A-</option>
              <option value="B+" {% if current == "B+" %}selected{% endif %}>B+</option>
              <option value="B-" {% if current == "B-" %}selected{% endif %}>B-</option>
              <option value="AB+" {% if current == "AB+" %}selected{% endif %}>AB+</option>
              <option value="AB-" {% if current == "AB-" %}selected{% endif %}>AB-</option>
              <option value="O+" {% if current == "O+" %}selected{% endif %}>O+</option>
              <option value="O-" {% if current == "O-" %}selected{% endif %}>O-</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field full"><label>Alergias</label><textarea name="alergias" id="id_alergias" rows="2" placeholder="Lista de alergias..." class="pm-input pm-textarea">{{ form.alergias.value|default:'' }}</textarea></div>
          <div class="pm-field full"><label>Condiciones mÃ©dicas</label><textarea name="condiciones_medicas" id="id_condiciones_medicas" rows="2" placeholder="Condiciones relevantes..." class="pm-input pm-textarea">{{ form.condiciones_medicas.value|default:'' }}</textarea></div>
          <div class="pm-field full"><label>Medicamentos</label><textarea name="medicamentos" id="id_medicamentos" rows="2" placeholder="Medicamentos actuales..." class="pm-input pm-textarea">{{ form.medicamentos.value|default:'' }}</textarea></div>
        </div>
      </div>
    </div>

    <!-- TRABAJO -->
    <div class="pm-section" data-section="trabajo">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ’¼</span> Trabajo</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field"><label>Empleador</label><input type="text" name="empleador" id="id_empleador" value="{{ form.empleador.value|default:'' }}" placeholder="Empresa" class="pm-input"></div>
          <div class="pm-field"><label>Puesto</label><input type="text" name="puesto" id="id_puesto" value="{{ form.puesto.value|default:'' }}" placeholder="Cargo" class="pm-input"></div>
          <div class="pm-field"><label>TelÃ©fono trabajo</label><input type="tel" name="telefono_trabajo" id="id_telefono_trabajo" value="{{ form.telefono_trabajo.value|default:'' }}" placeholder="TelÃ©fono" class="pm-input" inputmode="numeric"></div>
          <div class="pm-field full"><label>DirecciÃ³n trabajo</label><textarea name="direccion_trabajo" id="id_direccion_trabajo" rows="2" placeholder="DirecciÃ³n completa..." class="pm-input pm-textarea">{{ form.direccion_trabajo.value|default:'' }}</textarea></div>
        </div>
      </div>
    </div>

    <!-- SOCIOECONÃ“MICO -->
    <div class="pm-section" data-section="socioeconomico">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ </span> SocioeconÃ³mico</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field">
            <label>Tipo de vivienda</label>
            {% with current=form.tipo_vivienda.value|default_if_none:'' %}
            <select name="tipo_vivienda" id="id_tipo_vivienda" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="propia" {% if current == "propia" %}selected{% endif %}>Casa propia</option>
              <option value="alquilada" {% if current == "alquilada" %}selected{% endif %}>Alquilada</option>
              <option value="familiar" {% if current == "familiar" %}selected{% endif %}>Casa de familiares</option>
              <option value="prestada" {% if current == "prestada" %}selected{% endif %}>Prestada / Cedida</option>
            </select>
            {% endwith %}
          </div>
          <div class="pm-field">
            <label>SituaciÃ³n econÃ³mica</label>
            {% with current=form.situacion_economica.value|default_if_none:'' %}
            <select name="situacion_economica" id="id_situacion_economica" class="pm-input pm-select">
              <option value="">â€” Selecciona â€”</option>
              <option value="estable" {% if current == "estable" %}selected{% endif %}>Estable</option>
              <option value="vulnerable" {% if current == "vulnerable" %}selected{% endif %}>Vulnerable</option>
              <option value="critica" {% if current == "critica" %}selected{% endif %}>CrÃ­tica</option>
            </select>
            {% endwith %}
          </div>
          <label class="pm-checkbox full"><input type="checkbox" name="tiene_vehiculo" id="id_tiene_vehiculo" {% if form.tiene_vehiculo.value %}checked{% endif %}><span>Tiene vehÃ­culo</span></label>
        </div>
        <div class="pm-subsection" id="bloque-vehiculo" style="{% if not form.tiene_vehiculo.value %}display:none{% endif %}">
          <h4>ğŸš— Datos del vehÃ­culo</h4>
          <div class="pm-grid">
            <div class="pm-field">
              <label>Tipo</label>
              {% with current=form.vehiculo_tipo.value|default_if_none:'' %}
              <select name="vehiculo_tipo" id="id_vehiculo_tipo" class="pm-input pm-select">
                <option value="">â€” Selecciona â€”</option>
                <option value="carro" {% if current == "carro" %}selected{% endif %}>Carro</option>
                <option value="jeepeta" {% if current == "jeepeta" %}selected{% endif %}>Jeepeta</option>
                <option value="camioneta" {% if current == "camioneta" %}selected{% endif %}>Camioneta</option>
                <option value="motor" {% if current == "motor" %}selected{% endif %}>Motor</option>
                <option value="camion" {% if current == "camion" %}selected{% endif %}>CamiÃ³n</option>
                <option value="otro" {% if current == "otro" %}selected{% endif %}>Otro</option>
              </select>
              {% endwith %}
            </div>
            <div class="pm-field"><label>Marca</label><input type="text" name="vehiculo_marca" id="id_vehiculo_marca" value="{{ form.vehiculo_marca.value|default:'' }}" placeholder="Ej: Toyota" class="pm-input"></div>
            <div class="pm-field"><label>Placa</label><input type="text" name="vehiculo_placa" id="id_vehiculo_placa" value="{{ form.vehiculo_placa.value|default:'' }}" placeholder="Ej: A123456" class="pm-input" style="text-transform:uppercase"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MI FAMILIA -->
    <div class="pm-section" data-section="familia">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span> Mi Familia</h3>
        <div class="pm-section-toggle">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div class="pm-section-body">

        {% if hogar_actual %}
        <div class="familia-hogar-card">
          <div class="hogar-icon">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
          </div>
          <div class="hogar-info">
            <div class="hogar-nombre">{{ hogar_actual.nombre|default:"Mi Hogar" }}</div>
            <div class="hogar-meta">
              {% if hogar_actual.clan %}
                <span class="hogar-clan">{{ hogar_actual.clan.nombre }}</span>
              {% endif %}
              <span class="hogar-count">{{ relaciones_count }} relacion{{ relaciones_count|pluralize:"es" }}</span>
            </div>
          </div>
          <button type="button" class="hogar-edit-btn" onclick="mostrarEditarNombreHogar()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
        </div>

        <div id="editarNombreHogarForm" class="hogar-edit-form" style="display:none;">
          <form method="post" action="{% url 'portal_miembros:actualizar_nombre_hogar' %}" class="hogar-edit-inline">
            {% csrf_token %}
            <input type="text" name="nombre_hogar" value="{{ hogar_actual.nombre }}" placeholder="Nombre del hogar" class="pm-input" style="flex:1;">
            <button type="submit" class="pm-btn-mini pm-btn-primary">Guardar</button>
            <button type="button" class="pm-btn-mini pm-btn-secondary" onclick="ocultarEditarNombreHogar()">Cancelar</button>
          </form>
        </div>

        {% else %}
        <div class="familia-sin-hogar">
          <div class="sin-hogar-icon">
            <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" opacity="0.3"/>
              <line x1="12" y1="9" x2="12" y2="15"/>
              <line x1="9" y1="12" x2="15" y2="12"/>
            </svg>
          </div>
          <p class="sin-hogar-text">AÃºn no tienes un hogar familiar registrado</p>
          <form method="post" action="{% url 'portal_miembros:crear_mi_hogar' %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="pm-btn-crear-hogar">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Crear mi hogar
            </button>
          </form>
        </div>
        {% endif %}

        {% if relaciones %}
        <div class="familia-relaciones-titulo">
          <span>Mis relaciones familiares</span>
          <span class="relaciones-badge">{{ relaciones_count }}</span>
        </div>

        <div class="familia-relaciones-lista">
          {% for rel in relaciones %}
          <div class="relacion-card">
            <div class="relacion-avatar">
              {% if rel.familiar_foto %}
                <img src="{{ rel.familiar_foto }}" alt="{{ rel.familiar_nombre }}">
              {% else %}
                <span class="avatar-initials">{{ rel.familiar_nombre|slice:":2"|upper }}</span>
              {% endif %}
            </div>
            <div class="relacion-info">
              <div class="relacion-nombre">{{ rel.familiar_nombre }}</div>
              <div class="relacion-tipo">
                <span class="tipo-badge tipo-{{ rel.tipo }}">{{ rel.tipo_display }}</span>
                {% if rel.vive_junto %}
                  <span class="vive-junto-badge">ğŸ  Vive conmigo</span>
                {% endif %}
              </div>
            </div>
            <form method="post" action="{% url 'portal_miembros:eliminar_relacion_portal' rel.id %}" 
                  onsubmit="return confirm('Â¿Eliminar esta relaciÃ³n familiar?');" style="margin:0;">
              {% csrf_token %}
              <button type="submit" class="relacion-delete-btn" title="Eliminar relaciÃ³n">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="familia-agregar-section">
          <button type="button" class="btn-agregar-relacion" onclick="mostrarFormRelacion()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Agregar familiar
          </button>
        </div>

        <div id="formAgregarRelacion" class="agregar-relacion-form" style="display:none;">
          <div class="agregar-relacion-header">
            <h4>Agregar familiar</h4>
            <button type="button" class="btn-cerrar-form" onclick="ocultarFormRelacion()">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <form method="post" action="{% url 'portal_miembros:agregar_relacion_portal' %}" id="formRelacionSubmit">
            {% csrf_token %}

            <div class="pm-field" style="margin-bottom:12px;">
              <label>Tipo de relaciÃ³n *</label>
              <select name="tipo_relacion" id="selectTipoRelacion" class="pm-input pm-select" required>
                <option value="">â€” Selecciona â€”</option>
                {% for value, label in tipos_relacion %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="pm-field" style="margin-bottom:12px;">
              <label>Buscar miembro *</label>
              <div class="autocomplete-familia-wrapper">
                <input type="hidden" name="familiar_id" id="familiarIdInput" required>
                
                <div class="autocomplete-familia-field" id="autocompleteField">
                  <div class="familiar-chip" id="familiarChip" style="display:none;">
                    <span class="chip-avatar" id="chipAvatar"></span>
                    <span class="chip-nombre" id="chipNombre"></span>
                    <button type="button" class="chip-remove" onclick="limpiarSeleccionFamiliar()">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                  
                  <input type="text" 
                         id="buscarFamiliarInput" 
                         class="pm-input" 
                         placeholder="Escribe un nombre..." 
                         autocomplete="off">
                </div>

                <div class="autocomplete-familia-dropdown" id="familiarDropdown">
                  <div class="dropdown-loading" id="dropdownLoading" style="display:none;">
                    <span class="spinner"></span> Buscando...
                  </div>
                  <div class="dropdown-empty" id="dropdownEmpty" style="display:none;">
                    No se encontraron miembros
                  </div>
                  <ul class="dropdown-results" id="dropdownResults"></ul>
                </div>
              </div>
              <p class="pm-hint">Escribe al menos 2 caracteres para buscar</p>
            </div>

            <label class="pm-checkbox" style="margin-bottom:16px;">
              <input type="checkbox" name="vive_junto" id="chkViveJunto">
              <span>Vive conmigo</span>
            </label>

            <div class="agregar-relacion-actions">
              <button type="button" class="pm-btn pm-btn-secondary" onclick="ocultarFormRelacion()">Cancelar</button>
              <button type="submit" class="pm-btn pm-btn-primary" id="btnGuardarRelacion">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M5 13l4 4L19 7"/>
                </svg>
                Agregar
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>

    <!-- INTERESES Y HABILIDADES -->
    <div class="pm-section" data-section="intereses">
      <div class="pm-section-header" onclick="toggleSection(this)">
        <h3 class="pm-section-title"><span class="icon">ğŸ¯</span> Intereses y habilidades</h3>
        <div class="pm-section-toggle"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="pm-section-body">
        <div class="pm-grid">
          <div class="pm-field full"><label>Intereses</label>{{ form.intereses }}</div>
          <div class="pm-field full"><label>Otros intereses</label><textarea name="otros_intereses" id="id_otros_intereses" rows="2" placeholder="Otros intereses..." class="pm-input pm-textarea">{{ form.otros_intereses.value|default:'' }}</textarea></div>
          <div class="pm-field full"><label>Habilidades</label>{{ form.habilidades }}</div>
          <div class="pm-field full"><label>Otras habilidades</label><textarea name="otras_habilidades" id="id_otras_habilidades" rows="2" placeholder="Otras habilidades..." class="pm-input pm-textarea">{{ form.otras_habilidades.value|default:'' }}</textarea></div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="pm-footer">
      <button type="submit" class="pm-btn pm-btn-primary">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
        Guardar cambios
      </button>
      <a href="{% url 'portal_miembros:perfil' %}" class="pm-btn pm-btn-secondary">Cancelar</a>
    </div>

  </form>
</div>

<script>
// =====================================================
// SECCIONES COLAPSABLES
// =====================================================
function toggleSection(header) {
  const section = header.closest('.pm-section');
  if (section.classList.contains('always-open')) return;
  section.classList.toggle('open');
}

// =====================================================
// VEHÃCULO TOGGLE
// =====================================================
document.addEventListener("DOMContentLoaded", function() {
  const chkVehiculo = document.getElementById('id_tiene_vehiculo');
  const bloqueVehiculo = document.getElementById('bloque-vehiculo');

  function toggleVehiculo() {
    if (!chkVehiculo || !bloqueVehiculo) return;
    bloqueVehiculo.style.display = chkVehiculo.checked ? 'block' : 'none';
    if (!chkVehiculo.checked) {
      bloqueVehiculo.querySelectorAll('input').forEach(i => i.value = '');
      bloqueVehiculo.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    }
  }

  if (chkVehiculo) {
    chkVehiculo.addEventListener('change', toggleVehiculo);
    toggleVehiculo();
  }

  // FOTO PREVIEW
  const inputFoto = document.getElementById('id_foto');
  const fotoPreview = document.getElementById('foto-preview');
  if (inputFoto && fotoPreview) {
    inputFoto.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        let img = fotoPreview.querySelector('img');
        if (!img) {
          fotoPreview.innerHTML = '';
          img = document.createElement('img');
          img.alt = 'Preview';
          fotoPreview.appendChild(img);
        }
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // UPPERCASE
  ['id_pasaporte', 'id_vehiculo_placa'].forEach(function(id) {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
  });
});

// =====================================================
// FAMILIA - MOSTRAR/OCULTAR FORMULARIOS
// =====================================================
function mostrarFormRelacion() {
  document.getElementById('formAgregarRelacion').style.display = 'block';
  document.querySelector('.familia-agregar-section').style.display = 'none';
  document.getElementById('selectTipoRelacion').focus();
  limpiarValidaciones();
}

function ocultarFormRelacion() {
  document.getElementById('formAgregarRelacion').style.display = 'none';
  document.querySelector('.familia-agregar-section').style.display = 'block';
  limpiarFormRelacion();
}

function mostrarEditarNombreHogar() {
  document.getElementById('editarNombreHogarForm').style.display = 'block';
}

function ocultarEditarNombreHogar() {
  document.getElementById('editarNombreHogarForm').style.display = 'none';
}

function limpiarFormRelacion() {
  const sel = document.getElementById('selectTipoRelacion');
  if (sel) sel.selectedIndex = 0;
  const inp = document.getElementById('buscarFamiliarInput');
  if (inp) inp.value = '';
  const hid = document.getElementById('familiarIdInput');
  if (hid) hid.value = '';
  const chk = document.getElementById('chkViveJunto');
  if (chk) chk.checked = false;
  limpiarSeleccionFamiliar();
  limpiarValidaciones();
}

// =====================================================
// VALIDACIONES EN TIEMPO REAL
// =====================================================
function limpiarValidaciones() {
  const container = document.getElementById('validacionesContainer');
  if (container) {
    container.innerHTML = '';
    container.style.display = 'none';
  }
  const btnGuardar = document.getElementById('btnGuardarRelacion');
  if (btnGuardar) {
    btnGuardar.disabled = false;
    btnGuardar.classList.remove('btn-disabled');
  }
}

function mostrarValidaciones(errors, warnings) {
  let container = document.getElementById('validacionesContainer');
  
  // Crear container si no existe
  if (!container) {
    container = document.createElement('div');
    container.id = 'validacionesContainer';
    container.className = 'validaciones-container';
    const form = document.getElementById('formRelacionSubmit');
    const actions = form.querySelector('.agregar-relacion-actions');
    form.insertBefore(container, actions);
  }
  
  container.innerHTML = '';
  
  const btnGuardar = document.getElementById('btnGuardarRelacion');
  
  // Mostrar errores
  if (errors && errors.length > 0) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'validacion-errores';
    errorDiv.innerHTML = `
      <div class="validacion-header error">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>No se puede crear esta relaciÃ³n</span>
      </div>
      <ul class="validacion-lista">
        ${errors.map(e => `<li>${e}</li>`).join('')}
      </ul>
    `;
    container.appendChild(errorDiv);
    
    // Deshabilitar botÃ³n
    if (btnGuardar) {
      btnGuardar.disabled = true;
      btnGuardar.classList.add('btn-disabled');
    }
  }
  
  // Mostrar warnings
  if (warnings && warnings.length > 0) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'validacion-warnings';
    warningDiv.innerHTML = `
      <div class="validacion-header warning">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>Advertencias</span>
      </div>
      <ul class="validacion-lista">
        ${warnings.map(w => `<li>${w}</li>`).join('')}
      </ul>
      <label class="validacion-confirmar">
        <input type="checkbox" id="chkConfirmarWarnings" name="confirmar_warnings" value="1" onchange="toggleBotonGuardar()">
        <span>Entiendo y deseo continuar de todas formas</span>
      </label>
    `;
    container.appendChild(warningDiv);
    
    // Deshabilitar botÃ³n hasta confirmar (solo si no hay errores)
    if (btnGuardar && (!errors || errors.length === 0)) {
      btnGuardar.disabled = true;
      btnGuardar.classList.add('btn-disabled');
    }
  }
  
  // Si no hay errores ni warnings, habilitar botÃ³n
  if ((!errors || errors.length === 0) && (!warnings || warnings.length === 0)) {
    if (btnGuardar) {
      btnGuardar.disabled = false;
      btnGuardar.classList.remove('btn-disabled');
    }
  }
  
  container.style.display = (errors && errors.length > 0) || (warnings && warnings.length > 0) ? 'block' : 'none';
}

function toggleBotonGuardar() {
  const chk = document.getElementById('chkConfirmarWarnings');
  const btnGuardar = document.getElementById('btnGuardarRelacion');
  const tieneErrores = document.querySelector('.validacion-errores');
  
  if (btnGuardar && !tieneErrores) {
    if (chk && chk.checked) {
      btnGuardar.disabled = false;
      btnGuardar.classList.remove('btn-disabled');
    } else {
      btnGuardar.disabled = true;
      btnGuardar.classList.add('btn-disabled');
    }
  }
}

async function validarRelacionEnTiempoReal() {
  const familiarId = document.getElementById('familiarIdInput').value;
  const tipoRelacion = document.getElementById('selectTipoRelacion').value;
  
  if (!familiarId || !tipoRelacion) {
    limpiarValidaciones();
    return;
  }
  
  try {
    const url = `{% url 'portal_miembros:ajax_validar_relacion' %}?familiar_id=${familiarId}&tipo_relacion=${encodeURIComponent(tipoRelacion)}`;
    const response = await fetch(url, {
      credentials: 'same-origin',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    mostrarValidaciones(data.errors, data.warnings);
    
  } catch (err) {
    console.error('Error validando relaciÃ³n:', err);
  }
}

// =====================================================
// AUTOCOMPLETE BUSCAR FAMILIAR
// =====================================================
(function() {
  const buscarInput = document.getElementById('buscarFamiliarInput');
  const familiarIdInput = document.getElementById('familiarIdInput');
  const dropdown = document.getElementById('familiarDropdown');
  const dropdownResults = document.getElementById('dropdownResults');
  const dropdownLoading = document.getElementById('dropdownLoading');
  const dropdownEmpty = document.getElementById('dropdownEmpty');
  const familiarChip = document.getElementById('familiarChip');
  const chipAvatar = document.getElementById('chipAvatar');
  const chipNombre = document.getElementById('chipNombre');
  const autocompleteField = document.getElementById('autocompleteField');
  const selectTipoRelacion = document.getElementById('selectTipoRelacion');

  let debounceTimer = null;

  if (buscarInput) {
    buscarInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const q = this.value.trim();
      
      if (q.length < 2) {
        cerrarDropdown();
        return;
      }

      debounceTimer = setTimeout(() => buscarMiembros(q), 300);
    });

    buscarInput.addEventListener('focus', function() {
      const q = this.value.trim();
      if (q.length >= 2) {
        buscarMiembros(q);
      }
    });
  }

  // Validar cuando cambia el tipo de relaciÃ³n
  if (selectTipoRelacion) {
    selectTipoRelacion.addEventListener('change', function() {
      validarRelacionEnTiempoReal();
    });
  }

  document.addEventListener('click', function(e) {
    if (dropdown && !dropdown.contains(e.target) && e.target !== buscarInput) {
      cerrarDropdown();
    }
  });

  async function buscarMiembros(query) {
    mostrarLoading();

    try {
      const url = `{% url 'portal_miembros:ajax_buscar_miembros_portal' %}?q=${encodeURIComponent(query)}`;
      const response = await fetch(url, {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        mostrarResultados(data.results);
      } else {
        mostrarEmpty();
      }
    } catch (err) {
      console.error('Error buscando miembros:', err);
      mostrarEmpty();
    }
  }

  function mostrarLoading() {
    if (dropdownResults) dropdownResults.innerHTML = '';
    if (dropdownResults) dropdownResults.style.display = 'none';
    if (dropdownEmpty) dropdownEmpty.style.display = 'none';
    if (dropdownLoading) dropdownLoading.style.display = 'block';
    abrirDropdown();
  }

  function mostrarEmpty() {
    if (dropdownResults) dropdownResults.innerHTML = '';
    if (dropdownResults) dropdownResults.style.display = 'none';
    if (dropdownLoading) dropdownLoading.style.display = 'none';
    if (dropdownEmpty) dropdownEmpty.style.display = 'block';
    abrirDropdown();
  }

  function mostrarResultados(results) {
    if (dropdownLoading) dropdownLoading.style.display = 'none';
    if (dropdownEmpty) dropdownEmpty.style.display = 'none';
    if (dropdownResults) dropdownResults.innerHTML = '';

    results.forEach(m => {
      const li = document.createElement('li');
      const initials = getInitials(m.nombre);

      li.innerHTML = `
        <div class="result-avatar">${escapeHtml(initials)}</div>
        <div class="result-info">
          <div class="result-nombre">${escapeHtml(m.nombre)}</div>
          <div class="result-codigo">${escapeHtml(m.codigo || 'Sin cÃ³digo')}</div>
        </div>
      `;

      li.addEventListener('click', () => seleccionarFamiliar(m.id, m.nombre));
      if (dropdownResults) dropdownResults.appendChild(li);
    });

    if (dropdownResults) dropdownResults.style.display = 'block';
    abrirDropdown();
  }

  function seleccionarFamiliar(id, nombre) {
    if (familiarIdInput) familiarIdInput.value = id;
    if (chipAvatar) chipAvatar.textContent = getInitials(nombre);
    if (chipNombre) chipNombre.textContent = nombre;
    if (familiarChip) familiarChip.style.display = 'flex';
    if (buscarInput) buscarInput.style.display = 'none';
    if (autocompleteField) autocompleteField.classList.add('has-selection');
    cerrarDropdown();
    
    // Validar en tiempo real despuÃ©s de seleccionar
    validarRelacionEnTiempoReal();
  }

  window.limpiarSeleccionFamiliar = function() {
    if (familiarIdInput) familiarIdInput.value = '';
    if (familiarChip) familiarChip.style.display = 'none';
    if (buscarInput) {
      buscarInput.style.display = '';
      buscarInput.value = '';
    }
    if (autocompleteField) autocompleteField.classList.remove('has-selection');
    if (buscarInput) buscarInput.focus();
    limpiarValidaciones();
  };

  function abrirDropdown() {
    if (dropdown) dropdown.classList.add('open');
  }

  function cerrarDropdown() {
    if (dropdown) dropdown.classList.remove('open');
  }

  function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ValidaciÃ³n antes de enviar
  const formRelacion = document.getElementById('formRelacionSubmit');
  if (formRelacion) {
    formRelacion.addEventListener('submit', function(e) {
      const tipoRelacion = document.getElementById('selectTipoRelacion');
      const familiarId = document.getElementById('familiarIdInput');
      const tieneErrores = document.querySelector('.validacion-errores');

      if (tipoRelacion && !tipoRelacion.value) {
        e.preventDefault();
        alert('Selecciona el tipo de relaciÃ³n');
        return;
      }

      if (familiarId && !familiarId.value) {
        e.preventDefault();
        alert('Busca y selecciona un familiar');
        return;
      }
      
      if (tieneErrores) {
        e.preventDefault();
        alert('No se puede crear esta relaciÃ³n. Revisa los errores.');
        return;
      }
    });
  }
})();
</script>

{% endblock %}