{% extends 'core/base.html' %}
{% load static %}

{% block title %}Registrar ingreso Â· Soid_Tf_2{% endblock %}

{% block content %}

<div class="odoo-page">
    

    <!-- BARRA SUPERIOR -->
    <div class="odoo-topbar">
        <div class="odoo-topbar-left">
            <a href="{% url 'finanzas_app:movimientos_listado' %}?tipo=ingreso" class="odoo-back-link">
                <span class="material-icons">arrow_back</span>
            </a>
            <div class="odoo-breadcrumb">
                <span class="odoo-breadcrumb-parent">Ingresos</span>
                <span class="odoo-breadcrumb-separator">/</span>
                <span class="odoo-breadcrumb-current">Nuevo</span>
            </div>
        </div>
        <div class="odoo-topbar-right">
            <span class="odoo-record-count">Nuevo</span>
        </div>
    </div>

    <!-- BARRA DE ACCIONES -->
    <div class="odoo-actionbar">
        <div class="odoo-actionbar-left">
            <button type="submit" form="ingreso-form" class="odoo-btn odoo-btn-primary">
                Confirmar
            </button>
            <a href="{% url 'finanzas_app:movimientos_listado' %}?tipo=ingreso" class="odoo-btn odoo-btn-secondary">
                Cancelar
            </a>
        </div>
    </div>

    <!-- FORMULARIO PRINCIPAL -->
    <div class="odoo-form-sheet">
        <form method="post" novalidate id="ingreso-form">
            {% csrf_token %}

            <!-- CONTENIDO EN DOS COLUMNAS -->
            <div class="odoo-form-content">
                
                <!-- COLUMNA IZQUIERDA -->
                <div class="odoo-form-col">
                    <div class="odoo-field-row">
                        <label>Fecha</label>
                        <div class="odoo-field-value">
                            {{ form.fecha }}
                            {% if form.fecha.errors %}<span class="odoo-error">{{ form.fecha.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="odoo-field-row odoo-field-amount">
                        <label>Monto</label>
                        <div class="odoo-field-value odoo-amount-value">
                            <span class="odoo-currency">RD$</span>
                            {{ form.monto }}
                            {% if form.monto.errors %}<span class="odoo-error">{{ form.monto.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="odoo-field-row">
                        <label>CategorÃ­a</label>
                        <div class="odoo-field-value">
                            {{ form.categoria }}
                            {% if form.categoria.errors %}<span class="odoo-error">{{ form.categoria.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- ðŸ‘‡ AUTOCOMPLETE DE MIEMBRO - CÃ“DIGO DIRECTO (NO INCLUDE) -->
                    <div class="odoo-field-row" style="grid-column: 1 / -1; position: relative;">
                        <label for="search-id_persona_asociada" style="text-align: left;">Persona (opcional)</label>
                        <div class="odoo-field-value">
                            
                            <!-- Input de bÃºsqueda visible -->
                            <div class="autocomplete-input-group">
                                <input 
                                    type="text" 
                                    id="search-id_persona_asociada" 
                                    class="autocomplete-search" 
                                    placeholder="Escribe nombre, apellido o cÃ³digo..."
                                    autocomplete="off"
                                    data-filtro="activos"
                                    style="width: 100%; padding: 10px 36px 10px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;"
                                >
                                <button type="button" class="autocomplete-clear-btn" title="Limpiar" style="position: absolute; right: 8px; background: transparent; border: none; cursor: pointer; padding: 4px; color: #9ca3af; display: none; z-index: 5;">
                                    <span class="material-icons" style="font-size: 18px;">close</span>
                                </button>
                            </div>
                            
                            <!-- Dropdown de resultados -->
                            <div class="autocomplete-dropdown" id="dropdown-id_persona_asociada" style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid #e5e7eb; border-radius: 4px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); z-index: 1000; max-height: 300px; overflow-y: auto;">
                                <ul class="autocomplete-list" style="list-style: none; margin: 0; padding: 4px 0;"></ul>
                                <div class="autocomplete-empty" style="display: none; padding: 24px 16px; text-align: center; color: #9ca3af; font-size: 13px;">
                                    <span class="material-icons" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 8px;">search</span>
                                    <p>No se encontraron miembros</p>
                                </div>
                                <div class="autocomplete-loading" style="display: none; padding: 24px 16px; text-align: center; color: #9ca3af; font-size: 13px;">
                                    <span class="material-icons spinner" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 8px; animation: spin 1s linear infinite;">refresh</span>
                                    <p>Buscando...</p>
                                </div>
                            </div>
                            
                            <!-- Campo hidden para guardar el ID -->
                            <input 
                                type="hidden" 
                                id="id_persona_asociada" 
                                name="persona_asociada" 
                                value=""
                            >
                            
                            <!-- Mostrar confirmaciÃ³n de selecciÃ³n -->
                            <div class="autocomplete-selected" style="display: none; margin-top: 12px;">
                                <div class="selected-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: #ecfdf5; border: 1px solid #86efac; border-radius: 4px;">
                                    <div class="selected-info" style="display: flex; flex-direction: column; gap: 2px;">
                                        <span class="selected-name" style="font-size: 13px; font-weight: 600; color: #065f46;"></span>
                                        <span class="selected-codigo" style="font-size: 12px; color: #059669;"></span>
                                    </div>
                                    <button type="button" class="selected-remove" title="Quitar selecciÃ³n" style="background: transparent; border: none; cursor: pointer; padding: 4px; color: #059669; transition: color 0.15s;">
                                        <span class="material-icons" style="font-size: 18px;">clear</span>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA -->
                <div class="odoo-form-col">
                    <div class="odoo-field-row">
                        <label>Cuenta</label>
                        <div class="odoo-field-value">
                            {{ form.cuenta }}
                            {% if form.cuenta.errors %}<span class="odoo-error">{{ form.cuenta.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="odoo-field-row">
                        <label>Forma de pago</label>
                        <div class="odoo-field-value">
                            {{ form.forma_pago }}
                            {% if form.forma_pago.errors %}<span class="odoo-error">{{ form.forma_pago.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- Campo condicional: solo si forma de pago es transferencia o cheque -->
                    <div class="odoo-field-row odoo-field-conditional" id="field-referencia" style="display: none;">
                        <label>Referencia</label>
                        <div class="odoo-field-value">
                            {{ form.referencia }}
                            {% if form.referencia.errors %}<span class="odoo-error">{{ form.referencia.errors.0 }}</span>{% endif %}
                        </div>
                    </div>
                </div>

            </div>

            <!-- DESCRIPCIÃ“N - ANCHO COMPLETO -->
            <div class="odoo-form-full">
                <div class="odoo-field-row">
                    <label>DescripciÃ³n</label>
                    <div class="odoo-field-value">
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}<span class="odoo-error">{{ form.descripcion.errors.0 }}</span>{% endif %}
                        <span class="odoo-field-hint">Opcional. Agrega detalles si es necesario.</span>
                    </div>
                </div>
            </div>

        </form>
    </div>

</div>

<style>
    /* =====================================
       ODOO FORM - ESTILO EXACTO
       ===================================== */
    
    /* Autocomplete dropdown - control de visibilidad */
    .autocomplete-dropdown {
        display: none !important;
    }
    
    .autocomplete-dropdown.open {
        display: block !important;
    }

    /* Input de autocomplete - estilo lÃ­nea como los demÃ¡s campos */
    .autocomplete-search {
        width: 100%;
        border: none !important;
        border-bottom: 1px solid transparent !important;
        border-radius: 0 !important;
        background: transparent !important;
        padding: 4px 0 !important;
        font-size: 13px;
        color: var(--odoo-text);
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .autocomplete-search:hover {
        border-bottom-color: var(--odoo-border) !important;
    }

    .autocomplete-search:focus {
        outline: none;
        border-bottom-color: var(--odoo-purple) !important;
        border-bottom-width: 2px !important;
        padding-bottom: 3px !important;
        box-shadow: none !important;
    }

    .autocomplete-input-group {
        position: relative;
    }

    .autocomplete-clear-btn {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
    }

    /* Estilos para items del autocomplete */
    .autocomplete-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.15s;
    }

    .autocomplete-item:hover {
        background: #f5f5f5;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .autocomplete-item-nombre {
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .autocomplete-item-codigo {
        font-size: 12px;
        color: #888;
        background: #f0f0f0;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .autocomplete-item-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 12px;
    }

    :root {
        --odoo-purple: #714B67;
        --odoo-purple-dark: #5d3d54;
        --odoo-text: #212529;
        --odoo-text-muted: #6c757d;
        --odoo-border: #dee2e6;
        --odoo-bg: #ffffff;
        --odoo-bg-gray: #f8f9fa;
        --odoo-success: #28a745;
        --odoo-error: #dc3545;
    }

    .odoo-page {
        background: var(--odoo-bg-gray);
        min-height: 100vh;
    }

    /* BARRA SUPERIOR - NAVEGACIÃ“N */
    .odoo-topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: var(--odoo-bg);
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-topbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .odoo-back-link {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        color: var(--odoo-text-muted);
        border-radius: 4px;
        transition: all 0.15s;
    }

    .odoo-back-link:hover {
        background: var(--odoo-bg-gray);
        color: var(--odoo-text);
    }

    .odoo-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .odoo-breadcrumb-parent {
        color: var(--odoo-purple);
        font-weight: 500;
    }

    .odoo-breadcrumb-separator {
        color: var(--odoo-text-muted);
    }

    .odoo-breadcrumb-current {
        color: var(--odoo-text);
        font-weight: 600;
    }

    .odoo-record-count {
        font-size: 13px;
        color: var(--odoo-text-muted);
    }

    /* BARRA DE ACCIONES */
    .odoo-actionbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: var(--odoo-bg);
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-actionbar-left {
        display: flex;
        gap: 8px;
    }

    /* BOTONES */
    .odoo-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 16px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
        font-family: inherit;
    }

    .odoo-btn-primary {
        background: var(--odoo-purple);
        color: white;
        border-color: var(--odoo-purple);
    }

    .odoo-btn-primary:hover {
        background: var(--odoo-purple-dark);
        border-color: var(--odoo-purple-dark);
    }

    .odoo-btn-secondary {
        background: var(--odoo-bg);
        color: var(--odoo-text);
    }

    .odoo-btn-secondary:hover {
        background: var(--odoo-bg-gray);
    }

    /* FORMULARIO */
    .odoo-form-sheet {
        max-width: 1200px;
        margin: 16px auto;
        background: var(--odoo-bg);
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        padding: 0;
    }

    .odoo-form-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        padding: 24px;
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-form-col {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .odoo-field-row {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        align-items: center;
    }

    .odoo-field-row label {
        font-size: 13px;
        font-weight: 600;
        color: var(--odoo-text);
        text-align: right;
    }

    .odoo-field-value {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .odoo-form-sheet input,
    .odoo-form-sheet select,
    .odoo-form-sheet textarea {
        width: 100%;
        border: none;
        border-bottom: 1px solid transparent;
        background: transparent;
        padding: 4px 0;
        font-size: 13px;
        color: var(--odoo-text);
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .odoo-form-sheet input:hover,
    .odoo-form-sheet select:hover,
    .odoo-form-sheet textarea:hover {
        border-bottom-color: var(--odoo-border);
    }

    .odoo-form-sheet input:focus,
    .odoo-form-sheet select:focus,
    .odoo-form-sheet textarea:focus {
        outline: none;
        border-bottom-color: var(--odoo-purple);
        border-bottom-width: 2px;
        padding-bottom: 3px;
    }

    .odoo-form-sheet select {
        appearance: none;
        cursor: pointer;
        padding-right: 20px;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0 center;
        background-size: 16px;
    }

    .odoo-form-sheet textarea {
        min-height: 60px;
        resize: vertical;
        line-height: 1.5;
    }

    /* CAMPO DE MONTO */
    .odoo-field-amount .odoo-field-value {
        flex-direction: row;
        align-items: center;
    }

    .odoo-amount-value {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .odoo-currency {
        font-size: 13px;
        font-weight: 500;
        color: var(--odoo-text-muted);
    }

    .odoo-amount-value input {
        font-weight: 600;
        font-size: 15px;
    }

    /* CAMPOS DE ANCHO COMPLETO */
    .odoo-form-full {
        padding: 0 24px 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .odoo-form-full .odoo-field-row {
        grid-template-columns: 140px 1fr;
    }

    /* ERRORES */
    .odoo-error {
        font-size: 11px;
        color: var(--odoo-error);
        margin-top: 2px;
    }

    /* HINT */
    .odoo-field-hint {
        font-size: 11px;
        color: var(--odoo-text-muted);
        font-style: italic;
        margin-top: 4px;
    }

    /* CAMPOS CONDICIONALES */
    .odoo-field-conditional {
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* AUTOCOMPLETE STYLES */
    .autocomplete-input-group {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .autocomplete-search:not(:placeholder-shown) ~ .autocomplete-clear-btn {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.15s;
        border-bottom: 1px solid #f3f4f6;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background: #f9fafb;
    }

    .autocomplete-item-main {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        margin-bottom: 4px;
    }

    .autocomplete-item-nombre {
        font-size: 13px;
        font-weight: 500;
        color: #111827;
    }

    .autocomplete-item-codigo {
        font-size: 11px;
        color: #9ca3af;
        background: #f3f4f6;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .autocomplete-item-meta {
        display: flex;
        gap: 16px;
        font-size: 11px;
        color: #6b7280;
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
        .odoo-form-content {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .odoo-field-row {
            grid-template-columns: 120px 1fr;
        }

        .odoo-form-full .odoo-field-row {
            grid-template-columns: 120px 1fr;
        }
    }

    @media (max-width: 600px) {
        .odoo-field-row {
            grid-template-columns: 1fr;
            gap: 4px;
        }

        .odoo-field-row label {
            text-align: left;
            font-size: 11px;
            color: var(--odoo-text-muted);
        }

        .odoo-form-full .odoo-field-row {
            grid-template-columns: 1fr;
        }
    }

    /* PLACEHOLDER */
    .odoo-form-sheet input::placeholder,
    .odoo-form-sheet textarea::placeholder {
        color: #adb5bd;
        font-style: normal;
    }

    /* INPUT DATE */
    .odoo-form-sheet input[type="date"] {
        font-variant-numeric: tabular-nums;
    }

    /* INPUT NUMBER */
    .odoo-form-sheet input[type="number"] {
        font-variant-numeric: tabular-nums;
        -moz-appearance: textfield;
    }

    .odoo-form-sheet input[type="number"]::-webkit-outer-spin-button,
    .odoo-form-sheet input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
// LÃ³gica para mostrar/ocultar campo de referencia
document.addEventListener('DOMContentLoaded', function() {
    const formaPagoSelect = document.querySelector('[name="forma_pago"]');
    const fieldReferencia = document.getElementById('field-referencia');

    const pagosConReferencia = ['transferencia', 'cheque', 'deposito', 'depÃ³sito'];

    function toggleReferencia() {
        if (!formaPagoSelect || !fieldReferencia) return;
        const valor = formaPagoSelect.options[formaPagoSelect.selectedIndex]?.text.toLowerCase() || '';
        const mostrar = pagosConReferencia.some(pago => valor.includes(pago));
        fieldReferencia.style.display = mostrar ? '' : 'none';
    }

    if (formaPagoSelect) {
        formaPagoSelect.addEventListener('change', toggleReferencia);
        toggleReferencia();
    }
});

// ====================================
// AUTOCOMPLETE DE MIEMBROS - CÃ“DIGO DIRECTO
// ====================================

class AutocompleteMiembro {
    constructor(fieldId) {
        this.fieldId = fieldId;
        this.inputSearch = document.getElementById(`search-${fieldId}`);
        this.dropdownEl = document.getElementById(`dropdown-${fieldId}`);
        this.listEl = this.dropdownEl.querySelector('.autocomplete-list');
        this.emptyEl = this.dropdownEl.querySelector('.autocomplete-empty');
        this.loadingEl = this.dropdownEl.querySelector('.autocomplete-loading');
        this.hiddenInput = document.getElementById(fieldId);

        this.debounceTimer = null;
        this.debounceDelay = 300;
        this.minChars = 2;

        if (!this.inputSearch) return;

        this.attachEventListeners();
    }

    attachEventListeners() {
        // BÃºsqueda con debounce
        this.inputSearch.addEventListener('input', (e) => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                this.search(e.target.value);
            }, this.debounceDelay);
        });

        // Click fuera cierra dropdown
        document.addEventListener('click', (e) => {
            if (!this.inputSearch.contains(e.target) && !this.dropdownEl.contains(e.target)) {
                this.closeDropdown();
            }
        });

        // BotÃ³n limpiar
        const clearBtn = document.querySelector(`.autocomplete-clear-btn[data-field="${this.fieldId}"]`) || 
                         this.inputSearch.parentElement.querySelector('.autocomplete-clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.clearSelection();
            });
        }

        // Focus abre dropdown si hay contenido
        this.inputSearch.addEventListener('focus', () => {
            if (this.inputSearch.value.length >= this.minChars) {
                this.dropdownEl.classList.add('open');
            }
        });

        // Navegar con teclado
        this.inputSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeDropdown();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const firstItem = this.listEl.querySelector('.autocomplete-item');
                if (firstItem) {
                    this.selectItem(
                        parseInt(firstItem.dataset.id),
                        firstItem.dataset.nombre,
                        firstItem.dataset.codigo
                    );
                }
            }
        });
    }

    async search(query) {
        query = query.trim();

        if (query.length < this.minChars) {
            this.closeDropdown();
            return;
        }

        this.showLoading();
        this.openDropdown();

        try {
            const filtro = this.inputSearch.dataset.filtro || 'activos';
            const response = await fetch(
                `/api/buscar-miembros/?q=${encodeURIComponent(query)}&filtro=${filtro}&limit=15`,
                {
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.resultados.length > 0) {
                this.renderResults(data.resultados);
            } else {
                this.showEmpty();
            }
        } catch (error) {
            console.error('Error en bÃºsqueda:', error);
            this.showEmpty();
        }
    }

    renderResults(resultados) {
        this.listEl.innerHTML = '';

        resultados.forEach((miembro) => {
            const item = document.createElement('li');
            item.className = 'autocomplete-item';
            item.dataset.id = miembro.id;
            item.dataset.nombre = miembro.nombre;
            item.dataset.codigo = miembro.codigo;

            item.innerHTML = `
                <div class="autocomplete-item-main">
                    <span class="autocomplete-item-nombre">${this.escapeHtml(miembro.nombre)}</span>
                    ${miembro.codigo ? `<span class="autocomplete-item-codigo">${this.escapeHtml(miembro.codigo)}</span>` : ''}
                </div>
                <div class="autocomplete-item-meta">
                    ${miembro.edad ? `<span>Edad: ${miembro.edad}</span>` : ''}
                    ${miembro.telefono && miembro.telefono !== 'â€”' ? `<span>${this.escapeHtml(miembro.telefono)}</span>` : ''}
                </div>
            `;

            item.addEventListener('click', () => {
                this.selectItem(miembro.id, miembro.nombre, miembro.codigo);
            });

            this.listEl.appendChild(item);
        });

        this.emptyEl.style.display = 'none';
        this.loadingEl.style.display = 'none';
        this.listEl.style.display = 'block';
    }

    selectItem(id, nombre, codigo) {
        this.hiddenInput.value = id;
        this.inputSearch.value = nombre;
        this.closeDropdown();
        this.showSelected(nombre, codigo);
    }

    clearSelection() {
        this.hiddenInput.value = '';
        this.inputSearch.value = '';
        const selectedDiv = this.dropdownEl.closest('.odoo-field-row').querySelector('.autocomplete-selected');
        if (selectedDiv) {
            selectedDiv.style.display = 'none';
        }
        this.listEl.innerHTML = '';
        this.closeDropdown();
        this.inputSearch.focus();
    }

    showSelected(nombre, codigo) {
        const selectedDiv = this.dropdownEl.closest('.odoo-field-row').querySelector('.autocomplete-selected');
        if (selectedDiv) {
            selectedDiv.style.display = 'block';
            selectedDiv.querySelector('.selected-name').textContent = nombre;
            selectedDiv.querySelector('.selected-codigo').textContent = codigo || 'Sin cÃ³digo';

            // BotÃ³n para quitar selecciÃ³n
            const removeBtn = selectedDiv.querySelector('.selected-remove');
            if (removeBtn && !removeBtn.dataset.listener) {
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.clearSelection();
                });
                removeBtn.dataset.listener = 'true';
            }
        }
    }

    showLoading() {
        this.listEl.innerHTML = '';
        this.listEl.style.display = 'none';
        this.emptyEl.style.display = 'none';
        this.loadingEl.style.display = 'block';
    }

    showEmpty() {
        this.listEl.innerHTML = '';
        this.listEl.style.display = 'none';
        this.loadingEl.style.display = 'none';
        this.emptyEl.style.display = 'block';
    }

    openDropdown() {
        this.dropdownEl.classList.add('open');
    }

    closeDropdown() {
        this.dropdownEl.classList.remove('open');
    }

    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
    }
}

// Inicializar autocomplete
document.addEventListener('DOMContentLoaded', () => {
    new AutocompleteMiembro('id_persona_asociada');
});
</script>
{% endblock %}