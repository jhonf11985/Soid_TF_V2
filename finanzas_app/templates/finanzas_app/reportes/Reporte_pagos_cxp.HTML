{% extends "finanzas_app/base_finanzas.html" %}
{% load humanize %}

{% block title %}Historial de Pagos CxP{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(56, 142, 60, 0.3);
    }
    .report-header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
    .report-header .subtitle { opacity: 0.9; font-size: 0.9rem; margin-top: 0.25rem; }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .summary-card {
        background: white;
        border-radius: 10px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #388e3c;
    }
    .summary-card .label { font-size: 0.8rem; color: #666; text-transform: uppercase; }
    .summary-card .value { font-size: 1.5rem; font-weight: 700; color: #388e3c; margin-top: 0.25rem; }
    
    .filters-section {
        background: white;
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .filters-grid { display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; }
    .filter-group label {
        display: block;
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 0.35rem;
        font-weight: 500;
    }
    .filter-group select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.875rem;
    }
    .filter-group select:focus { outline: none; border-color: #0097a7; }
    
    .btn-filter {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }
    .btn-filter.primary { background: #0097a7; color: white; }
    .btn-filter.secondary { background: #f5f5f5; color: #666; }
    
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    .table-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .table-header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
    
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
        background: #f8f9fa;
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        border-bottom: 2px solid #eee;
    }
    .data-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.875rem;
    }
    .data-table tr:hover { background: #f8f9fa; }
    .data-table tfoot td {
        background: #f8f9fa;
        font-weight: 700;
        border-top: 2px solid #eee;
    }
    
    .text-right { text-align: right; }
    .amount { font-family: 'Roboto Mono', monospace; font-weight: 500; }
    .positive { color: #388e3c; }
    
    .badge-forma {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .resumen-proveedor {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .resumen-proveedor .header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #eee;
    }
    .resumen-proveedor .header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
    
    .proveedor-list {
        padding: 0;
        margin: 0;
        list-style: none;
    }
    .proveedor-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1.25rem;
        border-bottom: 1px solid #f0f0f0;
    }
    .proveedor-item:last-child { border-bottom: none; }
    .proveedor-item .nombre { font-weight: 500; }
    .proveedor-item .stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .proveedor-item .stat {
        text-align: right;
    }
    .proveedor-item .stat-label { font-size: 0.7rem; color: #999; }
    .proveedor-item .stat-value { font-weight: 600; color: #388e3c; }
    
    .btn-print {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #666;
        cursor: pointer;
    }
    
    .empty-state { text-align: center; padding: 2rem; color: #999; }
    
    @media print {
        .filters-section, .btn-print, .no-print { display: none !important; }
        .report-header { background: #388e3c !important; -webkit-print-color-adjust: exact; }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-header">
    <h1><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">payments</span>Historial de Pagos a CxP</h1>
    <div class="subtitle">{{ mes_label }}</div>
</div>

<div class="summary-cards">
    <div class="summary-card">
        <div class="label">Pagos Realizados</div>
        <div class="value">{{ cantidad }}</div>
    </div>
    <div class="summary-card">
        <div class="label">Total Pagado</div>
        <div class="value">RD$ {{ total_pagado|intcomma }}</div>
    </div>
</div>

<div class="filters-section no-print">
    <form method="get">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Mes</label>
                <select name="month">
                    {% for m_val, m_name in meses %}
                    <option value="{{ m_val }}" {% if month == m_val %}selected{% endif %}>{{ m_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Año</label>
                <select name="year">
                    {% for y in "2024 2025 2026 2027"|make_list %}
                    {% endfor %}
                    <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
                    <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Proveedor</label>
                <select name="proveedor">
                    <option value="">Todos</option>
                    {% for p in proveedores %}
                    <option value="{{ p.id }}" {% if proveedor_id == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn-filter primary">Filtrar</button>
                <a href="{% url 'finanzas_app:reporte_pagos_cxp' %}" class="btn-filter secondary">Limpiar</a>
            </div>
        </div>
    </form>
</div>

<!-- Resumen por proveedor -->
{% if por_proveedor %}
<div class="resumen-proveedor" style="margin-bottom: 1.5rem;">
    <div class="header">
        <h3>Resumen por Proveedor</h3>
    </div>
    <ul class="proveedor-list">
        {% for row in por_proveedor %}
        <li class="proveedor-item">
            <span class="nombre">{{ row.cuenta_por_pagar__proveedor__nombre }}</span>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Pagos</div>
                    <div class="stat-value">{{ row.cantidad }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Total</div>
                    <div class="stat-value">RD$ {{ row.monto|intcomma }}</div>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Detalle de pagos -->
<div class="table-container">
    <div class="table-header">
        <h3>Detalle de Pagos ({{ cantidad }})</h3>
        <button class="btn-print no-print" onclick="window.print()">
            <span class="material-icons">print</span>
            Imprimir
        </button>
    </div>
    
    {% if items %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>CxP / Concepto</th>
                <th>Cuenta</th>
                <th>Forma Pago</th>
                <th class="text-right">Monto</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in items %}
            <tr>
                <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                <td><strong>{{ mov.cuenta_por_pagar.proveedor.nombre }}</strong></td>
                <td>
                    {{ mov.cuenta_por_pagar.concepto|truncatechars:30 }}
                    {% if mov.referencia %}
                    <br><small style="color: #999;">Ref: {{ mov.referencia }}</small>
                    {% endif %}
                </td>
                <td>{{ mov.cuenta.nombre }}</td>
                <td><span class="badge-forma">{{ mov.get_forma_pago_display }}</span></td>
                <td class="text-right amount positive">{{ mov.monto|intcomma }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="5"><strong>TOTAL PAGADO</strong></td>
                <td class="text-right amount positive" style="font-size: 1rem;">RD$ {{ total_pagado|intcomma }}</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="empty-state">
        <span class="material-icons" style="font-size: 2rem;">inbox</span>
        <p>No se encontraron pagos de CxP en el período seleccionado.</p>
    </div>
    {% endif %}
</div>

{% if auto_print %}
<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); };</script>
{% endif %}
{% endblock %}