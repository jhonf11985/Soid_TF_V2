{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard de Finanzas · Soid_Tf_2{% endblock %}

{% block content %}

<div class="odoo-page">

    <!-- BARRA SUPERIOR -->
    <div class="odoo-topbar">
        <div class="odoo-topbar-left">
            <div class="odoo-breadcrumb">
                <span class="odoo-breadcrumb-current">Dashboard de Finanzas</span>
            </div>
        </div>
        <div class="odoo-topbar-right">
            <span class="odoo-record-count">{{ fecha_hoy|date:"d/m/Y" }}</span>
        </div>
    </div>

    <!-- BARRA DE ACCIONES -->
    <div class="odoo-actionbar">
        <div class="odoo-actionbar-left">
            <a href="{% url 'finanzas_app:ingreso_crear' %}" class="odoo-btn odoo-btn-primary">
                <span class="material-icons" style="font-size: 16px;">add</span>
                Nuevo ingreso
            </a>
            <a href="{% url 'finanzas_app:egreso_crear' %}" class="odoo-btn odoo-btn-secondary">
                <span class="material-icons" style="font-size: 16px;">remove</span>
                Nuevo egreso
            </a>
        </div>
        <div class="odoo-actionbar-right">
            <a href="{% url 'finanzas_app:movimientos_listado' %}" class="odoo-btn odoo-btn-ghost">
                <span class="material-icons" style="font-size: 16px;">list</span>
                Ver movimientos
            </a>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="odoo-dashboard-content">

        <!-- TARJETAS DE RESUMEN -->
        <div class="odoo-cards-row">
            <div class="odoo-summary-card odoo-card-success">
                <div class="odoo-card-icon">
                    <span class="material-icons">trending_up</span>
                </div>
                <div class="odoo-card-info">
                    <span class="odoo-card-label">Ingresos del mes</span>
                    <span class="odoo-card-value">RD$ {{ resumen.ingresos_mes|floatformat:2|default:"0.00" }}</span>
                    <span class="odoo-card-subtitle">{{ mes_actual }}</span>
                </div>
            </div>

            <div class="odoo-summary-card odoo-card-danger">
                <div class="odoo-card-icon">
                    <span class="material-icons">trending_down</span>
                </div>
                <div class="odoo-card-info">
                    <span class="odoo-card-label">Egresos del mes</span>
                    <span class="odoo-card-value">RD$ {{ resumen.egresos_mes|floatformat:2|default:"0.00" }}</span>
                    <span class="odoo-card-subtitle">{{ mes_actual }}</span>
                </div>
            </div>

            <div class="odoo-summary-card odoo-card-primary">
                <div class="odoo-card-icon">
                    <span class="material-icons">account_balance</span>
                </div>
                <div class="odoo-card-info">
                    <span class="odoo-card-label">Balance del mes</span>
                    <span class="odoo-card-value">RD$ {{ resumen.balance|floatformat:2|default:"0.00" }}</span>
                    <span class="odoo-card-subtitle">Ingresos - Egresos</span>
                </div>
            </div>

            <div class="odoo-summary-card odoo-card-purple">
                <div class="odoo-card-icon">
                    <span class="material-icons">savings</span>
                </div>
                <div class="odoo-card-info">
                    <span class="odoo-card-label">Saldo actual</span>
                    <span class="odoo-card-value">RD$ {{ saldo_actual|floatformat:2|default:"0.00" }}</span>
                    <span class="odoo-card-subtitle">Total en cuentas</span>
                </div>
            </div>
        </div>

        <!-- GRÁFICOS -->
        <div class="odoo-panels-row">
            <!-- Gráfico de barras -->
            <div class="odoo-panel odoo-panel-large">
                <div class="odoo-panel-header">
                    <h3>Ingresos vs Egresos</h3>
                    <div class="odoo-panel-legend">
                        <span class="odoo-legend-item">
                            <span class="odoo-legend-dot" style="background: #28a745;"></span>
                            Ingresos
                        </span>
                        <span class="odoo-legend-item">
                            <span class="odoo-legend-dot" style="background: #dc3545;"></span>
                            Egresos
                        </span>
                    </div>
                </div>
                <div class="odoo-panel-body">
                    <div class="odoo-chart-container">
                        <canvas id="chartBarras"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico de dona -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h3>Distribución de ingresos</h3>
                </div>
                <div class="odoo-panel-body">
                    <div class="odoo-chart-container-small">
                        <canvas id="chartDona"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CUENTAS Y CATEGORÍAS -->
        <div class="odoo-panels-row">
            <!-- Saldo por cuenta -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h3>Saldo por cuenta</h3>
                    <a href="{% url 'finanzas_app:cuentas_listado' %}" class="odoo-panel-link">Ver todas →</a>
                </div>
                <div class="odoo-panel-body">
                    {% if cuentas_resumen %}
                        <div class="odoo-accounts-list">
                            {% for item in cuentas_resumen %}
                            <div class="odoo-account-item">
                                <div class="odoo-account-info">
                                    <span class="odoo-account-name">{{ item.cuenta.nombre }}</span>
                                    <span class="odoo-account-type">{{ item.cuenta.get_tipo_display }} · {{ item.cuenta.moneda }}</span>
                                </div>
                                <div class="odoo-account-balance">
                                    <span class="odoo-account-total">{{ item.cuenta.moneda }} {{ item.saldo_actual|floatformat:2 }}</span>
                                    <span class="odoo-account-detail">
                                        <span class="text-success">+{{ item.ingresos|floatformat:0 }}</span>
                                        /
                                        <span class="text-danger">-{{ item.egresos|floatformat:0 }}</span>
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="odoo-empty-state">
                            <span class="material-icons">account_balance</span>
                            <p>No hay cuentas activas</p>
                            <a href="{% url 'finanzas_app:cuenta_crear' %}">Crear cuenta</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Top categorías -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h3>Top categorías del mes</h3>
                </div>
                <div class="odoo-panel-body">
                    <div class="odoo-categories-grid">
                        <!-- Ingresos -->
                        <div class="odoo-category-col">
                            <h4 class="odoo-category-title text-success">
                                <span class="material-icons">arrow_downward</span>
                                Ingresos
                            </h4>
                            {% if top_categorias_ingreso %}
                                {% for cat in top_categorias_ingreso %}
                                <div class="odoo-category-item">
                                    <span class="odoo-category-name">{{ cat.categoria__nombre }}</span>
                                    <span class="odoo-category-value text-success">{{ cat.total|floatformat:2 }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="odoo-no-data">Sin datos</p>
                            {% endif %}
                        </div>
                        <!-- Egresos -->
                        <div class="odoo-category-col">
                            <h4 class="odoo-category-title text-danger">
                                <span class="material-icons">arrow_upward</span>
                                Egresos
                            </h4>
                            {% if top_categorias_egreso %}
                                {% for cat in top_categorias_egreso %}
                                <div class="odoo-category-item">
                                    <span class="odoo-category-name">{{ cat.categoria__nombre }}</span>
                                    <span class="odoo-category-value text-danger">{{ cat.total|floatformat:2 }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="odoo-no-data">Sin datos</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÚLTIMOS MOVIMIENTOS -->
        <div class="odoo-panel odoo-panel-full">
            <div class="odoo-panel-header">
                <h3>Últimos movimientos</h3>
                <a href="{% url 'finanzas_app:movimientos_listado' %}" class="odoo-panel-link">Ver todos →</a>
            </div>
            <div class="odoo-panel-body odoo-panel-table">
                <table class="odoo-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Cuenta</th>
                            <th>Categoría</th>
                            <th>Descripción</th>
                            <th class="text-right">Monto</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if ultimos_movimientos %}
                            {% for mov in ultimos_movimientos %}
                            <tr>
                                <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                                <td>
                                    {% if mov.tipo == 'ingreso' %}
                                        <span class="odoo-badge odoo-badge-success">
                                            <span class="material-icons">arrow_downward</span>
                                            Ingreso
                                        </span>
                                    {% else %}
                                        <span class="odoo-badge odoo-badge-danger">
                                            <span class="material-icons">arrow_upward</span>
                                            Egreso
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ mov.cuenta.nombre }}</td>
                                <td>{{ mov.categoria.nombre }}</td>
                                <td>{{ mov.descripcion|default:"—"|truncatechars:35 }}</td>
                                <td class="text-right {% if mov.tipo == 'ingreso' %}text-success{% else %}text-danger{% endif %}">
                                    <strong>{% if mov.tipo == 'ingreso' %}+{% else %}-{% endif %}{{ mov.monto|floatformat:2 }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if mov.estado == 'confirmado' %}
                                        <span class="odoo-status odoo-status-success">Confirmado</span>
                                    {% elif mov.estado == 'pendiente' %}
                                        <span class="odoo-status odoo-status-warning">Pendiente</span>
                                    {% elif mov.estado == 'anulado' %}
                                        <span class="odoo-status odoo-status-danger">Anulado</span>
                                    {% else %}
                                        <span class="odoo-status">{{ mov.get_estado_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="odoo-table-empty">
                                    <span class="material-icons">inbox</span>
                                    <p>No hay movimientos registrados</p>
                                    <a href="{% url 'finanzas_app:ingreso_crear' %}">Registrar el primer ingreso</a>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ESTADÍSTICAS -->
        <div class="odoo-stats-row">
            <div class="odoo-stat-item">
                <span class="odoo-stat-value">{{ stats.total_movimientos_mes }}</span>
                <span class="odoo-stat-label">Movimientos este mes</span>
            </div>
            <div class="odoo-stat-item">
                <span class="odoo-stat-value text-success">{{ stats.promedio_ingreso|floatformat:2 }}</span>
                <span class="odoo-stat-label">Promedio por ingreso</span>
            </div>
            <div class="odoo-stat-item">
                <span class="odoo-stat-value">{{ historico.ingresos_total|floatformat:0 }}</span>
                <span class="odoo-stat-label">Ingresos históricos</span>
            </div>
            <div class="odoo-stat-item">
                <span class="odoo-stat-value">{{ historico.egresos_total|floatformat:0 }}</span>
                <span class="odoo-stat-label">Egresos históricos</span>
            </div>
        </div>

    </div>

</div>

<style>
    /* =====================================
       DASHBOARD - ESTILO ODOO
       ===================================== */
    
    :root {
        --odoo-purple: #714B67;
        --odoo-purple-dark: #5d3d54;
        --odoo-text: #212529;
        --odoo-text-muted: #6c757d;
        --odoo-border: #dee2e6;
        --odoo-bg: #ffffff;
        --odoo-bg-gray: #f8f9fa;
        --odoo-success: #28a745;
        --odoo-danger: #dc3545;
        --odoo-warning: #ffc107;
        --odoo-info: #17a2b8;
    }

    .odoo-page {
        background: var(--odoo-bg-gray);
        min-height: 100vh;
    }

    /* BARRA SUPERIOR */
    .odoo-topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: var(--odoo-bg);
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-topbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .odoo-breadcrumb-current {
        font-size: 16px;
        font-weight: 600;
        color: var(--odoo-text);
    }

    .odoo-record-count {
        font-size: 13px;
        color: var(--odoo-text-muted);
    }

    /* BARRA DE ACCIONES */
    .odoo-actionbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: var(--odoo-bg);
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-actionbar-left,
    .odoo-actionbar-right {
        display: flex;
        gap: 8px;
    }

    /* BOTONES */
    .odoo-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
        font-family: inherit;
        background: var(--odoo-bg);
        color: var(--odoo-text);
    }

    .odoo-btn-primary {
        background: var(--odoo-purple);
        color: white;
        border-color: var(--odoo-purple);
    }

    .odoo-btn-primary:hover {
        background: var(--odoo-purple-dark);
        border-color: var(--odoo-purple-dark);
    }

    .odoo-btn-secondary {
        background: var(--odoo-success);
        color: white;
        border-color: var(--odoo-success);
    }

    .odoo-btn-secondary:hover {
        background: #218838;
        border-color: #218838;
    }

    .odoo-btn-ghost:hover {
        background: var(--odoo-bg-gray);
    }

    /* CONTENIDO DEL DASHBOARD */
    .odoo-dashboard-content {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* TARJETAS DE RESUMEN */
    .odoo-cards-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    .odoo-summary-card {
        background: var(--odoo-bg);
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .odoo-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .odoo-card-icon .material-icons {
        font-size: 24px;
        color: white;
    }

    .odoo-card-success .odoo-card-icon { background: var(--odoo-success); }
    .odoo-card-danger .odoo-card-icon { background: var(--odoo-danger); }
    .odoo-card-primary .odoo-card-icon { background: var(--odoo-purple); }
    .odoo-card-purple .odoo-card-icon { background: #6f42c1; }

    .odoo-card-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .odoo-card-label {
        font-size: 12px;
        color: var(--odoo-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 500;
    }

    .odoo-card-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--odoo-text);
        font-variant-numeric: tabular-nums;
    }

    .odoo-card-subtitle {
        font-size: 11px;
        color: var(--odoo-text-muted);
    }

    /* PANELES */
    .odoo-panels-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }

    .odoo-panel {
        background: var(--odoo-bg);
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .odoo-panel-large {
        grid-column: span 1;
    }

    .odoo-panel-full {
        margin-bottom: 20px;
    }

    .odoo-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--odoo-border);
        background: var(--odoo-bg-gray);
    }

    .odoo-panel-header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--odoo-text);
    }

    .odoo-panel-link {
        font-size: 12px;
        color: var(--odoo-purple);
        text-decoration: none;
    }

    .odoo-panel-link:hover {
        text-decoration: underline;
    }

    .odoo-panel-legend {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--odoo-text-muted);
    }

    .odoo-legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .odoo-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 2px;
    }

    .odoo-panel-body {
        padding: 16px;
    }

    .odoo-panel-table {
        padding: 0;
    }

    /* GRÁFICOS */
    .odoo-chart-container {
        height: 280px;
        position: relative;
    }

    .odoo-chart-container-small {
        height: 240px;
        position: relative;
    }

    /* CUENTAS */
    .odoo-accounts-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .odoo-account-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: var(--odoo-bg-gray);
        border-radius: 4px;
        border-left: 3px solid var(--odoo-purple);
    }

    .odoo-account-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .odoo-account-name {
        font-weight: 600;
        font-size: 13px;
        color: var(--odoo-text);
    }

    .odoo-account-type {
        font-size: 11px;
        color: var(--odoo-text-muted);
    }

    .odoo-account-balance {
        text-align: right;
    }

    .odoo-account-total {
        font-weight: 700;
        font-size: 14px;
        color: var(--odoo-purple);
        display: block;
        font-variant-numeric: tabular-nums;
    }

    .odoo-account-detail {
        font-size: 11px;
    }

    /* CATEGORÍAS */
    .odoo-categories-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .odoo-category-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin: 0 0 10px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .odoo-category-title .material-icons {
        font-size: 14px;
    }

    .odoo-category-item {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid var(--odoo-border);
        font-size: 13px;
    }

    .odoo-category-item:last-child {
        border-bottom: none;
    }

    .odoo-category-name {
        color: var(--odoo-text);
    }

    .odoo-category-value {
        font-weight: 600;
        font-variant-numeric: tabular-nums;
    }

    .odoo-no-data {
        color: var(--odoo-text-muted);
        font-size: 12px;
        font-style: italic;
    }

    /* TABLA */
    .odoo-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .odoo-table thead {
        background: var(--odoo-bg-gray);
    }

    .odoo-table th {
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--odoo-text-muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        border-bottom: 1px solid var(--odoo-border);
    }

    .odoo-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--odoo-border);
        color: var(--odoo-text);
    }

    .odoo-table tbody tr:hover {
        background: #f8f4f7;
    }

    .odoo-table-empty {
        text-align: center;
        padding: 40px 20px !important;
        color: var(--odoo-text-muted);
    }

    .odoo-table-empty .material-icons {
        font-size: 40px;
        opacity: 0.3;
        display: block;
        margin-bottom: 8px;
    }

    .odoo-table-empty p {
        margin: 0 0 8px;
    }

    .odoo-table-empty a {
        color: var(--odoo-purple);
    }

    /* BADGES */
    .odoo-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
    }

    .odoo-badge .material-icons {
        font-size: 12px;
    }

    .odoo-badge-success {
        background: #d4edda;
        color: #155724;
    }

    .odoo-badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    /* STATUS */
    .odoo-status {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .odoo-status-success {
        background: #d4edda;
        color: #155724;
    }

    .odoo-status-warning {
        background: #fff3cd;
        color: #856404;
    }

    .odoo-status-danger {
        background: #f8d7da;
        color: #721c24;
    }

    /* ESTADÍSTICAS */
    .odoo-stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    .odoo-stat-item {
        background: var(--odoo-bg);
        border: 1px solid var(--odoo-border);
        border-radius: 4px;
        padding: 16px;
        text-align: center;
    }

    .odoo-stat-value {
        display: block;
        font-size: 24px;
        font-weight: 700;
        color: var(--odoo-text);
        font-variant-numeric: tabular-nums;
    }

    .odoo-stat-label {
        font-size: 11px;
        color: var(--odoo-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* EMPTY STATE */
    .odoo-empty-state {
        text-align: center;
        padding: 30px 20px;
        color: var(--odoo-text-muted);
    }

    .odoo-empty-state .material-icons {
        font-size: 40px;
        opacity: 0.3;
    }

    .odoo-empty-state p {
        margin: 8px 0;
    }

    .odoo-empty-state a {
        color: var(--odoo-purple);
    }

    /* UTILIDADES */
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .text-success { color: var(--odoo-success) !important; }
    .text-danger { color: var(--odoo-danger) !important; }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
        .odoo-cards-row {
            grid-template-columns: repeat(2, 1fr);
        }
        .odoo-stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 900px) {
        .odoo-panels-row {
            grid-template-columns: 1fr;
        }
        .odoo-dashboard-content {
            padding: 12px;
        }
    }

    @media (max-width: 600px) {
        .odoo-cards-row {
            grid-template-columns: 1fr;
        }
        .odoo-stats-row {
            grid-template-columns: 1fr;
        }
        .odoo-actionbar {
            flex-direction: column;
            gap: 10px;
        }
        .odoo-actionbar-left,
        .odoo-actionbar-right {
            width: 100%;
            justify-content: center;
        }
        .odoo-categories-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos desde Django
    const datosBarras = {{ grafico_barras|safe }};
    const datosDona = {{ grafico_dona|safe }};

    // Colores Odoo
    const colorIngreso = '#28a745';
    const colorEgreso = '#dc3545';
    const coloresDona = ['#714B67', '#8e6b82', '#28a745', '#17a2b8', '#ffc107', '#6f42c1'];

    // ========== GRÁFICO DE BARRAS ==========
    const ctxBarras = document.getElementById('chartBarras');
    if (ctxBarras) {
        new Chart(ctxBarras, {
            type: 'bar',
            data: {
                labels: datosBarras.labels,
                datasets: [
                    {
                        label: 'Ingresos',
                        data: datosBarras.ingresos,
                        backgroundColor: colorIngreso,
                        borderRadius: 4,
                    },
                    {
                        label: 'Egresos',
                        data: datosBarras.egresos,
                        backgroundColor: colorEgreso,
                        borderRadius: 4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': RD$ ' + ctx.parsed.y.toLocaleString('es-DO', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        beginAtZero: true,
                        grid: { color: '#eee' },
                        ticks: {
                            callback: function(value) {
                                return 'RD$ ' + value.toLocaleString('es-DO');
                            }
                        }
                    }
                }
            }
        });
    }

    // ========== GRÁFICO DE DONA ==========
    const ctxDona = document.getElementById('chartDona');
    if (ctxDona) {
        new Chart(ctxDona, {
            type: 'doughnut',
            data: {
                labels: datosDona.labels,
                datasets: [{
                    data: datosDona.valores,
                    backgroundColor: coloresDona.slice(0, datosDona.labels.length),
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 12,
                            usePointStyle: true,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                return ctx.label + ': RD$ ' + ctx.parsed.toLocaleString('es-DO') + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}