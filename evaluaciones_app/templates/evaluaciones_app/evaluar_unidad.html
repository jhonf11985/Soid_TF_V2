{% extends "evaluaciones_app/base_evaluaciones.html" %}

{% block evaluaciones_content %}

<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }

  .eval-app {
    max-width: 500px;
    margin: 0 auto;
    padding: 16px;
  }

  /* Progress Header */
  .progress-header {
    text-align: center;
    margin-bottom: 24px;
  }

  .progress-text {
    font-size: 14px;
    color: var(--text-secondary, #64748b);
    margin-bottom: 12px;
  }

  .progress-text strong {
    color: var(--text-primary, #1f2937);
  }

  .progress-bar {
    height: 6px;
    background: var(--border, #e2e8f0);
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--success));
    border-radius: 3px;
    transition: width 0.4s ease;
  }

  /* Member Card */
  .member-card {
    background: var(--bg-secondary, #fff);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid var(--border, #e2e8f0);
    padding: 24px;
    margin-bottom: 20px;
  }

  .member-header {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border, #e2e8f0);
    margin-bottom: 24px;
  }

  .member-avatar {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 28px;
    color: var(--primary);
  }

  .member-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .member-name {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary, #1f2937);
    margin: 0 0 4px;
  }

  .member-code {
    font-size: 13px;
    color: var(--text-muted, #94a3b8);
  }

  /* Rating Groups */
  .rating-group {
    margin-bottom: 20px;
  }

  .rating-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary, #64748b);
    margin-bottom: 10px;
    display: block;
  }

  .rating-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .rating-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid var(--border, #e2e8f0);
    background: var(--bg-secondary, #fff);
    font-size: 16px;
    font-weight: 600;
    color: var(--text-secondary, #64748b);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .rating-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: scale(1.08);
  }

  .rating-btn.selected {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
  }

  /* Rating descriptions - Dynamic */
  .rating-desc-dynamic {
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    margin-top: 8px;
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.25s ease;
    min-height: 28px;
  }

  .rating-desc-dynamic.level-1 {
    background: #fef2f2;
    color: #dc2626;
  }

  .rating-desc-dynamic.level-2 {
    background: #fff7ed;
    color: #ea580c;
  }

  .rating-desc-dynamic.level-3 {
    background: #fefce8;
    color: #ca8a04;
  }

  .rating-desc-dynamic.level-4 {
    background: #f0fdf4;
    color: #16a34a;
  }

  .rating-desc-dynamic.level-5 {
    background: #ecfdf5;
    color: #059669;
  }

  /* Estado Select */
  .estado-group {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border, #e2e8f0);
  }

  .estado-select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border, #e2e8f0);
    border-radius: 12px;
    font-size: 15px;
    background: var(--bg-secondary, #fff);
    cursor: pointer;
    transition: border-color 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }

  .estado-select:focus {
    outline: none;
    border-color: var(--primary);
  }

  /* Navigation */
  .nav-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .nav-btn {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .nav-btn.prev {
    background: var(--bg-secondary, #fff);
    border: 1px solid var(--border, #e2e8f0);
    color: var(--text-primary, #374151);
  }

  .nav-btn.prev:hover:not(:disabled) {
    background: var(--bg-tertiary, #f1f5f9);
  }

  .nav-btn.next {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border: none;
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .nav-btn.next:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
  }

  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Actions */
  .eval-actions {
    display: flex;
    gap: 12px;
    flex-direction: column;
  }

  .btn-continue-later {
    width: 100%;
    padding: 14px;
    border: 1px solid var(--border, #e2e8f0);
    border-radius: 12px;
    background: var(--bg-secondary, #fff);
    color: var(--text-primary, #374151);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-continue-later:hover {
    background: var(--bg-tertiary, #f1f5f9);
  }

  .btn-finish {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    display: none;
  }

  .btn-finish.visible {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-finish:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
  }

  /* Member dots navigation */
  .member-dots {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    max-width: 100%;
    padding: 0 10px;
  }

  .member-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border, #e2e8f0);
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    padding: 0;
  }

  .member-dot:hover {
    background: #94a3b8;
    transform: scale(1.2);
  }

  .member-dot.current {
    background: var(--primary);
    transform: scale(1.3);
  }

  .member-dot.completed {
    background: var(--success);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted, #94a3b8);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  /* Lista de miembros (vista alternativa) */
  .view-toggle {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
  }

  .toggle-btn {
    padding: 8px 16px;
    border: 1px solid var(--border, #e2e8f0);
    background: var(--bg-secondary, #fff);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-secondary, #64748b);
  }

  .toggle-btn:first-child {
    border-radius: 8px 0 0 8px;
  }

  .toggle-btn:last-child {
    border-radius: 0 8px 8px 0;
    border-left: none;
  }

  .toggle-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  /* Lista compacta */
  .members-list {
    display: none;
    background: var(--bg-secondary, #fff);
    border-radius: 12px;
    border: 1px solid var(--border, #e2e8f0);
    overflow: hidden;
  }

  .members-list.visible {
    display: block;
  }

  .member-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border, #e2e8f0);
    cursor: pointer;
    transition: background 0.15s;
  }

  .member-list-item:last-child {
    border-bottom: none;
  }

  .member-list-item:hover {
    background: var(--bg-hover, #f8fafc);
  }

  .member-list-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .member-list-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--primary);
  }

  .member-list-name {
    font-weight: 500;
    color: var(--text-primary, #1f2937);
    font-size: 14px;
  }

  .member-list-status {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-badge.completed {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .slider-view {
    display: block;
  }

  .slider-view.hidden {
    display: none;
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #1f2937;
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .toast.success {
    background: #059669;
  }

  .toast.error {
    background: #dc2626;
  }

  /* Saving indicator */
  .saving-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 8px 16px;
    border-radius: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    font-size: 13px;
    display: none;
    align-items: center;
    gap: 8px;
    z-index: 1000;
  }

  .saving-indicator.visible {
    display: flex;
  }

  .saving-indicator .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid #e2e8f0;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Completion banner */
  .completion-banner {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    border: 1px solid #6ee7b7;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    text-align: center;
    display: none;
  }

  .completion-banner.visible {
    display: block;
  }

  .completion-banner h3 {
    color: #065f46;
    margin: 0 0 4px;
    font-size: 16px;
  }

  .completion-banner p {
    color: #047857;
    margin: 0;
    font-size: 14px;
  }
</style>

{% if perfil_es_default %}
<div style="background:#fffbeb; border:1px solid #f59e0b; color:#92400e; padding:12px 14px; border-radius:10px; margin-bottom:14px;">
  <strong>‚ö†Ô∏è Recomendaci√≥n:</strong> esta unidad est√° usando el <strong>perfil por defecto</strong>.
  Te sugerimos configurarlo antes de evaluar para definir tiempo, campos y reglas.
  <div style="margin-top:10px;">
    <a href="{% url 'evaluaciones_app:perfil_evaluacion_unidad' unidad.id %}"
       style="display:inline-block; padding:8px 12px; border-radius:8px; background:#111827; color:#fff; text-decoration:none; font-weight:700;">
      ‚öôÔ∏è Configurar perfil ahora
    </a>
  </div>
</div>
{% endif %}

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<!-- Saving indicator -->
<div class="saving-indicator" id="savingIndicator">
  <div class="spinner"></div>
  <span>Guardando...</span>
</div>

<div class="eval-app">
  
  {% if items %}
  
  <!-- Completion Banner -->
  <div class="completion-banner" id="completionBanner">
    <h3>üéâ ¬°Evaluaci√≥n completada!</h3>
    <p>Has evaluado a todos los miembros de esta unidad</p>
  </div>
  
  <!-- Progress Header -->
  <div class="progress-header">
    <div class="progress-text">
      Evaluando <strong><span id="currentNum">1</span></strong> de <strong><span id="totalNum">{{ items|length }}</span></strong> miembros
      ¬∑ <span id="completedCount">0</span> completados
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <!-- View Toggle -->
  <div class="view-toggle">
    <button type="button" class="toggle-btn active" data-view="slider">
      üë§ Uno a uno
    </button>
    <button type="button" class="toggle-btn" data-view="list">
      üìã Ver lista
    </button>
  </div>

  <!-- Member Dots -->
  <div class="member-dots" id="memberDots"></div>

  <!-- Slider View -->
  <div class="slider-view" id="sliderView">
    <!-- Member Card (populated by JS) -->
    <div class="member-card" id="memberCard">
      <div class="member-header">
        <div class="member-avatar" id="memberAvatar">üë§</div>
        <h3 class="member-name" id="memberName">Cargando...</h3>
        <span class="member-code" id="memberCode"></span>
      </div>

      <!-- Ratings condicionales seg√∫n perfil -->
      {% if perfil.usar_asistencia %}
      <div class="rating-group" data-campo="asistencia">
        <label class="rating-label">Asistencia</label>
        <div class="rating-buttons" data-field="asistencia">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="asistencia"></div>
      </div>
      {% endif %}

      {% if perfil.usar_participacion %}
      <div class="rating-group" data-campo="participacion">
        <label class="rating-label">Participaci√≥n</label>
        <div class="rating-buttons" data-field="participacion">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="participacion"></div>
      </div>
      {% endif %}

      {% if perfil.usar_compromiso %}
      <div class="rating-group" data-campo="compromiso">
        <label class="rating-label">Compromiso</label>
        <div class="rating-buttons" data-field="compromiso">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="compromiso"></div>
      </div>
      {% endif %}

      {% if perfil.usar_actitud %}
      <div class="rating-group" data-campo="actitud">
        <label class="rating-label">Actitud</label>
        <div class="rating-buttons" data-field="actitud">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="actitud"></div>
      </div>
      {% endif %}

      {% if perfil.usar_integracion %}
      <div class="rating-group" data-campo="integracion">
        <label class="rating-label">Integraci√≥n</label>
        <div class="rating-buttons" data-field="integracion">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="integracion"></div>
      </div>
      {% endif %}

      {% if perfil.usar_liderazgo %}
      <div class="rating-group" data-campo="liderazgo">
        <label class="rating-label">Liderazgo</label>
        <div class="rating-buttons" data-field="liderazgo">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="liderazgo"></div>
      </div>
      {% endif %}

      {% if perfil.usar_madurez_espiritual %}
      <div class="rating-group" data-campo="madurez_espiritual">
        <label class="rating-label">Madurez Espiritual</label>
        <div class="rating-buttons" data-field="madurez_espiritual">
          <button type="button" class="rating-btn" data-value="1">1</button>
          <button type="button" class="rating-btn" data-value="2">2</button>
          <button type="button" class="rating-btn" data-value="3">3</button>
          <button type="button" class="rating-btn" data-value="4">4</button>
          <button type="button" class="rating-btn" data-value="5">5</button>
        </div>
        <div class="rating-desc-dynamic" data-field="madurez_espiritual"></div>
      </div>
      {% endif %}

      <!-- Estado espiritual (condicional) -->

    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
      <button type="button" class="nav-btn prev" id="prevBtn">
        ‚Üê Anterior
      </button>
      <button type="button" class="nav-btn next" id="nextBtn">
        Guardar y continuar ‚Üí
      </button>
    </div>
  </div>

  <!-- List View -->
  <div class="members-list" id="listView"></div>

  <!-- Actions -->
  <div class="eval-actions">
    <button type="button" class="btn-finish" id="btnFinish">
      ‚úì Finalizar evaluaci√≥n
    </button>
    <button type="button" class="btn-continue-later" id="btnContinueLater">
      üíæ Guardar y continuar despu√©s
    </button>
  </div>

  {% else %}
  
  <div class="empty-state">
    <div class="empty-state-icon">üìã</div>
    <p>No hay miembros en esta unidad</p>
    <a href="{% url 'evaluaciones_app:mis_unidades' %}" class="btn-continue-later" style="display: inline-block; margin-top: 16px; text-decoration: none;">
      ‚Üê Volver
    </a>
  </div>
  
  {% endif %}

</div>

{% if items %}
<script>
(function() {
  // Config
  const CSRF_TOKEN = '{{ csrf_token }}';
  const SAVE_URL = '{% url "evaluaciones_app:guardar_evaluacion_miembro" %}';
  const BACK_URL = '{% url "evaluaciones_app:mis_unidades" %}';
  const RESULTS_URL = '{% url "evaluaciones_app:ver_resultados_unidad" evaluacion.id %}';
  const EVALUACION_ID = {{ evaluacion.id }};

  // Data from Django
  const members = [
    {% for item in items %}
    {
      id: {{ item.miembro.id }},
      itemId: {{ item.id }},
      nombre: "{{ item.miembro.nombres|escapejs }} {{ item.miembro.apellidos|escapejs }}",
      codigo: "{{ item.miembro.codigo_miembro|default:''|escapejs }}",
      foto: "{% if item.miembro.foto_perfil %}{{ item.miembro.foto_perfil.url }}{% endif %}",
      saved: {% if item.evaluado_por %}true{% else %}false{% endif %},
      valores: {
        asistencia: {{ item.asistencia|default:3 }},
        participacion: {{ item.participacion|default:3 }},
        compromiso: {{ item.compromiso|default:3 }},
        actitud: {{ item.actitud|default:3 }},
        integracion: {{ item.integracion|default:3 }},
        liderazgo: 3,
        madurez_espiritual: {{ item.madurez_espiritual|default:3 }},
       

      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Campos activos seg√∫n perfil
  const fields = [
    {% if perfil.usar_asistencia %}'asistencia',{% endif %}
    {% if perfil.usar_participacion %}'participacion',{% endif %}
    {% if perfil.usar_compromiso %}'compromiso',{% endif %}
    {% if perfil.usar_actitud %}'actitud',{% endif %}
    {% if perfil.usar_integracion %}'integracion',{% endif %}
    {% if perfil.usar_liderazgo %}'liderazgo',{% endif %}
    {% if perfil.usar_madurez_espiritual %}'madurez_espiritual',{% endif %}
  ];

  
  
  // Descripciones din√°micas
  const ratingDescriptions = {
    asistencia: {
      1: 'Muy baja - Casi no asiste',
      2: 'Baja - Asiste poco',
      3: 'Regular - Asiste a veces',
      4: 'Buena - Asiste frecuentemente',
      5: 'Excelente - Asiste siempre'
    },
    participacion: {
      1: 'Nula - No participa',
      2: 'Baja - Participa poco',
      3: 'Regular - Participa a veces',
      4: 'Buena - Participa activamente',
      5: 'Excelente - Muy participativo'
    },
    compromiso: {
      1: 'Muy bajo - Sin compromiso',
      2: 'Bajo - Poco comprometido',
      3: 'Regular - Compromiso moderado',
      4: 'Alto - Muy comprometido',
      5: 'Excelente - Totalmente comprometido'
    },
    actitud: {
      1: 'Negativa - Actitud problem√°tica',
      2: 'Pasiva - Actitud indiferente',
      3: 'Neutral - Actitud aceptable',
      4: 'Positiva - Buena actitud',
      5: 'Excelente - Actitud ejemplar'
    },
    integracion: {
      1: 'Nula - No se integra',
      2: 'Baja - Le cuesta integrarse',
      3: 'Regular - Se integra a veces',
      4: 'Buena - Bien integrado',
      5: 'Excelente - Totalmente integrado'
    },
    liderazgo: {
      1: 'Nulo - Sin liderazgo',
      2: 'Bajo - Poco liderazgo',
      3: 'Regular - Liderazgo ocasional',
      4: 'Bueno - Buen l√≠der',
      5: 'Excelente - L√≠der nato'
    },
    madurez_espiritual: {
      1: 'Inicial - Reci√©n comenzando',
      2: 'En desarrollo - Creciendo',
      3: 'Moderada - Estable',
      4: 'Avanzada - Maduro',
      5: 'Plena - Muy maduro espiritualmente'
    }
  };
  
  // Encontrar el primer miembro pendiente (no guardado)
  let currentIndex = 0;
  const firstPendingIndex = members.findIndex(m => !m.saved);
  if (firstPendingIndex !== -1) {
    currentIndex = firstPendingIndex;
  }
  
  let evaluations = {};
  let isSaving = false;

  // Initialize evaluations from existing data
  members.forEach(m => {
    evaluations[m.id] = { 
      ...m.valores,
      saved: m.saved,
      dirty: false
    };
  });
  
  // Debug: mostrar estado inicial
  console.log('Estado inicial de evaluaciones:', members.map(m => ({
    nombre: m.nombre,
    saved: m.saved,
    itemId: m.itemId
  })));
  console.log('Iniciando en √≠ndice:', currentIndex);

  // DOM Elements
  const memberName = document.getElementById('memberName');
  const memberCode = document.getElementById('memberCode');
  const memberAvatar = document.getElementById('memberAvatar');
  
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const currentNum = document.getElementById('currentNum');
  const totalNum = document.getElementById('totalNum');
  const completedCount = document.getElementById('completedCount');
  const progressFill = document.getElementById('progressFill');
  const memberDots = document.getElementById('memberDots');
  const listView = document.getElementById('listView');
  const sliderView = document.getElementById('sliderView');
  const btnFinish = document.getElementById('btnFinish');
  const btnContinueLater = document.getElementById('btnContinueLater');
  const toast = document.getElementById('toast');
  const savingIndicator = document.getElementById('savingIndicator');
  const completionBanner = document.getElementById('completionBanner');

  // Toast notification
  function showToast(message, type = 'success') {
    toast.textContent = message;
    toast.className = 'toast ' + type;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // Saving indicator
  function showSaving(show) {
    savingIndicator.classList.toggle('visible', show);
  }

  // Save single member via AJAX
  async function saveMember(memberId) {
    if (isSaving) return false;
    
    const m = members.find(x => x.id === memberId);
    const ev = evaluations[memberId];
    
    isSaving = true;
    showSaving(true);

    // Construir data expl√≠citamente (sin spread para evitar campos innecesarios)
    const data = {
      evaluacion_id: EVALUACION_ID,
      miembro_id: memberId,
      item_id: m.itemId,
      asistencia: ev.asistencia,
      participacion: ev.participacion,
      compromiso: ev.compromiso,
      actitud: ev.actitud,
      integracion: ev.integracion,
      liderazgo: ev.liderazgo || 3,
      madurez_espiritual: ev.madurez_espiritual,
      observacion: ev.observacion || ''
    };

    try {
      const response = await fetch(SAVE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      
      if (result.success) {
        ev.saved = true;
        ev.dirty = false;
        console.log('‚úÖ Guardado exitoso:', {miembro_id: memberId, item_id: m.itemId, result});
        updateCompletionState();
        showToast('‚úì ' + m.nombre.split(' ')[0] + ' guardado');
        return true;
      } else {
        console.error('‚ùå Error al guardar:', result);
        showToast('Error: ' + (result.error || 'No se pudo guardar'), 'error');
        return false;
      }
    } catch (error) {
      console.error('Error saving:', error);
      showToast('Error de conexi√≥n', 'error');
      return false;
    } finally {
      isSaving = false;
      showSaving(false);
    }
  }

  // Check completion state
  function getCompletedCount() {
    return members.filter(m => evaluations[m.id].saved).length;
  }

  function isAllCompleted() {
    return getCompletedCount() === members.length;
  }

  function updateCompletionState() {
    const completed = getCompletedCount();
    completedCount.textContent = completed;
    
    // Update progress bar based on completed
    const progress = (completed / members.length) * 100;
    progressFill.style.width = progress + '%';
    
    // Show/hide finish button
    btnFinish.classList.toggle('visible', isAllCompleted());
    
    // Show completion banner
    completionBanner.classList.toggle('visible', isAllCompleted());
    
    // Update dots
    updateDots();
    updateListBadges();
  }

  // Initialize
  function init() {
    totalNum.textContent = members.length;
    createDots();
    createListView();
    renderMember();
    setupEventListeners();
    updateCompletionState();
  }

  // Create navigation dots
  function createDots() {
    memberDots.innerHTML = members.map((m, i) => 
      `<button type="button" class="member-dot${evaluations[m.id].saved ? ' completed' : ''}" data-index="${i}" title="${m.nombre}"></button>`
    ).join('');
  }

  // Create list view
  function createListView() {
    listView.innerHTML = members.map((m, i) => `
      <div class="member-list-item" data-index="${i}">
        <div class="member-list-info">
          <div class="member-list-avatar">
            ${m.foto ? `<img src="${m.foto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : 'üë§'}
          </div>
          <span class="member-list-name">${m.nombre}</span>
        </div>
        <div class="member-list-status">
          <span class="status-badge ${evaluations[m.id].saved ? 'completed' : 'pending'}" data-member="${m.id}">
            ${evaluations[m.id].saved ? 'Completado' : 'Pendiente'}
          </span>
          <span style="color: var(--text-muted);">‚Üí</span>
        </div>
      </div>
    `).join('');
  }

  // Render current member
  function renderMember() {
    const m = members[currentIndex];
    const ev = evaluations[m.id];

    // Update header
    memberName.textContent = m.nombre;
    memberCode.textContent = m.codigo || '';
    memberAvatar.innerHTML = m.foto ? 
      `<img src="${m.foto}" alt="${m.nombre}">` : 'üë§';

    // Update ratings
    fields.forEach(field => {
      const container = document.querySelector(`[data-field="${field}"]`);
      if (container) {
        container.querySelectorAll('.rating-btn').forEach(btn => {
          btn.classList.toggle('selected', parseInt(btn.dataset.value) === ev[field]);
        });
      }
    });

 

    // Update rating descriptions
    updateAllRatingDescriptions();

    // Update navigation
    currentNum.textContent = currentIndex + 1;
    prevBtn.disabled = currentIndex === 0;
    
    // Update next button text
    if (currentIndex === members.length - 1) {
      nextBtn.textContent = ev.saved ? '‚úì Guardado' : 'Guardar ‚úì';
    } else {
      nextBtn.textContent = 'Guardar y continuar ‚Üí';
    }

    // Update dots
    document.querySelectorAll('.member-dot').forEach((dot, i) => {
      dot.classList.toggle('current', i === currentIndex);
    });
  }

  function updateListBadges() {
    members.forEach(m => {
      const badge = document.querySelector(`.status-badge[data-member="${m.id}"]`);
      if (badge) {
        const saved = evaluations[m.id].saved;
        badge.textContent = saved ? 'Completado' : 'Pendiente';
        badge.classList.toggle('completed', saved);
        badge.classList.toggle('pending', !saved);
      }
    });
  }

  function updateDots() {
    document.querySelectorAll('.member-dot').forEach((dot, i) => {
      dot.classList.toggle('completed', evaluations[members[i].id].saved);
    });
  }

  // Event listeners
  function setupEventListeners() {
    // Rating buttons
    document.querySelectorAll('.rating-buttons').forEach(container => {
      container.addEventListener('click', (e) => {
        const btn = e.target.closest('.rating-btn');
        if (!btn) return;

        const field = container.dataset.field;
        const value = parseInt(btn.dataset.value);
        const m = members[currentIndex];

        evaluations[m.id][field] = value;
        evaluations[m.id].dirty = true;

        container.querySelectorAll('.rating-btn').forEach(b => {
          b.classList.toggle('selected', parseInt(b.dataset.value) === value);
        });

        updateRatingDescription(field, value);
      });
    });


    // Previous button
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderMember();
      }
    });

    // Next button - Save and advance
    nextBtn.addEventListener('click', async () => {
      const m = members[currentIndex];
      
      // Save current member
      const saved = await saveMember(m.id);
      
      if (saved && currentIndex < members.length - 1) {
        currentIndex++;
        renderMember();
      }
    });

    // Dots navigation
    memberDots.addEventListener('click', (e) => {
      const dot = e.target.closest('.member-dot');
      if (!dot) return;
      currentIndex = parseInt(dot.dataset.index);
      renderMember();
    });

    // List item click
    listView.addEventListener('click', (e) => {
      const item = e.target.closest('.member-list-item');
      if (!item) return;
      currentIndex = parseInt(item.dataset.index);
      
      // Switch to slider view
      document.querySelectorAll('.toggle-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.view === 'slider');
      });
      sliderView.classList.remove('hidden');
      listView.classList.remove('visible');
      
      renderMember();
    });

    // View toggle
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        document.querySelectorAll('.toggle-btn').forEach(b => {
          b.classList.toggle('active', b === btn);
        });
        
        if (view === 'list') {
          sliderView.classList.add('hidden');
          listView.classList.add('visible');
        } else {
          sliderView.classList.remove('hidden');
          listView.classList.remove('visible');
        }
      });
    });

    // Continue later button
    btnContinueLater.addEventListener('click', async () => {
      const m = members[currentIndex];
      
      // Save current if dirty
      if (evaluations[m.id].dirty) {
        await saveMember(m.id);
      }
      
      // Redirect back
      window.location.href = BACK_URL;
    });

    // Finish button
    btnFinish.addEventListener('click', () => {
      if (isAllCompleted()) {
        window.location.href = RESULTS_URL;
      }
    });
  }

  // Rating descriptions
  function updateRatingDescription(field, value) {
    const descEl = document.querySelector(`.rating-desc-dynamic[data-field="${field}"]`);
    if (descEl && ratingDescriptions[field]) {
      descEl.textContent = ratingDescriptions[field][value] || '';
      descEl.classList.remove('level-1', 'level-2', 'level-3', 'level-4', 'level-5');
      descEl.classList.add(`level-${value}`);
    }
  }

  function updateAllRatingDescriptions() {
    const m = members[currentIndex];
    const ev = evaluations[m.id];
    fields.forEach(field => {
      updateRatingDescription(field, ev[field]);
    });
  }

  // Start
  init();
})();
</script>
{% endif %}

{% endblock %}