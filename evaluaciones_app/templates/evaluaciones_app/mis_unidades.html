{% extends 'evaluaciones_app/base_evaluaciones.html' %}

{% block evaluaciones_content %}
<style>
  :root {
    --primary: #5c9ead;
    --primary-dark: #4a8a98;
    --primary-light: #e8f4f6;
    --secondary: #ffab91;
    --secondary-dark: #ff8a65;
    --secondary-light: #fff3e0;
    --success: #10b981;
    --success-light: #ecfdf5;
    --warning: #f59e0b;
    --warning-light: #fffbeb;
    --danger: #ef4444;
    --danger-light: #fef2f2;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-900: #111827;
  }

  .page-header {
    margin-bottom: 28px;
  }
  .page-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-header h2::before {
    content: '';
    width: 4px;
    height: 28px;
    background: linear-gradient(180deg, var(--primary), var(--secondary));
    border-radius: 2px;
  }
  .page-header p {
    color: var(--gray-500);
    font-size: 14px;
    margin: 0;
    padding-left: 16px;
  }

  /* Cards */
  .unidad-card {
    background: #fff;
    border: 1px solid var(--gray-200);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .unidad-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, var(--primary), var(--secondary));
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  .unidad-card:hover {
    box-shadow: 0 8px 24px rgba(92, 158, 173, 0.12);
    border-color: var(--primary);
    transform: translateY(-2px);
  }
  .unidad-card:hover::before {
    opacity: 1;
  }

  .unidad-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 24px;
  }
  @media (max-width: 768px) {
    .unidad-content {
      flex-direction: column;
      gap: 20px;
    }
  }

  .unidad-info {
    flex: 1;
    min-width: 0;
  }

  .unidad-nombre {
    font-weight: 700;
    font-size: 18px;
    color: var(--gray-900);
    margin-bottom: 4px;
    line-height: 1.3;
  }

  .unidad-ruta {
    font-size: 13px;
    color: var(--gray-500);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .unidad-ruta::before {
    content: '';
    width: 16px;
    height: 16px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E");
    background-size: contain;
    flex-shrink: 0;
  }

  /* Stats badges */
  .unidad-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 18px;
  }

  .stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
  }
  .stat-badge.estado {
    background: var(--primary-light);
    color: var(--primary-dark);
  }
  .stat-badge.progreso {
    background: var(--secondary-light);
    color: var(--secondary-dark);
  }
  .stat-badge svg {
    flex-shrink: 0;
  }

  /* Progress */
  .progress-section {
    margin-bottom: 18px;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--gray-500);
    margin-bottom: 8px;
  }
  .progress-label strong {
    color: var(--gray-700);
  }
  .progress-bar-container {
    width: 100%;
    max-width: 320px;
    height: 8px;
    background: var(--gray-100);
    border-radius: 10px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .progress-bar-fill.low { 
    background: linear-gradient(90deg, var(--danger), #f87171); 
  }
  .progress-bar-fill.mid { 
    background: linear-gradient(90deg, var(--warning), #fbbf24); 
  }
  .progress-bar-fill.high { 
    background: linear-gradient(90deg, var(--primary), var(--primary-dark)); 
  }
  .progress-bar-fill.complete { 
    background: linear-gradient(90deg, var(--success), #34d399); 
  }

  .reabierta-badge {
    font-size: 11px;
    color: var(--warning);
    background: var(--warning-light);
    padding: 2px 8px;
    border-radius: 6px;
    margin-left: 8px;
  }

  /* Alertas */
  .alertas-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .alerta-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 8px;
  }
  .alerta-item.riesgo {
    background: var(--danger-light);
    color: var(--danger);
  }
  .alerta-item.lideres {
    background: var(--secondary-light);
    color: var(--secondary-dark);
  }
  .alerta-item.ok {
    background: var(--success-light);
    color: var(--success);
  }
  .alerta-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .alerta-dot.riesgo { background: var(--danger); }
  .alerta-dot.lideres { background: var(--secondary); }
  .alerta-dot.ok { background: var(--success); }

  /* Actions */
  .unidad-action {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  @media (max-width: 768px) {
    .unidad-action {
      width: 100%;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .unidad-action .btn-action {
      flex: 1;
      min-width: calc(50% - 4px);
      justify-content: center;
    }
    .unidad-action .btn-action.primary {
      min-width: 100%;
    }
  }

  .btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    white-space: nowrap;
  }
  .btn-action svg {
    flex-shrink: 0;
  }

  .btn-action.empezar {
    background: var(--primary);
    color: #fff;
  }
  .btn-action.empezar:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(92, 158, 173, 0.3);
  }

  .btn-action.continuar {
    background: var(--secondary);
    color: #fff;
  }
  .btn-action.continuar:hover {
    background: var(--secondary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 171, 145, 0.4);
  }

  .btn-action.completado {
    background: var(--success);
    color: #fff;
  }
  .btn-action.completado:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .btn-action.secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-200);
  }
  .btn-action.secondary:hover {
    background: var(--gray-200);
    border-color: var(--gray-300);
  }

  .btn-action.disabled {
    background: var(--gray-100);
    color: var(--gray-500);
    cursor: not-allowed;
    opacity: 0.7;
  }
  .btn-action.disabled:hover {
    transform: none;
    box-shadow: none;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 80px 24px;
    background: #fff;
    border: 2px dashed var(--gray-200);
    border-radius: 16px;
  }
  .empty-state-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .empty-state-icon svg {
    width: 40px;
    height: 40px;
    color: var(--primary);
  }
  .empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0 0 8px 0;
  }
  .empty-state p {
    color: var(--gray-500);
    font-size: 14px;
    margin: 0;
  }
</style>

<div class="page-header">
  <h2>Mis unidades para evaluar</h2>
  <p>Aquí solo aparecen las unidades donde tienes un cargo vigente.</p>
</div>

{% if not unidades_info %}
  <div class="empty-state">
    <div class="empty-state-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
      </svg>
    </div>
    <h3>Sin unidades asignadas</h3>
    <p>No tienes unidades asignadas como líder.</p>
  </div>
{% else %}
  {% for item in unidades_info %}
    {% with u=item.unidad %}
    <div class="unidad-card">
      <div class="unidad-content">
        
        <div class="unidad-info">
          <div class="unidad-nombre">{{ u.nombre }}</div>
          <div class="unidad-ruta">{{ u.ruta }}</div>

          <div class="unidad-stats">
            <span class="stat-badge estado">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              {{ item.estado_txt }}
            </span>
            <span class="stat-badge progreso">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              {{ item.evaluados }}/{{ item.total }} evaluados
            </span>
          </div>

          <div class="progress-section">
            <div class="progress-label">
              <span>Progreso de evaluación</span>
              <span>
                <strong>{{ item.porcentaje }}%</strong>
                {% if item.reabierta %}<span class="reabierta-badge">Reabierta</span>{% endif %}
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill {% if item.reabierta %}mid{% elif item.porcentaje == 100 %}complete{% elif item.porcentaje >= 70 %}high{% elif item.porcentaje >= 30 %}mid{% else %}low{% endif %}" 
                   style="width: {{ item.porcentaje }}%;"></div>
            </div>
          </div>

          <div class="alertas-row">
            {% if item.en_riesgo > 0 %}
            <span class="alerta-item riesgo">
              <span class="alerta-dot riesgo"></span>
              {{ item.en_riesgo }} en riesgo
            </span>
            {% endif %}
            {% if item.lideres > 0 %}
            <span class="alerta-item lideres">
              <span class="alerta-dot lideres"></span>
              {{ item.lideres }} líderes potenciales
            </span>
            {% endif %}
            {% if item.en_riesgo == 0 and item.lideres == 0 %}
            <span class="alerta-item ok">
              <span class="alerta-dot ok"></span>
              Sin alertas
            </span>
            {% endif %}
          </div>
        </div>

        <div class="unidad-action">
          {% if item.accion == "Empezar" %}
            <a class="btn-action empezar primary" href="{% url 'evaluaciones_app:evaluar_unidad' item.unidad.id %}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Empezar
            </a>
          {% elif item.accion == "Continuar" %}
            <a class="btn-action continuar primary" href="{% url 'evaluaciones_app:evaluar_unidad' item.unidad.id %}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Continuar
            </a>
          {% else %}
            <a class="btn-action completado primary" href="{% url 'evaluaciones_app:ver_resultados_unidad' item.evaluacion.id %}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              Ver resultados
            </a>
          {% endif %}

          {% if item.bloquear_configuracion %}
            <button class="btn-action secondary disabled" disabled title="No se puede configurar porque hay una evaluación en progreso">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              Configurar
            </button>
          {% else %}
            <a class="btn-action secondary" href="{% url 'evaluaciones_app:perfil_evaluacion_unidad' u.id %}">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              Configurar
            </a>
          {% endif %}

          {% if item.evaluacion and item.evaluacion.estado_workflow == "CERRADA" %}
            <form method="post" action="{% url 'evaluaciones_app:reabrir_evaluacion_unidad' item.evaluacion.id %}" style="margin:0;">
              {% csrf_token %}
              <button type="submit" class="btn-action secondary" style="width:100%;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                </svg>
                Reabrir
              </button>
            </form>
          {% endif %}

          <a class="btn-action secondary" href="{% url 'evaluaciones_app:listar_evaluaciones_unidad' item.unidad.id %}">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
            </svg>
            Historial
          </a>
        </div>

      </div>
    </div>
    {% endwith %}
  {% endfor %}
{% endif %}
{% endblock %}