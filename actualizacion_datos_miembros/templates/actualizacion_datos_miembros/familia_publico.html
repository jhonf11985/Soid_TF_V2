<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Alta de Familia</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --color-primary: {{ CFG.color_primario|default:"#0097a7" }};
      --color-primary-dark: #00838f;
      --color-primary-soft: #e0f7fa;
      --color-bg: #f5f5f7;
      --color-surface: #ffffff;
      --color-text-main: #111827;
      --color-text-muted: #6b7280;
      --color-border: #e5e7eb;
      --color-error: #ef4444;
      --radius-soft: 12px;
    }

    body {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--color-primary) 0%, #5c9ead 50%, #5c9ead 100%);
      min-height: 100vh;
      padding: 40px 20px;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
    }

    .form-container { max-width: 680px; margin: 0 auto; position: relative; z-index: 1; }

    .brand-top { display: flex; justify-content: center; margin-bottom: 22px; }
    .church-logo { max-height: 72px; object-fit: contain; filter: drop-shadow(0 6px 14px rgba(0,0,0,0.15)); }

    .form-header { text-align: center; margin-bottom: 28px; }
    .form-header h1 { font-size: 26px; font-weight: 700; color: #fff; margin-bottom: 6px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .form-header p { font-size: 14px; color: rgba(255,255,255,0.9); }

    .form-card { background: var(--color-surface); border-radius: 20px; padding: 32px; box-shadow: 0 25px 60px rgba(0,0,0,0.15); }

    .alert-error {
      display: flex; gap: 10px; padding: 14px 16px; margin-bottom: 18px;
      border-radius: var(--radius-soft);
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #b91c1c; font-size: 13px; line-height: 1.4;
    }
    .alert-error .material-icons { font-size: 20px; }

    .form-section { margin-top: 22px; padding-top: 22px; border-top: 1px solid var(--color-border); }

    .section-header { display:flex; align-items:center; gap:10px; margin-bottom:16px; flex-wrap: wrap; }
    .section-icon {
      width: 38px; height: 38px; border-radius: 12px;
      display:inline-flex; align-items:center; justify-content:center;
      background: var(--color-primary-soft);
      border: 1px solid rgba(0,151,167,0.25);
      color: var(--color-primary-dark);
      transition: all 0.2s;
    }
    .section-icon .material-icons { font-size: 20px; }
    .section-title { font-size: 14px; font-weight: 700; color: var(--color-text-main); }

    .fields-grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 760px){ .fields-grid.two-col{ grid-template-columns: 1fr 1fr; } }

    .form-group { position: relative; }
    .form-label { display:block; font-size: 12px; font-weight:600; color: var(--color-text-main); margin-bottom:8px; transition: color 0.2s; }

    .help-text { margin-top:6px; font-size:12px; color: var(--color-text-muted); line-height:1.4; }

    /* ====== AUTOCOMPLETE STYLES - ESTILO LÍNEA ====== */
    .autocomplete-wrapper { position: relative; }

    /* Campo estilo línea (solo borde inferior) */
    .autocomplete-field {
      position: relative;
      display: flex;
      align-items: center;
      min-height: 44px;
      padding: 0 4px;
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      transition: border-color 0.2s;
    }
    .autocomplete-field:focus-within {
      border-bottom-color: var(--color-primary);
    }
    .autocomplete-field.has-selection {
      border-bottom-color: var(--color-primary);
    }

    /* Estado bloqueado/deshabilitado */
    .autocomplete-wrapper.disabled .autocomplete-field {
      background: #f9fafb;
      border-bottom-color: #e5e7eb;
      pointer-events: none;
      opacity: 0.6;
    }
    .autocomplete-wrapper.disabled .autocomplete-search {
      cursor: not-allowed;
    }
    .autocomplete-wrapper.disabled .form-label {
      color: var(--color-text-muted);
    }

    .autocomplete-search {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      padding: 10px 0;
      background: transparent;
      color: var(--color-text-main);
    }
    .autocomplete-search::placeholder { color: var(--color-text-muted); }
    .autocomplete-search:disabled {
      background: transparent;
      cursor: not-allowed;
    }

    /* Chip de selección */
    .autocomplete-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px 6px 6px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(0,151,167,0.08), rgba(0,151,167,0.12));
      border: 1px solid rgba(0,151,167,0.25);
    }

    .chip-avatar {
      width: 32px; height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--color-primary), #5c9ead);
      color: #fff;
      font-size: 12px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      text-transform: uppercase;
    }

    .chip-text { display: flex; flex-direction: column; line-height: 1.3; }
    .chip-name { font-size: 13px; font-weight: 600; color: var(--color-text-main); }
    .chip-code { font-size: 11px; color: var(--color-text-muted); }

    .chip-remove {
      width: 24px; height: 24px;
      border: none; background: transparent;
      color: var(--color-text-muted);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px;
      transition: background 0.15s, color 0.15s;
    }
    .chip-remove:hover { background: rgba(239,68,68,0.1); color: #dc2626; }
    .chip-remove .material-icons { font-size: 18px; }

    /* Dropdown */
    .autocomplete-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0; right: 0;
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.12);
      z-index: 100;
      max-height: 280px;
      overflow-y: auto;
      display: none;
    }
    .autocomplete-dropdown.open { display: block; }

    .autocomplete-list { list-style: none; padding: 6px; margin: 0; }

    .autocomplete-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .autocomplete-item:hover { background: rgba(0,151,167,0.06); }

    .autocomplete-item-avatar {
      width: 36px; height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--color-primary), #5c9ead);
      color: #fff;
      font-size: 13px; font-weight: 600;
      display: flex; align-items: center; justify-content: center;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .autocomplete-item-info { flex: 1; min-width: 0; }
    .autocomplete-item-name {
      font-size: 13px; font-weight: 600;
      color: var(--color-text-main);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .autocomplete-item-meta {
      font-size: 12px; color: var(--color-text-muted);
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .autocomplete-item-code {
      background: rgba(0,151,167,0.1);
      color: var(--color-primary-dark);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .autocomplete-empty, .autocomplete-loading {
      padding: 20px;
      text-align: center;
      color: var(--color-text-muted);
      font-size: 13px;
    }
    .autocomplete-empty .material-icons,
    .autocomplete-loading .material-icons {
      font-size: 32px;
      margin-bottom: 8px;
      display: block;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }

    /* ====== FIN AUTOCOMPLETE ====== */

    /* Sección bloqueada */
    .form-section.locked {
      opacity: 0.5;
      pointer-events: none;
    }
    .form-section.locked .section-icon {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: #9ca3af;
    }

    /* Indicador de bloqueo */
    .lock-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--color-text-muted);
      margin-left: auto;
      padding: 4px 10px;
      background: #f3f4f6;
      border-radius: 20px;
    }
    .lock-indicator .material-icons { font-size: 14px; }
    .lock-indicator.unlocked { display: none; }

    .children-list { display:flex; flex-direction:column; gap:12px; }
    .child-row { border:1px solid var(--color-border); border-radius:14px; padding:14px; background:#fff; }
    .row-actions { display:flex; gap:10px; margin-top:10px; }

    .btn-secondary {
      border: 1px solid rgba(0,151,167,0.35);
      background: rgba(0,151,167,0.08);
      color: var(--color-primary-dark);
      padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; gap:8px;
      transition: opacity 0.2s;
    }
    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary .material-icons { font-size:18px; }

    .submit-btn {
      width:100%; margin-top:28px; padding:16px;
      border-radius: var(--radius-soft);
      border:none;
      background: linear-gradient(135deg, var(--color-primary), #5c9ead);
      color:#fff; font-size:15px; font-weight:600;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }
    .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,151,167,0.3); }
    .submit-btn:active:not(:disabled) { transform: translateY(0); }
    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .form-footer { margin-top:18px; padding-top:18px; border-top:1px solid var(--color-border); text-align:center; font-size:12px; color: var(--color-text-muted); }
    .powered-by { margin-top:22px; text-align:center; font-size:11px; color: rgba(255,255,255,0.75); }

    /* Bienvenida */
    .welcome {
      display:flex; gap:12px; padding:16px;
      margin-bottom: 18px;
      border-radius: var(--radius-soft);
      background: var(--color-primary-soft);
      border: 1px solid var(--color-primary);
      color: var(--color-primary-dark);
      font-size: 13px; line-height: 1.6;
    }
    .welcome .material-icons { font-size:22px; flex-shrink:0; }
    .welcome strong { font-weight:700; }

    .welcome-actions { margin-top: 12px; display:flex; justify-content:flex-end; }
    .btn-start {
      border:none;
      background: linear-gradient(135deg, var(--color-primary), #5c9ead);
      color:#fff;
      padding: 12px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .hidden { display:none; }

    /* Modal de confirmación */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-box {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    .modal-overlay.active .modal-box {
      transform: scale(1);
    }
    .modal-icon {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }
    .modal-icon .material-icons { font-size: 24px; }
    .modal-title {
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
      color: var(--color-text-main);
    }
    .modal-text {
      font-size: 13px;
      text-align: center;
      color: var(--color-text-muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background 0.15s;
    }
    .modal-btn-cancel {
      background: #f3f4f6;
      color: var(--color-text-main);
    }
    .modal-btn-cancel:hover { background: #e5e7eb; }
    .modal-btn-confirm {
      background: #dc2626;
      color: #fff;
    }
    .modal-btn-confirm:hover { background: #b91c1c; }
  </style>
</head>

<body data-alta-familia-token="{{ acceso.token }}">

<!-- Modal de confirmación -->
<div class="modal-overlay" id="modalConfirm">
  <div class="modal-box">
    <div class="modal-icon">
      <span class="material-icons">warning</span>
    </div>
    <div class="modal-title">¿Quitar miembro principal?</div>
    <div class="modal-text">
      Al quitar el miembro principal se borrarán todas las selecciones de cónyuge, padres e hijos que hayas hecho.
    </div>
    <div class="modal-actions">
      <button type="button" class="modal-btn modal-btn-cancel" id="modalCancel">Cancelar</button>
      <button type="button" class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Sí, quitar todo</button>
    </div>
  </div>
</div>

<div class="form-container">

  <div class="brand-top">
    {% if CFG and CFG.logo %}
      <img src="{{ CFG.logo.url }}" alt="{{ CFG.nombre_iglesia|default:'Iglesia' }}" class="church-logo">
    {% endif %}
  </div>

  <div class="form-header">
    <h1>Alta de Familia</h1>
    <p>Organización de relaciones básicas del hogar</p>
  </div>

  <div class="form-card">

    {% if messages %}
      {% for m in messages %}
        {% if m.tags == "error" %}
          <div class="alert-error">
            <span class="material-icons">error</span>
            <div>{{ m }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- BIENVENIDA -->
    <div id="welcomeBox" class="welcome">
      <span class="material-icons">info</span>
      <div>
        <strong>Bienvenido/a</strong><br>
        Este formulario te ayudará a organizar tu núcleo familiar en el sistema.
        <br><br>
        <strong>¿Cómo funciona?</strong>
        <ul style="margin:8px 0 0 18px;">
          <li>Primero elegirás el <strong>miembro principal</strong> (debe existir en el sistema).</li>
          <li>Luego podrás elegir cónyuge, padre, madre e hijos (si ya están registrados).</li>
          <li>Si alguien no aparece en la búsqueda, consulta con el equipo para registrarlo primero.</li>
        </ul>

        <div class="welcome-actions">
          <button type="button" class="btn-start" id="btnStart">
            <span class="material-icons">arrow_forward</span>
            Comenzar
          </button>
        </div>
      </div>
    </div>

    <form method="post" autocomplete="off" id="familyForm" class="hidden">
      {% csrf_token %}

      <!-- PRINCIPAL -->
      <div class="form-section" style="margin-top:0; padding-top:0; border-top:none;" id="section-principal">
        <div class="section-header">
          <div class="section-icon"><span class="material-icons">person</span></div>
          <span class="section-title">Miembro principal</span>
        </div>

        <div class="fields-grid">
          <div class="form-group autocomplete-wrapper" data-field="principal" id="autocomplete-principal">
            <label class="form-label">Buscar miembro principal (obligatorio)</label>
            
            <input type="hidden" name="principal_id" class="autocomplete-hidden">
            
            <div class="autocomplete-field">
              <div class="autocomplete-chip" style="display: none;">
                <span class="chip-avatar"></span>
                <span class="chip-text">
                  <span class="chip-name"></span>
                  <span class="chip-code"></span>
                </span>
                <button type="button" class="chip-remove" title="Quitar">
                  <span class="material-icons">close</span>
                </button>
              </div>
              <input type="text" class="autocomplete-search" placeholder="Escribe un nombre o cédula…" autocomplete="off">
            </div>
            
            <div class="autocomplete-dropdown">
              <ul class="autocomplete-list"></ul>
              <div class="autocomplete-empty" style="display:none;">
                <span class="material-icons">person_search</span>
                <p>No se encontraron miembros</p>
              </div>
              <div class="autocomplete-loading" style="display:none;">
                <span class="material-icons spinner">sync</span>
                <p>Buscando...</p>
              </div>
            </div>

            <div class="help-text">Este será el miembro base. Una vez seleccionado, podrás agregar familiares.</div>
          </div>
        </div>
      </div>

      <!-- CÓNYUGE -->
      <div class="form-section locked" id="section-conyuge">
        <div class="section-header">
          <div class="section-icon"><span class="material-icons">favorite</span></div>
          <span class="section-title">Cónyuge</span>
          <span class="lock-indicator" id="lock-conyuge">
            <span class="material-icons">lock</span>
            Selecciona el principal primero
          </span>
        </div>

        <div class="fields-grid">
          <div class="form-group autocomplete-wrapper disabled" data-field="conyuge">
            <label class="form-label">Buscar cónyuge (opcional)</label>
            
            <input type="hidden" name="conyuge_id" class="autocomplete-hidden">
            
            <div class="autocomplete-field">
              <div class="autocomplete-chip" style="display: none;">
                <span class="chip-avatar"></span>
                <span class="chip-text">
                  <span class="chip-name"></span>
                  <span class="chip-code"></span>
                </span>
                <button type="button" class="chip-remove" title="Quitar">
                  <span class="material-icons">close</span>
                </button>
              </div>
              <input type="text" class="autocomplete-search" placeholder="Escribe un nombre o cédula…" autocomplete="off" disabled>
            </div>
            
            <div class="autocomplete-dropdown">
              <ul class="autocomplete-list"></ul>
              <div class="autocomplete-empty" style="display:none;">
                <span class="material-icons">person_search</span>
                <p>No se encontraron miembros</p>
              </div>
              <div class="autocomplete-loading" style="display:none;">
                <span class="material-icons spinner">sync</span>
                <p>Buscando...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PADRES -->
      <div class="form-section locked" id="section-padres">
        <div class="section-header">
          <div class="section-icon"><span class="material-icons">groups</span></div>
          <span class="section-title">Padre y madre</span>
          <span class="lock-indicator" id="lock-padres">
            <span class="material-icons">lock</span>
            Selecciona el principal primero
          </span>
        </div>

        <div class="fields-grid two-col">
          <div class="form-group autocomplete-wrapper disabled" data-field="padre">
            <label class="form-label">Buscar padre (opcional)</label>
            
            <input type="hidden" name="padre_id" class="autocomplete-hidden">
            
            <div class="autocomplete-field">
              <div class="autocomplete-chip" style="display: none;">
                <span class="chip-avatar"></span>
                <span class="chip-text">
                  <span class="chip-name"></span>
                  <span class="chip-code"></span>
                </span>
                <button type="button" class="chip-remove" title="Quitar">
                  <span class="material-icons">close</span>
                </button>
              </div>
              <input type="text" class="autocomplete-search" placeholder="Escribe un nombre o cédula…" autocomplete="off" disabled>
            </div>
            
            <div class="autocomplete-dropdown">
              <ul class="autocomplete-list"></ul>
              <div class="autocomplete-empty" style="display:none;">
                <span class="material-icons">person_search</span>
                <p>No se encontraron miembros</p>
              </div>
              <div class="autocomplete-loading" style="display:none;">
                <span class="material-icons spinner">sync</span>
                <p>Buscando...</p>
              </div>
            </div>
          </div>

          <div class="form-group autocomplete-wrapper disabled" data-field="madre">
            <label class="form-label">Buscar madre (opcional)</label>
            
            <input type="hidden" name="madre_id" class="autocomplete-hidden">
            
            <div class="autocomplete-field">
              <div class="autocomplete-chip" style="display: none;">
                <span class="chip-avatar"></span>
                <span class="chip-text">
                  <span class="chip-name"></span>
                  <span class="chip-code"></span>
                </span>
                <button type="button" class="chip-remove" title="Quitar">
                  <span class="material-icons">close</span>
                </button>
              </div>
              <input type="text" class="autocomplete-search" placeholder="Escribe un nombre o cédula…" autocomplete="off" disabled>
            </div>
            
            <div class="autocomplete-dropdown">
              <ul class="autocomplete-list"></ul>
              <div class="autocomplete-empty" style="display:none;">
                <span class="material-icons">person_search</span>
                <p>No se encontraron miembros</p>
              </div>
              <div class="autocomplete-loading" style="display:none;">
                <span class="material-icons spinner">sync</span>
                <p>Buscando...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HIJOS -->
      <div class="form-section locked" id="section-hijos">
        <div class="section-header">
          <div class="section-icon"><span class="material-icons">child_care</span></div>
          <span class="section-title">Hijos</span>
          <span class="lock-indicator" id="lock-hijos">
            <span class="material-icons">lock</span>
            Selecciona el principal primero
          </span>
        </div>

        <div class="help-text" style="margin-bottom: 12px;">
          Agrega todos tus hijos que ya estén registrados en el sistema.
        </div>

        <div class="children-list" id="childrenList"></div>

        <button type="button" class="btn-secondary" id="btnAddChild" disabled>
          <span class="material-icons">add</span>
          Añadir hijo
        </button>
      </div>

      <button type="submit" class="submit-btn" id="btnSubmit" disabled>
        <span class="material-icons">send</span>
        Enviar familia
      </button>

      <div class="form-footer">
        Si algún dato no aparece en la búsqueda, consulta con el equipo para registrarlo primero.
      </div>
    </form>
  </div>

  <div class="powered-by">
    Desarrollado con ❤️ por <strong>{{ CFG.nombre_iglesia|default:"Torre Fuerte" }}</strong>
  </div>

</div>

<script>
(function() {
  'use strict';

  // =============================================
  // CONFIG
  // =============================================
  const SEARCH_URL = "{% url 'actualizacion_datos_miembros:api_buscar_miembros' %}";
  const MIN_CHARS = 2;
  const DEBOUNCE_DELAY = 300;

  // Estado global
  let principalSelected = false;
  let autocompleteInstances = [];

  function getToken() {
    return document.body.dataset.altaFamiliaToken || "";
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return "";
    const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
    return String(text).replace(/[&<>"']/g, (m) => map[m]);
  }

  function getInitials(nombre) {
    if (!nombre) return "?";
    const parts = nombre.trim().split(/\s+/).filter(Boolean);
    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
    return nombre.trim().substring(0, 2).toUpperCase();
  }

  // =============================================
  // BLOQUEO/DESBLOQUEO DE SECCIONES
  // =============================================
  function unlockAllSections() {
    principalSelected = true;

    // Desbloquear secciones
    ['section-conyuge', 'section-padres', 'section-hijos'].forEach(id => {
      const section = document.getElementById(id);
      if (section) section.classList.remove('locked');
    });

    // Ocultar indicadores de bloqueo
    ['lock-conyuge', 'lock-padres', 'lock-hijos'].forEach(id => {
      const lock = document.getElementById(id);
      if (lock) lock.classList.add('unlocked');
    });

    // Habilitar wrappers y sus inputs
    document.querySelectorAll('.autocomplete-wrapper:not([data-field="principal"])').forEach(wrapper => {
      wrapper.classList.remove('disabled');
      const input = wrapper.querySelector('.autocomplete-search');
      if (input) input.disabled = false;
    });

    // Habilitar botones
    document.getElementById('btnAddChild').disabled = false;
    document.getElementById('btnSubmit').disabled = false;
  }

  function lockAllSections() {
    principalSelected = false;

    // Bloquear secciones
    ['section-conyuge', 'section-padres', 'section-hijos'].forEach(id => {
      const section = document.getElementById(id);
      if (section) section.classList.add('locked');
    });

    // Mostrar indicadores de bloqueo
    ['lock-conyuge', 'lock-padres', 'lock-hijos'].forEach(id => {
      const lock = document.getElementById(id);
      if (lock) lock.classList.remove('unlocked');
    });

    // Deshabilitar wrappers
    document.querySelectorAll('.autocomplete-wrapper:not([data-field="principal"])').forEach(wrapper => {
      wrapper.classList.add('disabled');
      const input = wrapper.querySelector('.autocomplete-search');
      if (input) input.disabled = true;
    });

    // Deshabilitar botones
    document.getElementById('btnAddChild').disabled = true;
    document.getElementById('btnSubmit').disabled = true;
  }

  function clearAllSelections() {
    // Limpiar todos los autocompletes excepto el principal
    autocompleteInstances.forEach(instance => {
      if (instance.wrapper.dataset.field !== 'principal') {
        instance.clearSelection(true); // true = sin trigger de eventos
      }
    });

    // Limpiar hijos
    document.getElementById('childrenList').innerHTML = '';
  }

  // =============================================
  // MODAL DE CONFIRMACIÓN
  // =============================================
  const modal = document.getElementById('modalConfirm');
  const modalCancel = document.getElementById('modalCancel');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  let pendingClearCallback = null;

  function showModal(onConfirm) {
    pendingClearCallback = onConfirm;
    modal.classList.add('active');
  }

  function hideModal() {
    modal.classList.remove('active');
    pendingClearCallback = null;
  }

  modalCancel.addEventListener('click', hideModal);
  modalConfirmBtn.addEventListener('click', function() {
    if (pendingClearCallback) {
      pendingClearCallback();
    }
    hideModal();
  });

  // Cerrar modal con Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      hideModal();
    }
  });

  // =============================================
  // AUTOCOMPLETE CLASS
  // =============================================
  class AutocompleteMiembro {
    constructor(wrapper) {
      this.wrapper = wrapper;
      this.debounceTimer = null;
      this.isPrincipal = wrapper.dataset.field === 'principal';

      // Elementos
      this.hiddenInput = wrapper.querySelector('.autocomplete-hidden');
      this.fieldContainer = wrapper.querySelector('.autocomplete-field');
      this.searchInput = wrapper.querySelector('.autocomplete-search');
      this.dropdown = wrapper.querySelector('.autocomplete-dropdown');
      this.listEl = wrapper.querySelector('.autocomplete-list');
      this.emptyEl = wrapper.querySelector('.autocomplete-empty');
      this.loadingEl = wrapper.querySelector('.autocomplete-loading');
      
      // Chip
      this.chip = wrapper.querySelector('.autocomplete-chip');
      this.chipAvatar = wrapper.querySelector('.chip-avatar');
      this.chipName = wrapper.querySelector('.chip-name');
      this.chipCode = wrapper.querySelector('.chip-code');
      this.chipRemove = wrapper.querySelector('.chip-remove');

      if (!this.searchInput || !this.dropdown || !this.hiddenInput) return;

      this.bind();
      autocompleteInstances.push(this);
    }

    bind() {
      // Input con debounce
      this.searchInput.addEventListener('input', (e) => {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
          this.search(e.target.value || "");
        }, DEBOUNCE_DELAY);
      });

      // Focus
      this.searchInput.addEventListener('focus', () => {
        if ((this.searchInput.value || "").length >= MIN_CHARS) {
          this.openDropdown();
        }
      });

      // Teclas
      this.searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.closeDropdown();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const firstItem = this.listEl.querySelector('.autocomplete-item');
          if (firstItem) {
            this.selectMiembro(firstItem.dataset.id, firstItem.dataset.nombre, firstItem.dataset.codigo);
          }
        }
      });

      // Quitar chip
      if (this.chipRemove) {
        this.chipRemove.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (this.isPrincipal && principalSelected) {
            // Mostrar modal de confirmación
            showModal(() => {
              clearAllSelections();
              this.clearSelection();
              lockAllSections();
            });
          } else {
            this.clearSelection();
          }
        });
      }

      // Click fuera
      document.addEventListener('click', (e) => {
        if (!this.wrapper.contains(e.target)) this.closeDropdown();
      });
    }

    async search(query) {
      query = (query || "").trim();

      if (query.length < MIN_CHARS) {
        this.closeDropdown();
        return;
      }

      this.showLoading();

      try {
        const token = getToken();
        const url = `${SEARCH_URL}?q=${encodeURIComponent(query)}&filtro=activos&limit=15` +
                    (token ? `&token=${encodeURIComponent(token)}` : "");

        const response = await fetch(url, {
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.success && Array.isArray(data.resultados) && data.resultados.length > 0) {
          this.renderResults(data.resultados);
        } else {
          this.showEmpty();
        }
      } catch (err) {
        console.error('AutocompleteMiembro error:', err);
        this.showEmpty();
      }
    }

    renderResults(resultados) {
      this.listEl.innerHTML = '';

      resultados.forEach((miembro) => {
        const li = document.createElement('li');
        li.className = 'autocomplete-item';
        li.dataset.id = String(miembro.id);
        li.dataset.nombre = miembro.nombre || '';
        li.dataset.codigo = miembro.codigo || '';

        const initials = getInitials(miembro.nombre || '');

        li.innerHTML = `
          <div class="autocomplete-item-avatar">${escapeHtml(initials)}</div>
          <div class="autocomplete-item-info">
            <div class="autocomplete-item-name">${escapeHtml(miembro.nombre || '')}</div>
            <div class="autocomplete-item-meta">
              ${miembro.codigo ? `<span class="autocomplete-item-code">${escapeHtml(miembro.codigo)}</span>` : ''}
              ${miembro.telefono && miembro.telefono !== '—' ? `<span>${escapeHtml(miembro.telefono)}</span>` : ''}
            </div>
          </div>
        `;

        li.addEventListener('click', () => {
          this.selectMiembro(miembro.id, miembro.nombre, miembro.codigo);
        });

        this.listEl.appendChild(li);
      });

      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.emptyEl) this.emptyEl.style.display = 'none';
      this.listEl.style.display = 'block';
      this.openDropdown();
    }

    selectMiembro(id, nombre, codigo) {
      this.hiddenInput.value = String(id);

      // Actualizar chip
      if (this.chipAvatar) this.chipAvatar.textContent = getInitials(nombre || '');
      if (this.chipName) this.chipName.textContent = nombre || '';
      if (this.chipCode) this.chipCode.textContent = codigo || 'Sin código';

      // Mostrar chip, ocultar input
      this.chip.style.display = 'inline-flex';
      this.searchInput.value = '';
      this.searchInput.style.display = 'none';
      if (this.fieldContainer) this.fieldContainer.classList.add('has-selection');

      this.closeDropdown();

      // Si es el principal, desbloquear todo
      if (this.isPrincipal) {
        unlockAllSections();
      }
    }

    clearSelection(silent = false) {
      this.hiddenInput.value = '';
      this.chip.style.display = 'none';
      this.searchInput.style.display = '';
      if (this.fieldContainer) this.fieldContainer.classList.remove('has-selection');
      this.searchInput.value = '';
      this.listEl.innerHTML = '';
      this.closeDropdown();
      
      if (!silent) {
        this.searchInput.focus();
      }
    }

    showLoading() {
      this.listEl.innerHTML = '';
      this.listEl.style.display = 'none';
      if (this.emptyEl) this.emptyEl.style.display = 'none';
      if (this.loadingEl) this.loadingEl.style.display = 'block';
      this.openDropdown();
    }

    showEmpty() {
      this.listEl.innerHTML = '';
      this.listEl.style.display = 'none';
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.emptyEl) this.emptyEl.style.display = 'block';
      this.openDropdown();
    }

    openDropdown() {
      this.dropdown.classList.add('open');
    }

    closeDropdown() {
      this.dropdown.classList.remove('open');
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.emptyEl) this.emptyEl.style.display = 'none';
    }
  }

  // =============================================
  // INIT
  // =============================================
  document.addEventListener('DOMContentLoaded', function() {
    
    // Bienvenida -> mostrar formulario
    document.getElementById('btnStart').addEventListener('click', function() {
      document.getElementById('welcomeBox').style.display = 'none';
      document.getElementById('familyForm').classList.remove('hidden');
      // Focus al primer campo
      const firstSearch = document.querySelector('#autocomplete-principal .autocomplete-search');
      if (firstSearch) firstSearch.focus();
    });

    // Inicializar autocompletes existentes (principal, cónyuge, padre, madre)
    document.querySelectorAll('.autocomplete-wrapper').forEach(wrapper => {
      new AutocompleteMiembro(wrapper);
    });

    // =============================================
    // HIJOS DINÁMICOS
    // =============================================
    const childrenList = document.getElementById('childrenList');
    const btnAddChild = document.getElementById('btnAddChild');
    let childCounter = 0;

    function addChildRow() {
      childCounter++;
      const idx = childCounter;

      const row = document.createElement('div');
      row.className = 'child-row';
      row.innerHTML = `
        <div class="form-group autocomplete-wrapper" data-field="hijo_${idx}">
          <label class="form-label">Buscar hijo</label>
          
          <input type="hidden" name="hijos_ids" class="autocomplete-hidden">
          
          <div class="autocomplete-field">
            <div class="autocomplete-chip" style="display: none;">
              <span class="chip-avatar"></span>
              <span class="chip-text">
                <span class="chip-name"></span>
                <span class="chip-code"></span>
              </span>
              <button type="button" class="chip-remove" title="Quitar">
                <span class="material-icons">close</span>
              </button>
            </div>
            <input type="text" class="autocomplete-search" placeholder="Escribe un nombre o cédula…" autocomplete="off">
          </div>
          
          <div class="autocomplete-dropdown">
            <ul class="autocomplete-list"></ul>
            <div class="autocomplete-empty" style="display:none;">
              <span class="material-icons">person_search</span>
              <p>No se encontraron miembros</p>
            </div>
            <div class="autocomplete-loading" style="display:none;">
              <span class="material-icons spinner">sync</span>
              <p>Buscando...</p>
            </div>
          </div>

          <div class="row-actions">
            <button type="button" class="btn-secondary btn-remove-child">
              <span class="material-icons">delete</span>
              Quitar
            </button>
          </div>
        </div>
      `;

      childrenList.appendChild(row);

      // Inicializar autocomplete para este hijo
      const wrapper = row.querySelector('.autocomplete-wrapper');
      new AutocompleteMiembro(wrapper);

      // Botón quitar
      row.querySelector('.btn-remove-child').addEventListener('click', function() {
        // Remover de la lista de instancias
        const instance = autocompleteInstances.find(i => i.wrapper === wrapper);
        if (instance) {
          const idx = autocompleteInstances.indexOf(instance);
          if (idx > -1) autocompleteInstances.splice(idx, 1);
        }
        row.remove();
      });

      // Focus al nuevo input
      const newInput = row.querySelector('.autocomplete-search');
      if (newInput) newInput.focus();
    }

    btnAddChild.addEventListener('click', addChildRow);

  });

})();
</script>
</body>
</html>