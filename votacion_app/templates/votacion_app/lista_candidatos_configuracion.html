{% extends "core/base.html" %}

{% block title %}{{ titulo }} · Soid_Tf_2{% endblock %}

{% block content %}

<!-- ===========================
     ENCABEZADO
=========================== -->
<div class="page-header page-header-compact no-print lista-config-header">
    <div class="lista-config-header-main">
        <h1 class="page-title">{{ titulo }}</h1>
        {% if lista %}
            <p class="page-subtitle">
                Administra el nombre, el código y los miembros que forman parte de esta lista previa.
            </p>
        {% else %}
            <p class="page-subtitle">
                Primero define el nombre de la lista. Luego podrás añadir miembros y gestionarlos.
            </p>
        {% endif %}
    </div>

    <div class="page-header-actions lista-config-header-actions">
        <a href="{% url 'votacion:lista_candidatos_listado' %}" class="btn-secondary btn-sm">
            <span class="material-icons" aria-hidden="true">arrow_back</span>
            <span class="btn-text">Volver a listas</span>
        </a>

        {% if lista %}
            <a href="{% url 'votacion:lista_candidatos_reporte' lista.pk %}"
               class="btn-secondary btn-sm"
               target="_blank">
                <span class="material-icons" aria-hidden="true">print</span>
                <span class="btn-text">Imprimir</span>
            </a>
        {% endif %}
    </div>
</div>

<div class="page-section lista-config">

    <!-- Mensajes del sistema -->
    {% if messages %}
        <div class="mb-2">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Layout principal: dos columnas en desktop, una en móvil -->
    <div class="lista-config-grid">

        <!-- ===========================
             TARJETA 1: DATOS BÁSICOS
        ============================ -->
        <section class="lcg-card">
            <header class="lcg-card-header">
                <div>
                    <h2 class="lcg-card-title">Datos de la lista</h2>
                    <p class="lcg-card-subtitle">
                        Usa un nombre claro y, si lo deseas, un código corto para identificarla rápidamente.
                    </p>
                </div>

                {% if lista %}
                    <span class="lcg-badge-estado {% if lista.estado == 'CONFIRMADA' %}lcg-badge-success{% else %}lcg-badge-warning{% endif %}">
                        {{ lista.get_estado_display }}
                    </span>
                {% endif %}
            </header>

            <form method="post" class="lcg-form">
                {% csrf_token %}

                <div class="lcg-form-row">
                    <div class="form-group lcg-form-col">
                        <label for="{{ form.nombre.id_for_label }}">Nombre de la lista</label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="lcg-field-error">{{ form.nombre.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group lcg-form-col">
                        <label for="{{ form.codigo_lista.id_for_label }}">Código (opcional)</label>
                        {{ form.codigo_lista }}
                        <p class="lcg-field-help">
                            Ejemplo: <strong>LD-2026-01</strong>. Útil para búsquedas y reportes.
                        </p>
                        {% if form.codigo_lista.errors %}
                            <div class="lcg-field-error">{{ form.codigo_lista.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.notas.id_for_label }}">Notas internas</label>
                    {{ form.notas }}
                    <p class="lcg-field-help">
                        Solo visible en el sistema. Anota aquí detalles sobre la lista o el contexto de uso.
                    </p>
                </div>

                <div class="lcg-form-footer">
                    <button type="submit"
                            name="accion"
                            value="guardar_seguir"
                            class="btn-primary btn-sm">
                        Guardar datos
                    </button>
                </div>

                {% if lista %}
                    {% if lista.estado == 'CONFIRMADA' %}
                        <p class="lcg-state-info">
                            Esta lista está <strong>confirmada</strong>. Su contenido no puede modificarse desde aquí.
                            Para permitir cambios, pásala a <strong>borrador</strong> desde la pantalla de listas.
                        </p>
                    {% else %}
                        <p class="lcg-state-info">
                            La lista está en <strong>borrador</strong>. Puedes seguir añadiendo o quitando miembros.
                        </p>
                    {% endif %}
                {% endif %}
            </form>
        </section>

        <!-- ===========================
             TARJETA 2: MIEMBROS
        ============================ -->
        <section class="lcg-card">
            <header class="lcg-card-header">
                <div>
                    <h2 class="lcg-card-title">
                        Miembros de la lista
                        {% if items %}
                            <span class="lcg-badge-count">{{ items|length }}</span>
                        {% endif %}
                    </h2>
                    <p class="lcg-card-subtitle">
                        Añade miembros por su código y revisa quiénes forman parte de esta lista previa.
                    </p>
                </div>
            </header>

            {% if lista %}
                {% if lista.estado == 'BORRADOR' %}
                    <!-- Formulario para agregar miembro por código -->
                    <form method="post" class="lcg-inline-form no-print" data-confirm-agregar="true">
                        {% csrf_token %}
                        <input type="hidden" name="accion" value="agregar_miembro">

                        <div class="lcg-inline-row">
                            <div class="form-group lcg-inline-grow">
                                {{ agregar_form.codigo_sufijo.label_tag }}
                                {{ agregar_form.codigo_sufijo }}
                                {% if agregar_form.codigo_sufijo.help_text %}
                                    <p class="lcg-field-help">
                                        {{ agregar_form.codigo_sufijo.help_text }}
                                    </p>
                                {% endif %}
                            </div>

                            <div class="lcg-inline-actions">
                                <button type="submit" class="btn-secondary btn-sm">
                                    <span class="material-icons" aria-hidden="true">person_add</span>
                                    <span class="btn-text">Añadir</span>
                                </button>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <p class="lcg-field-help">
                        La lista está <strong>confirmada</strong>. No puedes añadir ni quitar miembros desde aquí.
                    </p>
                {% endif %}

                <!-- Tabla de miembros -->
                <div class="table-wrapper lcg-table-wrapper">
                    <table class="table lcg-table">
                        <thead>
                            <tr>
                                <th class="lcg-th-foto">Foto</th>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th class="no-print lcg-th-acciones">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if items %}
                                {% for item in items %}
                                    <tr>
                                        <td>
                                            {% if item.miembro.foto %}
                                                <img src="{{ item.miembro.foto.url }}"
                                                     alt="Foto de {{ item.miembro }}"
                                                     class="lcg-avatar lcg-avatar-sm">
                                            {% else %}
                                                <div class="lcg-avatar lcg-avatar-sm lcg-avatar-placeholder">
                                                    {{ item.miembro.iniciales|default:"?" }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="lcg-cell-code">
                                            {{ item.miembro.codigo_miembro }}
                                        </td>
                                        <td>
                                            <div class="lcg-member-name">
                                                {{ item.miembro }}
                                            </div>
                                            {% if item.observacion %}
                                                <div class="lcg-member-note">
                                                    {{ item.observacion }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="no-print lcg-cell-actions">
                                            {% if lista.estado == 'BORRADOR' %}
                                                <form method="post"
                                                      style="display:inline;"
                                                      onsubmit="return confirm('¿Quitar este miembro de la lista?');">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="accion" value="eliminar_item">
                                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                                    <button type="submit"
                                                            class="lcg-btn-icon"
                                                            title="Quitar de la lista">
                                                        <span class="material-icons" aria-hidden="true">close</span>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="lcg-table-empty">
                                        Aún no hay miembros en esta lista.
                                        {% if lista.estado == 'BORRADOR' %}
                                            Empieza añadiéndolos por su código de miembro.
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="lcg-empty-info">
                    Primero guarda la lista (nombre y, si quieres, código).
                    Después podrás añadir miembros y verlos aquí.
                </p>
            {% endif %}
        </section>

    </div>
</div>

<style>
    /* ===============================
       CONTEXTO GENERAL
    =============================== */
    .lista-config-header {
        margin-bottom: 16px;
    }

    .lista-config-header-main .page-subtitle {
        margin-top: 2px;
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .lista-config-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
    }

    .btn-sm .material-icons {
        font-size: 18px;
        line-height: 1;
    }

    .btn-text {
        white-space: nowrap;
    }

    /* Contenedor principal */
    .lista-config {
        --lcg-gray-50: #f9fafb;
        --lcg-gray-100: #f3f4f6;
        --lcg-gray-200: #e5e7eb;
        --lcg-gray-300: #d1d5db;
        --lcg-gray-400: #9ca3af;
        --lcg-gray-500: #6b7280;
        --lcg-gray-600: #4b5563;
        --lcg-gray-800: #1f2937;
        --lcg-success: #16a34a;
        --lcg-warning: #f59e0b;
        --lcg-danger: #dc2626;
    }

    .lista-config-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 14px;
    }

    @media (min-width: 900px) {
        .lista-config-grid {
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
        }
    }

    /* ===============================
       TARJETAS
    =============================== */
    .lcg-card {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 5px 15px rgba(15, 23, 42, 0.04);
        padding: 14px 16px;
    }

    .lcg-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--lcg-gray-100);
        margin-bottom: 10px;
    }

    .lcg-card-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin: 0;
        color: var(--lcg-gray-800);
    }

    .lcg-card-subtitle {
        margin: 2px 0 0;
        font-size: 0.8rem;
        color: var(--lcg-gray-500);
    }

    /* ===============================
       BADGES
    =============================== */
    .lcg-badge-estado {
        font-size: 0.78rem;
        padding: 4px 10px;
        border-radius: 999px;
        white-space: nowrap;
        border: 1px solid var(--lcg-gray-200);
        background: var(--lcg-gray-50);
        color: var(--lcg-gray-600);
        font-weight: 500;
    }

    .lcg-badge-success {
        background: #ecfdf3;
        border-color: #bbf7d0;
        color: #166534;
    }

    .lcg-badge-warning {
        background: #fffbeb;
        border-color: #fde68a;
        color: #92400e;
    }

    .lcg-badge-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* ===============================
       FORMULARIOS
    =============================== */
    .lcg-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .lcg-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .lcg-form-col {
        flex: 1 1 250px;
    }

    .lcg-field-help {
        margin-top: 3px;
        font-size: 0.78rem;
        color: var(--lcg-gray-500);
    }

    .lcg-field-error {
        margin-top: 3px;
        font-size: 0.78rem;
        color: var(--lcg-danger);
    }

    .lcg-form-footer {
        margin-top: 4px;
    }

    .lcg-state-info {
        margin-top: 6px;
        font-size: 0.8rem;
        color: var(--lcg-gray-500);
    }

    .lcg-empty-info {
        font-size: 0.85rem;
        color: var(--lcg-gray-500);
        background: var(--lcg-gray-50);
        padding: 14px;
        border-radius: 10px;
        margin: 6px 0;
    }

    /* Inputs/textarea solo dentro de esta tarjeta */
    .lcg-card input[type="text"],
    .lcg-card input[type="number"],
    .lcg-card input[type="email"],
    .lcg-card textarea,
    .lcg-card select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--lcg-gray-300);
        padding: 7px 10px;
        font-size: 0.9rem;
        background: var(--lcg-gray-50);
        transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .lcg-card textarea {
        min-height: 40px;
        resize: vertical;
        font-family: inherit;
    }

    .lcg-card input:focus,
    .lcg-card textarea:focus,
    .lcg-card select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.18);
        background: #ffffff;
    }

    /* ===============================
       FORM INLINE (AÑADIR MIEMBRO)
    =============================== */
    .lcg-inline-form {
        margin-top: 4px;
        margin-bottom: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--lcg-gray-50);
        border: 1px solid var(--lcg-gray-100);
    }

    .lcg-inline-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-end;
    }

    .lcg-inline-grow {
        flex: 1 1 250px;
    }

    .lcg-inline-actions {
        flex: 0 0 auto;
    }

    /* ===============================
       TABLA DE MIEMBROS
    =============================== */
    .lcg-table-wrapper {
        margin-top: 10px;
    }

    .lcg-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.88rem;
    }

    .lcg-table thead th {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--lcg-gray-600);
        background: var(--lcg-gray-50);
        border-bottom: 2px solid var(--lcg-gray-200);
        padding: 8px;
        text-align: left;
        white-space: nowrap;
    }

    .lcg-table tbody td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--lcg-gray-100);
        vertical-align: middle;
    }

    .lcg-table tbody tr:hover {
        background: var(--lcg-gray-50);
    }

    .lcg-th-foto {
        width: 48px;
    }

    .lcg-th-acciones {
        width: 70px;
        text-align: right;
    }

    .lcg-cell-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.82rem;
        color: #1e3a8a;
        font-weight: 600;
    }

    .lcg-member-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--lcg-gray-800);
    }

    .lcg-member-note {
        font-size: 0.78rem;
        color: var(--lcg-gray-500);
        margin-top: 2px;
    }

    .lcg-table-empty {
        text-align: center;
        padding: 26px 10px !important;
        font-size: 0.88rem;
        color: var(--lcg-gray-500);
    }

    .lcg-cell-actions {
        text-align: right;
    }

    /* ===============================
       AVATARES
    =============================== */
    .lcg-avatar {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        overflow: hidden;
        background: var(--lcg-gray-200);
        color: #ffffff;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .lcg-avatar-sm {
        width: 36px;
        height: 36px;
    }

    .lcg-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .lcg-avatar-placeholder {
        background: linear-gradient(135deg, #6366f1, #ec4899);
    }

    /* ===============================
       BOTÓN ICONO (ELIMINAR)
    =============================== */
    .lcg-btn-icon {
        border: none;
        background: transparent;
        padding: 4px;
        border-radius: 999px;
        cursor: pointer;
        color: var(--lcg-danger);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s ease, transform 0.1s ease, opacity 0.15s ease;
    }

    .lcg-btn-icon .material-icons {
        font-size: 18px;
    }

    .lcg-btn-icon:hover {
        background: rgba(220, 38, 38, 0.06);
        transform: translateY(-0.5px);
        opacity: 0.9;
    }

    /* ===============================
       RESPONSIVE
    =============================== */
    @media (max-width: 768px) {
        .lista-config-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .lista-config-header-actions {
            justify-content: flex-start;
        }

        .lcg-form-row {
            flex-direction: column;
        }

        .lcg-inline-row {
            flex-direction: column;
        }

        .lcg-inline-actions {
            width: 100%;
        }

        .lcg-inline-actions .btn-sm {
            width: 100%;
            justify-content: center;
        }
    }

    @media print {
        .no-print {
            display: none !important;
        }
    }
</style>


<!-- Modal de confirmación para agregar candidato -->
<div id="confirm-agregar-modal" class="lcg-modal-backdrop">
  <div class="lcg-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-agregar-titulo">
    <div class="lcg-modal-header">
      <h3 id="confirm-agregar-titulo">Confirmar candidato</h3>
      <button type="button" class="lcg-modal-close" id="confirm-agregar-cerrar" aria-label="Cerrar">
        <span class="material-icons" aria-hidden="true">close</span>
      </button>
    </div>
    <div class="lcg-modal-body">
      <p class="lcg-modal-text">
        ¿Deseas añadir a la lista al siguiente miembro?
      </p>
      <div class="lcg-modal-member">
        <div class="lcg-modal-member-main">
          <span class="lcg-modal-member-name" id="confirm-agregar-nombre"></span>
          <span class="lcg-modal-member-code">
            Código: <strong id="confirm-agregar-codigo"></strong>
          </span>
        </div>
      </div>
      <p class="lcg-modal-subtext" id="confirm-agregar-detalle">
        Si confirmas, el sistema añadirá este miembro a la lista
        si todavía cumple las condiciones (activo, edad mínima, etc.).
      </p>
    </div>
    <div class="lcg-modal-footer">
      <button type="button" class="btn-secondary btn-sm" id="confirm-agregar-cancelar">
        Cancelar
      </button>
      <button type="button" class="btn-primary btn-sm" id="confirm-agregar-aceptar">
        Sí, añadir
      </button>
    </div>
  </div>
</div>

<style>
.lcg-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
}

.lcg-modal-backdrop.is-visible {
  display: flex;
}

.lcg-modal {
  background: #ffffff;
  border-radius: 16px;
  padding: 14px 16px 12px;
  max-width: 420px;
  width: 100%;
  box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.lcg-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.lcg-modal-header h3 {
  margin: 0;
  font-size: 0.98rem;
  font-weight: 600;
}

.lcg-modal-close {
  border: none;
  background: transparent;
  padding: 4px;
  border-radius: 999px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.lcg-modal-close .material-icons {
  font-size: 18px;
}

.lcg-modal-body {
  margin-bottom: 10px;
}

.lcg-modal-text {
  margin: 0 0 8px;
  font-size: 0.88rem;
}

.lcg-modal-subtext {
  margin: 8px 0 0;
  font-size: 0.8rem;
  opacity: 0.8;
}

.lcg-modal-member {
  margin-top: 6px;
  padding: 10px 10px;
  border-radius: 10px;
  background: var(--lcg-gray-50);
  border: 1px solid var(--lcg-gray-100);
}

.lcg-modal-member-main {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.lcg-modal-member-name {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--lcg-gray-800);
}

.lcg-modal-member-code {
  font-size: 0.8rem;
  color: var(--lcg-gray-500);
}

.lcg-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  var modal = document.getElementById("confirm-agregar-modal");
  if (!modal) return;

  var spanCodigo  = document.getElementById("confirm-agregar-codigo");
  var spanNombre  = document.getElementById("confirm-agregar-nombre");
  var btnCancelar = document.getElementById("confirm-agregar-cancelar");
  var btnAceptar  = document.getElementById("confirm-agregar-aceptar");
  var btnCerrar   = document.getElementById("confirm-agregar-cerrar");
  var pendingForm = null;

  function cerrarModal() {
    modal.classList.remove("is-visible");
    pendingForm = null;
  }

  async function buscarMiembroPorCodigo(codigoRaw) {
    var url = "{% url 'votacion:lista_candidatos_buscar_miembro' %}";
    var params = new URLSearchParams({codigo: codigoRaw || ""});
    var resp = await fetch(url + "?" + params.toString(), {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    });
    if (!resp.ok) {
      throw new Error("Error de red al buscar el miembro");
    }
    return await resp.json();
  }

  document.addEventListener("submit", function (evt) {
    var form = evt.target;
    if (form.matches('[data-confirm-agregar="true"]')) {
      evt.preventDefault();
      var input = form.querySelector('input[name="codigo_sufijo"]');
      var codigo = input && input.value ? input.value.trim() : "";

      if (!codigo) {
        alert("Debes introducir un código de miembro.");
        return;
      }

      // Llamamos al endpoint AJAX para obtener nombre + código normalizado
      buscarMiembroPorCodigo(codigo)
        .then(function (data) {
          if (!data.ok) {
            alert(data.error || "No se pudo localizar el miembro.");
            return;
          }

          // Rellenamos el modal con nombre + código
          if (spanNombre) spanNombre.textContent = data.nombre || "";
          if (spanCodigo) spanCodigo.textContent = data.codigo || codigo;

          pendingForm = form;
          modal.classList.add("is-visible");
        })
        .catch(function (err) {
          console.error(err);
          alert("Ocurrió un error al buscar el miembro.");
        });
    }
  });

  if (btnCancelar) {
    btnCancelar.addEventListener("click", function () {
      cerrarModal();
    });
  }
  if (btnCerrar) {
    btnCerrar.addEventListener("click", function () {
      cerrarModal();
    });
  }
  if (btnAceptar) {
    btnAceptar.addEventListener("click", function () {
      if (pendingForm) {
        var form = pendingForm;
        cerrarModal();
        form.submit();   // aquí ya entra al view y lo agrega de verdad
      }
    });
  }

  modal.addEventListener("click", function (evt) {
    if (evt.target === modal) {
      cerrarModal();
    }
  });
});
</script>


{% endblock %}
