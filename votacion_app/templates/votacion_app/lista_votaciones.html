{% extends "core/base.html" %}

{% block title %}Elecciones · Soid_Tf_2{% endblock %}

{% block content %}

<!-- ===========================
     ENCABEZADO
=========================== -->
<div class="page-header">
    <div>
        <h1 class="page-title">Elecciones</h1>
        <p class="page-subtitle">
            Gestiona las votaciones de tu iglesia: configura reglas, vueltas y seguimiento.
        </p>
    </div>

    <div class="page-header-actions">

        <!-- Botón para ir a listas de candidatos -->
        <a href="{% url 'votacion:lista_candidatos_listado' %}"
           class="btn-secondary"
           style="margin-right: 8px;">
            <span class="material-icons" style="font-size: 18px;">how_to_reg</span>
            Listado de los Candidatos
        </a>

        <!-- Botón para crear nueva elección -->
        <a href="{% url 'votacion:crear_votacion' %}" class="btn-primary">
            <span class="material-icons" style="font-size: 18px;">add</span>
            Nueva elección
        </a>

    </div>
</div>

<div class="page-section">
    {% if messages %}
        <div class="mb-2">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {% if votaciones %}

        <!-- ===========================
             VISTA LISTA (ÚNICA VISTA)
        ============================ -->
        <div class="table-wrapper">
            <table class="table table-compact">
            <thead>
            <tr>
                <th class="col-id">ID</th>
                <th class="col-nombre">Nombre</th>
                <th class="col-tipo">Tipo</th>
                <th class="col-estado">Estado</th>
                <th class="col-fecha">Creación</th>
                <th class="col-fecha">Actualización</th>
                <th class="col-acciones">Acciones</th>
            </tr>
            </thead>

                <tbody>
                    {% for v in votaciones %}
                        <!-- Fila principal de la elección -->
                        <tr class="{% if v.estado == 'ABIERTA' %}row-election-open{% endif %}">
                            <td>{{ v.nombre }}</td>
                            <td>{{ v.get_tipo_display }}</td>
                            <td>
                                {% if v.estado == "ABIERTA" %}
                                    <span class="badge-soft badge-soft-success">Abierta</span>
                                {% elif v.estado == "CERRADA" %}
                                    <span class="badge-soft badge-soft-muted">Cerrada</span>
                                {% else %}
                                    <span class="badge-soft badge-soft-warning">Borrador</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if v.votos_minimos_requeridos %}
                                    <div>
                                        {{ v.votos_minimos_requeridos }}
                                        {% if v.base_quorum == "HABILITADOS" and v.total_habilitados %}
                                            / {{ v.total_habilitados }}
                                        {% elif v.base_quorum == "PRESENTES" and v.miembros_presentes %}
                                            / {{ v.miembros_presentes }}
                                        {% endif %}
                                    </div>
                                    <div class="table-subtext">
                                        {% if v.tipo_quorum == "PORCENTAJE" and v.valor_quorum %}
                                            {{ v.valor_quorum }}% · Base: {{ v.get_base_quorum_display }}
                                        {% else %}
                                            {{ v.get_tipo_quorum_display }} · Base: {{ v.get_base_quorum_display }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="badge-soft badge-soft-warning">Sin definir</span>
                                {% endif %}
                            </td>
                            <td>{{ v.get_regla_ganador_display }}</td>
                            <td class="col-center">{{ v.total_votos_emitidos }}</td>

                            <!-- ACCIONES -->
<td class="col-center">
    <div class="action-menu-wrapper">

        <!-- Botón que abre el menú -->
        <button type="button" class="action-menu-toggle" onclick="toggleActionMenu(this)">
            <span class="material-symbols-rounded">more_vert</span>
        </button>

        <!-- MENÚ OCULTO -->
        <div class="action-menu-dropdown">

            <!-- EDITAR -->
            <a href="{% url 'votacion:editar_votacion' v.pk %}" class="action-menu-item action-edit">
                <span class="material-symbols-rounded">edit</span>
                Editar
            </a>

            <!-- DUPLICAR -->
            <a href="{% url 'votacion:duplicar_votacion' v.pk %}" class="action-menu-item action-duplicate">
                <span class="material-symbols-rounded">content_copy</span>
                Duplicar
            </a>

            <!-- ESTADO (cambiar según estado actual) -->
            {% if v.estado == "BORRADOR" %}
            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                {% csrf_token %}
                <input type="hidden" name="nuevo_estado" value="ABIERTA">
                <button class="action-menu-item action-approve">
                    <span class="material-symbols-rounded">play_arrow</span>
                    Abrir votación
                </button>
            </form>

            {% elif v.estado == "ABIERTA" %}
            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                {% csrf_token %}
                <input type="hidden" name="nuevo_estado" value="CERRADA">
                <button class="action-menu-item action-approve">
                    <span class="material-symbols-rounded">stop</span>
                    Cerrar votación
                </button>
            </form>

            {% else %}
            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                {% csrf_token %}
                <input type="hidden" name="nuevo_estado" value="BORRADOR">
                <button class="action-menu-item action-approve">
                    <span class="material-symbols-rounded">restart_alt</span>
                    Volver a borrador
                </button>
            </form>
            {% endif %}

            <!-- KIOSKO -->
           <a href="{% url 'votacion:kiosko_ingreso_codigo' %}" class="action-menu-item action-edit">

                <span class="material-symbols-rounded">how_to_vote</span>
                Kiosko
            </a>

            <!-- PANTALLA PÚBLICA -->
            <a href="{% url 'votacion:pantalla_votacion' v.pk %}" class="action-menu-item action-print">
                <span class="material-symbols-rounded">monitor</span>
                Pantalla pública
            </a>

            <!-- ELIMINAR -->
            <a href="{% url 'votacion:eliminar_votacion' v.pk %}" class="action-menu-item action-delete">
                <span class="material-symbols-rounded">delete</span>
                Eliminar
            </a>

        </div>
    </div>
</td>

                        </tr>

                        <!-- Fila secundaria: vueltas (rondas) de esta elección -->
                        <tr class="row-rounds">
                            <td colspan="7">
                                <div class="rounds-inline">
                                    {% with v.rondas.all as rondas %}
                                        {% if rondas %}
                                            <span class="rounds-label">Vueltas:</span>
                                            {% for ronda in rondas %}
                                                <span class="round-pill">
                                                    {{ ronda.numero }}ª ·
                                                    {% if ronda.estado == "ABIERTA" %}
                                                        <span class="badge-soft badge-soft-success">Abierta</span>
                                                    {% elif ronda.estado == "CERRADA" %}
                                                        <span class="badge-soft badge-soft-muted">Cerrada</span>
                                                    {% else %}
                                                        <span class="badge-soft badge-soft-warning">Borrador</span>
                                                    {% endif %}
                                                    {% if ronda.fecha_inicio %}
                                                        · {{ ronda.fecha_inicio|date:"d/m H:i" }}
                                                    {% endif %}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="rounds-empty">
                                                Esta elección aún no tiene vueltas configuradas.
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}
        <div class="alert alert-info">
            Todavía no hay elecciones creadas.
            Usa el botón <strong>“Nueva elección”</strong> para crear la primera.
        </div>
    {% endif %}
</div>

<!-- CSS ESPECÍFICO PARA ESTA PANTALLA -->
<style>
    /* Tabla más limpia y ligera */
    .table-wrapper {
        border-radius: 8px;
        overflow: hidden;
    }

    .table {
        background: #ffffff;
        border-collapse: collapse;
        width: 100%;
    }

    .table thead {
        background: #f3f4f6;
    }

    .table th {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 10px 8px;
        color: #374151;
    }

    .table td {
        padding: 10px 8px;
        font-size: 0.84rem;
        vertical-align: middle;
    }

    /* Fila de elección abierta destacada */
    .row-election-open td {
        background: #ecfdf3;
        transition: background 0.15s ease-in-out;
    }

    .row-election-open:hover td {
        background: #dcfce7;
    }

    /* Hover general sobre filas */
    .table tbody tr:hover td {
        background: #f9fafb;
    }

    /* Texto auxiliar pequeño en celdas (como detalle del quórum) */
    .table-subtext {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Centrado de columnas numéricas */
    .col-center {
        text-align: center;
    }

    /* ---- FILA DE VUELTAS (RONDAS) ---- */
    .row-rounds td {
        background: #fafafa;
        padding-top: 4px;
        padding-bottom: 8px;
    }

    .rounds-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 0.8rem;
    }

    .rounds-label {
        font-weight: 600;
        color: var(--text-muted);
        margin-right: 4px;
    }

    .round-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
    }

    .rounds-empty {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Acciones comunes */
    .elections-actions {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .elections-actions form {
        margin: 0;
    }

    .btn-icon-only {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        min-width: 30px;
        min-height: 30px;
        border-radius: 999px;
    }

    .btn-icon-only .material-icons {
        font-size: 17px;
    }

    
</style>

<script>
function toggleActionMenu(btn) {
    const wrapper = btn.closest(".action-menu-wrapper");
    wrapper.classList.toggle("open");
    document.querySelectorAll(".action-menu-wrapper").forEach(w => {
        if (w !== wrapper) w.classList.remove("open");
    });
}
document.addEventListener("click", function(e) {
    if (!e.target.closest(".action-menu-wrapper")) {
        document.querySelectorAll(".action-menu-wrapper").forEach(w => w.classList.remove("open"));
    }
});
</script>


{% endblock %}
