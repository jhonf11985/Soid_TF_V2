{% extends "core/base.html" %}

{% block title %}Elecciones · Soid_Tf_2{% endblock %}

{% block content %}

<div class="page-header">
    <div>
        <h1 class="page-title">Elecciones</h1>
        <p class="page-subtitle">
            Gestiona aquí las elecciones creadas en el sistema.
        </p>
    </div>
    <div class="page-header-actions">
        <a href="{% url 'votacion:crear_votacion' %}" class="btn-primary">
            <span class="material-icons" style="font-size: 18px;">add</span>
            Nueva elección
        </a>
    </div>
</div>

<div class="page-section">
    {% if messages %}
        <div class="mb-2">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {% if votaciones %}
        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Quórum</th>
                        <th>Regla</th>
                        <th class="col-center">Votos</th>
                        <th class="col-center" style="width: 220px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in votaciones %}
                        <!-- Fila principal de la elección -->
                        <tr class="{% if v.estado == 'ABIERTA' %}row-election-open{% endif %}">
                            <td>{{ v.nombre }}</td>
                            <td>{{ v.get_tipo_display }}</td>
                            <td>
                                {% if v.estado == "ABIERTA" %}
                                    <span class="badge-soft badge-soft-success">Abierta</span>
                                {% elif v.estado == "CERRADA" %}
                                    <span class="badge-soft badge-soft-muted">Cerrada</span>
                                {% else %}
                                    <span class="badge-soft badge-soft-warning">Borrador</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if v.votos_minimos_requeridos %}
                                    <div>
                                        {{ v.votos_minimos_requeridos }}
                                        {% if v.base_quorum == "HABILITADOS" and v.total_habilitados %}
                                            / {{ v.total_habilitados }}
                                        {% elif v.base_quorum == "PRESENTES" and v.miembros_presentes %}
                                            / {{ v.miembros_presentes }}
                                        {% endif %}
                                    </div>
                                    <div class="table-subtext">
                                        {% if v.tipo_quorum == "PORCENTAJE" and v.valor_quorum %}
                                            {{ v.valor_quorum }}% · Base: {{ v.get_base_quorum_display }}
                                        {% else %}
                                            {{ v.get_tipo_quorum_display }} · Base: {{ v.get_base_quorum_display }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="badge-soft badge-soft-warning">Sin definir</span>
                                {% endif %}
                            </td>
                            <td>{{ v.get_regla_ganador_display }}</td>
                            <td class="col-center">{{ v.total_votos_emitidos }}</td>

                            <!-- ACCIONES -->
                            <td class="col-center">
                                <div class="elections-actions">

                                    <!-- Configurar -->
                                    <a href="{% url 'votacion:editar_votacion' v.pk %}"
                                       class="btn-secondary btn-icon-only"
                                       title="Configurar elección">
                                        <span class="material-icons">settings</span>
                                    </a>

                                    <!-- Duplicar -->
                                    <form method="post"
                                          action="{% url 'votacion:duplicar_votacion' v.pk %}">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="btn-secondary btn-icon-only"
                                                title="Duplicar elección">
                                            <span class="material-icons">content_copy</span>
                                        </button>
                                    </form>

                                    <!-- Eliminar -->
                                    <form method="post"
                                          action="{% url 'votacion:eliminar_votacion' v.pk %}"
                                          onsubmit="return confirm('¿Seguro que deseas eliminar esta elección? No se puede deshacer.');">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="btn-danger btn-icon-only"
                                                title="Eliminar elección">
                                            <span class="material-icons">delete</span>
                                        </button>
                                    </form>
                                
                                    <!-- Kiosko (solo si está ABIERTA) -->
                                    {% if v.estado == "ABIERTA" %}
                                        <a href="{% url 'votacion:kiosko_ingreso_codigo' %}"
                                           class="btn-primary btn-icon-only"
                                           title="Abrir modo kiosko (usa la última elección abierta)">
                                            <span class="material-icons">how_to_vote</span>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- Fila secundaria: vueltas (rondas) de esta elección -->
                        <tr class="row-rounds">
                            <td colspan="7">
                                <div class="rounds-inline">
                                    {% with v.rondas.all as rondas %}
                                        {% if rondas %}
                                            <span class="rounds-label">Vueltas:</span>
                                            {% for ronda in rondas %}
                                                <span class="round-pill">
                                                    {{ ronda.numero }}ª ·
                                                    {% if ronda.estado == "ABIERTA" %}
                                                        <span class="badge-soft badge-soft-success">Abierta</span>
                                                    {% elif ronda.estado == "CERRADA" %}
                                                        <span class="badge-soft badge-soft-muted">Cerrada</span>
                                                    {% else %}
                                                        <span class="badge-soft badge-soft-warning">Borrador</span>
                                                    {% endif %}
                                                    {% if ronda.fecha_inicio %}
                                                        · {{ ronda.fecha_inicio|date:"d/m H:i" }}
                                                    {% endif %}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="rounds-empty">
                                                Esta elección aún no tiene vueltas configuradas.
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            Todavía no hay elecciones creadas.
            Usa el botón <strong>“Nueva elección”</strong> para crear la primera.
        </div>
    {% endif %}
</div>

<!-- CSS ESPECÍFICO PARA ESTA TABLA -->
<style>
    .elections-actions {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .elections-actions form {
        margin: 0;
    }

    .btn-icon-only {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        min-width: 34px;
        min-height: 34px;
        border-radius: 999px;
    }

    .btn-icon-only .material-icons {
        font-size: 18px;
    }

    /* ---- FILA DE VUELTAS (RONDAS) ---- */

    .row-rounds td {
        background: #fafafa;
        padding-top: 4px;
        padding-bottom: 8px;
    }

    .rounds-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 0.85rem;
    }

    .rounds-label {
        font-weight: 600;
        color: var(--text-muted);
        margin-right: 4px;
    }

    .round-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
    }

    .rounds-empty {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Fila de elección abierta destacada */
    .row-election-open td {
        background: #ecfdf3;
        transition: background 0.15s ease-in-out;
    }

    .row-election-open:hover td {
        background: #dcfce7;
    }

    /* Hover general sobre filas */
    .table tbody tr:hover td {
        background: #f9fafb;
    }

    /* Texto auxiliar pequeño en celdas (como detalle del quórum) */
    .table-subtext {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Centrado de columnas numéricas */
    .col-center {
        text-align: center;
    }
</style>

{% endblock %}
