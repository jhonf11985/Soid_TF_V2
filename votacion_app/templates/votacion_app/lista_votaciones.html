{% extends "votacion_app/base_votacion.html" %}

{% load static %}

{% block title %}Elecciones · Torre Fuerte{% endblock %}

{% block extra_css %}
<!-- Material Symbols (por si no está en base.html) -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
<link rel="stylesheet" href="{% static 'votacion/css/votacion.css' %}">
{% endblock %}

{% block votacion_content %}

<!-- ===========================
     ENCABEZADO
=========================== -->
<div class="page-header">
    <div>
        <h1 class="page-title">Elecciones</h1>
        <p class="page-subtitle">
            Gestiona las votaciones de tu iglesia: configura reglas, vueltas y seguimiento.
        </p>
    </div>

    <div class="page-header-actions">
        <a href="{% url 'votacion:lista_candidatos_listado' %}" class="btn-secondary">
            <span class="material-symbols-rounded">how_to_reg</span>
            Listado de Candidatos
        </a>
        <a href="{% url 'votacion:crear_votacion' %}" class="btn-primary">
            <span class="material-symbols-rounded">add</span>
            Nueva elección
        </a>
    </div>
</div>

<!-- ===========================
     CONTENIDO PRINCIPAL
=========================== -->
<div class="page-section">

    {% if messages %}
        <div class="mb-2">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {% if votaciones %}

        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th class="col-nombre">Nombre</th>
                        <th class="col-tipo">Tipo</th>
                        <th class="col-estado">Estado</th>
                        <th class="col-quorum">Quórum</th>
                        <th class="col-regla">Regla Ganador</th>
                        <th class="col-votos">Votos</th>
                        <th class="col-acciones"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in votaciones %}
                        <!-- Fila principal -->
                        <tr class="{% if v.estado == 'ABIERTA' %}row-highlight-success{% endif %}">
                            <td>
                                <a href="{% url 'votacion:editar_votacion' v.pk %}" class="link-primary">
                                    {{ v.nombre }}
                                </a>
                            </td>
                            <td>{{ v.get_tipo_display }}</td>
                            <td>
                                {% if v.estado == "ABIERTA" %}
                                    <span class="badge-soft badge-soft-success">Abierta</span>
                                {% elif v.estado == "CERRADA" %}
                                    <span class="badge-soft badge-soft-muted">Cerrada</span>
                                {% else %}
                                    <span class="badge-soft badge-soft-warning">Borrador</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if v.votos_minimos_requeridos %}
                                    <div class="cell-main">
                                        {{ v.votos_minimos_requeridos }}
                                        {% if v.base_quorum == "HABILITADOS" and v.total_habilitados %}
                                            / {{ v.total_habilitados }}
                                        {% elif v.base_quorum == "PRESENTES" and v.miembros_presentes %}
                                            / {{ v.miembros_presentes }}
                                        {% endif %}
                                    </div>
                                    <div class="cell-sub">
                                        {% if v.tipo_quorum == "PORCENTAJE" and v.valor_quorum %}
                                            {{ v.valor_quorum }}% · {{ v.get_base_quorum_display }}
                                        {% else %}
                                            {{ v.get_tipo_quorum_display }} · {{ v.get_base_quorum_display }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Sin definir</span>
                                {% endif %}
                            </td>
                            <td>{{ v.get_regla_ganador_display }}</td>
                            <td class="text-center">
                                <span class="cell-number">{{ v.total_votos_emitidos }}</span>
                            </td>
                            <td class="text-center">
                                <div class="action-menu-wrapper">
                                    <button type="button" class="action-menu-toggle" onclick="toggleActionMenu(this)">
                                        <span class="material-symbols-rounded">more_vert</span>
                                    </button>
                                    <div class="action-menu-dropdown">
                                        <a href="{% url 'votacion:editar_votacion' v.pk %}" class="action-menu-item">
                                            <span class="material-symbols-rounded">edit</span>
                                            Editar
                                        </a>
                                        <a href="{% url 'votacion:duplicar_votacion' v.pk %}" class="action-menu-item">
                                            <span class="material-symbols-rounded">content_copy</span>
                                            Duplicar
                                        </a>

                                        <div class="action-menu-divider"></div>

                                        {% if v.estado == "BORRADOR" %}
                                            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="nuevo_estado" value="ABIERTA">
                                                <button type="submit" class="action-menu-item action-approve">
                                                    <span class="material-symbols-rounded">play_arrow</span>
                                                    Abrir votación
                                                </button>
                                            </form>
                                        {% elif v.estado == "ABIERTA" %}
                                            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="nuevo_estado" value="CERRADA">
                                                <button type="submit" class="action-menu-item action-print">
                                                    <span class="material-symbols-rounded">stop</span>
                                                    Cerrar votación
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="post" action="{% url 'votacion:cambiar_estado' v.pk %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="nuevo_estado" value="BORRADOR">
                                                <button type="submit" class="action-menu-item action-duplicate">
                                                    <span class="material-symbols-rounded">restart_alt</span>
                                                    Volver a borrador
                                                </button>
                                            </form>
                                        {% endif %}

                                        <div class="action-menu-divider"></div>

                                        <a href="{% url 'votacion:kiosko_ingreso_codigo' %}" class="action-menu-item">
                                            <span class="material-symbols-rounded">how_to_vote</span>
                                            Kiosko
                                        </a>
                                        <a href="{% url 'votacion:pantalla_votacion' v.pk %}" class="action-menu-item">
                                            <span class="material-symbols-rounded">monitor</span>
                                            Pantalla pública
                                        </a>

                                        <div class="action-menu-divider"></div>

                                        <a href="{% url 'votacion:eliminar_votacion' v.pk %}" class="action-menu-item action-delete">
                                            <span class="material-symbols-rounded">delete</span>
                                            Eliminar
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- Fila de vueltas/rondas -->
                        <tr class="row-subinfo">
                            <td colspan="7">
                                <div class="rounds-container">
                                    {% with v.rondas.all as rondas %}
                                        {% if rondas %}
                                            <span class="rounds-label">
                                                <span class="material-symbols-rounded">sync</span>
                                                Vueltas:
                                            </span>
                                            {% for ronda in rondas %}
                                                <span class="round-chip {% if ronda.estado == 'ABIERTA' %}round-chip-active{% elif ronda.estado == 'CERRADA' %}round-chip-closed{% endif %}">
                                                    {{ ronda.numero }}ª
                                                    {% if ronda.estado == "ABIERTA" %}
                                                        <span class="round-status-dot dot-success"></span>
                                                    {% elif ronda.estado == "CERRADA" %}
                                                        <span class="round-status-dot dot-muted"></span>
                                                    {% else %}
                                                        <span class="round-status-dot dot-warning"></span>
                                                    {% endif %}
                                                    {% if ronda.fecha_inicio %}
                                                        <span class="round-date">{{ ronda.fecha_inicio|date:"d/m H:i" }}</span>
                                                    {% endif %}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="rounds-empty">
                                                <span class="material-symbols-rounded">info</span>
                                                Sin vueltas configuradas
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}
        <!-- Estado vacío -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <span class="material-symbols-rounded">how_to_vote</span>
            </div>
            <h3 class="empty-state-title">No hay elecciones</h3>
            <p class="empty-state-text">
                Todavía no has creado ninguna elección.<br>
                Comienza creando tu primera votación.
            </p>
            <a href="{% url 'votacion:crear_votacion' %}" class="btn-primary">
                <span class="material-symbols-rounded">add</span>
                Nueva elección
            </a>
        </div>
    {% endif %}

</div>

{% endblock %}

{% block extra_js %}
<style>
/* === ESTILOS CRÍTICOS (respaldo si votacion.css no carga) === */

/* Badges */
.badge-soft {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 999px;
}
.badge-soft-success {
    background: #d1fae5;
    color: #065f46;
}
.badge-soft-warning {
    background: #fef3c7;
    color: #92400e;
}
.badge-soft-muted {
    background: #f3f4f6;
    color: #6b7280;
}

/* Fila destacada */
.row-highlight-success td {
    background: rgba(16, 185, 129, 0.06);
}

/* Celdas */
.cell-main { font-weight: 500; }
.cell-sub { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }
.cell-number { font-weight: 600; }

/* Link */
.link-primary {
    color: var(--color-primary, #0097a7);
    text-decoration: none;
    font-weight: 500;
}
.link-primary:hover { text-decoration: underline; }

/* Vueltas/Rondas */
.row-subinfo td {
    background: #f9fafb;
    padding: 8px 16px;
    border-bottom: 1px solid #e5e7eb;
}
.rounds-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
}
.rounds-label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    color: #374151;
}
.rounds-label .material-symbols-rounded { font-size: 16px; }
.round-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 500;
}
.round-chip-active {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}
.round-chip-closed {
    background: #f3f4f6;
    color: #6b7280;
}
.round-status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
}
.dot-success { background: #10b981; }
.dot-warning { background: #f59e0b; }
.dot-muted { background: #6b7280; }
.round-date { font-size: 0.75rem; color: #6b7280; }
.rounds-empty {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: #6b7280;
}

/* Divisor menú */
.action-menu-divider {
    height: 1px;
    background: #f3f4f6;
    margin: 6px 0;
}

/* Estado vacío */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
}
.empty-state-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
    background: #f3f4f6;
    border-radius: 50%;
    margin-bottom: 16px;
}
.empty-state-icon .material-symbols-rounded {
    font-size: 32px;
    color: #6b7280;
}
.empty-state-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 8px;
}
.empty-state-text {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 20px;
}

/* Utilidades */
.text-center { text-align: center; }
.text-muted { color: #6b7280; }
</style>

<script>
function toggleActionMenu(btn) {
    const wrapper = btn.closest(".action-menu-wrapper");
    const dropdown = wrapper.querySelector(".action-menu-dropdown");
    const isOpen = wrapper.classList.contains("open");

    // Cerrar todos los demás menús
    document.querySelectorAll(".action-menu-wrapper.open").forEach(w => {
        if (w !== wrapper) w.classList.remove("open");
    });

    if (isOpen) {
        wrapper.classList.remove("open");
        return;
    }

    wrapper.classList.add("open");
    
    if (!dropdown) return;

    requestAnimationFrame(() => {
        const rect = btn.getBoundingClientRect();
        const dropdownWidth = dropdown.offsetWidth || 180;
        
        dropdown.style.top = (rect.bottom + 4) + 'px';
        dropdown.style.left = (rect.right - dropdownWidth) + 'px';
        
        // Verificar espacio abajo
        const dropdownRect = dropdown.getBoundingClientRect();
        if (window.innerHeight - dropdownRect.bottom < 16) {
            dropdown.style.top = (rect.top - dropdown.offsetHeight - 4) + 'px';
        }
    });
}

// Cerrar al hacer clic fuera
document.addEventListener("click", function(e) {
    if (!e.target.closest(".action-menu-wrapper")) {
        document.querySelectorAll(".action-menu-wrapper.open").forEach(w => {
            w.classList.remove("open");
        });
    }
});
</script>
{% endblock %}