{% extends "core/base.html" %}

{% block title %}{{ titulo }} ¬∑ Soid_Tf_2{% endblock %}

{% block content %}

<!-- ===========================
     ENCABEZADO
=========================== -->
<section class="page-header">
    <div>
        <h1 class="page-title">{{ titulo }}</h1>
        <p class="page-subtitle">
            Configura el tipo de elecci√≥n, las reglas, las vueltas y los candidatos de forma organizada.
        </p>
    </div>

    <div class="page-header-actions">
        {% if not es_nueva and votacion %}

            <!-- Duplicar -->
            <form method="post"
                  action="{% url 'votacion:duplicar_votacion' votacion.pk %}"
                  style="display:inline-block; margin-right: 8px;">
                {% csrf_token %}
                <button type="submit" class="btn-secondary">
                    <span class="material-icons" style="font-size: 18px;">content_copy</span>
                    Duplicar
                </button>
            </form>

            <!-- Eliminar -->
            <form method="post"
                  action="{% url 'votacion:eliminar_votacion' votacion.pk %}"
                  onsubmit="return confirm('¬øSeguro que deseas eliminar esta elecci√≥n?')"
                  style="display:inline-block; margin-right: 8px;">
                {% csrf_token %}
                <button type="submit" class="btn-danger">
                    <span class="material-icons" style="font-size: 18px;">delete</span>
                    Eliminar
                </button>
            </form>
        {% endif %}

        <!-- Volver -->
        <a href="{% url 'votacion:lista_votaciones' %}" class="btn-secondary">
            <span class="material-icons" style="font-size: 18px;">arrow_back</span>
            Volver
        </a>
    </div>
</section>

<section class="votacion-config-wrapper">

    <!-- MENSAJES -->
    {% if messages %}
        <div class="messages-container" style="margin-bottom:10px;">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="votacion-card">

        <!-- ENCABEZADO INTERNO -->
        <div class="votacion-card-header">
            <div>
                <h2>Ficha de configuraci√≥n</h2>
                <p class="votacion-card-subtitle">
                    Ajusta primero la configuraci√≥n general. Luego revisa qu√≥rum, fechas, vueltas y candidatos.
                </p>
            </div>
            <div class="votacion-status-pill">
                <span class="status-dot"></span>
                {% if es_nueva %}
                    Nueva elecci√≥n
                {% else %}
                    Editando: {{ votacion.nombre|default:"Elecci√≥n" }}
                {% endif %}
            </div>
        </div>

        <!-- TABS -->
        <div class="votacion-tabs-bar">
            <button type="button"
                    class="votacion-tab-btn active"
                    onclick="openVotacionTab('tab-config', this)">
                Configuraci√≥n general
            </button>

            <button type="button"
                    class="votacion-tab-btn"
                    onclick="openVotacionTab('tab-quorum', this)">
                Qu√≥rum y asistencia
            </button>

            <button type="button"
                    class="votacion-tab-btn"
                    onclick="openVotacionTab('tab-fechas', this)">
                Fechas y opciones
            </button>

            <!-- Siempre visibles -->
            <button type="button"
                    class="votacion-tab-btn"
                    onclick="openVotacionTab('tab-vueltas', this)">
                Vueltas
            </button>

            <button type="button"
                    class="votacion-tab-btn"
                    onclick="openVotacionTab('tab-candidatos', this)">
                Candidatos
            </button>
        </div>

        <div class="votacion-layout">
            <!-- CONTENIDO PRINCIPAL -->
            <div class="votacion-main">

                <!-- ========== FORM PRINCIPAL (Config + Qu√≥rum + Fechas) ========== -->
                <form method="post" novalidate>
                    {% csrf_token %}

                    <!-- BARRA SUPERIOR DE GUARDAR -->
                    <div class="form-actions form-actions-top">
                        <div class="form-actions-main">
                            <button type="submit"
                                    name="accion"
                                    value="guardar_votacion"
                                    class="btn-primary"
                                    style="justify-content:center; max-width:260px;">
                                <span class="material-icons" style="font-size: 18px;">save</span>
                                Guardar configuraci√≥n
                            </button>
                            {% if es_nueva %}
                                <p class="form-actions-help">
                                    Guarda al menos una vez para poder gestionar las
                                    <strong>vueltas</strong> y los <strong>candidatos</strong>.
                                </p>
                            {% else %}
                                <p class="form-actions-help">
                                    Puedes actualizar los datos generales y luego seguir con vueltas y candidatos.
                                </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ========== TAB: CONFIGURACI√ìN GENERAL ========== -->
                    <div id="tab-config" class="votacion-tab-content" style="display:block;">
                        <h3 class="tab-title">Configuraci√≥n general</h3>
                        <p class="tab-description">
                            Define el nombre de la elecci√≥n, su tipo, estado y regla de ganador.
                        </p>

                        <!-- BLOQUE 1: DATOS B√ÅSICOS -->
                        <div class="form-section">
                            <h4 class="tab-subtitle">Datos b√°sicos</h4>
                            <div class="form-grid">
                                <div class="form-field form-field-full">
                                    <label>Nombre de la elecci√≥n</label>
                                    {{ form.nombre }}
                                </div>

                                <div class="form-field form-field-full">
                                    <label>Descripci√≥n</label>
                                    {{ form.descripcion }}
                                </div>

                                <div class="form-field">
                                    <label>Tipo</label>
                                    {{ form.tipo }}
                                </div>

                                <div class="form-field">
                                    <label>Estado</label>
                                    {{ form.estado }}
                                    <div class="field-help">Borrador ¬∑ Abierta ¬∑ Cerrada</div>
                                </div>

                                <div class="form-field">
                                    <label for="id_regla_ganador" style="display:flex; align-items:center; gap:6px;">
                                        Regla de votaci√≥n
                                        <a href="{% url 'votacion:documentacion_sistemas_votacion' %}"
                                           class="info-badge"
                                           target="_blank"
                                           title="Ver explicaci√≥n de los sistemas de votaci√≥n">
                                            ‚ìò
                                        </a>
                                    </label>
                                    {{ form.regla_ganador }}
                                </div>

                                <div class="form-field">
                                    <label>N√∫mero de cargos</label>
                                    {{ form.numero_cargos }}
                                    <div class="field-help">Ej.: 3 di√°conos, 2 l√≠deres‚Ä¶</div>
                                </div>

                                {% if form.edad_minima_candidato %}
                                <div class="form-field">
                                    <label>Edad m√≠nima del candidato</label>
                                    {{ form.edad_minima_candidato }}
                                    <div class="field-help">Ej.: 18 a√±os</div>
                                </div>
                                {% endif %}

                                <div class="form-field form-field-full">
                                    <label>Observaciones internas</label>
                                    {{ form.observaciones_internas }}
                                </div>
                            </div>
                        </div>
                    </div>
<!-- ========== TAB: QU√ìRUM Y ASISTENCIA ========== -->
<div id="tab-quorum" class="votacion-tab-content" style="display:none;">
    <h3 class="tab-title">Qu√≥rum y asistencia</h3>
    <p class="tab-description">
        Aqu√≠ defines cu√°ntas personas cuentan para la votaci√≥n y qu√© m√≠nimo de votos se necesita
        para que la elecci√≥n sea v√°lida.
    </p>

    <!-- PASOS VISUALES -->
    <ol class="quorum-steps">
        <li><strong>Paso 1:</strong> Revisa cu√°ntos miembros tienen derecho a votar.</li>
        <li><strong>Paso 2:</strong> Escribe cu√°ntos est√°n presentes f√≠sicamente.</li>
        <li><strong>Paso 3:</strong> Elige la base, el tipo de qu√≥rum y su valor.</li>
    </ol>

    <!-- RESUMEN DE MIEMBROS HABILITADOS (solo lectura visible) -->
    <div class="quorum-layout">
        <div class="quorum-column">
            <div class="quorum-summary-card">
                <div class="quorum-summary-header">
                    <span class="quorum-summary-title">Miembros con derecho a votar</span>
                    <span class="quorum-summary-badge">Calculado autom√°ticamente</span>
                </div>
                <div class="quorum-summary-value">
                    {{ form.total_habilitados.value|default:"‚Äî" }}
                </div>
                <p class="quorum-summary-help">
                    Son los miembros oficiales activos que cumplen la edad m√≠nima del sistema.
                    Este n√∫mero no se edita aqu√≠.
                </p>
            </div>

            {# Campo real, pero oculto visualmente para que viaje en el POST #}
            <div style="display:none;">
                {{ form.total_habilitados }}
            </div>

            <div class="form-section" style="margin-top: 16px;">
                <h4 class="tab-subtitle">Asistencia del d√≠a</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Miembros presentes (contados f√≠sicamente)</label>
                        {{ form.miembros_presentes }}
                        <div class="field-help">
                            Escribe cu√°ntos de esos miembros habilitados est√°n presentes hoy
                            en el local.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: CONFIGURACI√ìN DE QU√ìRUM -->
        <div class="quorum-column">
            <div class="form-section">
                <h4 class="tab-subtitle">C√≥mo se calcula el qu√≥rum</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Base para calcular el qu√≥rum</label>
                        {{ form.base_quorum }}
                        <div class="field-help">
                            <strong>Habilitados:</strong> usa a todos los que tienen derecho a voto.<br>
                            <strong>Presentes:</strong> usa s√≥lo a los que est√°n f√≠sicamente hoy.
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Tipo de qu√≥rum</label>
                        {{ form.tipo_quorum }}
                        <div class="field-help" id="tipo-quorum-ayuda">
                            <!-- Se rellena con texto gen√©rico por defecto -->
                            Si eliges <strong>Porcentaje</strong>, el valor se interpreta como %.
                            Si eliges <strong>Cantidad</strong>, el valor es n√∫mero de personas.
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Valor del qu√≥rum</label>
                        {{ form.valor_quorum }}
                        <div class="field-help" id="valor-quorum-ayuda">
                            Si el tipo es <strong>Porcentaje</strong>, escribe un n√∫mero entre 1 y 100
                            (por ejemplo: 50 = 50%).<br>
                            Si el tipo es <strong>Cantidad</strong>, escribe cu√°ntas personas como m√≠nimo
                            deben votar (por ejemplo: 80).
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Votos m√≠nimos requeridos</label>
                        {{ form.votos_minimos_requeridos }}
                        <div class="field-help">
                            Este valor se calcula autom√°ticamente al guardar, combinando la base,
                            el tipo y el valor de qu√≥rum. Indica cu√°ntos votos m√≠nimos se necesitan
                            para que la elecci√≥n sea v√°lida.
                        </div>
                    </div>
                </div>

                <div class="quorum-hint-box">
                    <strong>Ejemplo r√°pido:</strong><br>
                    Si tienes 100 miembros con derecho a voto, eliges base
                    <em>Habilitados</em>, tipo <em>Porcentaje</em> y valor <em>50</em>, el sistema
                    exigir√° al menos <strong>50 votos</strong> para validar la elecci√≥n.
                </div>
            </div>
        </div>
    </div>
</div>




                    <!-- ========== TAB: FECHAS Y OPCIONES ADICIONALES ========== -->
                    <div id="tab-fechas" class="votacion-tab-content" style="display:none;">
                        <h3 class="tab-title">Fechas y opciones adicionales</h3>
                        <p class="tab-description">
                            Define el periodo de la elecci√≥n y algunas opciones adicionales.
                        </p>

                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-field">
                                    <label>Fecha inicio</label>
                                    {{ form.fecha_inicio }}
                                </div>

                                <div class="form-field">
                                    <label>Fecha cierre</label>
                                    {{ form.fecha_fin }}
                                </div>

                                <div class="form-field">
                                    <label>{{ form.permite_empates }} Permitir empates</label>
                                </div>

                                <div class="form-field">
                                    <label>{{ form.permite_voto_remoto }} Permitir voto remoto</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- ========== TAB: VUELTAS ========== -->
                <div id="tab-vueltas" class="votacion-tab-content" style="display:none;">
                    <h3 class="tab-title">Vueltas de esta elecci√≥n</h3>
                    <p class="tab-description">
                        Cada vuelta representa una ronda de votaci√≥n. Puedes agregar nuevas vueltas seg√∫n las reglas definidas.
                    </p>

                    {% if es_nueva or not votacion %}
                        <p class="section-help">
                            Primero debes <strong>guardar la configuraci√≥n general</strong> de la votaci√≥n
                            usando el bot√≥n <strong>‚ÄúGuardar configuraci√≥n‚Äù</strong> de arriba para poder gestionar las vueltas.
                        </p>
                    {% else %}
                        <div class="form-actions" style="justify-content:flex-end; margin-bottom:10px;">
                            <form method="post" action="{% url 'votacion:agregar_ronda' votacion.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn-secondary">
                                    <span class="material-icons" style="font-size:18px;">add</span>
                                    Nueva vuelta
                                </button>
                            </form>
                        </div>

                        {% with votacion.rondas.all as rondas %}
                            {% if rondas %}
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Nombre</th>
                                            <th>Estado</th>
                                            <th>Votos</th>
                                            <th>Inicio</th>
                                            <th>Cierre</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ronda in rondas %}
                                        <tr>
                                            <td>{{ ronda.numero }}</td>
                                            <td>
                                                {% if ronda.numero == 1 %}
                                                    Primera vuelta
                                                {% elif ronda.numero == 2 %}
                                                    Segunda vuelta
                                                {% else %}
                                                    Vuelta {{ ronda.numero }}
                                                {% endif %}
                                                {% if ronda.nombre %} - {{ ronda.nombre }}{% endif %}
                                            </td>
                                            <td>
                                                {% if ronda.estado == "ABIERTA" %}
                                                    <span class="badge-soft badge-soft-success">Abierta</span>
                                                {% elif ronda.estado == "CERRADA" %}
                                                    <span class="badge-soft badge-soft-muted">Cerrada</span>
                                                {% else %}
                                                    <span class="badge-soft badge-soft-warning">Borrador</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ ronda.votos.count }}</td>
                                            <td>{{ ronda.fecha_inicio|default:"‚Äî" }}</td>
                                            <td>{{ ronda.fecha_fin|default:"‚Äî" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p class="section-help">A√∫n no hay vueltas registradas.</p>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>

                <!-- ========== TAB: CANDIDATOS ========== -->
                <div id="tab-candidatos" class="votacion-tab-content" style="display:none;">
                    <h3 class="tab-title">Candidatos</h3>
                    <p class="tab-description">
                        Selecciona los candidatos a partir de los miembros activos. Usa el c√≥digo interno (TF-XXXX).
                    </p>

                    {% if es_nueva or not votacion %}
                        <p class="section-help">
                            Primero debes <strong>guardar la configuraci√≥n general</strong> de la votaci√≥n
                            usando el bot√≥n <strong>‚ÄúGuardar configuraci√≥n‚Äù</strong> de arriba para poder agregar y gestionar candidatos.
                        </p>
                    {% else %}

                        <!-- LISTA DE CANDIDATOS -->
                        {% if candidatos %}
                            <h4 class="subsection-title">Listado actual</h4>
                            <p class="section-help">
                                Visualiza los candidatos ya asignados para esta elecci√≥n.
                            </p>

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in candidatos %}
                                    <tr>
                                        <td>
                                            {% if c.miembro.foto %}
                                                <img src="{{ c.miembro.foto.url }}" class="candidate-avatar candidate-avatar-lg">
                                            {% else %}
                                                <div class="candidate-avatar candidate-avatar-placeholder candidate-avatar-lg">
                                                    {{ c.nombre|first }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ c.miembro.codigo_miembro|default:"‚Äî" }}</td>
                                        <td><strong>{{ c.nombre }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="section-help">A√∫n no hay candidatos.</p>
                        {% endif %}

                        <!-- AGREGAR CANDIDATO -->
                        <h4 class="subsection-title" style="margin-top: 20px;">Agregar candidato por c√≥digo</h4>
                        <p class="section-help">Introduce solo el n√∫mero; el sistema a√±ade TF- autom√°ticamente.</p>

                        <form method="post" style="margin-top:8px;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="previsualizar_candidato">

                            <div class="form-grid">
                                <div class="form-field">
                                <div class="input-prefix-group">
                                    <span class="input-prefix">TF-</span>
                                    <input type="text"
                                        name="codigo_sufijo"
                                        id="codigo_sufijo"  
                                        placeholder="0001"
                                        inputmode="numeric"
                                        autocomplete="off">
                                </div>

                                    <div class="field-help">
                                        Escribe solo el n√∫mero correlativo. Ej.: 0001, 0123, 1045‚Ä¶
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions" style="padding-top:0;">
                                <button type="submit" class="btn-primary" style="max-width:260px; width:100%; justify-content:center;">
                                    <span class="material-icons" style="font-size:18px;">search</span>
                                    Buscar candidato
                                </button>
                            </div>
                        </form>

                        <!-- MODAL CONFIRMACI√ìN -->
                        {% if pre_candidato and codigo_pre_candidato %}
                        <div class="modal-backdrop">
                            <div class="modal-card">
                                <h3>Confirmar candidato</h3>
                                <p>
                                    ¬øDeseas agregar como candidato a:<br>
                                    <strong>{{ pre_candidato }}</strong><br>
                                    <small>C√≥digo: {{ codigo_pre_candidato }}</small>
                                </p>

                                <div class="modal-actions">
                                    <button type="button"
                                            class="btn-secondary"
                                            onclick="cerrarModalVotacion(this);">
                                        Cerrar
                                    </button>

                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="accion" value="agregar_candidato_confirmado">
                                        <input type="hidden" name="codigo_miembro" value="{{ codigo_pre_candidato }}">
                                        <button type="submit" class="btn-primary">
                                            <span class="material-icons" style="font-size:18px;">person_add</span>
                                            Confirmar y agregar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        {% elif candidato_error %}
                        <div class="modal-backdrop">
                            <div class="modal-card">
                                <h3>No se puede agregar este candidato</h3>
                                <p>{{ candidato_error }}</p>

                                <div class="modal-actions">
                                    <button type="button"
                                            class="btn-primary"
                                            onclick="cerrarModalVotacion(this);">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% endif %}
                </div>
            </div>

            <!-- ASIDE / AYUDA -->
            <aside class="votacion-aside">
                <div class="aside-card">
                    <h4>Consejos r√°pidos</h4>
                    <ul>
                        <li>Primero define <strong>nombre, tipo y regla</strong> en Configuraci√≥n general.</li>
                        <li>Luego ajusta el <strong>qu√≥rum y la asistencia</strong>.</li>
                        <li>Configura las <strong>fechas</strong> y opciones como empates o voto remoto.</li>
                        <li>Despu√©s de guardar, pasa a <strong>Vueltas</strong> y <strong>Candidatos</strong>.</li>
                    </ul>
                </div>

                <div class="aside-card">
                    <h4>Estado de la elecci√≥n</h4>
                    <p class="votacion-card-subtitle" style="margin-bottom:6px;">
                        Usa el estado <strong>Borrador</strong> mientras preparas todo.
                    </p>
                    <p class="votacion-card-subtitle">
                        Cuando todo est√© listo, cambia a <strong>Abierta</strong> para empezar la votaci√≥n.
                    </p>
                </div>
            </aside>
        </div>
    </div>
</section>

<script>
    // Mantener scroll
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    window.addEventListener("beforeunload", function () {
        localStorage.setItem("scrollPos", window.scrollY);
    });
    window.addEventListener("load", function () {
        const pos = localStorage.getItem("scrollPos");
        if (pos) window.scrollTo(0, parseInt(pos));
    });

    // Enfocar el campo de c√≥digo de candidato
    function focusCodigoCandidato() {
        const input = document.getElementById("codigo_sufijo");
        if (input) {
            input.focus();
            input.select(); // selecciona el contenido si hubiera algo
        }
    }

    // TABS
    function openVotacionTab(tabId, btn) {
        // Ocultar todas las tabs
        document.querySelectorAll('.votacion-tab-content').forEach(function (tab) {
            tab.style.display = 'none';
        });

        // Quitar active de todos los botones
        document.querySelectorAll('.votacion-tab-btn').forEach(function (b) {
            b.classList.remove('active');
        });

        // Mostrar tab seleccionada
        const target = document.getElementById(tabId);
        if (target) {
            target.style.display = 'block';
        }

        // Activar bot√≥n
        if (btn) {
            btn.classList.add('active');
        } else {
            // Si viene de ?tab=..., intenta buscar el bot√≥n por su onclick
            document.querySelectorAll('.votacion-tab-btn').forEach(function (b) {
                const onclick = b.getAttribute('onclick') || "";
                if (onclick.includes("'" + tabId + "'")) {
                    b.classList.add('active');
                }
            });
        }

        // Si es la pesta√±a de candidatos, enfocar el campo de c√≥digo
        if (tabId === 'tab-candidatos') {
            setTimeout(focusCodigoCandidato, 50);
        }
    }


    // Permitir abrir una pesta√±a espec√≠fica con ?tab=...
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const tabParam = params.get('tab');

        if (tabParam === 'vueltas') {
            openVotacionTab('tab-vueltas', null);
        } else if (tabParam === 'candidatos') {
            openVotacionTab('tab-candidatos', null);
        } else if (tabParam === 'quorum') {
            openVotacionTab('tab-quorum', null);
        } else if (tabParam === 'fechas') {
            openVotacionTab('tab-fechas', null);
        } 

        // üëá Nuevo: si NO hay ?tab en la URL, pero venimos de buscar candidato
        // (hay pre_candidato o candidato_error), forzamos la pesta√±a de candidatos.
        {% if pre_candidato or candidato_error %}
        if (!tabParam) {
            openVotacionTab('tab-candidatos', null);
        }
        {% endif %}
    });

// ===== ENTER en el modal =====
document.addEventListener("keydown", function (event) {
    // Solo si la tecla presionada es Enter
    if (event.key === "Enter") {
        const modal = document.querySelector(".modal-backdrop");

        // Si no hay modal abierto, no hacemos nada
        if (!modal) return;

        event.preventDefault(); // Evita recargar o enviar formularios por defecto

        // Prioridad 1: bot√≥n de confirmar
        const btnConfirmar = modal.querySelector("form button.btn-primary[type='submit']");
        if (btnConfirmar) {
            btnConfirmar.click();
            return;
        }

        // Prioridad 2: bot√≥n de cerrar (modal de error)
        const btnCerrar = modal.querySelector(".modal-actions .btn-primary, .modal-actions .btn-secondary");
        if (btnCerrar) {
            btnCerrar.click();
        }
    }
});

    // Cerrar modal candidatos
    function cerrarModalVotacion(button) {
        const backdrop = button.closest(".modal-backdrop");
        if (backdrop) {
            backdrop.remove();
        }
        // Volver a enfocar el campo de c√≥digo
        focusCodigoCandidato();
    }

</script>
<script>
    // ...todo lo que ya tienes arriba en el <script>...

    // ===== C√ÅLCULO PREVIO DEL QU√ìRUM EN EL NAVEGADOR =====
    function recalcularQuorumPreview() {
        const baseField = document.getElementById("id_base_quorum");
        const tipoField = document.getElementById("id_tipo_quorum");
        const valorField = document.getElementById("id_valor_quorum");
        const totalHabilitadosField = document.getElementById("id_total_habilitados");
        const presentesField = document.getElementById("id_miembros_presentes");
        const votosMinField = document.getElementById("id_votos_minimos_requeridos");

        if (!baseField || !tipoField || !valorField || !votosMinField) {
            return;
        }

        const base = baseField.value;
        const tipo = tipoField.value;
        const valor = parseFloat((valorField.value || "").replace(",", "."));

        let baseNumero = 0;

        if (base === "HABILITADOS" && totalHabilitadosField) {
            baseNumero = parseInt(totalHabilitadosField.value || "0", 10);
        } else if (base === "PRESENTES" && presentesField) {
            baseNumero = parseInt(presentesField.value || "0", 10);
        }

        if (!tipo || tipo === "NINGUNO" || isNaN(valor) || baseNumero <= 0) {
            votosMinField.value = "";
            return;
        }

        let resultado = 0;

        if (tipo === "PORCENTAJE") {
            const porcentaje = Math.max(0, Math.min(valor, 100));
            resultado = Math.ceil(baseNumero * (porcentaje / 100));
        } else if (tipo === "CANTIDAD") {
            resultado = Math.max(0, Math.floor(valor));
        }

        votosMinField.value = resultado;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const ids = [
            "id_base_quorum",
            "id_tipo_quorum",
            "id_valor_quorum",
            "id_total_habilitados",
            "id_miembros_presentes"
        ];

        ids.forEach(function (id) {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener("change", recalcularQuorumPreview);
                el.addEventListener("keyup", recalcularQuorumPreview);
            }
        });

        // Calcula una primera vez al cargar la p√°gina
        recalcularQuorumPreview();
    });
</script>


<!-- ===========================
     ESTILOS LOCALES
=========================== -->
<style>
    .votacion-config-wrapper {
        margin-top: 10px;
    }

    .votacion-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 18px 18px 20px;
        box-shadow: 0 10px 25px rgba(15,23,42,0.08);
        border: 1px solid #e5e7eb;
    }

    .votacion-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .votacion-card-header h2 {
        margin: 0;
        font-size: 18px;
        color: #111827;
    }

    .votacion-card-subtitle {
        margin: 4px 0 0;
        font-size: 12px;
        color: #6b7280;
    }

    .votacion-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
        white-space: nowrap;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
    }

    .votacion-tabs-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        background: #f3f4f6;
        padding: 6px;
        border-radius: 999px;
        margin-bottom: 16px;
    }

    .votacion-tab-btn {
        border: none;
        background: transparent;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        color: #4b5563;
        display: inline-flex;
        align-items: center;
    }

    .votacion-tab-btn.active {
        background: #ffffff;
        color: #111827;
        box-shadow: 0 2px 6px rgba(15,23,42,0.12);
    }

    .votacion-layout {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(220px, 1.2fr);
        gap: 18px;
        align-items: flex-start;
    }

    .votacion-main {
        min-width: 0;
    }

    .votacion-aside {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .aside-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 10px;
        font-size: 12px;
        color: #4b5563;
    }

    .aside-card h4 {
        margin: 0 0 6px;
        font-size: 13px;
        color: #111827;
    }

    .aside-card ul {
        padding-left: 18px;
        margin: 0;
    }

    .aside-card ul li {
        margin-bottom: 4px;
    }

    .tab-title {
        margin: 0 0 4px;
        font-size: 15px;
        color: #111827;
    }

    .tab-description {
        margin: 0 0 12px;
        font-size: 12px;
        color: #6b7280;
    }

    .tab-subtitle {
        margin: 0 0 6px;
        font-size: 13px;
        color: #111827;
    }

    .form-section {
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #e5e7eb;
    }

    .form-section:last-of-type {
        border-bottom: none;
    }

    .section-help {
        font-size: 13px;
        color: var(--color-text-muted, #6b7280);
    }

    .field-help {
        font-size: 12px;
        color: var(--color-text-muted, #6b7280);
        margin-top: 2px;
    }

    /* Barra superior de guardar */
    .form-actions-top {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 12px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
    }

    .form-actions-main {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-actions-help {
        font-size: 12px;
        color: #6b7280;
        margin: 0;
    }

    /* Prefijo c√≥digo TF- */
    .input-prefix-group {
        display: flex;
        align-items: stretch;
        max-width: 260px;
    }
    .input-prefix {
        padding: 0.45rem 0.75rem;
        border: 1px solid var(--border, #d1d5db);
        border-right: none;
        border-radius: var(--radius-lg, 12px) 0 0 var(--radius-lg, 12px);
        background: #f9fafb;
        color: var(--text-muted, #6b7280);
    }
    .input-prefix-group input {
        border-left: none;
    }

    /* Modales */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.35);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }
    .modal-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        max-width: 420px;
        width: 100%;
        box-shadow: 0 18px 45px rgba(15,23,42,0.25);
    }
    .modal-actions {
        margin-top: 15px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    /* Avatar candidatos */
    .candidate-avatar {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        object-fit: cover;
        border: 1px solid var(--border, #e5e7eb);
    }
    .candidate-avatar-lg {
        width: 50px;
        height: 50px;
    }
    .candidate-avatar-placeholder {
        background: #f9fafb;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        color: var(--text-muted, #6b7280);
    }

    /* Bot√≥n info sistemas */
    .info-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(25, 135, 84, 0.12);
        color: var(--primary, #198754);
        font-size: 12px;
        font-weight: 700;
        text-decoration: none;
        cursor: pointer;
        transition: 0.2s ease;
    }
    .info-badge:hover {
        background: var(--primary, #198754);
        color: #ffffff;
    }

    .subsection-title {
        margin: 0 0 4px;
        font-size: 14px;
        font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .votacion-layout {
            grid-template-columns: 1fr;
        }

        .votacion-aside {
            flex-direction: column-reverse;
        }

        .votacion-tabs-bar {
            border-radius: 12px;
        }

        .votacion-card-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .form-actions-top {
            flex-direction: column;
            align-items: stretch;
        }
    }
        .quorum-summary-card {
        margin-bottom: 14px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
    }

    .quorum-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .quorum-summary-title {
        font-size: 12px;
        font-weight: 600;
        color: #111827;
    }

    .quorum-summary-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
        white-space: nowrap;
    }

    .quorum-summary-value {
        font-size: 22px;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
    }

    .quorum-summary-help {
        margin: 4px 0 0;
        font-size: 11px;
        color: #6b7280;
    }

</style>

{% endblock %}
