{% extends "core/base.html" %}

{% block title %}{{ titulo }} · Soid_Tf_2{% endblock %}

{% block content %}

<!-- ===========================
     ENCABEZADO
=========================== -->
<div class="page-header">
    <div>
        <h1 class="page-title">{{ titulo }}</h1>
        <p class="page-subtitle">
            Configura el tipo de elección, las reglas, las vueltas y los candidatos.
        </p>
    </div>

    <div class="page-header-actions">
        {% if not es_nueva and votacion %}
            <!-- Duplicar -->
            <form method="post"
                  action="{% url 'votacion:duplicar_votacion' votacion.pk %}"
                  style="display:inline-block; margin-right: 8px;">
                {% csrf_token %}
                <button type="submit" class="btn-secondary">
                    <span class="material-icons" style="font-size: 18px;">content_copy</span>
                    Duplicar
                </button>
            </form>

            <!-- Eliminar -->
            <form method="post"
                  action="{% url 'votacion:eliminar_votacion' votacion.pk %}"
                  onsubmit="return confirm('¿Seguro que deseas eliminar esta elección?')"
                  style="display:inline-block; margin-right: 8px;">
                {% csrf_token %}
                <button type="submit" class="btn-danger">
                    <span class="material-icons" style="font-size: 18px;">delete</span>
                    Eliminar
                </button>
            </form>
        {% endif %}

        <!-- Volver -->
        <a href="{% url 'votacion:lista_votaciones' %}" class="btn-secondary">
            <span class="material-icons" style="font-size: 18px;">arrow_back</span>
            Volver
        </a>
    </div>
</div>

<div class="page-section">

<!-- ===========================
     MENSAJES
=========================== -->
{% if messages %}
    <div class="messages-container">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
{% endif %}

<!-- ===========================
     1) CONFIGURACIÓN GENERAL
=========================== -->
<h2>Configuración general</h2>
<p class="section-help">
    Define el nombre de la elección, su tipo, estado, quórum y otros parámetros.
</p>

<form method="post" novalidate>
    {% csrf_token %}

    <div class="form-grid">

        <div class="form-field form-field-full">
            <label>Nombre de la elección</label>
            {{ form.nombre }}
        </div>

        <div class="form-field form-field-full">
            <label>Descripción</label>
            {{ form.descripcion }}
        </div>

        <div class="form-field">
            <label>Tipo</label>
            {{ form.tipo }}
        </div>

        <div class="form-field">
            <label>Estado</label>
            {{ form.estado }}
            <div class="field-help">Borrador · Abierta · Cerrada</div>
        </div>

        <div class="form-field">
            <label for="id_regla_ganador" style="display:flex; align-items:center; gap:6px;">
                Regla de votación
                <a href="{% url 'votacion:documentacion_sistemas_votacion' %}"
                   class="info-badge"
                   target="_blank"
                   title="Ver explicación de los sistemas de votación">
                    ⓘ
                </a>
            </label>
            {{ form.regla_ganador }}
        </div>

        <div class="form-field">
            <label>Número de cargos</label>
            {{ form.numero_cargos }}
            <div class="field-help">Ej.: 3 diáconos, 2 líderes…</div>
        </div>

        {% if form.edad_minima_candidato %}
        <div class="form-field">
            <label>Edad mínima del candidato</label>
            {{ form.edad_minima_candidato }}
            <div class="field-help">Ej.: 18 años</div>
        </div>
        {% endif %}

        <!-- Bloque de quórum y asistencia -->
        <div class="form-field">
            <label>Miembros con derecho a voto (automático)</label>
            {{ form.total_habilitados }}
            <div class="field-help">
                Miembros activos que cumplen la edad mínima para votar.
            </div>
        </div>

        <div class="form-field">
            <label>Miembros presentes (contados físicamente)</label>
            {{ form.miembros_presentes }}
            <div class="field-help">
                Número de miembros habilitados que están presentes en el local.
            </div>
        </div>

        <div class="form-field">
            <label>Tipo de quórum</label>
            {{ form.tipo_quorum }}
        </div>

        <div class="form-field">
            <label>Valor de quórum</label>
            {{ form.valor_quorum }}
            <div class="field-help">
                Si es porcentaje, escribe un valor como 50 o 60. Si es cantidad fija, escribe el número de personas.
            </div>
        </div>

        <div class="form-field">
            <label>Votos mínimos requeridos</label>
            {{ form.votos_minimos_requeridos }}
            <div class="field-help">
                Se calculará automáticamente en base a los presentes y al tipo de quórum.
            </div>
        </div>

        <div class="form-field">
            <label>Fecha inicio</label>
            {{ form.fecha_inicio }}
        </div>

        <div class="form-field">
            <label>Fecha cierre</label>
            {{ form.fecha_fin }}
        </div>

        <div class="form-field">
            <label>{{ form.permite_empates }} Permitir empates</label>
        </div>

        <div class="form-field">
            <label>{{ form.permite_voto_remoto }} Permitir voto remoto</label>
        </div>

        <div class="form-field form-field-full">
            <label>Observaciones internas</label>
            {{ form.observaciones_internas }}
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" name="accion" value="guardar_votacion" class="btn-primary">
            <span class="material-icons" style="font-size: 18px;">save</span>
            Guardar
        </button>
    </div>
</form>

<!-- ===========================
     PROCESO SOLO SI YA EXISTE
=========================== -->
{% if not es_nueva and votacion %}

<hr>

<!-- ===========================
     2.1) VUELTAS
=========================== -->
<h2>Vueltas de esta elección</h2>
<p class="section-help">
    Cada vuelta representa una ronda de votación.
</p>

<div class="form-actions" style="justify-content:flex-end; margin-bottom:10px;">
    <form method="post" action="{% url 'votacion:agregar_ronda' votacion.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn-secondary">
            <span class="material-icons" style="font-size:18px;">add</span>
            Nueva vuelta
        </button>
    </form>
</div>

{% with votacion.rondas.all as rondas %}
{% if rondas %}
<table class="table">
    <thead>
        <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Votos</th>
            <th>Inicio</th>
            <th>Cierre</th>
        </tr>
    </thead>
    <tbody>
        {% for ronda in rondas %}
        <tr>
            <td>{{ ronda.numero }}</td>
            <td>
                {% if ronda.numero == 1 %}
                    Primera vuelta
                {% elif ronda.numero == 2 %}
                    Segunda vuelta
                {% else %}
                    Vuelta {{ ronda.numero }}
                {% endif %}
                {% if ronda.nombre %} - {{ ronda.nombre }}{% endif %}
            </td>
            <td>
                {% if ronda.estado == "ABIERTA" %}
                    <span class="badge-soft badge-soft-success">Abierta</span>
                {% elif ronda.estado == "CERRADA" %}
                    <span class="badge-soft badge-soft-muted">Cerrada</span>
                {% else %}
                    <span class="badge-soft badge-soft-warning">Borrador</span>
                {% endif %}
            </td>
            <td>{{ ronda.votos.count }}</td>
            <td>{{ ronda.fecha_inicio|default:"—" }}</td>
            <td>{{ ronda.fecha_fin|default:"—" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="section-help">Aún no hay vueltas registradas.</p>
{% endif %}
{% endwith %}

<hr>

<!-- ===========================
     2.2) CANDIDATOS
=========================== -->
<h2 id="candidatos">Candidatos</h2>
<p class="section-help">
    Selecciona los candidatos a partir de los miembros activos.
</p>

<!-- LISTA DE CANDIDATOS -->
{% if candidatos %}
<table class="table">
    <thead>
        <tr>
            <th>Foto</th>
            <th>Código</th>
            <th>Nombre</th>
        </tr>
    </thead>
    <tbody>
        {% for c in candidatos %}
        <tr>
            <td>
                {% if c.miembro.foto %}
                    <img src="{{ c.miembro.foto.url }}" class="candidate-avatar">
                {% else %}
                    <div class="candidate-avatar candidate-avatar-placeholder">
                        {{ c.nombre|first }}
                    </div>
                {% endif %}
            </td>
            <td>{{ c.miembro.codigo_miembro|default:"—" }}</td>
            <td>{{ c.nombre }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="section-help">Aún no hay candidatos.</p>
{% endif %}

<!-- AGREGAR CANDIDATO -->
<h3>Agregar candidato por código</h3>
<p class="section-help">Introduce solo el número; el sistema añade TF- automáticamente.</p>

<form method="post" style="margin-top:8px;">
    {% csrf_token %}
    <input type="hidden" name="accion" value="previsualizar_candidato">

    <div class="form-grid">
        <div class="form-field">
            <label>Código de miembro</label>
            <div class="input-prefix-group">
                <span class="input-prefix">TF-</span>
                <input type="text" name="codigo_sufijo" placeholder="0001" inputmode="numeric">
            </div>
        </div>
    </div>

    <div class="form-actions" style="padding-top:0;">
        <button type="submit" class="btn-primary">
            <span class="material-icons" style="font-size:18px;">search</span>
            Buscar candidato
        </button>
    </div>
</form>

<!-- MODAL CONFIRMACIÓN -->
{% if pre_candidato and codigo_pre_candidato %}
<div class="modal-backdrop">
    <div class="modal-card">
        <h3>Confirmar candidato</h3>
        <p>
            ¿Deseas agregar como candidato a:<br>
            <strong>{{ pre_candidato }}</strong><br>
            <small>Código: {{ codigo_pre_candidato }}</small>
        </p>

        <div class="modal-actions">
            <button class="btn-secondary" onclick="this.closest('.modal-backdrop').remove();">
                Cerrar
            </button>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="accion" value="agregar_candidato_confirmado">
                <input type="hidden" name="codigo_miembro" value="{{ codigo_pre_candidato }}">
                <button type="submit" class="btn-primary">
                    <span class="material-icons" style="font-size:18px;">person_add</span>
                    Confirmar y agregar
                </button>
            </form>
        </div>
    </div>
</div>

{% elif candidato_error %}
<div class="modal-backdrop">
    <div class="modal-card">
        <h3>No se puede agregar este candidato</h3>
        <p>{{ candidato_error }}</p>

        <div class="modal-actions">
            <button class="btn-primary" onclick="this.closest('.modal-backdrop').remove();">
                Cerrar
            </button>
        </div>
    </div>
</div>
{% endif %}

{% endif %}

</div>

<script>
    // Evita que la página suba arriba al presionar ENTER dentro de un formulario
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }

    // Mantiene la posición al recargar después del POST
    window.addEventListener("beforeunload", function () {
        localStorage.setItem("scrollPos", window.scrollY);
    });

    window.addEventListener("load", function () {
        const pos = localStorage.getItem("scrollPos");
        if (pos) window.scrollTo(0, parseInt(pos));
    });
</script>

<!-- ===========================
     ESTILOS LOCALES
=========================== -->
<style>
.section-help {
    font-size: 13px;
    color: var(--color-text-muted);
}

.field-help {
    font-size: 12px;
    color: var(--color-text-muted);
    margin-top: 2px;
}

/* Prefijo */
.input-prefix-group {
    display: flex;
    align-items: stretch;
    max-width: 260px;
}
.input-prefix {
    padding: 0.45rem 0.75rem;
    border: 1px solid var(--border);
    border-right: none;
    border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    background: #f9fafb;
    color: var(--text-muted);
}
.input-prefix-group input {
    border-left: none;
}

/* Modales */
.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.35);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}
.modal-card {
    background: #fff;
    border-radius: var(--radius-lg);
    padding: 20px;
    max-width: 420px;
    width: 100%;
}
.modal-actions {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* Avatar */
.candidate-avatar {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid var(--border);
}
.candidate-avatar-placeholder {
    background: #f9fafb;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 600;
    color: var(--text-muted);
}

/* Botón de info de sistemas */
.info-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: rgba(25, 135, 84, 0.12);
    color: var(--primary, #198754);
    font-size: 12px;
    font-weight: 700;
    text-decoration: none;
    cursor: pointer;
    transition: 0.2s ease;
}
.info-badge:hover {
    background: var(--primary, #198754);
    color: #ffffff;
}
</style>

{% endblock %}
