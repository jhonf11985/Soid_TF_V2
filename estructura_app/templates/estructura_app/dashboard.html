{% extends 'estructura_app/base_estructura.html' %}


{% block title %}Dashboard · Estructura{% endblock %}

{% block estructura_content %}
<!-- ══════════════════════════════════════════════════════════════════════════
     BARRA DE CONTROL SUPERIOR (Estilo Odoo)
     ══════════════════════════════════════════════════════════════════════════ -->
<div class="odoo-control-bar">
    <div class="odoo-control-left">
        <a href="/admin/estructura_app/unidad/add/" class="odoo-btn odoo-btn-primary">
            <span class="material-icons">add</span>
            Nueva unidad
        </a>

        
    </div>

</div>

<!-- ══════════════════════════════════════════════════════════════════════════
     CONTENIDO DEL DASHBOARD
     ══════════════════════════════════════════════════════════════════════════ -->
<div class="odoo-dashboard">

    <!-- KPIs -->
    <div class="odoo-kpi-row">
        <div class="odoo-kpi-card">
            <div class="odoo-kpi-icon" style="background: #e0f2fe; color: #0284c7;">
                <span class="material-icons">account_tree</span>
            </div>
            <div class="odoo-kpi-content">
                <div class="odoo-kpi-value">{{ total_unidades|default:"0" }}</div>
                <div class="odoo-kpi-label">Unidades registradas</div>
                <div class="odoo-kpi-sub">Ministerios, grupos, equipos, etc.</div>
            </div>
        </div>
<div class="odoo-kpi-card">
    <div class="odoo-kpi-icon" style="background: #fee2e2; color: #b91c1c;">
        <span class="material-icons">person_off</span>
    </div>
    <div class="odoo-kpi-content">
        <div class="odoo-kpi-value">{{ miembros_no_sirviendo|default:"0" }}</div>
        <div class="odoo-kpi-label">Miembros no sirviendo</div>
        <div class="odoo-kpi-sub">
            {{ porcentaje_no_sirviendo|default:"0" }}% ·
            {{ miembros_no_sirviendo|default:"0" }}/{{ total_miembros_oficiales|default:"0" }} oficiales
        </div>
    </div>
</div>

<div class="odoo-kpi-card">
    <div class="odoo-kpi-icon" style="background:#ecfeff;color:#0891b2;">
        <span class="material-icons">handyman</span>
    </div>
    <div class="odoo-kpi-content">
        <div class="odoo-kpi-value">
            {{ miembros_sirviendo }}
        </div>
        <div class="odoo-kpi-label">
            Miembros sirviendo
        </div>
        <div class="odoo-kpi-sub">
            {{ porcentaje_sirviendo }}% ·
            {{ miembros_sirviendo }}/{{ total_miembros_oficiales }} oficiales
        </div>
    </div>
</div>

<div class="odoo-kpi-card">
    <div class="odoo-kpi-icon" style="background:#ede9fe;color:#6d28d9;">
        <span class="material-icons">military_tech</span>
    </div>
    <div class="odoo-kpi-content">
        <div class="odoo-kpi-value">{{ lideres_vigentes|default:"0" }}</div>
        <div class="odoo-kpi-label">Líderes vigentes</div>
        <div class="odoo-kpi-sub">
            {{ porcentaje_lideres|default:"0" }}% ·
            {{ lideres_vigentes|default:"0" }}/{{ total_miembros_oficiales|default:"0" }} oficiales
        </div>
    </div>
</div>

    </div>

    <!-- GRID -->
    <div class="odoo-dashboard-grid">

        <!-- Columna izquierda -->
        <div class="odoo-dashboard-column">

            <!-- Estado general -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Estado general</h2>
                    <span class="odoo-panel-badge">{{ unidades_activas|default:"0" }} activas</span>
                </div>

                <div class="odoo-alerts-grid">
                    <div class="odoo-alert-item" style="background:#ecfdf5;">
                        <span class="material-icons" style="color:#059669;">check_circle</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value" style="color:#065f46;">{{ unidades_activas|default:"0" }}</div>
                            <div class="odoo-alert-label" style="color:#065f46;">Unidades activas</div>
                        </div>
                    </div>

                    <div class="odoo-alert-item" style="background:#f3f4f6;">
                        <span class="material-icons" style="color:#6b7280;">pause_circle</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value" style="color:#374151;">{{ unidades_inactivas|default:"0" }}</div>
                            <div class="odoo-alert-label" style="color:#374151;">Unidades inactivas</div>
                        </div>
                    </div>

                    <div class="odoo-alert-item">
                        <span class="material-icons">warning_amber</span>
                        <div class="odoo-alert-info">
                            <div class="odoo-alert-value">{{ unidades_sin_lider|default:"0" }}</div>
                            <div class="odoo-alert-label">Sin líder</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribución por tipo - GRÁFICO MEJORADO -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Distribución por tipo</h2>
                    <span class="odoo-panel-badge">{{ total_unidades|default:"0" }} total</span>
                </div>

                {% if distribucion_por_tipo %}
                <div class="chart-distribution">
                    <!-- Gráfico de dona -->
                    <div class="donut-chart-container">
                        <svg class="donut-chart" viewBox="0 0 160 160">
                            {% with total=total_unidades|default:1 %}
                            {% for t in distribucion_por_tipo %}
                                {% widthratio t.total total 100 as pct %}
                                <circle class="donut-segment" 
                                        data-value="{{ t.total }}" 
                                        data-name="{{ t.nombre }}"
                                        data-index="{{ forloop.counter0 }}"></circle>
                            {% endfor %}
                            {% endwith %}
                            <!-- Centro con total -->
                            <circle cx="80" cy="80" r="45" fill="#fff"/>
                            <text x="80" y="75" class="donut-total">{{ total_unidades|default:"0" }}</text>
                            <text x="80" y="92" class="donut-label">unidades</text>
                        </svg>
                    </div>
                    
                    <!-- Leyenda -->
                    <div class="chart-legend">
                        {% for t in distribucion_por_tipo %}
                            {% if total_unidades %}
                                {% widthratio t.total total_unidades 100 as pct %}
                            {% endif %}
                            <div class="legend-item">
                                <span class="legend-color" data-index="{{ forloop.counter0 }}"></span>
                                <span class="legend-name">{{ t.nombre }}</span>
                                <span class="legend-value">{{ t.total }}</span>
                                <span class="legend-pct">{% if total_unidades %}{{ pct }}{% else %}0{% endif %}%</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <p class="odoo-empty">No hay tipos configurados.</p>
                {% endif %}
            </div>

        </div>

        <!-- Columna derecha -->
        <div class="odoo-dashboard-column">

            <!-- Top unidades por miembros -->
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Unidades con más miembros</h2>
                    <span class="odoo-panel-sub">Miembros activos</span>
                </div>

                {% if top_unidades %}
                <ul class="odoo-recent-list">
                    {% for u in top_unidades %}
                    <li class="odoo-recent-item">
                        <div class="odoo-recent-avatar" style="background:#017e84;">
                            {{ u.nombre|slice:":1"|upper }}
                        </div>
                        <div class="odoo-recent-info">
                            <div class="odoo-recent-name">{{ u.nombre }}</div>
                            <div class="odoo-recent-sub">{{ u.tipo.nombre }} · {{ u.total_miembros }} miembros</div>
                        </div>
                        <span class="odoo-recent-badge odoo-badge-new">{{ u.total_miembros }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="odoo-empty">Aún no hay membresías registradas.</p>
                {% endif %}
            </div>

            <!-- Unidades sin líder (nuevo panel sugerido) -->
            {% if unidades_sin_lider_lista %}
            <div class="odoo-panel">
                <div class="odoo-panel-header">
                    <h2>Requieren atención</h2>
                    <span class="odoo-panel-badge" style="background:#fef2f2;color:#991b1b;">{{ unidades_sin_lider|default:"0" }} sin líder</span>
                </div>

                <ul class="odoo-recent-list">
                    {% for u in unidades_sin_lider_lista|slice:":5" %}
                    <li class="odoo-recent-item" style="background:#fef2f2;">
                        <div class="odoo-recent-avatar" style="background:#dc2626;">
                            <span class="material-icons" style="font-size:16px;">warning</span>
                        </div>
                        <div class="odoo-recent-info">
                            <a href="/admin/estructura_app/unidad/{{ u.id }}/change/" class="odoo-recent-name">{{ u.nombre }}</a>
                            <div class="odoo-recent-sub">{{ u.tipo.nombre }} · Sin líder asignado</div>
                        </div>
                        <a href="/admin/estructura_app/unidadcargo/add/?unidad={{ u.id }}" class="odoo-btn-mini">
                            <span class="material-icons">person_add</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
/* Copiado/ajustado del dashboard de miembros para mantener el MISMO look & feel */
.odoo-control-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:#f8f9fa;border-bottom:1px solid #dee2e6}
.odoo-control-left,.odoo-control-right{display:flex;align-items:center;gap:12px}
.odoo-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;font-size:13px;font-weight:500;border:none;border-radius:4px;cursor:pointer;text-decoration:none;transition:all .15s ease}
.odoo-btn .material-icons{font-size:18px}
.odoo-btn-primary{background:#017e84;color:#fff}
.odoo-btn-primary:hover{background:#016166}
.odoo-btn-secondary{background:#fff;color:#495057;border:1px solid #dee2e6}
.odoo-btn-secondary:hover{background:#e9ecef}

.odoo-breadcrumb{display:flex;align-items:center;gap:6px;padding:4px 10px;background:#fff;border:1px solid #dee2e6;border-radius:4px;font-size:13px}
.odoo-breadcrumb-title{font-weight:500;color:#495057}
.odoo-breadcrumb-icon{font-size:16px;color:#6c757d}

.odoo-dashboard{padding:16px;background:#f8f9fa;min-height:calc(100vh - 120px);display:flex;flex-direction:column;gap:16px}

.odoo-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.odoo-kpi-card{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px;display:flex;align-items:center;gap:16px}
.odoo-kpi-icon{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.odoo-kpi-icon .material-icons{font-size:24px}
.odoo-kpi-content{flex:1;min-width:0}
.odoo-kpi-value{font-size:28px;font-weight:700;color:#212529;line-height:1}
.odoo-kpi-label{font-size:13px;font-weight:500;color:#495057;margin-top:4px}
.odoo-kpi-sub{font-size:11px;color:#6c757d;margin-top:2px}

.odoo-dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.odoo-dashboard-column{display:flex;flex-direction:column;gap:16px}

.odoo-panel{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px}
.odoo-panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e9ecef}
.odoo-panel-header h2{font-size:14px;font-weight:600;color:#212529;margin:0}
.odoo-panel-badge{font-size:11px;background:#e9ecef;color:#495057;padding:2px 8px;border-radius:10px}
.odoo-panel-sub{font-size:11px;color:#6c757d}
.odoo-empty{font-size:13px;color:#6c757d;text-align:center;padding:20px}

/* ══════════════════════════════════════════════════════════════════════════
   GRÁFICO DE DISTRIBUCIÓN POR TIPO - DONA
   ══════════════════════════════════════════════════════════════════════════ */
.chart-distribution{
    display:flex;
    align-items:center;
    gap:24px;
}

.donut-chart-container{
    flex-shrink:0;
    width:160px;
    height:160px;
}

.donut-chart{
    width:100%;
    height:100%;
    transform:rotate(-90deg);
}

.donut-segment{
    fill:none;
    stroke-width:28;
    cx:80;
    cy:80;
    r:60;
    transition:stroke-dashoffset .3s ease, opacity .2s;
}

.donut-segment:hover{
    opacity:0.8;
    cursor:pointer;
}

.donut-total{
    font-size:28px;
    font-weight:700;
    fill:#212529;
    text-anchor:middle;
    transform:rotate(90deg);
    transform-origin:80px 80px;
}

.donut-label{
    font-size:11px;
    fill:#6c757d;
    text-anchor:middle;
    transform:rotate(90deg);
    transform-origin:80px 80px;
}

.chart-legend{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
}

.legend-item{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    background:#f8f9fa;
    border-radius:6px;
    transition:background .15s;
}

.legend-item:hover{
    background:#e9ecef;
}

.legend-color{
    width:12px;
    height:12px;
    border-radius:3px;
    flex-shrink:0;
}

.legend-name{
    flex:1;
    font-size:12px;
    color:#495057;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.legend-value{
    font-size:13px;
    font-weight:600;
    color:#212529;
    min-width:24px;
    text-align:right;
}

.legend-pct{
    font-size:11px;
    color:#6c757d;
    min-width:32px;
    text-align:right;
}

/* Colores para los segmentos y leyenda */
.donut-segment[data-index="0"], .legend-color[data-index="0"]{stroke:#017e84;background:#017e84}
.donut-segment[data-index="1"], .legend-color[data-index="1"]{stroke:#0ea5e9;background:#0ea5e9}
.donut-segment[data-index="2"], .legend-color[data-index="2"]{stroke:#8b5cf6;background:#8b5cf6}
.donut-segment[data-index="3"], .legend-color[data-index="3"]{stroke:#f59e0b;background:#f59e0b}
.donut-segment[data-index="4"], .legend-color[data-index="4"]{stroke:#ef4444;background:#ef4444}
.donut-segment[data-index="5"], .legend-color[data-index="5"]{stroke:#10b981;background:#10b981}
.donut-segment[data-index="6"], .legend-color[data-index="6"]{stroke:#ec4899;background:#ec4899}
.donut-segment[data-index="7"], .legend-color[data-index="7"]{stroke:#6366f1;background:#6366f1}

/* Botón mini para acciones */
.odoo-btn-mini{
    display:flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:32px;
    background:#fff;
    border:1px solid #dee2e6;
    border-radius:6px;
    color:#017e84;
    text-decoration:none;
    transition:all .15s;
}
.odoo-btn-mini:hover{
    background:#017e84;
    color:#fff;
    border-color:#017e84;
}
.odoo-btn-mini .material-icons{font-size:18px}

.odoo-alerts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.odoo-alert-item{display:flex;align-items:center;gap:10px;padding:12px;background:#fef2f2;border-radius:6px}
.odoo-alert-item .material-icons{font-size:20px;color:#dc2626}
.odoo-alert-value{font-size:18px;font-weight:700;color:#991b1b}
.odoo-alert-label{font-size:11px;color:#991b1b}

.odoo-recent-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
.odoo-recent-item{display:flex;align-items:center;gap:12px;padding:8px;background:#f8f9fa;border-radius:6px}
.odoo-recent-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:600;flex-shrink:0;overflow:hidden}
.odoo-recent-info{flex:1;min-width:0}
.odoo-recent-name{font-size:13px;font-weight:500;color:#212529;text-decoration:none;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.odoo-recent-sub{font-size:11px;color:#6c757d}
.odoo-recent-badge{font-size:10px;font-weight:500;padding:2px 8px;border-radius:10px;flex-shrink:0}
.odoo-badge-new{background:#d1fae5;color:#065f46}

/* ══════════════════════════════════════════════════════════════════════════
   OPTIMIZACIÓN MÓVIL - DISEÑO COMPACTO
   ══════════════════════════════════════════════════════════════════════════ */

@media (max-width:1200px){
    .odoo-kpi-row{grid-template-columns:repeat(2,1fr)}
}

@media (max-width:992px){
    .odoo-dashboard-grid{grid-template-columns:1fr}
    .odoo-alerts-grid{grid-template-columns:1fr}
}

@media (max-width:640px){
    /* Dashboard general */
    .odoo-dashboard{padding:12px;gap:12px}
    
    /* Control bar compacto */
    .odoo-control-bar{padding:8px 12px}
    .odoo-btn{padding:6px 10px;font-size:12px}
    .odoo-btn .material-icons{font-size:16px}
    
    /* KPIs compactos en grid 2x2 */
    .odoo-kpi-row{
        grid-template-columns:repeat(2,1fr);
        gap:8px
    }
    .odoo-kpi-card{
        padding:10px;
        gap:10px;
        flex-direction:row;
        align-items:center
    }
    .odoo-kpi-icon{
        width:36px;
        height:36px;
        border-radius:6px
    }
    .odoo-kpi-icon .material-icons{font-size:18px}
    .odoo-kpi-value{font-size:20px}
    .odoo-kpi-label{font-size:11px;margin-top:2px}
    .odoo-kpi-sub{display:none}
    
    /* Paneles compactos */
    .odoo-panel{padding:12px;border-radius:6px}
    .odoo-panel-header{
        margin-bottom:10px;
        padding-bottom:8px
    }
    .odoo-panel-header h2{font-size:13px}
    
    /* Alertas en columna compacta */
    .odoo-alerts-grid{
        grid-template-columns:1fr;
        gap:6px
    }
    .odoo-alert-item{
        padding:8px 10px;
        gap:8px
    }
    .odoo-alert-item .material-icons{font-size:18px}
    .odoo-alert-value{font-size:15px}
    .odoo-alert-label{font-size:10px}
    
    /* Gráfico de distribución móvil */
    .chart-distribution{
        flex-direction:column;
        gap:16px;
    }
    .donut-chart-container{
        width:140px;
        height:140px;
        margin:0 auto;
    }
    .donut-total{font-size:24px}
    .chart-legend{gap:6px}
    .legend-item{padding:5px 8px}
    .legend-name{font-size:11px}
    .legend-value{font-size:12px}
    .legend-pct{font-size:10px}
    
    /* Lista de unidades compacta */
    .odoo-recent-list{gap:6px}
    .odoo-recent-item{
        padding:6px 8px;
        gap:10px
    }
    .odoo-recent-avatar{
        width:32px;
        height:32px;
        font-size:12px
    }
    .odoo-recent-name{font-size:12px}
    .odoo-recent-sub{font-size:10px}
    .odoo-recent-badge{
        font-size:9px;
        padding:2px 6px
    }
    
    /* Empty states */
    .odoo-empty{padding:16px;font-size:12px}
}

/* Extra pequeño (iPhone SE, etc) */
@media (max-width:375px){
    .odoo-dashboard{padding:8px;gap:8px}
    
    .odoo-kpi-row{gap:6px}
    .odoo-kpi-card{padding:8px;gap:8px}
    .odoo-kpi-icon{width:32px;height:32px}
    .odoo-kpi-icon .material-icons{font-size:16px}
    .odoo-kpi-value{font-size:18px}
    .odoo-kpi-label{font-size:10px}
    
    .odoo-panel{padding:10px}
    .odoo-panel-header h2{font-size:12px}
    
    .donut-chart-container{width:120px;height:120px}
    .donut-total{font-size:20px}
    .legend-color{width:10px;height:10px}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const segments = document.querySelectorAll('.donut-segment');
    if (!segments.length) return;
    
    // Calcular total
    let total = 0;
    segments.forEach(seg => {
        total += parseInt(seg.dataset.value) || 0;
    });
    
    if (total === 0) return;
    
    // Circunferencia del círculo (2 * PI * r)
    const circumference = 2 * Math.PI * 60;
    let currentOffset = 0;
    
    segments.forEach((segment, index) => {
        const value = parseInt(segment.dataset.value) || 0;
        const percentage = value / total;
        const segmentLength = circumference * percentage;
        
        // Establecer el dash array y offset
        segment.style.strokeDasharray = `${segmentLength} ${circumference}`;
        segment.style.strokeDashoffset = -currentOffset;
        
        currentOffset += segmentLength;
        
        // Tooltip on hover
        segment.addEventListener('mouseenter', function() {
            const name = this.dataset.name;
            const val = this.dataset.value;
            const pct = Math.round((val / total) * 100);
            // Podrías añadir un tooltip aquí si lo deseas
        });
    });
});
</script>

{% endblock %}