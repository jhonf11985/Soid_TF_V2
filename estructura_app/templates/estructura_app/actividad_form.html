{% extends 'estructura_app/base_estructura.html' %}
{% load static %}

{% block title %}
    {% if actividad %}{{ actividad.titulo }}{% else %}Nueva actividad{% endif %} · {{ unidad.nombre }}
{% endblock %}

{% block estructura_content %}

<form method="post" class="activity-form" id="activityForm">
    {% csrf_token %}

    <!-- ══════════════════════════════════════════════════════════════════
         HEADER COMPACTO
         ══════════════════════════════════════════════════════════════════ -->
    <header class="form-header">
        <a href="{% url 'estructura_app:unidad_actividades' unidad.pk %}" class="back-link">
            <span class="material-icons">arrow_back</span>
            <span>{{ unidad.nombre }}</span>
        </a>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">
                <span class="material-icons">check</span>
                <span>Guardar</span>
            </button>
        </div>
    </header>

    <!-- ══════════════════════════════════════════════════════════════════
         TOGGLE MODO RÁPIDO
         ══════════════════════════════════════════════════════════════════ -->
    <div class="quick-mode-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="quickMode" checked>
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Registro rápido</span>
        <span class="toggle-hint">Solo lo esencial</span>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════
         CONTENIDO PRINCIPAL
         ══════════════════════════════════════════════════════════════════ -->
    <div class="form-content">

        <!-- ═══════════════════════════════════════════════════════════════
             SECCIÓN: INFORMACIÓN BÁSICA (siempre visible)
             ═══════════════════════════════════════════════════════════════ -->
        <section class="form-section section-main">
            
            <!-- Tipo de actividad - Pills compactos -->
            <div class="type-selector">
                {% for value, label in form.tipo.field.choices %}
                    {% if value %}
                    <label class="type-pill" data-type="{{ value|lower }}">
                        <input type="radio" name="tipo" value="{{ value }}"
                            {% if form.tipo.value|stringformat:"s" == value|stringformat:"s" %}checked{% endif %}>
                        <span class="pill-icon material-icons">
                            {% if value|lower == 'reunion' %}groups
                            {% elif value|lower == 'culto' %}church
                            {% elif value|lower == 'evangelismo' %}campaign
                            {% elif value|lower == 'capacitacion' %}school
                            {% elif value|lower == 'servicio' %}volunteer_activism
                            {% else %}event{% endif %}
                        </span>
                        <span class="pill-label">{{ label }}</span>
                    </label>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Título -->
            <div class="field-group field-title">
                <input type="text"
                       name="titulo"
                       id="{{ form.titulo.id_for_label }}"
                       value="{{ form.titulo.value|default:'' }}"
                       placeholder="¿Qué actividad es?"
                       class="input-title"
                       required
                       autocomplete="off">
            </div>

            <!-- Fecha y Lugar en línea -->
            <div class="field-row">
                <div class="field-group field-date">
                    <span class="field-icon material-icons">event</span>
                    <input type="date"
                           name="fecha"
                           id="{{ form.fecha.id_for_label }}"
                           value="{{ form.fecha.value|default:'' }}"
                           required>
                </div>
                
                <div class="field-group field-location" data-optional>
                    <span class="field-icon material-icons">location_on</span>
                    <input type="text"
                           name="lugar"
                           id="{{ form.lugar.id_for_label }}"
                           value="{{ form.lugar.value|default:'' }}"
                           placeholder="Lugar (opcional)">
                </div>
            </div>

        </section>

        <!-- ═══════════════════════════════════════════════════════════════
             SECCIÓN: PARTICIPANTES (accordion expandido por defecto)
             ═══════════════════════════════════════════════════════════════ -->
        <section class="form-section accordion-section" data-accordion="participantes">
            <button type="button" class="accordion-header" aria-expanded="true">
                <div class="accordion-title">
                    <span class="material-icons accordion-icon">groups</span>
                    <span>Participantes</span>
                    <span class="accordion-badge" id="participantCount">0</span>
                </div>
                <span class="material-icons accordion-arrow">expand_more</span>
            </button>
            
            <div class="accordion-content expanded">
                <!-- Toolbar: Búsqueda + QR -->
                <div class="participants-toolbar">
                    <div class="participants-search">
                        <span class="material-icons">search</span>
                        <input type="text" 
                               id="searchParticipants" 
                               placeholder="Buscar miembro..."
                               autocomplete="off">
                    </div>
                    
                    <div class="toolbar-actions">
                        <button type="button" class="btn-qr" id="btnScanQR">
                            <span class="material-icons">qr_code_scanner</span>
                            <span class="btn-qr-label">Escanear</span>
                        </button>
                        <button type="button" class="btn-icon" id="selectAll" title="Seleccionar todos">
                            <span class="material-icons">check_box</span>
                        </button>
                        <button type="button" class="btn-icon" id="selectNone" title="Quitar todos">
                            <span class="material-icons">check_box_outline_blank</span>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Scanner QR -->
                <div class="qr-modal" id="qrModal">
                    <div class="qr-modal-content">
                        <div class="qr-modal-header">
                            <h3>
                                <span class="material-icons">qr_code_scanner</span>
                                Escanear asistencia
                            </h3>
                            <button type="button" class="btn-close" id="btnCloseQR">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        
                        <div class="qr-scanner-container">
                            <video id="qrVideo" playsinline autoplay muted></video>
                            <div class="qr-overlay">
                                <div class="qr-frame"></div>
                            </div>
                        </div>
                        
                        <div class="qr-scanned-list" id="scannedList">
                            <div class="scanned-header">
                                <span class="material-icons">people</span>
                                <span>Escaneados: <strong id="scannedCount">0</strong></span>
                            </div>
                            <div class="scanned-items" id="scannedItems"></div>
                        </div>
                        
                        <div class="qr-modal-footer">
                            <button type="button" class="btn-secondary" id="btnDoneQR">
                                <span class="material-icons">check</span>
                                Listo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chips de seleccionados -->
                <div class="selected-chips" id="selectedChips">
                    <div class="empty-chips" id="emptyChips">
                        <span class="material-icons">touch_app</span>
                        <span>Toca para seleccionar</span>
                    </div>
                </div>

                <!-- Grid de disponibles -->
                <div class="participants-grid" id="participantsGrid">
                    {{ form.participantes }}
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════
             SECCIÓN: RESPONSABLE (accordion colapsado, opcional)
             ═══════════════════════════════════════════════════════════════ -->
        <section class="form-section accordion-section optional-section" data-accordion="responsable">
            <button type="button" class="accordion-header" aria-expanded="false">
                <div class="accordion-title">
                    <span class="material-icons accordion-icon">person</span>
                    <span>Responsable</span>
                    <span class="accordion-value" id="responsableValue">Sin asignar</span>
                </div>
                <span class="material-icons accordion-arrow">expand_more</span>
            </button>
            
            <div class="accordion-content">
                <div class="field-group">
                    <select name="responsable" id="{{ form.responsable.id_for_label }}" class="input-select">
                        <option value="">Sin responsable asignado</option>
                        {% for value, label in form.responsable.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" {% if form.responsable.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════
             SECCIÓN: IMPACTO (accordion colapsado, opcional)
             ═══════════════════════════════════════════════════════════════ -->
        <section class="form-section accordion-section optional-section" data-accordion="impacto">
            <button type="button" class="accordion-header" aria-expanded="false">
                <div class="accordion-title">
                    <span class="material-icons accordion-icon">insights</span>
                    <span>Métricas de impacto</span>
                </div>
                <span class="material-icons accordion-arrow">expand_more</span>
            </button>
            
            <div class="accordion-content">
                <div class="impact-fields">
                    <div class="field-group field-number">
                        <label>Oyentes / Invitados</label>
                        <input type="number"
                               name="oyentes"
                               value="{{ form.oyentes.value|default:0 }}"
                               min="0">
                    </div>
                    
                    <div class="field-group field-number">
                        <label>Nuevos creyentes</label>
                        <input type="number"
                               name="nuevos_creyentes"
                               value="{{ form.nuevos_creyentes.value|default:0 }}"
                               min="0">
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Observaciones</label>
                    <textarea name="observaciones_impacto"
                              rows="2"
                              placeholder="Algo destacable de la actividad...">{{ form.observaciones_impacto.value|default:'' }}</textarea>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════
             SECCIÓN: NOTAS (accordion colapsado, opcional)
             ═══════════════════════════════════════════════════════════════ -->
        <section class="form-section accordion-section optional-section" data-accordion="notas">
            <button type="button" class="accordion-header" aria-expanded="false">
                <div class="accordion-title">
                    <span class="material-icons accordion-icon">notes</span>
                    <span>Notas adicionales</span>
                </div>
                <span class="material-icons accordion-arrow">expand_more</span>
            </button>
            
            <div class="accordion-content">
                <div class="field-group">
                    <textarea name="notas"
                              id="{{ form.notas.id_for_label }}"
                              rows="3"
                              placeholder="Notas internas, recordatorios, etc...">{{ form.notas.value|default:'' }}</textarea>
                </div>
            </div>
        </section>

    </div>

    <!-- ══════════════════════════════════════════════════════════════════
         FOOTER FIJO (móvil)
         ══════════════════════════════════════════════════════════════════ -->
    <footer class="form-footer">
        <a href="{% url 'estructura_app:unidad_actividades' unidad.pk %}" class="btn-secondary">
            Cancelar
        </a>
        <button type="submit" class="btn-primary">
            <span class="material-icons">check</span>
            Guardar
        </button>
    </footer>

</form>

<!-- ══════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════ -->
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   VARIABLES - Manteniendo tu paleta Odoo
   ═══════════════════════════════════════════════════════════════════════════ */
:root {
    --primary: #714B67;
    --primary-light: #8a6280;
    --primary-dark: #5a3c52;
    --primary-bg: #f9f5f8;
    
    --text: #1f2937;
    --text-muted: #6b7280;
    --text-light: #9ca3af;
    
    --bg: #ffffff;
    --bg-alt: #f9fafb;
    --border: #e5e7eb;
    --border-light: #f3f4f6;
    
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
    
    --transition: 0.2s ease;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BASE
   ═══════════════════════════════════════════════════════════════════════════ */
.activity-form {
    max-width: 640px;
    margin: 0 auto;
    padding: 0 16px;
    padding-bottom: 100px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════════════════════════════════════ */
.form-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 100;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 16px;
}

.back-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
    padding: 8px 12px;
    margin: -8px -12px;
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.back-link:hover {
    background: var(--bg-alt);
}

.back-link .material-icons {
    font-size: 20px;
    color: var(--text-muted);
}

.form-actions {
    display: flex;
    gap: 8px;
}

.form-actions .btn-primary {
    display: none;
}

@media (min-width: 640px) {
    .form-actions .btn-primary {
        display: flex;
    }
}

/* ═══════════════════════════════════════════════════════════════════════════
   TOGGLE MODO RÁPIDO
   ═══════════════════════════════════════════════════════════════════════════ */
.quick-mode-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--primary-bg);
    border-radius: var(--radius);
    margin-bottom: 20px;
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--border);
    border-radius: 24px;
    transition: var(--transition);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: var(--transition);
    box-shadow: var(--shadow);
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--primary);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

.toggle-label {
    font-weight: 600;
    color: var(--text);
}

.toggle-hint {
    color: var(--text-muted);
    font-size: 13px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   SECCIONES
   ═══════════════════════════════════════════════════════════════════════════ */
.form-section {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 12px;
    overflow: hidden;
}

.section-main {
    padding: 20px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   SELECTOR DE TIPO - Pills horizontales
   ═══════════════════════════════════════════════════════════════════════════ */
.type-selector {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
    margin-bottom: 20px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.type-selector::-webkit-scrollbar {
    display: none;
}

.type-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--bg-alt);
    border: 2px solid transparent;
    border-radius: 100px;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
    flex-shrink: 0;
}

.type-pill input {
    display: none;
}

.type-pill .pill-icon {
    font-size: 18px;
    color: var(--text-muted);
    transition: var(--transition);
}

.type-pill .pill-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    transition: var(--transition);
}

.type-pill:has(input:checked) {
    background: var(--primary-bg);
    border-color: var(--primary);
}

.type-pill:has(input:checked) .pill-icon,
.type-pill:has(input:checked) .pill-label {
    color: var(--primary);
}

/* ═══════════════════════════════════════════════════════════════════════════
   CAMPOS
   ═══════════════════════════════════════════════════════════════════════════ */
.field-group {
    margin-bottom: 16px;
}

.field-group:last-child {
    margin-bottom: 0;
}

.field-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.input-title {
    width: 100%;
    font-size: 24px;
    font-weight: 600;
    color: var(--text);
    border: none;
    padding: 0;
    background: transparent;
    outline: none;
}

.input-title::placeholder {
    color: var(--text-light);
}

.field-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.field-date,
.field-location {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    flex: 1;
    min-width: 140px;
}

.field-icon {
    font-size: 20px;
    color: var(--text-muted);
}

.field-date input,
.field-location input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 15px;
    color: var(--text);
    outline: none;
    min-width: 0;
}

.input-select,
.field-group input[type="number"],
.field-group textarea {
    width: 100%;
    padding: 12px 14px;
    font-size: 15px;
    color: var(--text);
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: var(--transition);
}

.input-select:focus,
.field-group input:focus,
.field-group textarea:focus {
    border-color: var(--primary);
    background: var(--bg);
}

.field-group textarea {
    resize: vertical;
    min-height: 60px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   ACCORDION
   ═══════════════════════════════════════════════════════════════════════════ */
.accordion-header {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.accordion-header:hover {
    background: var(--bg-alt);
}

.accordion-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.accordion-icon {
    font-size: 22px;
    color: var(--primary);
}

.accordion-title > span:nth-child(2) {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
}

.accordion-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 22px;
    padding: 0 7px;
    background: var(--primary);
    color: white;
    font-size: 12px;
    font-weight: 600;
    border-radius: 100px;
}

.accordion-badge:empty,
.accordion-badge[data-count="0"] {
    display: none;
}

.accordion-value {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 400;
}

.accordion-arrow {
    font-size: 24px;
    color: var(--text-muted);
    transition: var(--transition);
}

.accordion-header[aria-expanded="true"] .accordion-arrow {
    transform: rotate(180deg);
}

.accordion-content {
    display: none;
    padding: 0 20px 20px;
}

.accordion-content.expanded {
    display: block;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PARTICIPANTES
   ═══════════════════════════════════════════════════════════════════════════ */
.participants-search {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    flex: 1;
}

.participants-search > .material-icons {
    font-size: 20px;
    color: var(--text-muted);
}

.participants-search input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 15px;
    outline: none;
}

/* Chips de seleccionados */
.selected-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 40px;
    padding: 12px;
    background: var(--primary-bg);
    border-radius: var(--radius-sm);
    margin-bottom: 16px;
}

.empty-chips {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 14px;
    width: 100%;
    justify-content: center;
    padding: 4px 0;
}

.empty-chips .material-icons {
    font-size: 18px;
}

.selected-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--primary);
    color: white;
    font-size: 13px;
    font-weight: 500;
    border-radius: 100px;
    cursor: pointer;
    transition: var(--transition);
    animation: chipIn 0.2s ease;
}

@keyframes chipIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
}

.selected-chip:hover {
    background: var(--primary-dark);
}

.selected-chip .material-icons {
    font-size: 16px;
    opacity: 0.8;
}

/* Grid de participantes */
.participants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
    max-height: 280px;
    overflow-y: auto;
    padding: 4px;
}

.participants-grid label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    color: var(--text);
}

.participants-grid label:hover {
    border-color: var(--primary-light);
    background: var(--primary-bg);
}

.participants-grid label:has(input:checked) {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.participants-grid label.hidden {
    display: none;
}

.participants-grid input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary);
    flex-shrink: 0;
}

/* ═══════════════════════════════════════════════════════════════════════════
   IMPACTO
   ═══════════════════════════════════════════════════════════════════════════ */
.impact-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.field-number input {
    text-align: center;
    font-weight: 600;
    font-size: 18px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   BOTONES
   ═══════════════════════════════════════════════════════════════════════════ */
.btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    color: white;
    background: var(--primary);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-primary .material-icons {
    font-size: 20px;
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-muted);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    text-decoration: none;
    transition: var(--transition);
}

.btn-secondary:hover {
    background: var(--bg-alt);
    color: var(--text);
}

/* ═══════════════════════════════════════════════════════════════════════════
   FOOTER FIJO (móvil)
   ═══════════════════════════════════════════════════════════════════════════ */
.form-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--bg);
    border-top: 1px solid var(--border);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
    z-index: 100;
}

.form-footer .btn-secondary {
    flex: 1;
}

.form-footer .btn-primary {
    flex: 2;
}

@media (min-width: 640px) {
    .form-footer {
        display: none;
    }
    
    .activity-form {
        padding-bottom: 40px;
    }
}

/* ═══════════════════════════════════════════════════════════════════════════
   MODO RÁPIDO - Ocultar secciones opcionales
   ═══════════════════════════════════════════════════════════════════════════ */
.activity-form.quick-mode .optional-section {
    display: none;
}

.activity-form.quick-mode [data-optional] {
    display: none;
}

/* ═══════════════════════════════════════════════════════════════════════════
   TOOLBAR PARTICIPANTES
   ═══════════════════════════════════════════════════════════════════════════ */
.participants-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 16px;
}

.participants-toolbar .participants-search {
    flex: 1;
    min-width: 150px;
    margin-bottom: 0;
}

.toolbar-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}

/* En móviles muy pequeños, toolbar en columna */
@media (max-width: 380px) {
    .participants-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .participants-toolbar .participants-search {
        width: 100%;
    }
    
    .toolbar-actions {
        justify-content: space-between;
    }
    
    .btn-qr {
        flex: 1;
        justify-content: center;
    }
}

.btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-muted);
}

.btn-icon:hover {
    background: var(--primary-bg);
    color: var(--primary);
    border-color: var(--primary-light);
}

.btn-qr {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
}

.btn-qr:hover {
    background: #0d9668;
}

.btn-qr .material-icons {
    font-size: 20px;
}

@media (max-width: 480px) {
    .btn-qr-label {
        display: none;
    }
    .btn-qr {
        padding: 8px 10px;
    }
}

/* ═══════════════════════════════════════════════════════════════════════════
   QR SCANNER MODAL
   ═══════════════════════════════════════════════════════════════════════════ */
.qr-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

.qr-modal.active {
    display: flex;
}

.qr-modal-content {
    width: 100%;
    max-width: 400px;
    max-height: 90vh;
    background: var(--bg);
    border-radius: var(--radius);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.qr-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.qr-modal-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
}

.qr-modal-header h3 .material-icons {
    color: var(--success);
}

.btn-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-muted);
    transition: var(--transition);
}

.btn-close:hover {
    background: var(--bg-alt);
    color: var(--text);
}

/* Scanner container */
.qr-scanner-container {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background: #000;
    overflow: hidden;
}

#qrVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qr-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}

.qr-frame {
    width: 200px;
    height: 200px;
    border: 3px solid var(--success);
    border-radius: 16px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    animation: pulse-frame 2s ease-in-out infinite;
}

@keyframes pulse-frame {
    0%, 100% { 
        border-color: var(--success);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 20px rgba(16, 185, 129, 0.3);
    }
    50% { 
        border-color: #34d399;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 30px rgba(16, 185, 129, 0.5);
    }
}

/* Lista de escaneados */
.qr-scanned-list {
    flex: 1;
    min-height: 100px;
    max-height: 200px;
    overflow-y: auto;
    border-top: 1px solid var(--border);
}

.scanned-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--bg-alt);
    font-size: 14px;
    color: var(--text-muted);
    position: sticky;
    top: 0;
}

.scanned-header .material-icons {
    font-size: 18px;
    color: var(--success);
}

.scanned-items {
    padding: 8px 12px;
}

.scanned-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--success);
    color: white;
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
}

.scanned-item .material-icons {
    font-size: 20px;
}

.scanned-item-name {
    flex: 1;
    font-weight: 500;
}

.scanned-item-time {
    font-size: 12px;
    opacity: 0.8;
}

.qr-modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
}

.qr-modal-footer .btn-secondary {
    width: 100%;
}

/* Toast de confirmación */
.qr-toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 20px;
    background: var(--success);
    color: white;
    border-radius: var(--radius);
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    z-index: 1001;
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2s forwards;
}

@keyframes toastIn {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
}

@keyframes toastOut {
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
}

.qr-toast .material-icons {
    font-size: 22px;
}

/* Error toast */
.qr-toast.error {
    background: var(--danger);
}

.qr-toast.warning {
    background: var(--warning);
    color: var(--text);
}
</style>

<!-- ══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT
     ══════════════════════════════════════════════════════════════════════════ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    initQuickMode();
    initAccordions();
    initParticipants();
    initResponsablePreview();
    setDefaultDate();
    initQRScanner();
});

/**
 * Modo rápido toggle
 */
function initQuickMode() {
    const form = document.getElementById('activityForm');
    const toggle = document.getElementById('quickMode');
    
    if (!form || !toggle) return;
    
    // Estado inicial
    if (toggle.checked) {
        form.classList.add('quick-mode');
    }
    
    toggle.addEventListener('change', function() {
        form.classList.toggle('quick-mode', this.checked);
    });
}

/**
 * Sistema de accordions
 */
function initAccordions() {
    const headers = document.querySelectorAll('.accordion-header');
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const section = this.closest('.accordion-section');
            const content = section.querySelector('.accordion-content');
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            
            this.setAttribute('aria-expanded', !isExpanded);
            content.classList.toggle('expanded', !isExpanded);
        });
    });
}

/**
 * Fecha por defecto: hoy
 */
function setDefaultDate() {
    const dateInput = document.querySelector('input[name="fecha"]');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
}

/**
 * Preview del responsable seleccionado
 */
function initResponsablePreview() {
    const select = document.querySelector('select[name="responsable"]');
    const preview = document.getElementById('responsableValue');
    
    if (!select || !preview) return;
    
    function updatePreview() {
        const selected = select.options[select.selectedIndex];
        preview.textContent = selected.value ? selected.text : 'Sin asignar';
    }
    
    select.addEventListener('change', updatePreview);
    updatePreview();
}

/**
 * Gestor de participantes
 */
function initParticipants() {
    const grid = document.getElementById('participantsGrid');
    const search = document.getElementById('searchParticipants');
    const chips = document.getElementById('selectedChips');
    const emptyChips = document.getElementById('emptyChips');
    const badge = document.getElementById('participantCount');
    const btnAll = document.getElementById('selectAll');
    const btnNone = document.getElementById('selectNone');
    
    if (!grid) return;
    
    const getCheckboxes = () => Array.from(grid.querySelectorAll('input[type="checkbox"]'));
    const getLabels = () => Array.from(grid.querySelectorAll('label'));
    
    // Obtener nombre del label
    function getName(checkbox) {
        const label = checkbox.closest('label') || document.querySelector(`label[for="${checkbox.id}"]`);
        return label ? label.textContent.trim() : 'Participante';
    }
    
    // Iniciales
    function getInitials(name) {
        return name.split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();
    }
    
    // Actualizar vista
    function updateView() {
        const checkboxes = getCheckboxes();
        const selected = checkboxes.filter(cb => cb.checked);
        const count = selected.length;
        
        // Badge
        if (badge) {
            badge.textContent = count;
            badge.dataset.count = count;
        }
        
        // Chips
        if (chips) {
            // Limpiar chips existentes (no el empty state)
            chips.querySelectorAll('.selected-chip').forEach(c => c.remove());
            
            if (emptyChips) {
                emptyChips.style.display = count > 0 ? 'none' : 'flex';
            }
            
            selected.forEach(cb => {
                const name = getName(cb);
                const chip = document.createElement('div');
                chip.className = 'selected-chip';
                chip.innerHTML = `
                    <span>${name}</span>
                    <span class="material-icons">close</span>
                `;
                chip.addEventListener('click', () => {
                    cb.checked = false;
                    updateView();
                });
                chips.appendChild(chip);
            });
        }
    }
    
    // Búsqueda
    if (search) {
        search.addEventListener('input', function() {
            const term = this.value.toLowerCase().trim();
            getLabels().forEach(label => {
                const text = label.textContent.toLowerCase();
                label.classList.toggle('hidden', term && !text.includes(term));
            });
        });
    }
    
    // Seleccionar todos/ninguno
    if (btnAll) {
        btnAll.addEventListener('click', () => {
            getLabels().forEach(label => {
                if (!label.classList.contains('hidden')) {
                    const cb = label.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = true;
                }
            });
            updateView();
        });
    }
    
    if (btnNone) {
        btnNone.addEventListener('click', () => {
            getCheckboxes().forEach(cb => cb.checked = false);
            updateView();
        });
    }
    
    // Escuchar cambios
    grid.addEventListener('change', updateView);
    
    // Inicial
    updateView();
}

/**
 * Scanner QR para agregar participantes
 * Requiere la librería html5-qrcode (se carga dinámicamente)
 */
function initQRScanner() {
    const btnScan = document.getElementById('btnScanQR');
    const btnClose = document.getElementById('btnCloseQR');
    const btnDone = document.getElementById('btnDoneQR');
    const modal = document.getElementById('qrModal');
    const video = document.getElementById('qrVideo');
    const scannedItems = document.getElementById('scannedItems');
    const scannedCount = document.getElementById('scannedCount');
    
    if (!btnScan || !modal) return;
    
    let stream = null;
    let scanning = false;
    let scannedIds = new Set();
    
    // Cargar librería QR dinámicamente
    function loadQRLibrary() {
        return new Promise((resolve, reject) => {
            if (window.Html5Qrcode) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    
    // Mostrar toast
    function showToast(message, type = 'success') {
        const existing = document.querySelector('.qr-toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = `qr-toast ${type}`;
        toast.innerHTML = `
            <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'warning'}</span>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 2500);
    }
    
    // Vibrar (si está disponible)
    function vibrate() {
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }
    }
    
    // Sonido de confirmación
    function playBeep() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = ctx.createOscillator();
            const gain = ctx.createGain();
            
            oscillator.connect(gain);
            gain.connect(ctx.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gain.gain.value = 0.3;
            
            oscillator.start();
            setTimeout(() => {
                oscillator.stop();
                ctx.close();
            }, 100);
        } catch (e) {}
    }
    
    // Buscar y marcar participante por ID/código
    function markParticipant(code) {
        // El QR puede contener: ID numérico, código de miembro, o URL con ID
        let memberId = code;
        
        // Si es URL, extraer el ID
        if (code.includes('/')) {
            const match = code.match(/miembro[s]?\/(\d+)/i) || code.match(/(\d+)/);
            if (match) memberId = match[1];
        }
        
        // Buscar checkbox por valor o data-attribute
        const grid = document.getElementById('participantsGrid');
        if (!grid) return null;
        
        const checkboxes = grid.querySelectorAll('input[type="checkbox"]');
        let found = null;
        
        checkboxes.forEach(cb => {
            // Buscar por valor del checkbox (normalmente el ID)
            if (cb.value === memberId || cb.value === code) {
                found = cb;
            }
            // Buscar por data-codigo si existe
            if (cb.dataset.codigo === code) {
                found = cb;
            }
        });
        
        if (found && !found.checked) {
            found.checked = true;
            
            // Obtener nombre
            const label = found.closest('label') || document.querySelector(`label[for="${found.id}"]`);
            const name = label ? label.textContent.trim() : `Miembro ${memberId}`;
            
            // Actualizar vista de participantes
            if (typeof updateParticipantsView === 'function') {
                updateParticipantsView();
            } else {
                // Trigger change event
                found.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            return { id: memberId, name: name };
        } else if (found && found.checked) {
            // Ya estaba marcado
            const label = found.closest('label');
            const name = label ? label.textContent.trim() : `Miembro ${memberId}`;
            return { id: memberId, name: name, duplicate: true };
        }
        
        return null;
    }
    
    // Agregar a lista de escaneados en el modal
    function addToScannedList(member) {
        if (!scannedItems) return;
        
        const time = new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
        
        const item = document.createElement('div');
        item.className = 'scanned-item';
        item.innerHTML = `
            <span class="material-icons">person</span>
            <span class="scanned-item-name">${member.name}</span>
            <span class="scanned-item-time">${time}</span>
        `;
        
        scannedItems.insertBefore(item, scannedItems.firstChild);
        
        if (scannedCount) {
            scannedCount.textContent = scannedItems.children.length;
        }
    }
    
    // Iniciar scanner
    async function startScanner() {
        try {
            // Verificar soporte de cámara
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('Tu navegador no soporta cámara', 'error');
                return;
            }
            
            await loadQRLibrary();
            
            modal.classList.add('active');
            
            // Configuración para iOS y Android
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
            
            // Solicitar acceso a cámara
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            video.srcObject = stream;
            
            // iOS requiere estos atributos
            video.setAttribute('autoplay', '');
            video.setAttribute('muted', '');
            video.setAttribute('playsinline', '');
            
            // Esperar a que el video esté listo
            await new Promise((resolve, reject) => {
                video.onloadedmetadata = () => {
                    video.play()
                        .then(resolve)
                        .catch(reject);
                };
                // Timeout por si no carga
                setTimeout(() => reject(new Error('Timeout')), 5000);
            });
            
            scanning = true;
            scanFrame();
            
        } catch (err) {
            console.error('Error iniciando scanner:', err);
            
            let mensaje = 'Error al iniciar cámara';
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                mensaje = 'Permite acceso a la cámara en ajustes';
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                mensaje = 'No se encontró cámara';
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                mensaje = 'La cámara está en uso por otra app';
            } else if (err.name === 'OverconstrainedError') {
                // Intentar sin constraints específicos
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    video.setAttribute('autoplay', '');
                    video.setAttribute('muted', '');
                    video.setAttribute('playsinline', '');
                    await video.play();
                    scanning = true;
                    scanFrame();
                    return;
                } catch (e) {
                    mensaje = 'Error de cámara';
                }
            } else if (err.message === 'Timeout') {
                mensaje = 'Cámara no responde';
            }
            
            showToast(mensaje, 'error');
            closeScanner();
        }
    }
    
    // Escanear frame por frame
    function scanFrame() {
        if (!scanning || !video.videoWidth) {
            if (scanning) requestAnimationFrame(scanFrame);
            return;
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Usar html5-qrcode para decodificar
        if (window.Html5Qrcode) {
            Html5Qrcode.scanFile(canvas.toDataURL(), true)
                .then(decodedText => {
                    handleQRCode(decodedText);
                })
                .catch(() => {
                    // No QR encontrado, continuar escaneando
                });
        }
        
        // Continuar escaneando
        if (scanning) {
            setTimeout(() => requestAnimationFrame(scanFrame), 200);
        }
    }
    
    // Manejar código QR detectado
    function handleQRCode(code) {
        if (scannedIds.has(code)) {
            return; // Ya escaneado en esta sesión
        }
        
        const result = markParticipant(code);
        
        if (result) {
            scannedIds.add(code);
            
            if (result.duplicate) {
                showToast(`${result.name} ya registrado`, 'warning');
                vibrate();
            } else {
                addToScannedList(result);
                showToast(`✓ ${result.name}`, 'success');
                playBeep();
                vibrate();
            }
        } else {
            showToast('Miembro no encontrado', 'error');
            vibrate();
        }
    }
    
    // Cerrar scanner
    function closeScanner() {
        scanning = false;
        modal.classList.remove('active');
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        
        video.srcObject = null;
    }
    
    // Event listeners
    btnScan.addEventListener('click', startScanner);
    btnClose.addEventListener('click', closeScanner);
    btnDone.addEventListener('click', closeScanner);
    
    // Cerrar con ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeScanner();
        }
    });
    
    // Cerrar al hacer click fuera
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeScanner();
        }
    });
}
</script>

{% endblock %}