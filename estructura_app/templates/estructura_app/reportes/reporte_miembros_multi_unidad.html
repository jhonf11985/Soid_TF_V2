{% extends "core/reporte_base.html" %}


{% block title %}Reporte · Miembros en múltiples unidades{% endblock %}

{% block content %}
<div class="rpt-header">
  <div>
    <div class="rpt-title">Miembros en múltiples unidades</div>
    <div class="rpt-sub">
      Lista de análisis · Se muestran solo miembros con <b>{{ min_unidades }}</b> o más unidades.
    </div>
  </div>

  <div class="rpt-meta">
    <span class="rpt-small">Generado: {% now "d/m/Y H:i" %}</span>
    <div class="no-print" style="margin-top:6px;">
      <button type="button" class="btn btn-primary" onclick="window.print()">Imprimir</button>
    </div>
  </div>
</div>

<!-- FILTROS (LISTA REAL) -->
<form method="get" class="no-print" style="margin-top:12px;">
  <div class="rpt-grid">
    <div class="rpt-card">
      <div class="rpt-k">Filtros</div>

      <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">
        <div>
          <label class="rpt-small rpt-muted">Mín. unidades</label><br>
          <select name="min_unidades" class="form-control" style="min-width:120px;">
            <option value="2" {% if min_unidades == 2 %}selected{% endif %}>2</option>
            <option value="3" {% if min_unidades == 3 %}selected{% endif %}>3</option>
            <option value="4" {% if min_unidades == 4 %}selected{% endif %}>4</option>
          </select>
        </div>

        <div>
          <label class="rpt-small rpt-muted">Buscar</label><br>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Nombre, código o teléfono" style="min-width:240px;">
        </div>

        <div>
          <label class="rpt-small rpt-muted">Estado</label><br>
          <select name="estado" class="form-control" style="min-width:160px;">
            <option value="todos" {% if estado == "todos" %}selected{% endif %}>Todos</option>
            <option value="activo" {% if estado == "activo" %}selected{% endif %}>Activo</option>
            <option value="pasivo" {% if estado == "pasivo" %}selected{% endif %}>Pasivo</option>
            <option value="disciplina" {% if estado == "disciplina" %}selected{% endif %}>Disciplina</option>
          </select>
          <div class="rpt-small rpt-muted" style="margin-top:4px;">
            (Si tus estados tienen otros valores, los ajustamos)
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:flex-end;">
          <label class="rpt-small">
            <input type="checkbox" name="liderazgo" value="1" {% if incluir_liderazgo %}checked{% endif %}>
            Liderazgo
          </label>

          <label class="rpt-small">
            <input type="checkbox" name="membresia" value="1" {% if incluir_membresia %}checked{% endif %}>
            Membresía
          </label>

          <label class="rpt-small">
            <input type="checkbox" name="solo_vigentes" value="1" {% if solo_vigentes %}checked{% endif %}>
            Solo vigentes
          </label>

          <label class="rpt-small">
            <input type="checkbox" name="excluir_nc" value="1" {% if excluir_nc %}checked{% endif %}>
            Excluir nuevos creyentes
          </label>
        </div>

        <div>
          <label class="rpt-small rpt-muted">Por página</label><br>
          <select name="per_page" class="form-control" style="min-width:110px;">
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </div>

        <div style="display:flex; gap:8px; align-items:flex-end;">
          <button type="submit" class="btn btn-primary">Aplicar</button>
          <a class="btn btn-light" href="{% url 'estructura_app:reporte_miembros_multi_unidad' %}">Limpiar</a>
        </div>
      </div>
    </div>

    <div class="rpt-card">
      <div class="rpt-k">Resultado</div>
      <div class="rpt-v">{{ total }}</div>
      <div class="rpt-small rpt-muted">miembro(s) encontrado(s)</div>
    </div>
  </div>
</form>

<!-- En impresión, mostramos filtros aplicados -->
<div class="only-print" style="margin-top:10px;">
  <div class="rpt-card">
    <div class="rpt-k">Filtros aplicados</div>
    <div class="rpt-small rpt-muted" style="margin-top:6px; line-height:1.5;">
      <div>• Mín. unidades: <b>{{ min_unidades }}</b></div>
      <div>• Buscar: <b>{% if q %}{{ q }}{% else %}—{% endif %}</b></div>
      <div>• Liderazgo: <b>{% if incluir_liderazgo %}Sí{% else %}No{% endif %}</b></div>
      <div>• Membresía: <b>{% if incluir_membresia %}Sí{% else %}No{% endif %}</b></div>
      <div>• Solo vigentes: <b>{% if solo_vigentes %}Sí{% else %}No{% endif %}</b></div>
      <div>• Estado: <b>{% if estado == "todos" %}Todos{% else %}{{ estado }}{% endif %}</b></div>
      <div>• Excluir nuevos creyentes: <b>{% if excluir_nc %}Sí{% else %}No{% endif %}</b></div>
    </div>
  </div>
</div>

<div class="rpt-table-wrap" style="margin-top:14px;">
  <table class="rpt-table">
    <thead>
      <tr>
        <th style="width:52px;">#</th>
        <th>Miembro</th>
        <th style="width:110px;">Código</th>
        <th style="width:70px;">Edad</th>
        <th style="width:140px;">Estado</th>
        <th style="width:90px; text-align:center;">Unidades</th>
        <th>Unidades (resumen)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in page_obj %}
      <tr>
        <td class="rpt-muted">{{ forloop.counter }}</td>
        <td>
          <div style="font-weight:700;">{{ r.nombre }}</div>
          <div class="rpt-small rpt-muted">ID: {{ r.miembro_id }}</div>
        </td>
        <td>{{ r.codigo|default:"—" }}</td>
        <td>{% if r.edad is not None %}{{ r.edad }}{% else %}—{% endif %}</td>
        <td>{{ r.estado|default:"—" }}</td>
        <td style="text-align:center; font-weight:700;">{{ r.total_unidades }}</td>
        <td>
          {% for it in r.items %}
            <div class="rpt-small" style="margin:2px 0;">
              <b>{{ it.unidad.nombre }}</b> — {{ it.etiqueta }}
            </div>
          {% empty %}
            <span class="rpt-muted">—</span>
          {% endfor %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="rpt-muted" style="text-align:center; padding:18px;">
          No hay miembros que cumplan con los filtros.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- PAGINACIÓN -->
<div class="no-print" style="margin-top:14px; display:flex; align-items:center; justify-content:space-between;">
  <div class="rpt-small rpt-muted">
    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
  </div>

  <div style="display:flex; gap:8px;">
    {% if page_obj.has_previous %}
      <a class="btn btn-light"
         href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
         Anterior
      </a>
    {% endif %}

    {% if page_obj.has_next %}
      <a class="btn btn-light"
         href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
         Siguiente
      </a>
    {% endif %}
  </div>
</div>

{% endblock %}
