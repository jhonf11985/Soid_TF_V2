{% extends 'estructura_app/base_estructura.html' %}
{% load static %}

{% block title %}Asignar a unidad · Estructura{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/estructura.css' %}">
{% endblock %}

{% block estructura_content %}
<div class="assign-container">

    <!-- Header -->
    <div class="assign-header">
        <h1>Asignar personas a unidad</h1>
        <a href="{% url 'estructura_app:unidad_listado' %}" class="assign-back">
            <span class="material-icons">arrow_back</span>
            Volver a unidades
        </a>
    </div>

    <div class="assign-layout">
        
        <!-- Panel izquierdo: Configuración -->
        <div class="assign-config">
            
            <div class="config-section">
                <div class="config-title">Unidad destino</div>
                <div class="config-field">
                    <label class="config-label">Seleccionar unidad</label>
                    <select class="config-select" id="select-unidad">
                        <option value="">Selecciona una unidad...</option>

                        {% if unidades %}
                            {% for unidad in unidades %}
                                <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>No hay unidades disponibles</option>
                        {% endif %}
                    </select>
                </div>
                
                <!-- Info de la unidad (se muestra cuando seleccionan) -->
                <div class="unit-info" id="unit-info" style="display: none;">
                    <div class="unit-info-row">
                        <span class="unit-info-label">Tipo</span>
                        <span class="unit-info-value" id="info-tipo">—</span>
                    </div>
                    <div class="unit-info-row">
                        <span class="unit-info-label">Miembros actuales</span>
                        <span class="unit-info-value" id="info-miembros">0</span>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">Rol a asignar</div>
                <div class="config-field">
                    <label class="config-label">Seleccionar rol</label>
                    <select class="config-select" id="select-rol">
                        <option value="">Selecciona un rol...</option>

                        {% if roles %}
                            {% for rol in roles %}
                                <option value="{{ rol.id }}">{{ rol.nombre }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>No hay roles disponibles</option>
                        {% endif %}
                    </select>
                </div>
            </div>

            <div class="config-actions">
                <button type="button" class="btn-assign" id="btn-guardar" disabled>
                    <span class="material-icons">save</span>
                    Guardar unidad y rol
                </button>

                <div class="selected-count">
                    <span id="count-selected">0</span> personas seleccionadas
                </div>
            </div>
        </div>

        <!-- Panel derecho: Lista de personas -->
        <div class="assign-list">
            
            <!-- Toolbar -->
            <div class="list-toolbar">
                <div class="search-box">
                    <span class="material-icons">search</span>
                    <input type="text" class="search-input" placeholder="Buscar por nombre o código...">
                </div>
                <div class="filter-chips">
                    <span class="filter-chip active" data-filter="todos">Todos</span>
                    <span class="filter-chip" data-filter="activo">Activos</span>
                    <span class="filter-chip" data-filter="observacion">Observación</span>
                </div>
            </div>

            <!-- Tabla -->
            <table class="list-table">
                <thead>
                    <tr>
                        <th class="check-cell">
                            <div class="custom-check" id="check-all"></div>
                        </th>
                        <th>Persona</th>
                        <th style="width: 120px;">Estado</th>
                        <th style="width: 140px;">Categoría</th>
                    </tr>
                </thead>

                <tbody id="personas-tbody">
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <span class="material-icons">touch_app</span>
                                <p>Selecciona una unidad para cargar las personas</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Footer -->
            <div class="list-footer">
                <span>Mostrando {{ personas|length }} personas</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const selectUnidad = document.getElementById('select-unidad');
  const selectRol = document.getElementById('select-rol');
  const tbody = document.getElementById('personas-tbody');

  const unitInfo = document.getElementById('unit-info');
  const infoTipo = document.getElementById('info-tipo');
  const infoMiembros = document.getElementById('info-miembros');

  const btnGuardar = document.getElementById('btn-guardar');

  function renderEmpty(msg) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <span class="material-icons">touch_app</span>
            <p>${msg}</p>
          </div>
        </td>
      </tr>
    `;
  }

  function updateGuardarState() {
    btnGuardar.disabled = !(selectUnidad.value && selectRol.value);
  }

  function rowHTML(p) {
    const extra = p.ya_en_unidad ? '<span class="status-badge status-activo">Ya en unidad</span>' : '';
    return `
      <tr data-id="${p.id}" data-estado="${p.estado_slug}">
        <td class="check-cell">
          <div class="custom-check" data-check="${p.id}"></div>
        </td>
        <td>
          <div class="person-cell">
            <div class="person-avatar"><span class="material-icons">person</span></div>
            <div>
              <div class="person-name">${p.nombre || '—'}</div>
              <div class="person-code">${p.codigo || ''}</div>
            </div>
          </div>
        </td>
        <td>
          <span class="status-badge status-${p.estado_slug}">${p.estado || '—'}</span>
          ${extra}
        </td>
        <td style="color: #6c757d; font-size: 13px;">
          ${p.categoria || '—'}
        </td>
      </tr>
    `;
  }

  async function guardarYcargar() {
    const unidadId = selectUnidad.value;
    const rolId = selectRol.value;

    if (!unidadId || !rolId) return;

    const urlGuardar = "{% url 'estructura_app:asignacion_guardar_contexto' %}";
    const res1 = await fetch(urlGuardar, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || "",
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({ unidad_id: unidadId, rol_id: rolId })
    });

    const data1 = await res1.json();
    if (!data1.ok) {
      renderEmpty(data1.error || "No se pudo guardar el contexto.");
      return;
    }

    const urlLista = "{% url 'estructura_app:asignacion_unidad_contexto' %}" + `?unidad_id=${unidadId}&rol_id=${rolId}`;
    const res2 = await fetch(urlLista, { headers: { "X-Requested-With": "XMLHttpRequest" }});
    const data2 = await res2.json();

    if (!data2.ok) {
      renderEmpty(data2.error || "No se pudo cargar la lista.");
      return;
    }

    unitInfo.style.display = "block";
    infoTipo.textContent = data2.unidad.tipo || "—";
    infoMiembros.textContent = data2.unidad.miembros_actuales ?? 0;

    tbody.innerHTML = data2.personas.map(rowHTML).join("") || "";
    if (!data2.personas.length) {
      renderEmpty("No hay personas disponibles según las reglas de esta unidad.");
    }
  }

  selectUnidad.addEventListener('change', () => {
    updateGuardarState();
    unitInfo.style.display = selectUnidad.value ? "block" : "none";
    renderEmpty("Selecciona un rol y pulsa “Guardar unidad y rol” para cargar la lista.");
  });

  selectRol.addEventListener('change', () => {
    updateGuardarState();
    renderEmpty("Pulsa “Guardar unidad y rol” para cargar la lista según reglas.");
  });

  btnGuardar.addEventListener('click', guardarYcargar);

  unitInfo.style.display = "none";
  renderEmpty("Selecciona una unidad y un rol, luego pulsa “Guardar” para cargar la lista.");
  updateGuardarState();
});
</script>

<style>
/* AQUÍ van tus estilos (igual que los tenías) */
/* ═══════════════════════════════════════════════════════════════════════════
   ASIGNACIÓN - DISEÑO MINIMALISTA
   ═══════════════════════════════════════════════════════════════════════════ */

.assign-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 24px;
}

/* Header */
.assign-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e9ecef;
}

.assign-header h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #212529;
}

.assign-back {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #495057;
    text-decoration: none;
    font-size: 14px;
}

.assign-back:hover {
    color: #017e84;
}

.assign-back .material-icons {
    font-size: 18px;
}

/* Layout dos columnas */
.assign-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 24px;
    align-items: start;
}

/* Panel izquierdo - Configuración */
.assign-config {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    position: sticky;
    top: 24px;
}

.config-section {
    padding: 16px;
    border-bottom: 1px solid #e9ecef;
}

.config-section:last-child {
    border-bottom: none;
}

.config-title {
    font-size: 11px;
    font-weight: 700;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.config-field {
    margin-bottom: 12px;
}

.config-field:last-child {
    margin-bottom: 0;
}

.config-label {
    display: block;
    font-size: 13px;
    color: #495057;
    margin-bottom: 6px;
}

.config-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
    color: #212529;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.15s;
}

.config-select:focus {
    outline: none;
    border-color: #017e84;
}

/* Info de unidad seleccionada */
.unit-info {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    margin-top: 12px;
}

.unit-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    padding: 4px 0;
}

.unit-info-label {
    color: #6c757d;
}

.unit-info-value {
    color: #212529;
    font-weight: 500;
}

/* Botón asignar */
.config-actions {
    padding: 16px;
    background: #f8f9fa;
}

.btn-assign {
    width: 100%;
    padding: 12px 16px;
    background: #017e84;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background 0.15s;
}

.btn-assign:hover {
    background: #016166;
}

.btn-assign:disabled {
    background: #adb5bd;
    cursor: not-allowed;
}

.btn-assign .material-icons {
    font-size: 18px;
}

.selected-count {
    text-align: center;
    font-size: 12px;
    color: #6c757d;
    margin-top: 8px;
}

/* Panel derecho - Lista de personas */
.assign-list {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

/* Barra de búsqueda y filtros */
.list-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #e9ecef;
    background: #fafafa;
}

.search-box {
    flex: 1;
    position: relative;
}

.search-box .material-icons {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: #adb5bd;
}

.search-input {
    width: 100%;
    padding: 8px 12px 8px 36px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
    background: #fff;
}

.search-input:focus {
    outline: none;
    border-color: #017e84;
}

.filter-chips {
    display: flex;
    gap: 6px;
}

.filter-chip {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    font-size: 12px;
    color: #6c757d;
    background: #fff;
    cursor: pointer;
    transition: all 0.15s;
}

.filter-chip:hover {
    border-color: #adb5bd;
}

.filter-chip.active {
    background: #017e84;
    border-color: #017e84;
    color: #fff;
}

/* Tabla */
.list-table {
    width: 100%;
    border-collapse: collapse;
}

.list-table th,
.list-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.list-table th {
    font-size: 11px;
    font-weight: 700;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    background: #fafafa;
}

.list-table tbody tr {
    transition: background 0.1s;
}

.list-table tbody tr:hover {
    background: #f8f9fa;
}

.list-table tbody tr:last-child td {
    border-bottom: none;
}

/* Checkbox personalizado */
.check-cell {
    width: 40px;
}

.custom-check {
    width: 18px;
    height: 18px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.custom-check:hover {
    border-color: #017e84;
}

.custom-check.checked {
    background: #017e84;
    border-color: #017e84;
}

.custom-check.checked::after {
    content: '';
    width: 5px;
    height: 9px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
}

/* Persona info */
.person-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.person-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.person-avatar .material-icons {
    font-size: 20px;
    color: #017e84;
    opacity: 0.7;
}

.person-name {
    font-size: 14px;
    color: #212529;
    font-weight: 500;
}

.person-code {
    font-size: 12px;
    color: #6c757d;
}

/* Status badge */
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.status-activo {
    background: #d4edda;
    color: #155724;
}

.status-observacion {
    background: #fff3cd;
    color: #856404;
}

.status-pasivo {
    background: #f8d7da;
    color: #721c24;
}

/* Empty state */
.empty-state {
    padding: 48px 24px;
    text-align: center;
    color: #6c757d;
}

.empty-state .material-icons {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 12px;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* Paginación */
.list-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-top: 1px solid #e9ecef;
    background: #fafafa;
    font-size: 13px;
    color: #6c757d;
}

/* Responsive */
@media (max-width: 900px) {
    .assign-layout {
        grid-template-columns: 1fr;
    }
    
    .assign-config {
        position: static;
    }
    
    .list-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-chips {
        justify-content: center;
    }
}
</style>

{% endblock %}



