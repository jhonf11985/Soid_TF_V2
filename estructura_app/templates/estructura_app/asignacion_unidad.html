{% extends 'estructura_app/base_estructura.html' %}
{% load static %}

{% block title %}Asignar a unidad · Estructura{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/estructura.css' %}">
{% endblock %}

{% block estructura_content %}
<div class="au-page">

    <!-- ══════════════════════════════════════════════════════════════════════
         CONTROL BAR (Header)
         ══════════════════════════════════════════════════════════════════════ -->
    <div class="au-control-bar">
        <div class="au-control-left">
            <a href="{% url 'estructura_app:unidad_listado' %}" class="au-btn-back">
                <span class="material-icons">arrow_back</span>
            </a>
            <div class="au-title-group">
                <h1>Asignar personas a unidad</h1>
                <span class="au-subtitle">Gestión de miembros</span>
            </div>
        </div>
        <div class="au-control-right">
            <span class="au-selected-badge" id="selected-badge">
                <span class="material-icons">check_circle</span>
                <span id="count-selected">0</span> seleccionados
            </span>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════════
         MAIN LAYOUT
         ══════════════════════════════════════════════════════════════════════ -->
    <div class="au-layout">

        <!-- ────────────────────────────────────────────────────────────────────
             SIDEBAR (Configuración)
             ──────────────────────────────────────────────────────────────────── -->
        <aside class="au-sidebar">
            
            <!-- Sección: Unidad destino -->
            <div class="au-card">
                <div class="au-card-header">
                    <span class="material-icons">apartment</span>
                    <span>Unidad destino</span>
                </div>
                <div class="au-card-body">
                    <div class="au-field">
                        <label for="select-unidad">Seleccionar unidad</label>
                        <select id="select-unidad">
                            <option value="">Selecciona una unidad...</option>
                            {% if unidades %}
                                {% for unidad in unidades %}
                                    <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay unidades disponibles</option>
                            {% endif %}
                        </select>
                    </div>

                    <!-- Info de la unidad -->
                    <div class="au-unit-info" id="unit-info">
                        <div class="au-info-row">
                            <span class="au-info-label">Tipo</span>
                            <span class="au-info-value" id="info-tipo">—</span>
                        </div>
                        <div class="au-info-row">
                            <span class="au-info-label">Miembros</span>
                            <span class="au-info-value" id="info-miembros">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Rol -->
            <div class="au-card">
                <div class="au-card-header">
                    <span class="material-icons">badge</span>
                    <span>Rol a asignar</span>
                </div>
                <div class="au-card-body">
                    <div class="au-field">
                        <label for="select-rol">Seleccionar rol</label>
                        <select id="select-rol">
                            <option value="">Selecciona un rol...</option>
                            {% if roles %}
                                {% for rol in roles %}
                                    <option value="{{ rol.id }}" data-tipo="{{ rol.tipo }}">{{ rol.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay roles disponibles</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección: Acciones -->
            <div class="au-card au-card-actions">
                <button type="button" class="au-btn au-btn-primary" id="btn-guardar" disabled>
                    <span class="material-icons">sync</span>
                    Cargar personas
                </button>

                <div class="au-btn-group">
                    <button type="button" class="au-btn au-btn-success" id="btn-asignar" disabled>
                        <span class="material-icons">person_add</span>
                        Asignar
                    </button>
                    <button type="button" class="au-btn au-btn-danger" id="btn-remover" disabled>
                        <span class="material-icons">person_remove</span>
                        Quitar
                    </button>
                </div>
            </div>

        </aside>

        <!-- ────────────────────────────────────────────────────────────────────
             CONTENT (Lista de personas)
             ──────────────────────────────────────────────────────────────────── -->
        <main class="au-content">
            
            <!-- Toolbar -->
            <div class="au-toolbar">
                <div class="au-search">
                    <span class="material-icons">search</span>
                    <input type="text" class="au-search-input" placeholder="Buscar por nombre o código...">
                </div>
                <div class="au-filter">
                    <label for="view-filter-select">Filtrar:</label>
                    <select id="view-filter-select" disabled>
                        <option value="todos">Todos (según reglas)</option>
                        <option value="no_activo">Ocultar activos</option>
                        <option value="activo">Solo Activos</option>
                        <option value="observacion">Solo Observación</option>
                        <option value="pasivo">Solo Pasivos</option>
                        <option value="disciplina">Solo Disciplina</option>
                        <option value="catecumeno">Solo Catecúmenos</option>
                        <option value="menor">Solo Menores</option>
                        <option value="nuevo">Solo Nuevos creyentes</option>
                        <option value="en_unidad">Solo en unidad</option>
                        <option value="fuera_unidad">Solo fuera de unidad</option>
                    </select>
                </div>
            </div>

            <!-- Tabla -->
            <div class="au-table-wrapper">
                <table class="au-table">
                    <thead>
                        <tr>
                            <th class="au-th-check">
                                <div class="au-checkbox" id="check-all">
                                    <span class="material-icons">check</span>
                                </div>
                            </th>
                            <th>Persona</th>
                            <th class="au-th-sm">Edad</th>
                            <th class="au-th-md">Estado</th>
                            <th class="au-th-md">Categoría</th>
                        </tr>
                    </thead>
                    <tbody id="personas-tbody">
                        <tr>
                            <td colspan="5">
                                <div class="au-empty">
                                    <span class="material-icons">touch_app</span>
                                    <p>Selecciona una unidad y un rol para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="au-footer">
                <span id="footer-count">Mostrando {{ personas|length }} personas</span>
            </div>

        </main>
    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT
     ══════════════════════════════════════════════════════════════════════════ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ─── Referencias DOM ───────────────────────────────────────────────────
    const selectUnidad = document.getElementById('select-unidad');
    const selectRol = document.getElementById('select-rol');
    // ─── Precargar unidad desde la URL (?unidad_id=) ─────────────
    const params = new URLSearchParams(window.location.search);
    const unidadFromUrl = params.get('unidad_id');

    if (unidadFromUrl && selectUnidad) {
        selectUnidad.value = unidadFromUrl;

        // Disparamos el cambio como si el usuario la hubiera elegido
        selectUnidad.dispatchEvent(new Event('change', { bubbles: true }));
    }

    const tbody = document.getElementById('personas-tbody');

    const unitInfo = document.getElementById('unit-info');
    const infoTipo = document.getElementById('info-tipo');
    const infoMiembros = document.getElementById('info-miembros');

    const btnGuardar = document.getElementById('btn-guardar');
    const btnAsignar = document.getElementById('btn-asignar');
    const btnRemover = document.getElementById('btn-remover');

    const countSelected = document.getElementById('count-selected');
    const selectedBadge = document.getElementById('selected-badge');
    const checkAll = document.getElementById('check-all');

    const searchInput = document.querySelector('.au-search-input');
    const viewSelect = document.getElementById('view-filter-select');
    const footerCount = document.getElementById('footer-count');

    // ─── Estado ────────────────────────────────────────────────────────────
    const selectedIds = new Set();

    // ─── Utilidades ────────────────────────────────────────────────────────
    function getCookie(name) {
        const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return m ? decodeURIComponent(m[2]) : '';
    }

    function renderEmpty(msg) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="au-empty">
                        <span class="material-icons">touch_app</span>
                        <p>${msg}</p>
                    </div>
                </td>
            </tr>
        `;
        updateFooter(0);
    }

    function updateFooter(count) {
        if (footerCount) {
            footerCount.textContent = `Mostrando ${count} persona${count !== 1 ? 's' : ''}`;
        }
    }

    function updateGuardarState() {
        btnGuardar.disabled = !(selectUnidad.value && selectRol.value);
    }

    function updateSelectedUI() {
        const n = selectedIds.size;
        if (countSelected) countSelected.textContent = String(n);
        if (selectedBadge) {
            selectedBadge.classList.toggle('au-visible', n > 0);
        }

        const enabled = (selectUnidad.value && selectRol.value && n > 0);
        if (btnAsignar) btnAsignar.disabled = !enabled;
        if (btnRemover) btnRemover.disabled = !enabled;

        validarContextoLiderazgoUI();
    }


    function clearSelection() {
        selectedIds.clear();
        tbody.querySelectorAll('.au-checkbox.checked').forEach(el => el.classList.remove('checked'));
        if (checkAll) checkAll.classList.remove('checked');
        updateSelectedUI();
    }

    function normalizeEstadoSlug(slug) {
        if (!slug || slug === 'null' || slug === 'undefined') return 'menor';
        return slug;
    }

    function labelForEstadoSlug(slug) {
        const map = {
            activo: 'Solo Activos',
            observacion: 'Solo Observación',
            pasivo: 'Solo Pasivos',
            disciplina: 'Solo Disciplina',
            catecumeno: 'Solo Catecúmenos',
            menor: 'Solo Menores',
            nuevo: 'Solo Nuevos creyentes',
        };
        return map[slug] || `Solo ${slug}`;
    }

    // ─── Filtros ───────────────────────────────────────────────────────────
    function buildViewFilterOptions(reglasAplicadas, personas) {
        const allowed = new Set(['activo']);
        const r = reglasAplicadas || {};

        if (r.permite_observacion) allowed.add('observacion');
        if (r.permite_pasivos) allowed.add('pasivo');
        if (r.permite_disciplina) allowed.add('disciplina');
        if (r.permite_catecumenos) allowed.add('catecumeno');
        if (r.permite_menores) allowed.add('menor');

        (personas || []).forEach(p => {
            const st = normalizeEstadoSlug(p.estado_slug);
            if (st === 'nuevo') allowed.add('nuevo');
            if (st === 'menor') allowed.add('menor');
        });

        const ordered = ['activo', 'observacion', 'pasivo', 'disciplina', 'catecumeno', 'menor', 'nuevo']
            .filter(x => allowed.has(x));

        if (!viewSelect) return { ordered, defaultValue: 'todos' };

        const baseOptions = [
            { value: 'todos', label: 'Todos (según reglas)' },
            { value: 'no_activo', label: 'Ocultar activos' },
        ];
        const unidadOptions = [
            { value: 'en_unidad', label: 'Solo en unidad' },
            { value: 'fuera_unidad', label: 'Solo fuera de unidad' },
        ];
        const stateOptions = ordered.map(slug => ({
            value: slug,
            label: labelForEstadoSlug(slug),
        }));

        viewSelect.innerHTML = [
            ...baseOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
            ...unidadOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
            ...stateOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
        ].join('');

        const nonActive = ordered.filter(x => x !== 'activo');
        const defaultValue = (nonActive.length === 1) ? nonActive[0] : 'todos';

        return { ordered, defaultValue };
    }

    function applyFilters() {
        const q = (searchInput?.value || '').trim().toLowerCase();
        const mode = viewSelect ? viewSelect.value : 'todos';

        const rows = document.querySelectorAll('#personas-tbody tr[data-estado]');
        let visibleCount = 0;

        rows.forEach(row => {
            const st = (row.dataset.estado || '').toLowerCase();
            const text = (row.innerText || '').toLowerCase();

            const matchSearch = !q || text.includes(q);

            let matchView = true;
            if (mode === 'todos') matchView = true;
            else if (mode === 'no_activo') matchView = (st !== 'activo');
            else if (mode === 'en_unidad') matchView = (row.dataset.enunidad === '1');
            else if (mode === 'fuera_unidad') matchView = (row.dataset.enunidad === '0');
            else matchView = (st === mode);

            const visible = matchSearch && matchView;
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        updateFooter(visibleCount);

        if (checkAll) {
            const visible = Array.from(document.querySelectorAll('#personas-tbody tr[data-id]'))
                .filter(r => r.style.display !== 'none');
            const allSelected = visible.length > 0 && visible.every(r => selectedIds.has(r.dataset.id));
            checkAll.classList.toggle('checked', allSelected);
        }
    }

    // ─── Renderizado de filas ──────────────────────────────────────────────
    function rowHTML(p) {
        const estadoSlug = normalizeEstadoSlug(p.estado_slug);
        const enUnidadBadge = p.ya_en_unidad
            ? `<span class="au-badge au-badge-info">En unidad · ${p.rol_en_unidad || '—'}</span>`
            : '';

        return `
            <tr data-id="${p.id}" data-estado="${estadoSlug}" data-enunidad="${p.ya_en_unidad ? '1' : '0'}">
                <td class="au-td-check">
                    <div class="au-checkbox" data-check="${p.id}">
                        <span class="material-icons">check</span>
                    </div>
                </td>
                <td>
                    <div class="au-person">
                        <div class="au-avatar">
                            <span class="material-icons">person</span>
                        </div>
                        <div class="au-person-info">
                            <span class="au-person-name">${p.nombre || '—'}</span>
                            <span class="au-person-code">${p.codigo || ''}</span>
                        </div>
                    </div>
                </td>
                <td class="au-td-center">
                    ${p.edad !== null && p.edad !== undefined ? p.edad : '—'}
                </td>
                <td>
                    <span class="au-badge au-badge-${estadoSlug}">${p.estado || '—'}</span>
                    ${enUnidadBadge}
                </td>
                <td class="au-td-muted">${p.categoria || '—'}</td>
            </tr>
        `;
    }

    // ─── Selección ─────────────────────────────────────────────────────────
    function attachSelectionHandlers() {
        tbody.querySelectorAll('.au-checkbox[data-check]').forEach(chk => {
            chk.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const id = chk.dataset.check;
                if (!id) return;

                chk.classList.toggle('checked');
                if (chk.classList.contains('checked')) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }
                updateSelectedUI();
                applyFilters();
            });
        });

        tbody.querySelectorAll('tr[data-id]').forEach(row => {
            row.addEventListener('click', (ev) => {
                if (ev.target.closest('.au-checkbox')) return;
                const id = row.dataset.id;
                const chk = row.querySelector(`.au-checkbox[data-check="${id}"]`);
                if (!chk) return;

                chk.classList.toggle('checked');
                if (chk.classList.contains('checked')) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }
                updateSelectedUI();
                applyFilters();
            });
        });

        if (checkAll) {
            checkAll.addEventListener('click', () => {
                const visibleRows = Array.from(tbody.querySelectorAll('tr[data-id]'))
                    .filter(r => r.style.display !== 'none');

                const allSelected = visibleRows.length > 0 && 
                    visibleRows.every(r => selectedIds.has(r.dataset.id));

                visibleRows.forEach(r => {
                    const id = r.dataset.id;
                    const chk = r.querySelector(`.au-checkbox[data-check="${id}"]`);
                    if (!chk) return;

                    if (allSelected) {
                        chk.classList.remove('checked');
                        selectedIds.delete(id);
                    } else {
                        chk.classList.add('checked');
                        selectedIds.add(id);
                    }
                });

                checkAll.classList.toggle('checked', !allSelected);
                updateSelectedUI();
            });
        }

        updateSelectedUI();
    }

    // ─── API: Guardar y Cargar ─────────────────────────────────────────────
    async function guardarYcargar() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;
        if (!unidadId || !rolId) return;

        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="material-icons au-spin">sync</span> Cargando...';

        try {
            const urlGuardar = "{% url 'estructura_app:asignacion_guardar_contexto' %}";
            const res1 = await fetch(urlGuardar, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({ unidad_id: unidadId, rol_id: rolId })
            });

            const data1 = await res1.json();
            if (!data1.ok) {
                clearSelection();
                renderEmpty(data1.error || "No se pudo guardar el contexto.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            const urlLista = "{% url 'estructura_app:asignacion_unidad_contexto' %}" + 
                `?unidad_id=${unidadId}&rol_id=${rolId}`;
            const res2 = await fetch(urlLista, { 
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });
            const data2 = await res2.json();

            if (!data2.ok) {
                clearSelection();
                renderEmpty(data2.error || "No se pudo cargar la lista.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            // Mostrar info de unidad
            unitInfo.classList.add('au-visible');
            infoTipo.textContent = data2.unidad?.tipo || "—";
            infoMiembros.textContent = data2.unidad?.miembros_actuales ?? 0;

            const personas = data2.personas || [];
            // ─── Contexto de liderazgo ───────────────────────────
            const reglasUnidad = data2.unidad?.reglas_aplicadas || {};
            const permiteLiderazgo = !!reglasUnidad.permite_liderazgo;

            // Tipo de rol seleccionado
            const rolOption = selectRol.options[selectRol.selectedIndex];
            const rolTipo = rolOption?.dataset?.tipo || null;

            // Guardamos en estado global
            window.__contextoAsignacion = {
                permiteLiderazgo,
                rolTipo,
            };

            tbody.innerHTML = personas.map(rowHTML).join("");

            clearSelection();

            if (!personas.length) {
                renderEmpty("No hay personas disponibles según las reglas de esta unidad.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            if (viewSelect) {
                viewSelect.disabled = false;
                const { defaultValue } = buildViewFilterOptions(data2.unidad?.reglas_aplicadas, personas);
                viewSelect.value = defaultValue;
            }

            applyFilters();
            validarContextoLiderazgoUI();
            attachSelectionHandlers();


        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<span class="material-icons">sync</span> Cargar personas';
            updateGuardarState();
        }
    }
    function validarContextoLiderazgoUI() {
        const ctx = window.__contextoAsignacion;
        if (!ctx) return true;

        const { permiteLiderazgo, rolTipo } = ctx;

        // Limpieza visual por defecto
        selectRol.classList.remove('au-input-error');

        // Si el rol NO es liderazgo, no hacemos nada especial
        if (rolTipo !== 'LIDERAZGO') {
            // No fuerces aquí: updateSelectedUI ya decide por selectedIds
            return true;
        }

        // Rol es liderazgo pero la unidad NO lo permite
        if (!permiteLiderazgo) {
            selectRol.classList.add('au-input-error');

            if (btnAsignar) btnAsignar.disabled = true;
            if (btnRemover) btnRemover.disabled = true;

            renderEmpty(
                "Esta unidad no permite liderazgo. Activa la opción «Permite liderazgo» en la configuración de la unidad."
            );
            return false;
        }

        return true;
    }



    // ─── API: Asignar ──────────────────────────────────────────────────────
    async function aplicarAsignacion() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;

        if (!unidadId || !rolId) {
            alert("Selecciona unidad y rol.");
            return;
        }

        const ids = Array.from(selectedIds);
        if (!ids.length) {
            alert("Selecciona al menos una persona.");
            return;
        }

        if (btnAsignar) btnAsignar.disabled = true;

        const urlAplicar = "{% url 'estructura_app:asignacion_aplicar' %}";
        const res = await fetch(urlAplicar, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify({
                unidad_id: unidadId,
                rol_id: rolId,
                miembro_ids: ids
            })
        });

        let data;
        try {
            data = await res.json();
        } catch (e) {
            alert("Respuesta inválida del servidor.");
            updateSelectedUI();
            return;
        }

        if (!data.ok) {
            alert(data.error || "No se pudo asignar.");
            updateSelectedUI();
            return;
        }

        await guardarYcargar();
        alert(`Listo.\nCreados: ${data.creados}\nReactivados: ${data.reactivados}\nYa existían: ${data.ya_existian}`);
    }

    // ─── API: Remover ──────────────────────────────────────────────────────
    async function aplicarRemocion() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;

        if (!unidadId || !rolId) {
            alert("Selecciona unidad y rol.");
            return;
        }

        const ids = Array.from(selectedIds);
        if (!ids.length) {
            alert("Selecciona al menos una persona.");
            return;
        }

        if (!confirm("¿Seguro que deseas quitar a las personas seleccionadas de esta unidad?")) {
            return;
        }

        if (btnRemover) btnRemover.disabled = true;

        const urlRemover = "{% url 'estructura_app:asignacion_remover' %}";
        const res = await fetch(urlRemover, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify({
                unidad_id: unidadId,
                rol_id: rolId,
                miembro_ids: ids
            })
        });

        let data;
        try {
            data = await res.json();
        } catch (e) {
            alert("Respuesta inválida del servidor.");
            updateSelectedUI();
            return;
        }

        if (!data.ok) {
            alert(data.error || "No se pudo remover.");
            updateSelectedUI();
            return;
        }

        await guardarYcargar();
        alert(`Listo.\nRemovidos: ${data.removidos}`);
    }

    // ─── Event Listeners ───────────────────────────────────────────────────
    selectUnidad.addEventListener('change', () => {
        updateGuardarState();
        unitInfo.classList.toggle('au-visible', !!selectUnidad.value);
        clearSelection();
        renderEmpty("Selecciona un rol y pulsa «Cargar personas»");

        if (viewSelect) {
            viewSelect.disabled = true;
            viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
            viewSelect.value = 'todos';
        }
    });

    selectRol.addEventListener('change', () => {
        updateGuardarState();
        clearSelection();
        renderEmpty("Pulsa «Cargar personas» para ver la lista según reglas.");

        if (viewSelect) {
            viewSelect.disabled = true;
            viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
            viewSelect.value = 'todos';
        }
    });

    btnGuardar.addEventListener('click', guardarYcargar);
    if (btnAsignar) btnAsignar.addEventListener('click', aplicarAsignacion);
    if (btnRemover) btnRemover.addEventListener('click', aplicarRemocion);

    if (viewSelect) viewSelect.addEventListener('change', applyFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);

    // ─── Estado inicial ────────────────────────────────────────────────────
    unitInfo.classList.remove('au-visible');
    renderEmpty("Selecciona una unidad y un rol para comenzar");
    updateGuardarState();
    clearSelection();

    if (viewSelect) {
        viewSelect.disabled = true;
        viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
        viewSelect.value = 'todos';
    }
});
</script>

<!-- ══════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════ -->
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   VARIABLES
   ═══════════════════════════════════════════════════════════════════════════ */
.au-page {
    --au-primary: #017e84;
    --au-primary-dark: #016166;
    --au-success: #28a745;
    --au-danger: #dc3545;
    --au-gray-100: #f8f9fa;
    --au-gray-200: #e9ecef;
    --au-gray-300: #dee2e6;
    --au-gray-500: #6c757d;
    --au-gray-700: #495057;
    --au-gray-900: #212529;
    --au-radius: 8px;
    --au-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

/* ═══════════════════════════════════════════════════════════════════════════
   PAGE LAYOUT
   ═══════════════════════════════════════════════════════════════════════════ */
.au-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTROL BAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    margin-bottom: 20px;
    box-shadow: var(--au-shadow);
}

.au-control-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.au-btn-back {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    color: var(--au-gray-700);
    text-decoration: none;
    transition: all 0.15s;
}

.au-btn-back:hover {
    background: var(--au-gray-200);
    color: var(--au-primary);
}

.au-title-group h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--au-gray-900);
}

.au-subtitle {
    font-size: 12px;
    color: var(--au-gray-500);
}

.au-selected-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--au-primary);
    color: #fff;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    opacity: 0;
    transform: scale(0.9);
    transition: all 0.2s;
}

.au-selected-badge.au-visible {
    opacity: 1;
    transform: scale(1);
}

.au-selected-badge .material-icons {
    font-size: 16px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   MAIN LAYOUT
   ═══════════════════════════════════════════════════════════════════════════ */
.au-layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-sidebar {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 16px;
    align-items: start;
}

.au-card {
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    overflow: hidden;
    box-shadow: var(--au-shadow);
}

.au-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-bottom: 1px solid var(--au-gray-200);
    font-size: 13px;
    font-weight: 600;
    color: var(--au-gray-700);
}

.au-card-header .material-icons {
    font-size: 18px;
    color: var(--au-primary);
}

.au-card-body {
    padding: 16px;
}

.au-card-actions {
    padding: 16px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   FORM FIELDS
   ═══════════════════════════════════════════════════════════════════════════ */
.au-field {
    margin-bottom: 0;
}

.au-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 500;
    color: var(--au-gray-700);
}

.au-field select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 14px;
    color: var(--au-gray-900);
    background: #fff;
    cursor: pointer;
    transition: border-color 0.15s;
}

.au-field select:focus {
    outline: none;
    border-color: var(--au-primary);
}

/* ═══════════════════════════════════════════════════════════════════════════
   UNIT INFO
   ═══════════════════════════════════════════════════════════════════════════ */
.au-unit-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--au-gray-100);
    border-radius: 6px;
    display: none;
}

.au-unit-info.au-visible {
    display: block;
}

.au-info-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 13px;
}

.au-info-label {
    color: var(--au-gray-500);
}

.au-info-value {
    font-weight: 500;
    color: var(--au-gray-900);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BUTTONS
   ═══════════════════════════════════════════════════════════════════════════ */
.au-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}

.au-btn .material-icons {
    font-size: 18px;
}

.au-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.au-btn-primary {
    background: var(--au-primary);
    color: #fff;
}

.au-btn-primary:hover:not(:disabled) {
    background: var(--au-primary-dark);
}

.au-btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.au-btn-success {
    background: var(--au-success);
    color: #fff;
}

.au-btn-success:hover:not(:disabled) {
    background: #218838;
}

.au-btn-danger {
    background: var(--au-danger);
    color: #fff;
}

.au-btn-danger:hover:not(:disabled) {
    background: #c82333;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTENT AREA
   ═══════════════════════════════════════════════════════════════════════════ */
.au-content {
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    overflow: hidden;
    box-shadow: var(--au-shadow);
}

/* ═══════════════════════════════════════════════════════════════════════════
   TOOLBAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-bottom: 1px solid var(--au-gray-200);
}

.au-search {
    flex: 1;
    position: relative;
}

.au-search .material-icons {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: var(--au-gray-500);
}

.au-search-input {
    width: 100%;
    padding: 8px 12px 8px 40px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
}

.au-search-input:focus {
    outline: none;
    border-color: var(--au-primary);
}

.au-filter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.au-filter label {
    font-size: 13px;
    color: var(--au-gray-500);
    white-space: nowrap;
}

.au-filter select {
    padding: 8px 12px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 13px;
    background: #fff;
    cursor: pointer;
}

.au-filter select:focus {
    outline: none;
    border-color: var(--au-primary);
}

.au-filter select:disabled {
    background: var(--au-gray-100);
    cursor: not-allowed;
}

/* ═══════════════════════════════════════════════════════════════════════════
   TABLE
   ═══════════════════════════════════════════════════════════════════════════ */
.au-table-wrapper {
    overflow-x: auto;
}

.au-table {
    width: 100%;
    border-collapse: collapse;
}

.au-table th,
.au-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--au-gray-200);
}

.au-table th {
    font-size: 11px;
    font-weight: 600;
    color: var(--au-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--au-gray-100);
}

.au-table tbody tr {
    transition: background 0.1s;
    cursor: pointer;
}

.au-table tbody tr:hover {
    background: var(--au-gray-100);
}

.au-th-check,
.au-td-check {
    width: 48px;
    text-align: center;
}

.au-th-sm { width: 70px; }
.au-th-md { width: 130px; }

.au-td-center { text-align: center; color: var(--au-gray-700); }
.au-td-muted { color: var(--au-gray-500); font-size: 13px; }

/* ═══════════════════════════════════════════════════════════════════════════
   CHECKBOX
   ═══════════════════════════════════════════════════════════════════════════ */
.au-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--au-gray-300);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
}

.au-checkbox .material-icons {
    font-size: 14px;
    color: transparent;
    transition: color 0.15s;
}

.au-checkbox:hover {
    border-color: var(--au-primary);
}

.au-checkbox.checked {
    background: var(--au-primary);
    border-color: var(--au-primary);
}

.au-checkbox.checked .material-icons {
    color: #fff;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PERSON CELL
   ═══════════════════════════════════════════════════════════════════════════ */
.au-person {
    display: flex;
    align-items: center;
    gap: 12px;
}

.au-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.au-avatar .material-icons {
    font-size: 20px;
    color: var(--au-primary);
    opacity: 0.7;
}

.au-person-name {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--au-gray-900);
}

.au-person-code {
    font-size: 12px;
    color: var(--au-gray-500);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BADGES
   ═══════════════════════════════════════════════════════════════════════════ */
.au-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-right: 4px;
}

.au-badge-activo { background: #d4edda; color: #155724; }
.au-badge-observacion { background: #fff3cd; color: #856404; }
.au-badge-pasivo { background: #f8d7da; color: #721c24; }
.au-badge-disciplina { background: #f5c6cb; color: #721c24; }
.au-badge-catecumeno { background: #cce5ff; color: #004085; }
.au-badge-menor { background: #e2e3e5; color: #383d41; }
.au-badge-nuevo { background: #d1ecf1; color: #0c5460; }
.au-badge-info { background: #d4edda; color: #155724; }

/* ═══════════════════════════════════════════════════════════════════════════
   EMPTY STATE
   ═══════════════════════════════════════════════════════════════════════════ */
.au-empty {
    padding: 60px 24px;
    text-align: center;
    color: var(--au-gray-500);
}

.au-empty .material-icons {
    font-size: 48px;
    color: var(--au-gray-300);
    margin-bottom: 12px;
}

.au-empty p {
    margin: 0;
    font-size: 14px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   FOOTER
   ═══════════════════════════════════════════════════════════════════════════ */
.au-footer {
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-top: 1px solid var(--au-gray-200);
    font-size: 13px;
    color: var(--au-gray-500);
}

/* ═══════════════════════════════════════════════════════════════════════════
   ANIMATIONS
   ═══════════════════════════════════════════════════════════════════════════ */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.au-spin {
    animation: spin 1s linear infinite;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════ */
@media (max-width: 900px) {
    .au-sidebar {
        grid-template-columns: 1fr 1fr;
    }

    .au-card-actions {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: flex-start;
    }

    .au-toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .au-filter {
        justify-content: flex-end;
    }
}

@media (max-width: 600px) {
    .au-page {
        padding: 12px;
    }

    .au-sidebar {
        grid-template-columns: 1fr;
    }

    .au-card-actions {
        flex-direction: column;
    }

    .au-control-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .au-control-right {
        align-self: flex-end;
    }
}
.au-input-error {
    border-color: #dc3545 !important;
    background: #fff5f5 !important;
}

</style>

{% endblock %}