{% extends 'estructura_app/base_estructura.html' %}
{% load static %}

{% block title %}Asignar a unidad · Estructura{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/estructura.css' %}">
{% endblock %}

{% block estructura_content %}
<div class="o-page">

    <!-- Header -->
    <header class="o-header">
        <div class="o-header-left">
            <a href="{% url 'estructura_app:unidad_listado' %}" class="o-back">
                <span class="material-icons">arrow_back</span>
            </a>
            <h1 class="o-title">Asignar personas a unidad</h1>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="o-layout">

        <!-- Sidebar -->
        <aside class="o-sidebar">

            <!-- Card: Configuración -->
            <div class="o-card">
                <div class="o-card-header">
                    <span class="material-icons">settings</span>
                    Configuración
                </div>
                <div class="o-card-body">
                    
                    <div class="o-field">
                        <label class="o-label">Unidad destino</label>
                        <select class="o-select" id="select-unidad">
                            <option value="">Selecciona una unidad...</option>
                            {% if unidades %}
                                {% for unidad in unidades %}
                                    <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay unidades disponibles</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="o-field">
                        <label class="o-label">Rol a asignar</label>
                        <select class="o-select" id="select-rol">
                            <option value="">Selecciona un rol...</option>
                            {% if roles %}
                                {% for rol in roles %}
                                    <option value="{{ rol.id }}">{{ rol.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay roles disponibles</option>
                            {% endif %}
                        </select>
                    </div>

                    <!-- Unit Info -->
                    <div class="o-unit-info" id="unit-info" style="display: none;">
                        <div class="o-info-item">
                            <span class="o-info-label">Tipo</span>
                            <span class="o-info-value" id="info-tipo">—</span>
                        </div>
                        <div class="o-info-item">
                            <span class="o-info-label">Miembros</span>
                            <span class="o-info-value" id="info-miembros">0</span>
                        </div>
                    </div>

                    <button type="button" class="o-btn o-btn-primary" id="btn-guardar" disabled>
                        <span class="material-icons">sync</span>
                        Cargar lista
                    </button>
                </div>
            </div>

            <!-- Card: Acciones -->
            <div class="o-card o-card-actions">
                <div class="o-card-header">
                    <span class="material-icons">touch_app</span>
                    Acciones
                </div>
                <div class="o-card-body">
                    <div class="o-counter">
                        <span class="o-counter-num" id="count-selected">0</span>
                        <span class="o-counter-text">seleccionados</span>
                    </div>

                    <div class="o-btn-stack">
                        <button type="button" class="o-btn o-btn-success" id="btn-asignar" disabled>
                            <span class="material-icons">person_add</span>
                            Asignar
                        </button>
                        <button type="button" class="o-btn o-btn-danger" id="btn-remover" disabled>
                            <span class="material-icons">person_remove</span>
                            Quitar
                        </button>
                    </div>
                </div>
            </div>

        </aside>

        <!-- Content -->
        <main class="o-main">
            <div class="o-card o-card-table">
                
                <!-- Toolbar -->
                <div class="o-toolbar">
                    <div class="o-search">
                        <span class="material-icons">search</span>
                        <input type="text" class="search-input" placeholder="Buscar por nombre o código...">
                    </div>
                    <div class="o-filter">
                        <select class="o-filter-select" id="view-filter-select" disabled>
                            <option value="todos">Todos (según reglas)</option>
                            <option value="no_activo">Ocultar activos</option>
                            <option value="activo">Solo Activos</option>
                            <option value="observacion">Solo Observación</option>
                            <option value="pasivo">Solo Pasivos</option>
                            <option value="disciplina">Solo Disciplina</option>
                            <option value="catecumeno">Solo Catecúmenos</option>
                            <option value="menor">Solo Menores</option>
                            <option value="nuevo">Solo Nuevos creyentes</option>
                            <option value="en_unidad">Solo en unidad</option>
                            <option value="fuera_unidad">Solo fuera de unidad</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="o-table-container">
                    <table class="o-table">
                        <thead>
                            <tr>
                                <th class="o-th-check">
                                    <div class="custom-check" id="check-all"></div>
                                </th>
                                <th>Persona</th>
                                <th class="o-th-sm">Edad</th>
                                <th class="o-th-md">Estado</th>
                                <th class="o-th-md">Categoría</th>
                            </tr>
                        </thead>
                        <tbody id="personas-tbody">
                            <tr>
                                <td colspan="5">
                                    <div class="empty-state">
                                        <span class="material-icons">touch_app</span>
                                        <p>Selecciona una unidad para cargar las personas</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Footer -->
                <div class="o-table-footer">
                    <span>Mostrando {{ personas|length }} personas</span>
                </div>

            </div>
        </main>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const selectUnidad = document.getElementById('select-unidad');
  const selectRol = document.getElementById('select-rol');
  const tbody = document.getElementById('personas-tbody');

  const unitInfo = document.getElementById('unit-info');
  const infoTipo = document.getElementById('info-tipo');
  const infoMiembros = document.getElementById('info-miembros');

  const btnGuardar = document.getElementById('btn-guardar');
  const btnAsignar = document.getElementById('btn-asignar');
  const btnRemover = document.getElementById('btn-remover');

  const countSelected = document.getElementById('count-selected');
  const checkAll = document.getElementById('check-all');

  // Buscador + filtro
  const searchInput = document.querySelector('.search-input');
  const viewSelect = document.getElementById('view-filter-select');

  // Selección
  const selectedIds = new Set();

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : '';
  }

  function renderEmpty(msg) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5">
          <div class="empty-state">
            <span class="material-icons">touch_app</span>
            <p>${msg}</p>
          </div>
        </td>
      </tr>
    `;
  }

  function updateGuardarState() {
    btnGuardar.disabled = !(selectUnidad.value && selectRol.value);
  }

  function updateSelectedUI() {
    const n = selectedIds.size;
    if (countSelected) countSelected.textContent = String(n);

    const enabled = (selectUnidad.value && selectRol.value && n > 0);

    if (btnAsignar) btnAsignar.disabled = !enabled;
    if (btnRemover) btnRemover.disabled = !enabled;
  }

  function clearSelection() {
    selectedIds.clear();
    tbody.querySelectorAll('.custom-check.checked').forEach(el => el.classList.remove('checked'));
    if (checkAll) checkAll.classList.remove('checked');
    updateSelectedUI();
  }

  function normalizeEstadoSlug(slug) {
    if (!slug || slug === 'null' || slug === 'undefined') return 'menor';
    return slug;
  }

  function labelForEstadoSlug(slug) {
    const map = {
      activo: 'Solo Activos',
      observacion: 'Solo Observación',
      pasivo: 'Solo Pasivos',
      disciplina: 'Solo Disciplina',
      catecumeno: 'Solo Catecúmenos',
      menor: 'Solo Menores',
      nuevo: 'Solo Nuevos creyentes',
    };
    return map[slug] || `Solo ${slug}`;
  }

  function buildViewFilterOptions(reglasAplicadas, personas) {
    const allowed = new Set(['activo']);
    const r = reglasAplicadas || {};

    if (r.permite_observacion) allowed.add('observacion');
    if (r.permite_pasivos) allowed.add('pasivo');
    if (r.permite_disciplina) allowed.add('disciplina');
    if (r.permite_catecumenos) allowed.add('catecumeno');
    if (r.permite_menores) allowed.add('menor');

    (personas || []).forEach(p => {
      const st = normalizeEstadoSlug(p.estado_slug);
      if (st === 'nuevo') allowed.add('nuevo');
      if (st === 'menor') allowed.add('menor');
    });

    const ordered = ['activo', 'observacion', 'pasivo', 'disciplina', 'catecumeno', 'menor', 'nuevo']
      .filter(x => allowed.has(x));

    if (!viewSelect) return { ordered, defaultValue: 'todos' };

    const baseOptions = [
      { value: 'todos', label: 'Todos (según reglas)' },
      { value: 'no_activo', label: 'Ocultar activos' },
    ];
    const unidadOptions = [
      { value: 'en_unidad', label: 'Solo en unidad' },
      { value: 'fuera_unidad', label: 'Solo fuera de unidad' },
    ];

    const stateOptions = ordered.map(slug => ({
      value: slug,
      label: labelForEstadoSlug(slug),
    }));

    viewSelect.innerHTML = [
      ...baseOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
      ...unidadOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
      ...stateOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
    ].join('');


    const nonActive = ordered.filter(x => x !== 'activo');
    const defaultValue = (nonActive.length === 1) ? nonActive[0] : 'todos';

    return { ordered, defaultValue };
  }

  function applyFilters() {
    const q = (searchInput?.value || '').trim().toLowerCase();
    const mode = viewSelect ? viewSelect.value : 'todos';

    const rows = document.querySelectorAll('#personas-tbody tr[data-estado]');
    rows.forEach(row => {
      const st = (row.dataset.estado || '').toLowerCase();
      const text = (row.innerText || '').toLowerCase();

      const matchSearch = !q || text.includes(q);

      let matchView = true;
      if (mode === 'todos') matchView = true;
      else if (mode === 'no_activo') matchView = (st !== 'activo');
      else if (mode === 'en_unidad') matchView = (row.dataset.enunidad === '1');
      else if (mode === 'fuera_unidad') matchView = (row.dataset.enunidad === '0');
      else matchView = (st === mode);


      row.style.display = (matchSearch && matchView) ? '' : 'none';
    });

    if (checkAll) {
      const visible = Array.from(document.querySelectorAll('#personas-tbody tr[data-id]'))
        .filter(r => r.style.display !== 'none');
      const allSelected = visible.length > 0 && visible.every(r => selectedIds.has(r.dataset.id));
      if (allSelected) checkAll.classList.add('checked');
      else checkAll.classList.remove('checked');
    }
  }

  function rowHTML(p) {
    const estadoSlug = normalizeEstadoSlug(p.estado_slug);
    const extra = p.ya_en_unidad
      ? '<span class="status-badge status-activo">Ya en unidad</span>'
      : '';

    return `
      <tr data-id="${p.id}" data-estado="${estadoSlug}" data-enunidad="${p.ya_en_unidad ? '1' : '0'}">  
        <td class="check-cell">
          <div class="custom-check" data-check="${p.id}"></div>
        </td>

        <td>
          <div class="person-cell">
            <div class="person-avatar"><span class="material-icons">person</span></div>
            <div>
              <div class="person-name">${p.nombre || '—'}</div>
              <div class="person-code">${p.codigo || ''}</div>
            </div>
          </div>
        </td>

        <td style="font-size: 13px; color: #495057;">
          ${p.edad !== null && p.edad !== undefined ? (p.edad + ' años') : '—'}
        </td>

        <td>
          <span class="status-badge status-${estadoSlug}">${p.estado || '—'}</span>
          ${extra}
        </td>

        <td style="color: #6c757d; font-size: 13px;">
          ${p.categoria || '—'}
        </td>
      </tr>
    `;
  }

  function attachSelectionHandlers() {
    tbody.querySelectorAll('.custom-check[data-check]').forEach(chk => {
      chk.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const id = chk.dataset.check;
        if (!id) return;

        if (chk.classList.contains('checked')) {
          chk.classList.remove('checked');
          selectedIds.delete(id);
        } else {
          chk.classList.add('checked');
          selectedIds.add(id);
        }
        updateSelectedUI();
        applyFilters();
      });
    });

    tbody.querySelectorAll('tr[data-id]').forEach(row => {
      row.addEventListener('click', () => {
        const id = row.dataset.id;
        const chk = row.querySelector(`.custom-check[data-check="${id}"]`);
        if (!chk) return;

        if (chk.classList.contains('checked')) {
          chk.classList.remove('checked');
          selectedIds.delete(id);
        } else {
          chk.classList.add('checked');
          selectedIds.add(id);
        }
        updateSelectedUI();
        applyFilters();
      });
    });

    if (checkAll) {
      checkAll.addEventListener('click', () => {
        const visibleRows = Array.from(tbody.querySelectorAll('tr[data-id]'))
          .filter(r => r.style.display !== 'none');

        const allSelected = visibleRows.length > 0 && visibleRows.every(r => selectedIds.has(r.dataset.id));

        visibleRows.forEach(r => {
          const id = r.dataset.id;
          const chk = r.querySelector(`.custom-check[data-check="${id}"]`);
          if (!chk) return;

          if (allSelected) {
            chk.classList.remove('checked');
            selectedIds.delete(id);
          } else {
            chk.classList.add('checked');
            selectedIds.add(id);
          }
        });

        if (allSelected) checkAll.classList.remove('checked');
        else checkAll.classList.add('checked');

        updateSelectedUI();
      });
    }

    updateSelectedUI();
  }

  async function guardarYcargar() {
    const unidadId = selectUnidad.value;
    const rolId = selectRol.value;
    if (!unidadId || !rolId) return;

    const urlGuardar = "{% url 'estructura_app:asignacion_guardar_contexto' %}";
    const res1 = await fetch(urlGuardar, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({ unidad_id: unidadId, rol_id: rolId })
    });

    const data1 = await res1.json();
    if (!data1.ok) {
      clearSelection();
      renderEmpty(data1.error || "No se pudo guardar el contexto.");
      if (viewSelect) {
        viewSelect.disabled = true;
        viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
      }
      return;
    }

    const urlLista = "{% url 'estructura_app:asignacion_unidad_contexto' %}" + `?unidad_id=${unidadId}&rol_id=${rolId}`;
    const res2 = await fetch(urlLista, { headers: { "X-Requested-With": "XMLHttpRequest" }});
    const data2 = await res2.json();

    if (!data2.ok) {
      clearSelection();
      renderEmpty(data2.error || "No se pudo cargar la lista.");
      if (viewSelect) {
        viewSelect.disabled = true;
        viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
      }
      return;
    }

    unitInfo.style.display = "block";
    infoTipo.textContent = data2.unidad?.tipo || "—";
    infoMiembros.textContent = data2.unidad?.miembros_actuales ?? 0;

    const personas = data2.personas || [];
    tbody.innerHTML = personas.map(rowHTML).join("");

    clearSelection();

    if (!personas.length) {
      renderEmpty("No hay personas disponibles según las reglas de esta unidad.");
      if (viewSelect) {
        viewSelect.disabled = true;
        viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
      }
      return;
    }

    if (viewSelect) {
      viewSelect.disabled = false;
      const { defaultValue } = buildViewFilterOptions(data2.unidad?.reglas_aplicadas, personas);
      viewSelect.value = defaultValue;
    }

    applyFilters();
    attachSelectionHandlers();
  }

  async function aplicarAsignacion() {
    const unidadId = selectUnidad.value;
    const rolId = selectRol.value;

    if (!unidadId || !rolId) {
      alert("Selecciona unidad y rol.");
      return;
    }

    const ids = Array.from(selectedIds);
    if (!ids.length) {
      alert("Selecciona al menos una persona.");
      return;
    }

    if (btnAsignar) btnAsignar.disabled = true;

    const urlAplicar = "{% url 'estructura_app:asignacion_aplicar' %}";
    const res = await fetch(urlAplicar, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({
        unidad_id: unidadId,
        rol_id: rolId,
        miembro_ids: ids
      })
    });

    let data;
    try {
      data = await res.json();
    } catch (e) {
      alert("Respuesta inválida del servidor.");
      updateSelectedUI();
      return;
    }

    if (!data.ok) {
      alert(data.error || "No se pudo asignar.");
      updateSelectedUI();
      return;
    }

    await guardarYcargar();
    alert(`Listo.\nCreados: ${data.creados}\nReactivados: ${data.reactivados}\nYa existían: ${data.ya_existian}`);
  }

  async function aplicarRemocion() {
    const unidadId = selectUnidad.value;
    const rolId = selectRol.value;

    if (!unidadId || !rolId) {
      alert("Selecciona unidad y rol.");
      return;
    }

    const ids = Array.from(selectedIds);
    if (!ids.length) {
      alert("Selecciona al menos una persona.");
      return;
    }

    if (!confirm("¿Seguro que deseas quitar a las personas seleccionadas de esta unidad?")) {
      return;
    }

    if (btnRemover) btnRemover.disabled = true;

    const urlRemover = "{% url 'estructura_app:asignacion_remover' %}";
    const res = await fetch(urlRemover, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({
        unidad_id: unidadId,
        rol_id: rolId,
        miembro_ids: ids
      })
    });

    let data;
    try {
      data = await res.json();
    } catch (e) {
      alert("Respuesta inválida del servidor.");
      updateSelectedUI();
      return;
    }

    if (!data.ok) {
      alert(data.error || "No se pudo remover.");
      updateSelectedUI();
      return;
    }

    await guardarYcargar();
    alert(`Listo.\nRemovidos: ${data.removidos}`);
  }

  // Eventos select
  selectUnidad.addEventListener('change', () => {
    updateGuardarState();
    unitInfo.style.display = selectUnidad.value ? "block" : "none";
    clearSelection();

    renderEmpty("Selecciona un rol y pulsa "Cargar lista".");

    if (viewSelect) {
      viewSelect.disabled = true;
      viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
      viewSelect.value = 'todos';
    }
  });

  selectRol.addEventListener('change', () => {
    updateGuardarState();
    clearSelection();

    renderEmpty("Pulsa "Cargar lista" para ver personas según reglas.");

    if (viewSelect) {
      viewSelect.disabled = true;
      viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
      viewSelect.value = 'todos';
    }
  });

  btnGuardar.addEventListener('click', guardarYcargar);
  if (btnAsignar) btnAsignar.addEventListener('click', aplicarAsignacion);
  if (btnRemover) btnRemover.addEventListener('click', aplicarRemocion);

  if (viewSelect) viewSelect.addEventListener('change', applyFilters);
  if (searchInput) searchInput.addEventListener('input', applyFilters);

  // Estado inicial
  unitInfo.style.display = "none";
  renderEmpty("Selecciona una unidad y un rol, luego pulsa "Cargar lista".");
  updateGuardarState();
  clearSelection();

  if (viewSelect) {
    viewSelect.disabled = true;
    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
    viewSelect.value = 'todos';
  }
});
</script>

<style>
/* ═══════════════════════════════════════════════════════════════════════════
   ODOO-STYLE CLEAN DESIGN
   ═══════════════════════════════════════════════════════════════════════════ */

.o-page {
    min-height: 100vh;
    background: #f1f3f5;
}

/* Header */
.o-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    height: 56px;
    background: #fff;
    border-bottom: 1px solid #dee2e6;
}

.o-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.o-back {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    color: #495057;
    transition: all 0.15s;
}

.o-back:hover {
    background: #f1f3f5;
    color: #017e84;
}

.o-back .material-icons {
    font-size: 22px;
}

.o-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #212529;
}

/* Layout */
.o-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

/* Sidebar */
.o-sidebar {
    display: flex;
    flex-direction: column;
    gap: 16px;
    position: sticky;
    top: 24px;
    align-self: start;
}

/* Cards */
.o-card {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.o-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 16px;
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.o-card-header .material-icons {
    font-size: 18px;
    color: #6c757d;
}

.o-card-body {
    padding: 16px;
}

.o-card-actions .o-card-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Form Fields */
.o-field {
    margin-bottom: 14px;
}

.o-field:last-of-type {
    margin-bottom: 16px;
}

.o-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #495057;
    margin-bottom: 6px;
}

.o-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    color: #212529;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
}

.o-select:focus {
    outline: none;
    border-color: #017e84;
    box-shadow: 0 0 0 3px rgba(1, 126, 132, 0.1);
}

/* Unit Info */
.o-unit-info {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 16px;
}

.o-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13px;
}

.o-info-item:first-child { padding-top: 0; }
.o-info-item:last-child { padding-bottom: 0; }

.o-info-label {
    color: #6c757d;
}

.o-info-value {
    font-weight: 600;
    color: #212529;
}

/* Buttons */
.o-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    width: 100%;
}

.o-btn .material-icons {
    font-size: 18px;
}

.o-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.o-btn-primary {
    background: #017e84;
    color: #fff;
}

.o-btn-primary:hover:not(:disabled) {
    background: #016166;
}

.o-btn-success {
    background: #28a745;
    color: #fff;
}

.o-btn-success:hover:not(:disabled) {
    background: #218838;
}

.o-btn-danger {
    background: #dc3545;
    color: #fff;
}

.o-btn-danger:hover:not(:disabled) {
    background: #c82333;
}

.o-btn-stack {
    display: flex;
    gap: 8px;
}

.o-btn-stack .o-btn {
    flex: 1;
    padding: 10px 12px;
}

/* Counter */
.o-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

.o-counter-num {
    font-size: 20px;
    font-weight: 700;
    color: #017e84;
}

.o-counter-text {
    font-size: 13px;
    color: #6c757d;
}

/* Main Content */
.o-main {
    min-width: 0;
}

.o-card-table {
    display: flex;
    flex-direction: column;
}

/* Toolbar */
.o-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
}

.o-search {
    flex: 1;
    position: relative;
    max-width: 320px;
}

.o-search .material-icons {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: #adb5bd;
}

.o-search .search-input {
    width: 100%;
    padding: 9px 12px 9px 40px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s;
}

.o-search .search-input:focus {
    outline: none;
    border-color: #017e84;
    box-shadow: 0 0 0 3px rgba(1, 126, 132, 0.1);
}

.o-filter {
    margin-left: auto;
}

.o-filter-select {
    padding: 9px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 13px;
    color: #495057;
    background: #fff;
    min-width: 180px;
}

.o-filter-select:focus {
    outline: none;
    border-color: #017e84;
}

/* Table */
.o-table-container {
    overflow-x: auto;
}

.o-table {
    width: 100%;
    border-collapse: collapse;
}

.o-table th,
.o-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.o-table th {
    font-size: 11px;
    font-weight: 700;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: #f8f9fa;
    white-space: nowrap;
}

.o-th-check { width: 48px; }
.o-th-sm { width: 80px; }
.o-th-md { width: 130px; }

.o-table tbody tr {
    transition: background 0.1s;
    cursor: pointer;
}

.o-table tbody tr:hover {
    background: #f8f9fa;
}

/* Checkbox */
.check-cell { width: 48px; }

.custom-check {
    width: 18px;
    height: 18px;
    border: 2px solid #ced4da;
    border-radius: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.custom-check:hover {
    border-color: #017e84;
}

.custom-check.checked {
    background: #017e84;
    border-color: #017e84;
}

.custom-check.checked::after {
    content: '';
    width: 5px;
    height: 9px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
}

/* Person Cell */
.person-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.person-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.person-avatar .material-icons {
    font-size: 20px;
    color: #017e84;
    opacity: 0.7;
}

.person-name {
    font-size: 14px;
    color: #212529;
    font-weight: 500;
}

.person-code {
    font-size: 12px;
    color: #6c757d;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.status-activo { background: #d4edda; color: #155724; }
.status-observacion { background: #fff3cd; color: #856404; }
.status-pasivo { background: #f8d7da; color: #721c24; }
.status-disciplina { background: #f5c6cb; color: #721c24; }
.status-catecumeno { background: #cce5ff; color: #004085; }
.status-menor { background: #e2e3e5; color: #383d41; }
.status-nuevo { background: #d1ecf1; color: #0c5460; }

/* Empty State */
.empty-state {
    padding: 60px 24px;
    text-align: center;
    color: #6c757d;
}

.empty-state .material-icons {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 12px;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* Table Footer */
.o-table-footer {
    padding: 12px 16px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    font-size: 13px;
    color: #6c757d;
}

/* Responsive */
@media (max-width: 1024px) {
    .o-layout {
        grid-template-columns: 1fr;
    }

    .o-sidebar {
        position: static;
        flex-direction: row;
        flex-wrap: wrap;
    }

    .o-sidebar .o-card {
        flex: 1;
        min-width: 260px;
    }
}

@media (max-width: 768px) {
    .o-header {
        padding: 0 16px;
    }

    .o-layout {
        padding: 16px;
    }

    .o-sidebar {
        flex-direction: column;
    }

    .o-sidebar .o-card {
        min-width: auto;
    }

    .o-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }

    .o-search {
        max-width: none;
    }

    .o-filter {
        margin-left: 0;
    }

    .o-filter-select {
        width: 100%;
    }

    .o-btn-stack {
        flex-direction: column;
    }
}
</style>
{% endblock %}