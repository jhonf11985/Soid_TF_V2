{% extends 'estructura_app/base_estructura.html' %}
{% load static %}

{% block title %}Asignar a unidad · Estructura{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/estructura.css' %}">
{% endblock %}

{% block estructura_content %}
<div class="au-page">

    <!-- ══════════════════════════════════════════════════════════════════════
         CONTROL BAR (Header)
         ══════════════════════════════════════════════════════════════════════ -->
    <div class="au-control-bar">
        <div class="au-control-left">
            <a href="{% url 'estructura_app:unidad_listado' %}" class="au-btn-back">
                <span class="material-icons">arrow_back</span>
            </a>
            <div class="au-title-group">
                <h1>Asignar personas a unidad</h1>
                <span class="au-subtitle">Gestión de miembros</span>
            </div>
        </div>
        <div class="au-control-right">
            <span class="au-selected-badge" id="selected-badge">
                <span class="material-icons">check_circle</span>
                <span id="count-selected">0</span> seleccionados
            </span>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════════════
         MAIN LAYOUT
         ══════════════════════════════════════════════════════════════════════ -->
    <div class="au-layout">

        <!-- ────────────────────────────────────────────────────────────────────
             SIDEBAR (Configuración)
             ──────────────────────────────────────────────────────────────────── -->
        <aside class="au-sidebar">
            
            <!-- Sección: Unidad destino -->
            <div class="au-card">
                <div class="au-card-header">
                    <span class="material-icons">apartment</span>
                    <span>Unidad destino</span>
                </div>
                <div class="au-card-body">
                    <div class="au-field">
                        <label>Seleccionar unidad</label>
                        
                        <!-- ═══════════════════════════════════════════════════
                             DROPDOWN JERÁRQUICO DE UNIDADES
                             ═══════════════════════════════════════════════════ -->
                        <div class="unit-dropdown" id="unit-dropdown">
                            <!-- Trigger button -->
                            <button type="button" class="unit-trigger" id="unit-trigger">
                                <span class="unit-trigger-text" id="unit-trigger-text">
                                    <span class="material-icons" style="font-size: 18px; color: #6c757d;">apartment</span>
                                    <span>Selecciona una unidad...</span>
                                </span>
                                <span class="material-icons unit-arrow">expand_more</span>
                            </button>
                            
                            <!-- Panel desplegable -->
                            <div class="unit-panel" id="unit-panel">
                                <!-- Buscador -->
                                <div class="unit-search-box">
                                    <span class="material-icons">search</span>
                                    <input type="text" id="unit-search-input" placeholder="Buscar unidad...">
                                </div>
                                
                                <!-- Lista de unidades -->
                                <div class="unit-list" id="unit-list">
                                    {% for unidad in unidades %}
                                    <div class="unit-option" 
                                         data-id="{{ unidad.id }}"
                                         data-nombre="{{ unidad.nombre }}"
                                         data-tipo="{{ unidad.tipo.nombre }}"
                                         data-icono="{{ unidad.tipo.icono|default:'folder' }}"
                                         data-categoria="{{ unidad.categoria.nombre }}"
                                         data-categoria-slug="{{ unidad.categoria.codigo|default:unidad.categoria.nombre|slugify }}"
                                         data-nivel="{{ unidad.nivel|default:0 }}"
                                         data-search="{{ unidad.nombre|lower }} {{ unidad.tipo.nombre|lower }} {{ unidad.categoria.nombre|lower }}">
                                        
                                        <!-- Indentación según nivel -->
                                        <span class="unit-indent" style="width: {{ unidad.nivel|default:0 }}0px;"></span>
                                        
                                        <!-- Conector visual (solo si tiene padre) -->
                                        {% if unidad.nivel|default:0 > 0 %}
                                        <span class="unit-connector">└</span>
                                        {% endif %}
                                        
                                        <!-- Icono del tipo -->
                                        <span class="unit-icon">
                                            <span class="material-icons">{{ unidad.tipo.icono|default:"folder" }}</span>
                                        </span>
                                        
                                        <!-- Nombre -->
                                        <span class="unit-name">{{ unidad.nombre }}</span>
                                        
                                        <!-- Badge de categoría -->
                                        <span class="unit-badge" data-cat="{{ unidad.categoria.codigo|default:unidad.categoria.nombre|slugify }}">
                                            {{ unidad.categoria.nombre }}
                                        </span>
                                    </div>
                                    {% empty %}
                                    <div class="unit-empty">
                                        <span class="material-icons">info</span>
                                        No hay unidades disponibles
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input oculto para compatibilidad -->
                        <input type="hidden" id="select-unidad" name="unidad" value="">
                    </div>

                    <!-- Info de la unidad -->
                    <div class="au-unit-info" id="unit-info">
                        <div class="au-info-row">
                            <span class="au-info-label">Tipo</span>
                            <span class="au-info-value" id="info-tipo">—</span>
                        </div>
                        <div class="au-info-row">
                            <span class="au-info-label">Miembros</span>
                            <span class="au-info-value" id="info-miembros">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Rol -->
            <div class="au-card">
                <div class="au-card-header">
                    <span class="material-icons">badge</span>
                    <span>Rol a asignar</span>
                </div>
                <div class="au-card-body">
                    <div class="au-field">
                        <label for="select-rol">Seleccionar rol</label>
                        <select id="select-rol">
                            <option value="">Selecciona un rol...</option>
                            {% if roles %}
                                {% for rol in roles %}
                                    <option value="{{ rol.id }}" data-tipo="{{ rol.tipo }}">{{ rol.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay roles disponibles</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección: Acciones -->
            <div class="au-card au-card-actions">
                <button type="button" class="au-btn au-btn-primary" id="btn-guardar" disabled>
                    <span class="material-icons">sync</span>
                    Cargar personas
                </button>

                <div class="au-btn-group">
                    <button type="button" class="au-btn au-btn-success" id="btn-asignar" disabled>
                        <span class="material-icons">person_add</span>
                        Asignar
                    </button>
                    <button type="button" class="au-btn au-btn-danger" id="btn-remover" disabled>
                        <span class="material-icons">person_remove</span>
                        Quitar
                    </button>
                </div>
            </div>

        </aside>

        <!-- ────────────────────────────────────────────────────────────────────
             CONTENT (Lista de personas)
             ──────────────────────────────────────────────────────────────────── -->
        <main class="au-content">
            
            <!-- Toolbar -->
            <div class="au-toolbar">
                <div class="au-search">
                    <span class="material-icons">search</span>
                    <input type="text" class="au-search-input" placeholder="Buscar por nombre o código...">
                </div>
                <div class="au-filter">
                    <label for="view-filter-select">Filtrar:</label>
                    <select id="view-filter-select" disabled>
                        <option value="todos">Todos (según reglas)</option>
                        <option value="no_activo">Ocultar activos</option>
                        <option value="activo">Solo Activos</option>
                        <option value="observacion">Solo Observación</option>
                        <option value="pasivo">Solo Pasivos</option>
                        <option value="disciplina">Solo Disciplina</option>
                        <option value="catecumeno">Solo Catecúmenos</option>
                        <option value="menor">Solo Menores</option>
                        <option value="nuevo">Solo Nuevos creyentes</option>
                        <option value="en_unidad">Solo en unidad</option>
                        <option value="fuera_unidad">Solo fuera de unidad</option>
                    </select>
                </div>
            </div>

            <!-- Tabla -->
            <div class="au-table-wrapper">
                <table class="au-table">
                    <thead>
                        <tr>
                            <th class="au-th-check">
                                <div class="au-checkbox" id="check-all">
                                    <span class="material-icons">check</span>
                                </div>
                            </th>
                            <th>Persona</th>
                            <th class="au-th-sm">Edad</th>
                            <th class="au-th-sm">Género</th>
                            <th class="au-th-md">Estado</th>
                            <th class="au-th-md">Categoría</th>
                        </tr>
                    </thead>
                    <tbody id="personas-tbody">
                        <tr>
                            <td colspan="5">
                                <div class="au-empty">
                                    <span class="material-icons">touch_app</span>
                                    <p>Selecciona una unidad y un rol para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="au-footer">
                <span id="footer-count">Mostrando {{ personas|length }} personas</span>
            </div>

        </main>
    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT
     ══════════════════════════════════════════════════════════════════════════ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ═══════════════════════════════════════════════════════════════════════
    // DROPDOWN JERÁRQUICO DE UNIDADES
    // ═══════════════════════════════════════════════════════════════════════
    const dropdown = document.getElementById('unit-dropdown');
    const trigger = document.getElementById('unit-trigger');
    const triggerText = document.getElementById('unit-trigger-text');
    const panel = document.getElementById('unit-panel');
    const unitSearchInput = document.getElementById('unit-search-input');
    const unitList = document.getElementById('unit-list');
    const selectUnidad = document.getElementById('select-unidad'); // Hidden input
    const unitOptions = unitList.querySelectorAll('.unit-option');
    
    // Toggle dropdown
    trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('open');
        if (dropdown.classList.contains('open')) {
            unitSearchInput.focus();
            unitSearchInput.value = '';
            unitOptions.forEach(o => o.classList.remove('hidden'));
        }
    });
    
    // Cerrar al hacer click fuera
    document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
        }
    });
    
    // Cerrar con Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            dropdown.classList.remove('open');
        }
    });
    
    // Buscar unidades
    unitSearchInput.addEventListener('input', () => {
        const term = unitSearchInput.value.toLowerCase().trim();
        unitOptions.forEach(opt => {
            const searchText = opt.dataset.search || '';
            opt.classList.toggle('hidden', term !== '' && !searchText.includes(term));
        });
    });
    
    // Seleccionar unidad
    unitOptions.forEach(opt => {
        opt.addEventListener('click', () => {
            // Quitar selección anterior
            unitOptions.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            
            // Actualizar hidden input
            const id = opt.dataset.id;
            selectUnidad.value = id;
            
            // Actualizar trigger
            const nombre = opt.dataset.nombre;
            const icono = opt.dataset.icono || 'folder';
            const categoria = opt.dataset.categoria;
            const catSlug = opt.dataset.categoriaSlug || categoria.toLowerCase().replace(/\s+/g, '-');
            
            triggerText.innerHTML = `
                <span class="unit-trigger-icon">
                    <span class="material-icons">${icono}</span>
                </span>
                <span>${nombre}</span>
                <span class="unit-badge" data-cat="${catSlug}">${categoria}</span>
            `;
            trigger.classList.add('has-selection');
            
            // Cerrar dropdown
            dropdown.classList.remove('open');
            
            // Disparar evento change para compatibilidad con lógica existente
            selectUnidad.dispatchEvent(new Event('change', { bubbles: true }));
        });
    });

    // ═══════════════════════════════════════════════════════════════════════
    // LÓGICA ORIGINAL (sin cambios)
    // ═══════════════════════════════════════════════════════════════════════
    
    const selectRol = document.getElementById('select-rol');
    
    // Precargar unidad desde la URL (?unidad_id=)
    const params = new URLSearchParams(window.location.search);
    const unidadFromUrl = params.get('unidad_id');

    if (unidadFromUrl) {
        const opt = unitList.querySelector(`[data-id="${unidadFromUrl}"]`);
        if (opt) {
            opt.click();
        }
    }

    const tbody = document.getElementById('personas-tbody');

    const unitInfo = document.getElementById('unit-info');
    const infoTipo = document.getElementById('info-tipo');
    const infoMiembros = document.getElementById('info-miembros');

    const btnGuardar = document.getElementById('btn-guardar');
    const btnAsignar = document.getElementById('btn-asignar');
    const btnRemover = document.getElementById('btn-remover');

    // Modal salida masiva
    const modalSalida = document.getElementById('au-modal-salida');
    const modalClose = document.getElementById('au-modal-close');
    const modalCancel = document.getElementById('au-salida-cancel');
    const modalAplicar = document.getElementById('au-salida-aplicar');

    const salidaResumen = document.getElementById('au-salida-resumen');
    const salidaFecha = document.getElementById('au-salida-fecha');
    const salidaMotivo = document.getElementById('au-salida-motivo');
    const salidaNotas = document.getElementById('au-salida-notas');
    const salidaConfirm = document.getElementById('au-salida-confirm');


    const countSelected = document.getElementById('count-selected');
    const selectedBadge = document.getElementById('selected-badge');
    const checkAll = document.getElementById('check-all');

    const searchInput = document.querySelector('.au-search-input');
    const viewSelect = document.getElementById('view-filter-select');
    const footerCount = document.getElementById('footer-count');

    // Estado
    const selectedIds = new Set();

    // Utilidades
    function getCookie(name) {
        const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return m ? decodeURIComponent(m[2]) : '';
    }

    function renderEmpty(msg) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="au-empty">
                        <span class="material-icons">touch_app</span>
                        <p>${msg}</p>
                    </div>
                </td>
            </tr>
        `;
        updateFooter(0);
    }

    function updateFooter(count) {
        if (footerCount) {
            footerCount.textContent = `Mostrando ${count} persona${count !== 1 ? 's' : ''}`;
        }
    }

    function updateGuardarState() {
        btnGuardar.disabled = !(selectUnidad.value && selectRol.value);
    }

    function updateSelectedUI() {
        const n = selectedIds.size;
        if (countSelected) countSelected.textContent = String(n);
        if (selectedBadge) {
            selectedBadge.classList.toggle('au-visible', n > 0);
        }

        const enabled = (selectUnidad.value && selectRol.value && n > 0);
        if (btnAsignar) btnAsignar.disabled = !enabled;
        if (btnRemover) btnRemover.disabled = !enabled;

        validarContextoLiderazgoUI();
    }


    function clearSelection() {
        selectedIds.clear();
        tbody.querySelectorAll('.au-checkbox.checked').forEach(el => el.classList.remove('checked'));
        if (checkAll) checkAll.classList.remove('checked');
        updateSelectedUI();
    }

    function normalizeEstadoSlug(slug) {
        if (!slug || slug === 'null' || slug === 'undefined') return 'menor';
        return slug;
    }

    function todayISO() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function getSelectedUnidadText() {
        const selectedOpt = unitList.querySelector('.unit-option.selected');
        return selectedOpt ? selectedOpt.dataset.nombre : '—';
    }

    function openModalSalida() {
        if (!modalSalida) return;

        const unidadTxt = getSelectedUnidadText();
        const rolTxt = selectRol?.options?.[selectRol.selectedIndex]?.text || '—';
        const n = selectedIds.size;

        if (salidaResumen) {
            salidaResumen.textContent = `Unidad: ${unidadTxt} · Rol: ${rolTxt} · Seleccionados: ${n}`;
        }

        if (salidaFecha) salidaFecha.value = todayISO();
        if (salidaMotivo) salidaMotivo.value = '';
        if (salidaNotas) salidaNotas.value = '';
        if (salidaConfirm) salidaConfirm.checked = false;

        modalSalida.style.display = 'block';
    }

    function closeModalSalida() {
        if (!modalSalida) return;
        modalSalida.style.display = 'none';
    }

    function labelForEstadoSlug(slug) {
        const map = {
            activo: 'Solo Activos',
            observacion: 'Solo Observación',
            pasivo: 'Solo Pasivos',
            disciplina: 'Solo Disciplina',
            catecumeno: 'Solo Catecúmenos',
            menor: 'Solo Menores',
            nuevo: 'Solo Nuevos creyentes',
        };
        return map[slug] || `Solo ${slug}`;
    }

    // Filtros
    function buildViewFilterOptions(reglasAplicadas, personas) {
        const allowed = new Set(['activo']);
        const r = reglasAplicadas || {};

        if (r.permite_observacion) allowed.add('observacion');
        if (r.permite_pasivos) allowed.add('pasivo');
        if (r.permite_disciplina) allowed.add('disciplina');
        if (r.permite_catecumenos) allowed.add('catecumeno');
        if (r.permite_menores) allowed.add('menor');

        (personas || []).forEach(p => {
            const st = normalizeEstadoSlug(p.estado_slug);
            if (st === 'nuevo') allowed.add('nuevo');
            if (st === 'menor') allowed.add('menor');
        });

        const ordered = ['activo', 'observacion', 'pasivo', 'disciplina', 'catecumeno', 'menor', 'nuevo']
            .filter(x => allowed.has(x));

        if (!viewSelect) return { ordered, defaultValue: 'todos' };

        const baseOptions = [
            { value: 'todos', label: 'Todos (según reglas)' },
            { value: 'no_activo', label: 'Ocultar activos' },
        ];
        const unidadOptions = [
            { value: 'en_unidad', label: 'Solo en unidad' },
            { value: 'fuera_unidad', label: 'Solo fuera de unidad' },
        ];
        const stateOptions = ordered.map(slug => ({
            value: slug,
            label: labelForEstadoSlug(slug),
        }));

        viewSelect.innerHTML = [
            ...baseOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
            ...unidadOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
            ...stateOptions.map(o => `<option value="${o.value}">${o.label}</option>`),
        ].join('');

        const nonActive = ordered.filter(x => x !== 'activo');
        const defaultValue = (nonActive.length === 1) ? nonActive[0] : 'todos';

        return { ordered, defaultValue };
    }

    function applyFilters() {
        const q = (searchInput?.value || '').toLowerCase().trim();
        const mode = viewSelect?.value || 'todos';
        const rows = tbody.querySelectorAll('tr[data-id]');
        let visibleCount = 0;

        rows.forEach(row => {
            const st = (row.dataset.estado || '').toLowerCase();
            const text = (row.innerText || '').toLowerCase();

            const matchSearch = !q || text.includes(q);

            let matchView = true;
            if (mode === 'todos') matchView = true;
            else if (mode === 'no_activo') matchView = (st !== 'activo');
            else if (mode === 'en_unidad') matchView = (row.dataset.enunidad === '1');
            else if (mode === 'fuera_unidad') matchView = (row.dataset.enunidad === '0');
            else matchView = (st === mode);

            const visible = matchSearch && matchView;
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        updateFooter(visibleCount);

        if (checkAll) {
            const visible = Array.from(document.querySelectorAll('#personas-tbody tr[data-id]'))
                .filter(r => r.style.display !== 'none');
            const allSelected = visible.length > 0 && visible.every(r => selectedIds.has(r.dataset.id));
            checkAll.classList.toggle('checked', allSelected);
        }
    }

    // Renderizado de filas
    function rowHTML(p) {
        const estadoSlug = normalizeEstadoSlug(p.estado_slug);
        const enUnidadBadge = p.ya_en_unidad
            ? `<span class="au-badge au-badge-info">En unidad · ${p.rol_en_unidad || '—'}</span>`
            : '';

        return `
            <tr data-id="${p.id}" data-estado="${estadoSlug}" data-enunidad="${p.ya_en_unidad ? '1' : '0'}">
                <td class="au-td-check">
                    <div class="au-checkbox" data-check="${p.id}">
                        <span class="material-icons">check</span>
                    </div>
                </td>
                <td>
                    <div class="au-person">
                        <div class="au-avatar">
                            <span class="material-icons">person</span>
                        </div>
                        <div class="au-person-info">
                            <span class="au-person-name">${p.nombre || '—'}</span>
                            <span class="au-person-code">${p.codigo || ''}</span>
                        </div>
                    </div>
                </td>


                <td class="au-td-center">
                    ${p.edad !== null && p.edad !== undefined ? p.edad : '—'}
                </td>
                <td class="au-td-center au-td-muted">${p.genero || "—"}</td>
                <td>
                    <span class="au-badge au-badge-${estadoSlug}">${p.estado || '—'}</span>
                    ${enUnidadBadge}
                </td>
                <td class="au-td-muted">${p.categoria || '—'}</td>
            </tr>
        `;
    }

    // Selección
    function attachSelectionHandlers() {
        tbody.querySelectorAll('.au-checkbox[data-check]').forEach(chk => {
            chk.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const id = chk.dataset.check;
                if (!id) return;

                chk.classList.toggle('checked');
                if (chk.classList.contains('checked')) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }
                updateSelectedUI();
                applyFilters();
            });
        });

        tbody.querySelectorAll('tr[data-id]').forEach(row => {
            row.addEventListener('click', (ev) => {
                if (ev.target.closest('.au-checkbox')) return;
                const id = row.dataset.id;
                const chk = row.querySelector(`.au-checkbox[data-check="${id}"]`);
                if (!chk) return;

                chk.classList.toggle('checked');
                if (chk.classList.contains('checked')) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }
                updateSelectedUI();
                applyFilters();
            });
        });

        if (checkAll) {
            checkAll.addEventListener('click', () => {
                const visibleRows = Array.from(tbody.querySelectorAll('tr[data-id]'))
                    .filter(r => r.style.display !== 'none');

                const allSelected = visibleRows.length > 0 && 
                    visibleRows.every(r => selectedIds.has(r.dataset.id));

                visibleRows.forEach(r => {
                    const id = r.dataset.id;
                    const chk = r.querySelector(`.au-checkbox[data-check="${id}"]`);
                    if (!chk) return;

                    if (allSelected) {
                        chk.classList.remove('checked');
                        selectedIds.delete(id);
                    } else {
                        chk.classList.add('checked');
                        selectedIds.add(id);
                    }
                });

                checkAll.classList.toggle('checked', !allSelected);
                updateSelectedUI();
            });
        }

        updateSelectedUI();
    }

    // API: Guardar y Cargar
    async function guardarYcargar() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;
        if (!unidadId || !rolId) return;

        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="material-icons au-spin">sync</span> Cargando...';

        try {
            const urlGuardar = "{% url 'estructura_app:asignacion_guardar_contexto' %}";
            const res1 = await fetch(urlGuardar, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({ unidad_id: unidadId, rol_id: rolId })
            });

            const data1 = await res1.json();
            if (!data1.ok) {
                clearSelection();
                renderEmpty(data1.error || "No se pudo guardar el contexto.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            const urlLista = "{% url 'estructura_app:asignacion_unidad_contexto' %}" + 
                `?unidad_id=${unidadId}&rol_id=${rolId}`;
            const res2 = await fetch(urlLista, { 
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });
            const data2 = await res2.json();

            if (!data2.ok) {
                clearSelection();
                renderEmpty(data2.error || "No se pudo cargar la lista.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            // Mostrar info de unidad
            unitInfo.classList.add('au-visible');
            infoTipo.textContent = data2.unidad?.tipo || "—";
            infoMiembros.textContent = data2.unidad?.miembros_actuales ?? 0;

            const personas = data2.personas || [];
            // Contexto de liderazgo
            const reglasUnidad = data2.unidad?.reglas_aplicadas || {};
            const permiteLiderazgo = !!reglasUnidad.permite_liderazgo;

            // Tipo de rol seleccionado
            const rolOption = selectRol.options[selectRol.selectedIndex];
            const rolTipo = rolOption?.dataset?.tipo || null;

            // Guardamos en estado global
            window.__contextoAsignacion = {
                permiteLiderazgo,
                rolTipo,
            };

            tbody.innerHTML = personas.map(rowHTML).join("");

            clearSelection();

            if (!personas.length) {
                renderEmpty("No hay personas disponibles según las reglas de esta unidad.");
                if (viewSelect) {
                    viewSelect.disabled = true;
                    viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
                }
                return;
            }

            if (viewSelect) {
                viewSelect.disabled = false;
                const { defaultValue } = buildViewFilterOptions(data2.unidad?.reglas_aplicadas, personas);
                viewSelect.value = defaultValue;
            }

            applyFilters();
            validarContextoLiderazgoUI();
            attachSelectionHandlers();


        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<span class="material-icons">sync</span> Cargar personas';
            updateGuardarState();
        }
    }

    function validarContextoLiderazgoUI() {
        const ctx = window.__contextoAsignacion;
        if (!ctx) return true;

        const { permiteLiderazgo, rolTipo } = ctx;

        // Limpieza visual por defecto
        selectRol.classList.remove('au-input-error');

        // Si el rol NO es liderazgo, no hacemos nada especial
        if (rolTipo !== 'LIDERAZGO') {
            return true;
        }

        // Rol es liderazgo pero la unidad NO lo permite
        if (!permiteLiderazgo) {
            selectRol.classList.add('au-input-error');

            if (btnAsignar) btnAsignar.disabled = true;
            if (btnRemover) btnRemover.disabled = true;

            renderEmpty(
                "Esta unidad no permite liderazgo. Activa la opción «Permite liderazgo» en la configuración de la unidad."
            );
            return false;
        }

        return true;
    }



    // API: Asignar
    async function aplicarAsignacion() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;

        if (!unidadId || !rolId) { alert("Selecciona unidad y rol."); return; }

        const ids = Array.from(selectedIds);
        if (!ids.length) { alert("Selecciona al menos una persona."); return; }

        if (btnAsignar) btnAsignar.disabled = true;

        try {
            const urlAplicar = "{% url 'estructura_app:asignacion_aplicar' %}";
            const res = await fetch(urlAplicar, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({ unidad_id: unidadId, rol_id: rolId, miembro_ids: ids })
            });

            let data;
            try { data = await res.json(); }
            catch { alert("Respuesta inválida del servidor."); return; }

            if (!data.ok) { alert(data.error || "No se pudo asignar."); return; }

            await guardarYcargar();
            alert(`Listo.\nCreados: ${data.creados}\nReactivados: ${data.reactivados}\nYa existían: ${data.ya_existian}`);
        } finally {
            if (btnAsignar) btnAsignar.disabled = false;
            updateSelectedUI();
        }
    }


    async function aplicarRemocion() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;

        if (!unidadId || !rolId) {
            alert("Selecciona unidad y rol.");
            return;
        }

        const ids = Array.from(selectedIds);
        if (!ids.length) {
            alert("Selecciona al menos una persona.");
            return;
        }

        openModalSalida();
    }

    async function ejecutarSalidaMasiva() {
        const unidadId = selectUnidad.value;
        const rolId = selectRol.value;

        const ids = Array.from(selectedIds);
        if (!ids.length) {
            alert("No hay seleccionados.");
            closeModalSalida();
            return;
        }

        const fecha = (salidaFecha?.value || '').trim();
        const motivo = (salidaMotivo?.value || '').trim();
        const notas = (salidaNotas?.value || '').trim();
        const confirmado = !!salidaConfirm?.checked;

        if (!fecha) {
            alert("Selecciona la fecha de salida.");
            return;
        }
        if (!motivo) {
            alert("Selecciona un motivo.");
            return;
        }
        if (!confirmado) {
            alert("Debes confirmar la salida.");
            return;
        }

        if (btnRemover) btnRemover.disabled = true;
        if (modalAplicar) modalAplicar.disabled = true;

        try {
            const urlRemover = "{% url 'estructura_app:asignacion_remover' %}";
            const res = await fetch(urlRemover, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({
                    unidad_id: unidadId,
                    rol_id: rolId,
                    miembro_ids: ids,
                    fecha_salida: fecha,
                    motivo: motivo,
                    notas: notas
                })
            });

            let data;
            try {
                data = await res.json();
            } catch (e) {
                alert("Respuesta inválida del servidor.");
                return;
            }

            if (!data.ok) {
                alert(data.error || "No se pudo remover.");
                return;
            }

            closeModalSalida();
            await guardarYcargar();
            alert(`Listo.\nRemovidos: ${data.removidos}`);
        } finally {
            if (btnRemover) btnRemover.disabled = false;
            if (modalAplicar) modalAplicar.disabled = false;
            updateSelectedUI();
        }
    }


    // Event Listeners
    selectUnidad.addEventListener('change', () => {
        updateGuardarState();
        unitInfo.classList.toggle('au-visible', !!selectUnidad.value);
        clearSelection();
        renderEmpty("Selecciona un rol y pulsa «Cargar personas»");

        if (viewSelect) {
            viewSelect.disabled = true;
            viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
            viewSelect.value = 'todos';
        }
    });

    selectRol.addEventListener('change', () => {
        updateGuardarState();
        clearSelection();
        renderEmpty("Pulsa «Cargar personas» para ver la lista según reglas.");

        if (viewSelect) {
            viewSelect.disabled = true;
            viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
            viewSelect.value = 'todos';
        }
    });

    btnGuardar.addEventListener('click', guardarYcargar);
    if (btnAsignar) btnAsignar.addEventListener('click', aplicarAsignacion);
    if (btnRemover) btnRemover.addEventListener('click', aplicarRemocion);

    // Modal events
    if (modalClose) modalClose.addEventListener('click', closeModalSalida);
    if (modalCancel) modalCancel.addEventListener('click', closeModalSalida);

    // Click fuera
    const backdrop = modalSalida?.querySelector('.au-modal-backdrop');
    if (backdrop) backdrop.addEventListener('click', closeModalSalida);

    if (modalAplicar) modalAplicar.addEventListener('click', ejecutarSalidaMasiva);


    if (viewSelect) viewSelect.addEventListener('change', applyFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);

    // Estado inicial
    unitInfo.classList.remove('au-visible');
    renderEmpty("Selecciona una unidad y un rol para comenzar");
    updateGuardarState();
    clearSelection();

    if (viewSelect) {
        viewSelect.disabled = true;
        viewSelect.innerHTML = `<option value="todos">Todos (según reglas)</option>`;
        viewSelect.value = 'todos';
    }
});
</script>

<!-- ══════════════════════════════════════════════════════════════════════════
     ESTILOS
     ══════════════════════════════════════════════════════════════════════════ -->
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   VARIABLES
   ═══════════════════════════════════════════════════════════════════════════ */
.au-page {
    --au-primary: #017e84;
    --au-primary-dark: #016166;
    --au-success: #28a745;
    --au-danger: #dc3545;
    --au-gray-100: #f8f9fa;
    --au-gray-200: #e9ecef;
    --au-gray-300: #dee2e6;
    --au-gray-500: #6c757d;
    --au-gray-700: #495057;
    --au-gray-900: #212529;
    --au-radius: 8px;
    --au-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

/* ═══════════════════════════════════════════════════════════════════════════
   PAGE LAYOUT
   ═══════════════════════════════════════════════════════════════════════════ */
.au-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTROL BAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    margin-bottom: 20px;
    box-shadow: var(--au-shadow);
}

.au-control-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.au-btn-back {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    color: var(--au-gray-700);
    text-decoration: none;
    transition: all 0.15s;
}

.au-btn-back:hover {
    background: var(--au-gray-200);
    color: var(--au-primary);
}

.au-title-group h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--au-gray-900);
}

.au-subtitle {
    font-size: 12px;
    color: var(--au-gray-500);
}

.au-selected-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--au-primary);
    color: #fff;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    opacity: 0;
    transform: scale(0.9);
    transition: all 0.2s;
}

.au-selected-badge.au-visible {
    opacity: 1;
    transform: scale(1);
}

.au-selected-badge .material-icons {
    font-size: 16px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   MAIN LAYOUT
   ═══════════════════════════════════════════════════════════════════════════ */
.au-layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-sidebar {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 16px;
    align-items: start;
    overflow: visible;
}

.au-card {
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    overflow: visible;
    box-shadow: var(--au-shadow);
}

.au-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-bottom: 1px solid var(--au-gray-200);
    font-size: 13px;
    font-weight: 600;
    color: var(--au-gray-700);
}

.au-card-header .material-icons {
    font-size: 18px;
    color: var(--au-primary);
}

.au-card-body {
    padding: 16px;
    overflow: visible;
}

.au-card-actions {
    padding: 16px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   FORM FIELDS
   ═══════════════════════════════════════════════════════════════════════════ */
.au-field {
    margin-bottom: 0;
}

.au-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 500;
    color: var(--au-gray-700);
}

.au-field select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 14px;
    color: var(--au-gray-900);
    background: #fff;
    cursor: pointer;
    transition: border-color 0.15s;
}

.au-field select:focus {
    outline: none;
    border-color: var(--au-primary);
}

/* ═══════════════════════════════════════════════════════════════════════════
   DROPDOWN JERÁRQUICO DE UNIDADES
   ═══════════════════════════════════════════════════════════════════════════ */
.unit-dropdown {
    position: relative;
    width: 100%;
    z-index: 100;
}

.unit-dropdown.open {
    z-index: 9999;
}

.unit-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px 12px;
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 14px;
    color: var(--au-gray-700);
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
    min-height: 42px;
}

.unit-trigger:hover {
    border-color: var(--au-gray-500);
}

.unit-trigger:focus {
    outline: none;
    border-color: var(--au-primary);
    box-shadow: 0 0 0 2px rgba(1, 126, 132, 0.15);
}

.unit-trigger-text {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.unit-arrow {
    font-size: 20px;
    color: var(--au-gray-500);
    transition: transform 0.2s ease;
}

.unit-dropdown.open .unit-arrow {
    transform: rotate(180deg);
}

.unit-panel {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    min-width: 450px;
    width: max-content;
    max-width: 550px;
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: 8px;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    z-index: 9999;
    display: none;
    max-height: 400px;
    overflow: hidden;
}

.unit-dropdown.open .unit-panel {
    display: block;
    animation: unitDropdownIn 0.15s ease;
}

@keyframes unitDropdownIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
}

.unit-search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--au-gray-200);
    background: var(--au-gray-100);
}

.unit-search-box .material-icons {
    font-size: 18px;
    color: var(--au-gray-500);
}

.unit-search-box input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 13px;
    outline: none;
    color: var(--au-gray-900);
}

.unit-search-box input::placeholder {
    color: var(--au-gray-500);
}

.unit-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 6px;
}

.unit-option {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s ease;
}

.unit-option:hover {
    background: var(--au-gray-100);
}

.unit-option.selected {
    background: #e8f4f4;
}

.unit-option.hidden {
    display: none;
}

.unit-indent {
    flex-shrink: 0;
}

.unit-connector {
    flex-shrink: 0;
    color: var(--au-gray-300);
    font-size: 12px;
    font-family: monospace;
    margin-right: 2px;
}

.unit-icon {
    flex-shrink: 0;
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    background: var(--au-gray-200);
}

.unit-icon .material-icons {
    font-size: 15px;
    color: var(--au-gray-700);
}

.unit-name {
    flex: 1;
    font-size: 13px;
    font-weight: 500;
    color: var(--au-gray-900);
    white-space: nowrap;
}

.unit-badge {
    flex-shrink: 0;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border-radius: 3px;
    background: var(--au-gray-200);
    color: var(--au-gray-700);
}

/* Colores por categoría */
.unit-badge[data-cat="congregacion"],
.unit-badge[data-cat="iglesia"] {
    background: #cfe2ff;
    color: #084298;
}

.unit-badge[data-cat="ministerio"] {
    background: #d1e7dd;
    color: #0f5132;
}

.unit-badge[data-cat="celula"],
.unit-badge[data-cat="grupo"],
.unit-badge[data-cat="pequeno-grupo"] {
    background: #fff3cd;
    color: #664d03;
}

.unit-badge[data-cat="departamento"] {
    background: #e2d9f3;
    color: #59359a;
}

.unit-badge[data-cat="zona"],
.unit-badge[data-cat="region"],
.unit-badge[data-cat="area"] {
    background: #f8d7da;
    color: #842029;
}

.unit-badge[data-cat="comision"],
.unit-badge[data-cat="comite"],
.unit-badge[data-cat="junta"] {
    background: #cff4fc;
    color: #055160;
}

.unit-badge[data-cat="servicio"],
.unit-badge[data-cat="equipo"] {
    background: #e2e3e5;
    color: #41464b;
}

.unit-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 24px;
    color: var(--au-gray-500);
    font-size: 13px;
}

.unit-trigger.has-selection {
    color: var(--au-gray-900);
}

.unit-trigger.has-selection .unit-trigger-icon {
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--au-gray-200);
    border-radius: 3px;
}

.unit-trigger.has-selection .unit-trigger-icon .material-icons {
    font-size: 14px;
    color: var(--au-gray-700);
}

.unit-trigger .unit-badge {
    margin-left: auto;
    margin-right: 8px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   UNIT INFO
   ═══════════════════════════════════════════════════════════════════════════ */
.au-unit-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--au-gray-100);
    border-radius: 6px;
    display: none;
}

.au-unit-info.au-visible {
    display: block;
}

.au-info-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 13px;
}

.au-info-label {
    color: var(--au-gray-500);
}

.au-info-value {
    font-weight: 500;
    color: var(--au-gray-900);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BUTTONS
   ═══════════════════════════════════════════════════════════════════════════ */
.au-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}

.au-btn .material-icons {
    font-size: 18px;
}

.au-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.au-btn-primary {
    background: var(--au-primary);
    color: #fff;
}

.au-btn-primary:hover:not(:disabled) {
    background: var(--au-primary-dark);
}

.au-btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.au-btn-success {
    background: var(--au-success);
    color: #fff;
}

.au-btn-success:hover:not(:disabled) {
    background: #218838;
}

.au-btn-danger {
    background: var(--au-danger);
    color: #fff;
}

.au-btn-danger:hover:not(:disabled) {
    background: #c82333;
}

.au-btn-light {
    background: var(--au-gray-200);
    color: var(--au-gray-700);
}

.au-btn-light:hover:not(:disabled) {
    background: var(--au-gray-300);
}

/* ═══════════════════════════════════════════════════════════════════════════
   CONTENT AREA
   ═══════════════════════════════════════════════════════════════════════════ */
.au-content {
    background: #fff;
    border: 1px solid var(--au-gray-300);
    border-radius: var(--au-radius);
    overflow: hidden;
    box-shadow: var(--au-shadow);
}

/* ═══════════════════════════════════════════════════════════════════════════
   TOOLBAR
   ═══════════════════════════════════════════════════════════════════════════ */
.au-toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-bottom: 1px solid var(--au-gray-200);
}

.au-search {
    flex: 1;
    position: relative;
}

.au-search .material-icons {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: var(--au-gray-500);
}

.au-search-input {
    width: 100%;
    padding: 8px 12px 8px 40px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
}

.au-search-input:focus {
    outline: none;
    border-color: var(--au-primary);
}

.au-filter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.au-filter label {
    font-size: 13px;
    color: var(--au-gray-500);
    white-space: nowrap;
}

.au-filter select {
    padding: 8px 12px;
    border: 1px solid var(--au-gray-300);
    border-radius: 6px;
    font-size: 13px;
    background: #fff;
    cursor: pointer;
}

.au-filter select:focus {
    outline: none;
    border-color: var(--au-primary);
}

.au-filter select:disabled {
    background: var(--au-gray-100);
    cursor: not-allowed;
}

/* ═══════════════════════════════════════════════════════════════════════════
   TABLE
   ═══════════════════════════════════════════════════════════════════════════ */
.au-table-wrapper {
    overflow-x: auto;
}

.au-table {
    width: 100%;
    border-collapse: collapse;
}

.au-table th,
.au-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--au-gray-200);
}

.au-table th {
    font-size: 11px;
    font-weight: 600;
    color: var(--au-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--au-gray-100);
}

.au-table tbody tr {
    transition: background 0.1s;
    cursor: pointer;
}

.au-table tbody tr:hover {
    background: var(--au-gray-100);
}

.au-th-check,
.au-td-check {
    width: 48px;
    text-align: center;
}

.au-th-sm { width: 70px; }
.au-th-md { width: 130px; }

.au-td-center { text-align: center; color: var(--au-gray-700); }
.au-td-muted { color: var(--au-gray-500); font-size: 13px; }

/* ═══════════════════════════════════════════════════════════════════════════
   CHECKBOX
   ═══════════════════════════════════════════════════════════════════════════ */
.au-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--au-gray-300);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
}

.au-checkbox .material-icons {
    font-size: 14px;
    color: transparent;
    transition: color 0.15s;
}

.au-checkbox:hover {
    border-color: var(--au-primary);
}

.au-checkbox.checked {
    background: var(--au-primary);
    border-color: var(--au-primary);
}

.au-checkbox.checked .material-icons {
    color: #fff;
}

/* ═══════════════════════════════════════════════════════════════════════════
   PERSON CELL
   ═══════════════════════════════════════════════════════════════════════════ */
.au-person {
    display: flex;
    align-items: center;
    gap: 12px;
}

.au-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e8f4f4 0%, #d4e8e8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.au-avatar .material-icons {
    font-size: 20px;
    color: var(--au-primary);
    opacity: 0.7;
}

.au-person-name {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--au-gray-900);
}

.au-person-code {
    font-size: 12px;
    color: var(--au-gray-500);
}

/* ═══════════════════════════════════════════════════════════════════════════
   BADGES
   ═══════════════════════════════════════════════════════════════════════════ */
.au-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-right: 4px;
}

.au-badge-activo { background: #d4edda; color: #155724; }
.au-badge-observacion { background: #fff3cd; color: #856404; }
.au-badge-pasivo { background: #f8d7da; color: #721c24; }
.au-badge-disciplina { background: #f5c6cb; color: #721c24; }
.au-badge-catecumeno { background: #cce5ff; color: #004085; }
.au-badge-menor { background: #e2e3e5; color: #383d41; }
.au-badge-nuevo { background: #d1ecf1; color: #0c5460; }
.au-badge-info { background: #d4edda; color: #155724; }

/* ═══════════════════════════════════════════════════════════════════════════
   EMPTY STATE
   ═══════════════════════════════════════════════════════════════════════════ */
.au-empty {
    padding: 60px 24px;
    text-align: center;
    color: var(--au-gray-500);
}

.au-empty .material-icons {
    font-size: 48px;
    color: var(--au-gray-300);
    margin-bottom: 12px;
}

.au-empty p {
    margin: 0;
    font-size: 14px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   FOOTER
   ═══════════════════════════════════════════════════════════════════════════ */
.au-footer {
    padding: 12px 16px;
    background: var(--au-gray-100);
    border-top: 1px solid var(--au-gray-200);
    font-size: 13px;
    color: var(--au-gray-500);
}

/* ═══════════════════════════════════════════════════════════════════════════
   ANIMATIONS
   ═══════════════════════════════════════════════════════════════════════════ */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.au-spin {
    animation: spin 1s linear infinite;
}

/* ═══════════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════ */
@media (max-width: 900px) {
    .au-sidebar {
        grid-template-columns: 1fr 1fr;
    }

    .au-card-actions {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: flex-start;
    }

    .au-toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .au-filter {
        justify-content: flex-end;
    }
}

@media (max-width: 600px) {
    .au-page {
        padding: 12px;
    }

    .au-sidebar {
        grid-template-columns: 1fr;
    }

    .au-card-actions {
        flex-direction: column;
    }

    .au-control-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .au-control-right {
        align-self: flex-end;
    }
}

.au-input-error {
    border-color: #dc3545 !important;
    background: #fff5f5 !important;
}

/* ═══════════════════════════════════════════════════════════════════════════
   MODAL (Salida masiva)
   ═══════════════════════════════════════════════════════════════════════════ */
.au-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
}

.au-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, .45);
    backdrop-filter: blur(2px);
}

.au-modal-card {
    position: relative;
    width: min(620px, calc(100% - 24px));
    margin: 56px auto;
    background: #fff;
    border: 1px solid var(--au-gray-200);
    border-radius: var(--au-radius);
    box-shadow: 0 12px 40px rgba(2, 6, 23, .18);
    overflow: hidden;
}

.au-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 16px;
    background: var(--au-gray-100);
    border-bottom: 1px solid var(--au-gray-200);
}

.au-modal-header h3 {
    margin: 0;
    font-size: 15px;
    font-weight: 650;
    color: var(--au-gray-900);
    letter-spacing: .2px;
}

.au-modal-body {
    padding: 16px;
}

.au-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 14px 16px;
    background: var(--au-gray-100);
    border-top: 1px solid var(--au-gray-200);
}

.au-label {
    display: block;
    margin: 10px 0 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--au-gray-500);
}

.au-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--au-gray-200);
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    color: var(--au-gray-900);
}

.au-input:focus {
    outline: none;
    border-color: var(--au-primary);
    box-shadow: 0 0 0 3px rgba(1, 126, 132, .15);
}

.au-muted {
    color: var(--au-gray-500);
    font-size: 13px;
    margin: 0 0 12px;
}

.au-modal-header .au-btn {
    padding: 8px 10px;
    border-radius: 6px;
}
</style>

<!-- Modal Salida Masiva -->
<div id="au-modal-salida" class="au-modal" style="display:none;">
    <div class="au-modal-backdrop"></div>
    <div class="au-modal-card">
        <div class="au-modal-header">
            <h3>Dar salida (en masa)</h3>
            <button type="button" id="au-modal-close" class="au-btn au-btn-light">Cerrar</button>
        </div>

        <div class="au-modal-body">
            <p id="au-salida-resumen" class="au-muted"></p>

            <label class="au-label">Fecha de salida</label>
            <input type="date" id="au-salida-fecha" class="au-input">

            <label class="au-label" style="margin-top:10px;">Motivo</label>
            <select id="au-salida-motivo" class="au-input">
                <option value="">— Selecciona —</option>
                <option value="Cierre de unidad">Cierre de unidad</option>
                <option value="Reorganización">Reorganización</option>
                <option value="Traslado">Traslado</option>
                <option value="Fin de período">Fin de período</option>
                <option value="Error de asignación">Error de asignación</option>
                <option value="Cambio de Estado">Cambio de Estado</option>
                <option value="Otro">Otro</option>
            </select>

            <label class="au-label" style="margin-top:10px;">Notas (opcional)</label>
            <textarea id="au-salida-notas" class="au-input" rows="3" placeholder="Detalle adicional…"></textarea>

            <label style="display:flex; gap:10px; align-items:center; margin-top:12px;">
                <input type="checkbox" id="au-salida-confirm">
                <span>Confirmo que deseo dar salida a los seleccionados</span>
            </label>
        </div>

        <div class="au-modal-footer">
            <button type="button" id="au-salida-cancel" class="au-btn au-btn-light">Cancelar</button>
            <button type="button" id="au-salida-aplicar" class="au-btn au-btn-danger">Confirmar salida</button>
        </div>
    </div>
</div>

{% endblock %}