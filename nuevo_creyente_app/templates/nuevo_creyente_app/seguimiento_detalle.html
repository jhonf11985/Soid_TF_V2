{% extends "core/base_sidebar.html" %}
{% load static %}

{% block title %}{{ miembro.nombres }} | Seguimiento{% endblock %}

{% block sidebar_icon %}group_add{% endblock %}
{% block sidebar_role_label %}Nuevo Creyente{% endblock %}

{% block sidebar_menu %}
<a class="sidebar-link" href="{% url 'nuevo_creyente_app:nuevo_creyente' %}">
  <span class="material-icons">dashboard</span>
  <span>Dashboard</span>
</a>
<a class="sidebar-link active" href="{% url 'nuevo_creyente_app:seguimiento_lista' %}">
  <span class="material-icons">list</span>
  <span>En seguimiento</span>
</a>
{% endblock %}

{% block page_content %}

<div class="mobile-app">

    <!-- HEADER -->
    <header class="mobile-header">
        <a href="{% url 'nuevo_creyente_app:seguimiento_lista' %}" class="mobile-back">
            <span class="material-icons">arrow_back</span>
        </a>
        <div class="mobile-header-title">Seguimiento</div>
        <div class="mobile-header-actions">
            {% if miembro.whatsapp %}
            <a href="https://wa.me/{{ miembro.whatsapp|cut:' '|cut:'-' }}" class="mobile-header-btn whatsapp" target="_blank">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.486 2 2 6.486 2 12c0 1.86.507 3.599 1.387 5.106L2 22l5.043-1.356A9.93 9.93 0 0 0 12 22c5.514 0 10-4.486 10-10S17.514 2 12 2z"/>
                </svg>
            </a>
            {% endif %}
            {% if miembro.telefono or miembro.whatsapp %}
            <a href="tel:{{ miembro.telefono|default:miembro.whatsapp }}" class="mobile-header-btn phone">
                <span class="material-icons">phone</span>
            </a>
            {% endif %}
        </div>
    </header>

    <!-- PERFIL -->
    <div class="profile-card">
        <div class="profile-avatar" style="background: {% if miembro.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
            {% if miembro.foto %}
                <img src="{{ miembro.foto.url }}" alt="{{ miembro.nombres }}">
            {% else %}
                <span>{{ miembro.nombres|slice:":1"|upper }}</span>
            {% endif %}
        </div>
        <div class="profile-info">
            <h1 class="profile-name">{{ miembro.nombres }} {{ miembro.apellidos }}</h1>
            <div class="profile-badges">
                {% if expediente.estado == "CERRADO" %}
                    <span class="badge badge-neutral"><span class="material-icons">lock</span> Cerrado</span>
                {% else %}
                    <span class="badge badge-info">{{ expediente.get_etapa_display }}</span>
                {% endif %}

                {% if miembro.edad %}
                    <span class="badge badge-light">{{ miembro.edad }} años</span>
                {% endif %}

                {# NUEVO: alerta siempre visible si no hay padre espiritual #}
                {% if expediente.estado != "CERRADO" %}
                    {% if not expediente.padres_links.all %}
                        <span class="badge badge-warning">
                            <span class="material-icons">person_off</span>
                            Sin padre espiritual
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- PRÓXIMA ACCIÓN -->
    {% if expediente.estado != "CERRADO" %}
    <div class="next-action-card">
        <div class="next-action-icon">
            <span class="material-icons">schedule</span>
        </div>
        <div class="next-action-content">
            <span class="next-action-label">Próximo contacto</span>
            <span class="next-action-date">
                {% if expediente.proximo_contacto %}
                    {{ expediente.proximo_contacto|date:"d M Y" }}
                {% else %}
                    Sin programar
                {% endif %}
            </span>
        </div>

        <div class="next-action-right">
            {% if expediente.responsable %}
            <div class="next-action-responsible">
                <span class="material-icons">person</span>
                {{ expediente.responsable.nombres|truncatewords:1 }}
            </div>
            {% endif %}

            <button type="button" class="btn-mini" id="btn-open-agendar">
                <span class="material-icons">edit_calendar</span>
                Reagendar
            </button>
        </div>
    </div>
    {% endif %}

    <!-- STEPPER -->
    <div class="stepper-container">
        <div class="stepper-track">
            {% for e in expediente.ETAPAS_ORDEN %}
            <div class="stepper-item {% if expediente.etapa == e %}is-current{% endif %} {% if expediente.etapa_index > forloop.counter0 %}is-done{% endif %}">
                <div class="stepper-dot">
                    {% if expediente.etapa_index > forloop.counter0 %}
                        <span class="material-icons">check</span>
                    {% else %}
                        {{ forloop.counter }}
                    {% endif %}
                </div>
                <span class="stepper-label">
                    {% if e == "INICIO" %}Inicio
                    {% elif e == "PRIMER_CONTACTO" %}Contacto
                    {% elif e == "ACOMPANAMIENTO" %}Acompañ.
                    {% elif e == "INTEGRACION" %}Integrac.
                    {% elif e == "EVALUACION" %}Evaluac.
                    {% elif e == "CIERRE" %}Cierre
                    {% else %}{{ e }}{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- TABS (más claro) -->
    <div class="mobile-tabs">
        <button class="mobile-tab" data-tab="actividad">
            <span class="material-icons">history</span>
            <span>Actividad</span>
        </button>
        <button class="mobile-tab" data-tab="datos">
            <span class="material-icons">info</span>
            <span>Datos</span>
        </button>
        <button class="mobile-tab" data-tab="gestionar">
            <span class="material-icons">tune</span>
            <span>Gestionar</span>
        </button>
    </div>

    <div class="mobile-content">

        <!-- TAB: ACTIVIDAD (antes Historial) -->
        <div class="tab-panel" id="tab-actividad">
            <div class="timeline">
                {% regroup expediente.bitacora.all by fecha|date:"d M Y" as items_by_date %}

                {% for date_group in items_by_date %}
                <div class="timeline-date">{{ date_group.grouper }}</div>

                {% for item in date_group.list %}
                <div class="timeline-item {% if item.tipo == 'nota' %}is-note{% endif %}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-author">
                                {% if item.autor %}{{ item.autor.nombres }}{% else %}Sistema{% endif %}
                            </span>
                            <span class="timeline-time">{{ item.fecha|date:"g:i a" }}</span>
                        </div>
                        {% if item.titulo %}
                        <div class="timeline-title">{{ item.titulo }}</div>
                        {% endif %}
                        <div class="timeline-body">{{ item.detalle|default:""|truncatewords:30 }}</div>
                        {% if item.canal or item.resultado_contacto %}
                        <div class="timeline-tags">
                            {% if item.canal %}<span class="timeline-tag">{{ item.canal }}</span>{% endif %}
                            {% if item.resultado_contacto %}<span class="timeline-tag">{{ item.resultado_contacto }}</span>{% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% empty %}
                <div class="empty-state">
                    <span class="material-icons">forum</span>
                    <p>Sin registros aún</p>
                    <span class="empty-hint">Las acciones aparecerán aquí</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- TAB: DATOS (antes Info) -->
        <div class="tab-panel" id="tab-datos">

            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">person</span>
                    Datos personales
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Nombre</span>
                        <span class="info-value">{{ miembro.nombres }} {{ miembro.apellidos }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Edad</span>
                        <span class="info-value">{{ miembro.edad|default:"—" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Género</span>
                        <span class="info-value">{{ miembro.get_genero_display|default:"—" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Teléfono</span>
                        <span class="info-value">
                            {% if miembro.telefono or miembro.whatsapp %}
                            <a href="tel:{{ miembro.telefono|default:miembro.whatsapp }}">{{ miembro.telefono|default:miembro.whatsapp }}</a>
                            {% else %}—{% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">
                            {% if miembro.email %}
                            <a href="mailto:{{ miembro.email }}">{{ miembro.email|truncatechars:25 }}</a>
                            {% else %}—{% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Conversión</span>
                        <span class="info-value">{% if miembro.fecha_conversion %}{{ miembro.fecha_conversion|date:"d/m/Y" }}{% else %}—{% endif %}</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">folder_open</span>
                    Expediente
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Estado</span>
                        <span class="info-value">
                            <span class="badge {% if expediente.estado == 'CERRADO' %}badge-success{% else %}badge-info{% endif %}">
                                {{ expediente.get_estado_display }}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Responsable</span>
                        <span class="info-value">{{ expediente.responsable|default:"—" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Unidad</span>
                        <span class="info-value">{{ expediente.unidad_responsable|default:"—" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha envío</span>
                        <span class="info-value">{{ expediente.fecha_envio|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Código</span>
                        <span class="info-value">{{ miembro.codigo_seguimiento|default:"—" }}</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">volunteer_activism</span>
                    Padres espirituales (solo lectura)
                </h3>
                {% if expediente.padres_links.all %}
                    <div class="assign-list">
                        {% for link in expediente.padres_links.all %}
                        <div class="assign-item">
                            <div class="assign-avatar" style="background: {% if link.padre.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
                                {{ link.padre.nombres|slice:":1"|upper }}
                            </div>
                            <span class="assign-name">{{ link.padre.nombres }} {{ link.padre.apellidos }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="assign-empty-small" style="margin:0;">
                        <span class="material-icons">person_off</span>
                        <span>Sin padres asignados</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- TAB: GESTIONAR (antes Más) -->
        <div class="tab-panel" id="tab-gestionar">

            {% if expediente.estado != "CERRADO" %}
            <!-- Acciones rápidas de gestión -->
            <div class="options-section">
                <h3 class="options-title">Gestión rápida</h3>
                <div class="manage-actions">
                    <button type="button" class="btn-secondary btn-block" id="btn-open-etapa">
                        <span class="material-icons">flag</span>
                        Cambiar etapa
                    </button>
                    <button type="button" class="btn-secondary btn-block" id="btn-open-agendar-2">
                        <span class="material-icons">event</span>
                        Agendar próximo contacto
                    </button>
                </div>
                <div class="manage-hint">
                    Usa “Cambiar etapa” solo cuando la persona avanzó de verdad (no por agendar).
                </div>
            </div>
            {% endif %}

            <!-- Padres espirituales -->
            {% if expediente.estado != "CERRADO" %}
            <div class="options-section">
                <h3 class="options-title">Padres espirituales</h3>

                {% if expediente.padres_links.all %}
                <div class="assign-list-editable">
                    {% for link in expediente.padres_links.all %}
                    <div class="assign-item-edit">
                        <div class="assign-avatar" style="background: {% if link.padre.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
                            {{ link.padre.nombres|slice:":1"|upper }}
                        </div>
                        <div class="assign-info">
                            <span class="assign-name">{{ link.padre.nombres }} {{ link.padre.apellidos }}</span>
                            <span class="assign-code">{{ link.padre.codigo|default:"Sin código" }}</span>
                        </div>
                        <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_padre_remove' miembro.id link.padre.id %}">
                            {% csrf_token %}
                            <button type="submit" class="assign-remove" onclick="return confirm('¿Quitar este padre espiritual?');">
                                <span class="material-icons">close</span>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="assign-empty-small">
                    <span class="material-icons">person_off</span>
                    <span>Sin padres asignados</span>
                </div>
                {% endif %}

                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_padre_add' miembro.id %}" class="assign-add-section">
                    {% csrf_token %}
                    <label>Añadir padre espiritual</label>
                    <div class="assign-add-row">
                        <div
                            class="autocomplete-wrapper"
                            data-autocomplete-id="id_padre_espiritual"
                            data-endpoint="/api/buscar-miembros/"
                            data-filtro="activos"
                            data-limit="15"
                        >
                            <input type="hidden" name="padre_espiritual_id" id="id_padre_espiritual" value="">

                            <div class="autocomplete-field">
                                <div class="autocomplete-chip" style="display:none;">
                                    <div class="chip-avatar"></div>
                                    <div class="chip-text">
                                        <div class="chip-name"></div>
                                        <div class="chip-code"></div>
                                    </div>
                                    <button type="button" class="chip-remove" title="Quitar">×</button>
                                </div>

                                <input
                                    type="text"
                                    class="autocomplete-search input"
                                    placeholder="Buscar miembro..."
                                    autocomplete="off"
                                >
                            </div>

                            <div class="autocomplete-dropdown">
                                <div class="autocomplete-loading" style="display:none;">Buscando…</div>
                                <ul class="autocomplete-list"></ul>
                                <div class="autocomplete-empty" style="display:none;">Sin resultados</div>
                            </div>
                        </div>

                        <button type="submit" class="btn-add-padre">
                            <span class="material-icons">person_add</span>
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Ajustes -->
            {% if expediente.estado != "CERRADO" %}
            <div class="options-section">
                <h3 class="options-title">Ajustes</h3>
                <form method="post" class="mobile-form">
                    {% csrf_token %}

                    <div class="form-group">
                        <label>Unidad responsable</label>
                        {{ form.unidad_responsable }}
                    </div>

                    <div class="form-group">
                        <label>Responsable</label>
                        {{ form.responsable }}
                    </div>

                    <div class="form-group">
                        <label>Notas del expediente</label>
                        {{ form.notas }}
                    </div>

                    <button type="submit" class="btn-secondary btn-block">
                        <span class="material-icons">save</span>
                        Guardar cambios
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Cerrar -->
            {% if expediente.estado != "CERRADO" and expediente.puede_cerrar %}
            <div class="options-section danger-zone">
                <h3 class="options-title">Cerrar seguimiento</h3>
                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_cerrar' miembro.id %}" class="mobile-form">
                    {% csrf_token %}

                    <div class="form-group">
                        <label>Resultado final</label>
                        <select name="resultado_final" required>
                            <option value="">Seleccionar</option>
                            <option value="integrado_celula">Integrado a célula</option>
                            <option value="inicio_discipulado">Inició discipulado</option>
                            <option value="congrega_regular">Se congrega regularmente</option>
                            <option value="trasladado">Trasladado a otra iglesia</option>
                            <option value="no_responde">No respondió</option>
                            <option value="rechazo">Rechazó seguimiento</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nota de cierre</label>
                        <textarea name="nota_cierre" rows="2" required placeholder="Resumen breve del cierre..."></textarea>
                    </div>

                    <button type="submit" class="btn-danger btn-block" onclick="return confirm('¿Confirmas cerrar este seguimiento?');">
                        <span class="material-icons">lock</span>
                        Cerrar seguimiento
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Información del sistema -->
            <div class="options-section">
                <h3 class="options-title">Información</h3>
                <div class="info-grid compact">
                    <div class="info-item">
                        <span class="info-label">Última actualización</span>
                        <span class="info-value">{{ expediente.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if expediente.fecha_cierre %}
                    <div class="info-item">
                        <span class="info-label">Fecha de cierre</span>
                        <span class="info-value">{{ expediente.fecha_cierre|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

    </div>
</div>

<!-- MODAL: AGENDAR -->
<div class="modal-overlay" id="modal-agendar" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="material-icons">event</span>
        Agendar próximo contacto
      </div>
      <button type="button" class="modal-close" data-close-modal="modal-agendar">
        <span class="material-icons">close</span>
      </button>
    </div>

    <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_accion' miembro.id %}">
      {% csrf_token %}
      <input type="hidden" name="accion_rapida" value="agendar">

      <div class="modal-body">
        <div class="form-group">
          <label>Fecha del próximo contacto</label>
          <input type="date" name="proximo_contacto" required value="{% if expediente.proximo_contacto %}{{ expediente.proximo_contacto|date:'Y-m-d' }}{% endif %}">
        </div>

        <div class="form-group">
          <label>Nota (opcional)</label>
          <textarea name="nota" rows="2" placeholder="Ej: Confirmó que estará disponible en la tarde..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" data-close-modal="modal-agendar">Cancelar</button>
        <button type="submit" class="btn-primary">
          <span class="material-icons">save</span>
          Guardar agenda
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: CAMBIAR ETAPA -->
{% if expediente.estado != "CERRADO" %}
<div class="modal-overlay" id="modal-etapa" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="material-icons">flag</span>
        Cambiar etapa
      </div>
      <button type="button" class="modal-close" data-close-modal="modal-etapa">
        <span class="material-icons">close</span>
      </button>
    </div>

    <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_set_etapa' miembro.id %}">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group">
          <label>Nueva etapa</label>
          <select name="etapa" required>
            {% for e in expediente.ETAPAS_ORDEN %}
              <option value="{{ e }}" {% if expediente.etapa == e %}selected{% endif %}>
                {% if e == "INICIO" %}Inicio
                {% elif e == "PRIMER_CONTACTO" %}Primer contacto
                {% elif e == "ACOMPANAMIENTO" %}Acompañamiento
                {% elif e == "INTEGRACION" %}Integración
                {% elif e == "EVALUACION" %}Evaluación
                {% elif e == "CIERRE" %}Cierre
                {% else %}{{ e }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Motivo (opcional)</label>
          <textarea name="nota_etapa" rows="2" placeholder="Ej: Ya fue a célula y está estable..."></textarea>
          <div class="helper-small">Si tu view todavía no usa “nota_etapa”, luego lo conectamos para guardarlo en bitácora.</div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" data-close-modal="modal-etapa">Cancelar</button>
        <button type="submit" class="btn-primary">
          <span class="material-icons">save</span>
          Cambiar etapa
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<style>
:root {
    --primary: #714B67;
    --primary-dark: #5a3d54;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
}

.mobile-app {
    max-width: 100%;
    min-height: 100vh;
    background: var(--gray-50);
    padding-bottom: 100px;
}

.mobile-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 100;
}

.mobile-back {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    color: var(--gray-600);
    text-decoration: none;
    transition: background 0.15s;
}
.mobile-back:hover { background: var(--gray-100); }

.mobile-header-title {
    flex: 1;
    font-size: 17px;
    font-weight: 600;
    color: var(--gray-800);
}

.mobile-header-actions { display: flex; gap: 8px; }

.mobile-header-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: all 0.15s;
}

.mobile-header-btn.whatsapp { background: #dcfce7; color: #16a34a; }
.mobile-header-btn.phone { background: #dbeafe; color: #2563eb; }
.mobile-header-btn .material-icons { font-size: 20px; }

.profile-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 16px;
    background: #fff;
}

.profile-avatar {
    width: 64px;
    height: 64px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
}
.profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
.profile-avatar span { font-size: 24px; font-weight: 700; color: #fff; }

.profile-info { flex: 1; min-width: 0; }
.profile-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 8px 0;
    line-height: 1.2;
}
.profile-badges { display: flex; flex-wrap: wrap; gap: 6px; }

.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 20px;
}
.badge .material-icons { font-size: 14px; }

.badge-info { background: #dbeafe; color: #1d4ed8; }
.badge-success { background: #dcfce7; color: #166534; }
.badge-neutral { background: var(--gray-200); color: var(--gray-600); }
.badge-light { background: var(--gray-100); color: var(--gray-600); }

/* NUEVO */
.badge-warning { background:#fffbeb; color:#b45309; }

.next-action-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0 16px 16px;
    padding: 14px 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: var(--radius);
    color: #fff;
}

.next-action-icon {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.next-action-icon .material-icons { font-size: 22px; }

.next-action-content { flex: 1; }
.next-action-label {
    display: block;
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.next-action-date { font-size: 15px; font-weight: 600; }

.next-action-right{
    display:flex;
    flex-direction: column;
    align-items:flex-end;
    gap:8px;
}

.next-action-responsible {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    opacity: 0.95;
    background: rgba(255,255,255,0.15);
    padding: 6px 10px;
    border-radius: 20px;
}
.next-action-responsible .material-icons { font-size: 16px; }

.btn-mini{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.35);
    background: rgba(255,255,255,0.12);
    color:#fff;
    cursor:pointer;
    font-size: 12px;
    font-weight: 600;
}
.btn-mini .material-icons{ font-size:16px; }
.btn-mini:hover{ background: rgba(255,255,255,0.18); }

.stepper-container {
    padding: 0 16px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.stepper-track { display: flex; gap: 4px; min-width: max-content; }
.stepper-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    min-width: 70px;
}
.stepper-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}
.stepper-dot .material-icons { font-size: 16px; }
.stepper-item.is-done .stepper-dot { background: var(--success); color: #fff; }
.stepper-item.is-current .stepper-dot {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 0 0 4px rgba(113, 75, 103, 0.2);
}
.stepper-label {
    font-size: 10px;
    color: var(--gray-500);
    text-align: center;
    white-space: nowrap;
}
.stepper-item.is-current .stepper-label { color: var(--primary); font-weight: 600; }
.stepper-item.is-done .stepper-label { color: var(--success); }

.mobile-tabs {
    display: flex;
    background: #fff;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 65px;
    z-index: 90;
}
.mobile-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 8px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-500);
    font-size: 11px;
    font-weight: 500;
    transition: all 0.15s;
    border-bottom: 2px solid transparent;
}
.mobile-tab .material-icons { font-size: 22px; }
.mobile-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

.mobile-content { padding: 16px; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

.mobile-form { background: #fff; border-radius: var(--radius); padding: 16px; }

.form-group { margin-bottom: 20px; position: relative; }
.form-group:last-child { margin-bottom: 0; }

.form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 0;
    font-size: 15px;
    border: none;
    border-bottom: 2px solid var(--gray-300);
    border-radius: 0;
    background: transparent;
    color: var(--gray-800);
    transition: border-color 0.2s;
    -webkit-appearance: none;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { outline: none; border-bottom-color: var(--primary); }
.form-group textarea { resize: vertical; min-height: 70px; border: none; border-bottom: 2px solid var(--gray-300); }
.form-group input[type="date"] { color-scheme: light; }

.btn-primary,
.btn-secondary,
.btn-danger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
.btn-secondary:hover { background: var(--gray-200); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-block { width: 100%; margin-top: 16px; }
.btn-primary .material-icons,
.btn-secondary .material-icons,
.btn-danger .material-icons { font-size: 20px; }

.timeline { position: relative; }
.timeline-date {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 0;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--gray-200);
}
.timeline-item { display: flex; gap: 12px; padding: 12px 0; position: relative; }
.timeline-item::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 28px;
    bottom: -12px;
    width: 2px;
    background: var(--gray-200);
}
.timeline-item:last-child::before { display: none; }
.timeline-dot {
    width: 12px;
    height: 12px;
    background: var(--primary);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
}
.timeline-item.is-note .timeline-dot { background: var(--warning); }
.timeline-content {
    flex: 1;
    min-width: 0;
    background: #fff;
    border-radius: var(--radius-sm);
    padding: 12px;
    box-shadow: var(--shadow);
}
.timeline-item.is-note .timeline-content {
    background: #fffbeb;
    border-left: 3px solid var(--warning);
}
.timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.timeline-author { font-size: 13px; font-weight: 600; color: var(--gray-800); }
.timeline-time { font-size: 11px; color: var(--gray-400); }
.timeline-title { font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
.timeline-body { font-size: 13px; color: var(--gray-600); line-height: 1.5; }
.timeline-tags { display: flex; gap: 6px; margin-top: 8px; }
.timeline-tag { font-size: 11px; padding: 3px 8px; background: var(--gray-100); color: var(--gray-600); border-radius: 10px; }

.info-section { background: #fff; border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
.info-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 16px 0;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-200);
}
.info-section-title .material-icons { font-size: 20px; color: var(--primary); }

.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.info-grid.compact { gap: 12px; }
.info-item { display: flex; flex-direction: column; gap: 4px; }
.info-label { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; }
.info-value { font-size: 14px; color: var(--gray-800); }
.info-value a { color: var(--primary); text-decoration: none; }

.assign-list { display: flex; flex-direction: column; gap: 10px; }
.assign-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
}
.assign-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
}
.assign-name { font-size: 14px; color: var(--gray-800); }

.options-section { background: #fff; border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
.options-section.danger-zone { border: 1px solid #fecaca; background: #fef2f2; }
.options-title { font-size: 14px; font-weight: 600; color: var(--gray-800); margin: 0 0 16px 0; }

.manage-actions{ display:flex; flex-direction: column; gap: 10px; }
.manage-hint{
    margin-top: 10px;
    font-size: 12px;
    color: var(--gray-500);
}

.assign-list-editable { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.assign-item-edit { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--gray-50); border-radius: var(--radius-sm); }
.assign-item-edit .assign-info { flex: 1; min-width: 0; }
.assign-item-edit .assign-name { display: block; font-size: 14px; font-weight: 500; color: var(--gray-800); }
.assign-item-edit .assign-code { font-size: 11px; color: var(--gray-500); }

.assign-remove {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; border-radius: 50%;
    color: var(--gray-400); cursor: pointer; transition: all 0.15s;
}
.assign-remove:hover { background: #fee2e2; color: var(--danger); }
.assign-remove .material-icons { font-size: 18px; }

.assign-empty-small {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    color: var(--gray-500);
    font-size: 13px;
    margin-bottom: 16px;
}
.assign-empty-small .material-icons { font-size: 20px; opacity: 0.5; }

.assign-add-section { padding-top: 16px; border-top: 1px solid var(--gray-200); }
.assign-add-section > label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.assign-add-row { display: flex; gap: 10px; align-items: flex-end; }
.assign-add-row .autocomplete-wrapper { flex: 1; position: relative; }

.btn-add-padre {
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    background: var(--primary); color: #fff;
    border: none; border-radius: var(--radius-sm);
    cursor: pointer; transition: background 0.15s;
}
.btn-add-padre:hover { background: var(--primary-dark); }
.btn-add-padre .material-icons { font-size: 22px; }

.empty-state { text-align: center; padding: 40px 20px; color: var(--gray-500); }
.empty-state .material-icons { font-size: 48px; opacity: 0.4; margin-bottom: 12px; }
.empty-state p { margin: 0 0 4px 0; font-size: 15px; font-weight: 500; color: var(--gray-600); }
.empty-hint { font-size: 13px; color: var(--gray-400); }

/* MODAL */
.modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(17,24,39,0.55);
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 9999;
    padding: 16px;
}
.modal-overlay.is-open{ display:flex; }

.modal-card{
    width: 100%;
    max-width: 520px;
    background: #fff;
    border-radius: 18px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    animation: modalUp .14s ease-out;
}
@keyframes modalUp{
    from{ transform: translateY(12px); opacity: 0.7; }
    to{ transform: translateY(0); opacity: 1; }
}
.modal-header{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--gray-200);
}
.modal-title{
    display:flex;
    align-items:center;
    gap: 8px;
    font-weight: 700;
    color: var(--gray-900);
}
.modal-title .material-icons{ color: var(--primary); }
.modal-close{
    width: 36px; height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--gray-100);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    color: var(--gray-700);
}
.modal-close:hover{ background: var(--gray-200); }

.modal-body{ padding: 16px; }
.modal-actions{
    display:flex;
    gap: 10px;
    padding: 14px 16px;
    border-top: 1px solid var(--gray-200);
    justify-content: flex-end;
}

.helper-small{
    margin-top: 6px;
    font-size: 12px;
    color: var(--gray-500);
}

@media (min-width: 768px) {
    .mobile-app {
        max-width: 600px;
        margin: 0 auto;
        border-left: 1px solid var(--gray-200);
        border-right: 1px solid var(--gray-200);
    }
    .profile-avatar { width: 80px; height: 80px; }
    .profile-name { font-size: 24px; }
    .info-grid { grid-template-columns: 1fr 1fr 1fr; }
    .modal-overlay{ align-items: center; }
}
</style>

<script src="{% static 'core/js/autocomplete-miembro.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tabs
    const tabs = document.querySelectorAll('.mobile-tab');
    const panels = document.querySelectorAll('.tab-panel');

    function activateTab(name){
        const targetId = 'tab-' + name;
        tabs.forEach(t => t.classList.remove('active'));
        panels.forEach(p => p.classList.remove('active'));
        const t = document.querySelector(`.mobile-tab[data-tab="${name}"]`);
        const p = document.getElementById(targetId);
        if (t) t.classList.add('active');
        if (p) p.classList.add('active');
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            activateTab(this.dataset.tab);
        });
    });

    // default
    activateTab('actividad');

    // URL param for tab
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam) activateTab(tabParam);

    // Modals
    function openModal(id){
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add('is-open');
        el.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
    }
    function closeModal(id){
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('is-open');
        el.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
    }

    const btnAgendar = document.getElementById('btn-open-agendar');
    const btnAgendar2 = document.getElementById('btn-open-agendar-2');
    if (btnAgendar) btnAgendar.addEventListener('click', () => openModal('modal-agendar'));
    if (btnAgendar2) btnAgendar2.addEventListener('click', () => openModal('modal-agendar'));

    const btnEtapa = document.getElementById('btn-open-etapa');
    if (btnEtapa) btnEtapa.addEventListener('click', () => openModal('modal-etapa'));

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.dataset.closeModal));
    });

    document.querySelectorAll('.modal-overlay').forEach(ov => {
        ov.addEventListener('click', (e) => {
            if (e.target === ov) closeModal(ov.id);
        });
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape'){
            document.querySelectorAll('.modal-overlay.is-open').forEach(ov => closeModal(ov.id));
        }
    });
});
</script>

{% endblock %}
