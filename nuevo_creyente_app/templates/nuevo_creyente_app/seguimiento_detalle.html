{% extends "core/base_sidebar.html" %}
{% load static %}

{% block title %}Nuevo Creyente | Detalle{% endblock %}

{% block sidebar_icon %}group_add{% endblock %}
{% block sidebar_role_label %}Nuevo Creyente{% endblock %}

{% block sidebar_menu %}
<a class="sidebar-link" href="{% url 'nuevo_creyente_app:nuevo_creyente' %}">
  <span class="material-icons">dashboard</span>
  <span>Dashboard</span>
</a>

<a class="sidebar-link active" href="{% url 'nuevo_creyente_app:seguimiento_lista' %}">
  <span class="material-icons">list</span>
  <span>En seguimiento</span>
</a>
{% endblock %}

{% block page_content %}
<div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
  <div>
    <h1 style="margin:0;">Detalle de seguimiento</h1>
    <div style="opacity:.75; margin-top:4px;">
      {{ miembro.nombres }} {{ miembro.apellidos }}
      {% if miembro.codigo_seguimiento %} Â· <strong>{{ miembro.codigo_seguimiento }}</strong>{% endif %}
    </div>
  </div>

  <div style="display:flex; gap:8px;">
    <a href="{% url 'nuevo_creyente_app:seguimiento_lista' %}" class="btn">Volver</a>
    <!-- MÃ¡s adelante: botones de acciones (cambiar etapa, asignar responsable, cerrar) -->
  </div>
</div>

<div class="card" style="padding:14px; margin-bottom:12px;">
  <h3 style="margin:0 0 10px 0;">Datos del miembro</h3>
  <div style="display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:10px;">
    <div>
      <div style="opacity:.7; font-size:.9em;">Nombre</div>
      <div><strong>{{ miembro.nombres }} {{ miembro.apellidos }}</strong></div>
    </div>
    <div>
      <div style="opacity:.7; font-size:.9em;">Edad</div>
      <div>{{ miembro.edad|default:"â€”" }}</div>
    </div>
    <div>
      <div style="opacity:.7; font-size:.9em;">GÃ©nero</div>
      <div>{{ miembro.get_genero_display|default:"â€”" }}</div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">TelÃ©fono</div>
      <div style="white-space:nowrap;">{{ miembro.telefono|default:miembro.whatsapp|default:"â€”" }}</div>
    </div>
    <div>
      <div style="opacity:.7; font-size:.9em;">Email</div>
      <div style="white-space:nowrap;">{{ miembro.email|default:"â€”" }}</div>
    </div>
    <div>
      <div style="opacity:.7; font-size:.9em;">Fecha de conversiÃ³n</div>
      <div style="white-space:nowrap;">
        {% if miembro.fecha_conversion %}{{ miembro.fecha_conversion|date:"d/m/Y" }}{% else %}â€”{% endif %}
      </div>
    </div>
  </div>
</div>
<div class="card" style="padding:14px; margin-bottom:12px;">
  <h3 style="margin:0 0 10px 0;">Expediente de seguimiento</h3>

  <div style="display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:10px;">

    <div>
      <div style="opacity:.7; font-size:.9em;">Estado</div>
      <div><strong>{{ expediente.get_estado_display }}</strong></div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">Responsable</div>
      <div>{{ expediente.responsable|default:"â€”" }}</div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">Fecha de envÃ­o</div>
      <div>{{ expediente.fecha_envio|date:"d/m/Y H:i" }}</div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">PrÃ³ximo contacto</div>
      <div>
        {% if expediente.proximo_contacto %}
          {{ expediente.proximo_contacto|date:"d/m/Y" }}
        {% else %}
          â€”
        {% endif %}
      </div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">Fecha de cierre</div>
      <div>
        {% if expediente.fecha_cierre %}
          {{ expediente.fecha_cierre|date:"d/m/Y H:i" }}
        {% else %}
          â€”
        {% endif %}
      </div>
    </div>

    <div>
      <div style="opacity:.7; font-size:.9em;">Ãšltima actualizaciÃ³n</div>
      <div>{{ expediente.fecha_actualizacion|date:"d/m/Y H:i" }}</div>
    </div>

  </div>
</div>

<div class="card" style="padding:14px; margin-bottom:12px;">
  <h3 style="margin:0 0 10px 0;">Editar seguimiento</h3>

  <form method="post" style="display:grid; gap:12px;">
    {% csrf_token %}

    
  <!-- PADRE ESPIRITUAL (AQUÃ VA EL AUTOCOMPLETE) -->
   <div class="odoo-field-value" style="min-width:0;">
    
  <div class="odoo-field-row">
    <label>Padre espiritual</label>
    <div class="odoo-field-value">

      <!-- ðŸ‘‡ AQUÃ PEGAS COMPLETO EL HTML DEL AUTOCOMPLETE QUE TE DI -->
<div
  class="autocomplete-wrapper"
  data-autocomplete-id="id_padre_espiritual"
  data-endpoint="/api/buscar-miembros/"
  data-filtro="activos"
  data-limit="15"
>
  <!-- hidden -->
  <input
    type="hidden"
    name="padre_espiritual_id"
    id="id_padre_espiritual"
    value="{% if expediente.padre_espiritual %}{{ expediente.padre_espiritual.id }}{% endif %}"
  >

  <div class="autocomplete-field">
    <!-- Chip (se muestra si ya hay padre espiritual asignado) -->
    <div class="autocomplete-chip" style="{% if not expediente.padre_espiritual %}display:none{% endif %}">
      <div class="chip-avatar">
        {% if expediente.padre_espiritual %}
          {{ expediente.padre_espiritual.nombres|slice:":1" }}{{ expediente.padre_espiritual.apellidos|slice:":1" }}
        {% endif %}
      </div>

      <div class="chip-text">
        <div class="chip-name">
          {% if expediente.padre_espiritual %}
            {{ expediente.padre_espiritual.nombres }} {{ expediente.padre_espiritual.apellidos }}
          {% endif %}
        </div>
        <div class="chip-code">
          {% if expediente.padre_espiritual %}
            {{ expediente.padre_espiritual.codigo|default:"" }}
          {% endif %}
        </div>
      </div>

      <button type="button" class="chip-remove" title="Quitar">Ã—</button>
    </div>

    <!-- input de bÃºsqueda -->
    <input
      type="text"
      class="autocomplete-search input"
      placeholder="Escriba para buscar..."
      autocomplete="off"
      {% if expediente.padre_espiritual %}style="display:none"{% endif %}
    >
  </div>

  <div class="autocomplete-dropdown">
    <div class="autocomplete-loading" style="display:none;">Buscandoâ€¦</div>
    <ul class="autocomplete-list"></ul>
    <div class="autocomplete-empty" style="display:none;">Sin resultados</div>
  </div>
</div>

    <div style="display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:10px;">
    
        <div>
    <label>Unidad responsable</label>
    {{ form.unidad_responsable }}
    {% if form.unidad_responsable.errors %}
        <div style="color:#b42318; font-size:.9em;">
        {{ form.unidad_responsable.errors }}
        </div>
    {% endif %}
    </div>

    
        <div>
        <label>Responsable</label>
        {{ form.responsable }}
        {% if form.responsable.errors %}
          <div style="color:#b42318; font-size:.9em;">{{ form.responsable.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label>PrÃ³ximo contacto</label>
        {{ form.proximo_contacto }}
        {% if form.proximo_contacto.errors %}
          <div style="color:#b42318; font-size:.9em;">{{ form.proximo_contacto.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div>
      <label>Notas</label>
      {{ form.notas }}
      {% if form.notas.errors %}
        <div style="color:#b42318; font-size:.9em;">{{ form.notas.errors }}</div>
      {% endif %}
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
      <a href="{% url 'nuevo_creyente_app:seguimiento_detalle' miembro.id %}" class="btn">Cancelar</a>
    </div>
  </form>
</div>
</div>
<style>
@media (max-width: 900px) {
  form[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
}
</style>


<style>
@media (max-width: 900px) {
  .card > div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
}
</style>
<style>
/* --- Fix: que el chip NO se quede en "..." en el detalle --- */
.autocomplete-wrapper { width: 100%; }
.autocomplete-field { width: 100%; }

.autocomplete-chip {
  max-width: 100%;
}

.chip-text{
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;        /* permite que baje a la siguiente lÃ­nea */
  min-width: 180px;       /* evita que se quede en 0px */
}

.chip-name{
  max-width: none !important;
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: unset !important;
}

.chip-code{
  white-space: nowrap;
  opacity: .75;
}
</style>

<script src="{% static 'core/js/autocomplete-miembro.js' %}"></script>

{% endblock %}
