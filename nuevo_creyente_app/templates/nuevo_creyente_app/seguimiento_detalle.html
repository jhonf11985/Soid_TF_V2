{% extends "core/base_sidebar.html" %}
{% load static %}

{% block title %}{{ miembro.nombres }} | Seguimiento{% endblock %}

{% block sidebar_icon %}group_add{% endblock %}
{% block sidebar_role_label %}Nuevo Creyente{% endblock %}

{% block sidebar_menu %}
<a class="sidebar-link" href="{% url 'nuevo_creyente_app:nuevo_creyente' %}">
  <span class="material-icons">dashboard</span>
  <span>Dashboard</span>
</a>
<a class="sidebar-link active" href="{% url 'nuevo_creyente_app:seguimiento_lista' %}">
  <span class="material-icons">list</span>
  <span>En seguimiento</span>
</a>
{% endblock %}

{% block page_content %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VISTA MOBILE-FIRST - DETALLE DE SEGUIMIENTO
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="mobile-app">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         HEADER COMPACTO
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="mobile-header">
        <a href="{% url 'nuevo_creyente_app:seguimiento_lista' %}" class="mobile-back">
            <span class="material-icons">arrow_back</span>
        </a>
        <div class="mobile-header-title">Seguimiento</div>
        <div class="mobile-header-actions">
            {% if miembro.whatsapp %}
            <a href="https://wa.me/{{ miembro.whatsapp|cut:' '|cut:'-' }}" class="mobile-header-btn whatsapp" target="_blank">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.486 2 2 6.486 2 12c0 1.86.507 3.599 1.387 5.106L2 22l5.043-1.356A9.93 9.93 0 0 0 12 22c5.514 0 10-4.486 10-10S17.514 2 12 2z"/>
                </svg>
            </a>
            {% endif %}
            {% if miembro.telefono or miembro.whatsapp %}
            <a href="tel:{{ miembro.telefono|default:miembro.whatsapp }}" class="mobile-header-btn phone">
                <span class="material-icons">phone</span>
            </a>
            {% endif %}
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CARD DE PERFIL
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="profile-card">
        <div class="profile-avatar" style="background: {% if miembro.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
            {% if miembro.foto %}
                <img src="{{ miembro.foto.url }}" alt="{{ miembro.nombres }}">
            {% else %}
                <span>{{ miembro.nombres|slice:":1"|upper }}</span>
            {% endif %}
        </div>
        <div class="profile-info">
            <h1 class="profile-name">{{ miembro.nombres }} {{ miembro.apellidos }}</h1>
            <div class="profile-badges">
                {% if expediente.estado == "CERRADO" %}
                    <span class="badge badge-neutral"><span class="material-icons">lock</span> Cerrado</span>
                {% else %}
                    <span class="badge badge-info">{{ expediente.get_etapa_display }}</span>
                {% endif %}
                {% if miembro.edad %}
                    <span class="badge badge-light">{{ miembro.edad }} aÃ±os</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PRÃ“XIMA ACCIÃ“N (destacado)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    {% if expediente.estado != "CERRADO" %}
    <div class="next-action-card">
        <div class="next-action-icon">
            <span class="material-icons">schedule</span>
        </div>
        <div class="next-action-content">
            <span class="next-action-label">PrÃ³ximo contacto</span>
            <span class="next-action-date">
                {% if expediente.proximo_contacto %}
                    {{ expediente.proximo_contacto|date:"d M Y" }}
                {% else %}
                    Sin programar
                {% endif %}
            </span>
        </div>
        {% if expediente.responsable %}
        <div class="next-action-responsible">
            <span class="material-icons">person</span>
            {{ expediente.responsable.nombres|truncatewords:1 }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         STEPPER HORIZONTAL COMPACTO
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="stepper-container">
        <div class="stepper-track">
            {% for e in expediente.ETAPAS_ORDEN %}
            <div class="stepper-item {% if expediente.etapa == e %}is-current{% endif %} {% if expediente.etapa_index > forloop.counter0 %}is-done{% endif %}">
                <div class="stepper-dot">
                    {% if expediente.etapa_index > forloop.counter0 %}
                        <span class="material-icons">check</span>
                    {% else %}
                        {{ forloop.counter }}
                    {% endif %}
                </div>
                <span class="stepper-label">
                    {% if e == "INICIO" %}Inicio
                    {% elif e == "PRIMER_CONTACTO" %}Contacto
                    {% elif e == "ACOMPANAMIENTO" %}AcompaÃ±.
                    {% elif e == "INTEGRACION" %}Integrac.
                    {% elif e == "EVALUACION" %}Evaluac.
                    {% elif e == "CIERRE" %}Cierre
                    {% else %}{{ e }}{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TABS DE NAVEGACIÃ“N (SWIPEABLE)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="mobile-tabs">
        <button class="mobile-tab active" data-tab="accion">
            <span class="material-icons">{% if expediente.estado == "CERRADO" %}lock{% else %}edit_note{% endif %}</span>
            <span>AcciÃ³n</span>
        </button>
        <button class="mobile-tab" data-tab="historial">
            <span class="material-icons">history</span>
            <span>Historial</span>
        </button>
        <button class="mobile-tab" data-tab="info">
            <span class="material-icons">info</span>
            <span>Info</span>
        </button>
        <button class="mobile-tab" data-tab="mas">
            <span class="material-icons">more_horiz</span>
            <span>MÃ¡s</span>
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CONTENIDO DE TABS
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="mobile-content">

        <!-- TAB: ACCIÃ“N ACTUAL -->
        <div class="tab-panel active" id="tab-accion">
            
            {% if expediente.estado == "CERRADO" %}
                <div class="empty-state">
                    <span class="material-icons">lock</span>
                    <p>Expediente cerrado</p>
                    <span class="empty-hint">No se pueden registrar nuevas acciones</span>
                </div>

            {% elif expediente.etapa == "INICIO" or expediente.etapa == "PRIMER_CONTACTO" %}
                <!-- FORMULARIO: Primer contacto -->
                <div class="action-header">
                    <span class="material-icons">call</span>
                    <div>
                        <strong>Registrar contacto</strong>
                        <p>Documenta el primer acercamiento</p>
                    </div>
                </div>

                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_primer_contacto' miembro.id %}" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" name="fecha_contacto" required>
                        </div>
                    </div>

                    <div class="form-row two-cols">
                        <div class="form-group">
                            <label>Canal</label>
                            <select name="canal" required>
                                <option value="">Seleccionar</option>
                                <option value="llamada">ğŸ“ Llamada</option>
                                <option value="whatsapp">ğŸ’¬ WhatsApp</option>
                                <option value="presencial">ğŸ¤ Presencial</option>
                                <option value="referido">ğŸ‘¥ Referido</option>
                                <option value="otro">ğŸ“‹ Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Resultado</label>
                            <select name="resultado" required>
                                <option value="">Seleccionar</option>
                                <option value="contactado">âœ… Contactado</option>
                                <option value="no_responde">âŒ No respondiÃ³</option>
                                <option value="num_err">âš ï¸ NÃºm. incorrecto</option>
                                <option value="pendiente">ğŸ• Pendiente</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nota breve</label>
                        <textarea name="nota" rows="3" required placeholder="Ej: Se le escribiÃ³ por WhatsApp, respondiÃ³ agradecido."></textarea>
                    </div>

                    <button type="submit" class="btn-primary btn-block">
                        <span class="material-icons">save</span>
                        Guardar contacto
                    </button>
                </form>

            {% elif expediente.etapa == "ACOMPANAMIENTO" %}
                <!-- FORMULARIO: AcompaÃ±amiento -->
                <div class="action-header">
                    <span class="material-icons">volunteer_activism</span>
                    <div>
                        <strong>Registrar acompaÃ±amiento</strong>
                        <p>Documenta el cuidado pastoral</p>
                    </div>
                </div>

                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_acompanamiento_add' miembro.id %}" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-row two-cols">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" name="fecha_evento" required>
                        </div>
                        <div class="form-group">
                            <label>PrÃ³ximo contacto</label>
                            <input type="date" name="proximo_contacto">
                        </div>
                    </div>

                    <div class="form-row two-cols">
                        <div class="form-group">
                            <label>Tipo</label>
                            <select name="tipo_acompanamiento" required>
                                <option value="">Seleccionar</option>
                                <option value="oracion">ğŸ™ OraciÃ³n</option>
                                <option value="conversacion">ğŸ’¬ ConversaciÃ³n</option>
                                <option value="visita">ğŸ  Visita</option>
                                <option value="culto">â›ª Culto</option>
                                <option value="celula">ğŸ‘¥ CÃ©lula</option>
                                <option value="llamada_seguimiento">ğŸ“ Llamada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select name="estado_persona" required>
                                <option value="">Seleccionar</option>
                                <option value="bien">ğŸ˜Š Bien</option>
                                <option value="neutro">ğŸ˜ Neutro</option>
                                <option value="desanimado">ğŸ˜” Desanimado</option>
                                <option value="riesgo">âš ï¸ En riesgo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nota pastoral</label>
                        <textarea name="nota" rows="3" required placeholder="Ej: Oramos, estÃ¡ animado, vendrÃ¡ el domingo."></textarea>
                    </div>

                    <button type="submit" class="btn-primary btn-block">
                        <span class="material-icons">save</span>
                        Guardar acompaÃ±amiento
                    </button>
                </form>

            {% elif expediente.etapa == "INTEGRACION" %}
                <!-- FORMULARIO: IntegraciÃ³n -->
                <div class="action-header">
                    <span class="material-icons">hub</span>
                    <div>
                        <strong>Registrar integraciÃ³n</strong>
                        <p>Â¿A quÃ© grupo/actividad se integrÃ³?</p>
                    </div>
                </div>

                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_integracion_add' miembro.id %}" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-row two-cols">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" name="fecha_integracion" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select name="tipo_integracion" required>
                                <option value="">Seleccionar</option>
                                <option value="celula">ğŸ‘¥ CÃ©lula</option>
                                <option value="culto">â›ª Culto</option>
                                <option value="actividad">ğŸ¯ Actividad</option>
                                <option value="unidad">ğŸ›ï¸ Ministerio</option>
                                <option value="mentoria">ğŸ¤ MentorÃ­a</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Â¿A dÃ³nde se integrÃ³?</label>
                        <input type="text" name="destino" required placeholder="Ej: CÃ©lula JÃ³venes (martes 7pm)">
                    </div>

                    <div class="form-group">
                        <label>Responsable / contacto (opcional)</label>
                        <input type="text" name="responsable_txt" placeholder="Ej: LÃ­der Juan PÃ©rez">
                    </div>

                    <div class="form-group">
                        <label>PrÃ³ximo paso</label>
                        <select name="proximo_paso">
                            <option value="">Ninguno</option>
                            <option value="confirmar_asistencia">Confirmar asistencia</option>
                            <option value="presentar_lider">Presentarlo al lÃ­der</option>
                            <option value="agendar_visita">Agendar visita</option>
                            <option value="pasar_discipulado">Pasar a discipulado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nota (opcional)</label>
                        <textarea name="nota" rows="2" placeholder="Ej: Se le presentÃ³ al lÃ­der, quedÃ³ motivado."></textarea>
                    </div>

                    <button type="submit" class="btn-primary btn-block">
                        <span class="material-icons">save</span>
                        Guardar integraciÃ³n
                    </button>
                </form>

            {% elif expediente.etapa == "EVALUACION" %}
                <!-- FORMULARIO: EvaluaciÃ³n -->
                <div class="action-header">
                    <span class="material-icons">fact_check</span>
                    <div>
                        <strong>EvaluaciÃ³n final</strong>
                        <p>Define siguiente paso o cierra</p>
                    </div>
                </div>

                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_evaluacion_add' miembro.id %}" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-row two-cols">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" name="fecha_evaluacion" required>
                        </div>
                        <div class="form-group">
                            <label>DecisiÃ³n</label>
                            <select name="decision" required>
                                <option value="">Seleccionar</option>
                                <option value="discipulado">ğŸ“– Discipulado</option>
                                <option value="mantener_integracion">ğŸ”„ Mantener</option>
                                <option value="visita_pastoral">ğŸ  Visita pastoral</option>
                                <option value="reasignar_responsable">ğŸ‘¤ Reasignar</option>
                                <option value="cerrar">ğŸ”’ Cerrar</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Barreras detectadas</label>
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="transporte">
                                <span>ğŸšŒ Transporte</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="horarios">
                                <span>ğŸ• Horarios</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="falta_interes">
                                <span>ğŸ˜• Sin interÃ©s</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="familia">
                                <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familia</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="salud">
                                <span>ğŸ¥ Salud</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="barreras" value="sin_contacto">
                                <span>ğŸ“µ Sin contacto</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nota final</label>
                        <textarea name="nota" rows="3" required placeholder="Ej: Se integrÃ³ a cÃ©lula, asistiÃ³ 2 veces, listo para discipulado."></textarea>
                    </div>

                    <button type="submit" class="btn-primary btn-block">
                        <span class="material-icons">save</span>
                        Guardar evaluaciÃ³n
                    </button>
                </form>
            {% endif %}

            <!-- NOTA RÃPIDA (siempre visible si no estÃ¡ cerrado) -->
            {% if expediente.estado != "CERRADO" %}
            <div class="quick-note-section">
                <button type="button" class="quick-note-toggle" id="toggle-quick-note">
                    <span class="material-icons">add_comment</span>
                    Agregar nota rÃ¡pida
                </button>
                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_nota_add' miembro.id %}" class="quick-note-form" id="quick-note-form" style="display:none;">
                    {% csrf_token %}
                    <input type="hidden" name="tipo" value="nota">
                    <textarea name="texto" rows="2" placeholder="Escribe una nota..." required></textarea>
                    <div class="quick-note-actions">
                        <button type="button" class="btn-ghost" id="cancel-quick-note">Cancelar</button>
                        <button type="submit" class="btn-secondary">
                            <span class="material-icons">send</span>
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- TAB: HISTORIAL -->
        <div class="tab-panel" id="tab-historial">
            <div class="timeline">
                {% regroup expediente.bitacora.all by fecha|date:"d M Y" as items_by_date %}
                
                {% for date_group in items_by_date %}
                <div class="timeline-date">{{ date_group.grouper }}</div>
                
                {% for item in date_group.list %}
                <div class="timeline-item {% if item.tipo == 'nota' %}is-note{% endif %}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-author">
                                {% if item.autor %}{{ item.autor.nombres }}{% else %}Sistema{% endif %}
                            </span>
                            <span class="timeline-time">{{ item.fecha|date:"g:i a" }}</span>
                        </div>
                        {% if item.titulo %}
                        <div class="timeline-title">{{ item.titulo }}</div>
                        {% endif %}
                        <div class="timeline-body">{{ item.detalle|default:""|truncatewords:30 }}</div>
                        {% if item.canal or item.resultado_contacto %}
                        <div class="timeline-tags">
                            {% if item.canal %}<span class="timeline-tag">{{ item.canal }}</span>{% endif %}
                            {% if item.resultado_contacto %}<span class="timeline-tag">{{ item.resultado_contacto }}</span>{% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% empty %}
                <div class="empty-state">
                    <span class="material-icons">forum</span>
                    <p>Sin registros aÃºn</p>
                    <span class="empty-hint">Las acciones aparecerÃ¡n aquÃ­</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- TAB: INFO -->
        <div class="tab-panel" id="tab-info">
            
            <!-- Datos personales -->
            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">person</span>
                    Datos personales
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Nombre</span>
                        <span class="info-value">{{ miembro.nombres }} {{ miembro.apellidos }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Edad</span>
                        <span class="info-value">{{ miembro.edad|default:"â€”" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">GÃ©nero</span>
                        <span class="info-value">{{ miembro.get_genero_display|default:"â€”" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">TelÃ©fono</span>
                        <span class="info-value">
                            {% if miembro.telefono or miembro.whatsapp %}
                            <a href="tel:{{ miembro.telefono|default:miembro.whatsapp }}">{{ miembro.telefono|default:miembro.whatsapp }}</a>
                            {% else %}â€”{% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">
                            {% if miembro.email %}
                            <a href="mailto:{{ miembro.email }}">{{ miembro.email|truncatechars:25 }}</a>
                            {% else %}â€”{% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ConversiÃ³n</span>
                        <span class="info-value">{% if miembro.fecha_conversion %}{{ miembro.fecha_conversion|date:"d/m/Y" }}{% else %}â€”{% endif %}</span>
                    </div>
                </div>
            </div>

            <!-- Expediente -->
            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">folder_open</span>
                    Expediente
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Estado</span>
                        <span class="info-value">
                            <span class="badge {% if expediente.estado == 'CERRADO' %}badge-success{% else %}badge-info{% endif %}">
                                {{ expediente.get_estado_display }}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Responsable</span>
                        <span class="info-value">{{ expediente.responsable|default:"â€”" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Unidad</span>
                        <span class="info-value">{{ expediente.unidad_responsable|default:"â€”" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha envÃ­o</span>
                        <span class="info-value">{{ expediente.fecha_envio|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">CÃ³digo</span>
                        <span class="info-value">{{ miembro.codigo_seguimiento|default:"â€”" }}</span>
                    </div>
                </div>
            </div>

            <!-- Asignaciones -->
            {% if expediente.padres_links.all %}
            <div class="info-section">
                <h3 class="info-section-title">
                    <span class="material-icons">volunteer_activism</span>
                    Padres espirituales
                </h3>
                <div class="assign-list">
                    {% for link in expediente.padres_links.all %}
                    <div class="assign-item">
                        <div class="assign-avatar" style="background: {% if link.padre.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
                            {{ link.padre.nombres|slice:":1"|upper }}
                        </div>
                        <span class="assign-name">{{ link.padre.nombres }} {{ link.padre.apellidos }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- TAB: MÃS OPCIONES -->
        <div class="tab-panel" id="tab-mas">
            
            <!-- Cambiar etapa manualmente -->
            {% if expediente.estado != "CERRADO" %}
            <div class="options-section">
                <h3 class="options-title">Cambiar etapa</h3>
                <div class="options-grid">
                    {% for e in expediente.ETAPAS_ORDEN %}
                    <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_set_etapa' miembro.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="etapa" value="{{ e }}">
                        <button type="submit" class="option-btn {% if expediente.etapa == e %}is-active{% endif %}">
                            {% if e == "INICIO" %}Inicio
                            {% elif e == "PRIMER_CONTACTO" %}Primer contacto
                            {% elif e == "ACOMPANAMIENTO" %}AcompaÃ±amiento
                            {% elif e == "INTEGRACION" %}IntegraciÃ³n
                            {% elif e == "EVALUACION" %}EvaluaciÃ³n
                            {% elif e == "CIERRE" %}Cierre
                            {% else %}{{ e }}{% endif %}
                        </button>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Padres espirituales -->
            {% if expediente.estado != "CERRADO" %}
            <div class="options-section">
                <h3 class="options-title">Padres espirituales</h3>
                
                <!-- Lista actual -->
                {% if expediente.padres_links.all %}
                <div class="assign-list-editable">
                    {% for link in expediente.padres_links.all %}
                    <div class="assign-item-edit">
                        <div class="assign-avatar" style="background: {% if link.padre.genero == 'M' %}#3b82f6{% else %}#ec4899{% endif %};">
                            {{ link.padre.nombres|slice:":1"|upper }}
                        </div>
                        <div class="assign-info">
                            <span class="assign-name">{{ link.padre.nombres }} {{ link.padre.apellidos }}</span>
                            <span class="assign-code">{{ link.padre.codigo|default:"Sin cÃ³digo" }}</span>
                        </div>
                        <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_padre_remove' miembro.id link.padre.id %}">
                            {% csrf_token %}
                            <button type="submit" class="assign-remove" onclick="return confirm('Â¿Quitar este padre espiritual?');">
                                <span class="material-icons">close</span>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="assign-empty-small">
                    <span class="material-icons">person_off</span>
                    <span>Sin padres asignados</span>
                </div>
                {% endif %}

                <!-- Agregar nuevo -->
                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_padre_add' miembro.id %}" class="assign-add-section">
                    {% csrf_token %}
                    <label>AÃ±adir padre espiritual</label>
                    <div class="assign-add-row">
                        <div
                            class="autocomplete-wrapper"
                            data-autocomplete-id="id_padre_espiritual"
                            data-endpoint="/api/buscar-miembros/"
                            data-filtro="activos"
                            data-limit="15"
                        >
                            <input type="hidden" name="padre_espiritual_id" id="id_padre_espiritual" value="">

                            <div class="autocomplete-field">
                                <div class="autocomplete-chip" style="display:none;">
                                    <div class="chip-avatar"></div>
                                    <div class="chip-text">
                                        <div class="chip-name"></div>
                                        <div class="chip-code"></div>
                                    </div>
                                    <button type="button" class="chip-remove" title="Quitar">Ã—</button>
                                </div>

                                <input
                                    type="text"
                                    class="autocomplete-search input"
                                    placeholder="Buscar miembro..."
                                    autocomplete="off"
                                >
                            </div>

                            <div class="autocomplete-dropdown">
                                <div class="autocomplete-loading" style="display:none;">Buscandoâ€¦</div>
                                <ul class="autocomplete-list"></ul>
                                <div class="autocomplete-empty" style="display:none;">Sin resultados</div>
                            </div>
                        </div>

                        <button type="submit" class="btn-add-padre">
                            <span class="material-icons">person_add</span>
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Ajustes del expediente -->
            {% if expediente.estado != "CERRADO" %}
            <div class="options-section">
                <h3 class="options-title">Ajustes</h3>
                <form method="post" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label>Unidad responsable</label>
                        {{ form.unidad_responsable }}
                    </div>

                    <div class="form-group">
                        <label>Responsable</label>
                        {{ form.responsable }}
                    </div>

                    <div class="form-group">
                        <label>Notas del expediente</label>
                        {{ form.notas }}
                    </div>

                    <button type="submit" class="btn-secondary btn-block">
                        <span class="material-icons">save</span>
                        Guardar cambios
                    </button>
                </form>
            </div>

            <!-- Cerrar seguimiento -->
            {% if expediente.puede_cerrar %}
            <div class="options-section danger-zone">
                <h3 class="options-title">Cerrar seguimiento</h3>
                <form method="post" action="{% url 'nuevo_creyente_app:seguimiento_cerrar' miembro.id %}" class="mobile-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label>Resultado final</label>
                        <select name="resultado_final" required>
                            <option value="">Seleccionar</option>
                            <option value="integrado_celula">Integrado a cÃ©lula</option>
                            <option value="inicio_discipulado">IniciÃ³ discipulado</option>
                            <option value="congrega_regular">Se congrega regularmente</option>
                            <option value="trasladado">Trasladado a otra iglesia</option>
                            <option value="no_responde">No respondiÃ³</option>
                            <option value="rechazo">RechazÃ³ seguimiento</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nota de cierre</label>
                        <textarea name="nota_cierre" rows="2" required placeholder="Resumen breve del cierre..."></textarea>
                    </div>

                    <button type="submit" class="btn-danger btn-block" onclick="return confirm('Â¿Confirmas cerrar este seguimiento?');">
                        <span class="material-icons">lock</span>
                        Cerrar seguimiento
                    </button>
                </form>
            </div>
            {% endif %}
            {% endif %}

            <!-- Info del sistema (siempre visible) -->
            <div class="options-section">
                <h3 class="options-title">InformaciÃ³n</h3>
                <div class="info-grid compact">
                    <div class="info-item">
                        <span class="info-label">Ãšltima actualizaciÃ³n</span>
                        <span class="info-value">{{ expediente.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if expediente.fecha_cierre %}
                    <div class="info-item">
                        <span class="info-label">Fecha de cierre</span>
                        <span class="info-value">{{ expediente.fecha_cierre|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CSS MOBILE-FIRST
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES Y RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --primary: #714B67;
    --primary-dark: #5a3d54;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP CONTAINER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-app {
    max-width: 100%;
    min-height: 100vh;
    background: var(--gray-50);
    padding-bottom: 100px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 100;
}

.mobile-back {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    color: var(--gray-600);
    text-decoration: none;
    transition: background 0.15s;
}

.mobile-back:hover {
    background: var(--gray-100);
}

.mobile-header-title {
    flex: 1;
    font-size: 17px;
    font-weight: 600;
    color: var(--gray-800);
}

.mobile-header-actions {
    display: flex;
    gap: 8px;
}

.mobile-header-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: all 0.15s;
}

.mobile-header-btn.whatsapp {
    background: #dcfce7;
    color: #16a34a;
}

.mobile-header-btn.phone {
    background: #dbeafe;
    color: #2563eb;
}

.mobile-header-btn .material-icons {
    font-size: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE CARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.profile-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 16px;
    background: #fff;
}

.profile-avatar {
    width: 64px;
    height: 64px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-avatar span {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
}

.profile-info {
    flex: 1;
    min-width: 0;
}

.profile-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 8px 0;
    line-height: 1.2;
}

.profile-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

/* Badges */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 20px;
}

.badge .material-icons {
    font-size: 14px;
}

.badge-info {
    background: #dbeafe;
    color: #1d4ed8;
}

.badge-success {
    background: #dcfce7;
    color: #166534;
}

.badge-neutral {
    background: var(--gray-200);
    color: var(--gray-600);
}

.badge-light {
    background: var(--gray-100);
    color: var(--gray-600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEXT ACTION CARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.next-action-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0 16px 16px;
    padding: 14px 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: var(--radius);
    color: #fff;
}

.next-action-icon {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.next-action-icon .material-icons {
    font-size: 22px;
}

.next-action-content {
    flex: 1;
}

.next-action-label {
    display: block;
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.next-action-date {
    font-size: 15px;
    font-weight: 600;
}

.next-action-responsible {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    opacity: 0.9;
    background: rgba(255,255,255,0.15);
    padding: 6px 10px;
    border-radius: 20px;
}

.next-action-responsible .material-icons {
    font-size: 16px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEPPER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stepper-container {
    padding: 0 16px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.stepper-track {
    display: flex;
    gap: 4px;
    min-width: max-content;
}

.stepper-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    min-width: 70px;
}

.stepper-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.stepper-dot .material-icons {
    font-size: 16px;
}

.stepper-item.is-done .stepper-dot {
    background: var(--success);
    color: #fff;
}

.stepper-item.is-current .stepper-dot {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 0 0 4px rgba(113, 75, 103, 0.2);
}

.stepper-label {
    font-size: 10px;
    color: var(--gray-500);
    text-align: center;
    white-space: nowrap;
}

.stepper-item.is-current .stepper-label {
    color: var(--primary);
    font-weight: 600;
}

.stepper-item.is-done .stepper-label {
    color: var(--success);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-tabs {
    display: flex;
    background: #fff;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 65px;
    z-index: 90;
}

.mobile-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 8px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-500);
    font-size: 11px;
    font-weight: 500;
    transition: all 0.15s;
    border-bottom: 2px solid transparent;
}

.mobile-tab .material-icons {
    font-size: 22px;
}

.mobile-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB PANELS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-content {
    padding: 16px;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.action-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #fff;
    border-radius: var(--radius);
    margin-bottom: 16px;
}

.action-header .material-icons {
    font-size: 24px;
    color: var(--primary);
    margin-top: 2px;
}

.action-header strong {
    display: block;
    font-size: 15px;
    color: var(--gray-800);
    margin-bottom: 2px;
}

.action-header p {
    margin: 0;
    font-size: 13px;
    color: var(--gray-500);
}

.mobile-form {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
}

.form-row {
    margin-bottom: 16px;
}

.form-row.two-cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.form-group {
    margin-bottom: 20px;
    position: relative;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 0;
    font-size: 15px;
    border: none;
    border-bottom: 2px solid var(--gray-300);
    border-radius: 0;
    background: transparent;
    color: var(--gray-800);
    transition: border-color 0.2s;
    -webkit-appearance: none;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-bottom-color: var(--primary);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: var(--gray-400);
}

.form-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0 center;
    padding-right: 20px;
}

.form-group textarea {
    resize: vertical;
    min-height: 70px;
    border: none;
    border-bottom: 2px solid var(--gray-300);
}

/* Date input icon color fix */
.form-group input[type="date"] {
    color-scheme: light;
}

/* Checkbox grid */
.checkbox-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    font-size: 13px;
    cursor: pointer;
    transition: background 0.15s;
}

.checkbox-item:has(input:checked) {
    background: #dbeafe;
}

.checkbox-item input {
    width: auto;
    margin: 0;
}

/* Buttons */
.btn-primary,
.btn-secondary,
.btn-danger,
.btn-ghost {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: #fff;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.btn-secondary:hover {
    background: var(--gray-200);
}

.btn-danger {
    background: var(--danger);
    color: #fff;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-ghost {
    background: transparent;
    color: var(--gray-600);
    padding: 10px 16px;
}

.btn-block {
    width: 100%;
    margin-top: 16px;
}

.btn-primary .material-icons,
.btn-secondary .material-icons,
.btn-danger .material-icons {
    font-size: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK NOTE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quick-note-section {
    margin-top: 20px;
}

.quick-note-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px;
    background: var(--gray-50);
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius);
    color: var(--gray-600);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}

.quick-note-toggle:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
}

.quick-note-form {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
    margin-top: 12px;
}

.quick-note-form textarea {
    width: 100%;
    padding: 12px 0;
    border: none;
    border-bottom: 2px solid var(--gray-300);
    border-radius: 0;
    background: transparent;
    font-size: 14px;
    resize: none;
    transition: border-color 0.2s;
}

.quick-note-form textarea:focus {
    outline: none;
    border-bottom-color: var(--primary);
}

.quick-note-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
}

.quick-note-actions .btn-secondary {
    padding: 10px 14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timeline {
    position: relative;
}

.timeline-date {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 0;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--gray-200);
}

.timeline-item {
    display: flex;
    gap: 12px;
    padding: 12px 0;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 28px;
    bottom: -12px;
    width: 2px;
    background: var(--gray-200);
}

.timeline-item:last-child::before {
    display: none;
}

.timeline-dot {
    width: 12px;
    height: 12px;
    background: var(--primary);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
}

.timeline-item.is-note .timeline-dot {
    background: var(--warning);
}

.timeline-content {
    flex: 1;
    min-width: 0;
    background: #fff;
    border-radius: var(--radius-sm);
    padding: 12px;
    box-shadow: var(--shadow);
}

.timeline-item.is-note .timeline-content {
    background: #fffbeb;
    border-left: 3px solid var(--warning);
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.timeline-author {
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-800);
}

.timeline-time {
    font-size: 11px;
    color: var(--gray-400);
}

.timeline-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 4px;
}

.timeline-body {
    font-size: 13px;
    color: var(--gray-600);
    line-height: 1.5;
}

.timeline-tags {
    display: flex;
    gap: 6px;
    margin-top: 8px;
}

.timeline-tag {
    font-size: 11px;
    padding: 3px 8px;
    background: var(--gray-100);
    color: var(--gray-600);
    border-radius: 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO SECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.info-section {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
}

.info-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 16px 0;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-200);
}

.info-section-title .material-icons {
    font-size: 20px;
    color: var(--primary);
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.info-grid.compact {
    gap: 12px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.info-label {
    font-size: 11px;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.info-value {
    font-size: 14px;
    color: var(--gray-800);
}

.info-value a {
    color: var(--primary);
    text-decoration: none;
}

/* Assign list */
.assign-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.assign-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
}

.assign-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
}

.assign-name {
    font-size: 14px;
    color: var(--gray-800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPTIONS SECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.options-section {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
}

.options-section.danger-zone {
    border: 1px solid #fecaca;
    background: #fef2f2;
}

.options-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 16px 0;
}

.options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.option-btn {
    padding: 12px;
    font-size: 13px;
    font-weight: 500;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.15s;
}

.option-btn:hover {
    background: var(--gray-100);
}

.option-btn.is-active {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PADRES ESPIRITUALES - EDITABLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.assign-list-editable {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.assign-item-edit {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
}

.assign-item-edit .assign-info {
    flex: 1;
    min-width: 0;
}

.assign-item-edit .assign-name {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-800);
}

.assign-item-edit .assign-code {
    font-size: 11px;
    color: var(--gray-500);
}

.assign-remove {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 50%;
    color: var(--gray-400);
    cursor: pointer;
    transition: all 0.15s;
}

.assign-remove:hover {
    background: #fee2e2;
    color: var(--danger);
}

.assign-remove .material-icons {
    font-size: 18px;
}

.assign-empty-small {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    color: var(--gray-500);
    font-size: 13px;
    margin-bottom: 16px;
}

.assign-empty-small .material-icons {
    font-size: 20px;
    opacity: 0.5;
}

.assign-add-section {
    padding-top: 16px;
    border-top: 1px solid var(--gray-200);
}

.assign-add-section > label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.assign-add-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.assign-add-row .autocomplete-wrapper {
    flex: 1;
    position: relative;
}

.assign-add-row .autocomplete-field {
    position: relative;
}

.assign-add-row .autocomplete-search,
.assign-add-row .autocomplete-search.input {
    width: 100%;
    padding: 12px 0;
    font-size: 15px;
    border: none;
    border-bottom: 2px solid var(--gray-300);
    border-radius: 0;
    background: transparent;
    color: var(--gray-800);
    transition: border-color 0.2s;
}

.assign-add-row .autocomplete-search:focus {
    outline: none;
    border-bottom-color: var(--primary);
}

.assign-add-row .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    max-height: 250px;
    overflow-y: auto;
}

.assign-add-row .autocomplete-list {
    list-style: none;
    margin: 0;
    padding: 4px 0;
}

.assign-add-row .autocomplete-list li {
    padding: 12px 14px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--gray-100);
}

.assign-add-row .autocomplete-list li:last-child {
    border-bottom: none;
}

.assign-add-row .autocomplete-list li:hover,
.assign-add-row .autocomplete-list li.is-active {
    background: var(--gray-50);
}

.assign-add-row .autocomplete-loading,
.assign-add-row .autocomplete-empty {
    padding: 16px;
    text-align: center;
    color: var(--gray-500);
    font-size: 13px;
}

.assign-add-row .autocomplete-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--gray-100);
    border-radius: 20px;
    font-size: 13px;
    margin-bottom: 4px;
}

.assign-add-row .chip-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
}

.assign-add-row .chip-text {
    flex: 1;
}

.assign-add-row .chip-name {
    font-weight: 500;
    color: var(--gray-800);
}

.assign-add-row .chip-code {
    font-size: 11px;
    color: var(--gray-500);
}

.assign-add-row .chip-remove {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--gray-500);
    cursor: pointer;
    padding: 0;
    line-height: 1;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.15s;
}

.assign-add-row .chip-remove:hover {
    background: var(--gray-200);
    color: var(--gray-700);
}

.btn-add-padre {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.15s;
}

.btn-add-padre:hover {
    background: var(--primary-dark);
}

.btn-add-padre .material-icons {
    font-size: 22px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray-500);
}

.empty-state .material-icons {
    font-size: 48px;
    opacity: 0.4;
    margin-bottom: 12px;
}

.empty-state p {
    margin: 0 0 4px 0;
    font-size: 15px;
    font-weight: 500;
    color: var(--gray-600);
}

.empty-hint {
    font-size: 13px;
    color: var(--gray-400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE - TABLET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 768px) {
    .mobile-app {
        max-width: 600px;
        margin: 0 auto;
        border-left: 1px solid var(--gray-200);
        border-right: 1px solid var(--gray-200);
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
    }

    .profile-name {
        font-size: 24px;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr 1fr;
    }
}
</style>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="{% static 'core/js/autocomplete-miembro.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabs = document.querySelectorAll('.mobile-tab');
    const panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = 'tab-' + this.dataset.tab;

            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        });
    });

    // URL param for tab
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam) {
        const targetTab = document.querySelector(`.mobile-tab[data-tab="${tabParam}"]`);
        if (targetTab) targetTab.click();
    }

    // Quick note toggle
    const toggleBtn = document.getElementById('toggle-quick-note');
    const quickForm = document.getElementById('quick-note-form');
    const cancelBtn = document.getElementById('cancel-quick-note');

    if (toggleBtn && quickForm) {
        toggleBtn.addEventListener('click', function() {
            this.style.display = 'none';
            quickForm.style.display = 'block';
            quickForm.querySelector('textarea').focus();
        });

        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                quickForm.style.display = 'none';
                toggleBtn.style.display = 'flex';
            });
        }
    }
});
</script>

{% endblock %}