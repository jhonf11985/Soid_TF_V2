{% extends "core/base_sidebar.html" %}
{% load static %}

{% block title %}Nuevo Creyente | Bandeja{% endblock %}

{% block sidebar_icon %}group_add{% endblock %}
{% block sidebar_role_label %}Nuevo Creyente{% endblock %}

{% block sidebar_menu %}
<a class="sidebar-link active" href="{% url 'nuevo_creyente_app:seguimiento_inbox' %}">
  <span class="material-icons">inbox</span>
  <span>Bandeja</span>
</a>
<a class="sidebar-link" href="{% url 'nuevo_creyente_app:seguimiento_lista' %}">
  <span class="material-icons">list</span>
  <span>Listado</span>
</a>
<a class="sidebar-link" href="{% url 'nuevo_creyente_app:nuevo_creyente' %}">
  <span class="material-icons">dashboard</span>
  <span>Dashboard</span>
</a>
{% endblock %}

{% block page_content %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CSRF TOKEN (para POST desde JS)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<form style="display:none;">
  {% csrf_token %}
</form>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BARRA DE CONTROL SUPERIOR (Estilo Odoo)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="odoo-control-bar">
  <div class="odoo-control-left">
    <a href="{% url 'nuevo_creyente_app:seguimiento_lista' %}" class="odoo-btn odoo-btn-secondary">
      <span class="material-icons">list</span>
      <span class="hide-mobile">Ver lista</span>
    </a>

    <!-- (Opcional) bot√≥n Agenda: lo conectamos ahora, y luego hacemos la vista -->
    <a href="{% url 'nuevo_creyente_app:seguimiento_inbox' %}#agenda" class="odoo-btn odoo-btn-secondary" title="Agenda (pr√≥ximamente)">
      <span class="material-icons">event_note</span>
      <span class="hide-mobile">Agenda</span>
    </a>

    <div class="odoo-breadcrumb">
      <span class="odoo-breadcrumb-title">Bandeja CRM</span>
      <span class="material-icons odoo-breadcrumb-icon">inbox</span>
    </div>
  </div>

  <div class="odoo-control-right">
    <div class="odoo-chip">
      <span class="material-icons">today</span>
      <span>{{ hoy|date:"d/m/Y" }}</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CRM LAYOUT: DOS COLUMNAS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="crm-container">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANEL IZQUIERDO: LISTA DE CONTACTOS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <aside class="crm-list-panel">

    <!-- B√∫squeda -->
    <div class="crm-search-box">
      <form method="get" class="crm-search">
        <span class="material-icons">search</span>
        <input type="text" name="q" value="{{ query }}" placeholder="Buscar..." autocomplete="off" />
        {% if query %}
          <a class="crm-clear" href="{{ request.path }}"><span class="material-icons">close</span></a>
        {% endif %}
      </form>
    </div>

    <!-- KPIs compactos -->
    <div class="crm-kpis">
      <a href="#sec-atrasados" class="crm-kpi crm-kpi--danger {% if not cnt_atrasados %}crm-kpi--zero{% endif %}" data-section="atrasados">
        <span class="crm-kpi-num">{{ cnt_atrasados }}</span>
        <span class="crm-kpi-label">Atrasados</span>
      </a>
      <a href="#sec-hoy" class="crm-kpi crm-kpi--warn {% if not cnt_hoy %}crm-kpi--zero{% endif %}" data-section="hoy">
        <span class="crm-kpi-num">{{ cnt_hoy }}</span>
        <span class="crm-kpi-label">Hoy</span>
      </a>
      <a href="#sec-sinproximo" class="crm-kpi crm-kpi--info {% if not cnt_sin_proximo %}crm-kpi--zero{% endif %}" data-section="sinproximo">
        <span class="crm-kpi-num">{{ cnt_sin_proximo }}</span>
        <span class="crm-kpi-label">Sin fecha</span>
      </a>
      <a href="#sec-manana" class="crm-kpi crm-kpi--neutral {% if not cnt_manana %}crm-kpi--zero{% endif %}" data-section="manana">
        <span class="crm-kpi-num">{{ cnt_manana }}</span>
        <span class="crm-kpi-label">Ma√±ana</span>
      </a>
    </div>

    <!-- Lista scrolleable -->
    <div class="crm-list-scroll">

      <!-- Grupo: Atrasados -->
      {% if atrasados %}
      <div class="crm-group" id="sec-atrasados">
        <div class="crm-group-header crm-group-header--danger">
          <span class="material-icons">priority_high</span>
          <span>Atrasados</span>
          <span class="crm-group-count">{{ atrasados|length }}</span>
        </div>
        {% for exp in atrasados %}
          {% with m=exp.miembro %}
          <div class="crm-item crm-item--danger"
               data-id="{{ m.id }}"
               data-nombre="{{ m.nombres }} {{ m.apellidos }}"
               data-telefono="{{ m.telefono|default:m.whatsapp|default:'' }}"
               data-whatsapp="{{ m.whatsapp|default:'' }}"
               data-codigo="{{ m.codigo_seguimiento|default:'' }}"
               data-fecha="{{ exp.proximo_contacto|date:'d/m/Y'|default:'Sin fecha' }}"
               data-estado="atrasado"
               data-url="{% url 'nuevo_creyente_app:seguimiento_accion' m.id %}">
            <div class="crm-item-avatar">{{ m.nombres|slice:":1"|upper }}</div>
            <div class="crm-item-info">
              <div class="crm-item-name">{{ m.nombres }} {{ m.apellidos }}</div>
              <div class="crm-item-meta">
                <span class="crm-item-date"><span class="material-icons">event</span>{{ exp.proximo_contacto|date:"d M" }}</span>
                {% if m.codigo_seguimiento %}<span class="crm-item-tag">{{ m.codigo_seguimiento }}</span>{% endif %}
              </div>
            </div>
            <span class="crm-item-badge crm-badge--danger">!</span>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      {% endif %}

      <!-- Grupo: Hoy -->
      {% if para_hoy %}
      <div class="crm-group" id="sec-hoy">
        <div class="crm-group-header crm-group-header--warn">
          <span class="material-icons">today</span>
          <span>Para hoy</span>
          <span class="crm-group-count">{{ para_hoy|length }}</span>
        </div>
        {% for exp in para_hoy %}
          {% with m=exp.miembro %}
          <div class="crm-item crm-item--warn"
               data-id="{{ m.id }}"
               data-nombre="{{ m.nombres }} {{ m.apellidos }}"
               data-telefono="{{ m.telefono|default:m.whatsapp|default:'' }}"
               data-whatsapp="{{ m.whatsapp|default:'' }}"
               data-codigo="{{ m.codigo_seguimiento|default:'' }}"
               data-fecha="Hoy"
               data-estado="hoy"
               data-url="{% url 'nuevo_creyente_app:seguimiento_accion' m.id %}">
            <div class="crm-item-avatar">{{ m.nombres|slice:":1"|upper }}</div>
            <div class="crm-item-info">
              <div class="crm-item-name">{{ m.nombres }} {{ m.apellidos }}</div>
              <div class="crm-item-meta">
                <span class="crm-item-date"><span class="material-icons">schedule</span>Hoy</span>
                {% if m.codigo_seguimiento %}<span class="crm-item-tag">{{ m.codigo_seguimiento }}</span>{% endif %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      {% endif %}

      <!-- Grupo: Sin pr√≥ximo -->
      {% if sin_proximo %}
      <div class="crm-group" id="sec-sinproximo">
        <div class="crm-group-header crm-group-header--info">
          <span class="material-icons">help_outline</span>
          <span>Sin pr√≥ximo contacto</span>
          <span class="crm-group-count">{{ sin_proximo|length }}</span>
        </div>
        {% for exp in sin_proximo %}
          {% with m=exp.miembro %}
          <div class="crm-item crm-item--info"
               data-id="{{ m.id }}"
               data-nombre="{{ m.nombres }} {{ m.apellidos }}"
               data-telefono="{{ m.telefono|default:m.whatsapp|default:'' }}"
               data-whatsapp="{{ m.whatsapp|default:'' }}"
               data-codigo="{{ m.codigo_seguimiento|default:'' }}"
               data-fecha="Sin fecha"
               data-estado="pendiente"
               data-url="{% url 'nuevo_creyente_app:seguimiento_accion' m.id %}">
            <div class="crm-item-avatar">{{ m.nombres|slice:":1"|upper }}</div>
            <div class="crm-item-info">
              <div class="crm-item-name">{{ m.nombres }} {{ m.apellidos }}</div>
              <div class="crm-item-meta">
                <span class="crm-item-date crm-item-date--muted"><span class="material-icons">event_busy</span>Sin fecha</span>
                {% if m.codigo_seguimiento %}<span class="crm-item-tag">{{ m.codigo_seguimiento }}</span>{% endif %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      {% endif %}

      <!-- Grupo: Ma√±ana -->
      {% if para_manana %}
      <div class="crm-group" id="sec-manana">
        <div class="crm-group-header crm-group-header--neutral">
          <span class="material-icons">date_range</span>
          <span>Ma√±ana</span>
          <span class="crm-group-count">{{ para_manana|length }}</span>
        </div>
        {% for exp in para_manana %}
          {% with m=exp.miembro %}
          <div class="crm-item"
               data-id="{{ m.id }}"
               data-nombre="{{ m.nombres }} {{ m.apellidos }}"
               data-telefono="{{ m.telefono|default:m.whatsapp|default:'' }}"
               data-whatsapp="{{ m.whatsapp|default:'' }}"
               data-codigo="{{ m.codigo_seguimiento|default:'' }}"
               data-fecha="Ma√±ana"
               data-estado="ma√±ana"
               data-url="{% url 'nuevo_creyente_app:seguimiento_accion' m.id %}">
            <div class="crm-item-avatar">{{ m.nombres|slice:":1"|upper }}</div>
            <div class="crm-item-info">
              <div class="crm-item-name">{{ m.nombres }} {{ m.apellidos }}</div>
              <div class="crm-item-meta">
                <span class="crm-item-date"><span class="material-icons">event</span>Ma√±ana</span>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      {% endif %}

      <!-- Empty state -->
      {% if not atrasados and not para_hoy and not sin_proximo and not para_manana %}
      <div class="crm-empty-list">
        <span class="material-icons">inbox</span>
        <div>
          <strong>Bandeja vac√≠a</strong>
          <p>No hay contactos pendientes</p>
        </div>
      </div>
      {% endif %}

    </div>
  </aside>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANEL DERECHO: DETALLE DEL CONTACTO
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <main class="crm-detail-panel">

    <!-- Estado inicial -->
    <div class="crm-detail-empty" id="detailEmpty">
      <div class="crm-detail-empty-icon">
        <span class="material-icons">touch_app</span>
      </div>
      <h3>Selecciona un contacto</h3>
      <p>Haz clic en un contacto de la lista para ver sus detalles y tomar acci√≥n.</p>
    </div>

    <!-- Detalle (oculto inicialmente) -->
    <div class="crm-detail-content" id="detailContent" style="display:none;">

      <!-- Header -->
      <div class="crm-detail-header">
        <div class="crm-detail-avatar" id="detailAvatar">J</div>
        <div class="crm-detail-title">
          <h2 id="detailName">Nombre del Contacto</h2>
          <div class="crm-detail-badges">
            <span class="crm-detail-status" id="detailStatus">Estado</span>
            <span class="crm-detail-code" id="detailCode">C√≥digo</span>
          </div>
        </div>
        <button class="crm-detail-close" id="detailClose" title="Cerrar">
          <span class="material-icons">close</span>
        </button>
      </div>

      <!-- Info r√°pida -->
      <div class="crm-detail-info">
        <div class="crm-info-row">
          <span class="material-icons">event</span>
          <span class="crm-info-label">Pr√≥ximo contacto:</span>
          <span class="crm-info-value" id="detailFecha">--</span>
        </div>
        <div class="crm-info-row" id="detailTelefonoRow">
          <span class="material-icons">phone</span>
          <span class="crm-info-label">Tel√©fono:</span>
          <span class="crm-info-value" id="detailTelefono">--</span>
        </div>
        <div class="crm-info-row" id="detailWhatsappRow">
          <span class="material-icons">chat</span>
          <span class="crm-info-label">WhatsApp:</span>
          <span class="crm-info-value" id="detailWhatsapp">--</span>
        </div>
      </div>

      <!-- Acciones r√°pidas -->
      <div class="crm-detail-actions">
        <a href="#" class="crm-action crm-action--primary" id="actionCall">
          <span class="material-icons">phone</span>
          <span>Llamar</span>
        </a>
        <a href="#" class="crm-action crm-action--success" id="actionWhatsapp" target="_blank">
          <span class="material-icons">chat</span>
          <span>WhatsApp</span>
        </a>
        <a href="#" class="crm-action crm-action--secondary" id="actionDetail">
          <span class="material-icons">open_in_new</span>
          <span>Ver ficha</span>
        </a>
      </div>

      <!-- Acciones de seguimiento -->
      <div class="crm-detail-section">
        <h4>Acciones de seguimiento</h4>

        <!-- NUEVO: botones abren modal (sin salir de la bandeja) -->
        <div class="crm-action-buttons">
          <button type="button" class="crm-btn crm-btn--block" id="btnOpenRegistrar">
            <span class="material-icons">edit_note</span>
            Registrar contacto (r√°pido)
          </button>

          <button type="button" class="crm-btn crm-btn--outline" id="btnOpenAgendar">
            <span class="material-icons">event</span>
            Agendar pr√≥ximo (r√°pido)
          </button>

          <!-- Fallback: sigue existiendo el link por si quieres ir a la ficha -->
          <a href="#" class="crm-btn crm-btn--ghost" id="actionRegistrarFull">
            <span class="material-icons">open_in_new</span>
            Ir al expediente completo
          </a>
        </div>
      </div>

      <!-- Nota r√°pida (GUARDA) -->
      <div class="crm-detail-section">
        <h4>Nota r√°pida</h4>
        <form class="crm-quick-note" id="quickNoteForm">
          <textarea id="quickNoteText" placeholder="Escribe una nota sobre este contacto..." rows="3"></textarea>
          <button type="submit" class="crm-btn crm-btn--sm">
            <span class="material-icons">save</span>
            Guardar
          </button>
          <div class="crm-inline-msg" id="quickNoteMsg" style="display:none;"></div>
        </form>
      </div>

    </div>
  </main>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: REGISTRAR CONTACTO (R√ÅPIDO)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="crm-modal" id="modalRegistrar" aria-hidden="true">
  <div class="crm-modal__backdrop" data-close="1"></div>
  <div class="crm-modal__card" role="dialog" aria-modal="true" aria-labelledby="modalRegistrarTitle">
    <div class="crm-modal__header">
      <div>
        <div class="crm-modal__kicker">Registrar contacto</div>
        <h3 class="crm-modal__title" id="modalRegistrarTitle">‚Äî</h3>
      </div>
      <button class="crm-modal__close" type="button" data-close="1" title="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </div>

    <form id="formRegistrarRapido">
      <div class="crm-modal__body">
        <div class="crm-field">
          <label>Resultado</label>
          <select id="regResultado" required>
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option value="llamada">üìû Llamada realizada</option>
            <option value="whatsapp">üí¨ WhatsApp enviado</option>
            <option value="visita">üè† Visita</option>
            <option value="sin_respuesta">‚è≥ Sin respuesta</option>
            <option value="otro">üìù Otro</option>
          </select>
        </div>

        <div class="crm-field">
          <label>Nota</label>
          <textarea id="regNota" rows="4" placeholder="Ej: oramos, est√° animado, pidi√≥ visita, etc." required></textarea>
        </div>

        <div class="crm-split">
          <div class="crm-field">
            <label>¬øAgendar pr√≥ximo?</label>
            <select id="regAgendar">
              <option value="no">No</option>
              <option value="si">S√≠</option>
            </select>
          </div>
          <div class="crm-field" id="regFechaWrap" style="display:none;">
            <label>Pr√≥ximo contacto</label>
            <input id="regProximo" type="date" />
          </div>
        </div>

        <div class="crm-inline-msg" id="regMsg" style="display:none;"></div>
      </div>

      <div class="crm-modal__footer">
        <button type="button" class="crm-btn crm-btn--outline" data-close="1">Cancelar</button>
        <button type="submit" class="crm-btn crm-btn--block">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: AGENDAR PR√ìXIMO (R√ÅPIDO)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="crm-modal" id="modalAgendar" aria-hidden="true">
  <div class="crm-modal__backdrop" data-close="1"></div>
  <div class="crm-modal__card" role="dialog" aria-modal="true" aria-labelledby="modalAgendarTitle">
    <div class="crm-modal__header">
      <div>
        <div class="crm-modal__kicker">Agendar pr√≥ximo contacto</div>
        <h3 class="crm-modal__title" id="modalAgendarTitle">‚Äî</h3>
      </div>
      <button class="crm-modal__close" type="button" data-close="1" title="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </div>

    <form id="formAgendarRapido">
      <div class="crm-modal__body">
        <div class="crm-field">
          <label>Fecha del pr√≥ximo contacto</label>
          <input id="agdFecha" type="date" required />
        </div>

        <div class="crm-field">
          <label>Nota (opcional)</label>
          <textarea id="agdNota" rows="3" placeholder="Ej: llamar por la tarde, confirmar asistencia, etc."></textarea>
        </div>

        <div class="crm-inline-msg" id="agdMsg" style="display:none;"></div>
      </div>

      <div class="crm-modal__footer">
        <button type="button" class="crm-btn crm-btn--outline" data-close="1">Cancelar</button>
        <button type="submit" class="crm-btn crm-btn--block">Agendar</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ESTILOS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>
/* Barra control Odoo */
.odoo-control-bar{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 16px; background:#f8f9fa; border-bottom:1px solid #dee2e6;
  flex-wrap:wrap; gap:10px;
}
.odoo-control-left,.odoo-control-right{display:flex; align-items:center; gap:12px;}
.odoo-btn{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; font-size:13px; font-weight:500;
  border:none; border-radius:6px; cursor:pointer; text-decoration:none;
  transition:all .15s ease;
}
.odoo-btn .material-icons{font-size:18px;}
.odoo-btn-primary{background:#017e84; color:#fff;}
.odoo-btn-primary:hover{background:#016166;}
.odoo-btn-secondary{background:#fff; color:#495057; border:1px solid #dee2e6;}
.odoo-btn-secondary:hover{background:#e9ecef;}
.odoo-breadcrumb{
  display:flex; align-items:center; gap:6px; padding:4px 10px;
  background:#fff; border:1px solid #dee2e6; border-radius:6px; font-size:13px;
}
.odoo-breadcrumb-title{font-weight:600; color:#495057;}
.odoo-breadcrumb-icon{font-size:16px; color:#6c757d;}
.odoo-chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border:1px solid #dee2e6; background:#fff;
  border-radius:999px; font-size:12px; color:#495057;
}
.odoo-chip .material-icons{font-size:16px; color:#017e84;}
.hide-mobile{display:inline;}

/* CRM LAYOUT */
.crm-container{
  display:grid;
  grid-template-columns:380px 1fr;
  height:calc(100vh - 53px);
  background:#f8f9fa;
}

/* Panel izquierdo */
.crm-list-panel{
  display:flex; flex-direction:column;
  background:#fff; border-right:1px solid #dee2e6;
  overflow:hidden;
}

/* B√∫squeda */
.crm-search-box{padding:12px; border-bottom:1px solid #e9ecef;}
.crm-search{
  display:flex; align-items:center; gap:8px;
  background:#f8f9fa; border:1px solid #e9ecef;
  border-radius:8px; padding:8px 12px;
  transition:all .2s ease;
}
.crm-search:focus-within{
  background:#fff; border-color:#017e84;
  box-shadow:0 0 0 3px rgba(1,126,132,.1);
}
.crm-search .material-icons{font-size:20px; color:#6c757d;}
.crm-search input{flex:1; border:none; outline:none; background:transparent; font-size:14px; color:#212529;}
.crm-search input::placeholder{color:#adb5bd;}
.crm-clear{
  display:flex; align-items:center; justify-content:center;
  width:22px; height:22px; border-radius:50%;
  background:#e9ecef; color:#6c757d; text-decoration:none;
}
.crm-clear:hover{background:#dee2e6;}
.crm-clear .material-icons{font-size:14px;}

/* KPIs */
.crm-kpis{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px; padding:12px;
  border-bottom:1px solid #e9ecef;
}
.crm-kpi{
  display:flex; flex-direction:column; align-items:center;
  padding:10px 6px; border-radius:8px;
  text-decoration:none; transition:all .15s ease;
  border:1px solid transparent;
}
.crm-kpi:hover{background:#f8f9fa;}
.crm-kpi-num{font-size:18px; font-weight:800; line-height:1;}
.crm-kpi-label{font-size:10px; font-weight:600; color:#6c757d; margin-top:4px; text-transform:uppercase;}
.crm-kpi--danger .crm-kpi-num{color:#dc2626;}
.crm-kpi--danger:hover{background:#fef2f2; border-color:#fecaca;}
.crm-kpi--warn .crm-kpi-num{color:#d97706;}
.crm-kpi--warn:hover{background:#fffbeb; border-color:#fde68a;}
.crm-kpi--info .crm-kpi-num{color:#0284c7;}
.crm-kpi--info:hover{background:#f0f9ff; border-color:#bae6fd;}
.crm-kpi--neutral .crm-kpi-num{color:#6c757d;}
.crm-kpi--zero{opacity:.4;}

/* Lista scroll */
.crm-list-scroll{flex:1; overflow-y:auto; padding:8px 0;}

/* Grupos */
.crm-group{margin-bottom:8px;}
.crm-group-header{
  display:flex; align-items:center; gap:8px;
  padding:8px 16px;
  font-size:11px; font-weight:700; text-transform:uppercase;
  letter-spacing:.5px; color:#6c757d;
  background:#f8f9fa;
  position:sticky; top:0; z-index:1;
}
.crm-group-header .material-icons{font-size:16px;}
.crm-group-count{
  margin-left:auto; background:#e9ecef;
  padding:2px 8px; border-radius:999px;
  font-size:10px;
}
.crm-group-header--danger{color:#991b1b; background:#fef2f2;}
.crm-group-header--danger .crm-group-count{background:#fecaca; color:#991b1b;}
.crm-group-header--warn{color:#92400e; background:#fffbeb;}
.crm-group-header--warn .crm-group-count{background:#fde68a; color:#92400e;}
.crm-group-header--info{color:#075985; background:#f0f9ff;}
.crm-group-header--info .crm-group-count{background:#bae6fd; color:#075985;}
.crm-group-header--neutral{color:#6c757d; background:#f8f9fa;}

/* Items */
.crm-item{
  display:flex; align-items:center; gap:12px;
  padding:12px 16px; cursor:pointer;
  transition:all .15s ease; border-left:3px solid transparent;
}
.crm-item:hover{background:#f8f9fa;}
.crm-item.active{background:#e7f5f5; border-left-color:#017e84;}
.crm-item--danger{border-left-color:#dc2626;}
.crm-item--warn{border-left-color:#d97706;}
.crm-item--info{border-left-color:#0284c7;}
.crm-item-avatar{
  width:40px; height:40px;
  display:flex; align-items:center; justify-content:center;
  border-radius:50%;
  background:#e0f2fe; color:#0284c7;
  font-size:16px; font-weight:700;
  flex-shrink:0;
}
.crm-item-info{flex:1; min-width:0;}
.crm-item-name{
  font-size:14px; font-weight:700; color:#212529;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.crm-item-meta{display:flex; align-items:center; gap:8px; margin-top:4px;}
.crm-item-date{display:inline-flex; align-items:center; gap:4px; font-size:11px; color:#6c757d;}
.crm-item-date .material-icons{font-size:14px;}
.crm-item-date--muted{color:#adb5bd;}
.crm-item-tag{
  font-size:10px; font-weight:700;
  padding:2px 6px; border-radius:4px;
  background:#e0f2fe; color:#0284c7;
}
.crm-item-badge{
  width:24px; height:24px;
  display:flex; align-items:center; justify-content:center;
  border-radius:50%;
  font-size:12px; font-weight:900;
}
.crm-badge--danger{background:#fee2e2; color:#dc2626;}

/* Empty list */
.crm-empty-list{
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:40px 20px; text-align:center;
  color:#6c757d;
}
.crm-empty-list .material-icons{font-size:48px; color:#dee2e6; margin-bottom:12px;}
.crm-empty-list strong{font-size:14px; color:#495057;}
.crm-empty-list p{font-size:12px; margin:4px 0 0;}

/* Panel derecho */
.crm-detail-panel{display:flex; flex-direction:column; overflow-y:auto; background:#f8f9fa;}
.crm-detail-empty{
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center; padding:40px; color:#6c757d;
}
.crm-detail-empty-icon{
  width:80px; height:80px;
  display:flex; align-items:center; justify-content:center;
  background:#e9ecef; border-radius:50%;
  margin-bottom:20px;
}
.crm-detail-empty-icon .material-icons{font-size:36px; color:#adb5bd;}
.crm-detail-empty h3{font-size:18px; font-weight:700; color:#495057; margin:0 0 8px;}
.crm-detail-empty p{font-size:14px; margin:0; max-width:280px;}
.crm-detail-content{padding:20px;}
.crm-detail-header{
  display:flex; align-items:flex-start; gap:16px;
  padding:20px; background:#fff;
  border-radius:12px; border:1px solid #e9ecef;
  margin-bottom:16px;
}
.crm-detail-avatar{
  width:56px; height:56px;
  display:flex; align-items:center; justify-content:center;
  border-radius:50%;
  background:linear-gradient(135deg, #017e84, #0ea5e9);
  color:#fff; font-size:22px; font-weight:700;
  flex-shrink:0;
}
.crm-detail-title{flex:1; min-width:0;}
.crm-detail-title h2{font-size:18px; font-weight:800; color:#212529; margin:0 0 8px;}
.crm-detail-badges{display:flex; gap:8px; flex-wrap:wrap;}
.crm-detail-status{
  font-size:11px; font-weight:700;
  padding:4px 10px; border-radius:999px;
  background:#fee2e2; color:#991b1b;
  text-transform:uppercase;
}
.crm-detail-status.status-hoy{background:#fef3c7; color:#92400e;}
.crm-detail-status.status-pendiente{background:#e0f2fe; color:#075985;}
.crm-detail-status.status-manana{background:#f3f4f6; color:#495057;}
.crm-detail-code{
  font-size:11px; font-weight:700;
  padding:4px 10px; border-radius:999px;
  background:#e0f2fe; color:#0284c7;
}
.crm-detail-close{
  width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  border:none; background:#f3f4f6; border-radius:8px;
  cursor:pointer; color:#6c757d;
  transition:all .15s ease;
}
.crm-detail-close:hover{background:#e9ecef; color:#212529;}

/* Info rows */
.crm-detail-info{
  background:#fff; border-radius:12px; border:1px solid #e9ecef;
  padding:16px; margin-bottom:16px;
}
.crm-info-row{
  display:flex; align-items:center; gap:10px;
  padding:10px 0; border-bottom:1px solid #f3f4f6;
}
.crm-info-row:last-child{border-bottom:none; padding-bottom:0;}
.crm-info-row:first-child{padding-top:0;}
.crm-info-row .material-icons{font-size:20px; color:#017e84;}
.crm-info-label{font-size:13px; color:#6c757d;}
.crm-info-value{font-size:13px; font-weight:700; color:#212529; margin-left:auto;}

/* Actions */
.crm-detail-actions{
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:10px; margin-bottom:16px;
}
.crm-action{
  display:flex; flex-direction:column; align-items:center; gap:6px;
  padding:16px 12px; background:#fff;
  border:1px solid #e9ecef; border-radius:12px;
  text-decoration:none; transition:all .15s ease;
}
.crm-action:hover{border-color:#dee2e6; box-shadow:0 2px 8px rgba(0,0,0,.06);}
.crm-action .material-icons{font-size:24px;}
.crm-action span:last-child{font-size:12px; font-weight:600;}
.crm-action--primary{background:#017e84; border-color:#017e84; color:#fff;}
.crm-action--primary:hover{background:#016166; border-color:#016166;}
.crm-action--success{background:#059669; border-color:#059669; color:#fff;}
.crm-action--success:hover{background:#047857; border-color:#047857;}
.crm-action--secondary{color:#495057;}
.crm-action--secondary .material-icons{color:#017e84;}

/* Sections */
.crm-detail-section{
  background:#fff; border-radius:12px; border:1px solid #e9ecef;
  padding:16px; margin-bottom:16px;
}
.crm-detail-section h4{
  font-size:13px; font-weight:700; color:#495057;
  margin:0 0 12px; text-transform:uppercase; letter-spacing:.3px;
}

/* Buttons */
.crm-action-buttons{display:flex; flex-direction:column; gap:8px;}
.crm-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:12px 16px; font-size:14px; font-weight:600;
  border-radius:8px; text-decoration:none; cursor:pointer; border:none;
  transition:all .15s ease;
}
.crm-btn .material-icons{font-size:20px;}
.crm-btn--block{background:#017e84; color:#fff;}
.crm-btn--block:hover{background:#016166;}
.crm-btn--outline{background:#fff; color:#017e84; border:1px solid #017e84;}
.crm-btn--outline:hover{background:#e7f5f5;}
.crm-btn--sm{padding:8px 12px; font-size:12px;}
.crm-btn--sm .material-icons{font-size:16px;}
.crm-btn--ghost{background:#fff; color:#495057; border:1px dashed #dee2e6;}
.crm-btn--ghost:hover{background:#f8f9fa;}

/* Quick note */
.crm-quick-note textarea{
  width:100%; padding:12px; border:1px solid #e9ecef; border-radius:8px;
  font-size:13px; resize:vertical; margin-bottom:10px; font-family:inherit;
}
.crm-quick-note textarea:focus{
  outline:none; border-color:#017e84; box-shadow:0 0 0 3px rgba(1,126,132,.1);
}
.crm-inline-msg{
  margin-top:10px;
  padding:10px 12px;
  border-radius:10px;
  font-size:12px;
  border:1px solid #e9ecef;
  background:#f8f9fa;
  color:#495057;
}
.crm-inline-msg.ok{border-color:#bbf7d0; background:#f0fdf4; color:#14532d;}
.crm-inline-msg.err{border-color:#fecaca; background:#fef2f2; color:#7f1d1d;}

/* MODALES */
.crm-modal{position:fixed; inset:0; display:none; z-index:9999;}
.crm-modal.show{display:block;}
.crm-modal__backdrop{position:absolute; inset:0; background:rgba(0,0,0,.35);}
.crm-modal__card{
  position:relative;
  width:min(560px, calc(100% - 24px));
  margin:60px auto;
  background:#fff;
  border-radius:14px;
  border:1px solid #e9ecef;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  overflow:hidden;
}
.crm-modal__header{
  display:flex; justify-content:space-between; align-items:flex-start;
  padding:16px 16px 12px;
  border-bottom:1px solid #f3f4f6;
  background:#fff;
}
.crm-modal__kicker{font-size:11px; font-weight:800; text-transform:uppercase; color:#6c757d; letter-spacing:.4px;}
.crm-modal__title{margin:4px 0 0; font-size:16px; font-weight:900; color:#212529;}
.crm-modal__close{
  border:none; background:#f3f4f6; border-radius:10px;
  width:34px; height:34px; cursor:pointer; color:#6c757d;
  display:flex; align-items:center; justify-content:center;
}
.crm-modal__close:hover{background:#e9ecef; color:#212529;}
.crm-modal__body{padding:14px 16px 6px;}
.crm-modal__footer{
  display:flex; justify-content:flex-end; gap:10px;
  padding:14px 16px 16px;
  border-top:1px solid #f3f4f6;
  background:#fff;
}
.crm-field{margin-bottom:12px;}
.crm-field label{display:block; font-size:12px; font-weight:800; color:#495057; margin-bottom:6px;}
.crm-field input, .crm-field select, .crm-field textarea{
  width:100%;
  padding:10px 12px;
  border:1px solid #e9ecef;
  border-radius:10px;
  font-size:13px;
  outline:none;
  font-family:inherit;
}
.crm-field input:focus, .crm-field select:focus, .crm-field textarea:focus{
  border-color:#017e84;
  box-shadow:0 0 0 3px rgba(1,126,132,.1);
}
.crm-split{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
@media (max-width:520px){ .crm-split{grid-template-columns:1fr;} .crm-modal__card{margin:18px auto;} }

/* RESPONSIVE */
@media (max-width: 900px){
  .crm-container{grid-template-columns:1fr; height:auto; min-height:calc(100vh - 53px);}
  .crm-list-panel{border-right:none; border-bottom:1px solid #dee2e6; max-height:50vh;}
  .crm-detail-panel{min-height:50vh;}
  .crm-detail-empty{padding:30px 20px;}
  .crm-detail-empty-icon{width:60px; height:60px;}
  .crm-detail-empty-icon .material-icons{font-size:28px;}
  .crm-detail-empty h3{font-size:16px;}
  .crm-detail-empty p{font-size:13px;}
}

@media (max-width: 600px){
  .odoo-breadcrumb{display:none;}
  .hide-mobile{display:none;}

  .crm-kpis{grid-template-columns:repeat(4,1fr); gap:6px; padding:10px;}
  .crm-kpi{padding:8px 4px;}
  .crm-kpi-num{font-size:16px;}
  .crm-kpi-label{font-size:9px;}

  .crm-item{padding:10px 12px;}
  .crm-item-avatar{width:36px; height:36px; font-size:14px;}
  .crm-item-name{font-size:13px;}

  .crm-detail-content{padding:12px;}
  .crm-detail-header{padding:16px; gap:12px;}
  .crm-detail-avatar{width:48px; height:48px; font-size:18px;}
  .crm-detail-title h2{font-size:16px;}

  .crm-detail-actions{grid-template-columns:1fr 1fr 1fr; gap:8px;}
  .crm-action{padding:12px 8px;}
  .crm-action .material-icons{font-size:22px;}
  .crm-action span:last-child{font-size:11px;}
}
</style>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const items = document.querySelectorAll('.crm-item');
  const detailEmpty = document.getElementById('detailEmpty');
  const detailContent = document.getElementById('detailContent');
  const detailClose = document.getElementById('detailClose');

  // detalle
  const detailAvatar = document.getElementById('detailAvatar');
  const detailName = document.getElementById('detailName');
  const detailStatus = document.getElementById('detailStatus');
  const detailCode = document.getElementById('detailCode');
  const detailFecha = document.getElementById('detailFecha');
  const detailTelefono = document.getElementById('detailTelefono');
  const detailTelefonoRow = document.getElementById('detailTelefonoRow');
  const detailWhatsapp = document.getElementById('detailWhatsapp');
  const detailWhatsappRow = document.getElementById('detailWhatsappRow');

  // acciones top
  const actionCall = document.getElementById('actionCall');
  const actionWhatsapp = document.getElementById('actionWhatsapp');
  const actionDetail = document.getElementById('actionDetail');

  // acciones r√°pidas nuevas
  const btnOpenRegistrar = document.getElementById('btnOpenRegistrar');
  const btnOpenAgendar = document.getElementById('btnOpenAgendar');
  const actionRegistrarFull = document.getElementById('actionRegistrarFull');

  // quick note
  const quickNoteForm = document.getElementById('quickNoteForm');
  const quickNoteText = document.getElementById('quickNoteText');
  const quickNoteMsg = document.getElementById('quickNoteMsg');

  // modales
  const modalRegistrar = document.getElementById('modalRegistrar');
  const modalAgendar = document.getElementById('modalAgendar');
  const modalRegistrarTitle = document.getElementById('modalRegistrarTitle');
  const modalAgendarTitle = document.getElementById('modalAgendarTitle');

  const formRegistrarRapido = document.getElementById('formRegistrarRapido');
  const regResultado = document.getElementById('regResultado');
  const regNota = document.getElementById('regNota');
  const regAgendar = document.getElementById('regAgendar');
  const regFechaWrap = document.getElementById('regFechaWrap');
  const regProximo = document.getElementById('regProximo');
  const regMsg = document.getElementById('regMsg');

  const formAgendarRapido = document.getElementById('formAgendarRapido');
  const agdFecha = document.getElementById('agdFecha');
  const agdNota = document.getElementById('agdNota');
  const agdMsg = document.getElementById('agdMsg');

  // estado seleccionado
  let selected = {
    id: null,
    nombre: null,
    url: null,
    telefono: null,
    whatsapp: null
  };

  function getCsrfToken() {
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }

  function flashMsg(el, text, type) {
    el.textContent = text;
    el.className = 'crm-inline-msg ' + (type === 'ok' ? 'ok' : 'err');
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 2600);
  }

  function openModal(modal) {
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  function closeModal(modal) {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  // cerrar modales
  document.querySelectorAll('.crm-modal [data-close="1"]').forEach(el => {
    el.addEventListener('click', () => {
      closeModal(modalRegistrar);
      closeModal(modalAgendar);
    });
  });

  regAgendar.addEventListener('change', () => {
    regFechaWrap.style.display = (regAgendar.value === 'si') ? 'block' : 'none';
    if (regAgendar.value !== 'si') regProximo.value = '';
  });

  // mostrar detalle
  function showDetail(item) {
    items.forEach(i => i.classList.remove('active'));
    item.classList.add('active');

    const nombre = item.dataset.nombre || '';
    const telefono = item.dataset.telefono || '';
    const whatsapp = item.dataset.whatsapp || '';
    const codigo = item.dataset.codigo || '';
    const fecha = item.dataset.fecha || '--';
    const estado = item.dataset.estado || '';
    const url = item.dataset.url || '#';
    const id = item.dataset.id || null;

    selected = { id, nombre, url, telefono, whatsapp };

    detailAvatar.textContent = nombre.charAt(0).toUpperCase();
    detailName.textContent = nombre;
    detailFecha.textContent = fecha;

    detailStatus.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
    detailStatus.className = 'crm-detail-status';
    if (estado === 'hoy') detailStatus.classList.add('status-hoy');
    else if (estado === 'pendiente') detailStatus.classList.add('status-pendiente');
    else if (estado === 'ma√±ana') detailStatus.classList.add('status-manana');

    if (codigo) {
      detailCode.textContent = codigo;
      detailCode.style.display = 'inline-block';
    } else {
      detailCode.style.display = 'none';
    }

    if (telefono) {
      detailTelefono.textContent = telefono;
      detailTelefonoRow.style.display = 'flex';
      actionCall.href = 'tel:' + telefono;
      actionCall.style.display = 'flex';
    } else {
      detailTelefonoRow.style.display = 'none';
      actionCall.style.display = 'none';
    }

    if (whatsapp) {
      detailWhatsapp.textContent = whatsapp;
      detailWhatsappRow.style.display = 'flex';
      actionWhatsapp.href = 'https://wa.me/' + whatsapp.replace(/[^0-9]/g, '');
      actionWhatsapp.style.display = 'flex';
    } else {
      detailWhatsappRow.style.display = 'none';
      actionWhatsapp.style.display = 'none';
    }

    // URLs
    actionDetail.href = url;
    actionRegistrarFull.href = url;

    // reset campos r√°pidos
    quickNoteText.value = '';
    regResultado.value = '';
    regNota.value = '';
    regAgendar.value = 'no';
    regFechaWrap.style.display = 'none';
    regProximo.value = '';
    agdFecha.value = '';
    agdNota.value = '';

    detailEmpty.style.display = 'none';
    detailContent.style.display = 'block';
  }

  function hideDetail() {
    items.forEach(i => i.classList.remove('active'));
    detailContent.style.display = 'none';
    detailEmpty.style.display = 'flex';
    selected = { id:null, nombre:null, url:null, telefono:null, whatsapp:null };
  }

  items.forEach(item => item.addEventListener('click', () => showDetail(item)));
  detailClose.addEventListener('click', hideDetail);

  if (items.length > 0 && window.innerWidth > 900) showDetail(items[0]);

  // KPIs scroll
  document.querySelectorAll('.crm-kpi').forEach(kpi => {
    kpi.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href && href.startsWith('#')) {
        e.preventDefault();
        const target = document.querySelector(href);
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Abrir modales
  btnOpenRegistrar.addEventListener('click', () => {
    if (!selected.url) return;
    modalRegistrarTitle.textContent = selected.nombre || '‚Äî';
    openModal(modalRegistrar);
  });

  btnOpenAgendar.addEventListener('click', () => {
    if (!selected.url) return;
    modalAgendarTitle.textContent = selected.nombre || '‚Äî';
    openModal(modalAgendar);
  });

  // QUICK NOTE (POST al seguimiento_accion)
  quickNoteForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selected.url) return;

    const nota = (quickNoteText.value || '').trim();
    if (!nota) {
      flashMsg(quickNoteMsg, 'Escribe una nota antes de guardar.', 'err');
      return;
    }

    try {
      const fd = new FormData();
      fd.append('accion_rapida', 'quick_note');
      fd.append('nota', nota);

      const res = await fetch(selected.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken() },
        body: fd
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      flashMsg(quickNoteMsg, 'Nota guardada.', 'ok');
      quickNoteText.value = '';
    } catch (err) {
      flashMsg(quickNoteMsg, 'No se pudo guardar. Revisa el backend de seguimiento_accion.', 'err');
    }
  });

  // REGISTRAR CONTACTO (R√ÅPIDO) -> POST al seguimiento_accion
  formRegistrarRapido.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selected.url) return;

    const resultado = regResultado.value;
    const nota = (regNota.value || '').trim();
    const agendar = regAgendar.value;
    const proximo = regProximo.value;

    if (!resultado || !nota) {
      flashMsg(regMsg, 'Completa resultado y nota.', 'err');
      return;
    }
    if (agendar === 'si' && !proximo) {
      flashMsg(regMsg, 'Selecciona la fecha del pr√≥ximo contacto.', 'err');
      return;
    }

    try {
      const fd = new FormData();
      fd.append('accion_rapida', 'registrar_contacto');
      fd.append('resultado', resultado);
      fd.append('nota', nota);
      fd.append('agendar', agendar);
      if (agendar === 'si') fd.append('proximo_contacto', proximo);

      const res = await fetch(selected.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken() },
        body: fd
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);

      flashMsg(regMsg, 'Contacto registrado.', 'ok');
      setTimeout(() => closeModal(modalRegistrar), 600);
    } catch (err) {
      flashMsg(regMsg, 'No se pudo guardar. Revisa el backend de seguimiento_accion.', 'err');
    }
  });

  // AGENDAR (R√ÅPIDO) -> POST al seguimiento_accion
  formAgendarRapido.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selected.url) return;

    const fecha = agdFecha.value;
    const nota = (agdNota.value || '').trim();

    if (!fecha) {
      flashMsg(agdMsg, 'Selecciona la fecha.', 'err');
      return;
    }

    try {
      const fd = new FormData();
      fd.append('accion_rapida', 'agendar');
      fd.append('proximo_contacto', fecha);
      if (nota) fd.append('nota', nota);

      const res = await fetch(selected.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken() },
        body: fd
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);

      flashMsg(agdMsg, 'Agendado.', 'ok');
      setTimeout(() => closeModal(modalAgendar), 600);
    } catch (err) {
      flashMsg(agdMsg, 'No se pudo agendar. Revisa el backend de seguimiento_accion.', 'err');
    }
  });

});
</script>

{% endblock %}
